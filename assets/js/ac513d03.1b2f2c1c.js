"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[5394],{3905:(e,t,o)=>{o.d(t,{Zo:()=>p,kt:()=>m});var r=o(67294);function n(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function a(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,r)}return o}function i(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?a(Object(o),!0).forEach((function(t){n(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function l(e,t){if(null==e)return{};var o,r,n=function(e,t){if(null==e)return{};var o,r,n={},a=Object.keys(e);for(r=0;r<a.length;r++)o=a[r],t.indexOf(o)>=0||(n[o]=e[o]);return n}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)o=a[r],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}var s=r.createContext({}),u=function(e){var t=r.useContext(s),o=t;return e&&(o="function"==typeof e?e(t):i(i({},t),e)),o},p=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},h="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var o=e.components,n=e.mdxType,a=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),h=u(o),d=n,m=h["".concat(s,".").concat(d)]||h[d]||c[d]||a;return o?r.createElement(m,i(i({ref:t},p),{},{components:o})):r.createElement(m,i({ref:t},p))}));function m(e,t){var o=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var a=o.length,i=new Array(a);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[h]="string"==typeof e?e:n,i[1]=l;for(var u=2;u<a;u++)i[u]=o[u];return r.createElement.apply(null,i)}return r.createElement.apply(null,o)}d.displayName="MDXCreateElement"},84408:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>c,frontMatter:()=>a,metadata:()=>l,toc:()=>u});var r=o(87462),n=(o(67294),o(3905));const a={},i="Sudo Buffer Overflow",l={unversionedId:"Tryhackme/Sudo Buffer Overflow/Sudo Buffer Overflow",id:"Tryhackme/Sudo Buffer Overflow/Sudo Buffer Overflow",title:"Sudo Buffer Overflow",description:"A tutorial room exploring CVE-2019-18634 in the Unix Sudo Program. Room Two in the SudoVulns Series",source:"@site/writeups/Tryhackme/Sudo Buffer Overflow/Sudo Buffer Overflow.md",sourceDirName:"Tryhackme/Sudo Buffer Overflow",slug:"/Tryhackme/Sudo Buffer Overflow/",permalink:"/writeups/Tryhackme/Sudo Buffer Overflow/",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Sublist3r",permalink:"/writeups/Tryhackme/Sublist3r/"},next:{title:"Sudo Security Bypass",permalink:"/writeups/Tryhackme/Sudo Security Bypass/"}},s={},u=[{value:"\ud83d\udca2 We will cover  the topics",id:"-we-will-cover--the-topics",level:2},{value:"Task 1 Deploy!",id:"task-1-deploy",level:2},{value:"Task 2 Buffer Overflow",id:"task-2-buffer-overflow",level:2}],p={toc:u},h="wrapper";function c(e){let{components:t,...o}=e;return(0,n.kt)(h,(0,r.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"sudo-buffer-overflow"},"Sudo Buffer Overflow"),(0,n.kt)("p",null,"A tutorial room exploring CVE-2019-18634 in the Unix Sudo Program. Room Two in the SudoVulns Series"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://tryhackme.com/room/sudovulnsbof"},"Sudo Buffer Overflow")),(0,n.kt)("h2",{id:"-we-will-cover--the-topics"},"\ud83d\udca2 We will cover  the topics"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Misconfigured Binaries"),(0,n.kt)("li",{parentName:"ul"},"CVE-2019-18634 - Sudo 1.8.25p - 'pwfeedback' Buffer Overflow")),(0,n.kt)("h2",{id:"task-1-deploy"},"Task 1 Deploy!"),(0,n.kt)("p",null,"To deploy this virtual machine you must be connected to the TryHackMe network using your OpenVPN configuration file. If you don't know how to do this, take a quick look at the OpenVPN room first."),(0,n.kt)("p",null,'Once you\'re connected click the green "Deploy" button to start an instance of the machine, then we can get started!'),(0,n.kt)("p",null,"(Please note that VMs can take a few minutes to boot up fully)"),(0,n.kt)("p",null,"You will be using SSH to log into the machine. On Linux this is done from the terminal, with a command that looks like this:"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"ssh -p <port-number> <username>@<remote-machine-ip>")),(0,n.kt)("p",null,"On Windows you would usually use a piece of software such as ",(0,n.kt)("a",{parentName:"p",href:"https://putty.org/"},"PuTTY"),". You would then login like this:"),(0,n.kt)("p",null,(0,n.kt)("img",{parentName:"p",src:"https://muirlandoracle.co.uk/wp-content/uploads/2020/02/PuTTY-Login-Demo-1.png",alt:null})),(0,n.kt)("p",null,"Whichever method you're using, you will then be asked for a password, which, once entered, will let you execute commands remotely on the machine."),(0,n.kt)("p",null,"Deployed!"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"No answer needed")),(0,n.kt)("h2",{id:"task-2-buffer-overflow"},"Task 2 Buffer Overflow"),(0,n.kt)("p",null,"CVE-2019-18634 is, at the time of writing, the latest offering from Joe Vennix - the same guy who brought us the security bypass vulnerability that we used in the Security Bypass room. This one is slightly more technical, using a Buffer Overflow attack to get root permissions. It has been patched, but affects versions of sudo earlier than 1.8.26."),(0,n.kt)("p",null,"Let's break this down a little bit."),(0,n.kt)("p",null,"In the ",(0,n.kt)("a",{parentName:"p",href:"https://tryhackme.com/room/sudovulnsbypass"},"Security Bypass room")," I mentioned briefly that you can add things to the ",(0,n.kt)("inlineCode",{parentName:"p"},"/etc/sudoers")," file in order to give lower-privileged users extra permissions. For this exploit we're more interested in one of the other options available: specifically an option called ",(0,n.kt)("inlineCode",{parentName:"p"},"pwfeedback"),". This option is purely aesthetic, and is usually turned off by default (with the exception of ElementaryOS and Linux Mint - although they will likely now also stop using it). If you have used Linux before then you might have noticed that passwords typed into the terminal usually don't show any output at all; ",(0,n.kt)("inlineCode",{parentName:"p"},"pwfeedback")," makes it so that whenever you type a character, an asterisk is displayed on the screen. Inside the ",(0,n.kt)("inlineCode",{parentName:"p"},"/etc/sudoers")," file it is specified like this:"),(0,n.kt)("p",null,(0,n.kt)("img",{parentName:"p",src:"https://muirlandoracle.co.uk/wp-content/uploads/2020/02/pwfeedback-demo.png",alt:null})),(0,n.kt)("p",null,"Here's the catch. When this option is turned on, it's possible to perform a ",(0,n.kt)("a",{parentName:"p",href:"https://tryhackme.com/room/bof1"},"buffer overflow"),' attack on the sudo command. To explain it really simply, when a program accepts input from a user it stores the data in a set size of storage space. A buffer overflow attack is when you enter so much data into the input that it spills out of this storage space and into the next "box," overwriting the data in it. As far as we\'re concerned, this means if we fill the password box of the sudo command up with a lot of garbage, we can inject our own stuff in at the end. This could mean that we get a shell as root! This exploit works regardless of whether we have any sudo permissions to begin with, unlike in CVE-2019-14287 where we had to have a very specific set of permissions in the first place.'),(0,n.kt)("p",null,"Here's a proof of concept:"),(0,n.kt)("p",null,(0,n.kt)("img",{parentName:"p",src:"https://muirlandoracle.co.uk/wp-content/uploads/2020/02/capture-1.png",alt:null})),(0,n.kt)("p",null,"In this command we're using the programming language Perl to generate a lot of information which we're then passing into the sudo command as a password using the pipe (",(0,n.kt)("inlineCode",{parentName:"p"},"|"),") operator. Notice that this doesn't actually give us root permissions -- instead it shows us an error message: ",(0,n.kt)("inlineCode",{parentName:"p"},"Segmentation fault"),", which basically means that we've tried to access some memory that we weren't supposed to be able to access. This proves that a buffer overflow vulnerability exists: now we just need to exploit it!"),(0,n.kt)("p",null,"The particular exploit that we're going to be using was written by Saleem Rashid (",(0,n.kt)("a",{parentName:"p",href:"https://twitter.com/saleemrash1d"},"@saleemrash1d"),")"),(0,n.kt)("p",null,"This is a program written in C that exploits CVE-2019-18634. In reality BOF attacks are considerably more complicated than in the explanation above, so we're not going to go into a huge amount of detail about what the program is doing exactly, but you can imagine that it's doing the same thing as in the explanation: filling the password field with rubbish information, then overwriting something more important that's in the next \"box\" with code that gives us a root shell."),(0,n.kt)("p",null,"I've already uploaded a compiled copy of the code into the VM, so all you need to do is run it. This next section is interesting (and useful if you ever need to use this program for a CTF or other hacking challenge), but not essential for completing the room. This is the process that you would use if you were to download and compile the program for yourself:"),(0,n.kt)("p",null,(0,n.kt)("img",{parentName:"p",src:"https://muirlandoracle.co.uk/wp-content/uploads/2020/02/Compiling-CVE-2019-18634.png",alt:null})),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"First you download the program (in this case I used wget to do it in the terminal). The source code can be found on Saleem's github, so if you're interested, I would highly recommend reading through the code to see what it does!"),(0,n.kt)("li",{parentName:"ol"},"Next you compile the program. I've used gcc to compile the exploit: ",(0,n.kt)("inlineCode",{parentName:"li"},"gcc -o <output-file> <source-file>")),(0,n.kt)("li",{parentName:"ol"},"Notice that there are two files in the directory -- a blue coloured file called ",(0,n.kt)("inlineCode",{parentName:"li"},"exploit")," which is our compiled executable, and a white coloured file called ",(0,n.kt)("inlineCode",{parentName:"li"},"exploit.c")," which is the original source file."),(0,n.kt)("li",{parentName:"ol"},"You would then upload the file into the target machine and run it:")),(0,n.kt)("p",null,(0,n.kt)("img",{parentName:"p",src:"https://muirlandoracle.co.uk/wp-content/uploads/2020/02/CVE-2019-18634-Demo-1.png",alt:null})),(0,n.kt)("p",null,"As I said earlier, I have already done the compilation and upload for you. All you need to do is login to the machine and run the exploit, just to see it working for yourself."),(0,n.kt)("p",null,"Now it's your turn."),(0,n.kt)("p",null,"SSH into that machine you deployed earlier, ",(0,n.kt)("strong",{parentName:"p"},"using port 4444"),"."),(0,n.kt)("p",null,"The credentials are:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Username: ",(0,n.kt)("strong",{parentName:"li"},"tryhackme")),(0,n.kt)("li",{parentName:"ul"},"Password: ",(0,n.kt)("strong",{parentName:"li"},"tryhackme"))),(0,n.kt)("p",null,"If you're using Linux, the command will look like this: ",(0,n.kt)("inlineCode",{parentName:"p"},"ssh -p 4444 tryhackme@MACHINE_IP")),(0,n.kt)("p",null,"Use the pre-compiled exploit in the VM to get a root shell."),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"No answer needed")),(0,n.kt)("p",null,"What's the flag in /root/root.txt?"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"tryhackme@sudo-bof:~$ ls -la\ntotal 44\ndrwxr-xr-x 2 tryhackme tryhackme  4096 Feb  8  2020 .\ndrwxr-xr-x 5 root      root       4096 Feb  8  2020 ..\n-rw------- 1 tryhackme tryhackme    22 Feb  8  2020 .bash_history\n-rw-r--r-- 1 tryhackme tryhackme   220 Apr  4  2018 .bash_logout\n-rw-r--r-- 1 tryhackme tryhackme  3771 Apr  4  2018 .bashrc\n-rw-r--r-- 1 tryhackme tryhackme   807 Apr  4  2018 .profile\n-rwxr-xr-x 1 root      root      17488 Feb  8  2020 exploit\ntryhackme@sudo-bof:~$ ./exploit \n[sudo] password for tryhackme: \nSorry, try again.\n# whoami\nroot\n# cat /root/root.txt\nTHM{buff3r_0v3rfl0w_rul3s}\n")),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"THM{buff3r_0v3rfl0w_rul3s}")))}c.isMDXComponent=!0}}]);