"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[259],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},k=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),d=p(n),k=r,h=d["".concat(s,".").concat(k)]||d[k]||c[k]||l;return n?a.createElement(h,i(i({ref:t},u),{},{components:n})):a.createElement(h,i({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=k;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[d]="string"==typeof e?e:r,i[1]=o;for(var p=2;p<l;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}k.displayName="MDXCreateElement"},46700:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>c,frontMatter:()=>l,metadata:()=>o,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const l={},i="Attacking ICS Plant #1",o={unversionedId:"Tryhackme/Attacking ICS Plant 1/Attacking ICS Plant",id:"Tryhackme/Attacking ICS Plant 1/Attacking ICS Plant",title:"Attacking ICS Plant #1",description:"1",source:"@site/writeups/Tryhackme/Attacking ICS Plant 1/Attacking ICS Plant.md",sourceDirName:"Tryhackme/Attacking ICS Plant 1",slug:"/Tryhackme/Attacking ICS Plant 1/Attacking ICS Plant",permalink:"/writeups/Tryhackme/Attacking ICS Plant 1/Attacking ICS Plant",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"AttackerKB",permalink:"/writeups/Tryhackme/AttackerKB/"},next:{title:"Attacking Kerberos",permalink:"/writeups/Tryhackme/Attacking Kerberos/"}},s={},p=[{value:"Task 1 Introduction to OT/ICS",id:"task-1-introduction-to-otics",level:2},{value:"Task 2 Introduction to Modbus protocol",id:"task-2-introduction-to-modbus-protocol",level:2},{value:"Task 3 Discovery",id:"task-3-discovery",level:2},{value:"Task 4 Play to learn",id:"task-4-play-to-learn",level:2},{value:"Task 5 Attack",id:"task-5-attack",level:2}],u={toc:p},d="wrapper";function c(e){let{components:t,...n}=e;return(0,r.kt)(d,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"attacking-ics-plant-1"},"Attacking ICS Plant #1"),(0,r.kt)("p",null,"Learn how to discover and attack ICS plants using modbus protocol (Modicon / Schneider Electric)."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://tryhackme.com/room/attackingics1"},"Attacking ICS Plant #1")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"task-1-introduction-to-otics"},"Task 1 Introduction to OT/ICS"),(0,r.kt)("p",null,"Operational Technology (OT) refers to systems used to monitor and control industrial operations. Industrial Control Systems (ICS) includes systems used to monitor and control industrial processes."),(0,r.kt)("p",null,"If IT operators have dozens of years of experience securing networks, systems and applications, OT operators are pretty new to this topic. Moreover in OT/ICS development availability is always preferred over integrity and confidentiality. In other words ICS softwares are designed to be fast but, often, insecure."),(0,r.kt)("p",null,"Supervisory Control and Data Acquisition (SCADA) systems are used to control and automate industrial processes. SCADA systems includes:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Supervisory computers"),": the servers used to manage the process gathering data on the process and communicating with filed devices (PLC/RTU). In smaller deployments HMI is embedded in a single computer, in larger deploy HMI is installed into a dedicated computer."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Programmable Logic Controllers (PLC)"),": digital computers used mainly for automating industrial processes. They are used to continuously monitor sensors (input) and make decisions controlling devices (output)."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Remote Terminal Units (RTU)"),": nowadays RTUs and PLCs functionalities overlap with each other. RTUs are usually preferred for wider geographical telemetry whereas PLCs are better with local controls."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Communication network"),": the network connecting all SCADA components (Ethernet, Serial, telephones, radio, cellular...). Network failures do not necessarily impact negatively on the plant process. Both RTU's and PLC's should be designed to operate autonomously, using the last instruction given from the supervisory system."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Human Machine Interface (HMI)"),": displays a digitalized representation of the plant. Operators can interact with the plant issuing commands using mouse, keyboards or touch screens. ",(0,r.kt)("strong",{parentName:"li"},"Operators can make supervisory decisions adjusting or overriding the normal plant behaviour"),".")),(0,r.kt)("p",null,"In short and simple words:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"industries are managed by sophisticated, mission critical computers (SCADA systems);"),(0,r.kt)("li",{parentName:"ul"},"security is not the first priority in OT/ICS;"),(0,r.kt)("li",{parentName:"ul"},"operators can manually override the behaviour of the plant via mouse/keyboard/touchscreen, locally or remotely;"),(0,r.kt)("li",{parentName:"ul"},"a malicious software can override the behaviour of the plant like HMI does.")),(0,r.kt)("p",null,"For more information see ",(0,r.kt)("a",{parentName:"p",href:"https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-82r2.pdf"},"Guide to Industrial Control Systems (ICS) Security (NIST 800-82)"),"."),(0,r.kt)("p",null,"No answer needed"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"No answer needed")),(0,r.kt)("h2",{id:"task-2-introduction-to-modbus-protocol"},"Task 2 Introduction to Modbus protocol"),(0,r.kt)("p",null,"Modbus is an industrial protocol developed by Modicon, acquired by Schneider Electric. Modbus is widely used to connect industrial devices; protocol specification is available and royalty-free."),(0,r.kt)("p",null,"Modbus protocol is a master/slave protocol: the master reads and writes slaves' registers."),(0,r.kt)("p",null,"Modbus RTU is usually used via RS-485 (serial network): one master is present with one or more slaves. Each slave has an unique 8-bit address."),(0,r.kt)("p",null,'Modbus data is used to read and write "registers" which are 16-bit long. The most common register is called "holding register" which is readable and writable; registry type "input register" is readable only. The registers "coil" and "discrete input" are 1-bit long: coils are readable and writable, discrete inputs are readable only.'),(0,r.kt)("p",null,"Modbus register types:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Discrete Input (Status Input): 1bit, RO"),(0,r.kt)("li",{parentName:"ul"},"Coil (Discrete Output): 1bit, R/W"),(0,r.kt)("li",{parentName:"ul"},"Input Register: 16bit, RO"),(0,r.kt)("li",{parentName:"ul"},"Holding Register: 16bit R/W")),(0,r.kt)("p",null,"Most commonly Modbus function:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Function Code"),(0,r.kt)("th",{parentName:"tr",align:null},"Register Type"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},"Read Coil")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"Read Discrete Input")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"3"),(0,r.kt)("td",{parentName:"tr",align:null},"Read Holding Registers")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"4"),(0,r.kt)("td",{parentName:"tr",align:null},"Read Input Registers")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"5"),(0,r.kt)("td",{parentName:"tr",align:null},"Write Single Coil")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"6"),(0,r.kt)("td",{parentName:"tr",align:null},"Write Single Holding Register")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"15"),(0,r.kt)("td",{parentName:"tr",align:null},"Write Multiple Coils")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"16"),(0,r.kt)("td",{parentName:"tr",align:null},"Write Multiple Holding Registers")))),(0,r.kt)("p",null,"Modbus TCP encapsulates Modbus RTU request and response data packets in a TCP packet transmitted over standard Ethernet networks. The TCP Modbus standard port is 502."),(0,r.kt)("p",null,"For more information see ",(0,r.kt)("a",{parentName:"p",href:"https://www.csimn.com/CSI_pages/Modbus101.html"},"Modbus 101 - Introduction to Modbus"),"."),(0,r.kt)("p",null,"Before starting, download the attached script package and install the Modbus TCP library for Python with the following command:"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"pip3 install pymodbus==1.5.2")),(0,r.kt)("p",null,"Which is the function used to read holding registers in pymodbus library?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"read_holding_registers")),(0,r.kt)("p",null,"Which is the function used to write holding registers in pymodbus library?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"write_register")),(0,r.kt)("h2",{id:"task-3-discovery"},"Task 3 Discovery"),(0,r.kt)("p",null,"Connect to the plant using the browser (http://MACHINE_IP) and learn how the bottle-filling plant works."),(0,r.kt)("p",null,"We have three phases:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Initialization: the plant is starting from the beginning. The roller moves the first bottle under the nozzle."),(0,r.kt)("li",{parentName:"ul"},"Filling: once a bottle is under the nozzle, the nozzle opens and the water flows in the bottle."),(0,r.kt)("li",{parentName:"ul"},"Moving: once the bottle is filled, the roller starts again moving the next empty bottle under the nozzle.")),(0,r.kt)("p",null,"When the phase 3 ends, the plant starts again with phase 2."),(0,r.kt)("p",null,"From the three phases described above, we can observe:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Sensors: used to read a state of the plant."),(0,r.kt)("li",{parentName:"ul"},"Actuators: used to alter the state of the plant.")),(0,r.kt)("p",null,"Example: a sensor can detect if a bottle is under the nozzle, while an actuator can open or close the nozzle."),(0,r.kt)("p",null,"Mind we can press the ESC button to start the plant from the beginning."),(0,r.kt)("p",null,"VirtuaPlant can be downloaded from ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/jseidl/virtuaplant/network/members"},"GitHub"),"."),(0,r.kt)("p",null,"How many phases can we observe?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"3")),(0,r.kt)("p",null,"How many sensors can we observe?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"2")),(0,r.kt)("p",null,"How many actuators can we observe?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"3")),(0,r.kt)("p",null,"Using the script discovery.py, how many registers can we count?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"16")),(0,r.kt)("p",null,"After the plant is started and a bottle is loaded, how many registers are continuously changing their values?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"4")),(0,r.kt)("p",null,"Which is the minimum observed value?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"0")),(0,r.kt)("p",null,"Which is the maximum observed value?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"1")),(0,r.kt)("p",null,"Which registry is holding its value?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"16")),(0,r.kt)("p",null,"Which registries are set to 1 while the nozzle is filling a bottle?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"2 4")),(0,r.kt)("p",null,"Which registries are set to 1 while the roller is moving the bottles?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"1 3")),(0,r.kt)("p",null,"Which is the color of the water level sensor?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"red")),(0,r.kt)("p",null,"Which is the color of the bottle sensor?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"green")),(0,r.kt)("p",null,"If you observe the plant at the very beginning, which is the registry associated with the roller?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"3")),(0,r.kt)("p",null,"Based on the previous answer, which is the registry associated with the water level sensor?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"1")),(0,r.kt)("h2",{id:"task-4-play-to-learn"},"Task 4 Play to learn"),(0,r.kt)("p",null,"On the previous task, we learned a lot about registries:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bottle-filling plant exposes 16 registries, but only 5 are used."),(0,r.kt)("li",{parentName:"ul"},"Registry 16 is associated with the start/stop button: 1 means plant is on, 0 means plant is off."),(0,r.kt)("li",{parentName:"ul"},"Registries 1 and 3 usually have the same value, except in the initialization phase."),(0,r.kt)("li",{parentName:"ul"},"Registries 2 and 4 always have the same value.")),(0,r.kt)("p",null,"We observed three phases, and the associated registries are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Initialization: ","[0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1]"),(0,r.kt)("li",{parentName:"ul"},"Filling: once a bottle is under the nozzle, the nozzle opens and the water flows in the bottle."),(0,r.kt)("li",{parentName:"ul"},"Moving: once the bottle is filled, the roller starts again moving the next empty bottle under the nozzle.")),(0,r.kt)("p",null,"We also assumed the plant has two sensors and three actuators. Actuators:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Start/stop button: registry 16."),(0,r.kt)("li",{parentName:"ul"},"Roller engine: registry 3."),(0,r.kt)("li",{parentName:"ul"},"Nozzle: registry 2 or 4. We need to spend additional time on that.")),(0,r.kt)("p",null,"Sensors:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Water level: 1 (red sensor)"),(0,r.kt)("li",{parentName:"ul"},"Bottle position: 2 or 4 (green sensor). We need to spend additional time on that.")),(0,r.kt)("p",null,"Now play with set_registry.py script and find out which registries are associated with the nozzle."),(0,r.kt)("p",null,"Which is the registry associated with the nozzle?"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"4")),(0,r.kt)("h2",{id:"task-5-attack"},"Task 5 Attack"),(0,r.kt)("p",null,"On the previous tasks, we figured out how registries work:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Registry 1: associated with the bottle sensor. Value is 1 if the bottle is under the nozzle."),(0,r.kt)("li",{parentName:"ul"},"Registry 2: associated with the water level sensor. Value is 1 if the bottle is filled."),(0,r.kt)("li",{parentName:"ul"},"Registry 3: associated with the roller actuators. Value 1 turns the roller on."),(0,r.kt)("li",{parentName:"ul"},"Registry 4: associated with the nozzle. Value 1 opens the nozzle."),(0,r.kt)("li",{parentName:"ul"},"Registry 16: associated with the plant. Value 1 starts the plant")),(0,r.kt)("p",null,"We can abuse the registries forcing a custom value to the above registries. We can do that in many ways."),(0,r.kt)("p",null,"Mind that the plant manager will shut down the plant if an abnormal condition is detected."),(0,r.kt)("p",null,"Shutdown the plant and avoid the plant manager starts it again."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"No answer needed")),(0,r.kt)("p",null,"Start the plant, open the nozzle while bottles are moving."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"No answer needed")),(0,r.kt)("p",null,"Start the plant, open the nozzle and stop the rollet."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"No answer needed")),(0,r.kt)("p",null,"Repeat attack in question 1 abusing sensor registries."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"No answer needed")),(0,r.kt)("p",null,"Repeat attack in question 2 abusing sensor registries."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"No answer needed")),(0,r.kt)("p",null,"Repeat attack in question 3 abusing sensor registries."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"No answer needed")))}c.isMDXComponent=!0}}]);